<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>TrAi â€¢ Sanal Stil AsistanÄ±n</title>
  
  <!-- Favicon - TrAi Logo -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23f472b6'/%3E%3Cstop offset='100%25' style='stop-color:%23a855f7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='48' fill='url(%23g)'/%3E%3Ctext x='50' y='62' font-family='system-ui,sans-serif' font-size='32' font-weight='bold' fill='white' text-anchor='middle'%3ETrAi%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23f472b6'/%3E%3Cstop offset='100%25' style='stop-color:%23a855f7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='48' fill='url(%23g)'/%3E%3Ctext x='50' y='62' font-family='system-ui,sans-serif' font-size='32' font-weight='bold' fill='white' text-anchor='middle'%3ETrAi%3C/text%3E%3C/svg%3E">
  
  <!-- Security: Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:;
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https:;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https:;
    font-src 'self' https://fonts.gstatic.com data:;
    img-src 'self' data: blob: https: *;
    connect-src 'self' https: wss:;
  ">
  
  <!-- Security: Prevent MIME sniffing -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  
  <!-- Security: Referrer Policy - Allow same-origin referrer for Firebase auth -->
  <meta name="referrer" content="strict-origin-when-cross-origin">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#2962FF',
            brand2: '#2962FF',
            accent: '#2962FF',
            dark: '#F5F5F7',
            surface: '#FFFFFF',
            muted: '#6B7280',
            ink: '#111111'
          }
        }
      }
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body,#root{height:100%;height:100dvh;height:-webkit-fill-available;margin:0;padding:0;overflow:hidden}
    body{
      font-family:'Inter',sans-serif;
      background:#F5F5F7;
      color:#111111;overflow:hidden;-webkit-font-smoothing:antialiased;
      position:fixed;width:100%;top:0;left:0;
      min-height:100vh;min-height:100dvh;min-height:-webkit-fill-available
    }
    .safe-bottom{padding-bottom:max(env(safe-area-inset-bottom,0px),16px)}
    .safe-top{padding-top:max(env(safe-area-inset-top,0px),0px)}
    @supports (-webkit-touch-callout: none) {
      /* iOS Safari specific */
      .safe-bottom{padding-bottom:max(env(safe-area-inset-bottom,0px),34px)}
      .safe-top{padding-top:max(env(safe-area-inset-top,0px),20px)}
    }
    @supports (padding-top: constant(safe-area-inset-top)) {
      /* Older iOS versions */
      .safe-top{padding-top:constant(safe-area-inset-top)}
      .safe-bottom{padding-bottom:constant(safe-area-inset-bottom)}
    }
    .glass{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border:1px solid rgba(0,0,0,.06)}
    .glass-dark{background:rgba(255,255,255,.98);backdrop-filter:blur(20px);border:1px solid rgba(0,0,0,.04)}
    .btn-primary{
      background:#2962FF;
      transition:all .22s;
      box-shadow:0 4px 14px rgba(41,98,255,.25);
      color:#fff
    }
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(41,98,255,.35);background:#1E54E5}
    .btn-primary:active{transform:scale(0.98)}
    .btn-ghost{background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.08);transition:all .18s;color:#111111}
    .btn-ghost:hover{background:rgba(0,0,0,.06)}
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .custom-scroll::-webkit-scrollbar{width:4px}
    .custom-scroll::-webkit-scrollbar-track{background:rgba(0,0,0,.03)}
    .custom-scroll::-webkit-scrollbar-thumb{background:rgba(41,98,255,.4);border-radius:6px}
    input,select,textarea{
      background:#FFFFFF;
      border:1px solid rgba(0,0,0,.10);
      color:#111111;padding:14px;border-radius:12px;font-size:15px;transition:all .2s;width:100%
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:#2962FF;box-shadow:0 0 0 3px rgba(41,98,255,.12)}
    input::placeholder,textarea::placeholder{color:#9CA3AF}
    select option{background:#fff;color:#111111}
    .fade-in{animation:fadeIn .22s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .slide-up{animation:slideUp .33s ease-out}
    @keyframes slideUp{from{opacity:0;transform:translateY(100%)}to{opacity:1;transform:translateY(0)}}
    .product-card{transition:all .24s}
    .product-card:hover{transform:translateY(-3px)}
    .badge{background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.1)}
    .ring-pulse{animation:ringPulse 1.25s infinite}
    @keyframes ringPulse{0%{transform:scale(.78);opacity:.9}100%{transform:scale(1.8);opacity:0}}
    .shadow-soft{box-shadow:0 8px 30px rgba(0,0,0,.12)}
    .bg-gradient-premium{background:#FFFFFF}
    .float{animation:float 3s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .btn-secondary{background:rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.08);transition:all .2s;color:#111111}
    .btn-secondary:hover{background:rgba(0,0,0,.08)}
    .scale-in{animation:scaleIn .3s cubic-bezier(.16,1,.3,1)}
    @keyframes scaleIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    .pulse{animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:.8}}
    .animate-bounce-right{animation:bounceRight 1s ease-in-out infinite}
    @keyframes bounceRight{0%,100%{transform:translateX(0)}50%{transform:translateX(8px)}}
    .animate-bounce-left{animation:bounceLeft 1s ease-in-out infinite}
    @keyframes bounceLeft{0%,100%{transform:translateX(0)}50%{transform:translateX(-8px)}}
    
    /* Desktop Responsive Layout */
    @media (min-width: 1024px) {
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        background-attachment: fixed;
      }
      .app-shell {
        max-width: 100% !important;
        height: 100vh;
        display: grid;
        grid-template-columns: 280px 1fr 320px;
        gap: 0;
        background: #F5F5F7;
      }
      .app-shell > * {
        height: 100vh;
        overflow-y: auto;
      }
      .desktop-sidebar-left {
        background: white;
        border-right: 1px solid rgba(0,0,0,0.08);
        padding: 24px;
      }
      .desktop-main {
        background: white;
        overflow: hidden;
      }
      .desktop-sidebar-right {
        background: #FAFAFA;
        border-left: 1px solid rgba(0,0,0,0.08);
        padding: 24px;
      }
      .mobile-nav {
        display: none !important;
      }
      .desktop-nav {
        display: flex !important;
      }
    }
    @media (max-width: 1023px) {
      .desktop-nav, .desktop-sidebar-left, .desktop-sidebar-right {
        display: none !important;
      }
      .app-shell {
        display: block !important;
      }
    }
    
    /* Desktop Navigation */
    .desktop-nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 500;
      color: #64748b;
      transition: all 0.2s;
      cursor: pointer;
    }
    .desktop-nav-item:hover {
      background: rgba(41, 98, 255, 0.08);
      color: #2962FF;
    }
    .desktop-nav-item.active {
      background: rgba(41, 98, 255, 0.12);
      color: #2962FF;
      font-weight: 600;
    }
    
    /* Drag and Drop Styles */
    .draggable-item {
      cursor: grab;
      transition: all 0.2s ease;
      user-select: none;
    }
    .draggable-item:active {
      cursor: grabbing;
    }
    .draggable-item.dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }
    .drop-zone {
      transition: all 0.2s ease;
      border: 2px dashed transparent;
    }
    .drop-zone.drag-over {
      background: rgba(41, 98, 255, 0.08);
      border-color: #2962FF;
      transform: scale(1.02);
    }
    .drop-zone.has-item {
      border-color: #10B981;
      background: rgba(16, 185, 129, 0.05);
    }
    .item-added-flash {
      animation: itemAdded 0.5s ease;
    }
    @keyframes itemAdded {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); background: rgba(41, 98, 255, 0.2); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
<div id="root"></div>

<!-- React & Babel - CDNJS & jsDelivr -->
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>

<!-- Firebase - jsDelivr -->
<script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-app-compat.js"></script>
<script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-auth-compat.js"></script>
<script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-firestore-compat.js"></script>
<script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-storage-compat.js"></script>

<!-- Trendyol Products Database -->
<script src="trendyol_products.js"></script>

<script type="text/babel">
const { useEffect, useMemo, useRef, useState } = React;

// ============ GLOBAL ERROR HANDLER ============
window.onerror = function(message, source, lineno, colno, error) {
  console.error('ðŸš¨ GLOBAL ERROR:', message, 'at', source, lineno, colno);
  if (typeof debugLog !== 'undefined') {
    debugLog('CRASH', `${message} (line ${lineno})`, 'error');
  }
  // Prevent white screen - show alert instead
  alert('Uygulama hatasÄ±: ' + message + '\n\nSayfayÄ± yenileyin.');
  return false;
};

window.onunhandledrejection = function(event) {
  console.error('ðŸš¨ UNHANDLED PROMISE:', event.reason);
  if (typeof debugLog !== 'undefined') {
    debugLog('CRASH', `Promise: ${event.reason?.message || event.reason}`, 'error');
  }
};

// ============ LOGO ============
const LOGO_BASE64 = "data:image/png;base64,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";

// ============ CONFIG ============
const CONFIG = {
  name: "TrAi",
  slogan: "Dene. KeÅŸfet. Parla.",
  apiKey: null, // API key is hidden in Vercel env - fetched via /api/gemini
  useApiRoute: true, // Always use /api/gemini for security
  freemiumImageModel: "gemini-2.5-flash-image",
  imageModel: "gemini-3-pro-image-preview",
  videoModel: "veo-3.0-fast-generate-001",
  textModel: "gemini-2.0-flash",
  timeoutMs: 45000, // 90s â†’ 45s (API genelde 15-25s'de yanÄ±t veriyor)
  videoTimeoutMs: 90000, // 120s â†’ 90s
  firebase: {
    apiKey: "AIzaSyA00c8vwyaoHBybeaS7skxmQNtb9BGZOWo",
    authDomain: "trai-fashion-1e0e6.firebaseapp.com",
    projectId: "trai-fashion-1e0e6",
    storageBucket: "trai-fashion-1e0e6.appspot.com",
    messagingSenderId: "651572736872",
    appId: "1:651572736872:web:15e8657d2507a3ffdbdcdd"
  }
};

// ============ TRANSLATIONS ============
const TRANSLATIONS = {
  tr: {
    // Slogan & Branding
    slogan: "Dene. KeÅŸfet. Parla.",
    sloganFull: "Yapay Zeka Moda ile BuluÅŸtu",
    
    // Welcome Screen
    digitalTwin: "Dijital Ä°kiz",
    virtualTryOn: "Sanal Deneme",
    aiStylist: "AI Stilist",
    kvkkCompliant: "KVKK Uyumlu",
    sslSecure: "256-bit SSL",
    startFree: "Ãœcretsiz BaÅŸla",
    alreadyHaveAccount: "Zaten hesabÄ±m var",
    
    // Auth
    welcomeBack: "Tekrar HoÅŸ Geldin",
    createAccount: "Hesap OluÅŸtur",
    loginToAccount: "HesabÄ±na giriÅŸ yap",
    startFashionJourney: "Moda yolculuÄŸuna baÅŸla",
    continueWithGoogle: "Google ile devam et",
    or: "veya",
    username: "KullanÄ±cÄ± AdÄ±",
    usernamePlaceholder: "kullanici_adi",
    usernameAvailable: "kullanÄ±labilir!",
    usernameTaken: "Bu kullanÄ±cÄ± adÄ± alÄ±nmÄ±ÅŸ",
    usernameMinChars: "En az 3 karakter gerekli",
    usernameRules: "Harf ile baÅŸlamalÄ±, sadece harf, rakam ve _ iÃ§erebilir",
    displayName: "GÃ¶rÃ¼nen Ad",
    displayNameOptional: "(isteÄŸe baÄŸlÄ±)",
    displayNamePlaceholder: "AdÄ±nÄ±z SoyadÄ±nÄ±z",
    displayNameHelp: "Profilinizde gÃ¶rÃ¼necek isim (boÅŸ bÄ±rakÄ±rsanÄ±z kullanÄ±cÄ± adÄ± gÃ¶sterilir)",
    email: "E-posta",
    emailAvailable: "E-posta kullanÄ±labilir",
    emailTaken: "Bu e-posta adresi zaten kullanÄ±lÄ±yor",
    emailInvalid: "GeÃ§erli bir e-posta adresi girin",
    password: "Åžifre",
    passwordRequirements: "Åžifre gereksinimleri:",
    minChars: "karakter",
    uppercase: "BÃ¼yÃ¼k harf",
    lowercase: "KÃ¼Ã§Ã¼k harf",
    number: "Rakam",
    termsText: "Devam ederek",
    termsLink: "KullanÄ±m KoÅŸullarÄ±",
    and: "ve",
    privacyLink: "Gizlilik PolitikasÄ±",
    termsAccept: "'nÄ± kabul ediyorum",
    login: "GiriÅŸ Yap",
    register: "KayÄ±t Ol",
    forgotPassword: "Åžifremi Unuttum",
    resetPassword: "Åžifre SÄ±fÄ±rla",
    resetEmailSent: "Åžifre sÄ±fÄ±rlama e-postasÄ± gÃ¶nderildi",
    
    // Navigation
    explore: "KeÅŸfet",
    closet: "Dolap",
    social: "AkÄ±ÅŸ",
    profile: "Profil",
    shopTab: "KeÅŸfet",
    closetTab: "DolabÄ±m",
    socialTab: "AkÄ±ÅŸ",
    profileTab: "Profil",
    quickStats: "HÄ±zlÄ± BakÄ±ÅŸ",
    closetCount: "DolabÄ±mda",
    recentTryOns: "Son Denemeler",
    
    // Explore Tab
    featuredCollection: "Ã–ne Ã‡Ä±kan Koleksiyon",
    trendPieces: "Sezonun en trend parÃ§alarÄ±",
    searchPlaceholder: "ÃœrÃ¼n, marka, renk ara...",
    all: "TÃ¼mÃ¼",
    male: "Erkek",
    female: "KadÄ±n",
    kids: "Ã‡ocuk",
    topWear: "Ãœst Giyim",
    bottomWear: "Alt Giyim",
    outerwear: "DÄ±ÅŸ Giyim",
    dress: "Elbise",
    topLabel: "Ãœst",
    bottomLabel: "Alt",
    outerwearLabel: "DÄ±ÅŸ Giyim",
    dressLabel: "Elbise",
    allBrands: "TÃ¼m Markalar",
    clearFilters: "Filtreleri Temizle",
    products: "Ã¼rÃ¼n",
    tryOn: "Dene",
    addToCloset: "Dolaba Ekle",
    getAdvice: "Tavsiye Al",
    sizeAdvice: "Beden Ã–nerisi",
    
    // Closet Tab
    myCloset: "DolabÄ±m",
    createAvatar: "Avatar OluÅŸtur",
    editAvatar: "Avatar DÃ¼zenle",
    tops: "Ãœstler",
    bottoms: "Altlar",
    outerwearsCloset: "DÄ±ÅŸ Giyim",
    dresses: "Elbiseler",
    items: "parÃ§a",
    trySingle: "Tekli Dene",
    tryCombo: "Kombin Dene",
    selectTop: "Ãœst seÃ§",
    selectBottom: "Alt seÃ§",
    selectOuterwear: "DÄ±ÅŸ giyim seÃ§ (opsiyonel)",
    tryComboButton: "Kombini Dene",
    dailyRecommendation: "GÃ¼nÃ¼n Kombini",
    
    // Custom Clothing Upload
    addClothing: "KÄ±yafet Ekle",
    myClothes: "KÄ±yafetlerim",
    uploadClothing: "KÄ±yafet YÃ¼kle",
    clothingUploadTitle: "Kendi KÄ±yafetini Ekle",
    clothingUploadDesc: "DolabÄ±ndaki gerÃ§ek kÄ±yafetleri dijital dolabÄ±na ekle",
    clothingUploadInstructions: "ðŸ“¸ Ä°yi FotoÄŸraf NasÄ±l Ã‡ekilir?",
    clothingInstruction1: "âœ“ DÃ¼z zemine serin (yatak, masa veya zemin)",
    clothingInstruction2: "âœ“ AÃ§Ä±k renk zemin kullanÄ±n (beyaz/gri en iyi)",
    clothingInstruction3: "âœ“ KÄ±yafeti dÃ¼zeltin, kol ve etekleri aÃ§Ä±n",
    clothingInstruction4: "âœ“ YukarÄ±dan Ã§ekin, tam ortada olsun",
    clothingInstruction5: "âœ“ GÃ¼n Ä±ÅŸÄ±ÄŸÄ±nda veya iyi aydÄ±nlÄ±k ortamda Ã§ekin",
    selectClothingType: "KÄ±yafet TÃ¼rÃ¼ SeÃ§in",
    clothingName: "KÄ±yafet AdÄ±",
    clothingNamePlaceholder: "Ã–rn: Mavi Ã‡izgili GÃ¶mlek",
    clothingColor: "Renk",
    uploadPhoto: "FotoÄŸraf YÃ¼kle",
    takePhoto: "FotoÄŸraf Ã‡ek",
    addToMyCloset: "DolabÄ±ma Ekle",
    premiumFeature: "Premium Ã–zellik",
    clothingUploadPremium: "KÄ±yafet Ekleme Paketi",
    clothingUploadPremiumDesc: "Kendi kÄ±yafetlerinizi yÃ¼kleyin ve sanal deneme yapÄ±n",
    maxItems: "Maksimum 100 kÄ±yafet",
    oneTimePurchase: "Tek seferlik Ã¶deme",
    buyNow: "SatÄ±n Al",
    remainingSlots: "Kalan hak",
    clothingAdded: "KÄ±yafet Eklendi",
    clothingAddedDesc: "KÄ±yafetin dolabÄ±na eklendi",
    limitReached: "Limit Doldu",
    limitReachedDesc: "Maksimum 100 kÄ±yafet ekleyebilirsiniz",
    myClothesCount: "kÄ±yafetim",
    
    // Avatar Creation
    createDigitalTwin: "Dijital Ä°kizini OluÅŸtur",
    avatarDescription: "Bilgilerini gir, 3 fotoÄŸraf Ã§ek ve yapay zeka seni modele dÃ¶nÃ¼ÅŸtÃ¼rsÃ¼n",
    gender: "Cinsiyet",
    genderHelp: "KÄ±yafet Ã¶nerileri ve avatar oluÅŸturma iÃ§in gerekli",
    physicalInfo: "Fiziksel Bilgiler",
    physicalInfoHelp: "Avatar'Ä±n vÃ¼cut oranlarÄ±nÄ± doÄŸru oluÅŸturmak iÃ§in kullanÄ±lÄ±r",
    age: "YaÅŸ",
    height: "Boy (cm)",
    weight: "Kilo (kg)",
    bodyType: "VÃ¼cut Tipi",
    bodyTypeHelp: "KÄ±yafetlerin vÃ¼cuduna nasÄ±l oturacaÄŸÄ±nÄ± belirler",
    slim: "Ä°nce / ZayÄ±f",
    athletic: "Atletik / Fit",
    average: "Normal / Orta",
    curvy: "Dolgun",
    plus: "BÃ¼yÃ¼k Beden",
    appearance: "GÃ¶rÃ¼nÃ¼m",
    appearanceHelp: "Avatar'Ä±n ten ve saÃ§ Ã¶zelliklerini belirler",
    skinTone: "Ten Renginizi SeÃ§in",
    fairSkin: "Ã‡ok AÃ§Ä±k",
    lightSkin: "AÃ§Ä±k",
    mediumSkin: "BuÄŸday",
    oliveSkin: "Zeytin",
    tanSkin: "Bronz",
    darkSkin: "Koyu",
    hairSection: "SaÃ§ Ã–zellikleri",
    hairColorSelect: "SaÃ§ Renginizi SeÃ§in",
    hairColor: "SaÃ§ Rengi",
    blackHair: "Siyah",
    brownHair: "Kahverengi",
    blondeHair: "SarÄ±",
    redHair: "KÄ±zÄ±l",
    grayHair: "Gri / Beyaz",
    hijabOption: "BaÅŸÃ¶rtÃ¼sÃ¼",
    hairLengthSelect: "SaÃ§ UzunluÄŸunuzu SeÃ§in",
    hairLength: "SaÃ§ UzunluÄŸu",
    veryShortHair: "Ã‡ok KÄ±sa",
    shortHair: "KÄ±sa",
    mediumHair: "Orta",
    longHair: "Uzun",
    veryLongHair: "Ã‡ok Uzun",
    hairTypeSelect: "SaÃ§ Tipinizi SeÃ§in",
    hairType: "SaÃ§ Tipi",
    straightHair: "DÃ¼z",
    wavyHair: "DalgalÄ±",
    curlyHair: "KÄ±vÄ±rcÄ±k",
    coilyHair: "Afro/SÄ±kÄ± KÄ±vÄ±rcÄ±k",
    hairStyle: "SaÃ§ Stili",
    continueToPhoto: "FotoÄŸraf Ã‡ekimine GeÃ§",
    takePhotos: "FotoÄŸraf Ã‡ek",
    photoInstructions: "3 farklÄ± aÃ§Ä±dan fotoÄŸraf Ã§ek",
    front: "Ã–n",
    leftSide: "Sol Profil",
    rightSide: "SaÄŸ Profil",
    openCamera: "KamerayÄ± AÃ§",
    takePhoto: "FotoÄŸraf Ã‡ek",
    creatingAvatar: "Avatar oluÅŸturuluyor...",
    analyzingPhotos: "FotoÄŸraflar analiz ediliyor...",
    extractingFeatures: "YÃ¼z Ã¶zellikleri Ã§Ä±karÄ±lÄ±yor...",
    creatingTwin: "Dijital ikiz oluÅŸturuluyor...",
    ready: "HazÄ±r!",
    
    // Social Tab
    socialFeed: "Sosyal AkÄ±ÅŸ",
    following: "Takip",
    followers: "TakipÃ§i",
    forYou: "Senin Ä°Ã§in",
    newPost: "Yeni PaylaÅŸÄ±m",
    shareLook: "Kombini paylaÅŸ",
    caption: "AÃ§Ä±klama",
    captionPlaceholder: "Bu kombin hakkÄ±nda bir ÅŸeyler yaz...",
    askFeedback: "Fikir sor",
    askingFeedback: "Fikir Ä°stiyor",
    visibility: "GÃ¶rÃ¼nÃ¼rlÃ¼k",
    public: "Herkese AÃ§Ä±k",
    followersOnly: "Sadece TakipÃ§iler",
    private: "Ã–zel",
    share: "PaylaÅŸ",
    like: "BeÄŸen",
    comment: "Yorum",
    comments: "Yorumlar",
    writeComment: "Yorum yaz...",
    send: "GÃ¶nder",
    follow: "Takip Et",
    unfollow: "Takibi BÄ±rak",
    followUser: "KullanÄ±cÄ± Takip Et",
    makeFirstPost: "Ä°lk PaylaÅŸÄ±mÄ±nÄ± Yap",
    getFeedbackFromFollowers: "TakipÃ§ilerinden yorum al",
    noPostsYet: "HenÃ¼z paylaÅŸÄ±m yok",
    myPosts: "PaylaÅŸÄ±mlarÄ±m",
    downloaded: "Ä°ndirildi",
    shareOnInstagram: "GÃ¶rseli Instagram'da paylaÅŸabilirsin",
    feedEmpty: "AkÄ±ÅŸ BoÅŸ",
    beFirstToShare: "Ä°lk gÃ¶nderiyi sen paylaÅŸ!",
    
    // Profile Tab
    myProfile: "Profilim",
    editProfile: "Profili DÃ¼zenle",
    posts: "PaylaÅŸÄ±mlar",
    messages: "Mesajlar",
    settings: "Ayarlar",
    closetLabel: "Dolap",
    tryOnLabel: "Deneme",
    accountInfo: "Hesap Bilgileri",
    myTwin: "Ä°kizim",
    logout: "Ã‡Ä±kÄ±ÅŸ Yap",
    deleteAccount: "HesabÄ± Sil",
    changePhoto: "FotoÄŸraf DeÄŸiÅŸtir",
    save: "Kaydet",
    cancel: "Ä°ptal",
    
    // Messages
    directMessages: "Direkt Mesajlar",
    newMessage: "Yeni Mesaj",
    searchUsers: "KullanÄ±cÄ± ara...",
    typeMessage: "Mesaj yaz...",
    noMessages: "HenÃ¼z mesaj yok",
    startNewMessage: "Yeni mesaj baÅŸlat veya grup oluÅŸtur",
    messagesLabel: "MESAJLAR",
    request: "Ä°stek",
    messageRequest: "Mesaj Ä°stekleri",
    notFollowingWarning: "Bu kullanÄ±cÄ± sizi takip etmiyor. MesajÄ±nÄ±z istek olarak gÃ¶nderilecek.",
    beFirstToMessage: "HenÃ¼z mesaj yok. Ä°lk mesajÄ± sen gÃ¶nder!",
    whoToMessage: "Kime mesaj gÃ¶ndermek istiyorsun?",
    sendMessage: "Mesaj GÃ¶nder",
    sendDM: "DM GÃ¶nder",
    deletePostConfirm: "Bu gÃ¶nderiyi silmek istiyor musun?",
    post: "GÃ¶nderi",
    sendVerificationEmail: "DoÄŸrulama E-postasÄ± GÃ¶nder",
    verificationSent: "DoÄŸrulama e-postasÄ± gÃ¶nderildi!",
    
    // Settings
    appSettings: "Uygulama AyarlarÄ±",
    language: "Dil",
    languagePreference: "Dil Tercihi",
    selectLanguage: "Dil SeÃ§in",
    notifications: "Bildirimler",
    notificationsTab: "Bildirimler",
    allNotifications: "TÃ¼m Bildirimler",
    noNotifications: "Bildirim yok",
    noNotificationsDesc: "Yeni bildirimler burada gÃ¶rÃ¼necek",
    markAllRead: "TÃ¼mÃ¼nÃ¼ Okundu Ä°ÅŸaretle",
    notificationFollowRequest: "seni takip etmek istiyor",
    notificationFollowAccept: "takip isteÄŸini kabul etti",
    notificationNewMessage: "sana mesaj gÃ¶nderdi",
    notificationGroupInvite: "seni bir gruba davet etti",
    notificationWeather: "BugÃ¼n hava",
    notificationDailyOutfit: "GÃ¼nÃ¼n kombini hazÄ±r!",
    notificationLike: "gÃ¶nderini beÄŸendi",
    notificationComment: "gÃ¶nderine yorum yaptÄ±",
    darkMode: "KaranlÄ±k Mod",
    debugMode: "GeliÅŸtirici Modu",
    about: "HakkÄ±nda",
    version: "Versiyon",
    privacySettings: "Gizlilik AyarlarÄ±",
    profileVisibility: "Profil GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼",
    profileVisibilityDesc: "Profilini herkes gÃ¶rebilsin",
    shareCombos: "Kombinleri PaylaÅŸ",
    shareCombosDesc: "Kombinlerin takipÃ§ilerine gÃ¶rÃ¼nsÃ¼n",
    onlineStatus: "Ã‡evrimiÃ§i Durumu",
    onlineStatusDesc: "Aktif olduÄŸunda gÃ¶rÃ¼nsÃ¼n",
    messageNotifications: "Mesaj Bildirimleri",
    messageNotificationsDesc: "Yeni mesajlarda bildirim al",
    messageRequests: "Mesaj Ä°stekleri",
    messageRequestsDesc: "Yeni isteklerde bildirim al",
    dailyOutfitSuggestion: "GÃ¼nlÃ¼k Kombin Ã–nerisi",
    dailyOutfitSuggestionDesc: "Sabah 9'da hava durumuna gÃ¶re Ã¶neri",
    application: "Uygulama",
    developer: "GeliÅŸtirici",
    debugModeDesc: "Hata ayÄ±klama loglarÄ±nÄ± gÃ¶ster",
    dangerZone: "Tehlikeli BÃ¶lge",
    clearCacheDesc: "TarayÄ±cÄ±daki Ã¶nbellek ve geÃ§miÅŸ verilerini temizle (hesap silinmez).",
    clearCache: "Ã–nbelleÄŸi Temizle",
    clearCacheConfirm: "Yerel Ã¶nbellek ve geÃ§miÅŸ silinsin mi? (HesabÄ±n silinmez)",
    deleteAccountDesc: "HesabÄ±nÄ± sildiÄŸinde tÃ¼m veriler (avatar, dolap, geÃ§miÅŸ) kalÄ±cÄ± olarak silinir. Bu iÅŸlem geri alÄ±namaz.",
    deleteAccount: "HesabÄ± Sil",
    // Group Chat
    createGroup: "Grup OluÅŸtur",
    groupName: "Grup AdÄ±",
    groupTopic: "Konu (Opsiyonel)",
    groupMembers: "Grup Ãœyeleri",
    selectMembers: "Ãœye SeÃ§",
    minGroupMembers: "En az 3 kiÅŸi seÃ§melisin",
    groupCreated: "Grup oluÅŸturuldu!",
    editGroup: "Grubu DÃ¼zenle",
    leaveGroup: "Gruptan AyrÄ±l",
    deleteGroup: "Grubu Sil",
    groupSettings: "Grup AyarlarÄ±",
    addMembers: "Ãœye Ekle",
    removeFromGroup: "Gruptan Ã‡Ä±kar",
    onlyFollowersCanJoin: "Sadece takip ettiklerin eklenebilir",
    
    // Try-On Results
    tryOnResult: "Deneme Sonucu",
    shareToFeed: "AkÄ±ÅŸta PaylaÅŸ",
    shareToDM: "DM ile GÃ¶nder",
    saveToGallery: "Galeriye Kaydet",
    tryAgain: "Tekrar Dene",
    close: "Kapat",
    
    // Advice
    styleAdvice: "Stil Tavsiyesi",
    aiStylistAdvice: "AI Stilist Ã–nerisi",
    loading: "YÃ¼kleniyor...",
    
    // Weather
    weather: "Hava Durumu",
    sunny: "GÃ¼neÅŸli",
    cloudy: "Bulutlu",
    rainy: "YaÄŸmurlu",
    snowy: "KarlÄ±",
    
    // Daily Recommendation
    dailyOutfitRecommendation: "GÃ¼nÃ¼n Kombin Ã–nerisi",
    recommendedOutfit: "Ã–NERÄ°LEN KOMBÄ°N",
    tryThisOutfit: "Bu Kombini Dene",
    maybeLater: "Sonra BakarÄ±m",
    
    // Errors & Messages
    error: "Hata",
    success: "BaÅŸarÄ±lÄ±",
    warning: "UyarÄ±",
    info: "Bilgi",
    tryOnError: "Deneme hatasÄ±",
    networkError: "BaÄŸlantÄ± hatasÄ±",
    unknownError: "Bir hata oluÅŸtu",
    avatarRequired: "Ã–nce avatar oluÅŸturmalÄ±sÄ±nÄ±z",
    selectItemFirst: "Ã–nce Ã¼rÃ¼n seÃ§in",
    added: "Eklendi",
    removed: "KaldÄ±rÄ±ldÄ±",
    shared: "PaylaÅŸÄ±ldÄ±",
    
    // SmartCloset Tabs
    studioTab: "StÃ¼dyo",
    studioTitle: "Kombin StÃ¼dyosu",
    studioDesc: "ParÃ§alarÄ± sÃ¼rÃ¼kleyip bÄ±rakarak kombin oluÅŸtur",
    tryCombo: "Kombini Dene",
    clearAll: "Temizle",
    productsTab: "ÃœrÃ¼nler",
    weatherTab: "Hava",
    combosTab: "Kombinler",
    favoritesTab: "Favoriler",
    historyTab: "GeÃ§miÅŸ",
    closetEmpty: "DolabÄ±n BoÅŸ",
    addFromShop: "AlÄ±ÅŸveriÅŸten Ã¼rÃ¼n ekle",
    recentSort: "Son Eklenen",
    brandSort: "Marka",
    colorSort: "Renk",
    selectComboItems: "Kombin iÃ§in Ã¼rÃ¼n seÃ§",
    tryOnCombo: "Kombini Dene",
    saveCombo: "Kombini Kaydet",
    comboName: "Kombin AdÄ±",
    savedCombos: "KayÄ±tlÄ± Kombinler",
    noCombos: "HenÃ¼z kombin yok",
    createCombo: "Kombin OluÅŸtur",
    noFavorites: "HenÃ¼z favori yok",
    noHistory: "HenÃ¼z deneme yok",
    tryOnHistory: "Deneme GeÃ§miÅŸi",
    weatherRecommendation: "Hava Durumu Ã–nerisi",
    getWeather: "Hava Durumunu Al",
    locationRequired: "Konum izni gerekli",
    noLogsYet: "HenÃ¼z log yok",
    debugLogs: "Debug Logs",
    termsTitle: "KullanÄ±m KoÅŸullarÄ±",
    lastUpdated: "Son gÃ¼ncelleme",
    kvkkNotice: "KiÅŸisel verileriniz 6698 sayÄ±lÄ± KVKK kapsamÄ±nda korunmaktadÄ±r.",
    scrollToRead: "LÃ¼tfen aÅŸaÄŸÄ± kaydÄ±rarak tÃ¼m koÅŸullarÄ± okuyun",
    decline: "VazgeÃ§",
    accept: "Kabul Ediyorum",
    processing: "Ä°ÅŸleniyor...",
    noAccount: "HesabÄ±n yok mu?",
    haveAccount: "Zaten hesabÄ±n var mÄ±?",
    signUp: "KayÄ±t ol",
    signIn: "GiriÅŸ yap",
    creating: "OluÅŸturuluyor",
    selected: "SeÃ§ili",
    loading: "YÃ¼kleniyor",
    wind: "RÃ¼zgar",
    shareWeather: "Hava durumunu gÃ¶rmek iÃ§in konumunuzu paylaÅŸÄ±n",
    noSavedCombos: "KayÄ±tlÄ± Kombin Yok",
    createComboHint: "ÃœrÃ¼nler sekmesinden kombin oluÅŸtur ve kaydet",
    addToFavorites: "BeÄŸendiÄŸin Ã¼rÃ¼nleri favorilere ekle",
    historyEmpty: "Deneme GeÃ§miÅŸi BoÅŸ",
    historyHint: "KÄ±yafet denemelerin burada gÃ¶rÃ¼necek",
    emailVerificationRequired: "E-posta DoÄŸrulama Gerekli",
    user: "KullanÄ±cÄ±",
    premiumMember: "Premium Ãœye",
    follower: "TakipÃ§i",
    displayNameLabel: "GÃ¶rÃ¼nen Ad",
    verify: "DoÄŸrula",
    membership: "Ãœyelik",
    premium: "Premium",
    joinDate: "KatÄ±lÄ±m",
    productNotFound: "ÃœrÃ¼n BulunamadÄ±",
    tryDifferentFilters: "FarklÄ± filtreler deneyin",
    sizeStyleAdvice: "Beden & Stil Ã–nerisi",
    completed: "TamamlandÄ±",
    startCamera: "Kamera baÅŸlatÄ±lÄ±yor...",
    takeSelfie: "Selfie Ã‡ek",
    takePhotosHint: "3 farklÄ± aÃ§Ä±dan fotoÄŸraf Ã§ekin",
    termsAcceptText: "KullanÄ±m KoÅŸullarÄ±",
    privacyAcceptText: "Gizlilik PolitikasÄ±",
    readAccepted: "'nÄ± okudum, kabul ediyorum.",
    occasionSuggestion: "iÃ§in Ã¶neri",
    groupMaxMembers: "Grup en fazla 10 kiÅŸi olabilir",
    groupMinMembers: "Grup en az 3 kiÅŸi olmalÄ±",
    
    // Misc
    back: "Geri",
    next: "Ä°leri",
    done: "Tamam",
    yes: "Evet",
    no: "HayÄ±r",
    confirm: "Onayla",
    delete: "Sil",
    edit: "DÃ¼zenle",
    view: "GÃ¶rÃ¼ntÃ¼le",
    download: "Ä°ndir",
    refresh: "Yenile",
    retry: "Tekrar Dene",
    selectLanguage: "Dil SeÃ§in",
    turkish: "TÃ¼rkÃ§e",
    english: "English",
    sent: "GÃ¶nderildi!",
    verificationEmailSent: "DoÄŸrulama e-postasÄ± gÃ¶nderildi. Spam klasÃ¶rÃ¼nÃ¼ de kontrol edin.",
    tooManyRequests: "Ã‡ok fazla istek",
    pleaseWait: "LÃ¼tfen birkaÃ§ dakika bekleyip tekrar deneyin.",
    connectionError: "BaÄŸlantÄ± HatasÄ±",
    firebaseError: "Firebase baÄŸlantÄ±sÄ± kurulamadÄ±. SayfayÄ± yenileyin.",
    remove: "KaldÄ±r",
    studio: "StÃ¼dyo",
    street: "Sokak",
    office: "Ofis",
    cafe: "Kafe",
    park: "Park",
    beach: "Plaj",
    travel: "Seyahat",
    fineDining: "Fine Dining",
    rooftop: "Teras",
    gallery: "Galeri",
    notVerifiedYet: "HenÃ¼z doÄŸrulanmadÄ±",
    clickLinkAndRetry: "E-postanÄ±zdaki linke tÄ±klayÄ±n ve tekrar deneyin.",
    emailVerificationRequired: "E-posta DoÄŸrulamasÄ± Gerekli",
    emailVerificationForCombo: "Kombinleri denemek iÃ§in e-posta adresinizi doÄŸrulamanÄ±z gerekiyor.",
    resendVerificationEmail: "DoÄŸrulama e-postasÄ±nÄ± tekrar gÃ¶nder",
    notFollowingAnyone: "HenÃ¼z kimseyi takip etmiyorsun",
    noPostsYetProfile: "HenÃ¼z PaylaÅŸÄ±mÄ±n Yok",
    noTriesYet: "HenÃ¼z deneme yok",
    noCommentsYet: "HenÃ¼z yorum yok",
    
    // Consent & Legal
    ageRequirement: "18+ YaÅŸ ÅžartÄ±",
    ageConfirmText: "18 yaÅŸÄ±ndan bÃ¼yÃ¼k olduÄŸumu beyan ve taahhÃ¼t ediyorum.",
    faceDataConsent: "YÃ¼z Verisi AÃ§Ä±k RÄ±zasÄ±",
    faceDataConsentText: "FotoÄŸraflarÄ±m Ã¼zerinden yÃ¼z ve vÃ¼cut Ã¶zelliklerimin analiz edilerek sanal kÄ±yafet deneme hizmeti sunulmasÄ±na aÃ§Ä±k rÄ±za veriyorum.",
    usaTransferConsent: "ABD'ye AktarÄ±m RÄ±zasÄ±",
    usaTransferConsentText: "FotoÄŸraflarÄ±mÄ±n Google Gemini ve Firebase altyapÄ±larÄ± sebebiyle ABD'ye aktarÄ±lmasÄ±na aÃ§Ä±k rÄ±za veriyorum.",
    sharingConsentText: "OluÅŸturduÄŸum gÃ¶rsellerin uygulama iÃ§inde diÄŸer kullanÄ±cÄ±larla paylaÅŸÄ±lmasÄ±nÄ± kabul ediyorum.",
    analyticsConsentText: "Uygulama deneyimini geliÅŸtirmek amacÄ±yla analitik Ã¶lÃ§Ã¼mleme yapÄ±lmasÄ±nÄ± kabul ediyorum.",
    optionalConsents: "Opsiyonel Ä°zinler",
    requiredFields: "Zorunlu alanlar",
    consentRequired: "Onay Gerekli",
    acceptRequiredConsents: "Devam etmek iÃ§in zorunlu onaylarÄ± verin.",
    kvkkText: "KVKK AydÄ±nlatma Metni",
    preInfoForm: "Ã–n Bilgilendirme",
    deleteAccountWarning: "HesabÄ±nÄ±zÄ± sildiÄŸinizde tÃ¼m verileriniz kalÄ±cÄ± olarak silinecektir.",
    deleteAccountConfirmText: "Bu iÅŸlem geri alÄ±namaz. HesabÄ±nÄ±zÄ± silmek istediÄŸinizden emin misiniz?",
    permanentlyDelete: "KalÄ±cÄ± Olarak Sil",
    sharingConsentTitle: "PaylaÅŸÄ±m Ä°zni",
    sharingConsentDesc: "OluÅŸturduÄŸunuz kombini diÄŸer kullanÄ±cÄ±larla paylaÅŸmak ister misiniz?",
    analyticsConsentTitle: "Deneyimi GeliÅŸtir",
    analyticsConsentDesc: "Kombin denemelerinizi analiz ederek size daha iyi Ã¶neriler sunmamÄ±za yardÄ±mcÄ± olun.",
    allowSharing: "PaylaÅŸÄ±ma Ä°zin Ver",
    allowAnalytics: "Analitik Ä°zni Ver",
    maybeLater: "Belki Sonra",
    dontShowAgain: "Bir daha gÃ¶sterme",
    
    // Credits & Subscription (Yeni sistem)
    credits: "Kredi",
    buyCredits: "Kredi SatÄ±n Al",
    buyPackage: "Paket Al",
    subscription: "Abonelik",
    premium: "Premium",
    premiumMember: "Premium Ãœye",
    freeMember: "Ãœcretsiz Ãœye",
    freemium: "Ãœcretsiz",
    freeTriesLeft: "Ãœcretsiz Hak",
    weeklyFreeTries: "HaftalÄ±k Deneme",
    comboFreeTries: "Kombin HakkÄ±",
    monthlySubscription: "AylÄ±k Premium",
    monthlyCredits: "AylÄ±k Kredi",
    unlimitedStyleChat: "SÄ±nÄ±rsÄ±z Stil Sohbeti",
    adFreeExperience: "ReklamsÄ±z Deneyim",
    creditPackage: "Kredi Paketi",
    creditPackage5: "5 Kredi Paketi",
    creditPackage40: "40 Kredi Paketi",
    tryOns: "Deneme",
    perMonth: "/ay",
    subscribe: "Abone Ol",
    buyNow: "Åžimdi Al",
    currentPlan: "Mevcut Plan",
    insufficientCredits: "Yetersiz Kredi",
    needMoreCredits: "Kredi satÄ±n alÄ±n veya Ã¼cretsiz haklarÄ±nÄ±zÄ± kullanÄ±n.",
    creditUsed: "1 kredi kullanÄ±ldÄ±",
    creditsRemaining: "Kalan kredi",
    freeTrieUsed: "Ãœcretsiz hak kullanÄ±ldÄ±",
    noFreeTries: "Ãœcretsiz hakkÄ±nÄ±z kalmadÄ±",
    
    // Referral System
    referralTitle: "ArkadaÅŸÄ±nÄ± Davet Et",
    referralSubtitle: "ArkadaÅŸÄ±n avatar oluÅŸturunca +1 kredi kazan",
    referralCode: "Davet Kodun",
    referralLink: "Davet Linkin",
    referralCopied: "Link kopyalandÄ±!",
    referralShare: "PaylaÅŸ",
    referralEarned: "KazanÄ±lan Kredi",
    referralThisMonth: "Bu Ay",
    referralMonthlyLimit: "AylÄ±k Limit",
    referralLimitReached: "Bu ay referans limitine ulaÅŸtÄ±n",
    referralHowItWorks: "NasÄ±l Ã‡alÄ±ÅŸÄ±r?",
    referralStep1: "Davet linkini arkadaÅŸÄ±nla paylaÅŸ",
    referralStep2: "ArkadaÅŸÄ±n kayÄ±t olup avatar oluÅŸtursun",
    referralStep3: "Sen +1 kredi kazan!",
    referralBonusOnPurchase: "ArkadaÅŸÄ±n her paket aldÄ±ÄŸÄ±nda sen de +1 kredi kazanÄ±rsÄ±n",
    referralSecurityNote: "GÃ¼venlik: AynÄ± cihazdan aÃ§Ä±lan hesaplar sayÄ±lmaz",
    
    // Video Tab
    videoTab: "Video",
    videoTokens: "Video HakkÄ±",
    videoTryOn: "Video Deneme",
    videoTryOnDesc: "6 saniyelik moda videosu oluÅŸtur",
    videoPackages: "Video Paketleri",
    videoPackage5: "5 Video Paketi",
    videoPackage10: "10 Video Paketi",
    videoPackageDesc5: "KÄ±sa video denemeleri",
    videoPackageDesc10: "%5 indirimli avantaj paketi",
    videoCreating: "Video oluÅŸturuluyor...",
    videoReady: "Videonuz hazÄ±r!",
    needMoreVideoTokens: "Video paketi satÄ±n alÄ±n.",
    videoTokenUsed: "1 video hakkÄ± kullanÄ±ldÄ±",
    videoTokensRemaining: "Kalan video hakkÄ±",
    purchaseFromProfile: "Profilden satÄ±n alabilirsiniz",
    
    // Paywall
    paywallTitle: "Premium Ã–zellik",
    paywallDesc: "Bu Ã¶zelliÄŸi kullanmak iÃ§in paket satÄ±n alÄ±n",
    weeklyTriesUsed: "HaftalÄ±k deneme haklarÄ±nÄ±z azalÄ±yor!",
    comboTriesLow: "Kombin haklarÄ±nÄ±z azalÄ±yor!",
    videoNeedPackage: "Video oluÅŸturmak iÃ§in paket gerekli",
    
    whereWillYouWear: "Ortam SeÃ§",
    selectBackground: "Kombinini nerede gÃ¶rmek istersin?",
    noItemsFound: "ÃœrÃ¼n bulunamadÄ±",
    
    // Cart & Shop
    cart: "Sepet",
    addToCart: "Sepete Ekle",
    removeFromCart: "Sepetten Ã‡Ä±kar",
    cartEmpty: "Sepetiniz boÅŸ",
    cartTotal: "Toplam",
    checkout: "Ã–deme Yap",
    itemsInCart: "Ã¼rÃ¼n sepette",
    continueShopping: "AlÄ±ÅŸveriÅŸe Devam",
    proceedToCheckout: "Ã–demeye GeÃ§",
    orderSummary: "SipariÅŸ Ã–zeti",
    subtotal: "Ara Toplam",
    shipping: "Kargo",
    freeShipping: "Ãœcretsiz Kargo",
    paymentMethod: "Ã–deme YÃ¶ntemi",
    creditCard: "Kredi KartÄ±",
    cardNumber: "Kart NumarasÄ±",
    expiryDate: "Son Kullanma",
    cvv: "CVV",
    cardHolder: "Kart Sahibi",
    completePayment: "Ã–demeyi Tamamla",
    paymentSuccess: "Ã–deme BaÅŸarÄ±lÄ±",
    paymentFailed: "Ã–deme BaÅŸarÄ±sÄ±z",
    orderConfirmed: "SipariÅŸiniz OnaylandÄ±",
    thankYouOrder: "SipariÅŸiniz iÃ§in teÅŸekkÃ¼rler!",
    externalPurchase: "Harici SatÄ±n Al",
    affiliateNotice: "Bu link sizi satÄ±cÄ±nÄ±n sitesine yÃ¶nlendirir",
    addedToCart: "Sepete Eklendi",
    user: "KullanÄ±cÄ±",
    add: "DolabÄ±ma Ekle",
    inCart: "Sepette",
    selectSize: "Beden SeÃ§in",
    deliveryInfo: "Teslimat Bilgileri",
    fullName: "Ad Soyad",
    phone: "Telefon",
    address: "Adres",
    city: "Åžehir",
    district: "Ä°lÃ§e",
    postalCode: "Posta Kodu",
    saveAddress: "Bu adresi kaydet",
    savedAddresses: "KayÄ±tlÄ± Adresler",
    useThisAddress: "Bu Adresi Kullan",
    addNewAddress: "Yeni Adres Ekle",
    legalConsent: "Yasal Onaylar",
    distanceSalesAgreement: "Mesafeli SatÄ±ÅŸ SÃ¶zleÅŸmesi",
    preliminaryInfo: "Ã–n Bilgilendirme Formu",
    acceptTermsCheckout: "Mesafeli SatÄ±ÅŸ SÃ¶zleÅŸmesi ve Ã–n Bilgilendirme Formu'nu okudum, kabul ediyorum.",
    mobilePayment: "Mobil Ã–deme",
    applePayment: "Apple Pay",
    googlePayment: "Google Pay",
    operatorPayment: "OperatÃ¶r Ã–demesi",
    continueToPayment: "Ã–demeye GeÃ§"
  },
  en: {
    // Slogan & Branding
    slogan: "Try. Discover. Shine.",
    sloganFull: "AI Meets Fashion",
    
    // Welcome Screen
    digitalTwin: "Digital Twin",
    virtualTryOn: "Virtual Try-On",
    aiStylist: "AI Stylist",
    kvkkCompliant: "GDPR Compliant",
    sslSecure: "256-bit SSL",
    startFree: "Start Free",
    alreadyHaveAccount: "Already have an account",
    
    // Auth
    welcomeBack: "Welcome Back",
    createAccount: "Create Account",
    loginToAccount: "Login to your account",
    startFashionJourney: "Start your fashion journey",
    continueWithGoogle: "Continue with Google",
    or: "or",
    username: "Username",
    usernamePlaceholder: "username",
    usernameAvailable: "is available!",
    usernameMinChars: "Minimum 3 characters required",
    usernameRules: "Must start with a letter, only letters, numbers and _ allowed",
    displayName: "Display Name",
    displayNameOptional: "(optional)",
    displayNamePlaceholder: "Your Name",
    displayNameHelp: "Name shown on your profile (username will be shown if left empty)",
    email: "Email",
    password: "Password",
    passwordRequirements: "Password requirements:",
    minChars: "characters",
    uppercase: "Uppercase",
    lowercase: "Lowercase",
    number: "Number",
    termsText: "By continuing, I accept the",
    termsLink: "Terms of Service",
    and: "and",
    privacyLink: "Privacy Policy",
    termsAccept: "",
    login: "Login",
    register: "Register",
    forgotPassword: "Forgot Password",
    resetPassword: "Reset Password",
    resetEmailSent: "Password reset email sent",
    
    // Navigation
    explore: "Shop",
    closet: "Closet",
    social: "Feed",
    profile: "Profile",
    shopTab: "Explore",
    closetTab: "My Closet",
    socialTab: "Social",
    profileTab: "Profile",
    quickStats: "Quick Stats",
    closetCount: "In Closet",
    recentTryOns: "Recent Try-ons",
    
    // Explore Tab
    featuredCollection: "Featured Collection",
    trendPieces: "Season's trendiest pieces",
    searchPlaceholder: "Search products, brands, colors...",
    all: "All",
    male: "Men",
    female: "Women",
    kids: "Kids",
    topWear: "Tops",
    bottomWear: "Bottoms",
    outerwear: "Outerwear",
    dress: "Dresses",
    topLabel: "Top",
    bottomLabel: "Bottom",
    outerwearLabel: "Outerwear",
    dressLabel: "Dress",
    allBrands: "All Brands",
    clearFilters: "Clear Filters",
    products: "products",
    tryOn: "Try On",
    addToCloset: "Add",
    getAdvice: "Get Advice",
    sizeAdvice: "Size Advice",
    
    // Closet Tab
    myCloset: "My Closet",
    createAvatar: "Create Avatar",
    editAvatar: "Edit Avatar",
    tops: "Tops",
    bottoms: "Bottoms",
    outerwearsCloset: "Outerwear",
    dresses: "Dresses",
    items: "items",
    trySingle: "Try Single",
    tryCombo: "Try Combo",
    selectTop: "Select top",
    selectBottom: "Select bottom",
    selectOuterwear: "Select outerwear (optional)",
    tryComboButton: "Try Combo",
    dailyRecommendation: "Daily Outfit",
    
    // Custom Clothing Upload
    addClothing: "Add Clothing",
    myClothes: "My Clothes",
    uploadClothing: "Upload Clothing",
    clothingUploadTitle: "Add Your Own Clothing",
    clothingUploadDesc: "Add real clothes from your wardrobe to your digital closet",
    clothingUploadInstructions: "Photo Instructions",
    clothingInstruction1: "Lay the clothing flat on a solid color surface",
    clothingInstruction2: "Choose a different color background (white/gray ideal)",
    clothingInstruction3: "Spread out sleeves and hems",
    clothingInstruction4: "Take photo from above, fit entire garment in frame",
    clothingInstruction5: "Use good lighting",
    selectClothingType: "Select Clothing Type",
    clothingName: "Clothing Name",
    clothingNamePlaceholder: "E.g.: Blue Striped Shirt",
    clothingColor: "Color",
    uploadPhoto: "Upload Photo",
    takePhoto: "Take Photo",
    addToMyCloset: "Add to My Closet",
    premiumFeature: "Premium Feature",
    clothingUploadPremium: "Clothing Upload Package",
    clothingUploadPremiumDesc: "Upload your own clothes and try them on virtually",
    maxItems: "Maximum 100 items",
    oneTimePurchase: "One-time payment",
    buyNow: "Buy Now",
    remainingSlots: "Remaining slots",
    clothingAdded: "Clothing Added",
    clothingAddedDesc: "Added to your closet",
    limitReached: "Limit Reached",
    limitReachedDesc: "You can add up to 100 items",
    myClothesCount: "my clothes",
    
    // Avatar Creation
    createDigitalTwin: "Create Your Digital Twin",
    avatarDescription: "Enter your info, take 3 photos and let AI transform you into a model",
    gender: "Gender",
    genderHelp: "Required for clothing recommendations and avatar creation",
    physicalInfo: "Physical Info",
    physicalInfoHelp: "Used to create accurate body proportions for your avatar",
    age: "Age",
    height: "Height (cm)",
    weight: "Weight (kg)",
    bodyType: "Body Type",
    bodyTypeHelp: "Determines how clothes will fit on your body",
    slim: "Slim",
    athletic: "Athletic",
    average: "Average",
    curvy: "Curvy",
    plus: "Plus Size",
    appearance: "Appearance",
    appearanceHelp: "Determines skin and hair features of your avatar",
    skinTone: "Skin Tone",
    fairSkin: "Fair",
    lightSkin: "Light",
    mediumSkin: "Medium",
    oliveSkin: "Olive",
    tanSkin: "Tan",
    darkSkin: "Dark",
    hairColor: "Hair Color",
    blackHair: "Black",
    brownHair: "Brown",
    blondeHair: "Blonde",
    redHair: "Red",
    grayHair: "Gray / White",
    hairStyle: "Hair Style",
    shortHair: "Short",
    mediumHair: "Medium",
    longHair: "Long",
    continueToPhoto: "Continue to Photo",
    takePhotos: "Take Photos",
    photoInstructions: "Take 3 photos from different angles",
    front: "Front",
    leftSide: "Left Side",
    rightSide: "Right Side",
    openCamera: "Open Camera",
    takePhoto: "Take Photo",
    creatingAvatar: "Creating avatar...",
    analyzingPhotos: "Analyzing photos...",
    extractingFeatures: "Extracting facial features...",
    creatingTwin: "Creating digital twin...",
    ready: "Ready!",
    
    // Social Tab
    socialFeed: "Social Feed",
    following: "Following",
    followers: "Followers",
    forYou: "For You",
    newPost: "New Post",
    shareLook: "Share your look",
    caption: "Caption",
    captionPlaceholder: "Write something about this outfit...",
    askFeedback: "Ask for feedback",
    askingFeedback: "Asking for Feedback",
    visibility: "Visibility",
    public: "Public",
    followersOnly: "Followers Only",
    private: "Private",
    share: "Share",
    like: "Like",
    comment: "Comment",
    comments: "Comments",
    writeComment: "Write a comment...",
    send: "Send",
    follow: "Follow",
    unfollow: "Unfollow",
    followUser: "Follow User",
    makeFirstPost: "Make Your First Post",
    getFeedbackFromFollowers: "Get feedback from your followers",
    noPostsYet: "No posts yet",
    myPosts: "My Posts",
    downloaded: "Downloaded",
    shareOnInstagram: "You can share this on Instagram",
    feedEmpty: "Feed Empty",
    beFirstToShare: "Be the first to share!",
    
    // Profile Tab
    myProfile: "My Profile",
    editProfile: "Edit Profile",
    posts: "Posts",
    messages: "Messages",
    settings: "Settings",
    closetLabel: "Closet",
    tryOnLabel: "Try-On",
    accountInfo: "Account Info",
    myTwin: "My Twin",
    logout: "Logout",
    deleteAccount: "Delete Account",
    changePhoto: "Change Photo",
    save: "Save",
    cancel: "Cancel",
    
    // Messages
    directMessages: "Direct Messages",
    newMessage: "New Message",
    searchUsers: "Search users...",
    typeMessage: "Type a message...",
    noMessages: "No messages yet",
    startNewMessage: "Start a new message or create a group",
    messagesLabel: "MESSAGES",
    request: "Request",
    messageRequest: "Message Requests",
    notFollowingWarning: "This user doesn't follow you. Your message will be sent as a request.",
    beFirstToMessage: "No messages yet. Send the first one!",
    whoToMessage: "Who do you want to message?",
    sendMessage: "Send Message",
    sendDM: "Send DM",
    deletePostConfirm: "Do you want to delete this post?",
    post: "Post",
    sendVerificationEmail: "Send Verification Email",
    verificationSent: "Verification email sent!",
    
    // Settings
    appSettings: "App Settings",
    language: "Language",
    languagePreference: "Language Preference",
    selectLanguage: "Select Language",
    notifications: "Notifications",
    darkMode: "Dark Mode",
    debugMode: "Developer Mode",
    about: "About",
    version: "Version",
    privacySettings: "Privacy Settings",
    profileVisibility: "Profile Visibility",
    profileVisibilityDesc: "Let everyone see your profile",
    shareCombos: "Share Combos",
    shareCombosDesc: "Show your combos to followers",
    onlineStatus: "Online Status",
    onlineStatusDesc: "Show when you're active",
    messageNotifications: "Message Notifications",
    messageNotificationsDesc: "Get notified for new messages",
    messageRequests: "Message Requests",
    messageRequestsDesc: "Get notified for new requests",
    dailyOutfitSuggestion: "Daily Outfit Suggestion",
    dailyOutfitSuggestionDesc: "Weather-based suggestion at 9 AM",
    application: "Application",
    developer: "Developer",
    debugModeDesc: "Show debug logs",
    dangerZone: "Danger Zone",
    clearCacheDesc: "Clear browser cache and history (account won't be deleted).",
    clearCache: "Clear Cache",
    clearCacheConfirm: "Clear local cache and history? (Your account won't be deleted)",
    deleteAccountDesc: "When you delete your account, all data (avatar, closet, history) will be permanently deleted. This action cannot be undone.",
    deleteAccount: "Delete Account",
    
    // Try-On Results
    tryOnResult: "Try-On Result",
    shareToFeed: "Share to Feed",
    shareToDM: "Send via DM",
    saveToGallery: "Save to Gallery",
    tryAgain: "Try Again",
    close: "Close",
    
    // Advice
    styleAdvice: "Style Advice",
    aiStylistAdvice: "AI Stylist Recommendation",
    loading: "Loading...",
    
    // Weather
    weather: "Weather",
    sunny: "Sunny",
    cloudy: "Cloudy",
    rainy: "Rainy",
    snowy: "Snowy",
    
    // Daily Recommendation
    dailyOutfitRecommendation: "Daily Outfit Recommendation",
    recommendedOutfit: "RECOMMENDED OUTFIT",
    tryThisOutfit: "Try This Outfit",
    maybeLater: "Maybe Later",
    
    // Errors & Messages
    error: "Error",
    success: "Success",
    warning: "Warning",
    info: "Info",
    tryOnError: "Try-on error",
    networkError: "Connection error",
    unknownError: "An error occurred",
    avatarRequired: "You need to create an avatar first",
    selectItemFirst: "Select an item first",
    added: "Added",
    removed: "Removed",
    shared: "Shared",
    
    // SmartCloset Tabs
    studioTab: "Studio",
    studioTitle: "Combo Studio",
    studioDesc: "Drag and drop items to create outfits",
    tryCombo: "Try Combo",
    clearAll: "Clear",
    productsTab: "Items",
    weatherTab: "Weather",
    combosTab: "Combos",
    favoritesTab: "Favorites",
    historyTab: "History",
    closetEmpty: "Closet is Empty",
    addFromShop: "Add items from shop",
    recentSort: "Recently Added",
    brandSort: "Brand",
    colorSort: "Color",
    selectComboItems: "Select items for combo",
    tryOnCombo: "Try Combo",
    saveCombo: "Save Combo",
    comboName: "Combo Name",
    savedCombos: "Saved Combos",
    noCombos: "No combos yet",
    createCombo: "Create Combo",
    noFavorites: "No favorites yet",
    noHistory: "No try-ons yet",
    tryOnHistory: "Try-On History",
    weatherRecommendation: "Weather Recommendation",
    getWeather: "Get Weather",
    locationRequired: "Location permission required",
    noLogsYet: "No logs yet",
    debugLogs: "Debug Logs",
    termsTitle: "Terms of Service",
    lastUpdated: "Last updated",
    kvkkNotice: "Your personal data is protected under GDPR regulations.",
    scrollToRead: "Please scroll down to read all terms",
    decline: "Decline",
    accept: "I Accept",
    processing: "Processing...",
    noAccount: "Don't have an account?",
    haveAccount: "Already have an account?",
    signUp: "Sign up",
    signIn: "Sign in",
    creating: "Creating",
    selected: "Selected",
    loading: "Loading",
    wind: "Wind",
    shareWeather: "Share your location to see weather",
    noSavedCombos: "No Saved Combos",
    createComboHint: "Create and save combos from Items tab",
    addToFavorites: "Add items you like to favorites",
    historyEmpty: "Try-On History Empty",
    historyHint: "Your try-ons will appear here",
    emailVerificationRequired: "Email Verification Required",
    user: "User",
    premiumMember: "Premium Member",
    follower: "Follower",
    displayNameLabel: "Display Name",
    verify: "Verify",
    membership: "Membership",
    premium: "Premium",
    joinDate: "Joined",
    productNotFound: "Product Not Found",
    tryDifferentFilters: "Try different filters",
    sizeStyleAdvice: "Size & Style Advice",
    completed: "Completed",
    startCamera: "Starting camera...",
    takeSelfie: "Take Selfie",
    takePhotosHint: "Take 3 photos from different angles",
    termsAcceptText: "Terms of Service",
    privacyAcceptText: "Privacy Policy",
    readAccepted: ", I have read and accept.",
    occasionSuggestion: "suggestion for",
    groupMaxMembers: "Group can have max 6 people (including you)",
    
    // Misc
    back: "Back",
    next: "Next",
    done: "Done",
    yes: "Yes",
    no: "No",
    confirm: "Confirm",
    delete: "Delete",
    edit: "Edit",
    view: "View",
    download: "Download",
    refresh: "Refresh",
    retry: "Retry",
    selectLanguage: "Select Language",
    turkish: "TÃ¼rkÃ§e",
    english: "English",
    sent: "Sent!",
    verificationEmailSent: "Verification email sent. Check your spam folder too.",
    tooManyRequests: "Too many requests",
    pleaseWait: "Please wait a few minutes and try again.",
    connectionError: "Connection Error",
    firebaseError: "Could not connect to Firebase. Please refresh the page.",
    remove: "Remove",
    studio: "Studio",
    street: "Street",
    office: "Office",
    cafe: "Cafe",
    park: "Park",
    beach: "Beach",
    travel: "Travel",
    fineDining: "Fine Dining",
    rooftop: "Rooftop",
    gallery: "Gallery",
    notVerifiedYet: "Not verified yet",
    clickLinkAndRetry: "Click the link in your email and try again.",
    notFollowingAnyone: "You're not following anyone yet",
    noPostsYetProfile: "No Posts Yet",
    noTriesYet: "No tries yet",
    noCommentsYet: "No comments yet",
    
    // Consent & Legal
    ageRequirement: "18+ Age Requirement",
    ageConfirmText: "I confirm that I am 18 years of age or older.",
    faceDataConsent: "Face Data Consent",
    faceDataConsentText: "I consent to my facial and body features being analyzed from my photos for virtual try-on services.",
    usaTransferConsent: "USA Data Transfer Consent",
    usaTransferConsentText: "I consent to my photos being transferred to the USA via Google Gemini and Firebase infrastructure.",
    sharingConsentText: "I allow my created images to be shared with other users within the app.",
    analyticsConsentText: "I allow analytics tracking to improve the app experience.",
    optionalConsents: "Optional Permissions",
    requiredFields: "Required fields",
    consentRequired: "Consent Required",
    acceptRequiredConsents: "Please accept required consents to continue.",
    kvkkText: "Privacy Policy",
    preInfoForm: "Pre-Information",
    deleteAccountWarning: "All your data will be permanently deleted when you delete your account.",
    deleteAccountConfirmText: "This action cannot be undone. Are you sure you want to delete your account?",
    permanentlyDelete: "Permanently Delete",
    sharingConsentTitle: "Sharing Permission",
    sharingConsentDesc: "Would you like to share your outfit with other users?",
    analyticsConsentTitle: "Improve Experience",
    analyticsConsentDesc: "Help us provide better recommendations by analyzing your try-ons.",
    allowSharing: "Allow Sharing",
    allowAnalytics: "Allow Analytics",
    maybeLater: "Maybe Later",
    dontShowAgain: "Don't show again",
    
    // Tokens & Subscription
    tokens: "Tokens",
    buyTokens: "Buy Tokens",
    buyPackage: "Buy Package",
    subscription: "Subscription",
    premium: "Premium",
    premiumMember: "Premium Member",
    freemium: "Free",
    monthlySubscription: "Monthly Subscription",
    hdTryOns: "HD Try-On Credits",
    unlimitedStyleChat: "Unlimited Style Chat",
    adFreeExperience: "Ad-Free Experience",
    urgentPackage: "Urgent Package",
    urgentPackageDesc: "For tonight's event",
    tryOns: "Try-Ons",
    perMonth: "/mo",
    subscribe: "Subscribe",
    buyNow: "Buy Now",
    currentPlan: "Current Plan",
    insufficientTokens: "Insufficient Tokens",
    needMoreTokens: "Please purchase more tokens.",
    tokenUsed: "1 token used",
    tokensRemaining: "Tokens remaining",
    // Video Tokens
    videoTokens: "Video Tokens",
    videoPackage5: "5 Video Package",
    videoPackage10: "10 Video Package",
    videoPackageDesc5: "Short video try-ons",
    videoPackageDesc10: "5% discount advantage pack",
    videoTryOn: "Video Try-On",
    videoTryOnDesc: "Create 6-second fashion video",
    createVideo: "Create Video",
    videoCreating: "Creating video...",
    videoReady: "Your video is ready!",
    insufficientVideoTokens: "Insufficient Video Tokens",
    needMoreVideoTokens: "Purchase a video package.",
    videoTokenUsed: "1 video token used",
    videoTokensRemaining: "Video tokens remaining",
    videoTab: "Video",
    videoPackages: "Video Packages",
    purchaseFromProfile: "Purchase from profile",
    videoTokenCount: "Video Tokens",
    discountText: "discount",
    whereWillYouWear: "Where Will You Wear This?",
    selectBackground: "Select a setting for your outfit",
    noItemsFound: "No items found",
    
    // Cart & Shop
    cart: "Cart",
    addToCart: "Add to Cart",
    removeFromCart: "Remove from Cart",
    cartEmpty: "Your cart is empty",
    cartTotal: "Total",
    checkout: "Checkout",
    itemsInCart: "items in cart",
    continueShopping: "Continue Shopping",
    proceedToCheckout: "Proceed to Checkout",
    orderSummary: "Order Summary",
    subtotal: "Subtotal",
    shipping: "Shipping",
    freeShipping: "Free Shipping",
    paymentMethod: "Payment Method",
    creditCard: "Credit Card",
    cardNumber: "Card Number",
    expiryDate: "Expiry",
    cvv: "CVV",
    cardHolder: "Card Holder",
    completePayment: "Complete Payment",
    paymentSuccess: "Payment Successful",
    paymentFailed: "Payment Failed",
    orderConfirmed: "Order Confirmed",
    thankYouOrder: "Thank you for your order!",
    externalPurchase: "Buy External",
    affiliateNotice: "This link will redirect you to the seller's site",
    addedToCart: "Added to Cart",
    user: "User",
    add: "Add",
    inCart: "In Cart",
    selectSize: "Select Size",
    deliveryInfo: "Delivery Info",
    fullName: "Full Name",
    phone: "Phone",
    address: "Address",
    city: "City",
    district: "District",
    postalCode: "Postal Code",
    saveAddress: "Save this address",
    savedAddresses: "Saved Addresses",
    useThisAddress: "Use This Address",
    addNewAddress: "Add New Address",
    legalConsent: "Legal Consents",
    distanceSalesAgreement: "Distance Sales Agreement",
    preliminaryInfo: "Preliminary Information Form",
    acceptTermsCheckout: "I have read and accept the Distance Sales Agreement and Preliminary Information Form.",
    mobilePayment: "Mobile Payment",
    applePayment: "Apple Pay",
    googlePayment: "Google Pay",
    operatorPayment: "Carrier Billing",
    continueToPayment: "Continue to Payment"
  }
};

// Language Context
let currentLanguage = localStorage.getItem('trai_language') || 'tr';

const setLanguage = (lang) => {
  currentLanguage = lang;
  localStorage.setItem('trai_language', lang);
};

const t = (key) => {
  return TRANSLATIONS[currentLanguage]?.[key] || TRANSLATIONS['tr'][key] || key;
};

// ============ FIREBASE INIT ============
let auth = null;
let db = null;
let storage = null;
let FIREBASE_OK = false;

try {
  firebase.initializeApp(CONFIG.firebase);
  auth = firebase.auth();
  db = firebase.firestore();
  storage = firebase.storage();
  FIREBASE_OK = true;
  // Test Firebase connection
  auth.onAuthStateChanged(() => {
    console.log('Firebase Auth connected successfully');
  });
} catch (e) {
  FIREBASE_OK = false;
  console.error('Firebase init error:', e);
  // Firebase initialization failed - app will work in offline mode
}

// Helper: Upload avatar to Firebase Storage
async function uploadAvatarToStorage(userId, avatarDataUrl) {
  if (!FIREBASE_OK || !storage || !avatarDataUrl) {
    console.warn('âš ï¸ uploadAvatarToStorage: Missing requirements', { FIREBASE_OK, hasStorage: !!storage, hasAvatar: !!avatarDataUrl });
    return null;
  }
  try {
    console.log('ðŸ“¤ Uploading avatar to Storage...');
    const ref = storage.ref(`avatars/${userId}/base-avatar.png`);
    // Convert data URL to blob
    const response = await fetch(avatarDataUrl);
    const blob = await response.blob();
    // Upload
    await ref.put(blob, { contentType: 'image/png' });
    // Get download URL
    const url = await ref.getDownloadURL();
    console.log('âœ… Avatar uploaded successfully');
    return url;
  } catch (e) {
    console.error('âŒ Avatar upload error:', e.code, e.message);
    return null;
  }
}

// Helper: Download avatar from Firebase Storage as data URL
async function downloadAvatarFromStorage(userId) {
  if (!FIREBASE_OK || !storage) return null;
  
  // 10 saniye timeout
  const timeoutPromise = new Promise((_, reject) => 
    setTimeout(() => reject(new Error('Avatar download timeout')), 10000)
  );
  
  const downloadPromise = (async () => {
    try {
      const ref = storage.ref(`avatars/${userId}/base-avatar.png`);
      const url = await ref.getDownloadURL();
      // Fetch and convert to data URL
      const response = await fetch(url);
      const blob = await response.blob();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    } catch (e) {
      // storage/object-not-found hatasÄ± normal - avatar yok demek
      if (e.code === 'storage/object-not-found') {
        console.log('â„¹ï¸ Avatar Storage\'da bulunamadÄ±');
        return null;
      }
      throw e;
    }
  })();
  
  try {
    return await Promise.race([downloadPromise, timeoutPromise]);
  } catch (e) {
    console.warn('âš ï¸ Avatar indirme hatasÄ±:', e.message);
    return null;
  }
}

// ============ ICONS ============
const Icons = {
  camera:<path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/>,
  film:<><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></>,
  video:<><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></>,
  user:<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/>,
  users:<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
  userPlus:<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></>,
  userMinus:<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/></>,
  messageCircle:<path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>,
  send:<><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
  settings:<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
  bell:<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9 M13.73 21a2 2 0 0 1-3.46 0"/>,
  gift:<><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></>,
  info:<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>,
  layers:<><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>,
  heart:<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>,
  heartFilled:<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" fill="currentColor"/>,
  clock:<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
  trash:<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>,
  bookmark:<path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>,
  grid:<><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></>,
  list:<><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>,
  pants:<path d="M4 2h16v6l-3 14H7L4 8V2z M4 8h16"/>,
  globe:<><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></>,
  world:<><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><path d="M12 2v20"/><path d="M4.93 4.93l14.14 14.14"/><path d="M19.07 4.93L4.93 19.07"/></>,
  image:<><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></>,
  plusCircle:<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></>,
  moreHorizontal:<><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></>,
  upload:<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>,
  copy:<><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>,
  instagram:<><rect x="2" y="2" width="20" height="20" rx="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></>,
  facebook:<path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>,
  twitter:<path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>,
  whatsapp:<path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413z" fill="currentColor" stroke="none"/>,
  shop:<path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z M3 6h18 M16 10a4 4 0 0 1-8 0"/>,
  search:<><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></>,
  shirt:<path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/>,
  sparkles:<path d="M12 3l1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3z"/>,
  ruler:<path d="M21.7 2.3a1 1 0 0 0-1.4 0l-18 18a1 1 0 1 0 1.4 1.4l18-18a1 1 0 0 0 0-1.4z M14.5 8.5l1 1 M11 12l1 1 M7.5 15.5l1 1"/>,
  minus:<path d="M5 12h14"/>,
  plus:<path d="M12 5v14 M5 12h14"/>,
  hanger:<><path d="M12 3a1 1 0 0 0-1 1v1.3a4 4 0 0 0-2.5 6.4L2 18v2h20v-2l-6.5-6.3A4 4 0 0 0 13 5.3V4a1 1 0 0 0-1-1z"/><circle cx="12" cy="8" r="1"/></>,
  x:<path d="M18 6L6 18 M6 6l12 12"/>,
  check:<path d="M20 6L9 17l-5-5"/>,
  edit:<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>,
  chevronLeft:<path d="M15 18l-6-6 6-6"/>,
  chevronRight:<path d="M9 18l6-6-6-6"/>,
  refresh:<path d="M23 4v6h-6 M1 20v-6h6 M3.51 9a9 9 0 0 1 14.85-3.36L23 10 M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>,
  share:<path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8 M16 6l-4-4-4 4 M12 2v13"/>,
  logout:<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9"/>,
  shield:<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
  lock:<><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
  eye:<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>,
  eyeOff:<><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></>,
  mail:<><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></>,
  google:<path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="currentColor" stroke="none"/>,
  sun:<><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>,
  calendar:<><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
  mapPin:<><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>,
  truck:<><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></>,
  arrowLeft:<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>,
  creditCard:<><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></>,
  externalLink:<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></>,
  info:<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>
};

// ============ LOGO ============
const TRAI_LOGO = "data:image/png;base64,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";

// ============ LOGO ============
const Icon = ({name, size=24, className=""}) => (
  <svg width={size} height={size} className={className} viewBox="0 0 24 24"
       fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    {Icons[name]}
  </svg>
);

// ============ HELPERS ============
const sleep = ms => new Promise(r => setTimeout(r, ms));

// Generate unique referral code from user ID
function generateReferralCode(uid) {
  if (!uid) return null;
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Avoid confusing chars
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars[Math.abs(uid.charCodeAt(i % uid.length) * (i + 1)) % chars.length];
  }
  return code;
}

// Get or create device ID for abuse prevention
function getDeviceId() {
  let deviceId = localStorage.getItem('trai_device_id');
  if (!deviceId) {
    deviceId = 'DEV_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('trai_device_id', deviceId);
  }
  return deviceId;
}

function dataUrlToInlinePart(dataUrl, fallbackMime = "image/png") {
  if (!dataUrl || typeof dataUrl !== "string") return null;
  const m = dataUrl.match(/^data:(.*?);base64,(.*)$/);
  if (!m) return null;
  // Ensure valid MIME type - never use application/octet-stream
  let mimeType = m[1] || fallbackMime;
  if (!mimeType || mimeType === "application/octet-stream" || !mimeType.startsWith("image/")) {
    mimeType = fallbackMime;
  }
  return { inlineData: { mimeType, data: m[2] } };
}

// Allowed image hosts for product images
const ALLOWED_IMAGE_HOSTS = new Set([
  "static.zara.net",
  "cdn.dsmcdn.com",
  "img-trendyol-images.mncdn.com",
  "images.unsplash.com",
  "via.placeholder.com",
  "picsum.photos",
  "firebasestorage.googleapis.com"
]);

// ============ DEBUG LOG SYSTEM ============
let DEBUG_MODE = false; // Default kapalÄ±, Settings'ten aÃ§Ä±labilir
const DEBUG_LOGS = [];
const MAX_DEBUG_LOGS = 50;

function debugLog(step, message, type = 'info') {
  if (!DEBUG_MODE) return; // Debug kapalÄ±ysa log yapma
  
  const timestamp = new Date().toLocaleTimeString();
  const log = { timestamp, step, message, type };
  DEBUG_LOGS.unshift(log);
  if (DEBUG_LOGS.length > MAX_DEBUG_LOGS) DEBUG_LOGS.pop();
  
  // Console'a da yaz
  const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warn' ? 'âš ï¸' : 'ðŸ“';
  console.log(`${icon} [${step}] ${message}`);
  
  // UI gÃ¼ncelle
  if (typeof window !== 'undefined' && window.updateDebugPanel) {
    window.updateDebugPanel();
  }
}

// ============ IMAGE PROCESSING ============
const IMAGE_CACHE = {};
const MAX_IMAGE_SIZE = 800; // Max dimension for API
const IMAGE_QUALITY = 0.8;

// Resize image to max dimension
function resizeImage(img, maxSize = MAX_IMAGE_SIZE) {
  let width = img.naturalWidth || img.width;
  let height = img.naturalHeight || img.height;
  
  // KÃ¼Ã§Ã¼ltme gerekli mi?
  if (width <= maxSize && height <= maxSize) {
    // KÃ¼Ã§Ã¼ltme gerekmez ama yine de canvas'a Ã§iz (CORS iÃ§in)
    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    return canvas.toDataURL('image/jpeg', IMAGE_QUALITY);
  }
  
  // Oran koruyarak kÃ¼Ã§Ã¼lt
  if (width > height) {
    height = Math.round(height * maxSize / width);
    width = maxSize;
  } else {
    width = Math.round(width * maxSize / height);
    height = maxSize;
  }
  
  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, width, height);
  
  debugLog('Resize', `${img.naturalWidth}x${img.naturalHeight} â†’ ${width}x${height}`, 'info');
  return canvas.toDataURL('image/jpeg', IMAGE_QUALITY);
}

// Load and cache image with CORS support
async function loadImageWithCORS(imageUrl, timeout = 8000) {
  // Cache check
  if (IMAGE_CACHE[imageUrl]) {
    return IMAGE_CACHE[imageUrl]; // Silent cache hit
  }
  
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    
    const timer = setTimeout(() => {
      resolve(null);
    }, timeout);
    
    img.onload = () => {
      clearTimeout(timer);
      try {
        const dataUrl = resizeImage(img, MAX_IMAGE_SIZE);
        IMAGE_CACHE[imageUrl] = dataUrl;
        resolve(dataUrl);
      } catch (e) {
        resolve(null);
      }
    };
    
    img.onerror = () => {
      clearTimeout(timer);
      resolve(null);
    };
    
    img.src = imageUrl;
  });
}

// Preload all product images
// Preload DISABLED - Too many products (5000+) kills performance
// Images now load on-demand with lazy loading
async function preloadAllProductImages() {
  // Only preload first 25 MODO products for AI features
  const products = typeof MODO_PRODUCTS !== 'undefined' ? MODO_PRODUCTS.slice(0, 25) : [];
  debugLog('Preload', `${products.length} MODO gÃ¶rseli yÃ¼kleniyor (AI iÃ§in)...`, 'info');
  
  let loaded = 0;
  for (const product of products) {
    if (product.image && !IMAGE_CACHE[product.image]) {
      const result = await loadImageWithCORS(product.image);
      if (result) loaded++;
      await new Promise(r => setTimeout(r, 50));
    }
  }
  debugLog('Preload', `${loaded}/${products.length} gÃ¶rsel yÃ¼klendi`, 'success');
}

// Start preloading (only MODO products)
if (typeof window !== 'undefined') {
  window.addEventListener('load', () => {
    setTimeout(preloadAllProductImages, 2000);
  });
}

// Main function to get product image
async function getProductImageDataUrl(imageUrl) {
  // 1. Cache - instant return
  if (IMAGE_CACHE[imageUrl]) {
    return IMAGE_CACHE[imageUrl];
  }
  
  // 2. Load with CORS (fast path)
  const result = await loadImageWithCORS(imageUrl);
  if (result) {
    return result;
  }
  
  // 3. Fallback: fetch as blob (shorter timeout)
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 6000); // 10s â†’ 6s
    
    const res = await fetch(imageUrl, { 
      mode: 'cors',
      signal: controller.signal
    });
    clearTimeout(timeout);
    
    if (res.ok) {
      const blob = await res.blob();
      
      // Blob'u image'a Ã§evir ve resize et
      const img = await new Promise((resolve, reject) => {
        const image = new Image();
        image.onload = () => resolve(image);
        image.onerror = reject;
        image.src = URL.createObjectURL(blob);
      });
      
      const dataUrl = resizeImage(img, MAX_IMAGE_SIZE);
      URL.revokeObjectURL(img.src);
      IMAGE_CACHE[imageUrl] = dataUrl;
      return dataUrl;
    }
  } catch (e) {
    // Silent fail
  }
  
  return null;
}

// Add watermark to image - Professional logo watermark (using actual TrAi logo)
async function addWatermark(dataUrl, text = 'TrAi Style', options = {}) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      try {
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        
        // Draw original image
        ctx.drawImage(img, 0, 0);
        
        // === WATERMARK: Sol alt kÃ¶ÅŸe - TrAi Logo ===
        const logoImg = new Image();
        logoImg.onload = () => {
          try {
            const logoSize = Math.max(45, Math.min(canvas.width * 0.1, 80));
            const logoPadding = logoSize * 0.25;
            const logoX = logoPadding;
            const logoY = canvas.height - logoPadding - logoSize;
            
            // Draw logo with slight shadow
            ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
            ctx.shadowBlur = 0;
            
            // Add trai.style text next to logo
            const fontSize = Math.max(12, logoSize * 0.25);
            ctx.font = `bold ${fontSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'left';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
            ctx.shadowBlur = 3;
            ctx.fillText('trai.style', logoX + logoSize + 8, logoY + logoSize / 2);
            ctx.shadowBlur = 0;
            
            const result = canvas.toDataURL('image/jpeg', 0.92);
            resolve(result);
          } catch (e) {
            resolve(dataUrl);
          }
        };
        logoImg.onerror = () => {
          // Fallback: just text watermark if logo fails
          const fontSize = Math.max(14, canvas.width * 0.03);
          ctx.font = `bold ${fontSize}px -apple-system, sans-serif`;
          ctx.textBaseline = 'bottom';
          ctx.textAlign = 'left';
          ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
          ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
          ctx.shadowBlur = 3;
          ctx.fillText('trai.style', fontSize, canvas.height - fontSize);
          resolve(canvas.toDataURL('image/jpeg', 0.92));
        };
        logoImg.src = LOGO_BASE64;
      } catch (e) {
        console.error('Watermark error:', e);
        resolve(dataUrl);
      }
    };
    img.onerror = () => resolve(dataUrl);
    img.src = dataUrl;
  });
}

// Compress result image from API (reduce size for React state)
// Now includes optional watermark
async function compressResultImage(dataUrl, maxSize = 1024, quality = 0.85, addWatermarkFlag = true, isGoldUser = false) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = async () => {
      try {
        let width = img.naturalWidth;
        let height = img.naturalHeight;
        
        // KÃ¼Ã§Ã¼ltme gerekiyorsa
        if (width > maxSize || height > maxSize) {
          if (width > height) {
            height = Math.round(height * maxSize / width);
            width = maxSize;
          } else {
            width = Math.round(width * maxSize / height);
            height = maxSize;
          }
        }
        
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        let compressed = canvas.toDataURL('image/jpeg', quality);
        
        // Add watermark unless Gold user
        if (addWatermarkFlag && !isGoldUser) {
          compressed = await addWatermark(compressed, 'TrAi Style');
        }
        
        resolve(compressed);
      } catch (e) {
        reject(e);
      }
    };
    img.onerror = () => reject(new Error('Image load failed'));
    img.src = dataUrl;
  });
}

// Safe image display in new tab (no document.write with user data)
function openImageInNewTabSafe(dataUrl) {
  // Security: Only allow data:image/* URLs
  if (typeof dataUrl !== "string" || !dataUrl.startsWith("data:image/")) {
    return false;
  }

  // Download the image instead of opening popup (popup blockers cause about:blank)
  try {
    const link = document.createElement('a');
    link.href = dataUrl;
    link.download = `trai-style-${Date.now()}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    return true;
  } catch (e) {
    console.error('Download failed:', e);
    return false;
  }
}

async function shareImage(dataUrl, options = {}) {
  // Validate dataUrl format
  if (typeof dataUrl !== "string" || !dataUrl.startsWith("data:image/")) {
    console.error('Invalid image data');
    return false;
  }
  
  try {
    // Try native share with file first (mobile)
    if (navigator.share && navigator.canShare) {
      const res = await fetch(dataUrl);
      const blob = await res.blob();
      const file = new File([blob], `trai-style-${Date.now()}.png`, { type: "image/png" });
      
      if (navigator.canShare({ files: [file] })) {
        await navigator.share({ 
          title: "TrAi Style", 
          text: "TrAi Style ile oluÅŸturdum âœ¨ Sende dene â†’ trai.style", 
          files: [file] 
        });
        return true;
      }
    }
    
    // Fallback: Share with just text and URL (no file)
    if (navigator.share) {
      try {
        await navigator.share({ 
          title: "TrAi Style", 
          text: "TrAi Style ile kendi kombinimi oluÅŸturdum! âœ¨", 
          url: "https://trai.style" 
        });
        return true;
      } catch (shareErr) {
        console.log('Share cancelled or failed:', shareErr);
      }
    }
  } catch (err) {
    console.log('Native share not available:', err);
  }
  
  // Final fallback: Open in new tab
  return openImageInNewTabSafe(dataUrl);
}

// Upload image to Firebase and get shareable URL
async function uploadAndShareImage(dataUrl, authUser, storage) {
  if (!dataUrl || !dataUrl.startsWith('data:image') || !storage || !authUser?.uid) {
    return shareImage(dataUrl);
  }
  
  try {
    // Upload to Firebase Storage
    const timestamp = Date.now();
    const storageRef = storage.ref(`shared_combos/${authUser.uid}/${timestamp}.jpg`);
    const response = await fetch(dataUrl);
    const blob = await response.blob();
    await storageRef.put(blob);
    const imageUrl = await storageRef.getDownloadURL();
    
    console.log('âœ… Image uploaded for sharing:', imageUrl);
    
    // Create share text with trai.style link
    const shareText = `TrAi Style ile oluÅŸturduÄŸum kombine bak! âœ¨\n\nðŸ”— GÃ¶rsel: ${imageUrl}\n\nðŸ“± Sen de dene: https://trai.style`;
    
    // Try to share with native share API
    if (navigator.share) {
      try {
        // First try with file
        const imgResponse = await fetch(dataUrl);
        const imgBlob = await imgResponse.blob();
        const file = new File([imgBlob], `trai-kombin-${timestamp}.jpg`, { type: 'image/jpeg' });
        
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: "TrAi Style Kombin",
            text: "TrAi Style ile oluÅŸturduÄŸum kombine bak! âœ¨ Sen de dene â†’ trai.style",
            files: [file]
          });
          return true;
        }
      } catch(e) {
        // File share failed, try URL only
      }
      
      // Fallback: share URL only
      await navigator.share({
        title: "TrAi Style Kombin",
        text: "TrAi Style ile oluÅŸturduÄŸum kombine bak! âœ¨",
        url: `https://trai.style?combo=${timestamp}`
      });
      return true;
    }
    
    // Fallback: Copy share text to clipboard
    if (navigator.clipboard) {
      await navigator.clipboard.writeText(shareText);
      return { copied: true, url: imageUrl };
    }
    
    // Last resort: open in new tab
    window.open(imageUrl, '_blank');
    return { opened: true, url: imageUrl };
    
  } catch (err) {
    console.error('Upload and share error:', err);
    return shareImage(dataUrl);
  }
}

function safeJsonParse(x, fallback) {
  try { return JSON.parse(x); } catch { return fallback; }
}

// ============ ULTRA-POWERFUL AI SERVICE ============
const AI = {
  async callGenerateContent({ model, parts, imageConfig, timeoutMs = CONFIG.timeoutMs }) {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), timeoutMs);

    // Build generation config for image generation
    const generationConfig = {
      responseModalities: ["TEXT", "IMAGE"]
    };

    // Safety settings - relaxed for fashion/clothing content
    const safetySettings = [
      { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
      { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
      { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
      { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
    ];

    const body = {
      contents: [{ parts }],
      generationConfig,
      safetySettings
    };

    const startTime = Date.now();
    
    try {
      // Use API route if configured (hides API key server-side)
      const apiUrl = CONFIG.useApiRoute 
        ? '/api/gemini'
        : `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
      
      const headers = { "Content-Type": "application/json" };
      if (!CONFIG.useApiRoute && CONFIG.apiKey) {
        headers["x-goog-api-key"] = CONFIG.apiKey;
      }
      
      // If using API route, include model in body
      const requestBody = CONFIG.useApiRoute 
        ? { model, ...body }
        : body;
      
      const res = await fetch(apiUrl, {
        method: "POST",
        headers,
        body: JSON.stringify(requestBody),
        signal: ctrl.signal
      });

      const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
      
      const data = await res.json().catch(() => ({}));
      
      if (!res.ok || data?.error) {
        const errMsg = data?.error?.message || `HTTP ${res.status}`;
        // Model bulunamadÄ± hatasÄ±
        if (errMsg.includes('not found') || errMsg.includes('404')) {
          throw new Error("Model bulunamadÄ±. API yapÄ±landÄ±rmasÄ±nÄ± kontrol edin.");
        }
        // API key hatasÄ±
        if (errMsg.includes('API key') || res.status === 401 || res.status === 403) {
          throw new Error("API anahtarÄ± geÃ§ersiz veya yetkisiz.");
        }
        // Quota/Rate limit hatasÄ±
        if (errMsg.includes('quota') || errMsg.includes('rate') || res.status === 429) {
          throw new Error("API limiti aÅŸÄ±ldÄ±. 30 saniye bekleyip tekrar dene.");
        }
        // Resource exhausted
        if (errMsg.includes('RESOURCE_EXHAUSTED') || errMsg.includes('exhausted')) {
          throw new Error("Sunucu yoÄŸun. Biraz bekleyip tekrar dene.");
        }
        throw new Error(errMsg);
      }

      // Check for blocked content or empty response
      if (data?.candidates?.[0]?.finishReason === 'SAFETY') {
        throw new Error("Ä°Ã§erik gÃ¼venlik filtresine takÄ±ldÄ±");
      }
      
      if (data?.candidates?.[0]?.finishReason === 'RECITATION') {
        throw new Error("Ä°Ã§erik kÄ±sÄ±tlamasÄ±. FarklÄ± bir fotoÄŸraf deneyin.");
      }
      
      if (!data?.candidates?.length) {
        throw new Error("API yanÄ±t vermedi - model meÅŸgul olabilir");
      }

      // YanÄ±tta gÃ¶rsel var mÄ± kontrol et
      for (const c of (data?.candidates || [])) {
        for (const p of (c?.content?.parts || [])) {
          if (p.inlineData?.data) {
            // Ensure valid image MIME type
            let mimeType = p.inlineData.mimeType || "image/png";
            if (!mimeType.startsWith("image/") || mimeType === "application/octet-stream") {
              mimeType = "image/png";
            }
            const rawSize = Math.round(p.inlineData.data.length / 1024);
            
            // GÃ¶rseli kÃ¼Ã§Ã¼lt (bÃ¼yÃ¼kse)
            const rawDataUrl = `data:${mimeType};base64,${p.inlineData.data}`;
            
            if (rawSize > 400) { // 300KB â†’ 400KB (daha az sÄ±kÄ±ÅŸtÄ±rma)
              try {
                const compressed = await compressResultImage(rawDataUrl);
                return compressed;
              } catch (compErr) {
                return rawDataUrl;
              }
            }
            
            console.log(`âœ… GÃ¶rsel: ${elapsed}s, ${rawSize}KB`);
            return rawDataUrl;
          }
        }
      }

      // If we got here, there's text but no image
      const textResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (textResponse) {
        throw new Error("Model gÃ¶rsel Ã¼retemedi. FarklÄ± fotoÄŸraflar deneyin.");
      }

      throw new Error("GÃ¶rsel alÄ±namadÄ±");
    } catch (e) {
      if (e.name === "AbortError") {
        throw new Error("Ä°stek zaman aÅŸÄ±mÄ±na uÄŸradÄ± (" + (timeoutMs/1000) + "s)");
      }
      throw e;
    } finally {
      clearTimeout(timer);
    }
  },

  async generateWithFallback(parts, imageConfig) {
    let lastError;
    const maxAttempts = 2;
    
    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
      try {
        const result = await this.callGenerateContent({ 
          model: CONFIG.imageModel, 
          parts, 
          imageConfig,
          timeoutMs: CONFIG.timeoutMs
        });
        
        // SonuÃ§ geÃ§erli mi kontrol et
        if (result && result.startsWith('data:image')) {
          return result;
        }
        throw new Error("GeÃ§ersiz gÃ¶rsel formatÄ±");
      } catch (e) {
        lastError = e;
        
        // Son deneme deÄŸilse ve timeout/network hatasÄ± deÄŸilse bekle
        if (attempt < maxAttempts) {
          const isRetryable = !e.message.includes('zaman aÅŸÄ±mÄ±') && 
                             !e.message.includes('gÃ¼venlik filtresine');
          if (isRetryable) {
            await sleep(800); // 1.5s â†’ 0.8s
            continue;
          }
        }
        break;
      }
    }
    
    // KullanÄ±cÄ± dostu hata mesajlarÄ±
    const errorMsg = lastError?.message || 'Bilinmeyen hata';
    if (errorMsg.includes('zaman aÅŸÄ±mÄ±')) {
      throw new Error('Ä°ÅŸlem Ã§ok uzun sÃ¼rdÃ¼. LÃ¼tfen tekrar dene.');
    }
    if (errorMsg.includes('gÃ¼venlik filtresine')) {
      throw new Error('GÃ¶rsel oluÅŸturulamadÄ±. FarklÄ± bir Ã¼rÃ¼n dene.');
    }
    if (errorMsg.includes('meÅŸgul')) {
      throw new Error('Sistem yoÄŸun. Biraz bekleyip tekrar dene.');
    }
    throw new Error('GÃ¶rsel oluÅŸturulamadÄ±. Tekrar dene.');
  },

  async generateBaseAvatar(params, photoDataUrls) {
    const gender = params.gender === "female" ? "woman" : "man";
    
    const bodyTypeDesc = {
      slim: "slim/slender",
      athletic: "athletic/fit",
      average: "average/medium",
      curvy: "curvy/full-figured",
      plus: "plus-size"
    }[params.bodyType] || "average";

    // BaÅŸÃ¶rtÃ¼sÃ¼/Hijab kontrolÃ¼
    const hijabInstruction = params.hijab ? `
- HIJAB/HEADSCARF: The person wears a modern, elegant hijab. Style the hijab in contemporary Turkish fashion - elegantly wrapped with a sophisticated look. Choose a neutral color (white, beige, or soft gray) that complements the base outfit. The hijab should look natural, stylish, and high-quality.` : '';

    // SaÃ§ bilgisi (baÅŸÃ¶rtÃ¼sÃ¼ yoksa)
    const hairInstruction = !params.hijab ? `
- Hair: ${params.hairColor || 'natural'} color, ${params.hairLength || 'medium'} length, ${params.hairType || 'natural'} texture. Preserve the exact hair from reference photos.` : '';

    // Professional hyper-realistic avatar generation prompt
    const prompt = `Task: Generate a hyper-realistic, 8K resolution FULL-BODY fashion portrait of this specific person based on the reference photos.

CRITICAL FRAMING REQUIREMENT:
- Generate a COMPLETE HEAD-TO-TOE full-body image
- The ENTIRE person must be visible: head, face, torso, arms, legs, and feet
- Camera should capture the full standing figure with some space above head and below feet
- Do NOT crop at waist, knees, or any other point - show the COMPLETE body

Identity & Body:
- Subject: ${gender}, ${params.age} years old.
- Height: ${params.height}cm, Weight: ${params.weight}kg.
- Body Type: ${bodyTypeDesc} build.
- Skin Tone: ${params.skinTone || 'natural'}.${hairInstruction}${hijabInstruction}
- CRITICAL IDENTITY LOCK: You MUST preserve the EXACT facial features from the reference photos - same face shape, bone structure, eyes, nose, lips, skin texture, and skin tone. The generated face must be 100% identical to the reference. This is the highest priority.

Pose & Setting:
- Pose: Standing straight, facing forward, arms slightly relaxed at sides (A-pose or neutral fashion pose). Full body visible from head to feet.
- Background: Clean, solid white background with soft studio lighting.
- Clothing: Wearing a tight-fitting plain white t-shirt and simple black pants with plain shoes (neutral base outfit for virtual try-on).
- Footwear: Include simple white sneakers or black shoes - feet MUST be visible.

Output: Professional full-body fashion catalog photography showing complete figure from head to toe, sharp focus, natural skin texture, photorealistic quality.`;

    const parts = [{ text: prompt }];
    for (const p of photoDataUrls) {
      const inline = dataUrlToInlinePart(p, "image/jpeg");
      if (inline) parts.push(inline);
    }

    return await this.generateWithFallback(parts, null);
  },

  async tryOnSingle(baseAvatarDataUrl, item, backgroundValue, userParams = {}) {
    debugLog('TryOn', `Tek Ã¼rÃ¼n: ${item.name}`, 'info');
    
    if (!baseAvatarDataUrl || !baseAvatarDataUrl.startsWith('data:image')) {
      debugLog('TryOn', 'Avatar geÃ§ersiz', 'error');
      throw new Error("GeÃ§ersiz avatar formatÄ±");
    }
    
    const avatarSize = Math.round(baseAvatarDataUrl.length / 1024);
    debugLog('TryOn', `Avatar: ${avatarSize}KB`, 'info');
    
    const avatarInline = dataUrlToInlinePart(baseAvatarDataUrl, "image/png");
    if (!avatarInline) {
      debugLog('TryOn', 'Avatar inline dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lemedi', 'error');
      throw new Error("Avatar gÃ¶rseli okunamadÄ±");
    }

    // ÃœrÃ¼n gÃ¶rselini al
    debugLog('TryOn', 'ÃœrÃ¼n gÃ¶rseli yÃ¼kleniyor...', 'info');
    const itemDataUrl = await getProductImageDataUrl(item.image);
    if (!itemDataUrl) {
      debugLog('TryOn', 'ÃœrÃ¼n gÃ¶rseli alÄ±namadÄ±', 'error');
      throw new Error("ÃœrÃ¼n gÃ¶rseli yÃ¼klenemedi. SayfayÄ± yenileyip tekrar deneyin.");
    }
    
    const itemSize = Math.round(itemDataUrl.length / 1024);
    debugLog('TryOn', `ÃœrÃ¼n gÃ¶rseli: ${itemSize}KB`, 'success');
    
    const itemInline = dataUrlToInlinePart(itemDataUrl, "image/jpeg");
    if (!itemInline) {
      debugLog('TryOn', 'ÃœrÃ¼n inline dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lemedi', 'error');
      throw new Error("ÃœrÃ¼n gÃ¶rseli iÅŸlenemedi");
    }

    const isTop = item.category === 'top';
    const isBottom = item.category === 'bottom';
    const isOuterwear = item.category === 'outerwear';
    const isFullbody = item.category === 'fullbody';
    
    // Professional VTO prompt with specific action
    const action = isOuterwear ? 'Layer this outerwear OVER the existing outfit' : 
                   isTop ? 'Swap the upper body garment with this top' : 
                   isFullbody ? 'Replace the entire outfit with this dress/jumpsuit' :
                   'Swap the lower body garment with this bottom';
    
    const garmentDetails = isTop ? 'ensure proper tucking or hemline at the waist' :
                          isBottom ? 'ensure correct length and natural break at the shoes' :
                          isOuterwear ? 'layer naturally over the base outfit, show proper collar and sleeve positioning' :
                          'ensure the dress/jumpsuit fits the body naturally';
    
    // Dynamic background based on selection
    const bgDescription = backgroundValue || 'Clean white professional photography studio with seamless backdrop';
    
    // BaÅŸÃ¶rtÃ¼sÃ¼/Hijab desteÄŸi
    const hijabInstruction = userParams.hijab ? `
8. HIJAB/HEADSCARF: The person wears a hijab/headscarf. Add a modern, stylish hijab that complements the outfit colors and style. The hijab should be elegantly wrapped in contemporary Turkish fashion style, matching or complementing the ${item.color} garment. Ensure the hijab fabric and texture look realistic and high-quality.` : '';
    
    const prompt = `Task: Professional Virtual Try-On (VTO).

Inputs:
- Image 1: Target Model (The Person) - THIS IS THE SACRED REFERENCE FOR FACIAL IDENTITY.
- Image 2: Reference Garment (${item.color} ${item.type} by ${item.brandName}).

CRITICAL FACE PRESERVATION PROTOCOL (HIGHEST PRIORITY):
â˜… FACE LOCK LEVEL: ABSOLUTE - The face in the output MUST be a pixel-perfect copy of Image 1.
â˜… DO NOT generate a new face. DO NOT modify, enhance, beautify, or alter ANY facial feature.
â˜… Preserve EXACTLY: Face shape, jawline, cheekbones, forehead, chin profile.
â˜… Preserve EXACTLY: Eyes (shape, size, distance, color, eyelids, lashes, eyebrows).
â˜… Preserve EXACTLY: Nose (bridge, tip, nostrils, width, length).
â˜… Preserve EXACTLY: Lips (shape, fullness, color, cupid's bow).
â˜… Preserve EXACTLY: Skin (texture, tone, any marks, freckles, or features).
â˜… Preserve EXACTLY: Ears, hairline, hair color, hair texture, hairstyle.
â˜… The face should look like a photograph of the SAME person, not a similar person.
â˜… If wearing hijab in reference, preserve the hijab style and coverage.

Instructions:
1. ACTION: ${action}. Apply the garment from Image 2 onto the person in Image 1.
2. Fit & Physics: Ensure the clothing fits the body type naturally. Accurately render fabric folds, texture, draping, and gravity effects.
3. Lighting Integration: Match the lighting and shadows of the new garment to the environment.
4. Garment Details: ${garmentDetails}.
5. FRAMING: Generate a FULL-BODY shot from head to toe. The entire person must be visible including face, torso, legs, and feet/shoes.
6. BACKGROUND & SETTING: Place the person in this environment: ${bgDescription}. Ensure the lighting, shadows, and atmosphere match this setting realistically.${hijabInstruction}

FINAL CHECK: Before outputting, verify the face is IDENTICAL to Image 1. If not identical, regenerate.

Output: High-quality full-body fashion photograph, 8K resolution, photorealistic, commercial quality.`;

    const parts = [{ text: prompt }, avatarInline, itemInline];
    return await this.generateWithFallback(parts, null);
  },

  async tryOnCombo(baseAvatarDataUrl, items, backgroundValue, userParams = {}) {
    if (!baseAvatarDataUrl || !baseAvatarDataUrl.startsWith('data:image')) {
      throw new Error("GeÃ§ersiz avatar formatÄ±");
    }

    const top = items.find(i => i.category === "top");
    const bottom = items.find(i => i.category === "bottom");
    const outerwear = items.find(i => i.category === "outerwear");

    // Tek Ã¼rÃ¼n varsa tryOnSingle kullan
    if (items.length === 1) {
      return await this.tryOnSingle(baseAvatarDataUrl, items[0], backgroundValue, userParams);
    }

    const avatarInline = dataUrlToInlinePart(baseAvatarDataUrl, "image/png");
    if (!avatarInline) throw new Error("Avatar gÃ¶rseli okunamadÄ±");

    // PARALEL gÃ¶rsel yÃ¼kleme - Ã§ok daha hÄ±zlÄ±!
    const [topDataUrl, bottomDataUrl, outerwearDataUrl] = await Promise.all([
      top ? getProductImageDataUrl(top.image) : Promise.resolve(null),
      bottom ? getProductImageDataUrl(bottom.image) : Promise.resolve(null),
      outerwear ? getProductImageDataUrl(outerwear.image) : Promise.resolve(null)
    ]);
    
    const topInline = topDataUrl ? dataUrlToInlinePart(topDataUrl, "image/jpeg") : null;
    const bottomInline = bottomDataUrl ? dataUrlToInlinePart(bottomDataUrl, "image/jpeg") : null;
    const outerwearInline = outerwearDataUrl ? dataUrlToInlinePart(outerwearDataUrl, "image/jpeg") : null;

    // En az bir gÃ¶rsel gerekli
    if (!topInline && !bottomInline && !outerwearInline) {
      throw new Error("ÃœrÃ¼n gÃ¶rselleri yÃ¼klenemedi. SayfayÄ± yenileyip tekrar deneyin.");
    }

    // Dynamic background based on selection
    const bgDescription = backgroundValue || 'Clean white professional photography studio with seamless backdrop';
    
    // BaÅŸÃ¶rtÃ¼sÃ¼/Hijab talimatÄ± - tÃ¼m promptlara eklenecek
    const hijabInstruction = userParams.hijab ? `
HIJAB REQUIREMENT: The person wears a hijab/headscarf. Add a modern, elegant hijab that complements the outfit colors. Style it in contemporary Turkish fashion - elegantly wrapped and matching the overall look. The hijab color should harmonize with the garments being worn.` : '';

    let prompt;
    const parts = [{ text: '' }, avatarInline];
    
    // Face preservation protocol for all combo prompts
    const faceProtocol = `
CRITICAL FACE PRESERVATION PROTOCOL (HIGHEST PRIORITY):
â˜… FACE LOCK LEVEL: ABSOLUTE - The face in the output MUST be a pixel-perfect copy of Image 1.
â˜… DO NOT generate a new face. DO NOT modify, enhance, beautify, or alter ANY facial feature.
â˜… Preserve EXACTLY: Face shape, jawline, cheekbones, forehead, chin profile.
â˜… Preserve EXACTLY: Eyes (shape, size, distance, color, eyelids, lashes, eyebrows).
â˜… Preserve EXACTLY: Nose (bridge, tip, nostrils, width, length).
â˜… Preserve EXACTLY: Lips (shape, fullness, color, cupid's bow).
â˜… Preserve EXACTLY: Skin (texture, tone, any marks, freckles, or features).
â˜… Preserve EXACTLY: Ears, hairline, hair color, hair texture, hairstyle.
â˜… The face should look like a photograph of the SAME person, not a similar person.
â˜… If wearing hijab in reference, preserve the hijab style and coverage exactly.`;

    // 3 Ã¼rÃ¼n: top + bottom + outerwear (Full layered outfit)
    if (topInline && bottomInline && outerwearInline) {
      parts.push(topInline, bottomInline, outerwearInline);
      prompt = `Task: Complete Layered Outfit Virtual Try-On.

Inputs:
- Image 1: Target Model - THIS IS THE SACRED REFERENCE FOR FACIAL IDENTITY.
- Image 2: Top Garment (${top.color} ${top.type}).
- Image 3: Bottom Garment (${bottom.color} ${bottom.type}).
- Image 4: Outerwear (${outerwear.color} ${outerwear.type}).
${faceProtocol}

Directives:
1. LAYERING: Dress the model with the top (Img 2) as base layer, bottom (Img 3) for lower body, and outerwear (Img 4) as the outer layer worn OPEN over the top.
2. Realism: Pay meticulous attention to how garments interact - waistline tucking, jacket draping over shoulders, natural fabric folds.
3. Cohesion: Create a stylistically cohesive look with proper proportions and layering.
5. FRAMING: Generate a FULL-BODY shot from head to toe. The entire person must be visible including face, torso, legs, and feet/shoes.
6. BACKGROUND & SETTING: Place the person in this environment: ${bgDescription}. Ensure lighting and atmosphere match this setting.${hijabInstruction}

Quality: Masterpiece, full-body commercial fashion photography, high detail, 8K resolution.`;
    }
    // 2 Ã¼rÃ¼n: top + bottom (Complete outfit)
    else if (topInline && bottomInline) {
      parts.push(topInline, bottomInline);
      prompt = `Task: Complete Outfit Virtual Try-On.

Inputs:
- Image 1: Target Model.
- Image 2: Top Garment (${top.color} ${top.type}).
- Image 3: Bottom Garment (${bottom.color} ${bottom.type}).

Directives:
1. OUTFIT: Dress the model in Image 1 with BOTH the top (Img 2) and bottom (Img 3).
2. Styling: Create a cohesive look. Decide on tucking (tucked in or out) based on current fashion trends and the garment types.
3. Waistline Realism: Pay close attention to where the garments meet. Create realistic shadows, fabric overlap, and natural interaction.
4. CRITICAL IDENTITY LOCK: The face MUST remain 100% identical to Image 1 - preserve exact facial features, bone structure, eyes, nose, lips, skin texture, skin tone. NO modifications allowed.
5. FRAMING: Generate a FULL-BODY shot from head to toe. The entire person must be visible including face, torso, legs, and feet/shoes.
6. BACKGROUND & SETTING: Place the person in this environment: ${bgDescription}. Ensure lighting and atmosphere match this setting.${hijabInstruction}

Quality: Masterpiece, full-body commercial fashion photography, high detail, photorealistic.`;
    }
    // 2 Ã¼rÃ¼n: top + outerwear
    else if (topInline && outerwearInline) {
      parts.push(topInline, outerwearInline);
      prompt = `Task: Layered Top + Outerwear Virtual Try-On.

Inputs:
- Image 1: Target Model.
- Image 2: Top Garment (${top.color} ${top.type}).
- Image 3: Outerwear (${outerwear.color} ${outerwear.type}).

Directives:
1. LAYERING: Put the top (Img 2) on the model, then layer the outerwear (Img 3) OVER it, worn open.
2. Auto-Complete: Generate stylish dark trousers or jeans that complement the outfit.
3. Realism: Show how the outerwear drapes over the top layer naturally.
4. CRITICAL IDENTITY LOCK: The face MUST remain 100% identical to Image 1 - preserve exact facial features, bone structure, eyes, nose, lips, skin texture, skin tone. NO modifications allowed.
5. FRAMING: Generate a FULL-BODY shot from head to toe. The entire person must be visible including face, torso, legs, and feet/shoes.
6. BACKGROUND & SETTING: Place the person in this environment: ${bgDescription}. Ensure lighting matches.${hijabInstruction}

Style: High-end full-body fashion photography, photorealistic.`;
    }
    // 2 Ã¼rÃ¼n: bottom + outerwear
    else if (bottomInline && outerwearInline) {
      parts.push(bottomInline, outerwearInline);
      prompt = `Task: Bottom + Outerwear Virtual Try-On.

Inputs:
- Image 1: Target Model.
- Image 2: Bottom Garment (${bottom.color} ${bottom.type}).
- Image 3: Outerwear (${outerwear.color} ${outerwear.type}).

Directives:
1. OUTFIT: Put the bottom (Img 2) on the model, layer the outerwear (Img 3) on top.
2. Auto-Complete: Generate a clean white or neutral t-shirt/blouse underneath the outerwear.
3. Layering: Show the outerwear worn open with the auto-generated top visible.
4. CRITICAL IDENTITY LOCK: The face MUST remain 100% identical to Image 1 - preserve exact facial features, bone structure, eyes, nose, lips, skin texture, skin tone. NO modifications allowed.
5. FRAMING: Generate a FULL-BODY shot from head to toe. The entire person must be visible including face, torso, legs, and feet/shoes.
6. BACKGROUND & SETTING: Place the person in this environment: ${bgDescription}. Ensure lighting matches.${hijabInstruction}

Style: High-end full-body fashion photography, photorealistic.`;
    }
    // Sadece top
    else if (topInline) {
      parts.push(topInline);
      prompt = `Task: Style Assistant - Top Try-On with Auto-Styling.

Inputs:
- Image 1: Target Model.
- Image 2: New Top Garment (${top.color} ${top.type}).

Instructions:
1. Replace the model's current top with the garment from Image 2.
2. Auto-Complete: Generate a pair of matching, stylish dark trousers or jeans to complete the look harmoniously.
3. Fit: Ensure the new top fits the body type perfectly with natural draping.
4. CRITICAL IDENTITY LOCK: The face MUST remain 100% identical to Image 1 - preserve exact facial features, bone structure, eyes, nose, lips, skin texture, skin tone. NO modifications allowed.
5. FRAMING: Generate a FULL-BODY shot from head to toe. The entire person must be visible including face, torso, legs, and feet/shoes.
6. BACKGROUND & SETTING: Place the person in this environment: ${bgDescription}. Ensure lighting matches.${hijabInstruction}

Style: High-end full-body fashion photography, photorealistic.`;
    }
    // Sadece bottom
    else if (bottomInline) {
      parts.push(bottomInline);
      prompt = `Task: Style Assistant - Bottom Try-On with Auto-Styling.

Inputs:
- Image 1: Target Model.
- Image 2: New Bottom Garment (${bottom.color} ${bottom.type}).

Instructions:
1. Replace the model's current pants/skirt with the garment from Image 2.
2. Auto-Complete: Generate a matching, clean white or neutral t-shirt/blouse to complete the look.
3. Integration: Ensure realistic waistline interaction and proper hemline.
4. CRITICAL IDENTITY LOCK: The face MUST remain 100% identical to Image 1 - preserve exact facial features, bone structure, eyes, nose, lips, skin texture, skin tone. NO modifications allowed.
5. FRAMING: Generate a FULL-BODY shot from head to toe. The entire person must be visible including face, torso, legs, and feet/shoes.
6. BACKGROUND & SETTING: Place the person in this environment: ${bgDescription}. Ensure lighting matches.${hijabInstruction}

Style: High-end full-body fashion photography, photorealistic.`;
    }
    // Sadece outerwear
    else if (outerwearInline) {
      parts.push(outerwearInline);
      prompt = `Task: Outerwear Layering Try-On.

Inputs:
- Image 1: Target Model.
- Image 2: Outerwear Garment (${outerwear.color} ${outerwear.type}).

Instructions:
1. Layer the outerwear from Image 2 OVER the model's current outfit, worn open.
2. Fit: Ensure the jacket/coat fits naturally on the shoulders and drapes properly.
3. Styling: Show the outerwear complementing the existing base outfit underneath.
4. CRITICAL IDENTITY LOCK: The face MUST remain 100% identical to Image 1 - preserve exact facial features, bone structure, eyes, nose, lips, skin texture, skin tone. NO modifications allowed.
5. FRAMING: Generate a FULL-BODY shot from head to toe. The entire person must be visible including face, torso, legs, and feet/shoes.
6. BACKGROUND & SETTING: Place the person in this environment: ${bgDescription}. Ensure lighting matches.${hijabInstruction}

Style: Full-body fashion photography, photorealistic.`;
    }

    parts[0] = { text: prompt };
    return await this.generateWithFallback(parts, null);
  },

  async getStyleAdvice(item, user) {
    const gender = user.gender === "female" ? "KadÄ±n" : "Erkek";
    const bodyType = {
      slim: 'ince/narin', athletic: 'atletik/fit', average: 'normal/orta', curvy: 'dolgun', plus: 'bÃ¼yÃ¼k beden'
    }[user.bodyType] || 'normal';
    
    const prompt = `Sen dÃ¼nyaca Ã¼nlÃ¼ bir moda stilisti ve beden danÄ±ÅŸmanÄ±sÄ±n. ${gender} mÃ¼ÅŸteri iÃ§in "${item.name}" (${item.brandName}, ${item.type}, ${item.color}) Ã¼rÃ¼nÃ¼ hakkÄ±nda KAPSAMLI tavsiye ver.

MÃœÅžTERÄ° PROFÄ°LÄ°:
- Cinsiyet: ${gender}
- Boy: ${user.height} cm
- Kilo: ${user.weight} kg
- VÃ¼cut Tipi: ${bodyType}
- YaÅŸ: ${user.age}

GÃ–REV 1 - BEDEN TAVSÄ°YESÄ°:
${item.brandName} markasÄ±nÄ±n beden tablosunu ve genel sektÃ¶r standartlarÄ±nÄ± gÃ¶z Ã¶nÃ¼nde bulundurarak:
- MÃ¼ÅŸterinin Ã¶lÃ§Ã¼lerine gÃ¶re ideal bedeni Ã¶ner (XS/S/M/L/XL/XXL veya 36/38/40/42 vb.)
- Bu markanÄ±n dar mÄ±, normal mi, bol mu kesim olduÄŸunu belirt
- "Normal bedeninizi alÄ±n" veya "Bir beden bÃ¼yÃ¼k alÄ±n" gibi net tavsiye ver

GÃ–REV 2 - STÄ°L TAVSÄ°YESÄ°:
- Bu parÃ§a mÃ¼ÅŸterinin vÃ¼cut tipine uygun mu?
- Hangi parÃ§alarla kombinlenir? (2-3 somut Ã¶neri)
- Hangi ortam/etkinliklerde giyilir?
- Sezon Ã¶nerisi

FORMAT:
ðŸ“ BEDEN Ã–NERÄ°SÄ°
[Tavsiye edilen beden ve aÃ§Ä±klama]

ðŸ‘” STÄ°L TAVSÄ°YESÄ°  
[Kombin ve giyim Ã¶nerileri]

KÄ±sa, net ve profesyonel TÃ¼rkÃ§e. Maximum 150 kelime.`;

    try {
      // Use API route if configured
      const apiUrl = CONFIG.useApiRoute 
        ? '/api/gemini'
        : `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.textModel}:generateContent`;
      
      const headers = { "Content-Type": "application/json" };
      if (!CONFIG.useApiRoute && CONFIG.apiKey) {
        headers["x-goog-api-key"] = CONFIG.apiKey;
      }
      
      const requestBody = CONFIG.useApiRoute 
        ? { model: CONFIG.textModel, contents: [{ parts: [{ text: prompt }] }] }
        : { contents: [{ parts: [{ text: prompt }] }] };
      
      const res = await fetch(apiUrl, {
        method: "POST",
        headers,
        body: JSON.stringify(requestBody)
      });
      const data = await res.json();
      return data?.candidates?.[0]?.content?.parts?.[0]?.text || "Tavsiye alÄ±namadÄ±.";
    } catch {
      return "Tavsiye alÄ±namadÄ±.";
    }
  },

  // TÃ¼m kategorileri destekleyen genel try-on fonksiyonu
  // GÃ¶rsel yerine metin aÃ§Ä±klamasÄ± kullanÄ±r - CORS sorununu bypass eder
  async tryOnOutfit(baseAvatarDataUrl, items, backgroundValue) {
    if (!baseAvatarDataUrl || !baseAvatarDataUrl.startsWith('data:image')) {
      throw new Error("GeÃ§ersiz avatar formatÄ±");
    }
    
    const avatarInline = dataUrlToInlinePart(baseAvatarDataUrl, "image/png");
    if (!avatarInline) throw new Error("Avatar gÃ¶rseli okunamadÄ±");

    // Kategorilere ayÄ±r
    const fullbody = items.find(i => i.category === 'fullbody');
    const outerwear = items.find(i => i.category === 'outerwear');
    const top = items.find(i => i.category === 'top');
    const bottom = items.find(i => i.category === 'bottom');

    // DetaylÄ± kÄ±yafet aÃ§Ä±klamalarÄ± oluÅŸtur
    const getClothingDescription = (item) => {
      if (!item) return '';
      const material = item.material ? ` made of ${item.material}` : '';
      return `${item.color} ${item.type}${material} (${item.description || item.name})`;
    };

    // Prompt oluÅŸtur - sadece metin aÃ§Ä±klamasÄ± ile
    let clothingInstructions = '';
    
    if (fullbody) {
      clothingInstructions = getClothingDescription(fullbody);
      if (outerwear) {
        clothingInstructions += `, layered with ${getClothingDescription(outerwear)} worn open on top`;
      }
    } else {
      const topDesc = top ? getClothingDescription(top) : 'a clean white cotton t-shirt';
      const bottomDesc = bottom ? getClothingDescription(bottom) : 'tailored black trousers';
      clothingInstructions = `${topDesc} paired with ${bottomDesc}`;
      
      if (outerwear) {
        clothingInstructions += `, styled with ${getClothingDescription(outerwear)} as an outer layer`;
      }
    }

    // Dynamic background based on selection
    const bgDescription = backgroundValue || 'Clean white professional photography studio with seamless backdrop';

    // Professional text-based outfit generation prompt
    const prompt = `Task: Generative Fashion Styling.

Subject: The person in the reference image (Image 1).
Outfit Description: ${clothingInstructions}.

Execution:
1. Generate a photorealistic image of this EXACT person wearing the described outfit.
2. Materiality: Represent the fabrics accurately - denim should look like denim, silk like silk, cotton like cotton. Pay attention to texture and drape.
3. Body Preservation: Maintain the person's exact body shape, proportions, and natural pose.
4. CRITICAL IDENTITY LOCK: The face MUST remain 100% identical to the reference - preserve exact facial features, bone structure, eyes, nose, lips, skin texture, skin tone, hair color, hair style. NO modifications allowed.
5. Styling: Apply modern fashion styling - proper tucking, natural garment interaction, cohesive look.
6. FRAMING: Generate a FULL-BODY shot from head to toe. The entire person must be visible including face, torso, legs, and feet/shoes.
7. BACKGROUND & SETTING: Place the person in this environment: ${bgDescription}. Ensure the lighting, shadows, and atmosphere match this setting realistically.

Output: Full-body 4K resolution, photorealistic fashion editorial quality, commercial-grade photography.`;

    const parts = [{ text: prompt }, avatarInline];
    return await this.generateWithFallback(parts, null);
  },

  // GÃ¼nlÃ¼k kombin Ã¶nerisi - KullanÄ±cÄ±nÄ±n dolabÄ±ndaki Ã¼rÃ¼nlerden
  async getDailyRecommendation(closet, weather, occasion, userGender) {
    if (!closet || closet.length === 0) return null;

    // Kategorilere ayÄ±r
    const tops = closet.filter(i => i.category === 'top');
    const bottoms = closet.filter(i => i.category === 'bottom');
    const outerwears = closet.filter(i => i.category === 'outerwear');
    const fullbodies = closet.filter(i => i.category === 'fullbody');

    // Dolap iÃ§eriÄŸini metin olarak hazÄ±rla
    const closetDescription = [
      tops.length > 0 ? `Ãœst giyim: ${tops.map(i => `${i.color} ${i.type}`).join(', ')}` : '',
      bottoms.length > 0 ? `Alt giyim: ${bottoms.map(i => `${i.color} ${i.type}`).join(', ')}` : '',
      outerwears.length > 0 ? `DÄ±ÅŸ giyim: ${outerwears.map(i => `${i.color} ${i.type}`).join(', ')}` : '',
      fullbodies.length > 0 ? `Elbise/Tulum: ${fullbodies.map(i => `${i.color} ${i.type}`).join(', ')}` : ''
    ].filter(Boolean).join('\n');

    // Hava durumu ve etkinlik bilgisi
    const weatherInfo = weather 
      ? `Hava: ${weather.temp}Â°C, ${weather.text}` 
      : '';
    const occasionInfo = occasion 
      ? `Etkinlik: ${occasion.name} (${occasion.suggestion})` 
      : '';

    const prompt = `Sen bir moda stilistisin. KullanÄ±cÄ±nÄ±n dolabÄ±ndaki kÄ±yafetlerden bugÃ¼n iÃ§in kombin Ã¶ner.

DOLAP Ä°Ã‡ERÄ°ÄžÄ°:
${closetDescription}

${weatherInfo}
${occasionInfo}
Cinsiyet: ${userGender === 'female' ? 'KadÄ±n' : 'Erkek'}

GÃ–REV:
1. YukarÄ±daki kÄ±yafetlerden SADECE mevcut olanlarÄ± kullanarak bir kombin Ã¶ner
2. Hava durumuna uygun seÃ§im yap
3. Varsa etkinliÄŸe uygun ol

CEVAP FORMATI (JSON):
{
  "combo": {
    "top": "seÃ§ilen Ã¼st giyim adÄ± veya null",
    "bottom": "seÃ§ilen alt giyim adÄ± veya null",
    "outerwear": "seÃ§ilen dÄ±ÅŸ giyim adÄ± veya null",
    "fullbody": "seÃ§ilen elbise adÄ± veya null"
  },
  "reason": "KÄ±sa Ã¶neri aÃ§Ä±klamasÄ± (max 50 kelime)",
  "tip": "GÃ¼nÃ¼n stil ipucu (max 20 kelime)"
}

SADECE JSON dÃ¶ndÃ¼r, baÅŸka bir ÅŸey yazma.`;

    try {
      // Use API route if configured
      const apiUrl = CONFIG.useApiRoute 
        ? '/api/gemini'
        : `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.textModel}:generateContent`;
      
      const headers = { "Content-Type": "application/json" };
      if (!CONFIG.useApiRoute && CONFIG.apiKey) {
        headers["x-goog-api-key"] = CONFIG.apiKey;
      }
      
      const requestBody = CONFIG.useApiRoute 
        ? { model: CONFIG.textModel, contents: [{ parts: [{ text: prompt }] }] }
        : { contents: [{ parts: [{ text: prompt }] }] };
      
      const res = await fetch(apiUrl, {
        method: "POST",
        headers,
        body: JSON.stringify(requestBody)
      });
      const data = await res.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
      
      // JSON parse et
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const result = JSON.parse(jsonMatch[0]);
        
        // Ã–nerilen Ã¼rÃ¼nleri bul
        const recommended = {
          top: result.combo.top ? tops.find(i => i.type.toLowerCase().includes(result.combo.top.toLowerCase()) || result.combo.top.toLowerCase().includes(i.type.toLowerCase()) || i.name.toLowerCase().includes(result.combo.top.toLowerCase())) : null,
          bottom: result.combo.bottom ? bottoms.find(i => i.type.toLowerCase().includes(result.combo.bottom.toLowerCase()) || result.combo.bottom.toLowerCase().includes(i.type.toLowerCase()) || i.name.toLowerCase().includes(result.combo.bottom.toLowerCase())) : null,
          outerwear: result.combo.outerwear ? outerwears.find(i => i.type.toLowerCase().includes(result.combo.outerwear.toLowerCase()) || result.combo.outerwear.toLowerCase().includes(i.type.toLowerCase()) || i.name.toLowerCase().includes(result.combo.outerwear.toLowerCase())) : null,
          fullbody: result.combo.fullbody ? fullbodies.find(i => i.type.toLowerCase().includes(result.combo.fullbody.toLowerCase()) || result.combo.fullbody.toLowerCase().includes(i.type.toLowerCase()) || i.name.toLowerCase().includes(result.combo.fullbody.toLowerCase())) : null
        };
        
        return {
          items: recommended,
          reason: result.reason || '',
          tip: result.tip || ''
        };
      }
    } catch (e) {
      // Hata durumunda basit Ã¶neri
    }
    
    // Fallback: Rastgele seÃ§im
    return {
      items: {
        top: tops[Math.floor(Math.random() * tops.length)] || null,
        bottom: bottoms[Math.floor(Math.random() * bottoms.length)] || null,
        outerwear: weather && weather.temp < 15 ? outerwears[0] : null,
        fullbody: null
      },
      reason: 'BugÃ¼n iÃ§in rahat bir kombin Ã¶neriyoruz.',
      tip: 'Kendini iyi hisset! âœ¨'
    };
  },

  // Video Try-On Generation using Veo 3.0
  async generateVideoTryOn(baseAvatarDataUrl, items, backgroundValue) {
    debugLog('VideoTryOn', `Video oluÅŸturuluyor - ${items.length} Ã¼rÃ¼n`, 'info');
    
    if (!baseAvatarDataUrl || !baseAvatarDataUrl.startsWith('data:image')) {
      debugLog('VideoTryOn', 'Avatar geÃ§ersiz', 'error');
      throw new Error("GeÃ§ersiz avatar formatÄ±");
    }
    
    const avatarInline = dataUrlToInlinePart(baseAvatarDataUrl, "image/png");
    if (!avatarInline) {
      debugLog('VideoTryOn', 'Avatar inline dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lemedi', 'error');
      throw new Error("Avatar gÃ¶rseli okunamadÄ±");
    }

    // Build outfit description from selected items
    const outfitParts = [];
    const top = items.find(i => i.category === 'top');
    const bottom = items.find(i => i.category === 'bottom');
    const outerwear = items.find(i => i.category === 'outerwear');
    const fullbody = items.find(i => i.category === 'fullbody');

    if (fullbody) {
      outfitParts.push(`${fullbody.color} ${fullbody.type} (${fullbody.name})`);
    } else {
      if (top) outfitParts.push(`${top.color} ${top.type} (${top.name})`);
      if (bottom) outfitParts.push(`${bottom.color} ${bottom.type} (${bottom.name})`);
    }
    if (outerwear) outfitParts.push(`${outerwear.color} ${outerwear.type} as outerwear`);

    const outfitDescription = outfitParts.join(', ');
    const bgDescription = backgroundValue || 'minimalist white fashion studio';

    // Professional video generation prompt for Veo 3.0
    const videoPrompt = `Generate a 6-second silent fashion showcase video.

SUBJECT: The exact person from the reference image wearing this outfit: ${outfitDescription}

CRITICAL IDENTITY REQUIREMENTS:
- Face must be 100% identical to reference: same bone structure, eyes, nose, lips, skin texture
- Preserve exact hair color, style, and length
- Maintain body proportions and measurements
- NO facial modifications or enhancements allowed

OUTFIT RENDERING:
- Clothing must look photorealistic with accurate fabric textures
- Natural draping, folds, and movement physics
- Correct fit based on body type
- Accurate colors and patterns as described

MOTION CHOREOGRAPHY (6 seconds):
- 0-2s: Model stands facing camera, slight head tilt, then begins elegant quarter turn to left
- 2-4s: Continue smooth rotation showing side/back view of outfit
- 4-6s: Complete rotation back to face camera with confident pose

CINEMATOGRAPHY:
- Full-body framing: head to toe visible at all times
- Slow, cinematic dolly/tracking movement
- Soft, diffused fashion photography lighting
- Background: ${bgDescription}
- Professional fashion film quality

OUTPUT SPECS:
- Duration: 6 seconds
- Resolution: 1080p
- Audio: SILENT (no sound)
- Style: High-end fashion editorial video`;

    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), CONFIG.videoTimeoutMs);

    try {
      debugLog('VideoTryOn', 'Video API isteÄŸi gÃ¶nderiliyor...', 'info');
      
      // Use API route if configured
      const apiUrl = CONFIG.useApiRoute 
        ? '/api/gemini'
        : `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.videoModel}:generateContent`;
      
      const headers = { "Content-Type": "application/json" };
      if (!CONFIG.useApiRoute && CONFIG.apiKey) {
        headers["x-goog-api-key"] = CONFIG.apiKey;
      }
      
      const baseBody = {
        contents: [{ 
          parts: [
            { text: videoPrompt },
            avatarInline
          ] 
        }],
        generationConfig: {
          responseModalities: ["VIDEO"]
        },
        safetySettings: [
          { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
          { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
          { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
          { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
        ]
      };
      
      const requestBody = CONFIG.useApiRoute 
        ? { model: CONFIG.videoModel, ...baseBody }
        : baseBody;
      
      const res = await fetch(apiUrl, {
        method: "POST",
        headers,
        body: JSON.stringify(requestBody),
        signal: ctrl.signal
      });

      const data = await res.json().catch(() => ({}));
      
      if (!res.ok || data?.error) {
        const errMsg = data?.error?.message || `HTTP ${res.status}`;
        debugLog('VideoTryOn', `API HatasÄ±: ${errMsg}`, 'error');
        throw new Error(errMsg);
      }

      // Extract video from response
      for (const c of (data?.candidates || [])) {
        for (const p of (c?.content?.parts || [])) {
          if (p.inlineData?.data) {
            const mimeType = p.inlineData.mimeType || "video/mp4";
            debugLog('VideoTryOn', `Video alÄ±ndÄ±: ${Math.round(p.inlineData.data.length / 1024)}KB`, 'success');
            return `data:${mimeType};base64,${p.inlineData.data}`;
          }
          if (p.fileData?.fileUri) {
            debugLog('VideoTryOn', 'Video URI alÄ±ndÄ±', 'success');
            return p.fileData.fileUri;
          }
        }
      }

      debugLog('VideoTryOn', 'Video alÄ±namadÄ±', 'error');
      throw new Error("Video oluÅŸturulamadÄ±");
    } catch (e) {
      if (e.name === "AbortError") {
        debugLog('VideoTryOn', 'Zaman aÅŸÄ±mÄ±', 'error');
        throw new Error("Video oluÅŸturma zaman aÅŸÄ±mÄ±na uÄŸradÄ±");
      }
      throw e;
    } finally {
      clearTimeout(timer);
    }
  }
};

// ============ PRODUCT CATALOG ============
// Merge with Trendyol products (if loaded from external file)
const TRENDYOL_DATA = (typeof TRENDYOL_PRODUCTS !== 'undefined' && Array.isArray(TRENDYOL_PRODUCTS)) 
  ? TRENDYOL_PRODUCTS 
  : [];

console.log(`ðŸ“¥ YÃ¼klenen ham veri: ${TRENDYOL_DATA.length} Ã¼rÃ¼n`);

// Debug first few items to see brand structure
if (TRENDYOL_DATA.length > 0) {
  console.log('ðŸ” Ä°lk 3 Ã¼rÃ¼n yapÄ±sÄ±:', TRENDYOL_DATA.slice(0, 3).map(p => ({
    brand: p.brand,
    brandName: p.brandName,
    brandId: p.brandId,
    name: p.name?.substring(0, 30)
  })));
}

// Fix brand names - ensure brandName is properly extracted
const ALL_PRODUCTS = TRENDYOL_DATA.map((p, i) => {
  // Brand name priority: brandName > brand > extract from name
  let brandName = p.brandName || p.brand || '';
  
  // Clean up brand name
  brandName = brandName.trim();
  
  // If brandName is empty or too generic, try to extract from title
  if (!brandName || brandName.toLowerCase() === 'trendyol' || brandName.length < 2) {
    const titleParts = (p.name || p.title || '').split(' ');
    if (titleParts.length > 1) {
      const firstWord = titleParts[0];
      const commonWords = ['erkek', 'kadÄ±n', 'siyah', 'beyaz', 'mavi', 'kÄ±rmÄ±zÄ±', 'yeÅŸil', 'slim', 'regular', 'oversize', 'basic', 'casual'];
      if (firstWord && firstWord.length > 2 && !commonWords.includes(firstWord.toLowerCase())) {
        brandName = firstWord;
      }
    }
  }
  
  // Final fallback
  if (!brandName || brandName.length < 2) {
    brandName = 'Trendyol Collection';
  }
  
  // Generate brandId from brandName (Turkish char safe)
  const brandId = brandName.toLowerCase()
    .replace(/Ä±/g, 'i').replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u')
    .replace(/ÅŸ/g, 's').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c')
    .replace(/Ä°/g, 'i').replace(/Äž/g, 'g').replace(/Ãœ/g, 'u')
    .replace(/Åž/g, 's').replace(/Ã–/g, 'o').replace(/Ã‡/g, 'c')
    .replace(/[^a-z0-9]/g, '_')
    .replace(/_+/g, '_')
    .replace(/^_|_$/g, '') || 'other';
  
  // --- CATEGORY & SUBTYPE FIX ---
  // ÃœrÃ¼n adÄ±ndan kategori ve subType belirle
  const productName = (p.name || p.title || '').toLowerCase();
  const productType = (p.type || '').toLowerCase();
  
  // Kategori belirleme kurallarÄ±
  let category = p.category || 'top';
  let subType = p.subType || p.type || null;
  
  // ÃœST GÄ°YÄ°M kelimeleri (top)
  const topKeywords = ['t-shirt', 'tiÅŸÃ¶rt', 'gÃ¶mlek', 'bluz', 'kazak', 'sweatshirt', 'sÃ¼veter', 'triko', 'polo', 'crop', 'atlet', 'body', 'tunik'];
  // ALT GÄ°YÄ°M kelimeleri (bottom)
  const bottomKeywords = ['pantolon', 'jean', 'kot', 'ÅŸort', 'etek', 'eÅŸofman', 'tayt', 'jogger', 'bermuda', 'capri'];
  // DIÅž GÄ°YÄ°M kelimeleri (outerwear) - SADECE bunlar dÄ±ÅŸ giyim
  const outerwearKeywords = ['mont', 'kaban', 'parka', 'palto', 'trenÃ§kot', 'yaÄŸmurluk', 'ceket', 'blazer', 'yelek'];
  // ELBÄ°SE kelimeleri (fullbody)
  const fullbodyKeywords = ['elbise', 'tulum', 'salopet', 'overall'];
  
  // Ã–ncelik: fullbody > outerwear > bottom > top
  if (fullbodyKeywords.some(k => productName.includes(k) || productType.includes(k))) {
    category = 'fullbody';
    if (productName.includes('tulum') || productName.includes('salopet')) subType = 'Tulum';
    else subType = 'Elbise';
  } else if (outerwearKeywords.some(k => productName.includes(k) || productType.includes(k))) {
    category = 'outerwear';
    // SubType belirleme
    if (productName.includes('mont')) subType = 'Mont';
    else if (productName.includes('kaban')) subType = 'Kaban';
    else if (productName.includes('parka')) subType = 'Parka';
    else if (productName.includes('palto')) subType = 'Palto';
    else if (productName.includes('trenÃ§kot')) subType = 'TrenÃ§kot';
    else if (productName.includes('yaÄŸmurluk')) subType = 'YaÄŸmurluk';
    else if (productName.includes('blazer')) subType = 'Blazer';
    else if (productName.includes('yelek')) subType = 'Yelek';
    else if (productName.includes('ceket')) subType = 'Ceket';
  } else if (bottomKeywords.some(k => productName.includes(k) || productType.includes(k))) {
    category = 'bottom';
    if (productName.includes('jean') || productName.includes('kot') || productName.includes('denim')) subType = 'Kot';
    else if (productName.includes('ÅŸort')) subType = 'Åžort';
    else if (productName.includes('etek')) subType = 'Etek';
    else if (productName.includes('eÅŸofman') || productName.includes('jogger')) subType = 'EÅŸofman';
    else if (productName.includes('tayt')) subType = 'Tayt';
    else subType = 'Pantolon';
  } else if (topKeywords.some(k => productName.includes(k) || productType.includes(k))) {
    category = 'top';
    // SubType belirleme - ÃœST GÄ°YÄ°M iÃ§in
    if (productName.includes('t-shirt') || productName.includes('tiÅŸÃ¶rt')) subType = 'T-Shirt';
    else if (productName.includes('gÃ¶mlek')) subType = 'GÃ¶mlek';
    else if (productName.includes('bluz')) subType = 'Bluz';
    else if (productName.includes('kazak') || productName.includes('sÃ¼veter') || productName.includes('triko')) subType = 'Kazak';
    else if (productName.includes('sweatshirt')) subType = 'Sweatshirt';
    else if (productName.includes('hÄ±rka')) subType = 'HÄ±rka';
    else if (productName.includes('polo')) subType = 'Polo';
    else if (productName.includes('crop')) subType = 'Crop Top';
    else if (productName.includes('atlet')) subType = 'Atlet';
    else subType = 'T-Shirt'; // VarsayÄ±lan
  }
  
  // HATA DÃœZELTMESÄ°: Kazak/HÄ±rka yanlÄ±ÅŸlÄ±kla outerwear olarak iÅŸaretlenmiÅŸse top'a Ã§evir
  if (category === 'outerwear' && (productName.includes('kazak') || productName.includes('hÄ±rka') || productName.includes('sÃ¼veter') || productName.includes('triko') || productName.includes('sweatshirt'))) {
    category = 'top';
    if (productName.includes('hÄ±rka')) subType = 'HÄ±rka';
    else if (productName.includes('sweatshirt')) subType = 'Sweatshirt';
    else subType = 'Kazak';
  }
  
  return {
    ...p,
    id: i + 1,
    brandId: brandId,
    brandName: brandName,
    // Ensure other required fields
    name: p.name || p.title || 'ÃœrÃ¼n',
    price: p.price || '0 TL',
    priceNum: p.priceNum || 0,
    image: p.image || '',
    category: category,
    subType: subType,
    gender: p.gender || 'unisex',
    type: p.type || 'Giyim',
    color: p.color || 'Ã‡ok Renkli'
  };
});


console.log(`ðŸ“¦ ÃœrÃ¼n VeritabanÄ±: ${ALL_PRODUCTS.length} Trendyol Ã¼rÃ¼nÃ¼`);

// Debug: Show sample brand names
if (ALL_PRODUCTS.length > 0) {
  const sampleBrands = [...new Set(ALL_PRODUCTS.slice(0, 20).map(p => p.brandName))];
  console.log(`ðŸ·ï¸ Ã–rnek markalar:`, sampleBrands);
}

// Generate BRANDS dynamically from ALL_PRODUCTS
const BRANDS = (() => {
  const brandMap = new Map();
  
  // Jenerik/atlanacak marka isimleri
  const genericBrands = ['trendyol collection', 'diÄŸer', 'other', 'genel', 'general', 'bilinmeyen', 'unknown'];
  
  // Extract unique brands from products
  ALL_PRODUCTS.forEach(p => {
    const brandId = p.brandId || 'other';
    const brandName = p.brandName || 'DiÄŸer';
    
    // Jenerik markalarÄ± atla
    if (genericBrands.includes(brandName.toLowerCase())) {
      return;
    }
    
    if (!brandMap.has(brandId)) {
      brandMap.set(brandId, { 
        id: brandId, 
        name: brandName,
        count: 1
      });
    } else {
      brandMap.get(brandId).count++;
    }
  });
  
  // Sort by product count (most products first), then alphabetically
  const brands = Array.from(brandMap.values());
  brands.sort((a, b) => {
    // First by count (descending)
    if (b.count !== a.count) return b.count - a.count;
    // Then alphabetically
    return a.name.localeCompare(b.name, 'tr');
  });
  
  // Sadece en az 2 Ã¼rÃ¼nÃ¼ olan markalarÄ± gÃ¶ster
  const filteredBrands = brands.filter(b => b.count >= 2);
  
  console.log(`ðŸ·ï¸ ${filteredBrands.length} farklÄ± marka bulundu (${brands.length - filteredBrands.length} tekil marka filtrelendi)`);
  if (filteredBrands.length > 0) {
    console.log(`ðŸ” En Ã§ok Ã¼rÃ¼nlÃ¼ markalar:`, filteredBrands.slice(0, 5).map(b => `${b.name}(${b.count})`));
  }
  
  return filteredBrands;
})();

const BACKGROUNDS = [
  { id: 'studio', value: 'Clean white professional photography studio with seamless backdrop' },
  { id: 'street', value: 'Fashionable European city street with elegant architecture, shallow depth of field' },
  { id: 'office', value: 'Modern minimalist corporate office with large windows and natural light' },
  { id: 'cafe', value: 'Trendy hipster cafe interior with warm ambient lighting' },
  { id: 'park', value: 'Beautiful green park with golden hour sunlight filtering through trees' },
  { id: 'beach', value: 'Stunning beach at sunset with soft warm lighting' },
  { id: 'travel', value: 'Scenic airport lounge with luxury atmosphere and city skyline view' },
  { id: 'fineDining', value: 'Elegant fine dining restaurant with crystal chandeliers and sophisticated ambiance' },
  { id: 'rooftop', value: 'Stylish rooftop terrace bar with city skyline panorama at dusk' },
  { id: 'gallery', value: 'Contemporary art gallery with white walls and dramatic spotlighting' }
];

// ============ UI COMPONENTS ============
const Logo = () => (
  <div className="flex items-center gap-3">
    <div className="w-11 h-11 rounded-2xl bg-brand flex items-center justify-center shadow-soft">
      <span className="text-xl">âœ¨</span>
    </div>
    <div>
      <div className="text-lg font-black tracking-tight">{CONFIG.name}</div>
      <div className="text-xs text-slate-500">{CONFIG.slogan}</div>
    </div>
  </div>
);

const Toast = ({ toast, onClose }) => {
  // Auto-close after 2 seconds - guaranteed
  useEffect(() => {
    let timer;
    if (toast?.open) {
      timer = setTimeout(() => {
        onClose();
      }, 2000);
    }
    return () => {
      if (timer) clearTimeout(timer);
    };
  }, [toast?.open, toast?.message, onClose]); // Also trigger on message change

  if (!toast?.open) return null;
  return (
    <div className="fixed z-[100] left-0 right-0 top-4 px-4 fade-in">
      <div className="max-w-md mx-auto glass rounded-2xl p-3 flex items-center gap-3">
        <div className={`w-8 h-8 rounded-xl flex items-center justify-center ${toast.type === 'error' ? 'bg-red-500/20' : 'bg-green-500/20'}`}>
          <Icon name={toast.type === 'error' ? 'x' : 'check'} size={16} className={toast.type === 'error' ? 'text-red-400' : 'text-green-400'} />
        </div>
        <div className="flex-1">
          <div className="font-bold text-sm">{toast.title || (toast.type === 'error' ? t('error') : t('success'))}</div>
          <div className="text-xs text-slate-600">{toast.message}</div>
        </div>
        <button onClick={onClose} className="p-1.5 rounded-lg hover:bg-slate-200/60"><Icon name="x" size={16} /></button>
      </div>
    </div>
  );
};

// ============ DEBUG PANEL ============
const DebugPanel = ({ debugEnabled }) => {
  const [logs, setLogs] = useState([]);
  const [isOpen, setIsOpen] = useState(false);
  
  useEffect(() => {
    // Update logs periodically
    const interval = setInterval(() => {
      if (typeof DEBUG_LOGS !== 'undefined') {
        setLogs([...DEBUG_LOGS]);
      }
    }, 500);
    
    // Register global update function
    if (typeof window !== 'undefined') {
      window.updateDebugPanel = () => setLogs([...DEBUG_LOGS]);
    }
    
    return () => clearInterval(interval);
  }, []);
  
  if (!debugEnabled) return null;
  
  return (
    <>
      {/* Toggle Button */}
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="fixed bottom-20 right-4 z-[90] w-10 h-10 rounded-full bg-yellow-500 text-black font-bold flex items-center justify-center shadow-lg"
      >
        ðŸ›
      </button>
      
      {/* Debug Panel */}
      {isOpen && (
        <div className="fixed bottom-32 right-4 left-4 z-[90] max-w-md ml-auto glass rounded-2xl overflow-hidden">
          <div className="bg-yellow-500/20 px-4 py-2 flex items-center justify-between">
            <span className="font-bold text-yellow-400 text-sm">ðŸ” Debug Logs</span>
            <button onClick={() => setIsOpen(false)} className="text-slate-500">âœ•</button>
          </div>
          <div className="max-h-48 overflow-y-auto p-2 space-y-1 text-xs font-mono">
            {logs.length === 0 ? (
              <div className="text-slate-400 text-center py-4">{t('noLogsYet')}</div>
            ) : (
              logs.map((log, i) => (
                <div key={i} className={`px-2 py-1 rounded ${
                  log.type === 'error' ? 'bg-red-500/20 text-red-300' :
                  log.type === 'success' ? 'bg-green-500/20 text-green-300' :
                  log.type === 'warn' ? 'bg-yellow-500/20 text-yellow-300' :
                  'bg-slate-100 text-slate-600'
                }`}>
                  <span className="text-slate-400">{log.timestamp}</span>
                  <span className="text-slate-500 mx-1">|</span>
                  <span className="font-semibold">{log.step}</span>
                  <span className="text-slate-500 mx-1">â†’</span>
                  <span>{log.message}</span>
                </div>
              ))
            )}
          </div>
        </div>
      )}
    </>
  );
};

const FullscreenLoader = ({ title, subtitle, onCancel, showProgress = true }) => {
  const [elapsed, setElapsed] = useState(0);
  
  useEffect(() => {
    if (!showProgress) return;
    const interval = setInterval(() => {
      setElapsed(e => e + 1);
    }, 1000);
    return () => clearInterval(interval);
  }, [showProgress]);
  
  const progressMessages = [
    "AI modeli yÃ¼kleniyor...",
    "GÃ¶rsel iÅŸleniyor...",
    "Avatar analiz ediliyor...",
    "KÄ±yafet yerleÅŸtiriliyor...",
    "Detaylar ekleniyor...",
    "Son rÃ¶tuÅŸlar yapÄ±lÄ±yor..."
  ];
  
  const currentMessage = progressMessages[Math.min(Math.floor(elapsed / 8), progressMessages.length - 1)];
  
  return (
    <div className="fixed inset-0 z-[90] bg-black/80 backdrop-blur flex items-center justify-center p-6">
      <div className="w-full max-w-sm glass-dark rounded-3xl p-6 text-center fade-in shadow-soft">
        <div className="relative w-20 h-20 mx-auto mb-4">
          <div className="absolute inset-0 rounded-full bg-brand opacity-25 ring-pulse" />
          <div className="relative w-full h-full rounded-full overflow-hidden">
            <img src={LOGO_BASE64} alt="TrAi" className="w-full h-full object-cover" />
          </div>
        </div>
        <div className="text-lg font-black">{title}</div>
        <div className="text-sm text-slate-600 mt-1">{subtitle}</div>
        {showProgress && (
          <div className="mt-3">
            <div className="text-xs text-slate-500">{currentMessage}</div>
            <div className="text-[10px] text-slate-400 mt-1">{elapsed} saniye</div>
          </div>
        )}
        {onCancel && <button onClick={onCancel} className="mt-4 btn-ghost px-6 py-2 rounded-xl text-sm font-bold">{t('cancel')}</button>}
      </div>
    </div>
  );
};

// ============ LEGAL DOCUMENTS ============
const LEGAL_DOCS = {
  updated: "27 AralÄ±k 2025",
  
  // KVKK AydÄ±nlatma Metni
  kvkkAydinlatma: {
    title: "KiÅŸisel Verilerin Ä°ÅŸlenmesine Ä°liÅŸkin AydÄ±nlatma Metni",
    sections: [
      { title: "Veri Sorumlusu", content: "TrAi Technologies\nAdres: [Åžirket adresi]\nE-posta: info@trai.style\n\nTrAi, 6698 sayÄ±lÄ± KiÅŸisel Verilerin KorunmasÄ± Kanunu (\"KVKK\") uyarÄ±nca kiÅŸisel verilerinizi aÅŸaÄŸÄ±da aÃ§Ä±klanan kapsamda iÅŸler." },
      { title: "1. Ä°ÅŸlenen KiÅŸisel Veriler", content: "â€¢ Kimlik / Ä°letiÅŸim: Ad, soyad, e-posta\nâ€¢ Hesap Bilgileri: Ãœyelik, kredi/abonelik, satÄ±n alma geÃ§miÅŸi\nâ€¢ GÃ¶rsel Veriler: YÃ¼klenen fotoÄŸraflar ve oluÅŸturulan try-on gÃ¶rselleri\nâ€¢ Ä°ÅŸlem GÃ¼venliÄŸi: IP, cihaz, log kayÄ±tlarÄ±\nâ€¢ Analitik (opsiyonel): Uygulama kullanÄ±m verileri\n\nâš ï¸ Ã–zel Nitelikli Veri UyarÄ±sÄ±:\nYÃ¼z gÃ¶rÃ¼ntÃ¼leri \"biyometrik veri niteliÄŸi taÅŸÄ±yabilecek Ã¶zel nitelikli kiÅŸisel veri\" kabul edilerek iÅŸlenmektedir." },
      { title: "2. Ä°ÅŸleme AmaÃ§larÄ±", content: "â€¢ Sanal kÄ±yafet deneme (Virtual Try-On) hizmetinin sunulmasÄ±\nâ€¢ KullanÄ±cÄ±ya Ã¶zel stil ve kombin Ã¶nerileri oluÅŸturulmasÄ±\nâ€¢ Ãœyelik ve Ã¶deme sÃ¼reÃ§lerinin yÃ¼rÃ¼tÃ¼lmesi\nâ€¢ GÃ¼venlik ve suistimal Ã¶nleme\nâ€¢ Uygulama performansÄ±nÄ±n geliÅŸtirilmesi (analitik rÄ±zasÄ± varsa)" },
      { title: "3. Hukuki Dayanak", content: "â€¢ Ãœyelik & hesap: KVKK 5/2-c â€“ SÃ¶zleÅŸmenin ifasÄ±\nâ€¢ Ã–deme kayÄ±tlarÄ±: KVKK 5/2-Ã§ â€“ Hukuki yÃ¼kÃ¼mlÃ¼lÃ¼k\nâ€¢ FotoÄŸraf & yÃ¼z verisi: KVKK 6 â€“ AÃ§Ä±k RÄ±za\nâ€¢ ABD'ye aktarÄ±m: KVKK 9 â€“ AÃ§Ä±k RÄ±za\nâ€¢ Analitik: AÃ§Ä±k RÄ±za" },
      { title: "4. Veri AktarÄ±mÄ±", content: "â€¢ Firebase Storage / Firestore: ABD\nâ€¢ Google Gemini AI: ABD\nâ€¢ Ã–deme altyapÄ±sÄ±: TR / AB\nâ€¢ Yetkili kamu kurumlarÄ±: TR" },
      { title: "5. Saklama SÃ¼resi", content: "â€¢ FotoÄŸraflar & try-on Ã§Ä±ktÄ±larÄ±: KullanÄ±cÄ± aktif olduÄŸu sÃ¼rece / yeni fotoÄŸraf yÃ¼kleyene kadar\nâ€¢ Hesap verileri: Ãœyelik sÃ¼resi boyunca\nâ€¢ Hesap silinirse: TÃ¼m gÃ¶rsel veriler DERHAL silinir\nâ€¢ Log kayÄ±tlarÄ±: En fazla 2 yÄ±l" },
      { title: "6. HaklarÄ±nÄ±z (KVKK md.11)", content: "Verilerinizin silinmesini, dÃ¼zeltilmesini, iÅŸlenip iÅŸlenmediÄŸini Ã¶ÄŸrenmeyi talep edebilirsiniz.\n\nBaÅŸvurular: info@trai.style\nEn geÃ§ 30 gÃ¼n iÃ§inde cevaplanÄ±r." }
    ]
  },
  
  // KullanÄ±m KoÅŸullarÄ±
  kullanimKosullari: {
    title: "KullanÄ±m KoÅŸullarÄ±",
    sections: [
      { title: "1. GiriÅŸ", content: "TrAi Technologies olarak, TrAi uygulamasÄ±nÄ±n kullanÄ±mÄ±nÄ± dÃ¼zenleyen bu KullanÄ±m KoÅŸullarÄ±'nÄ± kabul etmenizi rica ediyoruz. Bu UygulamayÄ± kullanarak, bu KoÅŸullarÄ± ve Gizlilik PolitikamÄ±zÄ± okuduÄŸunuzu, anladÄ±ÄŸÄ±nÄ±zÄ± ve kabul ettiÄŸinizi beyan edersiniz." },
      { title: "2. Hizmet TanÄ±mÄ±", content: "TrAi, yapay zeka teknolojisi kullanarak sanal giysi deneme hizmeti sunan bir platformdur.\n\nHizmetlerimiz:\nâ€¢ Dijital Avatar OluÅŸturma\nâ€¢ Sanal KÄ±yafet Deneme\nâ€¢ AI Stil Ã–nerileri\nâ€¢ Dijital Dolap YÃ¶netimi" },
      { title: "3. YaÅŸ SÄ±nÄ±rÄ±", content: "âš ï¸ TrAi yalnÄ±zca 18 yaÅŸ ve Ã¼zeri kullanÄ±cÄ±lar iÃ§indir.\n18 yaÅŸ altÄ± kullanÄ±cÄ±larÄ±n kaydÄ± yasaktÄ±r.\n\nKayÄ±t olarak 18 yaÅŸÄ±ndan bÃ¼yÃ¼k olduÄŸunuzu beyan ve taahhÃ¼t edersiniz." },
      { title: "4. Hesap GÃ¼venliÄŸi", content: "Hesap oluÅŸtururken doÄŸru ve gÃ¼ncel bilgiler saÄŸlamayÄ± kabul edersiniz. Hesap bilgilerinizin gizliliÄŸinden siz sorumlusunuz." },
      { title: "5. ÃœÃ§Ã¼ncÃ¼ Taraf Hizmetler", content: "UygulamamÄ±z aÅŸaÄŸÄ±daki Ã¼Ã§Ã¼ncÃ¼ taraf hizmetleri kullanmaktadÄ±r:\n\nâ€¢ Google Gemini AI: Avatar ve giysi deneme gÃ¶rsellerinin oluÅŸturulmasÄ±\nâ€¢ Firebase (Google): Kimlik doÄŸrulama ve veri depolama" },
      { title: "6. Fikri MÃ¼lkiyet", content: "TrAi uygulamasÄ± ve iÃ§eriÄŸinin tÃ¼m haklarÄ± TrAi Technologies'e aittir. OluÅŸturduÄŸunuz gÃ¶rseller Ã¼zerinde kiÅŸisel kullanÄ±m hakkÄ±na sahipsiniz." },
      { title: "7. Sorumluluk Reddi", content: "Hizmet \"olduÄŸu gibi\" sunulmaktadÄ±r. Kesintisiz veya hatasÄ±z Ã§alÄ±ÅŸmayÄ± garanti etmeyiz. AI sonuÃ§larÄ±nÄ±n %100 doÄŸru olacaÄŸÄ±nÄ± garanti etmeyiz." },
      { title: "8. Ä°letiÅŸim", content: "TrAi Technologies\ndestek@trai.style\ninfo@trai.style" }
    ]
  },
  
  // Ã–n Bilgilendirme Formu (6502)
  onBilgilendirme: {
    title: "Ã–n Bilgilendirme Formu",
    content: "SipariÅŸi onayladÄ±ÄŸÄ±mda Ã¶deme yÃ¼kÃ¼mlÃ¼lÃ¼ÄŸÃ¼ altÄ±na gireceÄŸimi biliyorum.\n\nSatÄ±n alÄ±nan hizmet elektronik ortamda anÄ±nda ifa edilen dijital hizmettir.\n\nâš ï¸ Ä°lk kullanÄ±m baÅŸladÄ±ktan sonra cayma hakkÄ± bulunmamaktadÄ±r."
  },
  
  // Footer Mikro UyarÄ±lar
  footerNotices: {
    kvkk: {
      title: "KVKK & Gizlilik",
      short: "KiÅŸisel verileriniz 6698 sayÄ±lÄ± KVKK kapsamÄ±nda iÅŸlenmektedir."
    },
    ai: {
      title: "Yapay ZekÃ¢ Bilgilendirmesi",
      short: "Uygulama, yapay zekÃ¢ ile Ã¼retilen simÃ¼lasyon gÃ¶rselleri sunar. SonuÃ§lar fikir verme amaÃ§lÄ±dÄ±r, gerÃ§ek Ã¼rÃ¼nÃ¼ %100 yansÄ±tmayabilir."
    },
    affiliate: {
      title: "Reklam & SatÄ±ÅŸ OrtaklÄ±ÄŸÄ±",
      short: "\"SatÄ±n Al\" butonlarÄ± sizi Ã¼Ã§Ã¼ncÃ¼ taraf satÄ±cÄ± sitelerine yÃ¶nlendirir. TrAi bu baÄŸlantÄ±lardan komisyon kazanabilir."
    },
    age: {
      title: "18+ KullanÄ±m ÅžartÄ±",
      short: "Bu uygulama yalnÄ±zca 18 yaÅŸ ve Ã¼zeri kullanÄ±cÄ±lar iÃ§indir."
    }
  },
  
  // Hesap Silme UyarÄ±sÄ±
  hesapSilme: {
    title: "HesabÄ± Sil",
    warning: "HesabÄ±nÄ±zÄ± sildiÄŸinizde:\n\nâ€¢ YÃ¼klediÄŸiniz tÃ¼m fotoÄŸraflar\nâ€¢ OluÅŸturulan tÃ¼m sanal deneme gÃ¶rselleri\nâ€¢ Sanal ikiz verileri\nâ€¢ Hesap bilgileriniz\n\nDERHAL ve KALICI OLARAK SÄ°LÄ°NÄ°R.\n\nSilme iÅŸlemi geri alÄ±namaz.\n\nYasal yÃ¼kÃ¼mlÃ¼lÃ¼k gereÄŸi saklanmasÄ± zorunlu olan muhasebe kayÄ±tlarÄ± haricinde hiÃ§bir kiÅŸisel veriniz sistemimizde tutulmaz.\n\nHesap silme talebiniz KVKK kapsamÄ±nda derhal iÅŸleme alÄ±nÄ±r ve en geÃ§ 24 saat iÃ§inde tamamlanÄ±r.",
    confirm: "Bu iÅŸlemi onaylayarak, tÃ¼m verilerinizin kalÄ±cÄ± olarak silineceÄŸini ve geri alÄ±namayacaÄŸÄ±nÄ± kabul etmiÅŸ olursunuz."
  },
  
  // AÃ§Ä±k RÄ±za Metinleri
  consents: {
    faceData: {
      required: true,
      label: "Sanal Ä°kiz & YÃ¼z Verisi AÃ§Ä±k RÄ±zasÄ±",
      text: "Uygulamaya yÃ¼klediÄŸim fotoÄŸraflarÄ±m Ã¼zerinden yÃ¼z ve vÃ¼cut Ã¶zelliklerimin analiz edilerek sanal kÄ±yafet deneme hizmeti sunulmasÄ±na aÃ§Ä±k rÄ±za veriyorum."
    },
    usaTransfer: {
      required: true,
      label: "ABD'ye AktarÄ±m AÃ§Ä±k RÄ±zasÄ±",
      text: "FotoÄŸraflarÄ±mÄ±n ve try-on Ã§Ä±ktÄ±larÄ±mÄ±n, Google Gemini ve Firebase altyapÄ±larÄ±nÄ±n ABD'de bulunmasÄ± sebebiyle yurt dÄ±ÅŸÄ±na aktarÄ±lmasÄ±na aÃ§Ä±k rÄ±za veriyorum."
    },
    sharing: {
      required: false,
      label: "Uygulama Ä°Ã§inde PaylaÅŸÄ±m",
      text: "OluÅŸturduÄŸum gÃ¶rsellerin uygulama iÃ§inde diÄŸer kullanÄ±cÄ±larla paylaÅŸÄ±lmasÄ±nÄ± kabul ediyorum."
    },
    analytics: {
      required: false,
      label: "Analitik",
      text: "Uygulama deneyimini geliÅŸtirmek amacÄ±yla Firebase Analytics vb. Ã¶lÃ§Ã¼mleme yapÄ±lmasÄ±nÄ± kabul ediyorum."
    }
  }
};

// Backward compatibility
const TERMS = {
  updated: LEGAL_DOCS.updated,
  sections: LEGAL_DOCS.kullanimKosullari.sections
};

const TermsModal = ({ isOpen, onClose, onAccept, docType = 'terms' }) => {
  const [scrolled, setScrolled] = useState(false);
  const ref = useRef(null);
  const onScroll = () => { const el = ref.current; if (el && el.scrollHeight - el.scrollTop <= el.clientHeight + 50) setScrolled(true); };
  
  // Get document based on type
  const getDoc = () => {
    switch(docType) {
      case 'kvkk': return { title: LEGAL_DOCS.kvkkAydinlatma.title, sections: LEGAL_DOCS.kvkkAydinlatma.sections };
      case 'onbilgilendirme': return { title: LEGAL_DOCS.onBilgilendirme.title, sections: [{ title: '', content: LEGAL_DOCS.onBilgilendirme.content }] };
      default: return { title: t('termsTitle'), sections: LEGAL_DOCS.kullanimKosullari.sections };
    }
  };
  const doc = getDoc();
  
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[100] bg-black/85 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="w-full max-w-xl max-h-[85vh] bg-surface rounded-3xl overflow-hidden flex flex-col border border-slate-200 fade-in">
        <div className="p-5 border-b border-slate-200 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-brand/10 flex items-center justify-center"><Icon name="shield" size={20} className="text-brand2" /></div>
            <div><h2 className="font-bold text-sm">{doc.title}</h2><p className="text-xs text-slate-400">{t('lastUpdated')}: {LEGAL_DOCS.updated}</p></div>
          </div>
          <button onClick={onClose} className="p-2 rounded-xl hover:bg-slate-200/60"><Icon name="x" size={20} /></button>
        </div>
        <div ref={ref} onScroll={onScroll} className="flex-1 overflow-y-auto custom-scroll p-5 space-y-4">
          {doc.sections.map((s, i) => (<div key={i}>{s.title && <h3 className="text-sm font-bold text-brand2 mb-1">{s.title}</h3>}<p className="text-sm text-slate-500 leading-relaxed whitespace-pre-line">{s.content}</p></div>))}
          <div className="glass rounded-2xl p-4 flex items-start gap-3 border border-brand/20"><Icon name="shield" size={18} className="text-brand2 flex-shrink-0 mt-0.5" /><p className="text-xs text-slate-500">{t('kvkkNotice')} info@trai.style</p></div>
        </div>
        <div className="p-5 border-t border-slate-200 space-y-3">
          {!scrolled && <p className="text-xs text-slate-400 text-center">{t('scrollToRead')}</p>}
          <div className="flex gap-3">
            <button onClick={onClose} className="flex-1 btn-ghost py-3 rounded-xl font-semibold text-sm">{onAccept ? t('decline') : t('close')}</button>
            {onAccept && <button onClick={onAccept} disabled={!scrolled} className="flex-1 btn-primary py-3 rounded-xl font-semibold text-sm disabled:opacity-40">{t('accept')}</button>}
          </div>
        </div>
      </div>
    </div>
  );
};

// ============ AUTH SCREEN ============
const AuthScreen = ({ onAuthed, setToast, changeLanguage }) => {
  const [mode, setMode] = useState('welcome');
  const [email, setEmail] = useState('');
  const [username, setUsername] = useState('');
  const [displayName, setDisplayName] = useState('');
  const [pass, setPass] = useState('');
  const [passConfirm, setPassConfirm] = useState('');
  const [showPass, setShowPass] = useState(false);
  const [termsOk, setTermsOk] = useState(false);
  const [showTerms, setShowTerms] = useState(false);
  const [termsDocType, setTermsDocType] = useState('terms');
  const [busy, setBusy] = useState(false);
  const [passErrors, setPassErrors] = useState([]);
  const [usernameStatus, setUsernameStatus] = useState({ checking: false, available: null, error: null });
  const [emailStatus, setEmailStatus] = useState({ checking: false, available: null, error: null });
  
  // Consent checkboxes (KVKK compliant)
  const [consents, setConsents] = useState({
    faceData: false,      // Zorunlu - YÃ¼z verisi iÅŸleme
    usaTransfer: false,   // Zorunlu - ABD'ye aktarÄ±m
    sharing: false,       // Opsiyonel - Uygulama iÃ§i paylaÅŸÄ±m
    analytics: false,     // Opsiyonel - Analitik
    ageConfirm: false     // Zorunlu - 18+ yaÅŸ onayÄ±
  });
  
  // Check if required consents are given
  const requiredConsentsOk = consents.faceData && consents.usaTransfer && termsOk;

  useEffect(() => {
    if (auth) auth.onAuthStateChanged(u => { if (u) onAuthed({ uid: u.uid, email: u.email, emailVerified: u.emailVerified }); });
    // Terms already accepted in localStorage - skip for returning users
    if (localStorage.getItem('trai_consents_v2')) {
      setTermsOk(true);
      setConsents(prev => ({ ...prev, faceData: true, usaTransfer: true, ageConfirm: true }));
    }
  }, []);

  // Username validation - BigTech standards
  const validateUsername = (name) => {
    const errors = [];
    
    // Length check (3-20 characters)
    if (name.length < 3) errors.push('En az 3 karakter olmalÄ±');
    if (name.length > 20) errors.push('En fazla 20 karakter olmalÄ±');
    
    // Allowed characters: letters, numbers, underscore, dot, dash
    if (!/^[a-zA-Z0-9_.\-]*$/.test(name)) errors.push('Sadece harf, rakam, alt Ã§izgi (_), nokta (.) ve tire (-) kullanÄ±labilir');
    
    // Must start with letter or number
    if (name.length > 0 && !/^[a-zA-Z0-9]/.test(name)) errors.push('Harf veya rakam ile baÅŸlamalÄ±');
    
    // No consecutive special characters
    if (/[_.\-]{2,}/.test(name)) errors.push('ArdÄ±ÅŸÄ±k Ã¶zel karakter kullanÄ±lamaz');
    
    // Cannot end with special character
    if (/[_.\-]$/.test(name)) errors.push('Ã–zel karakter ile bitemez');
    
    // Profanity filter - common Turkish and English bad words
    const badWords = [
      // Turkish
      'amk', 'aq', 'orospu', 'piÃ§', 'sik', 'yarrak', 'gÃ¶t', 'meme', 'sex', 'porn',
      'anan', 'amina', 'sikim', 'oÃ§', 'mk', 'awk', 'amq',
      // English
      'fuck', 'shit', 'ass', 'dick', 'cock', 'pussy', 'bitch', 'cunt', 'nigger', 'faggot',
      'whore', 'slut', 'bastard', 'damn', 'penis', 'vagina', 'boob', 'tits',
      // Leetspeak variants
      'f4ck', 'sh1t', 'b1tch', 'p0rn', 's3x', 'd1ck', 'c0ck', 'fuk', 'azz'
    ];
    
    const lowerName = name.toLowerCase();
    for (const word of badWords) {
      if (lowerName.includes(word)) {
        errors.push('Uygunsuz iÃ§erik tespit edildi');
        break;
      }
    }
    
    // Reserved usernames
    const reserved = ['admin', 'trai', 'support', 'help', 'official', 'moderator', 'mod', 'system', 'bot', 'root', 'null', 'undefined'];
    if (reserved.includes(lowerName)) {
      errors.push('Bu kullanÄ±cÄ± adÄ± ayrÄ±lmÄ±ÅŸ');
    }
    
    return errors;
  };

  // Check username availability (simulated - in real app would check Firestore)
  const checkUsernameAvailability = async (name) => {
    if (!name || name.length < 3) {
      setUsernameStatus({ checking: false, available: null, error: null });
      return;
    }
    
    const errors = validateUsername(name);
    if (errors.length > 0) {
      setUsernameStatus({ checking: false, available: false, error: errors[0] });
      return;
    }
    
    setUsernameStatus({ checking: true, available: null, error: null });
    
    // Simulate API check delay
    await new Promise(r => setTimeout(r, 500));
    
    // Check Firestore for existing username
    if (db) {
      try {
        const snapshot = await db.collection('usernames').doc(name.toLowerCase()).get();
        if (snapshot.exists) {
          setUsernameStatus({ checking: false, available: false, error: 'Bu kullanÄ±cÄ± adÄ± alÄ±nmÄ±ÅŸ' });
        } else {
          setUsernameStatus({ checking: false, available: true, error: null });
        }
      } catch (e) {
        // If Firestore not available, assume available
        setUsernameStatus({ checking: false, available: true, error: null });
      }
    } else {
      setUsernameStatus({ checking: false, available: true, error: null });
    }
  };

  // Debounced username check
  useEffect(() => {
    if (mode !== 'register') return;
    const timer = setTimeout(() => {
      checkUsernameAvailability(username);
    }, 400);
    return () => clearTimeout(timer);
  }, [username, mode]);

  // Email validation
  const validateEmail = (emailInput) => {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailInput) return null;
    if (!emailRegex.test(emailInput)) return 'GeÃ§erli bir e-posta adresi girin';
    return null;
  };

  // Check email availability
  const checkEmailAvailability = async (emailInput) => {
    if (!emailInput || emailInput.length < 5) {
      setEmailStatus({ checking: false, available: null, error: null });
      return;
    }
    
    const validationError = validateEmail(emailInput);
    if (validationError) {
      setEmailStatus({ checking: false, available: false, error: validationError });
      return;
    }
    
    setEmailStatus({ checking: true, available: null, error: null });
    
    // Check with Firebase Auth - try to fetch sign-in methods
    if (auth) {
      try {
        const methods = await auth.fetchSignInMethodsForEmail(emailInput);
        if (methods && methods.length > 0) {
          setEmailStatus({ checking: false, available: false, error: 'Bu e-posta adresi zaten kullanÄ±lÄ±yor' });
        } else {
          setEmailStatus({ checking: false, available: true, error: null });
        }
      } catch (e) {
        // Invalid email format or other error
        if (e.code === 'auth/invalid-email') {
          setEmailStatus({ checking: false, available: false, error: 'GeÃ§ersiz e-posta adresi' });
        } else {
          // Assume available if can't check
          setEmailStatus({ checking: false, available: true, error: null });
        }
      }
    } else {
      setEmailStatus({ checking: false, available: true, error: null });
    }
  };

  // Debounced email check
  useEffect(() => {
    if (mode !== 'register') return;
    const timer = setTimeout(() => {
      checkEmailAvailability(email);
    }, 600);
    return () => clearTimeout(timer);
  }, [email, mode]);

  // Password validation
  const validatePassword = (password) => {
    const errors = [];
    if (password.length < 8) errors.push('En az 8 karakter');
    if (!/[A-Z]/.test(password)) errors.push('En az 1 bÃ¼yÃ¼k harf');
    if (!/[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\;'/`~]/.test(password)) errors.push('En az 1 noktalama iÅŸareti');
    return errors;
  };

  // Update password and validate
  const handlePassChange = (value) => {
    setPass(value);
    if (mode === 'register' && value.length > 0) {
      setPassErrors(validatePassword(value));
    } else {
      setPassErrors([]);
    }
  };

  const acceptTerms = () => { 
    setTermsOk(true); 
    localStorage.setItem('trai_consents_v2', JSON.stringify(consents)); 
    setShowTerms(false); 
  };
  
  const openLegalDoc = (docType) => {
    setTermsDocType(docType);
    setShowTerms(true);
  };

  // Åžifremi Unuttum
  const forgotPassword = async () => {
    if (!auth) return setToast({ open: true, type: 'error', title: t('error'), message: 'Firebase baÄŸlantÄ±sÄ± kurulamadÄ±' });
    if (!email) return setToast({ open: true, type: 'error', title: 'E-posta Gerekli', message: 'Åžifre sÄ±fÄ±rlama linki iÃ§in e-posta adresinizi girin' });
    
    setBusy(true);
    try {
      await auth.sendPasswordResetEmail(email);
      setToast({ open: true, type: 'success', title: 'E-posta GÃ¶nderildi', message: 'Åžifre sÄ±fÄ±rlama linki e-posta adresinize gÃ¶nderildi' });
    } catch (e) {
      let m = e.message;
      if (e.code === 'auth/user-not-found') m = 'Bu e-posta ile kayÄ±tlÄ± hesap bulunamadÄ±';
      if (e.code === 'auth/invalid-email') m = 'GeÃ§ersiz e-posta adresi';
      if (e.code === 'auth/too-many-requests') m = 'Ã‡ok fazla deneme. LÃ¼tfen bekleyin.';
      setToast({ open: true, type: 'error', title: t('error'), message: m });
    }
    setBusy(false);
  };

  const submit = async (e) => {
    // SAYFA YENÄ°LENMESÄ°NÄ° ENGELLE
    if (e) e.preventDefault();
    
    console.log('ðŸ”µ ADIM 1: Submit baÅŸladÄ±');
    
    try {
      // Firebase kontrol
      if (typeof firebase === 'undefined') {
        alert("HATA: Firebase kÃ¼tÃ¼phanesi yÃ¼klenmedi!");
        return;
      }
      if (!auth) {
        alert("HATA: Firebase Auth baÅŸlatÄ±lamadÄ±.");
        return;
      }
      console.log('ðŸ”µ ADIM 2: Firebase OK');
      
      // Alan kontrolleri
      if (!email || !pass) {
        alert("E-posta ve ÅŸifre gerekli.");
        return;
      }
      console.log('ðŸ”µ ADIM 3: Email/Pass OK');

      // KayÄ±t validasyonlarÄ±
      if (mode === 'register') {
        console.log('ðŸ”µ ADIM 4: Register kontrolleri');
        if (!username) { 
          alert("KullanÄ±cÄ± adÄ± gerekli."); 
          return; 
        }
        const usernameErrors = validateUsername(username);
        if (usernameErrors.length > 0) {
          alert("KullanÄ±cÄ± AdÄ±: " + usernameErrors[0]);
          return;
        }
        if (!usernameStatus.available) {
          alert("KullanÄ±cÄ± AdÄ±: " + (usernameStatus.error || 'Bu kullanÄ±cÄ± adÄ± kullanÄ±lamaz'));
          return;
        }
        // Email availability check
        if (emailStatus.available === false) {
          alert("E-posta: " + (emailStatus.error || 'Bu e-posta adresi zaten kullanÄ±lÄ±yor'));
          return;
        }
        const errors = validatePassword(pass);
        if (errors.length > 0) {
          alert("ZayÄ±f Åžifre: " + errors.join(', '));
          return;
        }
        // Åžifre doÄŸrulama kontrolÃ¼
        if (pass !== passConfirm) {
          alert("Åžifreler uyuÅŸmuyor. LÃ¼tfen aynÄ± ÅŸifreyi girin.");
          return;
        }
        if (!requiredConsentsOk) { 
          alert("Zorunlu izinleri onaylayÄ±n."); 
          return; 
        }
        console.log('ðŸ”µ ADIM 5: Validasyonlar OK');
      }

      setBusy(true);
      console.log('ðŸ”µ ADIM 6: Firebase Auth iÅŸlemi baÅŸlÄ±yor...');
      
      // GiriÅŸ veya KayÄ±t
      const c = mode === 'login' 
        ? await auth.signInWithEmailAndPassword(email, pass) 
        : await auth.createUserWithEmailAndPassword(email, pass);
      
      console.log('ðŸŸ¢ ADIM 7: Auth baÅŸarÄ±lÄ±:', c.user.uid);
      
      // Yeni kayÄ±tta Firestore iÅŸlemleri
      if (mode === 'register' && c.user && db) {
        console.log('ðŸ”µ ADIM 8: Firestore kayÄ±t');
        
        // Check if this email was previously deleted (abuse prevention)
        let isReturningUser = false;
        try {
          const deletedEmailDoc = await db.collection('deletedEmails').doc(email.toLowerCase()).get();
          if (deletedEmailDoc.exists) {
            console.log('âš ï¸ Previously deleted email detected - no free trials');
            isReturningUser = true;
          }
        } catch (e) {
          console.warn('âš ï¸ Deleted email check error:', e);
        }
        
        try {
          await db.collection('usernames').doc(username.toLowerCase()).set({
            uid: c.user.uid,
            username: username,
            createdAt: Date.now()
          });
          await db.collection('users').doc(c.user.uid).set({
            username: username,
            usernameLower: username.toLowerCase(),
            displayName: displayName.trim() || null,
            email: c.user.email,
            credits: 0, // SatÄ±n alÄ±nmÄ±ÅŸ krediler
            // Yeni Ã¼cretsiz hak sistemi - tek seferlik, yenilenmez
            freeAvatarTry: isReturningUser ? 0 : 1,  // 1 avatar oluÅŸturma hakkÄ±
            freeShopTry: isReturningUser ? 0 : 1,    // 1 shop deneme hakkÄ±
            freeComboTry: isReturningUser ? 0 : 1,   // 1 kombin deneme hakkÄ±
            subscription: null,
            returningUser: isReturningUser,
            createdAt: Date.now()
          }, { merge: true });
          console.log('ðŸŸ¢ ADIM 9: Firestore OK');
        } catch (dbErr) {
          console.warn('âš ï¸ Firestore hatasÄ± (devam ediliyor):', dbErr.message);
        }
        
        // Email doÄŸrulama
        if (!c.user.emailVerified) {
          try {
            console.log('ðŸ“§ Email doÄŸrulama gÃ¶nderiliyor...', c.user.email);
            const actionCodeSettings = {
              url: window.location.origin + '/?verified=true',
              handleCodeInApp: false
            };
            await c.user.sendEmailVerification(actionCodeSettings);
            console.log('âœ… Email doÄŸrulama gÃ¶nderildi');
            setToast({ open: true, type: 'info', title: 'DoÄŸrulama Emaili', message: 'LÃ¼tfen email kutunuzu kontrol edin' });
          } catch (verifyErr) {
            console.error('âŒ Email doÄŸrulama hatasÄ±:', verifyErr.code, verifyErr.message);
            // Firebase'de "too-many-requests" hatasÄ± olabilir
            if (verifyErr.code !== 'auth/too-many-requests') {
              setToast({ open: true, type: 'warning', title: 'Email DoÄŸrulama', message: 'DoÄŸrulama emaili gÃ¶nderilemedi. Daha sonra tekrar deneyin.' });
            }
          }
        }
      }
      
      // BaÅŸarÄ±lÄ±
      console.log('ðŸŸ¢ ADIM 10: Ä°ÅŸlem tamamlandÄ±!');
      if (mode === 'register') localStorage.setItem('trai_terms_v1', '1');
      onAuthed({ 
        uid: c.user.uid, 
        email: c.user.email, 
        emailVerified: c.user.emailVerified, 
        username: mode === 'register' ? username : null, 
        displayName: mode === 'register' ? (displayName.trim() || null) : null 
      });
      setToast({ open: true, type: 'success', title: 'HoÅŸ geldin!', message: 'GiriÅŸ baÅŸarÄ±lÄ±' });
      
    } catch (e) {
      console.error('ðŸ”´ HATA:', e);
      
      let userMessage = e.message;
      if (e.code === 'auth/invalid-credential') userMessage = 'E-posta veya ÅŸifre hatalÄ±';
      else if (e.code === 'auth/email-already-in-use') userMessage = 'Bu e-posta zaten kayÄ±tlÄ±';
      else if (e.code === 'auth/weak-password') userMessage = 'Åžifre Ã§ok zayÄ±f';
      else if (e.code === 'auth/invalid-email') userMessage = 'GeÃ§ersiz e-posta';
      else if (e.code === 'auth/user-not-found') userMessage = 'Hesap bulunamadÄ±';
      else if (e.code === 'auth/wrong-password') userMessage = 'Åžifre hatalÄ±';
      else if (e.code === 'auth/too-many-requests') userMessage = 'Ã‡ok fazla deneme';
      else if (e.code === 'auth/network-request-failed') userMessage = 'Sunucuya ulaÅŸÄ±lamadÄ±';
      else if (e.code === 'auth/operation-not-allowed') userMessage = 'Email/Åžifre giriÅŸi kapalÄ±';
      
      // GERÃ‡EK HATAYI GÃ–STER
      alert(`HATA!\n\nKod: ${e.code || 'Yok'}\nMesaj: ${userMessage}\n\nDetay: ${e.message}`);
      setToast({ open: true, type: 'error', title: 'Hata', message: userMessage });
    } finally {
      setBusy(false);
    }
  };

  const googleLogin = async () => {
    if (!auth) return setToast({ open: true, type: 'error', title: t('connectionError'), message: 'Firebase baÄŸlantÄ±sÄ± kurulamadÄ±. SayfayÄ± yenileyin.' });
    setBusy(true);
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      
      // Try popup first, fallback to redirect on mobile/blocked
      let result;
      try {
        result = await auth.signInWithPopup(provider);
      } catch (popupError) {
        // If popup blocked or failed on mobile, try redirect
        if (popupError.code === 'auth/popup-blocked' || popupError.code === 'auth/popup-closed-by-user') {
          await auth.signInWithRedirect(provider);
          return; // Redirect will reload page
        }
        throw popupError;
      }
      
      localStorage.setItem('trai_terms_v1', '1');
      onAuthed({ uid: result.user.uid, email: result.user.email, emailVerified: result.user.emailVerified });
      setToast({ open: true, type: 'success', title: 'HoÅŸ geldin!', message: 'Google ile giriÅŸ baÅŸarÄ±lÄ±' });
    } catch (e) { 
      let m = e.message;
      const code = e.code || '';
      
      if (code === 'auth/popup-closed-by-user') m = 'GiriÅŸ penceresi kapatÄ±ldÄ±';
      else if (code === 'auth/popup-blocked') m = 'Popup engellendi. LÃ¼tfen izin verin.';
      else if (code === 'auth/network-request-failed') m = 'Sunucuya baÄŸlanÄ±lamÄ±yor. VPN kullanÄ±yorsanÄ±z kapatmayÄ± deneyin.';
      else if (code === 'auth/unauthorized-domain') m = 'Bu domain yetkilendirilmemiÅŸ. Firebase Console > Authentication > Settings > Authorized domains\'e bu siteyi ekleyin.';
      else if (code === 'auth/operation-not-allowed') m = 'Google giriÅŸi etkin deÄŸil. Firebase Console > Authentication > Sign-in method > Google\'Ä± etkinleÅŸtirin.';
      else if (code === 'auth/cancelled-popup-request') m = 'Ä°ÅŸlem iptal edildi. Tekrar deneyin.';
      else if (code === 'auth/internal-error') {
        m = 'Firebase yapÄ±landÄ±rma hatasÄ±. LÃ¼tfen ÅŸunlarÄ± kontrol edin:\n\n' +
            '1. Firebase Console > Authentication > Sign-in method > Google ETKÄ°N mi?\n\n' +
            '2. Firebase Console > Authentication > Settings > Authorized domains\'de bu site var mÄ±?\n\n' +
            '3. Google Cloud Console > APIs & Services > Credentials\'da OAuth ayarlarÄ± doÄŸru mu?';
      }
      
      console.error('Google auth error:', code, e.message, e);
      setToast({ open: true, type: 'error', title: 'Google GiriÅŸ HatasÄ±', message: m }); 
    }
    setBusy(false);
  };
  
  // Check for redirect result on page load
  useEffect(() => {
    if (auth) {
      auth.getRedirectResult().then(result => {
        if (result?.user) {
          localStorage.setItem('trai_terms_v1', '1');
          onAuthed({ uid: result.user.uid, email: result.user.email, emailVerified: result.user.emailVerified });
        }
      }).catch(e => {
        console.error('Redirect result error:', e);
      });
    }
  }, []);

  if (mode === 'welcome') {
    return (
      <div className="h-full bg-gradient-premium flex flex-col">
        {/* Language Selector - Fixed top */}
        <div className="flex-shrink-0 p-3 flex justify-end safe-top">
          <div className="flex gap-1 glass rounded-full p-1">
            <button 
              onClick={() => changeLanguage('tr')}
              className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${currentLanguage === 'tr' ? 'bg-brand text-white' : 'text-slate-500 hover:text-slate-700'}`}
            >
              TR
            </button>
            <button 
              onClick={() => changeLanguage('en')}
              className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${currentLanguage === 'en' ? 'bg-brand text-white' : 'text-slate-500 hover:text-slate-700'}`}
            >
              EN
            </button>
          </div>
        </div>
        
        {/* Main Content - Centered with top bias */}
        <div className="flex-1 flex flex-col items-center justify-start pt-8 px-6 text-center">
          {/* Logo & Brand */}
          <div className="mb-3 float"><img src={LOGO_BASE64} alt="TrAi Logo" className="w-20 h-20 rounded-2xl shadow-xl shadow-brand/20" /></div>
          <h1 className="text-2xl font-light tracking-wide text-slate-700 mb-1">TrAi Style</h1>
          
          {/* BUTTONS - Compact */}
          <div className="w-full max-w-xs space-y-2 my-4">
            <button onClick={() => setMode('register')} className="w-full btn-primary py-3 rounded-xl font-semibold text-sm flex items-center justify-center gap-2 shadow-lg shadow-brand/25">{t('startFree')}<Icon name="chevronRight" size={16} /></button>
            <button onClick={() => setMode('login')} className="w-full glass py-2.5 rounded-xl font-medium text-sm text-slate-600">{t('alreadyHaveAccount')}</button>
          </div>
          
          {/* Slogan with more spacing */}
          <p className="text-sm text-slate-500 mt-4 mb-8">{t('sloganFull')}</p>
          
          {/* Features */}
          <div className="flex gap-6 mb-6">
            {[{ icon: 'user', label: t('digitalTwin') }, { icon: 'shirt', label: t('virtualTryOn') }, { icon: 'sparkles', label: t('aiStylist') }].map((f, i) => (
              <div key={i} className="text-center fade-in" style={{ animationDelay: `${i * 0.1}s` }}>
                <div className="w-12 h-12 rounded-xl glass flex items-center justify-center mx-auto mb-2">
                  <Icon name={f.icon} size={20} className="text-brand2" />
                </div>
                <span className="text-xs text-slate-500">{f.label}</span>
              </div>
            ))}
          </div>
          
          {/* Trust badges */}
          <div className="flex items-center gap-3 text-slate-400 text-xs">
            <div className="flex items-center gap-1"><Icon name="shield" size={14} /><span>{t('kvkkCompliant')}</span></div>
            <div className="w-1 h-1 rounded-full bg-slate-300" />
            <div className="flex items-center gap-1"><Icon name="lock" size={14} /><span>{t('sslSecure')}</span></div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="h-full bg-gradient-premium flex flex-col">
      <div className="p-6 safe-top"><button onClick={() => setMode('welcome')} className="p-2 -ml-2 rounded-xl hover:bg-slate-200/60"><Icon name="chevronLeft" size={24} /></button></div>
      <div className="flex-1 px-6 pb-24 overflow-y-auto custom-scroll">
        <div className="flex justify-center mb-6"><img src={LOGO_BASE64} alt="TrAi Logo" className="w-16 h-16 rounded-2xl" /></div>
        <h1 className="text-2xl font-bold text-center mb-1">{mode === 'login' ? t('welcomeBack') : t('createAccount')}</h1>
        <p className="text-sm text-slate-500 text-center mb-8">{mode === 'login' ? t('loginToAccount') : t('startFashionJourney')}</p>
        
        <button onClick={googleLogin} disabled={busy} className="w-full btn-secondary py-4 rounded-2xl font-semibold text-sm flex items-center justify-center gap-3 mb-6 disabled:opacity-50"><Icon name="google" size={20} />{t('continueWithGoogle')}</button>
        <div className="flex items-center gap-3 mb-6"><div className="flex-1 h-px bg-slate-200/60" /><span className="text-xs text-slate-400">{t('or')}</span><div className="flex-1 h-px bg-slate-200/60" /></div>
        
        <div className="space-y-4 mb-6">
          {/* Username - only for registration */}
          {mode === 'register' && (
            <div>
              <label className="text-xs text-slate-500 mb-1.5 block">{t('username')}</label>
              <div className="relative">
                <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-medium">@</span>
                <input 
                  type="text" 
                  value={username} 
                  onChange={e => setUsername(e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, ''))} 
                  placeholder={t('usernamePlaceholder')} 
                  className="pl-10 pr-10"
                  maxLength={20}
                />
                {/* Status indicator */}
                <div className="absolute right-4 top-1/2 -translate-y-1/2">
                  {usernameStatus.checking && (
                    <div className="w-4 h-4 border-2 border-white/30 border-t-white/60 rounded-full animate-spin" />
                  )}
                  {!usernameStatus.checking && usernameStatus.available === true && (
                    <Icon name="check" size={18} className="text-green-400" />
                  )}
                  {!usernameStatus.checking && usernameStatus.available === false && (
                    <Icon name="x" size={18} className="text-red-400" />
                  )}
                </div>
              </div>
              {/* Username feedback */}
              {username.length > 0 && (
                <div className="mt-1.5">
                  {usernameStatus.error ? (
                    <p className="text-xs text-red-400">{usernameStatus.error}</p>
                  ) : usernameStatus.available ? (
                    <p className="text-xs text-green-400">@{username} kullanÄ±labilir!</p>
                  ) : username.length < 3 ? (
                    <p className="text-xs text-slate-400">En az 3 karakter gerekli</p>
                  ) : null}
                </div>
              )}
              {username.length === 0 && (
                <p className="text-xs text-slate-400 mt-1">Harf ile baÅŸlamalÄ±, sadece harf, rakam ve _ iÃ§erebilir</p>
              )}
            </div>
          )}
          
          {/* Display Name - optional, only for registration */}
          {mode === 'register' && (
            <div>
              <label className="text-xs text-slate-500 mb-1.5 block">{t('displayNameLabel')} <span className="text-slate-400">{t('displayNameOptional')}</span></label>
              <div className="relative">
                <Icon name="user" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
                <input 
                  type="text" 
                  value={displayName} 
                  onChange={e => setDisplayName(e.target.value)} 
                  placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z" 
                  className="pl-11"
                  maxLength={50}
                />
              </div>
              <p className="text-xs text-slate-400 mt-1">Profilinizde gÃ¶rÃ¼necek isim (boÅŸ bÄ±rakÄ±rsanÄ±z kullanÄ±cÄ± adÄ± gÃ¶sterilir)</p>
            </div>
          )}
          
          <div><label className="text-xs text-slate-500 mb-1.5 block">E-posta</label>
            <div className="relative">
              <Icon name="mail" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
              <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="ornek@mail.com" className="pl-11 pr-10" />
              {/* Status indicator - only show on register */}
              {mode === 'register' && (
                <div className="absolute right-4 top-1/2 -translate-y-1/2">
                  {emailStatus.checking && (
                    <div className="w-4 h-4 border-2 border-white/30 border-t-white/60 rounded-full animate-spin" />
                  )}
                  {!emailStatus.checking && emailStatus.available === true && (
                    <Icon name="check" size={18} className="text-green-400" />
                  )}
                  {!emailStatus.checking && emailStatus.available === false && (
                    <Icon name="x" size={18} className="text-red-400" />
                  )}
                </div>
              )}
            </div>
            {/* Email feedback - only show on register */}
            {mode === 'register' && email.length > 0 && (
              <div className="mt-1.5">
                {emailStatus.error ? (
                  <p className="text-xs text-red-400">{emailStatus.error}</p>
                ) : emailStatus.available ? (
                  <p className="text-xs text-green-400">E-posta kullanÄ±labilir âœ“</p>
                ) : null}
              </div>
            )}
          </div>
          <div>
            <label className="text-xs text-slate-500 mb-1.5 block">Åžifre</label>
            <div className="relative">
              <Icon name="lock" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
              <input 
                type={showPass ? 'text' : 'password'} 
                value={pass} 
                onChange={e => handlePassChange(e.target.value)} 
                onKeyDown={e => { if (e.key === 'Enter' && !busy) submit(e); }}
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
                className="pl-11 pr-11" 
              />
              <button type="button" onClick={() => setShowPass(!showPass)} className="absolute right-3 top-1/2 -translate-y-1/2 p-1.5"><Icon name={showPass ? 'eyeOff' : 'eye'} size={18} className="text-slate-400" /></button>
            </div>
            {/* Password requirements - only show on register */}
            {mode === 'register' && (
              <div className="mt-2 space-y-1">
                <div className={`flex items-center gap-2 text-xs ${pass.length >= 8 ? 'text-green-400' : 'text-slate-400'}`}>
                  <Icon name={pass.length >= 8 ? 'check' : 'x'} size={12} />
                  <span>En az 8 karakter</span>
                </div>
                <div className={`flex items-center gap-2 text-xs ${/[A-Z]/.test(pass) ? 'text-green-400' : 'text-slate-400'}`}>
                  <Icon name={/[A-Z]/.test(pass) ? 'check' : 'x'} size={12} />
                  <span>En az 1 bÃ¼yÃ¼k harf (A-Z)</span>
                </div>
                <div className={`flex items-center gap-2 text-xs ${/[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\;'/\`~]/.test(pass) ? 'text-green-400' : 'text-slate-400'}`}>
                  <Icon name={/[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\;'/\`~]/.test(pass) ? 'check' : 'x'} size={12} />
                  <span>En az 1 noktalama iÅŸareti (!@#$%...)</span>
                </div>
              </div>
            )}
          </div>
          
          {/* Password Confirmation - only show on register */}
          {mode === 'register' && (
            <div>
              <label className="text-xs text-slate-500 mb-1.5 block">Åžifre Tekrar</label>
              <div className="relative">
                <Icon name="lock" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
                <input 
                  type={showPass ? 'text' : 'password'} 
                  value={passConfirm} 
                  onChange={e => setPassConfirm(e.target.value)} 
                  placeholder="Åžifrenizi tekrar girin" 
                  className={`pl-11 ${passConfirm && pass !== passConfirm ? 'border-red-400 ring-red-200' : passConfirm && pass === passConfirm ? 'border-green-400 ring-green-200' : ''}`}
                />
              </div>
              {passConfirm && (
                <div className={`mt-2 flex items-center gap-2 text-xs ${pass === passConfirm ? 'text-green-400' : 'text-red-400'}`}>
                  <Icon name={pass === passConfirm ? 'check' : 'x'} size={12} />
                  <span>{pass === passConfirm ? 'Åžifreler uyuÅŸuyor' : 'Åžifreler uyuÅŸmuyor'}</span>
                </div>
              )}
            </div>
          )}
        </div>
        
        {/* Forgot Password - only show on login */}
        {mode === 'login' && (
          <div className="text-right mb-4">
            <button 
              onClick={forgotPassword} 
              disabled={busy}
              className="text-sm text-brand2 hover:text-brand font-medium disabled:opacity-50"
            >
              {t('forgotPassword')}
            </button>
          </div>
        )}
        
        {/* Consent Checkboxes - only show on registration */}
        {mode === 'register' && (
          <div className="mb-6 space-y-3">
            {/* 18+ Age Notice - Just text, no checkbox */}
            <div className="p-3 rounded-xl bg-red-50 border border-red-200">
              <p className="text-xs text-red-600 flex items-center gap-2">
                <span className="text-base">ðŸ”ž</span>
                <span>{t('ageConfirmText')}</span>
              </p>
            </div>
            
            {/* Combined Face Data & USA Transfer Consent - REQUIRED */}
            <div className="flex items-start gap-3 p-3 rounded-xl glass border border-brand/20">
              <input 
                type="checkbox" 
                checked={consents.faceData && consents.usaTransfer} 
                onChange={e => setConsents(p => ({ ...p, faceData: e.target.checked, usaTransfer: e.target.checked }))} 
                className="w-5 h-5 rounded border-2 border-slate-300 bg-slate-100 checked:bg-brand checked:border-brand mt-0.5 cursor-pointer accent-brand flex-shrink-0" 
              />
              <div>
                <p className="text-xs font-semibold text-slate-700 flex items-center gap-1">{t('faceDataConsent')} <span className="text-red-400">*</span></p>
                <p className="text-[11px] text-slate-500 mt-0.5">{t('faceDataConsentText')} {t('usaTransferConsentText')}</p>
              </div>
            </div>
            
            {/* Terms & Privacy - REQUIRED */}
            <div className="flex items-start gap-3 p-3 rounded-xl glass border border-brand/20">
              <input 
                type="checkbox" 
                checked={termsOk} 
                onChange={e => setTermsOk(e.target.checked)} 
                className="w-5 h-5 rounded border-2 border-slate-300 bg-slate-100 checked:bg-brand checked:border-brand mt-0.5 cursor-pointer accent-brand flex-shrink-0" 
              />
              <div>
                <p className="text-xs text-slate-600">
                  <button onClick={() => openLegalDoc('terms')} className="text-brand2 font-medium underline underline-offset-2">{t('termsAcceptText')}</button>
                  {' '}{t('and')}{' '}
                  <button onClick={() => openLegalDoc('kvkk')} className="text-brand2 font-medium underline underline-offset-2">{t('kvkkText')}</button>
                  {t('readAccepted')} <span className="text-red-400">*</span>
                </p>
              </div>
            </div>
            
            <p className="text-[10px] text-slate-400 text-center"><span className="text-red-400">*</span> {t('requiredFields')}</p>
          </div>
        )}
        
        <button onClick={(e) => submit(e)} disabled={busy || (mode === 'register' && (!requiredConsentsOk || passErrors.length > 0 || !usernameStatus.available || emailStatus.available === false))} className="w-full btn-primary py-4 rounded-2xl font-bold disabled:opacity-50 mb-4">
          {busy ? <span className="flex items-center justify-center gap-2"><div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />{t('processing')}</span> : (mode === 'login' ? t('login') : t('register'))}
        </button>
        
        {/* Footer with legal links - only on register */}
        {mode === 'register' && (
          <div className="border-t border-slate-200 pt-4 mb-4">
            <div className="flex flex-wrap justify-center gap-x-3 gap-y-1 text-[10px] text-slate-400">
              <button onClick={() => openLegalDoc('terms')} className="hover:text-brand2 underline-offset-2 hover:underline">{t('termsAcceptText')}</button>
              <span>|</span>
              <button onClick={() => openLegalDoc('kvkk')} className="hover:text-brand2 underline-offset-2 hover:underline">{t('kvkkText')}</button>
              <span>|</span>
              <button onClick={() => openLegalDoc('onbilgilendirme')} className="hover:text-brand2 underline-offset-2 hover:underline">{t('preInfoForm')}</button>
            </div>
            <p className="text-[10px] text-slate-300 text-center mt-2">Â© 2025 TrAi Technologies</p>
          </div>
        )}
        
        <p className="text-center text-sm text-slate-500 pb-8 safe-bottom">{mode === 'login' ? t('noAccount') + ' ' : t('haveAccount') + ' '}<button onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-brand2 font-semibold">{mode === 'login' ? t('signUp') : t('signIn')}</button></p>
      </div>
      <TermsModal isOpen={showTerms} onClose={() => setShowTerms(false)} onAccept={termsDocType === 'terms' ? acceptTerms : null} docType={termsDocType} />
    </div>
  );
};

// ============ AVATAR WIZARD ============
const AvatarWizard = ({ onComplete, setToast, initialParams = null, useCredit, refundCredit }) => {
  const [step, setStep] = useState(1);
  const [params, setParams] = useState(initialParams || {
    gender: '', age: '', height: '', weight: '',
    bodyType: 'average', skinTone: 'medium', 
    hairColor: 'brown', hairLength: 'medium', hairType: 'straight',
    hijab: false
  });
  const [photos, setPhotos] = useState([]);
  const [status, setStatus] = useState('');
  const [busy, setBusy] = useState(false);
  const [cameraReady, setCameraReady] = useState(false);
  const [useNativeCamera, setUseNativeCamera] = useState(false);
  const [creditUsed, setCreditUsed] = useState(false); // Kredi kullanÄ±ldÄ± mÄ± takip et
  const fileInputRef = useRef(null);
  const videoRef = useRef(null);
  const streamRef = useRef(null);

  // Detect if mobile
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  
  // Validation - all required fields filled
  const isFormValid = params.gender && params.age && params.height && params.weight;

  useEffect(() => {
    if (step === 2 && !isMobile) {
      startWebCamera();
    }
    return () => stopCamera();
  }, [step]);

  // Web camera using getUserMedia
  const startWebCamera = async () => {
    try {
      setCameraReady(false);
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });
      streamRef.current = stream;
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        videoRef.current.onloadedmetadata = () => {
          videoRef.current.play().then(() => setCameraReady(true)).catch(() => setCameraReady(true));
        };
      }
    } catch (e) {
      // Fallback to file input if camera fails
      setUseNativeCamera(true);
    }
  };

  const stopCamera = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(t => t.stop());
      streamRef.current = null;
    }
  };

  // Take photo from video stream (web)
  const takePhotoFromVideo = () => {
    const video = videoRef.current;
    if (!video) return;
    
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    const photo = canvas.toDataURL('image/jpeg', 0.8);
    
    addPhoto(photo);
  };

  // Handle photo from file input (mobile)
  const handleFileSelect = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (ev) => {
      // Compress image for mobile
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const maxSize = 800;
        let width = img.width;
        let height = img.height;
        
        if (width > height) {
          if (width > maxSize) {
            height = Math.round((height * maxSize) / width);
            width = maxSize;
          }
        } else {
          if (height > maxSize) {
            width = Math.round((width * maxSize) / height);
            height = maxSize;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        const compressed = canvas.toDataURL('image/jpeg', 0.7);
        addPhoto(compressed);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
    e.target.value = '';
  };

  // Add photo and trigger generate if 3 photos
  const addPhoto = (photo) => {
    setPhotos(prev => {
      const newPhotos = [...prev, photo];
      if (newPhotos.length >= 3) {
        stopCamera();
        setTimeout(() => generate(newPhotos), 100);
      }
      return newPhotos;
    });
  };

  const openNativeCamera = () => fileInputRef.current?.click();

  const generate = async (photoArray) => {
    // Kredi kontrolÃ¼ - avatar iÃ§in 'avatar' source
    let usedCredit = false;
    if (useCredit) {
      if (!useCredit('avatar')) {
        return; // Kredi yoksa Ã§Ä±k
      }
      usedCredit = true;
      setCreditUsed(true);
    }
    
    setBusy(true);
    setStep(3);
    setStatus(t('analyzingPhotos'));
    
    try {
      await sleep(500);
      setStatus(t('extractingFeatures'));
      await sleep(500);
      setStatus(t('creatingTwin'));
      
      const baseAvatar = await AI.generateBaseAvatar(params, photoArray);
      
      if (!baseAvatar) {
        throw new Error('Avatar oluÅŸturulamadÄ±');
      }
      
      setStatus('HazÄ±r! âœ¨');
      await sleep(400);
      setCreditUsed(false); // BaÅŸarÄ±lÄ± - kredi harcandÄ±, iade gerekmiyor
      onComplete({ ...params, baseAvatar, createdAt: Date.now() });
      setToast({ open: true, type: 'success', title: t('success'), message: 'Dijital ikizin oluÅŸturuldu!' });
    } catch (e) {
      // Hata durumunda krediyi iade et - sadece kredi kullanÄ±ldÄ±ysa
      if (usedCredit && refundCredit) {
        refundCredit('avatar');
      }
      setCreditUsed(false);
      // refundCredit zaten toast gÃ¶steriyor, sadece hata mesajÄ± gÃ¶ster (iade mesajÄ± yok)
      if (!usedCredit) {
        setToast({ open: true, type: 'error', title: 'Avatar hatasÄ±', message: e.message || 'Bir hata oluÅŸtu' });
      }
      setStep(1);
      setPhotos([]);
    }
    setBusy(false);
  };

  if (step === 1) {
    return (
      <div className="h-full flex flex-col overflow-y-auto custom-scroll">
        <div className="p-6 pt-8"><Logo /></div>
        <div className="px-6 pb-32">
          <div className="glass rounded-3xl p-6">
            <div className="text-center mb-8">
              <div className="w-20 h-20 mx-auto rounded-3xl bg-brand flex items-center justify-center mb-4 shadow-lg shadow-brand/20">
                <Icon name="user" size={36} className="text-white" />
              </div>
              <h1 className="text-2xl font-black">{t('createDigitalTwin')}</h1>
              <p className="text-sm text-slate-500 mt-2">{t('avatarDescription')}</p>
            </div>
            
            <div className="space-y-6">
              {/* Gender Selection */}
              <div>
                <label className="text-sm font-semibold text-slate-700 mb-3 block flex items-center gap-2">
                  <span className="w-6 h-6 rounded-lg bg-brand/10 flex items-center justify-center text-xs">1</span>
                  Cinsiyet
                </label>
                <p className="text-xs text-slate-500 mb-3">KÄ±yafet Ã¶nerileri ve avatar oluÅŸturma iÃ§in gerekli</p>
                <div className="grid grid-cols-2 gap-3">
                  {[
                    { value: 'female', label: 'KadÄ±n' },
                    { value: 'male', label: 'Erkek' }
                  ].map(g => (
                    <button key={g.value} onClick={() => setParams(p => ({ ...p, gender: g.value }))}
                      className={`py-4 rounded-2xl font-bold transition-all ${params.gender === g.value 
                        ? 'bg-brand text-white shadow-lg shadow-brand/20' 
                        : 'bg-slate-100 text-slate-600 hover:bg-slate-200/60'}`}>
                      {g.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Physical Info */}
              <div>
                <label className="text-sm font-semibold text-slate-700 mb-3 block flex items-center gap-2">
                  <span className="w-6 h-6 rounded-lg bg-brand/10 flex items-center justify-center text-xs">2</span>
                  Fiziksel Bilgiler
                </label>
                <p className="text-xs text-slate-500 mb-3">Avatar'Ä±n vÃ¼cut oranlarÄ±nÄ± doÄŸru oluÅŸturmak iÃ§in kullanÄ±lÄ±r</p>
                <div className="grid grid-cols-3 gap-3">
                  <div>
                    <label className="text-xs text-slate-500 mb-1.5 block">{t('age')}</label>
                    <input type="number" value={params.age} onChange={e => setParams(p => ({ ...p, age: e.target.value }))} 
                      placeholder="25" className="text-center text-lg font-bold" min="13" max="99" />
                  </div>
                  <div>
                    <label className="text-xs text-slate-500 mb-1.5 block">Boy (cm)</label>
                    <input type="number" value={params.height} onChange={e => setParams(p => ({ ...p, height: e.target.value }))} 
                      placeholder="170" className="text-center text-lg font-bold" min="100" max="220" />
                  </div>
                  <div>
                    <label className="text-xs text-slate-500 mb-1.5 block">Kilo (kg)</label>
                    <input type="number" value={params.weight} onChange={e => setParams(p => ({ ...p, weight: e.target.value }))} 
                      placeholder="60" className="text-center text-lg font-bold" min="30" max="200" />
                  </div>
                </div>
              </div>

              {/* Body Type */}
              <div>
                <label className="text-sm font-semibold text-slate-700 mb-3 block flex items-center gap-2">
                  <span className="w-6 h-6 rounded-lg bg-brand/10 flex items-center justify-center text-xs">3</span>
                  VÃ¼cut Tipi
                </label>
                <p className="text-xs text-slate-500 mb-3">{t('bodyTypeHelp')}</p>
                <select value={params.bodyType} onChange={e => setParams(p => ({ ...p, bodyType: e.target.value }))} className="text-base">
                  <option value="slim">{t('slim')}</option>
                  <option value="athletic">{t('athletic')}</option>
                  <option value="average">{t('average')}</option>
                  <option value="curvy">{t('curvy')}</option>
                  <option value="plus">{t('plus')}</option>
                </select>
              </div>

              {/* Skin Tone Section */}
              <div className="glass rounded-xl p-4">
                <label className="text-sm font-semibold text-slate-700 mb-3 block flex items-center gap-2">
                  <span className="w-6 h-6 rounded-lg bg-amber-100 flex items-center justify-center text-xs">4</span>
                  {t('skinTone')}
                </label>
                <div className="grid grid-cols-3 gap-2">
                  {[
                    { value: 'fair', label: t('fairSkin'), color: '#fde8d8' },
                    { value: 'light', label: t('lightSkin'), color: '#f5d5c0' },
                    { value: 'medium', label: t('mediumSkin'), color: '#d4a574' },
                    { value: 'olive', label: t('oliveSkin'), color: '#c49a6c' },
                    { value: 'tan', label: t('tanSkin'), color: '#a67c52' },
                    { value: 'dark', label: t('darkSkin'), color: '#6b4423' }
                  ].map(skin => (
                    <button
                      key={skin.value}
                      onClick={() => setParams(p => ({ ...p, skinTone: skin.value }))}
                      className={`p-2 rounded-lg border-2 text-xs font-medium transition ${
                        params.skinTone === skin.value 
                          ? 'border-brand bg-brand/5' 
                          : 'border-transparent bg-slate-50 hover:bg-slate-100'
                      }`}
                    >
                      <div className="w-8 h-8 rounded-full mx-auto mb-1" style={{ background: skin.color }} />
                      {skin.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Hair Section */}
              <div className="glass rounded-xl p-4">
                <label className="text-sm font-semibold text-slate-700 mb-3 block flex items-center gap-2">
                  <span className="w-6 h-6 rounded-lg bg-purple-100 flex items-center justify-center text-xs">5</span>
                  {t('hairSection')}
                </label>
                
                {/* Hair Color / Hijab */}
                <div className="mb-4">
                  <p className="text-xs text-slate-500 mb-2">{t('hairColorSelect')}</p>
                  <div className="grid grid-cols-3 gap-2">
                    {[
                      { value: 'black', label: t('blackHair'), color: '#1a1a1a' },
                      { value: 'brown', label: t('brownHair'), color: '#5c4033' },
                      { value: 'blonde', label: t('blondeHair'), color: '#d4a017' },
                      { value: 'red', label: t('redHair'), color: '#8b2500' },
                      { value: 'gray', label: t('grayHair'), color: '#808080' },
                      { value: 'hijab', label: t('hijabOption'), color: 'linear-gradient(135deg, #6366f1, #8b5cf6)', isHijab: true }
                    ].map(hair => (
                      <button
                        key={hair.value}
                        onClick={() => setParams(p => ({ 
                          ...p, 
                          hairColor: hair.value,
                          hijab: hair.value === 'hijab'
                        }))}
                        className={`p-2 rounded-lg border-2 text-xs font-medium transition ${
                          params.hairColor === hair.value 
                            ? 'border-brand bg-brand/5' 
                            : 'border-transparent bg-slate-50 hover:bg-slate-100'
                        }`}
                      >
                        {hair.isHijab ? (
                          <div className="w-8 h-8 rounded-full mx-auto mb-1 flex items-center justify-center text-white text-[10px] font-bold" style={{ background: hair.color }}>T</div>
                        ) : (
                          <div className="w-8 h-8 rounded-full mx-auto mb-1" style={{ background: hair.color }} />
                        )}
                        {hair.label}
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* Hair Length & Type - Only show if not hijab */}
                {!params.hijab && (
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <p className="text-xs text-slate-500 mb-2">{t('hairLengthSelect')}</p>
                      <select 
                        value={params.hairLength} 
                        onChange={e => setParams(p => ({ ...p, hairLength: e.target.value }))}
                        className="text-sm"
                      >
                        <option value="very-short">{t('veryShortHair')}</option>
                        <option value="short">{t('shortHair')}</option>
                        <option value="medium">{t('mediumHair')}</option>
                        <option value="long">{t('longHair')}</option>
                        <option value="very-long">{t('veryLongHair')}</option>
                        {params.gender === 'male' && <option value="bald">{t('bald')}</option>}
                      </select>
                    </div>
                    <div>
                      <p className="text-xs text-slate-500 mb-2">{t('hairTypeSelect')}</p>
                      <select 
                        value={params.hairType} 
                        onChange={e => setParams(p => ({ ...p, hairType: e.target.value }))}
                        className="text-sm"
                      >
                        <option value="straight">{t('straightHair')}</option>
                        <option value="wavy">{t('wavyHair')}</option>
                        <option value="curly">{t('curlyHair')}</option>
                        <option value="coily">{t('coilyHair')}</option>
                      </select>
                    </div>
                  </div>
                )}
                
                {params.hijab && (
                  <div className="bg-purple-50 rounded-lg p-3 text-xs text-purple-700">
                    <span className="font-medium">BaÅŸÃ¶rtÃ¼sÃ¼ Modu:</span> AvatarÄ±nÄ±z modern baÅŸÃ¶rtÃ¼sÃ¼ stiliyle oluÅŸturulacak. Kombin denemelerinde kÄ±yafetlerinizle uyumlu baÅŸÃ¶rtÃ¼sÃ¼ Ã¶nerilecek.
                  </div>
                )}
              </div>

              {/* Submit Button */}
              <button 
                onClick={() => setStep(2)} 
                disabled={!isFormValid}
                className={`w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all ${
                  isFormValid 
                    ? 'btn-primary' 
                    : 'bg-slate-200/60 text-slate-400 cursor-not-allowed'
                }`}>
                <Icon name="camera" size={20} />
                {isFormValid ? 'Devam Et - FotoÄŸraf Ã‡ek' : 'TÃ¼m alanlarÄ± doldurun'}
              </button>
              
              {!isFormValid && (
                <p className="text-center text-xs text-slate-400">
                  Cinsiyet, yaÅŸ, boy ve kilo bilgilerini girin
                </p>
              )}
              
              {/* Safe bottom zone */}
              <div className="h-8 safe-bottom"></div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (step === 2) {
    const labels = ['Ã–n YÃ¼z', 'SaÄŸ Profil', 'Sol Profil'];
    const instructions = [
      { direction: 'front', text: 'DÃ¼z BakÄ±n', subtext: 'YÃ¼zÃ¼nÃ¼zÃ¼ kameraya doÄŸru tutun' },
      { direction: 'right', text: 'SaÄŸa DÃ¶nÃ¼n', subtext: 'BaÅŸÄ±nÄ±zÄ± hafifÃ§e saÄŸa Ã§evirin' },
      { direction: 'left', text: 'Sola DÃ¶nÃ¼n', subtext: 'BaÅŸÄ±nÄ±zÄ± hafifÃ§e sola Ã§evirin' }
    ];
    const currentInstruction = instructions[photos.length] || instructions[0];
    const showVideo = !isMobile && !useNativeCamera;
    
    return (
      <div className="fixed inset-0 bg-black flex flex-col" style={{ height: '100dvh' }}>
        {/* Hidden file input for mobile camera */}
        <input 
          ref={fileInputRef}
          type="file" 
          accept="image/*" 
          capture="user"
          onChange={handleFileSelect}
          className="hidden"
        />
        
        <div className="flex-shrink-0 p-4 flex items-center justify-between safe-top">
          <button onClick={() => { stopCamera(); setStep(1); setPhotos([]); }} className="p-2"><Icon name="chevronLeft" /></button>
          <div className="text-center">
            <div className="font-bold">{photos.length + 1}/3</div>
            <div className="text-xs text-slate-500">{labels[photos.length] || 'TamamlandÄ±'}</div>
          </div>
          <div className="w-10" />
        </div>
        
        <div className="flex-shrink-0 px-4 pb-2 flex gap-2">
          {[0, 1, 2].map(i => (
            <div key={i} className={`flex-1 h-1.5 rounded-full ${i < photos.length ? 'bg-brand2' : i === photos.length ? 'bg-accent' : 'bg-slate-200'}`} />
          ))}
        </div>
        
        {/* Camera/Preview Area */}
        <div className="flex-1 relative overflow-hidden" style={{ minHeight: 0 }}>
          {showVideo ? (
            <>
              <video 
                ref={videoRef} 
                autoPlay 
                playsInline 
                muted
                className={`w-full h-full object-cover ${cameraReady ? 'opacity-100' : 'opacity-0'}`}
              />
              {!cameraReady && (
                <div className="absolute inset-0 flex items-center justify-center bg-black">
                  <div className="text-center">
                    <div className="w-12 h-12 border-4 border-brand2 border-t-transparent rounded-full animate-spin mx-auto mb-3" />
                    <p className="text-slate-500 text-sm">Kamera baÅŸlatÄ±lÄ±yor...</p>
                  </div>
                </div>
              )}
              {cameraReady && (
                <>
                  {/* Face guide frame */}
                  <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div className="w-44 h-60 border-2 border-dashed border-white/50 rounded-3xl" />
                  </div>
                  
                  {/* Compact instruction overlay */}
                  <div className="absolute top-3 left-3 right-3 pointer-events-none">
                    <div className="bg-black/60 backdrop-blur-sm rounded-xl p-3 flex items-center gap-3 fade-in" key={photos.length}>
                      <div className="w-10 h-10 rounded-full bg-brand flex items-center justify-center flex-shrink-0 pulse">
                        {currentInstruction.direction === 'front' && <Icon name="user" size={20} />}
                        {currentInstruction.direction === 'right' && <Icon name="chevronRight" size={24} />}
                        {currentInstruction.direction === 'left' && <Icon name="chevronLeft" size={24} />}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="font-semibold text-sm text-white truncate">{currentInstruction.text}</div>
                        <div className="text-slate-400 text-xs truncate">{currentInstruction.subtext}</div>
                      </div>
                      <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center font-bold text-sm text-white">
                        {photos.length + 1}
                      </div>
                    </div>
                  </div>
                  
                  {/* Bottom direction indicator - simplified */}
                  <div className="absolute bottom-3 left-0 right-0 flex justify-center pointer-events-none">
                    <div className="bg-black/60 backdrop-blur-sm rounded-full px-4 py-2 flex items-center gap-2">
                      {photos.length === 0 && <Icon name="user" size={18} className="text-brand2" />}
                      {photos.length === 1 && <div className="animate-bounce-right"><Icon name="chevronRight" size={20} className="text-brand2" /></div>}
                      {photos.length === 2 && <div className="animate-bounce-left"><Icon name="chevronLeft" size={20} className="text-brand2" /></div>}
                      <span className="font-medium text-sm text-white">{currentInstruction.text}</span>
                    </div>
                  </div>
                </>
              )}
            </>
          ) : (
            <div className="w-full h-full flex flex-col items-center justify-center p-6 bg-dark">
              {photos.length > 0 ? (
                <div className="grid grid-cols-3 gap-3 w-full max-w-sm mb-4">
                  {photos.map((p, i) => (
                    <div key={i} className="aspect-square rounded-2xl overflow-hidden border-2 border-brand2">
                      <img src={p} className="w-full h-full object-cover" />
                    </div>
                  ))}
                  {Array(3 - photos.length).fill(0).map((_, i) => (
                    <div key={`e-${i}`} className="aspect-square rounded-2xl border-2 border-dashed border-slate-300 flex items-center justify-center">
                      <Icon name="camera" size={20} className="text-white/20" />
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center mb-6">
                  <div className="w-20 h-20 mx-auto rounded-full bg-brand flex items-center justify-center mb-4">
                    <Icon name="camera" size={36} />
                  </div>
                  <h3 className="font-bold text-lg">{t('takeSelfie')}</h3>
                  <p className="text-slate-500 text-sm mt-1">3 farklÄ± aÃ§Ä±dan fotoÄŸraf Ã§ekin</p>
                </div>
              )}
              
              {/* Animated instruction card for mobile */}
              <div className="glass rounded-2xl p-4 max-w-sm w-full fade-in" key={photos.length}>
                <div className="flex items-center gap-4">
                  <div className="w-14 h-14 rounded-full bg-brand flex items-center justify-center flex-shrink-0 pulse">
                    {currentInstruction.direction === 'front' && <Icon name="user" size={28} />}
                    {currentInstruction.direction === 'right' && <Icon name="chevronRight" size={32} />}
                    {currentInstruction.direction === 'left' && <Icon name="chevronLeft" size={32} />}
                  </div>
                  <div className="flex-1">
                    <div className="font-bold text-lg">{currentInstruction.text}</div>
                    <div className="text-slate-500 text-sm">{currentInstruction.subtext}</div>
                  </div>
                  <div className="w-10 h-10 rounded-full bg-slate-200/60 flex items-center justify-center font-bold text-xl">
                    {photos.length + 1}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Photo thumbnails for video mode */}
        {showVideo && photos.length > 0 && (
          <div className="flex-shrink-0 px-4 py-2 flex gap-2 justify-center">
            {photos.map((p, i) => (
              <div key={i} className="w-12 h-12 rounded-lg overflow-hidden border-2 border-brand2">
                <img src={p} className="w-full h-full object-cover" />
              </div>
            ))}
          </div>
        )}
        
        <div className="flex-shrink-0 p-4 safe-bottom">
          <button 
            onClick={showVideo ? takePhotoFromVideo : openNativeCamera}
            disabled={showVideo && !cameraReady}
            className={`w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 ${
              (showVideo && !cameraReady) ? 'bg-slate-200/60 text-slate-400' : 'btn-primary'
            }`}
          >
            <Icon name="camera" size={20} />
            {(showVideo && !cameraReady) ? 'Kamera Bekleniyor...' : `FotoÄŸraf Ã‡ek (${photos.length + 1}/3)`}
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="h-full flex items-center justify-center p-6">
      <div className="text-center">
        <div className="relative w-24 h-24 mx-auto mb-6">
          <div className="absolute inset-0 rounded-full bg-brand opacity-25 ring-pulse" />
          <div className="relative w-full h-full rounded-full bg-brand flex items-center justify-center">
            <span className="text-4xl">âœ¨</span>
          </div>
        </div>
        <h2 className="text-xl font-black">{t('creating')}</h2>
        <p className="text-slate-500 mt-1">{status}</p>
      </div>
    </div>
  );
};

// ============ PRODUCT CARD ============
const ProductCard = ({ product, onTryOn, onAddToCloset, onAdvice, isInCloset, onAddToCart, isInCart }) => {
  const [loaded, setLoaded] = useState(false);
  const isFeatured = product.brandId === 'modo';
  
  return (
    <div className={`product-card glass rounded-2xl overflow-hidden fade-in ${isFeatured ? 'ring-1 ring-brand2/50' : ''}`}>
      <div className="relative aspect-[3/4] bg-slate-100">
        {!loaded && <div className="absolute inset-0 bg-slate-100 animate-pulse" />}
        <img src={product.image} alt="" crossOrigin="anonymous" className={`w-full h-full object-cover transition-opacity ${loaded ? 'opacity-100' : 'opacity-0'}`}
          onLoad={() => setLoaded(true)} loading="lazy" />
        <div className="absolute top-2 left-2 flex gap-1">
          <div className={`badge px-2 py-1 rounded-lg text-[10px] font-bold ${isFeatured ? 'bg-brand' : ''}`}>{product.brandName}</div>
          {isFeatured && <div className="bg-accent/90 px-1.5 py-1 rounded-lg text-[9px] font-bold">âœ¨</div>}
        </div>
        {isInCloset && <div className="absolute top-2 right-2 bg-green-500/80 p-1.5 rounded-lg"><Icon name="check" size={10} /></div>}
        {isInCart && <div className="absolute top-2 right-2 bg-brand2/80 p-1.5 rounded-lg"><Icon name="shop" size={10} /></div>}
      </div>
      <div className="p-3">
        <div className="text-brand2 font-bold text-sm">{product.priceNum > 0 ? product.price : 'Fiyat Yok'}</div>
        <div className="text-xs text-slate-600 truncate">{product.name}</div>
        {product.description && <div className="text-[10px] text-slate-400 truncate mt-0.5">{product.description}</div>}
        <div className="mt-3 space-y-2">
          <button onClick={() => onTryOn(product)} className="w-full bg-brand hover:bg-brand2 text-white py-2.5 rounded-xl text-xs font-bold flex items-center justify-center gap-1 transition">
            <Icon name="shirt" size={14} />{t('tryOn')}
          </button>
          <div className="grid grid-cols-2 gap-2">
            <button onClick={() => onAddToCloset(product)} disabled={isInCloset}
              className={`py-2 rounded-xl text-xs font-bold flex items-center justify-center gap-1 ${isInCloset ? 'bg-green-500/20 text-green-400' : 'bg-slate-200/60 hover:bg-slate-200'}`}>
              <Icon name={isInCloset ? 'check' : 'hanger'} size={12} />{isInCloset ? t('added') : t('add')}
            </button>
            {onAddToCart && (
              <button 
                onClick={() => onAddToCart(product)}
                className={`py-2 rounded-xl text-xs font-bold flex items-center justify-center gap-1 transition ${isInCart ? 'bg-brand2/20 text-brand2' : 'bg-brand2/10 hover:bg-brand2/20 text-brand2'}`}
              >
                <Icon name="shop" size={12} />{isInCart ? t('inCart') : t('addToCart')}
              </button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// ============ SHOP ============
const Shop = ({ user, closet, onTryOn, onAddToCloset, onAdvice, onAddToCart, cart, onShowCart, onShowSubscription, setTab }) => {
  const [search, setSearch] = useState('');
  const [brand, setBrand] = useState('all');
  
  // Pagination
  const [visibleCount, setVisibleCount] = useState(20);
  const LOAD_MORE_COUNT = 20;
  
  // AÅŸamalÄ± filtreler
  const [genderFilter, setGenderFilter] = useState('all'); // all, male, female, kids
  const [categoryFilter, setCategoryFilter] = useState('all'); // all, top, bottom, outerwear, fullbody
  const [typeFilter, setTypeFilter] = useState('all'); // Pantolon, T-shirt, vs.

  const closetIds = useMemo(() => new Set(closet.map(i => i.id)), [closet]);

  // Alt kategori tipleri
  const subTypes = useMemo(() => {
    const types = {
      top: {
        male: ['T-shirt', 'GÃ¶mlek', 'Kazak', 'Sweatshirt', 'Polo'],
        female: ['T-shirt', 'Bluz', 'GÃ¶mlek', 'Kazak', 'Sweatshirt', 'Crop Top'],
        kids: ['T-shirt', 'Sweatshirt', 'Kazak'],
        all: ['T-shirt', 'GÃ¶mlek', 'Bluz', 'Kazak', 'Sweatshirt', 'Polo', 'Crop Top']
      },
      bottom: {
        male: ['Pantolon', 'Jean', 'EÅŸofman', 'Åžort', 'Kargo'],
        female: ['Pantolon', 'Jean', 'Etek', 'EÅŸofman', 'Åžort', 'Tayt'],
        kids: ['Pantolon', 'Jean', 'EÅŸofman', 'Åžort'],
        all: ['Pantolon', 'Jean', 'EÅŸofman', 'Åžort', 'Etek', 'Tayt', 'Kargo']
      },
      outerwear: {
        male: ['Ceket', 'Mont', 'Blazer', 'HÄ±rka', 'Parka', 'Palto', 'TrenÃ§kot', 'Yelek'],
        female: ['Ceket', 'Mont', 'Blazer', 'HÄ±rka', 'Parka', 'Palto', 'TrenÃ§kot', 'Kaban'],
        kids: ['Ceket', 'Mont', 'HÄ±rka', 'Yelek'],
        all: ['Ceket', 'Mont', 'Blazer', 'HÄ±rka', 'Parka', 'Palto', 'TrenÃ§kot', 'Yelek', 'Kaban']
      },
      fullbody: {
        male: [], // Erkek iÃ§in elbise yok
        female: ['Elbise', 'Tulum', 'TakÄ±m'],
        kids: ['Elbise', 'Tulum'],
        all: ['Elbise', 'Tulum', 'TakÄ±m']
      }
    };
    
    if (categoryFilter === 'all') return [];
    return types[categoryFilter]?.[genderFilter] || types[categoryFilter]?.all || [];
  }, [categoryFilter, genderFilter]);

  // Filtre deÄŸiÅŸtiÄŸinde alt filtreleri sÄ±fÄ±rla
  const handleGenderChange = (value) => {
    setGenderFilter(value);
    setCategoryFilter('all');
    setTypeFilter('all');
  };

  const handleCategoryChange = (value) => {
    setCategoryFilter(value);
    setTypeFilter('all');
  };

  // FiltrelenmiÅŸ Ã¼rÃ¼nler
  const products = useMemo(() => {
    let f = [...ALL_PRODUCTS];
    
    // Cinsiyet filtresi
    if (genderFilter !== 'all') {
      f = f.filter(p => p.gender === genderFilter || p.gender === 'unisex');
    }
    
    // Marka filtresi (check both brandId and generated brandId from brandName)
    if (brand !== 'all') {
      f = f.filter(p => {
        const productBrandId = p.brandId || p.brandName?.toLowerCase().replace(/[^a-z0-9]/g, '_') || 'other';
        return productBrandId === brand;
      });
    }
    
    // Kategori filtresi
    if (categoryFilter !== 'all') {
      f = f.filter(p => p.category === categoryFilter);
    }
    
    // Tip filtresi
    if (typeFilter !== 'all') {
      f = f.filter(p => p.type === typeFilter);
    }
    
    // Arama
    if (search) {
      const q = search.toLowerCase();
      f = f.filter(p => 
        p.name.toLowerCase().includes(q) || 
        p.brandName.toLowerCase().includes(q) || 
        p.type.toLowerCase().includes(q) ||
        p.color?.toLowerCase().includes(q)
      );
    }
    
    return f;
  }, [genderFilter, brand, categoryFilter, typeFilter, search]);

  // Paginated products (only show visibleCount)
  const visibleProducts = useMemo(() => products.slice(0, visibleCount), [products, visibleCount]);
  
  // Reset pagination when filters change
  useEffect(() => {
    setVisibleCount(20);
  }, [genderFilter, brand, categoryFilter, typeFilter, search]);

  // Kategori listesi (erkek iÃ§in elbise gÃ¶sterme)
  const categories = useMemo(() => {
    const base = [
      { v: 'all', lKey: 'all' },
      { v: 'top', lKey: 'topWear' },
      { v: 'bottom', lKey: 'bottomWear' },
      { v: 'outerwear', lKey: 'outerwear' }
    ];
    
    // Erkek filtresi deÄŸilse elbise ekle
    if (genderFilter !== 'male') {
      base.push({ v: 'fullbody', lKey: 'dress' });
    }
    
    return base;
  }, [genderFilter]);

  // Aktif filtre sayÄ±sÄ±
  const activeFilterCount = [
    genderFilter !== 'all',
    categoryFilter !== 'all',
    typeFilter !== 'all',
    brand !== 'all'
  ].filter(Boolean).length;

  // Filtreleri temizle
  const clearFilters = () => {
    setGenderFilter('all');
    setCategoryFilter('all');
    setTypeFilter('all');
    setBrand('all');
    setSearch('');
  };

  return (
    <div className="h-full flex flex-col overflow-hidden">
      {/* Logo & Slogan Header with Cart/Premium */}
      <div className="flex-shrink-0 px-4 pt-2 pb-1 flex items-center justify-between">
        <button 
          onClick={() => {
            // Ana sayfaya (keÅŸfet) git
            if (typeof setTab === 'function') setTab('shop');
          }}
          className="flex items-center gap-2 hover:opacity-80 transition"
        >
          <img src={LOGO_BASE64} alt="TrAi" className="w-8 h-8 rounded-lg shadow-sm" />
          <p className="text-xs font-bold bg-brand bg-clip-text text-transparent">{t('slogan')}</p>
        </button>
        <div className="flex items-center gap-2">
          {/* Universal Credits Display - Gold Coin */}
          <button 
            onClick={onShowSubscription}
            className="flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-amber-100 to-yellow-50 border border-amber-300 hover:from-amber-200 hover:to-yellow-100 transition shadow-sm"
          >
            <span className="text-lg">ðŸª™</span>
            <span className="text-sm font-bold text-amber-700">{(user?.freeAvatarTry || 0) + (user?.freeShopTry || 0) + (user?.freeComboTry || 0) + (user?.credits || 0)}</span>
          </button>
          {/* Cart Button */}
          <button 
            onClick={onShowCart}
            className="relative p-2 rounded-lg bg-slate-100 hover:bg-slate-200 transition"
          >
            <Icon name="shop" size={18} className="text-slate-600" />
            {cart && cart.length > 0 && (
              <span className="absolute -top-1 -right-1 bg-brand2 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center">
                {cart.length}
              </span>
            )}
          </button>
        </div>
      </div>
      
      {/* Search */}
      <div className="p-4 pt-2 pb-2">
        <div className="relative">
          <Icon name="search" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
          <input 
            value={search} 
            onChange={e => setSearch(e.target.value)} 
            placeholder={t('searchPlaceholder')} 
            className="pl-11"
          />
          {search && (
            <button onClick={() => setSearch('')} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
              <Icon name="x" size={16} />
            </button>
          )}
        </div>
      </div>
      
      {/* Featured Banner - DeFacto */}
      {!search && genderFilter === 'all' && categoryFilter === 'all' && (
        <div className="px-4 pb-2">
          <div className="glass rounded-xl p-2.5 bg-brand/10 border border-brand/30">
            <div className="flex items-center justify-between">
              <div>
                <div className="flex items-center gap-1.5 mb-0.5">
                  <span className="text-xs">âœ¨</span>
                  <span className="text-[9px] font-bold text-brand2 uppercase tracking-wide">{t('featuredCollection')}</span>
                </div>
                <h3 className="text-base font-black">DeFacto</h3>
              </div>
              <button 
                onClick={() => setBrand('defacto')} 
                className="btn-primary px-3 py-1.5 rounded-lg text-xs font-bold"
              >
                {t('explore')}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* === AÅžAMALI FÄ°LTRELER === */}
      <div className="px-4 pb-2 space-y-1.5">
        
        {/* 1. AÅžAMA: Cinsiyet Filtresi - Her zaman gÃ¶rÃ¼nÃ¼r */}
        <div className="flex gap-2">
          {[
            { v: 'all', lKey: 'all' },
            { v: 'male', lKey: 'male' },
            { v: 'female', lKey: 'female' }
          ].map(g => (
            <button 
              key={g.v} 
              onClick={() => handleGenderChange(g.v)} 
              className={`flex-1 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all ${
                genderFilter === g.v 
                  ? 'bg-brand text-white shadow-md' 
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
              }`}
            >
              {t(g.lKey)}
            </button>
          ))}
        </div>

        {/* 2. AÅžAMA: Kategori Filtresi (Cinsiyet seÃ§iliyse gÃ¶ster) */}
        {genderFilter !== 'all' && (
          <div className="flex gap-1.5 overflow-x-auto no-scrollbar py-1 fade-in">
            {categories.map(c => (
              <button 
                key={c.v} 
                onClick={() => handleCategoryChange(c.v)} 
                className={`px-3 py-1.5 rounded-lg text-[11px] font-semibold whitespace-nowrap transition-all ${
                  categoryFilter === c.v 
                    ? 'bg-brand2 text-white' 
                    : 'bg-slate-50 text-slate-500 hover:bg-slate-100 border border-slate-200'
                }`}
              >
                {t(c.lKey)}
              </button>
            ))}
          </div>
        )}

        {/* 3. AÅžAMA: Alt Tip Filtresi (Kategori seÃ§iliyse gÃ¶ster) */}
        {categoryFilter !== 'all' && subTypes.length > 0 && (
          <div className="flex gap-1.5 overflow-x-auto no-scrollbar py-1 fade-in">
            <button 
              onClick={() => setTypeFilter('all')} 
              className={`px-2.5 py-1 rounded-lg text-[10px] font-semibold whitespace-nowrap transition-all ${
                typeFilter === 'all' 
                  ? 'bg-accent text-white' 
                  : 'bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200'
              }`}
            >
              {t('all')}
            </button>
            {subTypes.map(st => (
              <button 
                key={st} 
                onClick={() => setTypeFilter(st)} 
                className={`px-2.5 py-1 rounded-lg text-[10px] font-semibold whitespace-nowrap transition-all ${
                  typeFilter === st 
                    ? 'bg-accent text-white' 
                    : 'bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200'
                }`}
              >
                {st}
              </button>
            ))}
          </div>
        )}

        {/* Marka Filtresi - AyrÄ± satÄ±rda, daha kompakt */}
        <div className="flex gap-1.5 overflow-x-auto no-scrollbar">
          <button 
            onClick={() => setBrand('all')} 
            className={`px-2.5 py-1 rounded-full text-[10px] font-bold whitespace-nowrap ${
              brand === 'all' ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-500'
            }`}
          >
            {t('allBrands')}
          </button>
          {BRANDS.slice(0, 10).map(b => (
            <button 
              key={b.id} 
              onClick={() => setBrand(b.id)} 
              className={`px-2.5 py-1 rounded-full text-[10px] font-bold whitespace-nowrap ${
                brand === b.id ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-500'
              }`}
            >
              {b.name}
            </button>
          ))}
        </div>
      </div>

      {/* SonuÃ§ Bilgisi & Temizle */}
      <div className="px-4 pb-2 flex items-center justify-between">
        <p className="text-xs text-slate-500">
          <span className="font-bold text-slate-700">{products.length}</span> {t('products')}
        </p>
        {activeFilterCount > 0 && (
          <button 
            onClick={clearFilters}
            className="text-xs text-brand font-semibold flex items-center gap-1 hover:text-brand2"
          >
            <Icon name="x" size={12} />
            {t('clearFilters')} ({activeFilterCount})
          </button>
        )}
      </div>

      {/* Products Grid */}
      <div className="flex-1 overflow-y-auto custom-scroll p-4 pt-0 pb-4 min-h-0">
        {products.length === 0 ? (
          <div className="text-center py-12">
            <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
              <Icon name="shop" size={28} className="text-slate-400" />
            </div>
            <p className="font-semibold text-slate-500">{t('productNotFound')}</p>
            <p className="text-sm text-slate-400 mt-1">{t('tryDifferentFilters')}</p>
            <button 
              onClick={clearFilters}
              className="mt-4 btn-ghost px-4 py-2 rounded-xl text-sm"
            >
              {t('clearFilters')}
            </button>
          </div>
        ) : (
          <>
            <div className="grid grid-cols-2 gap-3">
              {visibleProducts.map(p => (
                <ProductCard key={p.id} product={p} onTryOn={onTryOn} onAddToCloset={onAddToCloset} onAdvice={onAdvice} isInCloset={closetIds.has(p.id)} onAddToCart={onAddToCart} isInCart={cart?.some(c => c.id === p.id)} />
              ))}
            </div>
            
            {/* Load More Button */}
            {visibleCount < products.length && (
              <div className="mt-6 text-center">
                <button 
                  onClick={() => setVisibleCount(prev => prev + LOAD_MORE_COUNT)}
                  className="btn-primary px-8 py-3 rounded-2xl font-semibold"
                >
                  Daha Fazla GÃ¶ster ({visibleCount}/{products.length})
                </button>
                <p className="text-xs text-slate-400 mt-2">
                  {products.length - visibleCount} Ã¼rÃ¼n daha var
                </p>
              </div>
            )}
            
            {/* All loaded indicator */}
            {visibleCount >= products.length && products.length > 20 && (
              <p className="text-center text-xs text-slate-400 mt-6">
                TÃ¼m Ã¼rÃ¼nler gÃ¶steriliyor ({products.length})
              </p>
            )}
          </>
        )}
      </div>
    </div>
  );
};

// ============ CLOSET ============
const SmartCloset = ({ user, authUser, closet, onRemove, onTryOnResult, setToast, savedCombos, setSavedCombos, favorites, setFavorites, tryHistory, setTryHistory, getBaseAvatar, tryOnCache, setTryOnCache, checkCooldown, setLastTryTime, onShareToFeed, onFirstTryOn, onAddCustomClothing, settings, onShowSubscription, useCredit, refundCredit, onAddToCart, showAvatarPrompt, setShowAvatarPrompt }) => {
  const [tab, setTab] = useState('studio'); // studio, items, upload, combos, favorites, history, weather
  const [selected, setSelected] = useState({ top: null, bottom: null, outerwear: null, fullbody: null });
  const [bg, setBg] = useState(BACKGROUNDS[0]);
  const [loading, setLoading] = useState(false);
  const [comboName, setComboName] = useState('');
  const [showSaveCombo, setShowSaveCombo] = useState(false);
  const [showBackgroundModal, setShowBackgroundModal] = useState(false);
  const [expandedCategory, setExpandedCategory] = useState({ left: null, right: null, bottom: null }); // For collapsible sub-categories
  const [viewMode, setViewMode] = useState('grid');
  const [sortBy, setSortBy] = useState('recent');
  const [showVerifyModal, setShowVerifyModal] = useState(false);
  const [itemsFilter, setItemsFilter] = useState({ gender: 'all', category: 'all', subCategory: null });
  
  // Custom clothing upload state
  const [uploadPhoto, setUploadPhoto] = useState(null);
  const [clothingName, setClothingName] = useState('');
  const [clothingType, setClothingType] = useState('top');
  const [clothingColor, setClothingColor] = useState('');
  const [clothingSubType, setClothingSubType] = useState('');
  const [uploadingClothing, setUploadingClothing] = useState(false);
  const uploadInputRef = React.useRef(null);
  
  // Count user's custom clothes
  const customClothesCount = closet.filter(item => item.isCustom).length;
  const freeClothingSlots = 10;
  const maxCustomClothes = 100;
  const hasExtendedClothingAccess = user?.clothingUploadPurchased || user?.subscription === 'premium';
  const canAddMoreClothes = customClothesCount < freeClothingSlots || hasExtendedClothingAccess;
  
  // Filter closet items for items tab
  const filteredClosetItems = React.useMemo(() => {
    let items = [...closet];
    
    // Gender filter
    if (itemsFilter.gender !== 'all') {
      items = items.filter(item => item.gender === itemsFilter.gender || item.gender === 'unisex');
    }
    
    // Category filter
    if (itemsFilter.category !== 'all') {
      items = items.filter(item => item.category === itemsFilter.category);
    }
    
    // Sub-category filter
    if (itemsFilter.subCategory) {
      items = items.filter(item => item.subType === itemsFilter.subCategory);
    }
    
    // Sort
    if (sortBy === 'recent') {
      items.sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0));
    } else if (sortBy === 'brand') {
      items.sort((a, b) => (a.brand || '').localeCompare(b.brand || ''));
    } else if (sortBy === 'name') {
      items.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
    }
    
    return items;
  }, [closet, itemsFilter, sortBy]);
  
  // Email doÄŸrulama kontrolÃ¼
  const isEmailVerified = authUser?.emailVerified === true;
  
  // Email doÄŸrulama maili gÃ¶nder
  const resendVerificationEmail = async () => {
    if (!auth?.currentUser) return;
    try {
      const actionCodeSettings = {
        url: window.location.origin + '/?verified=true',
        handleCodeInApp: false
      };
      await auth.currentUser.sendEmailVerification(actionCodeSettings);
      setToast({ open: true, type: 'success', title: t('sent'), message: t('verificationEmailSent') });
    } catch (e) {
      if (e.code === 'auth/too-many-requests') {
        setToast({ open: true, type: 'error', title: t('tooManyRequests'), message: t('pleaseWait') });
      } else {
        setToast({ open: true, type: 'error', title: t('error'), message: e.message });
      }
    }
  };
  
  // Weather & Calendar state
  const [weather, setWeather] = useState(null);
  const [weatherLoading, setWeatherLoading] = useState(false);
  const [occasion, setOccasion] = useState(null);

  // Kategorilere ayÄ±r - Kazak/Sweatshirt/HÄ±rka tÃ¼rleri Ã¼st giyime taÅŸÄ±nÄ±yor
  const isTopClothing = (item) => {
    const type = (item.type || '').toLowerCase();
    const subType = (item.subType || '').toLowerCase();
    const name = (item.name || '').toLowerCase();
    
    // Bu tÃ¼rler dÄ±ÅŸ giyim deÄŸil, Ã¼st giyim
    const topTypes = ['kazak', 'sweatshirt', 'sÃ¼veter', 'triko', 'Ã¶rme', 'hÄ±rka', 'kardiÄŸan'];
    return topTypes.some(t => type.includes(t) || subType.includes(t) || name.includes(t));
  };
  
  const isRealOuterwear = (item) => {
    const type = (item.type || '').toLowerCase();
    const subType = (item.subType || '').toLowerCase();
    const name = (item.name || '').toLowerCase();
    
    // GerÃ§ek dÄ±ÅŸ giyim tÃ¼rleri - kazak/hÄ±rka/sweatshirt HARÄ°Ã‡
    const outerwearTypes = ['mont', 'ceket', 'kaban', 'parka', 'trenÃ§kot', 'yaÄŸmurluk', 'palto', 'blazer', 'yelek'];
    const notOuterwear = ['kazak', 'sweatshirt', 'sÃ¼veter', 'triko', 'hÄ±rka', 'kardiÄŸan'];
    
    // Ã–nce dÄ±ÅŸ giyim OLMAYAN tÃ¼rleri kontrol et
    if (notOuterwear.some(t => type.includes(t) || subType.includes(t) || name.includes(t))) {
      return false;
    }
    
    return outerwearTypes.some(t => type.includes(t) || subType.includes(t) || name.includes(t));
  };
  
  // DoÄŸru kategorilere ayÄ±r
  const tops = closet.filter(i => 
    i.category === 'top' || 
    (i.category === 'outerwear' && isTopClothing(i))
  );
  const bottoms = closet.filter(i => i.category === 'bottom');
  const outerwears = closet.filter(i => 
    i.category === 'outerwear' && !isTopClothing(i) && isRealOuterwear(i)
  );
  const fullbodies = closet.filter(i => i.category === 'fullbody');
  
  // Alt kategorilere gÃ¶re grupla
  const groupBySubType = (items, defaultSubs) => {
    const groups = {};
    items.forEach(item => {
      const sub = item.subType || 'DiÄŸer';
      if (!groups[sub]) groups[sub] = [];
      groups[sub].push(item);
    });
    // Ensure default categories exist
    defaultSubs.forEach(s => { if (!groups[s]) groups[s] = []; });
    return groups;
  };
  
  const bottomsGrouped = groupBySubType(bottoms, ['Kot', 'Pantolon', 'Åžort', 'Etek', 'EÅŸofman']);
  const topsGrouped = groupBySubType(tops, ['T-Shirt', 'GÃ¶mlek', 'Kazak', 'Sweatshirt', 'Bluz', 'HÄ±rka']);
  const outerwearGrouped = groupBySubType(outerwears, ['Mont', 'Ceket', 'Kaban', 'Blazer', 'Yelek']);

  // Toggle selection based on category
  const toggle = item => {
    // Fullbody seÃ§ildiÄŸinde top/bottom temizle
    if (item.category === 'fullbody') {
      setSelected({ top: null, bottom: null, outerwear: selected.outerwear, fullbody: selected.fullbody?.id === item.id ? null : item });
    } 
    // Top/bottom seÃ§ildiÄŸinde fullbody temizle
    else if (item.category === 'top' || item.category === 'bottom') {
      setSelected(p => ({ ...p, fullbody: null, [item.category]: p[item.category]?.id === item.id ? null : item }));
    }
    // Outerwear her zaman eklenebilir
    else {
      setSelected(p => ({ ...p, [item.category]: p[item.category]?.id === item.id ? null : item }));
    }
  };

  // Hava durumu al
  const fetchWeather = async () => {
    setWeatherLoading(true);
    try {
      if (!navigator.geolocation) {
        throw new Error('Konum desteÄŸi yok');
      }
      
      const pos = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
      });
      
      const { latitude, longitude } = pos.coords;
      
      // Open-Meteo API (Ã¼cretsiz, API key gerektirmez)
      const res = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto&forecast_days=3`
      );
      const data = await res.json();
      
      // Hava kodu aÃ§Ä±klamasÄ±
      const weatherCodes = {
        0: { icon: 'â˜€ï¸', text: 'AÃ§Ä±k' },
        1: { icon: 'ðŸŒ¤ï¸', text: 'Az Bulutlu' },
        2: { icon: 'â›…', text: 'ParÃ§alÄ± Bulutlu' },
        3: { icon: 'â˜ï¸', text: 'Bulutlu' },
        45: { icon: 'ðŸŒ«ï¸', text: 'Sisli' },
        48: { icon: 'ðŸŒ«ï¸', text: 'YoÄŸun Sis' },
        51: { icon: 'ðŸŒ§ï¸', text: 'Hafif YaÄŸmur' },
        53: { icon: 'ðŸŒ§ï¸', text: 'YaÄŸmurlu' },
        55: { icon: 'ðŸŒ§ï¸', text: 'YoÄŸun YaÄŸmur' },
        61: { icon: 'ðŸŒ§ï¸', text: 'Hafif YaÄŸmur' },
        63: { icon: 'ðŸŒ§ï¸', text: 'YaÄŸmurlu' },
        65: { icon: 'ðŸŒ§ï¸', text: 'Åžiddetli YaÄŸmur' },
        71: { icon: 'ðŸŒ¨ï¸', text: 'Hafif Kar' },
        73: { icon: 'ðŸŒ¨ï¸', text: 'KarlÄ±' },
        75: { icon: 'ðŸŒ¨ï¸', text: 'YoÄŸun Kar' },
        80: { icon: 'ðŸŒ¦ï¸', text: 'SaÄŸanak' },
        95: { icon: 'â›ˆï¸', text: 'FÄ±rtÄ±na' }
      };
      
      const code = data.current.weather_code;
      const weatherInfo = weatherCodes[code] || { icon: 'ðŸŒ¡ï¸', text: 'Belirsiz' };
      
      setWeather({
        temp: Math.round(data.current.temperature_2m),
        icon: weatherInfo.icon,
        text: weatherInfo.text,
        wind: Math.round(data.current.wind_speed_10m),
        daily: data.daily ? data.daily.time.map((date, i) => ({
          date: new Date(date).toLocaleDateString('tr-TR', { weekday: 'short' }),
          max: Math.round(data.daily.temperature_2m_max[i]),
          min: Math.round(data.daily.temperature_2m_min[i]),
          icon: (weatherCodes[data.daily.weather_code[i]] || weatherInfo).icon
        })) : []
      });
    } catch (e) {
      setToast({ open: true, type: 'error', title: 'Hava Durumu', message: 'Konum alÄ±namadÄ±. TarayÄ±cÄ± iznini kontrol edin.' });
    }
    setWeatherLoading(false);
  };

  // Hava durumuna gÃ¶re Ã¶neri
  const getWeatherSuggestion = () => {
    if (!weather) return null;
    const temp = weather.temp;
    if (temp < 5) return { text: 'KalÄ±n mont ve kat kat giyinin', categories: ['outerwear', 'top'] };
    if (temp < 15) return { text: 'Ceket veya hÄ±rka Ã¶nerilir', categories: ['outerwear', 'top', 'bottom'] };
    if (temp < 22) return { text: 'Hafif katman ideal', categories: ['top', 'bottom'] };
    return { text: 'Hafif ve serin kÄ±yafetler', categories: ['top', 'bottom', 'fullbody'] };
  };

  // Etkinlik tÃ¼rleri
  const occasions = [
    { id: 'work', name: 'Ä°ÅŸ', icon: 'ðŸ’¼', suggestion: 'Formal veya smart casual' },
    { id: 'casual', name: 'GÃ¼nlÃ¼k', icon: 'ðŸ‘•', suggestion: 'Rahat ve ÅŸÄ±k' },
    { id: 'date', name: 'Randevu', icon: 'ðŸ’•', suggestion: 'ÅžÄ±k ve dikkat Ã§ekici' },
    { id: 'sport', name: 'Spor', icon: 'ðŸƒ', suggestion: 'Rahat ve esnek' },
    { id: 'party', name: 'Parti', icon: 'ðŸŽ‰', suggestion: 'GÃ¶z alÄ±cÄ± ve eÄŸlenceli' },
    { id: 'wedding', name: 'DÃ¼ÄŸÃ¼n', icon: 'ðŸ’’', suggestion: 'Elegant ve ÅŸÄ±k' }
  ];

  // Unified try-on function: handles all categories
  // Background seÃ§ildikten sonra Ã§aÄŸrÄ±lacak asÄ±l tryOn fonksiyonu
  const executeTryOn = async (selectedBg) => {
    const items = [selected.fullbody, selected.top, selected.bottom, selected.outerwear].filter(Boolean);
    const avatarData = user?.baseAvatar || user?.avatar;
    
    // Create cache key
    const cacheKey = `combo_${items.map(i => i.id).sort().join('_')}_${selectedBg.id}`;
    
    // Check cache first - cache hit doesn't use credit
    if (tryOnCache && tryOnCache[cacheKey]) {
      const cachedResult = tryOnCache[cacheKey];
      const historyItem = { id: Date.now(), image: cachedResult, items, background: selectedBg, createdAt: Date.now() };
      setTryHistory(prev => [historyItem, ...prev].slice(0, 50));
      onTryOnResult(cachedResult, items);
      setToast({ open: true, type: 'success', title: 'HÄ±zlÄ± SonuÃ§ âš¡', message: 'Ã–nceki deneme yÃ¼klendi!' });
      return;
    }
    
    // Kredi kontrolÃ¼ - kombin iÃ§in 'combo' source
    if (useCredit && !useCredit('combo')) {
      return;
    }
    
    if (checkCooldown && !checkCooldown()) return;
    
    setLoading(true);
    if (setLastTryTime) setLastTryTime(Date.now());
    
    // Check if user is Gold (no watermark)
    const isGoldUser = user?.subscription === 'gold' || user?.subscriptionTier === 'gold';
    
    try {
      const baseAvatar = getBaseAvatar ? await getBaseAvatar() : avatarData;
      if (!baseAvatar || !baseAvatar.startsWith('data:image')) {
        throw new Error('Avatar yÃ¼klenemedi');
      }
      
      debugLog('TryOn', `Kombin: ${items.length} Ã¼rÃ¼n, Background: ${selectedBg.id}`, 'info');
      let result = await AI.tryOnCombo(baseAvatar, items, selectedBg.value, { hijab: user?.hijab });
        
      if (!result || !result.startsWith('data:image')) {
        throw new Error("GÃ¶rsel oluÅŸturulamadÄ±");
      }
      
      // Add watermark unless Gold user
      if (!isGoldUser) {
        result = await addWatermark(result, 'TrAi Style');
      }
      
      if (setTryOnCache) {
        setTryOnCache(prev => ({ ...prev, [cacheKey]: result }));
      }
      
      debugLog('TryOn', 'History\'ye ekleniyor...', 'info');
      const historyItem = { id: Date.now(), image: result, items, background: selectedBg, createdAt: Date.now() };
      setTryHistory(prev => {
        const newHistory = [historyItem, ...prev].slice(0, 50);
        // Ä°lk deneme ise analytics consent popup gÃ¶ster
        if (prev.length === 0 && onFirstTryOn) {
          onFirstTryOn();
        }
        return newHistory;
      });
      
      debugLog('TryOn', 'Loading kapatÄ±lÄ±yor...', 'info');
      setLoading(false);
      
      debugLog('TryOn', 'onTryOnResult Ã§aÄŸrÄ±lÄ±yor...', 'info');
      onTryOnResult(result, items);
      
      setSelected({ top: null, bottom: null, outerwear: null, fullbody: null });
      setToast({ open: true, type: 'success', title: t('success'), message: t('tryonSuccess') });
    } catch (err) {
      setLoading(false);
      // Hata durumunda krediyi iade et
      if (refundCredit) {
        refundCredit('combo');
      }
      // refundCredit zaten toast gÃ¶steriyor, ek hata mesajÄ± gÃ¶stermeye gerek yok
    }
  };
  
  const handleTryOn = async () => {
    // Email doÄŸrulama kontrolÃ¼
    if (!isEmailVerified) {
      setShowVerifyModal(true);
      return;
    }
    
    // SeÃ§ili Ã¼rÃ¼nleri topla
    const items = [selected.fullbody, selected.top, selected.bottom, selected.outerwear].filter(Boolean);
    
    if (!items.length) {
      setToast({ open: true, type: 'error', title: 'SeÃ§im yok', message: 'En az bir Ã¼rÃ¼n seÃ§' });
      return;
    }
    
    const avatarData = user?.baseAvatar || user?.avatar;
    if (!avatarData) {
      // Avatar yoksa, prompt modal gÃ¶ster
      if (showAvatarPrompt !== undefined && setShowAvatarPrompt) {
        setShowAvatarPrompt(true);
      } else {
        setToast({ open: true, type: 'error', title: 'Avatar yok', message: 'Ã–nce avatar oluÅŸturmalÄ±sÄ±n' });
      }
      return;
    }
    
    // Background seÃ§im popup'Ä±nÄ± aÃ§
    setShowBackgroundModal(true);
  };

  const saveCombo = () => {
    const items = [selected.fullbody, selected.top, selected.bottom, selected.outerwear].filter(Boolean);
    if (!items.length) return;
    const combo = {
      id: Date.now(),
      name: comboName || `Kombin ${savedCombos.length + 1}`,
      items: items,
      background: bg,
      createdAt: Date.now()
    };
    setSavedCombos(prev => [...prev, combo]);
    setComboName('');
    setShowSaveCombo(false);
    setSelected({ top: null, bottom: null, outerwear: null, fullbody: null });
    setToast({ open: true, type: 'success', title: 'Kaydedildi', message: 'Kombin kaydedildi!' });
  };

  const deleteCombo = (id) => {
    if (confirm('Bu kombini silmek istiyor musun?')) {
      setSavedCombos(prev => prev.filter(c => c.id !== id));
    }
  };

  const toggleFavorite = (item) => {
    const isFav = favorites.some(f => f.id === item.id);
    if (isFav) {
      setFavorites(prev => prev.filter(f => f.id !== item.id));
    } else {
      setFavorites(prev => [...prev, { ...item, favoritedAt: Date.now() }]);
    }
  };

  const isFavorite = (itemId) => favorites.some(f => f.id === itemId);

  const sortedCloset = useMemo(() => {
    let sorted = [...closet];
    if (sortBy === 'recent') sorted.sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0));
    if (sortBy === 'brand') sorted.sort((a, b) => a.brandName.localeCompare(b.brandName));
    if (sortBy === 'color') sorted.sort((a, b) => a.color.localeCompare(b.color));
    return sorted;
  }, [closet, sortBy]);

  const tabs = [
    { id: 'studio', icon: 'sparkles', label: t('studioTab') || 'StÃ¼dyo', count: 0 },
    { id: 'items', icon: 'hanger', label: t('productsTab'), count: closet.length },
    { id: 'upload', icon: 'plus', label: t('addClothing'), count: customClothesCount },
    { id: 'video', icon: 'film', label: 'Video', count: user?.videoTokens || 0 },
    { id: 'weather', icon: 'sun', label: t('weatherTab'), count: 0 },
    { id: 'combos', icon: 'layers', label: t('combosTab'), count: savedCombos.length },
    { id: 'favorites', icon: 'heart', label: t('favoritesTab'), count: favorites.length }
  ];

  if (!closet.length && tab === 'items') {
    return (
      <div className="h-full flex flex-col">
        {/* Tab Navigation */}
        <div className="flex-shrink-0 px-4 py-3 border-b border-slate-200">
          <div className="flex gap-1 bg-slate-100 rounded-2xl p-1">
            {tabs.map(t => (
              <button
                key={t.id}
                onClick={() => setTab(t.id)}
                className={`flex-1 py-2 px-0.5 rounded-xl text-[10px] font-semibold flex flex-col items-center justify-center gap-0.5 transition ${
                  tab === t.id ? 'bg-brand text-white' : 'text-slate-500 hover:text-slate-600'
                }`}
              >
                <Icon name={t.icon} size={16} />
                <span className="truncate max-w-full">{t.label}</span>
                {t.count > 0 && <span className="bg-slate-200 px-1 py-0 rounded-full text-[8px]">{t.count}</span>}
              </button>
            ))}
          </div>
        </div>
        <div className="flex-1 flex items-center justify-center p-6">
          <div className="text-center">
            <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
              <Icon name="hanger" size={32} className="text-slate-400" />
            </div>
            <p className="text-slate-500 font-bold">{t('closetEmpty')}</p>
            <p className="text-slate-400 text-sm mt-1">{t('addFromShop')}</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="h-full flex flex-col">
      {/* Tab Navigation */}
      <div className="flex-shrink-0 px-4 py-2 border-b border-slate-200 safe-top">
        <div className="flex gap-1 bg-slate-100 rounded-2xl p-1">
          {tabs.map(t => (
            <button
              key={t.id}
              onClick={() => setTab(t.id)}
              className={`relative flex-1 py-2 px-0.5 rounded-xl text-[10px] font-semibold flex flex-col items-center justify-center gap-0.5 transition ${
                tab === t.id ? 'bg-brand text-white' : 'text-slate-500 hover:text-slate-600'
              }`}
            >
              <Icon name={t.icon} size={16} />
              <span className="truncate max-w-full">{t.label}</span>
              {t.count > 0 && <span className={`px-1 py-0 rounded-full text-[8px] ${tab === t.id ? 'bg-white/20' : 'bg-slate-200'}`}>{t.count}</span>}
            </button>
          ))}
        </div>
      </div>

      {/* STUDIO TAB - Drag & Drop Interface */}
      {tab === 'studio' && (
        <div className="flex-1 overflow-hidden flex flex-col">
          {/* Studio Header */}
          <div className="flex-shrink-0 px-4 py-3 border-b border-slate-100">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="font-bold text-lg">{t('studioTitle') || 'Kombin StÃ¼dyosu'}</h2>
                <p className="text-xs text-slate-500">{t('studioDesc') || 'ParÃ§alarÄ± sÃ¼rÃ¼kleyip bÄ±rakarak kombin oluÅŸtur'}</p>
              </div>
              {(selected.top || selected.bottom || selected.outerwear || selected.fullbody) && (
                <button
                  onClick={() => setSelected({ top: null, bottom: null, outerwear: null, fullbody: null })}
                  className="text-xs text-slate-500 hover:text-slate-700 px-3 py-1.5 rounded-lg bg-slate-100"
                >
                  {t('clearAll') || 'Temizle'}
                </button>
              )}
            </div>
          </div>

          {/* Main Studio Area */}
          <div className="flex-1 flex overflow-hidden">
            {/* Left Panel - Bottoms */}
            <div className="w-32 lg:w-36 flex-shrink-0 border-r border-slate-100 overflow-y-auto custom-scroll bg-slate-50/50">
              <p className="text-[10px] font-bold text-slate-400 py-2 text-center sticky top-0 bg-slate-50/95 backdrop-blur-sm border-b border-slate-100">ðŸ‘– ALT</p>
              <div className="p-1.5 space-y-1">
                {Object.entries(bottomsGrouped).filter(([_, items]) => items.length > 0).map(([subType, items]) => (
                  <div key={subType} className="border-b border-slate-100 last:border-0">
                    <button 
                      onClick={() => setExpandedCategory(p => ({ ...p, left: p.left === subType ? null : subType }))}
                      className={`w-full text-left px-2 py-1.5 rounded-lg text-[10px] font-semibold flex items-center justify-between transition ${
                        expandedCategory.left === subType ? 'bg-brand/10 text-brand' : 'text-slate-600 hover:bg-slate-100'
                      }`}
                    >
                      <span>{subType}</span>
                      <span className={`text-[9px] px-1.5 py-0.5 rounded-full ${expandedCategory.left === subType ? 'bg-brand text-white' : 'bg-slate-200'}`}>
                        {items.length}
                      </span>
                    </button>
                    {expandedCategory.left === subType && (
                      <div className="grid grid-cols-2 gap-1 p-1 pb-2">
                        {items.map(item => (
                          <div
                            key={item.id}
                            draggable
                            onDragStart={(e) => {
                              e.dataTransfer.setData('item', JSON.stringify(item));
                              e.dataTransfer.effectAllowed = 'copy';
                            }}
                            onClick={() => toggle(item)}
                            className={`draggable-item aspect-square rounded-lg overflow-hidden border-2 transition-all cursor-pointer ${
                              selected.bottom?.id === item.id 
                                ? 'border-brand ring-2 ring-brand/30 scale-95' 
                                : 'border-transparent hover:border-slate-300'
                            }`}
                          >
                            <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                ))}
                {bottoms.length === 0 && (
                  <div className="text-center py-4">
                    <Icon name="hanger" size={20} className="text-slate-300 mx-auto mb-1" />
                    <p className="text-[10px] text-slate-400">BoÅŸ</p>
                  </div>
                )}
              </div>
            </div>

            {/* Center - Avatar Drop Zone */}
            <div className="flex-1 flex flex-col items-center justify-center p-2 relative">
              {/* Avatar Area - Full height avatar display */}
              <div 
                className={`relative w-40 h-64 lg:w-48 lg:h-72 rounded-2xl overflow-hidden drop-zone ${
                  loading ? 'opacity-50' : ''
                }`}
                style={{ background: 'linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%)' }}
                onDragOver={(e) => {
                  e.preventDefault();
                  e.currentTarget.classList.add('drag-over');
                }}
                onDragLeave={(e) => {
                  e.currentTarget.classList.remove('drag-over');
                }}
                onDrop={(e) => {
                  e.preventDefault();
                  e.currentTarget.classList.remove('drag-over');
                  try {
                    const item = JSON.parse(e.dataTransfer.getData('item'));
                    toggle(item);
                  } catch (err) {}
                }}
              >
                {/* Base Avatar - object-cover with top alignment for better fit */}
                {(user?.baseAvatar || user?.avatar) ? (
                  <img src={user?.baseAvatar || user?.avatar} className="w-full h-full object-cover object-top" />
                ) : (
                  <div className="w-full h-full flex items-center justify-center bg-slate-100">
                    <Icon name="user" size={48} className="text-slate-300" />
                  </div>
                )}

                {/* Selected Items Overlay */}
                {(selected.top || selected.bottom || selected.outerwear || selected.fullbody) && (
                  <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                    <div className="text-center text-white">
                      <Icon name="check" size={32} className="mx-auto mb-2" />
                      <p className="text-xs font-bold">
                        {[selected.top, selected.bottom, selected.outerwear, selected.fullbody].filter(Boolean).length} parÃ§a seÃ§ili
                      </p>
                    </div>
                  </div>
                )}

                {/* Loading Spinner */}
                {loading && (
                  <div className="absolute inset-0 flex items-center justify-center bg-white/80">
                    <div className="w-10 h-10 border-4 border-brand border-t-transparent rounded-full animate-spin" />
                  </div>
                )}
              </div>

              {/* Selected Items Preview */}
              <div className="flex gap-2 mt-4 items-center justify-center flex-wrap">
                {selected.top && (
                  <div className="item-added relative">
                    <img src={selected.top.image} className="w-12 h-12 rounded-lg object-cover ring-2 ring-brand" />
                    <button onClick={() => setSelected(s => ({...s, top: null}))} className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
                      <Icon name="x" size={10} className="text-white" />
                    </button>
                    <span className="absolute -bottom-1 left-1/2 -translate-x-1/2 text-[8px] bg-brand text-white px-1 rounded">ÃœST</span>
                  </div>
                )}
                {selected.bottom && (
                  <div className="item-added relative">
                    <img src={selected.bottom.image} className="w-12 h-12 rounded-lg object-cover ring-2 ring-amber-500" />
                    <button onClick={() => setSelected(s => ({...s, bottom: null}))} className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
                      <Icon name="x" size={10} className="text-white" />
                    </button>
                    <span className="absolute -bottom-1 left-1/2 -translate-x-1/2 text-[8px] bg-amber-500 text-white px-1 rounded">ALT</span>
                  </div>
                )}
                {selected.outerwear && (
                  <div className="item-added relative">
                    <img src={selected.outerwear.image} className="w-12 h-12 rounded-lg object-cover ring-2 ring-blue-500" />
                    <button onClick={() => setSelected(s => ({...s, outerwear: null}))} className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
                      <Icon name="x" size={10} className="text-white" />
                    </button>
                    <span className="absolute -bottom-1 left-1/2 -translate-x-1/2 text-[8px] bg-blue-500 text-white px-1 rounded">DIÅž</span>
                  </div>
                )}
                {selected.fullbody && (
                  <div className="item-added relative">
                    <img src={selected.fullbody.image} className="w-12 h-12 rounded-lg object-cover ring-2 ring-brand" />
                    <button onClick={() => setSelected(s => ({...s, fullbody: null}))} className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
                      <Icon name="x" size={10} className="text-white" />
                    </button>
                    <span className="absolute -bottom-1 left-1/2 -translate-x-1/2 text-[8px] bg-brand text-white px-1 rounded">ELBÄ°SE</span>
                  </div>
                )}
              </div>

              {/* Try On Button */}
              {(selected.top || selected.bottom || selected.outerwear || selected.fullbody) && (
                <button
                  onClick={handleTryOn}
                  disabled={loading || !isEmailVerified}
                  className="mt-4 btn-primary px-8 py-3 rounded-xl font-bold flex items-center gap-2 disabled:opacity-50"
                >
                  {loading ? (
                    <>
                      <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                      {t('trying')}
                    </>
                  ) : (
                    <>
                      <Icon name="sparkles" size={18} />
                      {t('tryCombo') || 'Kombini Dene'}
                    </>
                  )}
                </button>
              )}
              
              {/* Email DoÄŸrulama UyarÄ±sÄ± - Sadece doÄŸrulanmamÄ±ÅŸ kullanÄ±cÄ±lara */}
              {!isEmailVerified && (
                <div className="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-xl max-w-xs">
                  <div className="flex items-start gap-2">
                    <div className="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0">
                      <Icon name="mail" size={16} className="text-amber-600" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-xs font-semibold text-amber-800">
                        {t('emailVerificationRequired') || 'E-posta DoÄŸrulamasÄ± Gerekli'}
                      </p>
                      <p className="text-[11px] text-amber-700 mt-0.5">
                        {t('emailVerificationForCombo') || 'Kombinleri denemek iÃ§in e-posta adresinizi doÄŸrulamanÄ±z gerekiyor.'}
                      </p>
                      <div className="flex gap-2 mt-2 flex-wrap">
                        <button
                          onClick={async () => {
                            try {
                              if (firebase?.auth?.().currentUser) {
                                await firebase.auth().currentUser.sendEmailVerification();
                                setToast({ open: true, type: 'success', title: 'ðŸ“§ GÃ¶nderildi', message: 'E-posta kutunuzu kontrol edin' });
                              }
                            } catch (e) {
                              if (e.code === 'auth/too-many-requests') {
                                setToast({ open: true, type: 'warning', title: 'Ã‡ok Fazla Deneme', message: 'LÃ¼tfen biraz bekleyin' });
                              } else {
                                setToast({ open: true, type: 'error', title: 'Hata', message: e.message });
                              }
                            }
                          }}
                          className="text-[10px] font-bold text-amber-700 hover:text-amber-900 underline"
                        >
                          E-posta GÃ¶nder
                        </button>
                        <span className="text-amber-400">|</span>
                        <button
                          onClick={async () => {
                            if (auth?.currentUser) {
                              try {
                                await auth.currentUser.reload();
                                if (auth.currentUser.emailVerified) {
                                  setAuthUser(prev => ({ ...prev, emailVerified: true }));
                                  setToast({ open: true, type: 'success', title: 'âœ… DoÄŸrulandÄ±!', message: 'ArtÄ±k kombinleri deneyebilirsiniz' });
                                } else {
                                  setToast({ open: true, type: 'info', title: 'HenÃ¼z DoÄŸrulanmadÄ±', message: 'E-postadaki linke tÄ±klayÄ±n' });
                                }
                              } catch (e) {
                                console.error('Email check error:', e);
                              }
                            }
                          }}
                          className="text-[10px] font-bold text-amber-700 hover:text-amber-900 underline"
                        >
                          DoÄŸruladÄ±m âœ“
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Right Panel - Tops */}
            <div className="w-32 lg:w-36 flex-shrink-0 border-l border-slate-100 overflow-y-auto custom-scroll bg-slate-50/50">
              <p className="text-[10px] font-bold text-slate-400 py-2 text-center sticky top-0 bg-slate-50/95 backdrop-blur-sm border-b border-slate-100">ðŸ‘• ÃœST</p>
              <div className="p-1.5 space-y-1">
                {Object.entries(topsGrouped).filter(([_, items]) => items.length > 0).map(([subType, items]) => (
                  <div key={subType} className="border-b border-slate-100 last:border-0">
                    <button 
                      onClick={() => setExpandedCategory(p => ({ ...p, right: p.right === subType ? null : subType }))}
                      className={`w-full text-left px-2 py-1.5 rounded-lg text-[10px] font-semibold flex items-center justify-between transition ${
                        expandedCategory.right === subType ? 'bg-brand2/10 text-brand2' : 'text-slate-600 hover:bg-slate-100'
                      }`}
                    >
                      <span>{subType}</span>
                      <span className={`text-[9px] px-1.5 py-0.5 rounded-full ${expandedCategory.right === subType ? 'bg-brand2 text-white' : 'bg-slate-200'}`}>
                        {items.length}
                      </span>
                    </button>
                    {expandedCategory.right === subType && (
                      <div className="grid grid-cols-2 gap-1 p-1 pb-2">
                        {items.map(item => (
                          <div
                            key={item.id}
                            draggable
                            onDragStart={(e) => {
                              e.dataTransfer.setData('item', JSON.stringify(item));
                              e.dataTransfer.effectAllowed = 'copy';
                            }}
                            onClick={() => toggle(item)}
                            className={`draggable-item aspect-square rounded-lg overflow-hidden border-2 transition-all cursor-pointer ${
                              selected.top?.id === item.id 
                                ? 'border-brand2 ring-2 ring-brand2/30 scale-95' 
                                : 'border-transparent hover:border-slate-300'
                            }`}
                          >
                            <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                ))}
                {tops.length === 0 && (
                  <div className="text-center py-4">
                    <Icon name="shirt" size={20} className="text-slate-300 mx-auto mb-1" />
                    <p className="text-[10px] text-slate-400">BoÅŸ</p>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Bottom - Outerwear & Dresses/Fullbody */}
          {(outerwears.length > 0 || fullbodies.length > 0) && (
            <div className="flex-shrink-0 border-t border-slate-100 p-2 bg-slate-50/50">
              <div className="flex gap-6 justify-center flex-wrap">
                {/* Outerwear - grouped by subType */}
                {outerwears.length > 0 && (
                  <div>
                    <p className="text-[10px] font-bold text-slate-400 mb-2 text-center">ðŸ§¥ DIÅž GÄ°YÄ°M ({outerwears.length})</p>
                    <div className="flex gap-1 mb-2 justify-center flex-wrap">
                      {Object.entries(outerwearGrouped).filter(([_, items]) => items.length > 0).map(([subType, _]) => (
                        <button
                          key={subType}
                          onClick={() => setExpandedCategory(p => ({ ...p, bottom: p.bottom === subType ? null : subType }))}
                          className={`px-2 py-1 rounded-full text-[9px] font-medium transition ${
                            expandedCategory.bottom === subType ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-600'
                          }`}
                        >
                          {subType}
                        </button>
                      ))}
                    </div>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar justify-center">
                      {(expandedCategory.bottom ? outerwearGrouped[expandedCategory.bottom] || [] : outerwears).map(item => (
                        <div
                          key={item.id}
                          draggable
                          onDragStart={(e) => {
                            e.dataTransfer.setData('item', JSON.stringify(item));
                            e.dataTransfer.effectAllowed = 'copy';
                          }}
                          onClick={() => toggle(item)}
                          className={`draggable-item flex-shrink-0 w-20 h-20 rounded-xl overflow-hidden border-2 transition-all cursor-pointer ${
                            selected.outerwear?.id === item.id 
                              ? 'border-blue-500 ring-2 ring-blue-500/30 scale-95' 
                              : 'border-transparent hover:border-slate-300'
                          }`}
                        >
                          <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                {/* Fullbody/Dresses */}
                {fullbodies.length > 0 && (
                  <div>
                    <p className="text-[10px] font-bold text-slate-400 mb-2 text-center">ðŸ‘— ELBÄ°SE & TULUM ({fullbodies.length})</p>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar justify-center">
                      {fullbodies.map(item => (
                        <div
                          key={item.id}
                          draggable
                          onDragStart={(e) => {
                            e.dataTransfer.setData('item', JSON.stringify(item));
                            e.dataTransfer.effectAllowed = 'copy';
                          }}
                          onClick={() => toggle(item)}
                          className={`draggable-item flex-shrink-0 w-20 h-20 rounded-xl overflow-hidden border-2 transition-all cursor-pointer ${
                            selected.fullbody?.id === item.id 
                              ? 'border-brand ring-2 ring-brand/30 scale-95' 
                              : 'border-transparent hover:border-slate-300'
                          }`}
                        >
                          <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      )}

      {/* ITEMS TAB */}
      {tab === 'items' && (
        <>
          {/* Filter Controls - Shop style */}
          <div className="flex-shrink-0 px-4 py-3 space-y-3 border-b border-slate-100">
            {/* Gender Filter */}
            <div className="flex gap-2 overflow-x-auto no-scrollbar">
              {[
                { id: 'all', label: t('all') },
                { id: 'male', label: t('male') },
                { id: 'female', label: t('female') }
              ].map(g => (
                <button 
                  key={g.id} 
                  onClick={() => setItemsFilter(p => ({...p, gender: g.id}))}
                  className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition ${
                    (itemsFilter?.gender || 'all') === g.id ? 'bg-brand text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                  }`}
                >
                  {g.label}
                </button>
              ))}
            </div>
            
            {/* Category Filter */}
            <div className="flex gap-2 overflow-x-auto no-scrollbar">
              {[
                { id: 'all', label: t('all'), icon: 'grid' },
                { id: 'top', label: t('topWear'), icon: 'shirt' },
                { id: 'bottom', label: t('bottomWear'), icon: 'hanger' },
                { id: 'outerwear', label: t('outerwear'), icon: 'shirt' },
                { id: 'fullbody', label: t('dress'), icon: 'hanger' }
              ].map(c => (
                <button 
                  key={c.id} 
                  onClick={() => setItemsFilter(p => ({...p, category: c.id}))}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition ${
                    (itemsFilter?.category || 'all') === c.id ? 'bg-brand2 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                  }`}
                >
                  <Icon name={c.icon} size={12} />
                  {c.label}
                </button>
              ))}
            </div>
            
            {/* Sub-category Filter (if top selected) */}
            {itemsFilter?.category === 'top' && (
              <div className="flex gap-2 overflow-x-auto no-scrollbar">
                {['TÃ¼mÃ¼', 'T-Shirt', 'GÃ¶mlek', 'Kazak', 'Bluz', 'Sweatshirt', 'HÄ±rka'].map(sub => (
                  <button 
                    key={sub} 
                    onClick={() => setItemsFilter(p => ({...p, subCategory: sub === 'TÃ¼mÃ¼' ? null : sub}))}
                    className={`px-3 py-1 rounded-full text-[11px] font-medium whitespace-nowrap transition ${
                      (itemsFilter?.subCategory || null) === (sub === 'TÃ¼mÃ¼' ? null : sub) ? 'bg-slate-700 text-white' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'
                    }`}
                  >
                    {sub}
                  </button>
                ))}
              </div>
            )}
            
            {/* Sub-category Filter (if bottom selected) */}
            {itemsFilter?.category === 'bottom' && (
              <div className="flex gap-2 overflow-x-auto no-scrollbar">
                {['TÃ¼mÃ¼', 'Pantolon', 'Kot', 'Åžort', 'Etek', 'EÅŸofman'].map(sub => (
                  <button 
                    key={sub} 
                    onClick={() => setItemsFilter(p => ({...p, subCategory: sub === 'TÃ¼mÃ¼' ? null : sub}))}
                    className={`px-3 py-1 rounded-full text-[11px] font-medium whitespace-nowrap transition ${
                      (itemsFilter?.subCategory || null) === (sub === 'TÃ¼mÃ¼' ? null : sub) ? 'bg-slate-700 text-white' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'
                    }`}
                  >
                    {sub}
                  </button>
                ))}
              </div>
            )}
            
            {/* View & Sort */}
            <div className="flex items-center justify-between">
              <p className="text-xs text-slate-500">{filteredClosetItems.length} {t('products')}</p>
              <div className="flex gap-2">
                <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="bg-slate-100 border-0 text-xs py-1.5 px-3 rounded-lg">
                  <option value="recent">{t('recentSort')}</option>
                  <option value="brand">{t('brandSort')}</option>
                  <option value="name">Ä°sim</option>
                </select>
                <div className="flex gap-1 bg-slate-100 rounded-lg p-1">
                  <button onClick={() => setViewMode('grid')} className={`p-1.5 rounded ${viewMode === 'grid' ? 'bg-white shadow-sm' : ''}`}>
                    <Icon name="grid" size={14} />
                  </button>
                  <button onClick={() => setViewMode('list')} className={`p-1.5 rounded ${viewMode === 'list' ? 'bg-white shadow-sm' : ''}`}>
                    <Icon name="list" size={14} />
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* Items Grid/List */}
          <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-8">
            {filteredClosetItems.length === 0 ? (
              <div className="text-center py-12">
                <Icon name="hanger" size={48} className="text-slate-300 mx-auto mb-4" />
                <p className="text-slate-500">{t('noItemsFound') || 'ÃœrÃ¼n bulunamadÄ±'}</p>
              </div>
            ) : (
              <div className={viewMode === 'grid' ? 'grid grid-cols-3 gap-3' : 'space-y-2'}>
                {filteredClosetItems.map(item => (
                  <div key={item.id} className={`relative group ${viewMode === 'list' ? 'glass rounded-xl p-3 flex items-center gap-3' : ''}`}>
                    <div className={`${viewMode === 'grid' ? 'aspect-[3/4] w-full' : 'w-16 h-20 flex-shrink-0'} rounded-xl overflow-hidden bg-slate-100`}>
                      <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" loading="lazy" />
                      {item.isCustom && (
                        <div className="absolute top-1 left-1 bg-amber-400 text-[8px] text-white px-1.5 py-0.5 rounded font-bold">
                          {t('myClothes')}
                        </div>
                      )}
                    </div>
                    {viewMode === 'grid' && (
                      <div className="mt-1.5">
                        <p className="text-xs font-medium truncate">{item.name}</p>
                        <p className="text-[10px] text-slate-500 truncate">{item.brand || item.subType || ''}</p>
                      </div>
                    )}
                    {viewMode === 'list' && (
                      <div className="flex-1 min-w-0">
                        <p className="font-semibold text-sm truncate">{item.name}</p>
                        <p className="text-xs text-slate-500">{item.brand || t('myClothes')}</p>
                        {item.subType && <span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full">{item.subType}</span>}
                      </div>
                    )}
                    <div className={`${viewMode === 'grid' ? 'absolute top-1 right-1 opacity-0 group-hover:opacity-100' : ''} flex gap-1 transition`}>
                      <button onClick={() => toggleFavorite(item)} className="p-1.5 rounded-lg bg-white/80 hover:bg-white shadow-sm">
                        <Icon name={isFavorite(item.id) ? 'heartFilled' : 'heart'} size={12} className={isFavorite(item.id) ? 'text-red-400' : 'text-slate-400'} />
                      </button>
                      <button onClick={() => onRemove(item.id)} className="p-1.5 rounded-lg bg-white/80 hover:bg-red-50 shadow-sm">
                        <Icon name="trash" size={12} className="text-slate-400 hover:text-red-500" />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </>
      )}


      {/* WEATHER TAB */}
      {tab === 'weather' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {/* Weather Card */}
          <div className="glass rounded-2xl p-4 mb-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-bold flex items-center gap-2">
                <Icon name="sun" size={18} className="text-yellow-400" />
                Hava Durumu
              </h3>
              <button 
                onClick={fetchWeather} 
                disabled={weatherLoading}
                className="px-3 py-1.5 bg-slate-200/60 rounded-lg text-xs font-semibold flex items-center gap-1"
              >
                {weatherLoading ? (
                  <><div className="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin" /> YÃ¼kleniyor</>
                ) : (
                  <><Icon name="mapPin" size={12} /> Konumdan Al</>
                )}
              </button>
            </div>
            
            {weather ? (
              <div>
                <div className="flex items-center gap-4 mb-4">
                  <span className="text-5xl">{weather.icon}</span>
                  <div>
                    <p className="text-3xl font-bold">{weather.temp}Â°C</p>
                    <p className="text-slate-500">{weather.text}</p>
                    <p className="text-xs text-slate-400">RÃ¼zgar: {weather.wind} km/s</p>
                  </div>
                </div>
                
                {/* 3 GÃ¼nlÃ¼k Tahmin */}
                {weather.daily?.length > 0 && (
                  <div className="grid grid-cols-3 gap-2 mt-4 pt-4 border-t border-slate-200">
                    {weather.daily.map((day, i) => (
                      <div key={i} className="text-center bg-slate-100 rounded-xl p-2">
                        <p className="text-xs text-slate-500">{day.date}</p>
                        <span className="text-xl">{day.icon}</span>
                        <p className="text-xs"><span className="text-slate-700">{day.max}Â°</span> <span className="text-slate-400">{day.min}Â°</span></p>
                      </div>
                    ))}
                  </div>
                )}
                
                {/* KÄ±yafet Ã–nerisi */}
                {getWeatherSuggestion() && (
                  <div className="mt-4 p-3 bg-brand/10 rounded-xl">
                    <p className="text-sm font-semibold flex items-center gap-2">
                      <Icon name="sparkles" size={14} className="text-brand2" />
                      {getWeatherSuggestion().text}
                    </p>
                  </div>
                )}
              </div>
            ) : (
              <div className="text-center py-6">
                <span className="text-4xl">ðŸŒ¡ï¸</span>
                <p className="text-sm text-slate-500 mt-2">{t('shareWeather')}</p>
              </div>
            )}
          </div>

          {/* Occasion Selection */}
          <div className="glass rounded-2xl p-4">
            <h3 className="font-bold mb-3 flex items-center gap-2">
              <Icon name="calendar" size={18} className="text-accent" />
              BugÃ¼n Ne YapÄ±yorsun?
            </h3>
            <div className="grid grid-cols-3 gap-2">
              {occasions.map(occ => (
                <button 
                  key={occ.id}
                  onClick={() => setOccasion(occasion?.id === occ.id ? null : occ)}
                  className={`p-3 rounded-xl text-center transition ${occasion?.id === occ.id ? 'bg-amber-200 ring-1 ring-accent' : 'bg-slate-100 hover:bg-slate-200/60'}`}
                >
                  <span className="text-2xl block mb-1">{occ.icon}</span>
                  <p className="text-xs font-semibold">{occ.name}</p>
                </button>
              ))}
            </div>
            
            {occasion && (
              <div className="mt-4 p-3 bg-amber-100 rounded-xl">
                <p className="text-sm">
                  <span className="font-semibold">{occasion.name}</span> iÃ§in Ã¶neri: {occasion.suggestion}
                </p>
              </div>
            )}
          </div>

          {/* Quick Suggestion */}
          {(weather || occasion) && (
            <div className="mt-4">
              <button 
                onClick={() => setTab('items')}
                className="w-full btn-primary py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
              >
                <Icon name="sparkles" size={16} />
                KÄ±yafet SeÃ§meye Git
              </button>
            </div>
          )}
        </div>
      )}

      {/* COMBOS TAB */}
      {tab === 'combos' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {savedCombos.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                <Icon name="layers" size={28} className="text-slate-400" />
              </div>
              <p className="font-semibold text-slate-500">{t('noSavedCombos')}</p>
              <p className="text-sm text-slate-400 mt-1">{t('createComboHint')}</p>
            </div>
          ) : (
            <div className="space-y-3">
              {savedCombos.map(combo => (
                <div key={combo.id} className="glass rounded-2xl p-4">
                  <div className="flex items-start justify-between mb-3">
                    <div>
                      <h4 className="font-semibold">{combo.name}</h4>
                      <p className="text-xs text-slate-500">
                        {new Date(combo.createdAt).toLocaleDateString(currentLanguage === 'tr' ? 'tr-TR' : 'en-US')} {combo.background?.id ? `â€¢ ${t(combo.background.id) || combo.background.label || 'StÃ¼dyo'}` : ''}
                      </p>
                    </div>
                    <button onClick={() => deleteCombo(combo.id)} className="p-2 rounded-xl hover:bg-red-500/20">
                      <Icon name="trash" size={16} className="text-red-400" />
                    </button>
                  </div>
                  
                  {/* Kombin gÃ¶rseli varsa gÃ¶ster */}
                  {combo.image && (
                    <div 
                      className="relative w-full aspect-[3/4] rounded-xl overflow-hidden mb-3 cursor-pointer group"
                      onClick={() => onTryOnResult(combo.image, combo.items || [])}
                    >
                      <img src={combo.image} crossOrigin="anonymous" className="w-full h-full object-cover" loading="lazy" />
                      <div className="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition flex items-center justify-center">
                        <div className="opacity-0 group-hover:opacity-100 bg-white/90 rounded-full p-3 transition">
                          <Icon name="eye" size={24} className="text-slate-700" />
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Kombin gÃ¶rseli yoksa sadece Ã¼rÃ¼n gÃ¶rselleri */}
                  {!combo.image && (
                    <div className="flex gap-2 mb-3">
                      {(combo.items || []).map((item, i) => (
                        <div key={i} className="w-16 h-16 rounded-xl overflow-hidden border border-slate-200">
                          <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" loading="lazy" />
                        </div>
                      ))}
                    </div>
                  )}
                  
                  <div className="flex gap-2">
                    <button 
                      onClick={() => {
                        // EÄŸer kombin gÃ¶rseli varsa, direkt result modal'Ä±nda gÃ¶ster
                        if (combo.image) {
                          onTryOnResult(combo.image, combo.items || []);
                        } else {
                          // GÃ¶rsel yoksa, Ã¼rÃ¼nleri seÃ§ili yap ve items sekmesine git
                          const top = (combo.items || []).find(i => i.category === 'top');
                          const bottom = (combo.items || []).find(i => i.category === 'bottom');
                          const outerwear = (combo.items || []).find(i => i.category === 'outerwear');
                          const fullbody = (combo.items || []).find(i => i.category === 'fullbody');
                          setSelected({ 
                            top: top || null, 
                            bottom: bottom || null,
                            outerwear: outerwear || null,
                            fullbody: fullbody || null
                          });
                          if (combo.background) setBg(combo.background);
                          setTab('studio');
                        }
                      }}
                      className={`flex-1 py-2.5 rounded-xl text-sm font-semibold flex items-center justify-center gap-2 ${
                        combo.image 
                          ? 'btn-primary' 
                          : 'btn-secondary'
                      }`}
                    >
                      <Icon name={combo.image ? 'eye' : 'sparkles'} size={14} />
                      {combo.image ? 'GÃ¶ster' : 'Dene'}
                    </button>
                    {onAddToCart && (combo.items || []).length > 0 && (
                      <button 
                        onClick={() => {
                          if (window.addMultipleToCart) {
                            window.addMultipleToCart(combo.items || []);
                          } else {
                            (combo.items || []).forEach(item => onAddToCart(item));
                          }
                        }}
                        className="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-2.5 rounded-xl text-sm font-semibold flex items-center justify-center gap-2"
                      >
                        <Icon name="shop" size={14} />Sepet
                      </button>
                    )}
                  </div>
                  {/* Share buttons */}
                  <div className="flex gap-2 mt-2">
                    {combo.image && (
                      <>
                        <button 
                          onClick={() => {
                            if (onShareToFeed) {
                              onShareToFeed({ image: combo.image, items: combo.items });
                            }
                          }}
                          className="flex-1 glass py-2 rounded-xl text-xs font-medium flex items-center justify-center gap-1.5 hover:bg-slate-200/60"
                        >
                          <Icon name="globe" size={12} />AkÄ±ÅŸta PaylaÅŸ
                        </button>
                        <button 
                          onClick={async () => {
                            // External share with Firebase upload
                            if (combo.image && window.uploadAndShareImage) {
                              const result = await window.uploadAndShareImage(combo.image, authUser, window.storage);
                              if (result?.copied) {
                                setToast({ open: true, type: 'success', title: 'Link KopyalandÄ±!', message: 'PaylaÅŸÄ±m linki panoya kopyalandÄ±' });
                              }
                            } else {
                              await shareImage(combo.image);
                            }
                          }}
                          className="flex-1 glass py-2 rounded-xl text-xs font-medium flex items-center justify-center gap-1.5 hover:bg-slate-200/60"
                        >
                          <Icon name="share" size={12} />Harici
                        </button>
                        <button 
                          onClick={() => {
                            if (window.openDMShareModal) {
                              window.openDMShareModal(combo.image, combo.items);
                            }
                          }}
                          className="flex-1 glass py-2 rounded-xl text-xs font-medium flex items-center justify-center gap-1.5 hover:bg-slate-200/60"
                        >
                          <Icon name="mail" size={12} />DM
                        </button>
                      </>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* FAVORITES TAB */}
      {tab === 'favorites' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {favorites.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                <Icon name="heart" size={28} className="text-slate-400" />
              </div>
              <p className="font-semibold text-slate-500">{t('noFavorites')}</p>
              <p className="text-sm text-slate-400 mt-1">{t('addToFavorites')}</p>
            </div>
          ) : (
            <div className="grid grid-cols-2 gap-3">
              {favorites.map(item => (
                <div key={item.id} className="glass rounded-2xl overflow-hidden">
                  <div className="aspect-square relative">
                    <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" loading="lazy" />
                    <button 
                      onClick={() => toggleFavorite(item)}
                      className="absolute top-2 right-2 p-2 rounded-xl bg-slate-900/40"
                    >
                      <Icon name="heartFilled" size={16} className="text-red-400" />
                    </button>
                  </div>
                  <div className="p-3">
                    <p className="text-xs text-slate-500">{item.brandName}</p>
                    <p className="font-semibold text-sm truncate">{item.name}</p>
                    <p className="text-brand2 text-sm font-bold mb-2">{item.price}</p>
                    {onAddToCart && (
                      <button 
                        onClick={() => onAddToCart(item)}
                        className="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 rounded-xl text-xs font-semibold flex items-center justify-center gap-1"
                      >
                        <Icon name="shop" size={12} />Sepete Ekle
                      </button>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* HISTORY TAB */}
      {tab === 'history' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {tryHistory.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                <Icon name="clock" size={28} className="text-slate-400" />
              </div>
              <p className="font-semibold text-slate-500">{t('historyEmpty')}</p>
              <p className="text-sm text-slate-400 mt-1">{t('historyHint')}</p>
            </div>
          ) : (
            <div className="space-y-3">
              {tryHistory.map(item => (
                <div key={item.id} className="glass rounded-2xl overflow-hidden">
                  <div 
                    className="aspect-[3/4] relative cursor-pointer"
                    onClick={() => {
                      // GÃ¶rseli tam ekran modal'da gÃ¶ster
                      onTryOnResult(item.image, item.items || []);
                    }}
                  >
                    <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" loading="lazy" />
                    <div className="absolute top-2 right-2 bg-black/50 rounded-lg px-2 py-1">
                      <Icon name="eye" size={14} className="text-white" />
                    </div>
                    <div className="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-slate-900/50 to-transparent">
                      <p className="text-xs text-slate-600">
                        {new Date(item.createdAt).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}
                      </p>
                      <div className="flex gap-1 mt-1">
                        {item.items.map((it, i) => (
                          <span key={i} className="text-[10px] bg-slate-200 px-2 py-0.5 rounded-full">{it.brandName}</span>
                        ))}
                      </div>
                    </div>
                  </div>
                  <div className="p-3 flex gap-2">
                    <button 
                      onClick={() => {
                        if (onShareToFeed) {
                          onShareToFeed(item.image, item.items || []);
                          setToast({ open: true, type: 'success', title: 'PaylaÅŸÄ±ldÄ±!', message: 'Sosyal akÄ±ÅŸta yayÄ±nlandÄ±' });
                        }
                      }}
                      className="flex-1 btn-primary py-2 rounded-xl text-xs font-semibold flex items-center justify-center gap-1"
                    >
                      <Icon name="users" size={12} />TrAi'de
                    </button>
                    <button 
                      onClick={() => shareImage(item.image)}
                      className="flex-1 btn-secondary py-2 rounded-xl text-xs font-semibold flex items-center justify-center gap-1"
                    >
                      <Icon name="share" size={12} />Harici
                    </button>
                    <button 
                      onClick={() => {
                        setTryHistory(prev => prev.filter(h => h.id !== item.id));
                      }}
                      className="px-3 rounded-xl bg-red-500/20 hover:bg-red-500/30"
                    >
                      <Icon name="trash" size={14} className="text-red-400" />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* UPLOAD TAB - Custom Clothing */}
      {tab === 'upload' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {/* Hidden file input */}
          <input 
            ref={uploadInputRef}
            type="file" 
            accept="image/*" 
            capture="environment"
            onChange={(e) => {
              const file = e.target.files?.[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = (ev) => {
                // Compress image
                const img = new Image();
                img.onload = () => {
                  const canvas = document.createElement('canvas');
                  const maxSize = 800;
                  let width = img.width;
                  let height = img.height;
                  if (width > height) {
                    if (width > maxSize) { height = Math.round((height * maxSize) / width); width = maxSize; }
                  } else {
                    if (height > maxSize) { width = Math.round((width * maxSize) / height); height = maxSize; }
                  }
                  canvas.width = width;
                  canvas.height = height;
                  const ctx = canvas.getContext('2d');
                  ctx.drawImage(img, 0, 0, width, height);
                  setUploadPhoto(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = ev.target.result;
              };
              reader.readAsDataURL(file);
              e.target.value = '';
            }}
            className="hidden"
          />
          
          {/* Slots Info & Upgrade */}
          <div className="glass rounded-2xl p-4 mb-4">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-brand/10 flex items-center justify-center">
                  <Icon name="hanger" size={20} className="text-brand" />
                </div>
                <div>
                  <p className="text-xs text-slate-500">{t('remainingSlots')}</p>
                  <p className="font-bold">
                    {hasExtendedClothingAccess 
                      ? `${maxCustomClothes - customClothesCount} / ${maxCustomClothes}`
                      : `${Math.max(0, freeClothingSlots - customClothesCount)} / ${freeClothingSlots} (Ãœcretsiz)`
                    }
                  </p>
                </div>
              </div>
              <span className="text-xs text-slate-400">{customClothesCount} {t('myClothesCount')}</span>
            </div>
            
            {/* Show upgrade option if using free slots */}
            {!hasExtendedClothingAccess && (
              <div className="bg-gradient-to-r from-brand/5 to-brand2/5 rounded-xl p-3 border border-brand/10">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs font-semibold text-slate-700">ðŸ“¦ 100 KÄ±yafet Paketi</p>
                    <p className="text-[10px] text-slate-500">DolabÄ±nda daha fazla yer aÃ§</p>
                  </div>
                  <button 
                    onClick={() => onShowSubscription && onShowSubscription('clothingUpload')}
                    className="px-4 py-2 bg-brand text-white text-xs font-bold rounded-lg"
                  >
                    99â‚º
                  </button>
                </div>
              </div>
            )}
          </div>
          
          {/* Check if can add more clothes */}
          {!canAddMoreClothes ? (
            <div className="text-center py-8">
              <div className="w-20 h-20 mx-auto rounded-full bg-amber-100 flex items-center justify-center mb-4">
                <Icon name="lock" size={40} className="text-amber-500" />
              </div>
              <h3 className="text-xl font-bold mb-2">Ãœcretsiz HakkÄ±nÄ±z Doldu</h3>
              <p className="text-slate-500 text-sm mb-6">10 Ã¼cretsiz kÄ±yafet hakkÄ±nÄ±zÄ± kullandÄ±nÄ±z. Daha fazla eklemek iÃ§in paketi satÄ±n alÄ±n.</p>
              
              <div className="glass rounded-2xl p-6 max-w-sm mx-auto mb-6">
                <div className="text-3xl font-black text-brand mb-2">99â‚º</div>
                <p className="text-sm text-slate-500 mb-4">{t('oneTimePurchase')}</p>
                
                <div className="space-y-2 text-left mb-6">
                  <div className="flex items-center gap-2 text-sm">
                    <Icon name="check" size={16} className="text-green-500" />
                    <span>Toplam 100 kÄ±yafet hakkÄ±</span>
                  </div>
                  <div className="flex items-center gap-2 text-sm">
                    <Icon name="check" size={16} className="text-green-500" />
                    <span>{t('clothingUploadDesc')}</span>
                  </div>
                </div>
                
                <button 
                  onClick={() => onShowSubscription && onShowSubscription('clothingUpload')}
                  className="w-full btn-primary py-3 rounded-xl font-bold"
                >
                  {t('buyNow')} - 99â‚º
                </button>
              </div>
              
              {/* Still show existing custom clothes */}
              {customClothesCount > 0 && (
                <div className="mt-6 text-left">
                  <h3 className="font-bold mb-3 flex items-center gap-2">
                    <Icon name="hanger" size={18} />
                    {t('myClothes')} ({customClothesCount})
                  </h3>
                  <div className="grid grid-cols-3 gap-2">
                    {closet.filter(item => item.isCustom).map(item => (
                      <div key={item.id} className="relative aspect-[3/4] rounded-xl overflow-hidden glass">
                        <img src={item.image} className="w-full h-full object-cover" />
                        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-2">
                          <p className="text-white text-xs font-medium truncate">{item.name}</p>
                        </div>
                        <button 
                          onClick={() => onRemove(item.id)}
                          className="absolute top-1 right-1 p-1.5 bg-red-500/80 text-white rounded-full"
                        >
                          <Icon name="x" size={12} />
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          ) : (
            <>
              {/* Upload Form */}
              <div className="glass rounded-2xl p-4 mb-4">
                <h3 className="font-bold mb-4 flex items-center gap-2">
                  <Icon name="camera" size={18} />
                  {t('clothingUploadTitle')}
                </h3>
                
                {/* Photo Instructions */}
                <div className="bg-amber-50 rounded-xl p-3 mb-4">
                  <p className="text-xs font-semibold text-amber-700 mb-2">{t('clothingUploadInstructions')}</p>
                  <ul className="text-xs text-amber-600 space-y-1">
                    <li>â€¢ {t('clothingInstruction1')}</li>
                    <li>â€¢ {t('clothingInstruction2')}</li>
                    <li>â€¢ {t('clothingInstruction3')}</li>
                    <li>â€¢ {t('clothingInstruction4')}</li>
                    <li>â€¢ {t('clothingInstruction5')}</li>
                  </ul>
                </div>
                
                {/* Photo Upload Area */}
                <div 
                  onClick={() => uploadInputRef.current?.click()}
                  className={`relative aspect-square rounded-xl border-2 border-dashed mb-4 flex items-center justify-center cursor-pointer transition ${
                    uploadPhoto ? 'border-brand bg-brand/5' : 'border-slate-300 hover:border-brand hover:bg-slate-50'
                  }`}
                >
                  {uploadPhoto ? (
                    <>
                      <img src={uploadPhoto} className="w-full h-full object-contain rounded-xl" />
                      <button 
                        onClick={(e) => { e.stopPropagation(); setUploadPhoto(null); }}
                        className="absolute top-2 right-2 p-2 bg-red-500 text-white rounded-full"
                      >
                        <Icon name="x" size={16} />
                      </button>
                    </>
                  ) : (
                    <div className="text-center p-6">
                      <Icon name="camera" size={48} className="text-slate-300 mx-auto mb-3" />
                      <p className="text-sm text-slate-500">{t('uploadPhoto')} / {t('takePhoto')}</p>
                    </div>
                  )}
                </div>
                
                {/* Clothing Type */}
                <div className="mb-4">
                  <label className="text-xs font-semibold text-slate-500 mb-2 block">{t('selectClothingType')}</label>
                  <div className="grid grid-cols-4 gap-2">
                    {[
                      { id: 'top', label: t('topLabel'), icon: 'shirt' },
                      { id: 'bottom', label: t('bottomLabel'), icon: 'hanger' },
                      { id: 'outerwear', label: t('outerwearLabel'), icon: 'shirt' },
                      { id: 'fullbody', label: t('dressLabel'), icon: 'hanger' }
                    ].map(type => (
                      <button
                        key={type.id}
                        onClick={() => { setClothingType(type.id); setClothingSubType(''); }}
                        className={`p-2 rounded-xl text-xs font-medium transition ${
                          clothingType === type.id 
                            ? 'bg-brand text-white' 
                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                        }`}
                      >
                        {type.label}
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* Sub-Type based on category */}
                <div className="mb-4">
                  <label className="text-xs font-semibold text-slate-500 mb-2 block">Alt Kategori</label>
                  <div className="flex gap-2 flex-wrap">
                    {(clothingType === 'top' ? ['T-Shirt', 'GÃ¶mlek', 'Kazak', 'Bluz', 'Sweatshirt', 'HÄ±rka', 'Polo'] :
                      clothingType === 'bottom' ? ['Pantolon', 'Kot', 'Åžort', 'Etek', 'EÅŸofman', 'Tayt'] :
                      clothingType === 'outerwear' ? ['Mont', 'Ceket', 'Kaban', 'YaÄŸmurluk', 'Yelek', 'TrenÃ§kot'] :
                      ['Elbise', 'Tulum', 'TakÄ±m']
                    ).map(sub => (
                      <button
                        key={sub}
                        onClick={() => setClothingSubType(sub)}
                        className={`px-3 py-1.5 rounded-full text-xs font-medium transition ${
                          clothingSubType === sub 
                            ? 'bg-brand2 text-white' 
                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                        }`}
                      >
                        {sub}
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* Clothing Name */}
                <div className="mb-4">
                  <label className="text-xs font-semibold text-slate-500 mb-2 block">{t('clothingName')}</label>
                  <input 
                    value={clothingName}
                    onChange={(e) => setClothingName(e.target.value)}
                    placeholder={t('clothingNamePlaceholder')}
                    className="w-full"
                  />
                </div>
                
                {/* Color */}
                <div className="mb-4">
                  <label className="text-xs font-semibold text-slate-500 mb-2 block">{t('clothingColor')}</label>
                  <div className="flex gap-2 flex-wrap">
                    {['Siyah', 'Beyaz', 'Gri', 'Lacivert', 'Mavi', 'KÄ±rmÄ±zÄ±', 'YeÅŸil', 'Kahve', 'Bej', 'Pembe'].map(color => (
                      <button
                        key={color}
                        onClick={() => setClothingColor(color)}
                        className={`px-3 py-1.5 rounded-full text-xs font-medium transition ${
                          clothingColor === color 
                            ? 'bg-brand text-white' 
                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                        }`}
                      >
                        {color}
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* Submit Button */}
                <button 
                  onClick={async () => {
                    if (!uploadPhoto) {
                      setToast({ open: true, type: 'error', title: t('error'), message: 'FotoÄŸraf yÃ¼kleyin' });
                      return;
                    }
                    if (!clothingName.trim()) {
                      setToast({ open: true, type: 'error', title: t('error'), message: 'KÄ±yafet adÄ± girin' });
                      return;
                    }
                    if (customClothesCount >= maxCustomClothes) {
                      setToast({ open: true, type: 'error', title: t('limitReached'), message: t('limitReachedDesc') });
                      return;
                    }
                    
                    setUploadingClothing(true);
                    try {
                      const newItem = {
                        id: `custom_${Date.now()}`,
                        name: clothingName.trim(),
                        brand: t('myClothes'),
                        category: clothingType,
                        subType: clothingSubType || null,
                        image: uploadPhoto,
                        color: clothingColor || 'BelirtilmemiÅŸ',
                        gender: user?.gender || 'unisex',
                        isCustom: true,
                        addedAt: Date.now()
                      };
                      
                      if (onAddCustomClothing) {
                        await onAddCustomClothing(newItem);
                      }
                      
                      setToast({ open: true, type: 'success', title: t('clothingAdded'), message: t('clothingAddedDesc') });
                      setUploadPhoto(null);
                      setClothingName('');
                      setClothingColor('');
                      setClothingSubType('');
                    } catch (e) {
                      setToast({ open: true, type: 'error', title: t('error'), message: e.message });
                    }
                    setUploadingClothing(false);
                  }}
                  disabled={!uploadPhoto || !clothingName.trim() || uploadingClothing}
                  className="w-full btn-primary py-3 rounded-xl font-bold disabled:opacity-50"
                >
                  {uploadingClothing ? (
                    <span className="flex items-center justify-center gap-2">
                      <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                      {t('processing')}
                    </span>
                  ) : (
                    <span className="flex items-center justify-center gap-2">
                      <Icon name="plus" size={18} />
                      {t('addToMyCloset')}
                    </span>
                  )}
                </button>
              </div>
            </>
          )}
        </div>
      )}

      {/* VIDEO TAB */}
      {tab === 'video' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {/* Coming Soon Banner */}
          <div className="text-center py-12">
            <div className="w-24 h-24 rounded-3xl bg-gradient-to-br from-brand to-purple-600 flex items-center justify-center mx-auto mb-6 shadow-lg">
              <Icon name="film" size={48} className="text-white" />
            </div>
            <h2 className="text-2xl font-bold mb-2">Video Deneme</h2>
            <p className="text-slate-500 mb-6">6 saniyelik moda videolarÄ± oluÅŸtur</p>
            
            <div className="glass rounded-2xl p-6 max-w-sm mx-auto mb-6">
              <div className="flex items-center justify-center gap-2 mb-4">
                <span className="text-3xl">ðŸš€</span>
                <span className="text-xl font-bold text-brand">Ã‡ok YakÄ±nda!</span>
              </div>
              <p className="text-sm text-slate-600">
                Video deneme Ã¶zelliÄŸi ÅŸu anda geliÅŸtirme aÅŸamasÄ±nda. 
                KÄ±sa sÃ¼re iÃ§inde kombinlerinizi videoya dÃ¶nÃ¼ÅŸtÃ¼rebileceksiniz!
              </p>
            </div>
            
            <div className="space-y-3 max-w-sm mx-auto">
              <div className="flex items-center gap-3 p-3 rounded-xl bg-slate-50">
                <div className="w-10 h-10 rounded-xl bg-brand/10 flex items-center justify-center">
                  <Icon name="sparkles" size={20} className="text-brand" />
                </div>
                <div className="text-left">
                  <p className="font-semibold text-sm">AI ile Video OluÅŸturma</p>
                  <p className="text-xs text-slate-500">Kombinlerini canlandÄ±r</p>
                </div>
              </div>
              <div className="flex items-center gap-3 p-3 rounded-xl bg-slate-50">
                <div className="w-10 h-10 rounded-xl bg-brand/10 flex items-center justify-center">
                  <Icon name="share" size={20} className="text-brand" />
                </div>
                <div className="text-left">
                  <p className="font-semibold text-sm">Sosyal Medya PaylaÅŸÄ±mÄ±</p>
                  <p className="text-xs text-slate-500">TikTok, Instagram Reels</p>
                </div>
              </div>
              <div className="flex items-center gap-3 p-3 rounded-xl bg-slate-50">
                <div className="w-10 h-10 rounded-xl bg-brand/10 flex items-center justify-center">
                  <Icon name="heart" size={20} className="text-brand" />
                </div>
                <div className="text-left">
                  <p className="font-semibold text-sm">GerÃ§ekÃ§i Hareketler</p>
                  <p className="text-xs text-slate-500">YÃ¼rÃ¼yÃ¼ÅŸ, dÃ¶nÃ¼ÅŸ animasyonlarÄ±</p>
                </div>
              </div>
            </div>
            
            <button 
              onClick={() => setTab('studio')}
              className="mt-8 px-6 py-3 rounded-xl bg-brand text-white font-semibold"
            >
              Åžimdilik GÃ¶rsel Dene
            </button>
          </div>
        </div>
      )}
      {loading && <FullscreenLoader 
        title={[selected.fullbody, selected.top, selected.bottom, selected.outerwear].filter(Boolean).length > 1 ? "Kombin HazÄ±rlanÄ±yor" : "Deneme HazÄ±rlanÄ±yor"} 
        subtitle="AI gÃ¶rsel oluÅŸturuyor..." 
      />}
      
      {/* Email Verification Modal */}
      {showVerifyModal && (
        <div className="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4 fade-in">
          <div className="glass rounded-3xl p-6 max-w-sm w-full scale-in">
            <div className="text-center">
              <div className="w-20 h-20 mx-auto rounded-full bg-brand flex items-center justify-center mb-4">
                <Icon name="mail" size={36} />
              </div>
              <h3 className="text-xl font-bold mb-2">{t('emailVerificationRequired')}</h3>
              <p className="text-slate-500 text-sm mb-6">
                Sanal deneme Ã¶zelliÄŸini kullanabilmek iÃ§in e-posta adresinizi doÄŸrulamanÄ±z gerekiyor.
              </p>
              
              <div className="bg-slate-100 rounded-xl p-4 mb-6">
                <p className="text-sm text-slate-600 mb-2">E-posta adresiniz:</p>
                <p className="font-semibold text-brand2">{authUser?.email}</p>
              </div>
              
              <div className="space-y-3">
                <button 
                  onClick={() => { resendVerificationEmail(); }}
                  className="w-full btn-primary py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                >
                  <Icon name="mail" size={18} />
                  {t('sendVerificationEmail')}
                </button>
                <button 
                  onClick={async () => { 
                    // Email doÄŸrulama durumunu sayfa yenilemeden kontrol et
                    if (auth?.currentUser) {
                      try {
                        await auth.currentUser.reload();
                        if (auth.currentUser.emailVerified) {
                          // State'i gÃ¼ncelle - sayfa yenilemesine gerek yok
                          setAuthUser(prev => ({ ...prev, emailVerified: true }));
                          setShowVerifyModal(false);
                          setToast({ open: true, type: 'success', title: 'âœ… E-posta DoÄŸrulandÄ±!', message: 'ArtÄ±k tÃ¼m Ã¶zellikleri kullanabilirsiniz' });
                        } else {
                          setToast({ open: true, type: 'info', title: t('notVerifiedYet'), message: t('clickLinkAndRetry') });
                        }
                      } catch (e) {
                        console.error('Email verification check error:', e);
                      }
                    }
                  }}
                  className="w-full btn-secondary py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                >
                  <Icon name="refresh" size={18} />
                  DoÄŸruladÄ±m, Kontrol Et
                </button>
                <button 
                  onClick={() => setShowVerifyModal(false)}
                  className="w-full text-slate-500 py-2 text-sm"
                >
                  Daha Sonra
                </button>
              </div>
              
              <p className="text-xs text-slate-400 mt-4">
                E-posta gelmediyse spam klasÃ¶rÃ¼nÃ¼ kontrol edin
              </p>
            </div>
          </div>
        </div>
      )}
      
      {/* Background Selection Modal - Compact */}
      {showBackgroundModal && (
        <div className="fixed inset-0 z-[100] bg-black/80 flex items-end justify-center fade-in" onClick={() => setShowBackgroundModal(false)}>
          <div className="glass rounded-t-2xl p-4 w-full max-w-lg scale-in" onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-bold text-sm">{t('whereWillYouWear') || 'Ortam SeÃ§'}</h3>
              <button onClick={() => setShowBackgroundModal(false)} className="p-1">
                <Icon name="x" size={18} />
              </button>
            </div>
            
            <div className="grid grid-cols-4 gap-2">
              {BACKGROUNDS.map(b => (
                <button
                  key={b.id}
                  onClick={() => {
                    setBg(b);
                    setShowBackgroundModal(false);
                    executeTryOn(b);
                  }}
                  className="group relative aspect-square rounded-lg overflow-hidden border-2 border-transparent hover:border-brand transition"
                >
                  <div 
                    className="absolute inset-0"
                    style={{ 
                      background: b.value.includes('gradient') || b.value.includes('#') 
                        ? b.value 
                        : `url('${b.preview || ''}') center/cover, ${b.value}`
                    }}
                  />
                  <div className="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent" />
                  <div className="absolute bottom-1 left-1 right-1">
                    <p className="text-white text-[9px] font-medium truncate">{t(b.id)}</p>
                  </div>
                </button>
              ))}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ============ PROFILE (EXPANDED) ============
const Profile = ({ user, authUser, onResetAvatar, onLogout, onDeleteAccount, friends, setFriends, messages, setMessages, settings, setSettings, onUpdateUser, onUpdateProfilePhoto, changeLanguage, followRequests, setFollowRequests, sentFollowRequests, setSentFollowRequests, notifications, setNotifications, dmChats, setDmChats, selectedChat, setSelectedChat, groups, setGroups, setMainTab }) => {
  const [tab, setTab] = useState('profile'); // profile, avatar, friends, notifications, settings, messages
  const [showAddFriend, setShowAddFriend] = useState(false);
  const profilePhotoRef = useRef(null);
  
  // OkunmamÄ±ÅŸ bildirim sayÄ±sÄ±
  const unreadNotificationsCount = notifications.filter(n => !n.read).length;
  
  // Bildirimi okundu olarak iÅŸaretle
  const markNotificationAsRead = (notificationId) => {
    setNotifications(prev => prev.map(n => 
      n.id === notificationId ? { ...n, read: true } : n
    ));
    // Firebase'e kaydet
    if (db && authUser?.uid) {
      db.collection('users').doc(authUser.uid).collection('notifications').doc(String(notificationId)).update({ read: true }).catch(() => {});
    }
  };
  
  // TÃ¼m bildirimleri okundu iÅŸaretle
  const markAllNotificationsAsRead = () => {
    setNotifications(prev => prev.map(n => ({ ...n, read: true })));
    // Firebase'e kaydet
    if (db && authUser?.uid) {
      notifications.forEach(n => {
        if (!n.read) {
          db.collection('users').doc(authUser.uid).collection('notifications').doc(String(n.id)).update({ read: true }).catch(() => {});
        }
      });
    }
  };
  
  // Bildirime tÄ±klandÄ±ÄŸÄ±nda yÃ¶nlendirme
  const handleNotificationClick = (notification) => {
    markNotificationAsRead(notification.id);
    
    switch (notification.type) {
      case 'follow_request':
        setTab('friends');
        break;
      case 'follow_accept':
        setTab('friends');
        break;
      case 'new_message':
        setTab('messages');
        // Ä°lgili chat'i aÃ§
        if (notification.chatId) {
          const chat = dmChats.find(c => c.id === notification.chatId);
          if (chat) setSelectedChat({ type: 'dm', ...chat });
        }
        break;
      case 'group_invite':
        setTab('messages');
        if (notification.groupId && groups) {
          const group = groups.find(g => g.id === notification.groupId);
          if (group) setSelectedChat({ type: 'group', ...group });
        }
        break;
      case 'like':
      case 'comment':
        // Sosyal sekmesine yÃ¶nlendir
        if (setMainTab) setMainTab('social');
        break;
      case 'weather':
      case 'daily_outfit':
        // Ana sayfaya yÃ¶nlendir
        if (setMainTab) setMainTab('shop');
        break;
      default:
        break;
    }
  };
  
  // Profil fotoÄŸrafÄ± seÃ§
  const handleProfilePhotoSelect = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    // Max 2MB
    if (file.size > 2 * 1024 * 1024) {
      alert('Dosya boyutu 2MB\'dan kÃ¼Ã§Ã¼k olmalÄ±');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (ev) => {
      // Resize image to 200x200
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const size = 200;
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        // Crop to square from center
        const minDim = Math.min(img.width, img.height);
        const sx = (img.width - minDim) / 2;
        const sy = (img.height - minDim) / 2;
        
        ctx.drawImage(img, sx, sy, minDim, minDim, 0, 0, size, size);
        const resized = canvas.toDataURL('image/jpeg', 0.85);
        
        if (onUpdateProfilePhoto) {
          onUpdateProfilePhoto(resized);
        }
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
    e.target.value = '';
  };
  
  // Email doÄŸrulama gÃ¶nder
  const resendVerification = async () => {
    if (!auth?.currentUser) return;
    try {
      const actionCodeSettings = {
        url: window.location.origin + '/?verified=true',
        handleCodeInApp: false
      };
      await auth.currentUser.sendEmailVerification(actionCodeSettings);
      alert('DoÄŸrulama e-postasÄ± gÃ¶nderildi!');
    } catch (e) {
      alert('Hata: ' + e.message);
    }
  };
  const [friendUsername, setFriendUsername] = useState('');
  const [friendSearchResult, setFriendSearchResult] = useState({ searching: false, found: null, error: null });
  const [newMessage, setNewMessage] = useState('');
  const [showEditParams, setShowEditParams] = useState(false);
  const [editParams, setEditParams] = useState({});
  const [showNewChat, setShowNewChat] = useState(false);
  const [showCreateGroup, setShowCreateGroup] = useState(false);
  const [groupName, setGroupName] = useState('');
  const [selectedGroupMembers, setSelectedGroupMembers] = useState([]);

  // Search friend by username
  const searchFriendByUsername = async (username) => {
    if (!username || username.length < 3) {
      setFriendSearchResult({ searching: false, found: null, error: null });
      return;
    }
    
    setFriendSearchResult({ searching: true, found: null, error: null });
    
    try {
      if (db) {
        // Search by username (case-insensitive)
        const snapshot = await db.collection('users')
          .where('usernameLower', '==', username.toLowerCase())
          .limit(1)
          .get();
        
        if (!snapshot.empty) {
          const doc = snapshot.docs[0];
          const data = doc.data();
          
          // Check if it's the current user
          if (doc.id === authUser?.uid) {
            setFriendSearchResult({ searching: false, found: null, error: 'Kendini takip edemezsin' });
            return;
          }
          
          // Check if already following
          if (friends.some(f => f.id === doc.id || f.uid === doc.id)) {
            setFriendSearchResult({ searching: false, found: null, error: 'Bu kullanÄ±cÄ±yÄ± zaten takip ediyorsun' });
            return;
          }
          
          setFriendSearchResult({
            searching: false,
            found: {
              uid: doc.id,
              username: data.username,
              displayName: data.displayName,
              profilePhoto: data.profilePhoto,
              baseAvatarStorageUrl: data.baseAvatarStorageUrl
            },
            error: null
          });
        } else {
          setFriendSearchResult({ searching: false, found: null, error: 'KullanÄ±cÄ± bulunamadÄ±' });
        }
      } else {
        setFriendSearchResult({ searching: false, found: null, error: 'VeritabanÄ± baÄŸlantÄ±sÄ± yok' });
      }
    } catch (e) {
      console.error('Friend search error:', e);
      setFriendSearchResult({ searching: false, found: null, error: 'Arama baÅŸarÄ±sÄ±z' });
    }
  };

  // Debounced friend search
  useEffect(() => {
    const timer = setTimeout(() => {
      searchFriendByUsername(friendUsername);
    }, 500);
    return () => clearTimeout(timer);
  }, [friendUsername]);

  // Open edit modal with current values
  const openEditParams = () => {
    setEditParams({
      gender: user.gender || 'female',
      age: user.age || '25',
      height: user.height || '170',
      weight: user.weight || '60',
      bodyType: user.bodyType || 'average',
      skinTone: user.skinTone || 'medium',
      hairColor: user.hairColor || 'brown',
      hairStyle: user.hairStyle || 'medium'
    });
    setShowEditParams(true);
  };

  // Save edited params
  const saveEditParams = () => {
    if (onUpdateUser) {
      onUpdateUser(editParams);
    }
    setShowEditParams(false);
  };

  // Loading state for follow request
  const [sendingFollowRequest, setSendingFollowRequest] = useState(false);

  // Send Follow Request - NEW SYSTEM
  const sendFollowRequest = async () => {
    if (!friendSearchResult.found || !authUser?.uid || !db) return;
    if (sendingFollowRequest) return; // Prevent double-click
    
    const foundUser = friendSearchResult.found;
    const myUid = authUser.uid;
    const targetUid = foundUser.uid;
    
    // Check if already sent request
    if (sentFollowRequests.some(r => r.uid === targetUid)) {
      setToast({ open: true, type: 'warning', title: 'Zaten GÃ¶nderildi', message: 'Bu kullanÄ±cÄ±ya takip isteÄŸi gÃ¶nderdin' });
      return;
    }
    
    // Check if already following
    if (friends.some(f => f.uid === targetUid)) {
      setToast({ open: true, type: 'info', title: 'Zaten Takip Ediyorsun', message: 'Bu kullanÄ±cÄ± arkadaÅŸ listende' });
      return;
    }
    
    setSendingFollowRequest(true);
    
    try {
      const requestData = {
        fromUid: myUid,
        fromUsername: user.username,
        fromDisplayName: user.displayName,
        fromPhoto: user.profilePhoto || null,
        toUid: targetUid,
        toUsername: foundUser.username,
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Add to target's incoming requests
      await db.collection('users').doc(targetUid).collection('followRequests').doc(myUid).set(requestData);
      
      // Add to my sent requests
      await db.collection('users').doc(myUid).collection('sentFollowRequests').doc(targetUid).set({
        ...requestData,
        toPhoto: foundUser.profilePhoto || null
      });
      
      // Create notification for target user
      await db.collection('users').doc(targetUid).collection('notifications').add({
        type: 'follow_request',
        fromUid: myUid,
        fromUsername: user.username,
        fromDisplayName: user.displayName,
        fromPhoto: user.profilePhoto || null,
        message: `${user.username || user.displayName} seni takip etmek istiyor`,
        read: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      console.log('âœ… Follow request sent');
      
      // INSTANT UPDATE: Local state'i hemen gÃ¼ncelle
      setSentFollowRequests(prev => [...prev, {
        uid: targetUid,
        username: foundUser.username,
        displayName: foundUser.displayName,
        profilePhoto: foundUser.profilePhoto || null,
        createdAt: Date.now()
      }]);
      
      setFriendUsername('');
      setFriendSearchResult({ searching: false, found: null, error: null });
      setShowAddFriend(false);
      setToast({ open: true, type: 'success', title: 'âœ… Ä°stek GÃ¶nderildi', message: `${foundUser.username}'e takip isteÄŸi gÃ¶nderildi` });
      
    } catch (e) {
      console.error('âŒ Follow request error:', e);
      setToast({ open: true, type: 'error', title: 'Hata', message: e.message });
    } finally {
      setSendingFollowRequest(false);
    }
  };
  
  // Accept Follow Request
  const acceptFollowRequest = async (request) => {
    if (!authUser?.uid || !db) return;
    
    const myUid = authUser.uid;
    const fromUid = request.fromUid;
    
    try {
      // Add each other to following/followers
      // They follow me
      await db.collection('users').doc(fromUid).collection('following').doc(myUid).set({
        uid: myUid,
        username: user.username,
        displayName: user.displayName,
        profilePhoto: user.profilePhoto || null,
        followedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // I'm in their following, they're in my followers
      await db.collection('users').doc(myUid).collection('followers').doc(fromUid).set({
        uid: fromUid,
        username: request.fromUsername,
        displayName: request.fromDisplayName,
        profilePhoto: request.fromPhoto || null,
        followedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // MUTUAL: I also follow them back automatically
      await db.collection('users').doc(myUid).collection('following').doc(fromUid).set({
        uid: fromUid,
        username: request.fromUsername,
        displayName: request.fromDisplayName,
        profilePhoto: request.fromPhoto || null,
        followedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      await db.collection('users').doc(fromUid).collection('followers').doc(myUid).set({
        uid: myUid,
        username: user.username,
        displayName: user.displayName,
        profilePhoto: user.profilePhoto || null,
        followedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Delete the request
      await db.collection('users').doc(myUid).collection('followRequests').doc(fromUid).delete();
      await db.collection('users').doc(fromUid).collection('sentFollowRequests').doc(myUid).delete();
      
      // Send notification to requester
      await db.collection('users').doc(fromUid).collection('notifications').add({
        type: 'follow_accepted',
        fromUid: myUid,
        fromUsername: user.username,
        fromDisplayName: user.displayName,
        fromPhoto: user.profilePhoto || null,
        message: `${user.username || user.displayName} takip isteÄŸini kabul etti`,
        read: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      console.log('âœ… Follow request accepted - mutual follow created');
      
      // INSTANT UPDATE: Local state'i hemen gÃ¼ncelle
      // Ä°steÄŸi listeden kaldÄ±r
      setFollowRequests(prev => prev.filter(r => r.fromUid !== fromUid));
      
      // Yeni arkadaÅŸÄ± friends listesine ekle
      const newFriend = {
        uid: fromUid,
        username: request.fromUsername,
        displayName: request.fromDisplayName,
        profilePhoto: request.fromPhoto || null,
        followedAt: Date.now()
      };
      setFriends(prev => {
        // Duplicate kontrolÃ¼
        if (prev.some(f => f.uid === fromUid)) return prev;
        return [...prev, newFriend];
      });
      
      setToast({ open: true, type: 'success', title: 'âœ… Kabul Edildi', message: `${request.fromUsername} artÄ±k arkadaÅŸÄ±n` });
      
    } catch (e) {
      console.error('âŒ Accept request error:', e);
      setToast({ open: true, type: 'error', title: 'Hata', message: e.message });
    }
  };
  
  // Reject Follow Request
  const rejectFollowRequest = async (request) => {
    if (!authUser?.uid || !db) return;
    
    const myUid = authUser.uid;
    const fromUid = request.fromUid;
    
    try {
      // Delete the request
      await db.collection('users').doc(myUid).collection('followRequests').doc(fromUid).delete();
      await db.collection('users').doc(fromUid).collection('sentFollowRequests').doc(myUid).delete();
      
      console.log('âœ… Follow request rejected');
      
      // Update local state
      setFollowRequests(prev => prev.filter(r => r.fromUid !== fromUid));
      
    } catch (e) {
      console.error('âŒ Reject request error:', e);
      alert('Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + e.message);
    }
  };
  
  // Cancel Sent Follow Request
  const cancelFollowRequest = async (targetUid) => {
    if (!authUser?.uid || !db) return;
    
    const myUid = authUser.uid;
    
    try {
      await db.collection('users').doc(targetUid).collection('followRequests').doc(myUid).delete();
      await db.collection('users').doc(myUid).collection('sentFollowRequests').doc(targetUid).delete();
      
      console.log('âœ… Follow request cancelled');
      setSentFollowRequests(prev => prev.filter(r => r.uid !== targetUid));
      
    } catch (e) {
      console.error('âŒ Cancel request error:', e);
    }
  };

  // Unfollow user - Removes MUTUAL follow
  const removeFriend = async (targetUid) => {
    if (!confirm('Takibi bÄ±rakmak istiyor musun? KarÅŸÄ±lÄ±klÄ± takip sonlanacak.')) return;
    if (!authUser?.uid || !db) return;
    
    const myUid = authUser.uid;
    
    try {
      // Remove mutual follow - both directions
      await db.collection('users').doc(myUid).collection('following').doc(targetUid).delete().catch(() => {});
      await db.collection('users').doc(myUid).collection('followers').doc(targetUid).delete().catch(() => {});
      await db.collection('users').doc(targetUid).collection('following').doc(myUid).delete().catch(() => {});
      await db.collection('users').doc(targetUid).collection('followers').doc(myUid).delete().catch(() => {});
      
      console.log('âœ… Mutual unfollow successful');
      
      // Update local state
      setFriends(prev => prev.filter(f => f.uid !== targetUid && f.id !== targetUid));
      setToast({ open: true, type: 'info', title: 'Takip BÄ±rakÄ±ldÄ±', message: 'ArkadaÅŸ listesinden Ã§Ä±karÄ±ldÄ±' });
      
    } catch (e) {
      console.error('âŒ Unfollow error:', e);
      setToast({ open: true, type: 'error', title: 'Hata', message: e.message });
    }
  };

  // Send message - REAL FIRESTORE
  const sendMessage = async () => {
    if (!newMessage.trim() || !selectedChat || !authUser?.uid || !db) return;
    
    const myUid = authUser.uid;
    const recipientUid = selectedChat.recipientId || selectedChat.uid;
    
    // Create chat ID (sorted UIDs for consistency)
    const chatId = selectedChat.type === 'group' 
      ? selectedChat.id 
      : [myUid, recipientUid].sort().join('_');
    
    const msg = {
      senderId: myUid,
      senderName: user.username || user.displayName,
      senderPhoto: user.profilePhoto || null,
      text: newMessage.trim(),
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    };
    
    try {
      if (selectedChat.type === 'group') {
        // Group message
        await db.collection('groups').doc(chatId).collection('messages').add(msg);
        
        // Update group's lastMessage
        await db.collection('groups').doc(chatId).update({
          lastMessage: newMessage.trim(),
          lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
          lastMessageBy: myUid
        });
      } else {
        // DM message
        const chatRef = db.collection('chats').doc(chatId);
        
        // Create/update chat document
        await chatRef.set({
          participants: [myUid, recipientUid],
          participantNames: {
            [myUid]: user.username || user.displayName,
            [recipientUid]: selectedChat.name
          },
          lastMessage: newMessage.trim(),
          lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
          lastMessageBy: myUid,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // Add message to subcollection
        await chatRef.collection('messages').add(msg);
        
        console.log('âœ… Message sent');
      }
      
      // Update local state immediately for responsiveness
      const localMsg = {
        id: Date.now(),
        senderId: myUid,
        senderName: user.username || user.displayName,
        text: newMessage.trim(),
        timestamp: Date.now()
      };
      
      if (selectedChat.type === 'group') {
        setGroups(prev => prev.map(g => 
          g.id === selectedChat.id 
            ? { ...g, messages: [...(g.messages || []), localMsg] }
            : g
        ));
      } else {
        setDmChats(prev => {
          const existing = prev.find(c => c.id === chatId);
          if (existing) {
            return prev.map(c => c.id === chatId 
              ? { ...c, messages: [...(c.messages || []), localMsg] }
              : c
            );
          } else {
            return [...prev, { 
              id: chatId, 
              recipientId: recipientUid,
              name: selectedChat.name, 
              avatar: selectedChat.avatar,
              messages: [localMsg],
              approved: true
            }];
          }
        });
      }
      
      setNewMessage('');
      
    } catch (e) {
      console.error('âŒ Send message error:', e);
      alert('Mesaj gÃ¶nderilemedi: ' + e.message);
    }
  };

  const getChatMessages = (chatId, type = 'dm') => {
    if (type === 'group') {
      const group = groups.find(g => g.id === chatId);
      return group?.messages || [];
    }
    const chat = dmChats.find(c => c.id === chatId);
    return chat?.messages || [];
  };
  
  // Start new DM
  const startDM = async (person) => {
    if (!authUser?.uid || !db) return;
    
    const myUid = authUser.uid;
    const recipientUid = person.uid;
    
    // Create consistent chat ID (sorted UIDs)
    const chatId = [myUid, recipientUid].sort().join('_');
    
    // Check if chat already exists in local state
    const existingChat = dmChats.find(c => c.id === chatId);
    
    if (existingChat) {
      setSelectedChat({ type: 'dm', ...existingChat });
      setShowNewChat(false);
      return;
    }
    
    // Check if chat exists in Firestore
    try {
      const chatDoc = await db.collection('chats').doc(chatId).get();
      
      if (chatDoc.exists) {
        // Chat exists, load it
        const data = chatDoc.data();
        setSelectedChat({
          type: 'dm',
          id: chatId,
          recipientId: recipientUid,
          name: person.displayName || person.username || person.name,
          avatar: person.avatar || person.profilePhoto,
          messages: [], // Will be loaded by the message listener
          approved: true
        });
      } else {
        // Create new chat placeholder - will be created in Firestore when first message is sent
        setSelectedChat({
          type: 'dm',
          id: chatId,
          recipientId: recipientUid,
          name: person.displayName || person.username || person.name,
          avatar: person.avatar || person.profilePhoto,
          messages: [],
          approved: true,
          isNew: true
        });
      }
    } catch (e) {
      console.error('âŒ Error checking chat:', e);
      // Fallback - create new chat
      setSelectedChat({
        type: 'dm',
        id: chatId,
        recipientId: recipientUid,
        name: person.displayName || person.username || person.name,
        avatar: person.avatar || person.profilePhoto,
        messages: [],
        approved: true,
        isNew: true
      });
    }
    
    setShowNewChat(false);
  };
  
  // Create group
  const createGroup = () => {
    if (!groupName.trim() || selectedGroupMembers.length === 0) return;
    if (selectedGroupMembers.length > 5) {
      alert('Grup en fazla 6 kiÅŸi olabilir (siz dahil)');
      return;
    }
    
    const newGroup = {
      id: Date.now(),
      name: groupName,
      members: [
        { uid: authUser?.uid, name: user.username || user.displayName, avatar: user.profilePhoto },
        ...selectedGroupMembers
      ],
      messages: [],
      createdAt: Date.now(),
      createdBy: authUser?.uid
    };
    
    setGroups(prev => [...prev, newGroup]);
    setGroupName('');
    setSelectedGroupMembers([]);
    setShowCreateGroup(false);
    setSelectedChat({ type: 'group', ...newGroup });
  };
  
  // Toggle group member selection
  const toggleGroupMember = (person) => {
    if (selectedGroupMembers.some(m => m.uid === person.uid)) {
      setSelectedGroupMembers(prev => prev.filter(m => m.uid !== person.uid));
    } else {
      if (selectedGroupMembers.length >= 5) {
        alert('Grup en fazla 6 kiÅŸi olabilir (siz dahil)');
        return;
      }
      setSelectedGroupMembers(prev => [...prev, {
        uid: person.uid,
        name: person.name || person.username,
        avatar: person.avatar
      }]);
    }
  };
  
  // Accept/Reject message request
  const handleMessageRequest = (chatId, accept) => {
    if (accept) {
      setDmChats(prev => prev.map(c => c.id === chatId ? { ...c, approved: true } : c));
    } else {
      setDmChats(prev => prev.filter(c => c.id !== chatId));
    }
    setMessageRequests(prev => prev.filter(r => r.chatId !== chatId));
  };
  
  // Get pending requests count
  const pendingRequestsCount = dmChats.filter(c => !c.approved && c.messages?.length > 0).length;

  // Load messages when a chat is selected - REAL TIME LISTENER
  useEffect(() => {
    if (!selectedChat || !db || selectedChat.type === 'group') return;
    
    const chatId = selectedChat.id;
    if (!chatId || typeof chatId !== 'string' || !chatId.includes('_')) return;
    
    console.log('ðŸ“¨ Starting real-time message listener for:', chatId);
    
    const unsubscribe = db.collection('chats').doc(chatId).collection('messages')
      .orderBy('timestamp', 'asc')
      .limit(100)
      .onSnapshot(
        (snapshot) => {
          const messagesList = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            messagesList.push({
              id: doc.id,
              senderId: data.senderId,
              senderName: data.senderName,
              text: data.text,
              type: data.type || 'text',
              image: data.image || null,
              items: data.items || [],
              timestamp: data.timestamp?.toMillis?.() || data.createdAt || Date.now(),
              read: data.read
            });
          });
          
          console.log('ðŸ“¨ Messages updated:', messagesList.length, messagesList.map(m => ({ type: m.type, hasImage: !!m.image })));
          
          // Update dmChats with loaded messages
          setDmChats(prev => prev.map(c => 
            c.id === chatId ? { ...c, messages: messagesList } : c
          ));
        },
        (error) => {
          console.error('âŒ Message listener error:', error);
        }
      );
    
    return () => {
      console.log('ðŸ”Œ Message listener unsubscribed');
      unsubscribe();
    };
  }, [selectedChat?.id]);

  const tabs = [
    { id: 'profile', icon: 'user', label: t('profile') },
    { id: 'avatar', icon: 'sparkles', label: t('myTwin') },
    { id: 'notifications', icon: 'bell', label: t('notifications'), badge: unreadNotificationsCount },
    { id: 'settings', icon: 'settings', label: t('settings') }
  ];

  // Physical attributes labels
  const bodyTypeLabels = {
    slim: 'Ä°nce', athletic: 'Atletik', average: 'Normal', curvy: 'Dolgun', plus: 'BÃ¼yÃ¼k Beden'
  };
  const skinToneLabels = {
    fair: 'Ã‡ok AÃ§Ä±k', light: 'AÃ§Ä±k', medium: 'BuÄŸday', olive: 'Zeytin', tan: 'Bronz', dark: 'Koyu'
  };
  const hairColorLabels = {
    black: 'Siyah', brown: 'Kahve', blonde: 'SarÄ±', red: 'KÄ±zÄ±l', gray: 'Gri'
  };
  const hairStyleLabels = {
    short: 'KÄ±sa', medium: 'Orta', long: 'Uzun', curly: 'KÄ±vÄ±rcÄ±k', wavy: 'DalgalÄ±', bald: 'Kel'
  };

  return (
    <div className="h-full flex flex-col">
      {/* Hidden file input for profile photo */}
      <input 
        ref={profilePhotoRef}
        type="file" 
        accept="image/*" 
        onChange={handleProfilePhotoSelect}
        className="hidden"
      />
      
      {/* Profile Header */}
      <div className="relative h-44 flex-shrink-0 overflow-hidden">
        <div className="absolute inset-0 bg-brand/20" />
        <div className="absolute inset-0 flex items-center justify-center">
          <div className="relative">
            {/* Profile Photo */}
            <button 
              onClick={() => profilePhotoRef.current?.click()}
              className="w-24 h-24 rounded-full overflow-hidden border-4 border-brand2/50 shadow-lg relative group"
            >
              {user.profilePhoto ? (
                <img src={user.profilePhoto} className="w-full h-full object-cover" />
              ) : (
                <img src={user.baseAvatar || user.avatar} className="w-full h-full object-cover object-top scale-150" />
              )}
              <div className="absolute inset-0 bg-slate-900/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                <Icon name="camera" size={20} />
              </div>
            </button>
            {/* Online/Public indicator */}
            {settings?.profilePublic && (
              <div className="absolute -bottom-1 -right-1 bg-green-500 p-1.5 rounded-full border-2 border-dark">
                <Icon name="globe" size={10} />
              </div>
            )}
          </div>
        </div>
        <div className="absolute bottom-3 left-0 right-0 text-center">
          <h1 className="text-lg font-bold">{user.displayName || user.username || t('user')}</h1>
          {user.username && (
            <p className="text-slate-500 text-sm">@{user.username}</p>
          )}
        </div>
      </div>

      {/* Tab Navigation */}
      <div className="flex-shrink-0 px-4 py-3 border-b border-slate-200">
        <div className="flex gap-1 bg-slate-100 rounded-2xl p-1">
          {tabs.map(t => (
            <button
              key={t.id}
              onClick={() => {
                setTab(t.id);
                // Clear selected chat when switching to messages tab to show chat list
                if (t.id === 'messages') {
                  setSelectedChat(null);
                }
              }}
              className={`flex-1 py-2 px-1 rounded-xl text-[10px] font-semibold flex flex-col items-center justify-center gap-0.5 transition relative ${
                tab === t.id ? 'bg-brand text-white' : 'text-slate-500 hover:text-slate-600'
              }`}
            >
              <Icon name={t.icon} size={16} />
              <span className="truncate max-w-full">{t.label}</span>
              {t.badge > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] font-bold w-4 h-4 rounded-full flex items-center justify-center">
                  {t.badge > 9 ? '9+' : t.badge}
                </span>
              )}
            </button>
          ))}
        </div>
      </div>

      {/* Tab Content */}
      <div className="flex-1 overflow-y-auto custom-scroll pb-24">
        {/* PROFILE TAB */}
        {tab === 'profile' && (
          <div className="p-4 space-y-4 fade-in">
            {/* Stats */}
            <div className="grid grid-cols-3 gap-3">
              <div className="glass rounded-2xl p-4 text-center">
                <div className="text-2xl font-bold text-brand2">{friends.length}</div>
                <div className="text-xs text-slate-500">{t('follower')}</div>
              </div>
              <div className="glass rounded-2xl p-4 text-center">
                <div className="text-2xl font-bold text-accent">{user.closetCount || 0}</div>
                <div className="text-xs text-slate-500">{t('closetLabel')}</div>
              </div>
              <div className="glass rounded-2xl p-4 text-center">
                <div className="text-2xl font-bold text-green-400">{user.tryOnCount || 0}</div>
                <div className="text-xs text-slate-500">{t('tryOnLabel')}</div>
              </div>
            </div>

            {/* Account Info */}
            <div className="glass rounded-2xl p-4 space-y-3">
              <h3 className="font-semibold text-sm flex items-center gap-2">
                <Icon name="user" size={16} className="text-brand2" />
                {t('accountInfo')}
              </h3>
              <div className="space-y-2">
                <div className="flex justify-between items-center py-2 border-b border-slate-200">
                  <span className="text-slate-500 text-sm">{t('displayNameLabel')}</span>
                  <input 
                    type="text" 
                    value={user.displayName || ''} 
                    onChange={(e) => onUpdateUser && onUpdateUser({ displayName: e.target.value })}
                    placeholder={authUser?.email?.split('@')[0]}
                    className="text-sm font-medium text-right bg-transparent border-none outline-none w-32"
                  />
                </div>
                <div className="flex justify-between items-center py-2 border-b border-slate-200">
                  <span className="text-slate-500 text-sm">E-posta</span>
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-medium">{authUser?.email || '-'}</span>
                    {authUser?.emailVerified ? (
                      <span className="text-green-400"><Icon name="check" size={12} /></span>
                    ) : (
                      <button onClick={resendVerification} className="text-yellow-400 text-xs hover:text-yellow-300">{t('verify')}</button>
                    )}
                  </div>
                </div>
                <div className="flex justify-between items-center py-2 border-b border-slate-200">
                  <span className="text-slate-500 text-sm">Ãœyelik</span>
                  <span className={`text-sm font-medium ${user.subscription?.active || (user.credits || 0) > 0 ? 'text-brand2' : 'text-slate-600'}`}>
                    {user.subscription?.active ? 'Premium âœ¨' : (user.credits || 0) > 0 ? 'Kredili Ãœye' : t('freeMember')}
                  </span>
                </div>
                
                {/* Kalan Hak Bilgileri */}
                <div className="py-2 border-b border-slate-200">
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-slate-500 text-sm">Kalan Haklar</span>
                  </div>
                  <div className="flex items-center justify-center">
                    <div className="bg-gradient-to-r from-amber-100 to-yellow-50 rounded-xl p-3 text-center border border-amber-300 shadow-sm">
                      <span className="text-2xl">ðŸª™</span>
                      <p className="text-lg font-bold text-amber-700">{(user?.freeAvatarTry || 0) + (user?.freeShopTry || 0) + (user?.freeComboTry || 0) + (user?.credits || 0)}</p>
                      <p className="text-[10px] text-amber-600 font-medium">Toplam Kredi</p>
                    </div>
                  </div>
                </div>
                <div className="flex justify-between items-center py-2">
                  <span className="text-slate-500 text-sm">KatÄ±lÄ±m</span>
                  <span className="text-sm font-medium">{user.createdAt ? new Date(user.createdAt).toLocaleDateString('tr-TR') : '-'}</span>
                </div>
              </div>
            </div>

            {/* Logout */}
            <button onClick={onLogout} className="w-full bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-400 py-4 rounded-xl font-semibold flex items-center justify-center gap-2">
              <Icon name="logout" size={18} />Ã‡Ä±kÄ±ÅŸ Yap
            </button>
          </div>
        )}

        {/* AVATAR TAB - Sanal Ä°kizim */}
        {tab === 'avatar' && (
          <div className="p-4 space-y-4 fade-in">
            {/* Full Body Avatar */}
            <div className="glass rounded-3xl overflow-hidden">
              <div className="aspect-[3/4] relative bg-gradient-to-b from-white/5 to-transparent">
                <img src={user.baseAvatar || user.avatar} className="w-full h-full object-contain" />
                <div className="absolute top-3 right-3 bg-brand2/90 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1">
                  <Icon name="sparkles" size={12} />Full Body
                </div>
              </div>
            </div>

            {/* Physical Attributes */}
            <div className="glass rounded-2xl p-4 space-y-4">
              <div className="flex items-center justify-between">
                <h3 className="font-semibold text-sm flex items-center gap-2">
                  <Icon name="user" size={16} className="text-brand2" />
                  Fiziksel Ã–zellikler
                </h3>
                <button onClick={openEditParams} className="text-xs text-brand2 font-semibold flex items-center gap-1 hover:text-brand">
                  <Icon name="edit" size={14} />DÃ¼zenle
                </button>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <div className="bg-slate-100 rounded-xl p-3">
                  <div className="text-xs text-slate-500 mb-1">Cinsiyet</div>
                  <div className="font-semibold">{user.gender === 'female' ? 'KadÄ±n' : 'Erkek'}</div>
                </div>
                <div className="bg-slate-100 rounded-xl p-3">
                  <div className="text-xs text-slate-500 mb-1">YaÅŸ</div>
                  <div className="font-semibold">{user.age} yaÅŸÄ±nda</div>
                </div>
                <div className="bg-slate-100 rounded-xl p-3">
                  <div className="text-xs text-slate-500 mb-1">Boy</div>
                  <div className="font-semibold">{user.height} cm</div>
                </div>
                <div className="bg-slate-100 rounded-xl p-3">
                  <div className="text-xs text-slate-500 mb-1">Kilo</div>
                  <div className="font-semibold">{user.weight} kg</div>
                </div>
              </div>

              <div className="space-y-2">
                <div className="flex justify-between items-center py-2 border-b border-slate-200">
                  <span className="text-slate-500 text-sm">VÃ¼cut Tipi</span>
                  <span className="text-sm font-medium">{bodyTypeLabels[user.bodyType] || user.bodyType}</span>
                </div>
                <div className="flex justify-between items-center py-2 border-b border-slate-200">
                  <span className="text-slate-500 text-sm">Ten Rengi</span>
                  <span className="text-sm font-medium">{skinToneLabels[user.skinTone] || user.skinTone}</span>
                </div>
                <div className="flex justify-between items-center py-2 border-b border-slate-200">
                  <span className="text-slate-500 text-sm">SaÃ§ Rengi</span>
                  <span className="text-sm font-medium">{hairColorLabels[user.hairColor] || user.hairColor}</span>
                </div>
                <div className="flex justify-between items-center py-2">
                  <span className="text-slate-500 text-sm">SaÃ§ Stili</span>
                  <span className="text-sm font-medium">{hairStyleLabels[user.hairStyle] || user.hairStyle}</span>
                </div>
              </div>
            </div>

            {/* Refresh Avatar Button */}
            <button onClick={onResetAvatar} className="w-full btn-secondary py-4 rounded-xl font-semibold flex items-center justify-center gap-2">
              <Icon name="refresh" size={18} />AvatarÄ± Yeniden OluÅŸtur
            </button>
            
            <p className="text-center text-xs text-slate-400">
              YÃ¼z fotoÄŸraflarÄ±nÄ± deÄŸiÅŸtirmek iÃ§in avatarÄ± yeniden oluÅŸtur
            </p>
          </div>
        )}

        {/* Edit Physical Params Modal */}
        {showEditParams && (
          <div className="fixed inset-0 z-[100] bg-black/90 flex flex-col slide-up">
            <div className="p-4 flex items-center justify-between border-b border-slate-200">
              <h3 className="font-bold flex items-center gap-2">
                <Icon name="edit" size={18} className="text-brand2" />
                Fiziksel Ã–zellikleri DÃ¼zenle
              </h3>
              <button onClick={() => setShowEditParams(false)} className="p-2 rounded-xl hover:bg-slate-200/60">
                <Icon name="x" size={20} />
              </button>
            </div>
            <div className="flex-1 overflow-auto custom-scroll p-4 space-y-4">
              <p className="text-sm text-slate-500 bg-slate-100 rounded-xl p-3">
                ðŸ’¡ Bu deÄŸiÅŸiklikler mevcut avatarÄ±nÄ± etkilemez. Yeni try-on sonuÃ§larÄ± iÃ§in kullanÄ±lÄ±r.
              </p>
              
              {/* Gender */}
              <div>
                <label className="text-sm font-semibold text-slate-700 mb-2 block">Cinsiyet</label>
                <div className="grid grid-cols-2 gap-2">
                  {['female', 'male'].map(g => (
                    <button key={g} onClick={() => setEditParams(p => ({ ...p, gender: g }))}
                      className={`py-3 rounded-xl font-bold transition-all ${editParams.gender === g 
                        ? 'bg-brand text-slate-800' 
                        : 'bg-slate-100 text-slate-500'}`}>
                      {g === 'female' ? 'KadÄ±n' : 'Erkek'}
                    </button>
                  ))}
                </div>
              </div>
              
              {/* Age, Height, Weight */}
              <div className="grid grid-cols-3 gap-3">
                <div>
                  <label className="text-xs text-slate-500 mb-1.5 block">YaÅŸ</label>
                  <input type="number" value={editParams.age} onChange={e => setEditParams(p => ({ ...p, age: e.target.value }))} className="text-center font-bold" />
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1.5 block">Boy (cm)</label>
                  <input type="number" value={editParams.height} onChange={e => setEditParams(p => ({ ...p, height: e.target.value }))} className="text-center font-bold" />
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1.5 block">Kilo (kg)</label>
                  <input type="number" value={editParams.weight} onChange={e => setEditParams(p => ({ ...p, weight: e.target.value }))} className="text-center font-bold" />
                </div>
              </div>
              
              {/* Body Type */}
              <div>
                <label className="text-xs text-slate-500 mb-1.5 block">VÃ¼cut Tipi</label>
                <select value={editParams.bodyType} onChange={e => setEditParams(p => ({ ...p, bodyType: e.target.value }))}>
                  <option value="slim">Ä°nce / ZayÄ±f</option>
                  <option value="athletic">Atletik / Fit</option>
                  <option value="average">Normal / Orta</option>
                  <option value="curvy">Dolgun</option>
                  <option value="plus">BÃ¼yÃ¼k Beden</option>
                </select>
              </div>
              
              {/* Skin Tone */}
              <div>
                <label className="text-xs text-slate-500 mb-1.5 block">Ten Rengi</label>
                <select value={editParams.skinTone} onChange={e => setEditParams(p => ({ ...p, skinTone: e.target.value }))}>
                  <option value="fair">Ã‡ok AÃ§Ä±k Ten</option>
                  <option value="light">AÃ§Ä±k Ten</option>
                  <option value="medium">BuÄŸday Ten</option>
                  <option value="olive">Zeytin Ten</option>
                  <option value="tan">Bronz Ten</option>
                  <option value="dark">Koyu Ten</option>
                </select>
              </div>
              
              {/* Hair */}
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="text-xs text-slate-500 mb-1.5 block">SaÃ§ Rengi</label>
                  <select value={editParams.hairColor} onChange={e => setEditParams(p => ({ ...p, hairColor: e.target.value }))}>
                    <option value="black">Siyah</option>
                    <option value="brown">Kahverengi</option>
                    <option value="blonde">SarÄ±</option>
                    <option value="red">KÄ±zÄ±l</option>
                    <option value="gray">Gri / Beyaz</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1.5 block">SaÃ§ Stili</label>
                  <select value={editParams.hairStyle} onChange={e => setEditParams(p => ({ ...p, hairStyle: e.target.value }))}>
                    <option value="short">KÄ±sa</option>
                    <option value="medium">Orta</option>
                    <option value="long">Uzun</option>
                    <option value="curly">KÄ±vÄ±rcÄ±k</option>
                    {editParams.gender === 'male' && <option value="bald">Kel</option>}
                  </select>
                </div>
              </div>
            </div>
            <div className="p-4 border-t border-slate-200 space-y-2 safe-bottom">
              <button onClick={saveEditParams} className="w-full btn-primary py-4 rounded-xl font-bold flex items-center justify-center gap-2">
                <Icon name="check" size={18} />Kaydet
              </button>
              <button onClick={() => setShowEditParams(false)} className="w-full btn-ghost py-3 rounded-xl text-sm text-slate-500">
                Ä°ptal
              </button>
            </div>
          </div>
        )}

        {/* FRIENDS TAB */}
        {tab === 'followers' && (
          <div className="p-4 space-y-4 fade-in">
            {/* Follow Requests Section */}
            {followRequests.length > 0 && (
              <div className="glass rounded-2xl p-4">
                <h3 className="font-bold text-sm mb-3 flex items-center gap-2">
                  <span className="w-6 h-6 bg-brand text-white rounded-full flex items-center justify-center text-xs">{followRequests.length}</span>
                  Takip Ä°stekleri
                </h3>
                <div className="space-y-2 max-h-48 overflow-y-auto">
                  {followRequests.map(req => (
                    <div key={req.fromUid} className="flex items-center gap-3 p-2 bg-white/50 rounded-xl">
                      <div className="w-10 h-10 rounded-xl bg-brand flex items-center justify-center overflow-hidden">
                        {req.fromPhoto ? (
                          <img src={req.fromPhoto} className="w-full h-full rounded-xl object-cover" />
                        ) : (
                          <span className="text-sm">ðŸ‘¤</span>
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="font-semibold text-sm truncate">{req.fromDisplayName || req.fromUsername}</div>
                        <div className="text-xs text-slate-500">@{req.fromUsername}</div>
                      </div>
                      <div className="flex gap-1">
                        <button 
                          onClick={() => acceptFollowRequest(req)} 
                          className="p-2 rounded-xl bg-green-500 text-white hover:bg-green-600"
                          title="Kabul Et"
                        >
                          <Icon name="check" size={16} />
                        </button>
                        <button 
                          onClick={() => rejectFollowRequest(req)} 
                          className="p-2 rounded-xl bg-red-500 text-white hover:bg-red-600"
                          title="Reddet"
                        >
                          <Icon name="x" size={16} />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Pending Sent Requests */}
            {sentFollowRequests.length > 0 && (
              <div className="glass rounded-2xl p-4">
                <h3 className="font-bold text-sm mb-3 text-slate-600">GÃ¶nderilen Ä°stekler ({sentFollowRequests.length})</h3>
                <div className="space-y-2 max-h-32 overflow-y-auto">
                  {sentFollowRequests.map(req => (
                    <div key={req.uid} className="flex items-center gap-3 p-2 bg-white/50 rounded-xl">
                      <div className="w-8 h-8 rounded-lg bg-slate-200 flex items-center justify-center overflow-hidden">
                        {req.profilePhoto ? (
                          <img src={req.profilePhoto} className="w-full h-full rounded-lg object-cover" />
                        ) : (
                          <span className="text-xs">ðŸ‘¤</span>
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="font-medium text-sm truncate">@{req.username}</div>
                        <div className="text-xs text-amber-600">Beklemede...</div>
                      </div>
                      <button 
                        onClick={() => cancelFollowRequest(req.uid)} 
                        className="text-xs text-red-500 hover:text-red-600"
                      >
                        Ä°ptal
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Follow User Button */}
            <button onClick={() => setShowAddFriend(true)} className="w-full btn-primary py-4 rounded-xl font-semibold flex items-center justify-center gap-2">
              <Icon name="userPlus" size={18} />KullanÄ±cÄ± Bul
            </button>

            {/* Following List */}
            {friends.length === 0 ? (
              <div className="text-center py-12">
                <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                  <Icon name="users" size={28} className="text-slate-400" />
                </div>
                <p className="font-semibold text-slate-500">{t('notFollowingAnyone')}</p>
                <p className="text-sm text-slate-400 mt-1">KullanÄ±cÄ± ara ve takip isteÄŸi gÃ¶nder</p>
              </div>
            ) : (
              <div className="space-y-2">
                <h3 className="font-bold text-sm text-slate-600">ArkadaÅŸlar ({friends.length})</h3>
                {friends.map(friend => (
                  <div key={friend.id} className="glass rounded-2xl p-4 flex items-center gap-3">
                    <div className="w-12 h-12 rounded-xl bg-brand flex items-center justify-center overflow-hidden">
                      {friend.avatar ? (
                        <img src={friend.avatar} className="w-full h-full rounded-xl object-cover" />
                      ) : (
                        <span className="text-lg">ðŸ‘¤</span>
                      )}
                    </div>
                    <div className="flex-1">
                      <div className="font-semibold">{friend.name}</div>
                      <div className="text-xs text-slate-500">@{friend.username || 'kullanici'}</div>
                    </div>
                    <div className="flex items-center gap-2">
                      <button 
                        onClick={() => startDM(friend)} 
                        className="p-2 rounded-xl hover:bg-slate-200/60"
                        title={t('sendMessage')}
                      >
                        <Icon name="mail" size={18} className="text-brand2" />
                      </button>
                      <button onClick={() => removeFriend(friend.id)} className="p-2 rounded-xl hover:bg-red-500/20" title="Takibi BÄ±rak">
                        <Icon name="userMinus" size={18} className="text-red-400" />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Add/Follow User Modal */}
            {showAddFriend && (
              <div className="fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4">
                <div className="w-full max-w-sm glass rounded-3xl p-6 scale-in">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-lg">KullanÄ±cÄ± Bul</h3>
                    <button onClick={() => { setShowAddFriend(false); setFriendUsername(''); setFriendSearchResult({ searching: false, found: null, error: null }); }} className="p-2 rounded-xl hover:bg-slate-200/60">
                      <Icon name="x" size={20} />
                    </button>
                  </div>
                  <p className="text-sm text-slate-500 mb-4">KullanÄ±cÄ± adÄ± ile ara</p>
                  
                  <div className="relative mb-4">
                    <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-medium">@</span>
                    <input
                      type="text"
                      value={friendUsername}
                      onChange={e => setFriendUsername(e.target.value.toLowerCase().replace(/[^a-z0-9_.\-]/g, ''))}
                      placeholder="kullanici_adi"
                      className="pl-10 pr-10"
                      maxLength={20}
                    />
                    <div className="absolute right-4 top-1/2 -translate-y-1/2">
                      {friendSearchResult.searching && (
                        <div className="w-4 h-4 border-2 border-brand/30 border-t-brand rounded-full animate-spin" />
                      )}
                      {!friendSearchResult.searching && friendSearchResult.found && (
                        <Icon name="check" size={18} className="text-green-400" />
                      )}
                      {!friendSearchResult.searching && friendSearchResult.error && (
                        <Icon name="x" size={18} className="text-red-400" />
                      )}
                    </div>
                  </div>
                  
                  {/* Search result */}
                  {friendSearchResult.found && (
                    <div className="bg-slate-100 rounded-xl p-3 mb-4 flex items-center gap-3">
                      <div className="w-12 h-12 rounded-xl bg-brand flex items-center justify-center overflow-hidden">
                        {friendSearchResult.found.profilePhoto ? (
                          <img src={friendSearchResult.found.profilePhoto} className="w-full h-full object-cover" />
                        ) : (
                          <span className="text-lg">ðŸ‘¤</span>
                        )}
                      </div>
                      <div className="flex-1">
                        <div className="font-semibold">{friendSearchResult.found.displayName || friendSearchResult.found.username}</div>
                        <div className="text-xs text-slate-500">@{friendSearchResult.found.username}</div>
                      </div>
                      <Icon name="check" size={20} className="text-green-400" />
                    </div>
                  )}
                  
                  {friendSearchResult.error && (
                    <p className="text-sm text-red-400 mb-4">{friendSearchResult.error}</p>
                  )}
                  
                  <div className="flex gap-3">
                    <button onClick={() => { setShowAddFriend(false); setFriendUsername(''); setFriendSearchResult({ searching: false, found: null, error: null }); }} className="flex-1 btn-ghost py-3 rounded-xl font-semibold">{t('cancel')}</button>
                    <button 
                      onClick={sendFollowRequest} 
                      disabled={!friendSearchResult.found || sentFollowRequests.some(r => r.uid === friendSearchResult.found?.uid)}
                      className="flex-1 btn-primary py-3 rounded-xl font-semibold disabled:opacity-50"
                    >
                      {sentFollowRequests.some(r => r.uid === friendSearchResult.found?.uid) ? 'Ä°stek GÃ¶nderildi' : 'Ä°stek GÃ¶nder'}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* MESSAGES TAB - DM & Groups */}
        {tab === 'messages' && (
          <div className="h-full flex flex-col fade-in">
            {!selectedChat ? (
              // Chat List View
              <div className="flex flex-col h-full">
                {/* New Chat/Group Buttons */}
                <div className="p-4 flex gap-2">
                  <button 
                    onClick={() => setShowNewChat(true)} 
                    className="flex-1 btn-primary py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                  >
                    <Icon name="mail" size={16} />{t('newMessage')}
                  </button>
                  <button 
                    onClick={() => setShowCreateGroup(true)} 
                    className="flex-1 btn-ghost py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                  >
                    <Icon name="users" size={16} />Grup OluÅŸtur
                  </button>
                </div>
                
                {/* Message Requests */}
                {pendingRequestsCount > 0 && (
                  <div className="px-4 mb-2">
                    <button 
                      onClick={() => setTab('requests')}
                      className="w-full bg-amber-100 border border-amber-200 rounded-xl p-3 flex items-center justify-between"
                    >
                      <div className="flex items-center gap-2">
                        <Icon name="mail" size={18} className="text-amber-600" />
                        <span className="font-medium text-amber-800">{t('messageRequest')}</span>
                      </div>
                      <span className="bg-amber-500 text-white text-xs font-bold px-2 py-1 rounded-full">{pendingRequestsCount}</span>
                    </button>
                  </div>
                )}
                
                {/* Groups Section */}
                {groups.length > 0 && (
                  <div className="px-4 mb-2">
                    <p className="text-xs font-semibold text-slate-500 mb-2">GRUPLAR</p>
                    <div className="space-y-2">
                      {groups.map(group => {
                        const lastMsg = (group.messages || []).slice(-1)[0];
                        return (
                          <button
                            key={group.id}
                            onClick={() => setSelectedChat({ type: 'group', ...group })}
                            className="w-full glass rounded-2xl p-3 flex items-center gap-3 text-left hover:bg-slate-100 transition"
                          >
                            <div className="w-12 h-12 rounded-xl bg-brand flex items-center justify-center">
                              <Icon name="users" size={20} className="text-white" />
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className="font-semibold">{group.name}</div>
                              <div className="text-xs text-slate-500 truncate">
                                {lastMsg ? `${lastMsg.senderName}: ${lastMsg.text}` : `${group.members.length} Ã¼ye`}
                              </div>
                            </div>
                            <Icon name="chevronRight" size={18} className="text-slate-400" />
                          </button>
                        );
                      })}
                    </div>
                  </div>
                )}
                
                {/* DM Chats */}
                <div className="flex-1 overflow-y-auto custom-scroll px-4">
                  {groups.length > 0 && <p className="text-xs font-semibold text-slate-500 mb-2">{t('messagesLabel')}</p>}
                  
                  {dmChats.length === 0 && groups.length === 0 ? (
                    <div className="text-center py-12">
                      <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                        <Icon name="mail" size={28} className="text-slate-400" />
                      </div>
                      <p className="font-semibold text-slate-500">{t('noMessages')}</p>
                      <p className="text-sm text-slate-400 mt-1">{t('startNewMessage')}</p>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {dmChats.filter(c => c.approved !== false || c.messages?.length > 0).map(chat => {
                        const lastMsg = (chat.messages || []).slice(-1)[0];
                        return (
                          <button
                            key={chat.id}
                            onClick={() => setSelectedChat({ type: 'dm', ...chat })}
                            className="w-full glass rounded-2xl p-3 flex items-center gap-3 text-left hover:bg-slate-100 transition"
                          >
                            <div className="w-12 h-12 rounded-xl bg-brand flex items-center justify-center overflow-hidden">
                              {chat.avatar ? (
                                <img src={chat.avatar} className="w-full h-full object-cover" />
                              ) : (
                                <span className="text-lg">ðŸ‘¤</span>
                              )}
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className="font-semibold">{chat.name}</div>
                              <div className="text-xs text-slate-500 truncate">
                                {lastMsg ? lastMsg.text : t('noMessages')}
                              </div>
                            </div>
                            {!chat.approved && (
                              <span className="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-lg">{t('request')}</span>
                            )}
                            <Icon name="chevronRight" size={18} className="text-slate-400" />
                          </button>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            ) : (
              // Chat View (DM or Group)
              <div className="flex flex-col h-full overflow-hidden">
                {/* Chat Header */}
                <div className="flex-shrink-0 p-4 border-b border-slate-200 flex items-center gap-3">
                  <button onClick={() => setSelectedChat(null)} className="p-2 -ml-2 rounded-xl hover:bg-slate-200/60">
                    <Icon name="chevronLeft" size={20} />
                  </button>
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${
                    selectedChat.type === 'group' 
                      ? 'bg-brand' 
                      : 'bg-brand'
                  }`}>
                    {selectedChat.type === 'group' ? (
                      <Icon name="users" size={18} className="text-white" />
                    ) : selectedChat.avatar ? (
                      <img src={selectedChat.avatar} className="w-full h-full rounded-xl object-cover" />
                    ) : (
                      <span>ðŸ‘¤</span>
                    )}
                  </div>
                  <div className="flex-1">
                    <div className="font-semibold">{selectedChat.name}</div>
                    <div className="text-xs text-slate-500">
                      {selectedChat.type === 'group' 
                        ? `${selectedChat.members?.length || 0} Ã¼ye`
                        : 'Ã‡evrimiÃ§i'
                      }
                    </div>
                  </div>
                  {selectedChat.type === 'group' && (
                    <button className="p-2 rounded-xl hover:bg-slate-200/60">
                      <Icon name="settings" size={18} className="text-slate-500" />
                    </button>
                  )}
                </div>
                
                {/* Approval Warning for non-follower DMs */}
                {selectedChat.type === 'dm' && selectedChat.approved === false && (
                  <div className="mx-4 mt-2 bg-amber-50 border border-amber-200 rounded-xl p-3 text-center">
                    <p className="text-sm text-amber-800">
                      {t('notFollowingWarning')}
                    </p>
                  </div>
                )}

                {/* Messages */}
                <div className="flex-1 min-h-0 overflow-y-auto custom-scroll p-4 space-y-3">
                  {getChatMessages(selectedChat.id, selectedChat.type).length === 0 ? (
                    <div className="text-center py-8 text-slate-400 text-sm">
                      {t('beFirstToMessage')}
                    </div>
                  ) : (
                    getChatMessages(selectedChat.id, selectedChat.type).map(msg => {
                      const isMine = msg.senderId === authUser?.uid;
                      return (
                        <div key={msg.id} className={`flex ${isMine ? 'justify-end' : 'justify-start'}`}>
                          <div className={`max-w-[80%] px-4 py-2.5 rounded-2xl ${
                            isMine ? 'bg-brand text-white rounded-br-md' : 'glass rounded-bl-md'
                          }`}>
                            {selectedChat.type === 'group' && !isMine && (
                              <p className="text-xs font-semibold text-brand2 mb-1">{msg.senderName}</p>
                            )}
                            {/* Combo/Image Message */}
                            {msg.type === 'combo' && msg.image && (
                              <div className="mb-2">
                                <img src={msg.image} className="rounded-xl max-w-full max-h-64 object-contain" />
                                {msg.items && msg.items.length > 0 && (
                                  <p className={`text-xs mt-1 ${isMine ? 'text-white/70' : 'text-slate-500'}`}>
                                    ðŸ“¸ {msg.items.length} Ã¼rÃ¼nlÃ¼ kombin
                                  </p>
                                )}
                              </div>
                            )}
                            <p className="text-sm">{msg.text}</p>
                            {/* Regular image (not combo) */}
                            {msg.type !== 'combo' && msg.image && (
                              <img src={msg.image} className="mt-2 rounded-lg max-w-full max-h-48 object-contain" />
                            )}
                            <p className={`text-[10px] mt-1 ${isMine ? 'text-white/60' : 'text-slate-400'}`}>
                              {new Date(msg.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                            </p>
                          </div>
                        </div>
                      );
                    })
                  )}
                </div>

                {/* Message Input */}
                <div className="p-4 border-t border-slate-200 flex gap-3">
                  <input
                    type="text"
                    value={newMessage}
                    onChange={e => setNewMessage(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && sendMessage()}
                    placeholder={t('typeMessage')}
                    className="flex-1"
                  />
                  <button onClick={sendMessage} className="btn-primary px-5 rounded-xl">
                    <Icon name="send" size={18} />
                  </button>
                </div>
              </div>
            )}
            
            {/* New Chat Modal */}
            {showNewChat && (
              <div className="fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4">
                <div className="w-full max-w-sm glass rounded-3xl p-6 scale-in max-h-[80vh] overflow-y-auto">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-lg">{t('newMessage')}</h3>
                    <button onClick={() => setShowNewChat(false)} className="p-2 rounded-xl hover:bg-slate-200/60">
                      <Icon name="x" size={20} />
                    </button>
                  </div>
                  
                  <p className="text-sm text-slate-500 mb-4">{t('whoToMessage')}</p>
                  
                  {friends.length === 0 ? (
                    <p className="text-center py-8 text-slate-400 text-sm">
                      {t('notFollowingAnyone')}
                    </p>
                  ) : (
                    <div className="space-y-2">
                      {friends.map(person => (
                        <button
                          key={person.id}
                          onClick={() => startDM(person)}
                          className="w-full glass rounded-xl p-3 flex items-center gap-3 text-left hover:bg-slate-100 transition"
                        >
                          <div className="w-10 h-10 rounded-lg bg-brand flex items-center justify-center overflow-hidden">
                            {person.avatar ? (
                              <img src={person.avatar} className="w-full h-full object-cover" />
                            ) : (
                              <span>ðŸ‘¤</span>
                            )}
                          </div>
                          <div className="flex-1">
                            <div className="font-semibold">{person.name}</div>
                            <div className="text-xs text-slate-500">@{person.username}</div>
                          </div>
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* Create Group Modal */}
            {showCreateGroup && (
              <div className="fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4">
                <div className="w-full max-w-sm glass rounded-3xl p-6 scale-in max-h-[80vh] overflow-y-auto">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-lg">Grup OluÅŸtur</h3>
                    <button onClick={() => { setShowCreateGroup(false); setGroupName(''); setSelectedGroupMembers([]); }} className="p-2 rounded-xl hover:bg-slate-200/60">
                      <Icon name="x" size={20} />
                    </button>
                  </div>
                  
                  <div className="mb-4">
                    <label className="text-xs text-slate-500 mb-1.5 block">Grup AdÄ±</label>
                    <input
                      type="text"
                      value={groupName}
                      onChange={e => setGroupName(e.target.value)}
                      placeholder="Grup adÄ± gir..."
                      maxLength={30}
                    />
                  </div>
                  
                  <p className="text-sm text-slate-500 mb-2">Ãœye ekle (max 6 kiÅŸi)</p>
                  
                  {/* Selected members */}
                  {selectedGroupMembers.length > 0 && (
                    <div className="flex flex-wrap gap-2 mb-4">
                      {selectedGroupMembers.map(m => (
                        <div key={m.uid} className="flex items-center gap-1 bg-brand/10 text-brand px-2 py-1 rounded-lg text-sm">
                          <span>{m.name}</span>
                          <button onClick={() => toggleGroupMember(m)} className="ml-1">
                            <Icon name="x" size={12} />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {friends.length === 0 ? (
                    <p className="text-center py-8 text-slate-400 text-sm">
                      Grup oluÅŸturmak iÃ§in Ã¶nce birilerini takip et
                    </p>
                  ) : (
                    <div className="space-y-2 max-h-48 overflow-y-auto">
                      {friends.map(person => {
                        const isSelected = selectedGroupMembers.some(m => m.uid === person.uid);
                        return (
                          <button
                            key={person.id}
                            onClick={() => toggleGroupMember(person)}
                            className={`w-full rounded-xl p-3 flex items-center gap-3 text-left transition ${
                              isSelected ? 'bg-brand/10 border-2 border-brand' : 'glass hover:bg-slate-100'
                            }`}
                          >
                            <div className="w-10 h-10 rounded-lg bg-brand flex items-center justify-center overflow-hidden">
                              {person.avatar ? (
                                <img src={person.avatar} className="w-full h-full object-cover" />
                              ) : (
                                <span>ðŸ‘¤</span>
                              )}
                            </div>
                            <div className="flex-1">
                              <div className="font-semibold">{person.name}</div>
                              <div className="text-xs text-slate-500">@{person.username}</div>
                            </div>
                            {isSelected && <Icon name="check" size={20} className="text-brand" />}
                          </button>
                        );
                      })}
                    </div>
                  )}
                  
                  <div className="flex gap-3 mt-4">
                    <button onClick={() => { setShowCreateGroup(false); setGroupName(''); setSelectedGroupMembers([]); }} className="flex-1 btn-ghost py-3 rounded-xl font-semibold">Ä°ptal</button>
                    <button 
                      onClick={createGroup}
                      disabled={!groupName.trim() || selectedGroupMembers.length === 0}
                      className="flex-1 btn-primary py-3 rounded-xl font-semibold disabled:opacity-50"
                    >
                      OluÅŸtur
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* NOTIFICATIONS TAB */}
        {tab === 'notifications' && (
          <div className="p-4 space-y-4 fade-in">
            {/* Header with mark all read */}
            <div className="flex items-center justify-between">
              <h3 className="font-bold text-lg">{t('allNotifications')}</h3>
              {unreadNotificationsCount > 0 && (
                <button
                  onClick={markAllNotificationsAsRead}
                  className="text-sm text-brand font-medium hover:underline"
                >
                  {t('markAllRead')}
                </button>
              )}
            </div>
            
            {/* Notifications List */}
            {notifications.length === 0 ? (
              <div className="text-center py-12">
                <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                  <Icon name="bell" size={28} className="text-slate-400" />
                </div>
                <p className="font-semibold text-slate-500">{t('noNotifications')}</p>
                <p className="text-sm text-slate-400 mt-1">{t('noNotificationsDesc')}</p>
              </div>
            ) : (
              <div className="space-y-2">
                {notifications.sort((a, b) => b.createdAt - a.createdAt).map(notification => {
                  // Ä°kon ve renk belirleme
                  let icon = 'bell';
                  let iconBg = 'bg-slate-500';
                  let actionText = '';
                  
                  switch (notification.type) {
                    case 'follow_request':
                      icon = 'userPlus';
                      iconBg = 'bg-blue-500';
                      actionText = t('notificationFollowRequest');
                      break;
                    case 'follow_accept':
                      icon = 'check';
                      iconBg = 'bg-green-500';
                      actionText = t('notificationFollowAccept');
                      break;
                    case 'new_message':
                      icon = 'mail';
                      iconBg = 'bg-purple-500';
                      actionText = t('notificationNewMessage');
                      break;
                    case 'group_invite':
                      icon = 'users';
                      iconBg = 'bg-indigo-500';
                      actionText = t('notificationGroupInvite');
                      break;
                    case 'like':
                      icon = 'heart';
                      iconBg = 'bg-red-500';
                      actionText = t('notificationLike');
                      break;
                    case 'comment':
                      icon = 'message';
                      iconBg = 'bg-amber-500';
                      actionText = t('notificationComment');
                      break;
                    case 'weather':
                      icon = 'sun';
                      iconBg = 'bg-yellow-500';
                      actionText = `${t('notificationWeather')} ${notification.weather || ''}`;
                      break;
                    case 'daily_outfit':
                      icon = 'sparkles';
                      iconBg = 'bg-brand';
                      actionText = t('notificationDailyOutfit');
                      break;
                    case 'referral_reward':
                      icon = 'gift';
                      iconBg = 'bg-gradient-to-r from-brand to-purple-500';
                      actionText = notification.message || '+1 kredi kazandÄ±n!';
                      break;
                    default:
                      icon = 'bell';
                      iconBg = 'bg-slate-500';
                      actionText = notification.message || '';
                  }
                  
                  const timeAgo = ((now) => {
                    const diff = now - notification.createdAt;
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(diff / 3600000);
                    const days = Math.floor(diff / 86400000);
                    if (minutes < 1) return 'Az Ã¶nce';
                    if (minutes < 60) return `${minutes}dk`;
                    if (hours < 24) return `${hours}sa`;
                    return `${days}g`;
                  })(Date.now());
                  
                  return (
                    <button
                      key={notification.id}
                      onClick={() => handleNotificationClick(notification)}
                      className={`w-full glass rounded-2xl p-3 flex items-start gap-3 text-left transition hover:bg-slate-100 ${!notification.read ? 'ring-2 ring-brand/30 bg-brand/5' : ''}`}
                    >
                      {/* Avatar or Icon */}
                      {notification.senderAvatar ? (
                        <div className="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                          <img src={notification.senderAvatar} className="w-full h-full object-cover" />
                        </div>
                      ) : (
                        <div className={`w-10 h-10 rounded-full ${iconBg} flex items-center justify-center flex-shrink-0`}>
                          <Icon name={icon} size={18} className="text-white" />
                        </div>
                      )}
                      
                      {/* Content */}
                      <div className="flex-1 min-w-0">
                        <p className="text-sm">
                          {notification.senderName && (
                            <span className="font-semibold">{notification.senderName} </span>
                          )}
                          <span className="text-slate-600">{actionText}</span>
                        </p>
                        {notification.preview && (
                          <p className="text-xs text-slate-500 truncate mt-0.5">{notification.preview}</p>
                        )}
                        <p className="text-[10px] text-slate-400 mt-1">{timeAgo}</p>
                      </div>
                      
                      {/* Unread indicator */}
                      {!notification.read && (
                        <div className="w-2 h-2 rounded-full bg-brand flex-shrink-0 mt-2" />
                      )}
                      
                      {/* Arrow */}
                      <Icon name="chevronRight" size={16} className="text-slate-400 flex-shrink-0 mt-2" />
                    </button>
                  );
                })}
              </div>
            )}
          </div>
        )}

        {/* SETTINGS TAB */}
        {tab === 'settings' && (
          <div className="p-4 space-y-4 fade-in">
            {/* Language Settings */}
            <div className="glass rounded-2xl p-4 space-y-4">
              <h3 className="font-semibold text-sm flex items-center gap-2">
                <Icon name="globe" size={16} className="text-brand2" />
                {t('languagePreference')}
              </h3>
              <div className="flex gap-2">
                <button
                  onClick={() => changeLanguage('tr')}
                  className={`flex-1 py-3 rounded-xl font-semibold text-sm transition-all ${currentLanguage === 'tr' ? 'bg-brand text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                >
                  ðŸ‡¹ðŸ‡· TÃ¼rkÃ§e
                </button>
                <button
                  onClick={() => changeLanguage('en')}
                  className={`flex-1 py-3 rounded-xl font-semibold text-sm transition-all ${currentLanguage === 'en' ? 'bg-brand text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                >
                  ðŸ‡¬ðŸ‡§ English
                </button>
              </div>
            </div>

            {/* Privacy Settings */}
            <div className="glass rounded-2xl p-4 space-y-4">
              <h3 className="font-semibold text-sm flex items-center gap-2">
                <Icon name="shield" size={16} className="text-brand2" />
                {t('privacySettings')}
              </h3>

              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">{t('profileVisibility')}</div>
                  <div className="text-xs text-slate-500">{t('profileVisibilityDesc')}</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, profilePublic: !s.profilePublic }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.profilePublic ? 'bg-brand' : 'bg-slate-200/60'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.profilePublic ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>

              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">{t('shareCombos')}</div>
                  <div className="text-xs text-slate-500">{t('shareCombosDesc')}</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, combosPublic: !s.combosPublic }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.combosPublic ? 'bg-brand' : 'bg-slate-200/60'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.combosPublic ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>

              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">{t('onlineStatus')}</div>
                  <div className="text-xs text-slate-500">{t('onlineStatusDesc')}</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, showOnline: !s.showOnline }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.showOnline ? 'bg-brand' : 'bg-slate-200/60'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.showOnline ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>
            </div>

            {/* Notification Settings */}
            <div className="glass rounded-2xl p-4 space-y-4">
              <h3 className="font-semibold text-sm flex items-center gap-2">
                <Icon name="bell" size={16} className="text-accent" />
                {t('notifications')}
              </h3>

              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">{t('messageNotifications')}</div>
                  <div className="text-xs text-slate-500">{t('messageNotificationsDesc')}</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, notifyMessages: !s.notifyMessages }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.notifyMessages ? 'bg-brand' : 'bg-slate-200/60'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.notifyMessages ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>

              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">{t('messageRequests')}</div>
                  <div className="text-xs text-slate-500">{t('messageRequestsDesc')}</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, notifyFriends: !s.notifyFriends }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.notifyFriends ? 'bg-brand' : 'bg-slate-200/60'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.notifyFriends ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>
              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">{t('dailyOutfitSuggestion')}</div>
                  <div className="text-xs text-slate-500">{t('dailyOutfitSuggestionDesc')}</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, notifyDailyOutfit: !s.notifyDailyOutfit }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.notifyDailyOutfit ? 'bg-brand' : 'bg-slate-200/60'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.notifyDailyOutfit ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>
            </div>

            {/* App Info */}
            <div className="glass rounded-2xl p-4 space-y-3">
              <h3 className="font-semibold text-sm flex items-center gap-2">
                <Icon name="info" size={16} className="text-slate-500" />
                {t('application')}
              </h3>
              <div className="flex justify-between items-center py-2 border-b border-slate-200">
                <span className="text-slate-500 text-sm">{t('version')}</span>
                <span className="text-sm font-medium">1.0.0</span>
              </div>
              <div className="flex justify-between items-center py-2 border-b border-slate-200">
                <span className="text-slate-500 text-sm">{t('developer')}</span>
                <span className="text-sm font-medium">TrAi Style Moda Ve Yapay Zeka Teknolojileri</span>
              </div>
            </div>

            {/* Danger Zone */}
            <div className="glass rounded-2xl p-4 border border-red-500/20">
              <h3 className="font-semibold text-sm text-red-400 mb-3 flex items-center gap-2">
                <Icon name="trash" size={16} />
                {t('dangerZone')}
              </h3>
              
              {/* Clear Local Data */}
              <div className="mb-4 pb-4 border-b border-slate-200">
                <p className="text-xs text-slate-500 mb-2">{t('clearCacheDesc')}</p>
                <button 
                  onClick={() => {
                    if (confirm(t('clearCacheConfirm'))) {
                      if (authUser) {
                        localStorage.removeItem(`trai_tryoncache_${authUser.uid}`);
                        localStorage.removeItem(`trai_history_${authUser.uid}`);
                      }
                      window.location.reload();
                    }
                  }}
                  className="w-full bg-orange-500/10 hover:bg-orange-500/20 border border-orange-500/20 text-orange-400 py-2.5 rounded-xl text-sm font-semibold flex items-center justify-center gap-2"
                >
                  <Icon name="trash" size={14} />
                  {t('clearCache')}
                </button>
              </div>
              
              {/* Delete Account - KVKK Compliant */}
              <div className="space-y-3">
                <div className="bg-red-50 rounded-xl p-3 border border-red-200">
                  <p className="text-xs font-semibold text-red-600 mb-2">âš ï¸ {t('deleteAccountWarning')}</p>
                  <ul className="text-[11px] text-red-500 space-y-1 ml-2">
                    <li>â€¢ {currentLanguage === 'tr' ? 'YÃ¼klediÄŸiniz tÃ¼m fotoÄŸraflar' : 'All your uploaded photos'}</li>
                    <li>â€¢ {currentLanguage === 'tr' ? 'OluÅŸturulan tÃ¼m sanal deneme gÃ¶rselleri' : 'All created virtual try-on images'}</li>
                    <li>â€¢ {currentLanguage === 'tr' ? 'Sanal ikiz verileri' : 'Virtual twin data'}</li>
                    <li>â€¢ {currentLanguage === 'tr' ? 'Hesap bilgileriniz' : 'Your account information'}</li>
                  </ul>
                  <p className="text-[11px] text-red-500 mt-2 font-medium">{currentLanguage === 'tr' ? 'DERHAL ve KALICI OLARAK SÄ°LÄ°NÄ°R.' : 'Will be IMMEDIATELY and PERMANENTLY DELETED.'}</p>
                </div>
                <p className="text-[10px] text-slate-400">{currentLanguage === 'tr' ? 'Hesap silme talebiniz KVKK kapsamÄ±nda derhal iÅŸleme alÄ±nÄ±r ve en geÃ§ 24 saat iÃ§inde tamamlanÄ±r.' : 'Your account deletion request will be processed immediately under GDPR and completed within 24 hours.'}</p>
                <button 
                  onClick={onDeleteAccount}
                  className="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl text-sm font-semibold flex items-center justify-center gap-2 transition"
                >
                  <Icon name="trash" size={16} />
                  {t('permanentlyDelete')}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// ============ MODALS ============

// Size Selection Modal - Ask size before adding to cart
const SizeSelectionModal = ({ open, product, currentIndex, totalItems, onSelect, onClose, userMeasurements }) => {
  const [selectedSize, setSelectedSize] = useState(null);
  const [aiRecommendation, setAiRecommendation] = useState(null);
  const [loadingAI, setLoadingAI] = useState(false);
  
  const SIZES = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];
  
  // Fetch AI recommendation on open
  React.useEffect(() => {
    if (open && product && userMeasurements) {
      fetchAIRecommendation();
    }
    return () => {
      setAiRecommendation(null);
      setSelectedSize(null);
    };
  }, [open, product?.id]);
  
  const fetchAIRecommendation = async () => {
    if (!userMeasurements?.height || !userMeasurements?.weight) return;
    
    setLoadingAI(true);
    try {
      const prompt = `Sen bir moda ve beden danÄ±ÅŸmanÄ±sÄ±n. KullanÄ±cÄ±ya online alÄ±ÅŸveriÅŸ iÃ§in beden Ã¶nerisi yapacaksÄ±n.

ÃœRÃœN BÄ°LGÄ°SÄ°:
- Marka: ${product.brandName || 'Bilinmiyor'}
- ÃœrÃ¼n: ${product.name}
- Kategori: ${product.type || product.category}
- Renk: ${product.color || 'BelirtilmemiÅŸ'}

KULLANICI Ã–LÃ‡ÃœLER:
- Boy: ${userMeasurements.height} cm
- Kilo: ${userMeasurements.weight} kg
- VÃ¼cut Tipi: ${userMeasurements.bodyType || 'normal'}
- Cinsiyet: ${product.gender === 'male' ? 'Erkek' : 'KadÄ±n'}

GÃ–REV:
1. Bu marka ve Ã¼rÃ¼n tipi iÃ§in internet yorumlarÄ±nÄ± ve beden tablolarÄ±nÄ± dÃ¼ÅŸÃ¼nerek analiz yap
2. TÃ¼rk markalarÄ±nÄ±n genelde dar kesim olduÄŸunu, uluslararasÄ± markalarÄ±n farklÄ± kalÄ±plara sahip olduÄŸunu dikkate al
3. KullanÄ±cÄ±nÄ±n vÃ¼cut tipine gÃ¶re rahat mÄ± yoksa slim fit mi tercih edeceÄŸini deÄŸerlendir

CEVAP FORMATI (sadece JSON, baÅŸka bir ÅŸey yazma):
{
  "size": "M",
  "confidence": "yÃ¼ksek",
  "reason": "KÄ±sa ve Ã¶z aÃ§Ä±klama (max 50 kelime)",
  "tip": "KullanÄ±cÄ±ya Ã¶zel ipucu (max 20 kelime)"
}`;

      const apiUrl = CONFIG.useApiRoute ? '/api/gemini' : `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.textModel}:generateContent`;
      const headers = { "Content-Type": "application/json" };
      
      const res = await fetch(apiUrl, {
        method: "POST",
        headers,
        body: JSON.stringify({
          model: CONFIG.textModel,
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.3, maxOutputTokens: 300 }
        })
      });
      
      const data = await res.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (text) {
        // Extract JSON from response
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          const parsed = JSON.parse(jsonMatch[0]);
          setAiRecommendation(parsed);
          setSelectedSize(parsed.size);
        }
      }
    } catch (e) {
      console.error('AI recommendation error:', e);
      // Fallback to simple BMI-based recommendation
      const heightM = userMeasurements.height / 100;
      const bmi = userMeasurements.weight / (heightM * heightM);
      const isMale = product?.gender === 'male';
      let fallbackSize = 'M';
      if (bmi < 18.5) fallbackSize = isMale ? 'S' : 'XS';
      else if (bmi < 22) fallbackSize = isMale ? 'M' : 'S';
      else if (bmi < 25) fallbackSize = isMale ? 'L' : 'M';
      else if (bmi < 28) fallbackSize = isMale ? 'XL' : 'L';
      else fallbackSize = 'XL';
      setAiRecommendation({ size: fallbackSize, reason: 'VÃ¼cut Ã¶lÃ§Ã¼lerinize gÃ¶re hesaplandÄ±', confidence: 'orta' });
      setSelectedSize(fallbackSize);
    } finally {
      setLoadingAI(false);
    }
  };
  
  if (!open || !product) return null;
  
  return (
    <div className="fixed inset-0 z-[110] bg-black/85 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="w-full max-w-sm bg-surface rounded-3xl overflow-hidden slide-up max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="p-4 border-b border-slate-200">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="font-bold text-lg">Beden SeÃ§</h2>
              {totalItems > 1 && (
                <p className="text-xs text-slate-500">{currentIndex}/{totalItems} Ã¼rÃ¼n</p>
              )}
            </div>
            <button onClick={onClose} className="p-2 rounded-xl hover:bg-slate-100">
              <Icon name="x" size={20} />
            </button>
          </div>
        </div>
        
        {/* Product Preview */}
        <div className="p-4 flex gap-3 items-center border-b border-slate-100">
          <div className="w-16 h-20 rounded-xl overflow-hidden bg-slate-100 flex-shrink-0">
            {product.image && <img src={product.image} className="w-full h-full object-cover" />}
          </div>
          <div className="flex-1 min-w-0">
            <p className="font-semibold text-sm truncate">{product.name}</p>
            <p className="text-xs text-slate-500">{product.brandName}</p>
            <p className="text-sm font-bold text-brand mt-1">{product.price}</p>
          </div>
        </div>
        
        {/* AI Recommendation Loading */}
        {loadingAI && (
          <div className="px-4 pt-4">
            <div className="bg-gradient-to-r from-brand/5 to-purple-500/5 border border-brand/20 rounded-xl p-4">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-brand/20 flex items-center justify-center animate-pulse">
                  <span className="text-lg">âœ¨</span>
                </div>
                <div className="flex-1">
                  <p className="font-semibold text-sm text-brand">AI Beden Analizi</p>
                  <p className="text-xs text-slate-500">VÃ¼cut Ã¶lÃ§Ã¼lerinize gÃ¶re Ã¶neri alÄ±nÄ±yor...</p>
                </div>
                <div className="w-5 h-5 border-2 border-brand/30 border-t-brand rounded-full animate-spin" />
              </div>
            </div>
          </div>
        )}
        
        {/* AI Recommendation Result */}
        {aiRecommendation && !loadingAI && (
          <div className="px-4 pt-4">
            <div className="bg-gradient-to-r from-brand/10 to-purple-500/10 border border-brand/30 rounded-xl p-4">
              <div className="flex items-start gap-3">
                <div className="w-12 h-12 rounded-full bg-brand flex items-center justify-center flex-shrink-0">
                  <span className="text-xl font-bold text-white">{aiRecommendation.size}</span>
                </div>
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-1">
                    <p className="font-bold text-sm">AI Ã–nerisi: {aiRecommendation.size}</p>
                    {aiRecommendation.confidence === 'yÃ¼ksek' && (
                      <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">GÃ¼venilir</span>
                    )}
                  </div>
                  <p className="text-xs text-slate-600 leading-relaxed">{aiRecommendation.reason}</p>
                  {aiRecommendation.tip && (
                    <p className="text-xs text-brand mt-2 font-medium">ðŸ’¡ {aiRecommendation.tip}</p>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}
        
        {/* Size Grid */}
        <div className="p-4">
          <p className="text-xs font-semibold text-slate-500 mb-3">BEDEN SEÃ‡</p>
          <div className="grid grid-cols-3 gap-2">
            {SIZES.map(size => (
              <button
                key={size}
                onClick={() => setSelectedSize(size)}
                className={`py-3 rounded-xl font-bold text-sm transition-all ${
                  selectedSize === size
                    ? 'bg-brand text-white shadow-lg scale-105'
                    : size === aiRecommendation?.size
                      ? 'bg-brand/10 text-brand border-2 border-brand/30'
                      : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                }`}
              >
                {size}
                {size === aiRecommendation?.size && selectedSize !== size && (
                  <span className="block text-[9px] font-normal">AI Ã–nerisi</span>
                )}
              </button>
            ))}
          </div>
        </div>
        
        {/* Confirm Button */}
        <div className="p-4 pt-0">
          <button
            onClick={() => {
              if (selectedSize) {
                onSelect(selectedSize);
                setSelectedSize(null);
                setAiRecommendation(null);
              }
            }}
            disabled={!selectedSize || loadingAI}
            className={`w-full py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 transition-all ${
              selectedSize && !loadingAI
                ? 'bg-brand text-white'
                : 'bg-slate-200 text-slate-400 cursor-not-allowed'
            }`}
          >
            <Icon name="shop" size={18} />
            {loadingAI ? 'Ã–neri AlÄ±nÄ±yor...' : selectedSize ? `${selectedSize} Beden Ekle` : 'Beden SeÃ§'}
          </button>
        </div>
      </div>
    </div>
  );
};

// DM Share Modal - Share combo to followers
const DMShareModal = ({ open, image, items, friends, groups, onClose, onSend, currentUserId }) => {
  const [selectedUsers, setSelectedUsers] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  
  if (!open) return null;
  
  const filteredFriends = friends.filter(f => 
    f.displayName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
    f.username?.toLowerCase().includes(searchQuery.toLowerCase())
  );
  
  const toggleUser = (userId) => {
    setSelectedUsers(prev => 
      prev.includes(userId) 
        ? prev.filter(id => id !== userId)
        : [...prev, userId]
    );
  };
  
  const handleSend = () => {
    if (selectedUsers.length === 0) return;
    onSend(selectedUsers, image, items);
    setSelectedUsers([]);
    onClose();
  };
  
  return (
    <div className="fixed inset-0 z-[100] bg-black/85 backdrop-blur-sm flex items-end justify-center">
      <div className="w-full max-w-lg bg-surface rounded-t-3xl max-h-[80vh] flex flex-col slide-up">
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-slate-200">
          <h2 className="font-bold text-lg">Kombini PaylaÅŸ</h2>
          <button onClick={onClose} className="p-2 rounded-xl hover:bg-slate-100">
            <Icon name="x" size={20} />
          </button>
        </div>
        
        {/* Preview */}
        <div className="p-4 border-b border-slate-200">
          <div className="flex gap-3 items-center">
            <div className="w-16 h-20 rounded-xl overflow-hidden bg-slate-100">
              {image && <img src={image} className="w-full h-full object-cover" />}
            </div>
            <div>
              <p className="font-semibold text-sm">Kombin GÃ¶rseli</p>
              <p className="text-xs text-slate-500">{items?.length || 0} Ã¼rÃ¼n</p>
            </div>
          </div>
        </div>
        
        {/* Search */}
        <div className="p-4 pb-2">
          <div className="relative">
            <Icon name="search" size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
            <input
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="TakipÃ§i ara..."
              className="w-full pl-10 py-2.5 rounded-xl bg-slate-100 border-none text-sm"
            />
          </div>
        </div>
        
        {/* Users List */}
        <div className="flex-1 overflow-y-auto p-4 pt-2">
          {filteredFriends.length === 0 ? (
            <div className="text-center py-8">
              <Icon name="users" size={32} className="mx-auto text-slate-300 mb-2" />
              <p className="text-slate-500 text-sm">HenÃ¼z takipÃ§in yok</p>
              <p className="text-slate-400 text-xs">Sosyal sekmesinden arkadaÅŸ ekle</p>
            </div>
          ) : (
            <div className="space-y-2">
              {filteredFriends.map(friend => (
                <button
                  key={friend.id}
                  onClick={() => toggleUser(friend.id)}
                  className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${
                    selectedUsers.includes(friend.id)
                      ? 'bg-brand/10 border-2 border-brand'
                      : 'bg-slate-50 hover:bg-slate-100 border-2 border-transparent'
                  }`}
                >
                  <img 
                    src={friend.profilePhoto || friend.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${friend.id}`}
                    className="w-12 h-12 rounded-full object-cover"
                  />
                  <div className="flex-1 text-left">
                    <p className="font-semibold text-sm">{friend.displayName || friend.username || 'KullanÄ±cÄ±'}</p>
                    {friend.username && <p className="text-xs text-slate-500">@{friend.username}</p>}
                  </div>
                  <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                    selectedUsers.includes(friend.id)
                      ? 'bg-brand border-brand'
                      : 'border-slate-300'
                  }`}>
                    {selectedUsers.includes(friend.id) && (
                      <Icon name="check" size={14} className="text-white" />
                    )}
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>
        
        {/* Send Button */}
        <div className="p-4 border-t border-slate-200">
          <button
            onClick={handleSend}
            disabled={selectedUsers.length === 0}
            className={`w-full py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 transition-all ${
              selectedUsers.length > 0
                ? 'bg-brand text-white'
                : 'bg-slate-200 text-slate-400 cursor-not-allowed'
            }`}
          >
            <Icon name="send" size={18} />
            {selectedUsers.length > 0 
              ? `${selectedUsers.length} KiÅŸiye GÃ¶nder`
              : 'KiÅŸi SeÃ§'
            }
          </button>
        </div>
      </div>
    </div>
  );
};

// Cart Modal - Trendyol Checkout System
const CartModal = ({ open, cart, onClose, onRemove, onUpdateQuantity, total }) => {
  const [clickedItems, setClickedItems] = useState([]);
  const [stockStatus, setStockStatus] = useState({});
  const [checkingStock, setCheckingStock] = useState(false);
  const [openPopups, setOpenPopups] = useState([]); // Track opened popups
  const [currentStep, setCurrentStep] = useState(1); // 1: Review, 2: Adding, 3: Done
  
  // Reset when modal opens
  useEffect(() => {
    if (open) {
      setClickedItems([]);
      setCurrentStep(1);
      setOpenPopups([]);
    }
  }, [open]);
  
  // Cleanup popups on unmount
  useEffect(() => {
    return () => {
      openPopups.forEach(popup => {
        try { if (popup && !popup.closed) popup.close(); } catch(e) {}
      });
    };
  }, []);
  
  if (!open) return null;
  
  // Check if all items have been clicked (added to Trendyol cart)
  const isAllClicked = cart.length > 0 && cart.every(item => clickedItems.includes(item.id));
  
  // Calculate total price
  const totalPrice = cart.reduce((sum, item) => {
    const price = item.priceNum || 0;
    return sum + (price * (item.quantity || 1));
  }, 0);
  
  // Build Trendyol URL with size parameter
  const buildTrendyolUrl = (item) => {
    if (!item.link) return null;
    
    let url = item.link;
    
    // Add size parameter if selected
    if (item.selectedSize) {
      const separator = url.includes('?') ? '&' : '?';
      url += `${separator}size=${encodeURIComponent(item.selectedSize)}`;
    }
    
    return url;
  };
  
  // Handle product click - open in popup window
  const handleProductClick = (item) => {
    const url = buildTrendyolUrl(item);
    if (url) {
      // Daha geniÅŸ popup - sepete ekle butonu gÃ¶rÃ¼nsÃ¼n
      const width = 900;
      const height = 950;
      const left = (window.screen.width - width) / 2;
      const top = (window.screen.height - height) / 2;
      
      const popup = window.open(
        url, 
        `trendyol_${item.id}`, 
        `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`
      );
      
      // Track popup reference
      if (popup) {
        setOpenPopups(prev => [...prev, popup]);
        
        // Auto-focus back to main window after 2 seconds (hint to user)
        setTimeout(() => {
          try { window.focus(); } catch(e) {}
        }, 3000);
      }
    }
    
    // Mark as clicked
    if (!clickedItems.includes(item.id)) {
      setClickedItems(prev => [...prev, item.id]);
      setCurrentStep(2);
    }
  };
  
  // Close all opened popups
  const handleCloseAllPopups = () => {
    let closedCount = 0;
    openPopups.forEach(popup => {
      try {
        if (popup && !popup.closed) {
          popup.close();
          closedCount++;
        }
      } catch(e) {
        console.log('Could not close popup');
      }
    });
    setOpenPopups([]);
    window.focus();
    return closedCount;
  };
  
  // Go to Trendyol cart
  const handleGoToTrendyolCart = () => {
    handleCloseAllPopups();
    setCurrentStep(3);
    window.open('https://www.trendyol.com/sepetim', '_blank');
  };
  
  return (
    <div className="fixed inset-0 z-[100] bg-black/85 backdrop-blur-sm flex items-end justify-center">
      <div className="w-full max-w-lg bg-surface rounded-t-3xl max-h-[90vh] flex flex-col slide-up">
        
        {/* Header */}
        <div className="bg-gradient-to-r from-orange-500 to-orange-600 p-5 rounded-t-3xl text-white">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center">
                <Icon name="shop" size={24} />
              </div>
              <div>
                <h2 className="font-bold text-lg">Kombini Tamamla</h2>
                <p className="text-orange-100 text-sm">
                  {cart.length} Ã¼rÃ¼n â€¢ Trendyol'a yÃ¶nlendirileceksin
                </p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 rounded-xl hover:bg-white/20 transition">
              <Icon name="x" size={20} />
            </button>
          </div>
          
          {/* Progress indicator */}
          {cart.length > 0 && (
            <div className="mt-4">
              <div className="flex justify-between text-xs text-orange-100 mb-2">
                <span>Sepete eklenen Ã¼rÃ¼nler</span>
                <span>{clickedItems.length}/{cart.length}</span>
              </div>
              <div className="h-2 bg-white/20 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-white rounded-full transition-all duration-300"
                  style={{ width: `${(clickedItems.length / cart.length) * 100}%` }}
                />
              </div>
            </div>
          )}
        </div>
        
        {/* Products List */}
        <div className="flex-1 overflow-y-auto p-4 space-y-3">
          {cart.length === 0 ? (
            <div className="text-center py-12">
              <Icon name="shop" size={48} className="mx-auto text-slate-300 mb-4" />
              <p className="text-slate-500 font-medium">Sepetiniz boÅŸ</p>
              <p className="text-slate-400 text-sm mt-1">KeÅŸfet'ten Ã¼rÃ¼n ekleyin</p>
            </div>
          ) : (
            <>
              {/* Step-based Instructions */}
              {currentStep === 1 && (
                <div className="bg-blue-50 border border-blue-200 rounded-xl p-3">
                  <div className="flex items-start gap-3">
                    <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center flex-shrink-0 font-bold">1</div>
                    <div>
                      <p className="font-semibold text-blue-700">ÃœrÃ¼nleri Trendyol'a Ekle</p>
                      <p className="text-blue-600 text-xs mt-1">
                        Her Ã¼rÃ¼ne tÄ±kla â†’ AÃ§Ä±lan pencerede "Sepete Ekle" butonuna bas
                      </p>
                    </div>
                  </div>
                </div>
              )}
              
              {currentStep === 2 && (
                <div className="bg-amber-50 border border-amber-200 rounded-xl p-3">
                  <div className="flex items-start gap-3">
                    <div className="w-8 h-8 rounded-full bg-amber-500 text-white flex items-center justify-center flex-shrink-0 font-bold">2</div>
                    <div className="flex-1">
                      <p className="font-semibold text-amber-700">Trendyol'da Sepete Ekle</p>
                      <p className="text-amber-600 text-xs mt-1">
                        AÃ§Ä±lan pencerede "Sepete Ekle" butonuna tÄ±kla, sonra buraya dÃ¶n
                      </p>
                      {openPopups.length > 0 && (
                        <button 
                          onClick={() => {
                            const count = handleCloseAllPopups();
                            if (count > 0) window.focus();
                          }}
                          className="mt-2 text-xs bg-amber-500 text-white px-3 py-1.5 rounded-lg font-semibold flex items-center gap-1"
                        >
                          <Icon name="x" size={12} />
                          Pencereleri Kapat & Buraya DÃ¶n
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              )}
              
              {currentStep === 3 && (
                <div className="bg-green-50 border border-green-200 rounded-xl p-3">
                  <div className="flex items-start gap-3">
                    <div className="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center flex-shrink-0">
                      <Icon name="check" size={16} />
                    </div>
                    <div>
                      <p className="font-semibold text-green-700">Harika! ðŸŽ‰</p>
                      <p className="text-green-600 text-xs mt-1">
                        Trendyol sepetinize yÃ¶nlendirildiniz. Ä°yi alÄ±ÅŸveriÅŸler!
                      </p>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Product Cards */}
              {cart.map((item, index) => {
                const isClicked = clickedItems.includes(item.id);
                const hasLink = !!item.link;
                
                return (
                  <div 
                    key={item.id}
                    className={`rounded-xl border-2 p-3 transition-all ${
                      isClicked 
                        ? 'border-green-400 bg-green-50' 
                        : 'border-slate-200 hover:border-orange-300 bg-white'
                    }`}
                  >
                    <div className="flex gap-3">
                      {/* Product Image */}
                      <div className="relative">
                        <img 
                          src={item.image} 
                          alt={item.name}
                          className="w-20 h-24 rounded-lg object-cover"
                        />
                        {isClicked && (
                          <div className="absolute inset-0 bg-green-500/20 rounded-lg flex items-center justify-center">
                            <div className="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                              <Icon name="check" size={16} className="text-white" />
                            </div>
                          </div>
                        )}
                        {/* Step number */}
                        <div className={`absolute -top-2 -left-2 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                          isClicked ? 'bg-green-500 text-white' : 'bg-orange-500 text-white'
                        }`}>
                          {index + 1}
                        </div>
                      </div>
                      
                      {/* Product Info */}
                      <div className="flex-1 min-w-0">
                        <p className="text-xs text-slate-500 font-semibold">{item.brandName}</p>
                        <p className="font-medium text-sm text-slate-800 line-clamp-2">{item.name}</p>
                        {item.selectedSize && (
                          <p className="text-xs text-slate-400 mt-0.5">Beden: {item.selectedSize}</p>
                        )}
                        <p className="text-orange-600 font-bold mt-1">
                          {item.priceNum > 0 ? `${item.priceNum.toLocaleString('tr-TR')} TL` : 'Fiyat iÃ§in tÄ±kla'}
                        </p>
                      </div>
                      
                      {/* Action Button */}
                      <div className="flex flex-col items-end justify-between">
                        <button
                          onClick={() => onRemove(item.id)}
                          className="p-1.5 text-slate-400 hover:text-red-500 transition"
                        >
                          <Icon name="trash" size={16} />
                        </button>
                        
                        {hasLink ? (
                          <button
                            onClick={() => handleProductClick(item)}
                            className={`px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-all ${
                              isClicked 
                                ? 'bg-green-100 text-green-700' 
                                : 'bg-orange-500 text-white hover:bg-orange-600'
                            }`}
                          >
                            {isClicked ? (
                              <>
                                <Icon name="check" size={14} />
                                Eklendi
                              </>
                            ) : (
                              <>
                                <Icon name="externalLink" size={12} />
                                Trendyol'da Beden SeÃ§
                              </>
                            )}
                          </button>
                        ) : (
                          <span className="text-xs text-slate-400">Link yok</span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </>
          )}
        </div>
        
        {/* Footer */}
        {cart.length > 0 && (
          <div className="p-5 border-t border-slate-200 bg-slate-50 space-y-3">
            {/* Total */}
            <div className="flex justify-between items-center">
              <span className="text-slate-500">Tahmini Toplam:</span>
              <span className="text-2xl font-bold text-slate-900">
                {totalPrice > 0 ? `${totalPrice.toLocaleString('tr-TR')} TL` : 'â€”'}
              </span>
            </div>
            
            {/* Go to Trendyol Cart Button */}
            <button
              onClick={handleGoToTrendyolCart}
              disabled={!isAllClicked}
              className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition-all ${
                isAllClicked 
                  ? 'bg-orange-500 text-white hover:bg-orange-600 shadow-lg shadow-orange-500/30' 
                  : 'bg-slate-200 text-slate-400 cursor-not-allowed'
              }`}
            >
              {isAllClicked ? (
                <>
                  <Icon name="externalLink" size={20} />
                  Trendyol Sepetine Git
                </>
              ) : (
                <>
                  <Icon name="shop" size={20} />
                  Ã–nce ÃœrÃ¼nleri Sepete Ekle
                </>
              )}
            </button>
            
            {!isAllClicked && (
              <p className="text-xs text-center text-slate-400">
                Butonu aktifleÅŸtirmek iÃ§in yukarÄ±daki tÃ¼m Ã¼rÃ¼nlere tÄ±klayÄ±p Trendyol sepetine ekle
              </p>
            )}
            
            {/* Disclaimer */}
            <p className="text-[10px] text-slate-400 text-center">
              Bu uygulama Trendyol'un resmi uygulamasÄ± deÄŸildir. SatÄ±n alma iÅŸlemi Trendyol Ã¼zerinden gerÃ§ekleÅŸir.
            </p>
          </div>
        )}
      </div>
    </div>
  );
};

// Paywall Modal - Strategic paywall for premium features
const PaywallModal = ({ open, onClose, type, user, onPurchase }) => {
  if (!open) return null;
  
  // Check remaining tries - evrensel kredi sistemi
  const remainingTries = (user?.freeAvatarTry || 0) + (user?.freeShopTry || 0) + (user?.freeComboTry || 0) + (user?.credits || 0);
  
  const paywallContent = {
    weeklyTries: {
      title: 'Deneme HaklarÄ±n AzalÄ±yor!',
      desc: 'KÄ±yafetleri Ã¼zerinde denemek iÃ§in hak gerekli',
      highlight: `Kalan: ${remainingTries} deneme hakkÄ±`,
      gradient: 'from-brand to-purple-600',
      recommendedPlan: 'bronze',
      plans: ['starter', 'bronze', 'silver']
    },
    comboTries: {
      title: 'Kombin HaklarÄ±n AzalÄ±yor!',
      desc: 'Kombin oluÅŸturup denemek iÃ§in hak gerekli',
      highlight: `Kalan: ${remainingTries} deneme hakkÄ±`,
      gradient: 'from-purple-500 to-pink-500',
      recommendedPlan: 'silver',
      plans: ['bronze', 'silver', 'gold']
    },
    noCredits: {
      title: 'Deneme HakkÄ±n Bitti!',
      desc: 'KÄ±yafetleri sanal olarak denemek iÃ§in paket al',
      highlight: 'Kalan: 0 deneme hakkÄ±',
      gradient: 'from-amber-500 to-orange-500',
      recommendedPlan: 'starter',
      plans: ['starter', 'bronze', 'silver']
    },
    videoAccess: {
      title: 'Video Paketi Gerekli',
      desc: 'Kombinlerinle kÄ±sa moda videolarÄ± oluÅŸtur',
      highlight: `Video hakkÄ±: ${user?.videoTokens || 0}`,
      gradient: 'from-blue-500 to-cyan-500',
      recommendedPlan: 'video5',
      plans: ['video5', 'video10']
    },
    clothingUpload: {
      title: 'KÄ±yafet YÃ¼kleme Limiti Doldu',
      desc: 'Kendi kÄ±yafetlerini fotoÄŸraflayÄ±p yÃ¼kle, AI ile Ã¼zerinde dene',
      highlight: `YÃ¼klenen: ${user?.clothingUploadCount || 0}/${user?.clothingUploadLimit || 5}`,
      gradient: 'from-green-500 to-teal-500',
      recommendedPlan: 'bronze',
      plans: ['starter', 'bronze', 'silver']
    }
  };
  
  const content = paywallContent[type] || paywallContent.weeklyTries;
  
  const planDetails = {
    starter: { 
      name: 'BaÅŸlangÄ±Ã§', 
      price: 29, 
      features: ['10 sanal deneme hakkÄ±', '10 kÄ±yafet yÃ¼kleme hakkÄ±', 'Tek seferlik'],
      desc: 'Tek seferlik paket' 
    },
    bronze: { 
      name: 'Bronze', 
      price: 69, 
      features: ['30 sanal deneme hakkÄ±', '30 kÄ±yafet yÃ¼kleme hakkÄ±', 'AylÄ±k yenilenir'],
      desc: 'AylÄ±k abonelik' 
    },
    silver: { 
      name: 'Silver', 
      price: 119, 
      features: ['70 sanal deneme hakkÄ±', '70 kÄ±yafet yÃ¼kleme hakkÄ±', 'Full HD Ã§Ä±ktÄ±', 'AylÄ±k yenilenir'],
      desc: 'En popÃ¼ler' 
    },
    gold: { 
      name: 'Gold', 
      price: 169, 
      features: ['150 sanal deneme hakkÄ±', '150 kÄ±yafet yÃ¼kleme hakkÄ±', '4K Ã§Ä±ktÄ±', 'Watermark YOK', 'AylÄ±k yenilenir'],
      desc: 'Tam deneyim' 
    },
    video5: { 
      name: '5 Video Paketi', 
      price: 149, 
      features: ['5 video oluÅŸturma hakkÄ±', '6 saniyelik moda videolarÄ±'],
      desc: 'Video paketi' 
    },
    video10: { 
      name: '10 Video Paketi', 
      price: 249, 
      features: ['10 video oluÅŸturma hakkÄ±', '6 saniyelik moda videolarÄ±', '%17 tasarruf'],
      desc: 'AvantajlÄ± paket' 
    }
  };
  
  return (
    <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="w-full max-w-sm bg-white rounded-3xl overflow-hidden scale-in">
        {/* Header */}
        <div className={`bg-gradient-to-br ${content.gradient} p-5 text-white text-center`}>
          <h2 className="text-xl font-bold">{content.title}</h2>
          <p className="text-white/80 text-sm mt-1">{content.desc}</p>
          <div className="mt-3 inline-block bg-white/20 px-4 py-1.5 rounded-full text-sm font-semibold">
            {content.highlight}
          </div>
        </div>
        
        {/* Plans */}
        <div className="p-4 space-y-2 max-h-[50vh] overflow-y-auto">
          {content.plans.map(planId => {
            const plan = planDetails[planId];
            const isRecommended = planId === content.recommendedPlan;
            return (
              <button
                key={planId}
                onClick={() => onPurchase(planId)}
                className={`w-full p-3 rounded-2xl border-2 text-left transition-all ${
                  isRecommended 
                    ? 'border-brand bg-brand/5 ring-2 ring-brand/20' 
                    : 'border-slate-200 hover:border-brand/50'
                }`}
              >
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <span className="font-bold">{plan.name}</span>
                    {isRecommended && (
                      <span className="text-[9px] bg-brand text-white px-1.5 py-0.5 rounded-full">Ã–NERÄ°LEN</span>
                    )}
                  </div>
                  <span className="text-lg font-bold text-brand">{plan.price}â‚º</span>
                </div>
                <div className="space-y-0.5">
                  {plan.features.map((f, i) => (
                    <p key={i} className="text-[11px] text-slate-500">â€¢ {f}</p>
                  ))}
                </div>
              </button>
            );
          })}
        </div>
        
        {/* View All Plans */}
        <div className="px-4 pb-2">
          <button
            onClick={() => {
              onClose();
              if (window.showSubscriptionModal) window.showSubscriptionModal();
            }}
            className="w-full py-2 text-brand text-sm font-medium"
          >
            TÃ¼m Paketleri GÃ¶r â†’
          </button>
        </div>
        
        {/* Close */}
        <div className="p-4 pt-0">
          <button
            onClick={onClose}
            className="w-full py-2.5 text-slate-500 font-medium text-sm"
          >
            Åžimdi DeÄŸil
          </button>
        </div>
      </div>
    </div>
  );
};

// Subscription Modal - New Package Structure
const SubscriptionModal = ({ open, user, onClose, onSubscribe, onBuyCredits, loading }) => {
  const [selectedPlan, setSelectedPlan] = useState('popular');
  const [activeTab, setActiveTab] = useState('credits'); // 'credits' only now
  const [showReferral, setShowReferral] = useState(false);
  
  if (!open) return null;
  
  // Kredi paketleri - Yeni fiyatlandÄ±rma
  const subscriptionPlans = [
    {
      id: 'starter',
      name: 'BaÅŸlangÄ±Ã§',
      price: 59,
      type: 'credits',
      amount: 10,
      clothingLimit: 15,
      avatarRefresh: 1,
      desc: 'Tek seferlik',
      features: [
        '10 Kredi (Deneme HakkÄ±)',
        '+15 KÄ±yafet YÃ¼kleme HakkÄ±',
        '+1 Avatar Yenileme HakkÄ±',
        'HD Kalitede Ã‡Ä±ktÄ±',
        'GÃ¶rsellerde TrAi Watermark'
      ],
      color: 'slate'
    },
    {
      id: 'popular',
      name: 'PopÃ¼ler',
      price: 109,
      type: 'credits',
      amount: 30,
      clothingLimit: 50,
      avatarRefresh: 2,
      desc: 'Tek seferlik',
      badge: 'EN POPÃœLER',
      features: [
        '30 Kredi (Deneme HakkÄ±)',
        '+50 KÄ±yafet YÃ¼kleme HakkÄ±',
        '+2 Avatar Yenileme HakkÄ±',
        'Full HD Kalitede Ã‡Ä±ktÄ±',
        'ReklamsÄ±z Deneyim',
        'Ã–ncelikli Destek'
      ],
      color: 'brand',
      popular: true
    },
    {
      id: 'pro',
      name: 'Pro',
      price: 179,
      type: 'credits',
      amount: 50,
      clothingLimit: 120,
      avatarRefresh: 3,
      desc: 'Tek seferlik',
      badge: 'EN Ä°YÄ° DEÄžER',
      features: [
        '50 Kredi (Deneme HakkÄ±)',
        '+120 KÄ±yafet YÃ¼kleme HakkÄ±',
        '+3 Avatar Yenileme HakkÄ±',
        '4K Ultra HD Kalitede Ã‡Ä±ktÄ±',
        'ReklamsÄ±z Deneyim',
        'VIP Ã–ncelikli Destek'
      ],
      color: 'amber',
      premium: true
    }
  ];
  
  const handlePurchase = () => {
    const plan = subscriptionPlans.find(p => p.id === selectedPlan);
    if (!plan) return;
    onBuyCredits(plan.amount, plan.type, plan.price, plan.clothingLimit, plan.avatarRefresh);
  };
  
  const selectedPlanData = subscriptionPlans.find(p => p.id === selectedPlan);
  
  // Copy referral code
  const copyReferralCode = () => {
    if (user?.referralCode) {
      navigator.clipboard.writeText(`https://trai.style?ref=${user.referralCode}`);
    }
  };
  
  return (
    <div className="fixed inset-0 z-[100] bg-black/85 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="w-full max-w-md bg-surface rounded-3xl max-h-[90vh] overflow-hidden flex flex-col fade-in">
        {/* Header */}
        <div className="p-4 border-b border-slate-200 bg-gradient-to-r from-brand/10 to-purple-500/10">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-brand to-brand2 flex items-center justify-center text-white text-xl font-bold">
                TrAi
              </div>
              <div>
                <h2 className="font-bold text-lg">{showReferral ? 'ArkadaÅŸÄ±nÄ± Davet Et' : 'Kredi SatÄ±n Al'}</h2>
                <p className="text-xs text-slate-500">{showReferral ? 'ArkadaÅŸÄ±n Ã¼ye olunca +1 kredi kazan' : 'Sanal deneme kredileri'}</p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 rounded-xl hover:bg-slate-200/60">
              <Icon name="x" size={20} />
            </button>
          </div>
          
          {/* Current Status */}
          <div className="flex gap-3 mt-3 text-xs">
            <div className="flex items-center gap-1 bg-white/60 px-2 py-1 rounded-lg">
              <span className="font-bold">{(user?.freeAvatarTry || 0) + (user?.freeShopTry || 0) + (user?.freeComboTry || 0) + (user?.credits || 0)}</span>
              <span className="text-slate-500">kredi</span>
            </div>
            <div className="flex items-center gap-1 bg-white/60 px-2 py-1 rounded-lg">
              <span className="font-bold">{user?.clothingUploadCount || 0}/{user?.clothingUploadLimit || 5}</span>
              <span className="text-slate-500">kÄ±yafet</span>
            </div>
            <div className="flex items-center gap-1 bg-white/60 px-2 py-1 rounded-lg">
              <span className="font-bold">{user?.referralCreditsEarned || 0}</span>
              <span className="text-slate-500">ref. kazanÃ§</span>
            </div>
          </div>
        </div>
        
        {/* Tab Switcher */}
        <div className="flex p-2 gap-1 border-b border-slate-100">
          <button
            onClick={() => setShowReferral(false)}
            className={`flex-1 py-2 rounded-xl text-sm font-semibold transition ${
              !showReferral ? 'bg-brand text-white' : 'text-slate-500 hover:bg-slate-100'
            }`}
          >
            ðŸ’³ Kredi Paketleri
          </button>
          <button
            onClick={() => setShowReferral(true)}
            className={`flex-1 py-2 rounded-xl text-sm font-semibold transition ${
              showReferral ? 'bg-brand text-white' : 'text-slate-500 hover:bg-slate-100'
            }`}
          >
            ðŸŽ Ãœcretsiz Kazan
          </button>
        </div>
        
        {/* Content */}
        {showReferral ? (
          // Referral Tab Content
          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            {/* Referral Stats */}
            <div className="grid grid-cols-3 gap-2">
              <div className="glass rounded-xl p-3 text-center">
                <div className="text-xl font-bold text-brand">{user?.referralCreditsEarned || 0}</div>
                <div className="text-[10px] text-slate-500">{t('referralEarned')}</div>
              </div>
              <div className="glass rounded-xl p-3 text-center">
                <div className="text-xl font-bold text-green-500">{user?.referralCreditsThisMonth || 0}/10</div>
                <div className="text-[10px] text-slate-500">{t('referralThisMonth')}</div>
              </div>
              <div className="glass rounded-xl p-3 text-center">
                <div className="text-xl font-bold text-slate-600">10</div>
                <div className="text-[10px] text-slate-500">{t('referralMonthlyLimit')}</div>
              </div>
            </div>
            
            {/* Referral Code */}
            <div className="glass rounded-xl p-4">
              <label className="text-xs font-semibold text-slate-500 mb-2 block">{t('referralLink')}</label>
              <div className="flex gap-2">
                <input
                  readOnly
                  value={user?.referralCode ? `https://trai.style?ref=${user.referralCode}` : ''}
                  className="flex-1 text-sm font-mono bg-slate-100 rounded-xl px-3 py-2 border-none"
                />
                <button
                  onClick={() => {
                    if (user?.referralCode) {
                      navigator.clipboard.writeText(`https://trai.style?ref=${user.referralCode}`);
                      // Show toast would require passing setToast prop
                    }
                  }}
                  className="btn-primary px-4 rounded-xl font-semibold text-sm"
                >
                  ðŸ“‹ Kopyala
                </button>
              </div>
              
              {/* Share Buttons */}
              <div className="flex gap-2 mt-3">
                <button
                  onClick={() => {
                    const text = `TrAi ile kÄ±yafetleri sanal olarak deneyebilirsin! Ãœcretsiz kaydol: https://trai.style?ref=${user?.referralCode}`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                  }}
                  className="flex-1 bg-green-500 text-white py-2 rounded-xl font-semibold text-sm flex items-center justify-center gap-1"
                >
                  <span>ðŸ’¬</span> WhatsApp
                </button>
                <button
                  onClick={() => {
                    const text = `TrAi ile kÄ±yafetleri sanal olarak deneyebilirsin! Ãœcretsiz kaydol: https://trai.style?ref=${user?.referralCode}`;
                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
                  }}
                  className="flex-1 bg-slate-800 text-white py-2 rounded-xl font-semibold text-sm flex items-center justify-center gap-1"
                >
                  <span>ð•</span> Twitter
                </button>
              </div>
            </div>
            
            {/* How It Works */}
            <div className="glass rounded-xl p-4">
              <h4 className="font-bold text-sm mb-3">{t('referralHowItWorks')}</h4>
              <div className="space-y-3">
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-brand text-white text-xs font-bold flex items-center justify-center flex-shrink-0">1</div>
                  <p className="text-sm text-slate-600">{t('referralStep1')}</p>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-brand text-white text-xs font-bold flex items-center justify-center flex-shrink-0">2</div>
                  <p className="text-sm text-slate-600">{t('referralStep2')}</p>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 rounded-full bg-brand text-white text-xs font-bold flex items-center justify-center flex-shrink-0">3</div>
                  <p className="text-sm text-slate-600">{t('referralStep3')}</p>
                </div>
              </div>
              
              {/* Bonus Info */}
              <div className="mt-4 p-3 bg-amber-50 rounded-xl border border-amber-200">
                <p className="text-xs text-amber-800">
                  <span className="font-bold">ðŸŽ Bonus:</span> {t('referralBonusOnPurchase')}
                </p>
              </div>
              
              {/* Security Note */}
              <div className="mt-3 p-2 bg-slate-100 rounded-lg">
                <p className="text-[10px] text-slate-500">
                  ðŸ”’ {t('referralSecurityNote')}
                </p>
              </div>
            </div>
          </div>
        ) : (
          // Credit Packages Tab Content
          <>
            {/* Plans */}
            <div className="flex-1 overflow-y-auto p-3 space-y-2">
              {subscriptionPlans.map(plan => (
            <button
              key={plan.id}
              onClick={() => setSelectedPlan(plan.id)}
              className={`w-full rounded-2xl p-3 text-left transition border-2 ${
                selectedPlan === plan.id 
                  ? 'border-brand bg-brand/5 ring-2 ring-brand/20' 
                  : 'border-slate-200 hover:border-brand/30 bg-white'
              }`}
            >
              <div className="flex items-start gap-3">
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 flex-wrap">
                    <span className="font-bold">{plan.name}</span>
                    {plan.badge && (
                      <span className={`text-[9px] px-1.5 py-0.5 rounded-full font-bold ${
                        plan.popular ? 'bg-brand text-white' : 'bg-amber-400 text-amber-900'
                      }`}>
                        {plan.badge}
                      </span>
                    )}
                  </div>
                  <div className="flex flex-col gap-0.5 mt-1">
                    {plan.features.map((f, i) => (
                      <span key={i} className="text-[11px] text-slate-500">âœ“ {f}</span>
                    ))}
                  </div>
                </div>
                <div className="text-right flex-shrink-0">
                  <span className="text-xl font-black text-brand">{plan.price}â‚º</span>
                  <p className="text-[10px] text-slate-400">{plan.desc}</p>
                </div>
              </div>
            </button>
          ))}
        </div>
        
        {/* Purchase Button */}
        <div className="p-4 border-t border-slate-200 bg-white">
          <button 
            onClick={handlePurchase}
            disabled={loading}
            className="w-full py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-50 bg-gradient-to-r from-brand to-brand2 text-white shadow-lg"
          >
            {loading ? (
              <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
            ) : (
              <>
                <Icon name="creditCard" size={18} />
                {selectedPlanData?.name} - {selectedPlanData?.price}â‚º {selectedPlanData?.type === 'subscription' ? '/ay' : ''}
              </>
            )}
          </button>
          <p className="text-[10px] text-slate-400 text-center mt-2">
            GÃ¼venli Ã¶deme â€¢ Ä°stediÄŸin zaman iptal
          </p>
        </div>
          </>
        )}
      </div>
    </div>
  );
};

// Payment Modal (Stripe/iyzico placeholder)
const PaymentModal = ({ open, onClose, onComplete, amount, type, tokenAmount, loading }) => {
  const [cardNumber, setCardNumber] = useState('');
  const [expiry, setExpiry] = useState('');
  const [cvv, setCvv] = useState('');
  const [cardHolder, setCardHolder] = useState('');
  
  if (!open) return null;
  
  const formatCardNumber = (v) => {
    const cleaned = v.replace(/\D/g, '').slice(0, 16);
    return cleaned.replace(/(.{4})/g, '$1 ').trim();
  };
  
  const formatExpiry = (v) => {
    const cleaned = v.replace(/\D/g, '').slice(0, 4);
    if (cleaned.length >= 2) return cleaned.slice(0, 2) + '/' + cleaned.slice(2);
    return cleaned;
  };
  
  const isValid = cardNumber.replace(/\s/g, '').length === 16 && expiry.length === 5 && cvv.length >= 3 && cardHolder.length > 2;

  const handleComplete = () => {
    // For token purchases, pass the token amount; for other types, pass the payment amount
    const amountToPass = (type === 'tokens' || type === 'videoTokens') ? tokenAmount : amount;
    onComplete(type, amountToPass);
  };
  
  return (
    <div className="fixed inset-0 z-[110] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="w-full max-w-md bg-surface rounded-3xl overflow-hidden fade-in">
        <div className="p-5 border-b border-slate-200 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${type === 'videoTokens' ? 'bg-brand/10' : 'bg-green-100'}`}>
              <Icon name="creditCard" size={20} className={type === 'videoTokens' ? 'text-brand' : 'text-green-600'} />
            </div>
            <div>
              <h2 className="font-bold">{t('paymentMethod')}</h2>
              <p className="text-xs text-slate-400">{t('orderSummary')}: {amount} â‚º</p>
            </div>
          </div>
          <button onClick={onClose} className="p-2 rounded-xl hover:bg-slate-200/60">
            <Icon name="x" size={20} />
          </button>
        </div>
        
        <div className="p-5 space-y-4">
          {/* Card Preview */}
          <div className={`rounded-2xl p-5 text-white ${type === 'videoTokens' ? 'bg-brand' : 'bg-gradient-to-br from-slate-800 to-slate-900'}`}>
            <div className="flex justify-between items-start mb-8">
              <span className="text-xs opacity-60">{t('creditCard')}</span>
              <div className="flex gap-1">
                <div className="w-6 h-6 rounded-full bg-red-500 opacity-80" />
                <div className="w-6 h-6 rounded-full bg-amber-500 opacity-80 -ml-3" />
              </div>
            </div>
            <p className="text-lg tracking-widest font-mono mb-4">{cardNumber || 'â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢'}</p>
            <div className="flex justify-between text-xs">
              <div>
                <p className="opacity-60 text-[10px]">{t('cardHolder')}</p>
                <p className="font-medium">{cardHolder || 'AD SOYAD'}</p>
              </div>
              <div className="text-right">
                <p className="opacity-60 text-[10px]">{t('expiryDate')}</p>
                <p className="font-medium">{expiry || 'MM/YY'}</p>
              </div>
            </div>
          </div>
          
          {/* Form */}
          <div className="space-y-3">
            <div>
              <label className="text-xs text-slate-500 mb-1 block">{t('cardNumber')}</label>
              <input 
                type="text" 
                value={cardNumber} 
                onChange={e => setCardNumber(formatCardNumber(e.target.value))}
                placeholder="1234 5678 9012 3456"
                className="font-mono"
              />
            </div>
            <div>
              <label className="text-xs text-slate-500 mb-1 block">{t('cardHolder')}</label>
              <input 
                type="text" 
                value={cardHolder} 
                onChange={e => setCardHolder(e.target.value.toUpperCase())}
                placeholder="AD SOYAD"
              />
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-slate-500 mb-1 block">{t('expiryDate')}</label>
                <input 
                  type="text" 
                  value={expiry} 
                  onChange={e => setExpiry(formatExpiry(e.target.value))}
                  placeholder="MM/YY"
                />
              </div>
              <div>
                <label className="text-xs text-slate-500 mb-1 block">{t('cvv')}</label>
                <input 
                  type="text" 
                  value={cvv} 
                  onChange={e => setCvv(e.target.value.replace(/\D/g, '').slice(0, 4))}
                  placeholder="123"
                />
              </div>
            </div>
          </div>
          
          <div className="flex gap-2 pt-2">
            <img src="https://cdn.jsdelivr.net/gh/nicehash/bitcoin-icons@master/svg/stripe.svg" alt="" className="h-6 opacity-50" onError={e => e.target.style.display = 'none'} />
            <span className="text-[10px] text-slate-400">256-bit SSL</span>
          </div>
        </div>
        
        <div className="p-5 border-t border-slate-200">
          <button 
            onClick={handleComplete}
            disabled={!isValid || loading}
            className={`w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-50 ${type === 'videoTokens' ? 'bg-brand text-white' : 'btn-primary'}`}
          >
            {loading ? (
              <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
            ) : (
              <>
                <Icon name="check" size={18} />
                {t('completePayment')} - {amount} â‚º
              </>
            )}
          </button>
        </div>
      </div>
    </div>
  );
};

const ResultModal = ({ open, image, item, items, onClose, onShare, onShareToFeed, onShareToDM, onAddToCart, onSaveCombo }) => {
  const [showShareOptions, setShowShareOptions] = useState(false);
  const [zoom, setZoom] = useState(1);
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
  const [saved, setSaved] = useState(false);
  const [addedToCart, setAddedToCart] = useState(false);
  const imageRef = React.useRef(null);
  
  // Reset state when modal opens
  React.useEffect(() => {
    if (open) {
      setZoom(1);
      setPosition({ x: 0, y: 0 });
      setSaved(false);
      setAddedToCart(false);
      setShowShareOptions(false);
    }
  }, [open]);
  
  // Handle wheel zoom
  const handleWheel = (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.1 : 0.1;
    setZoom(prev => Math.min(Math.max(prev + delta, 0.5), 4));
  };
  
  // Handle pinch zoom for touch
  const handleTouchStart = (e) => {
    if (e.touches.length === 2) {
      const distance = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      imageRef.current.dataset.initialDistance = distance;
      imageRef.current.dataset.initialZoom = zoom;
    } else if (e.touches.length === 1 && zoom > 1) {
      setIsDragging(true);
      setDragStart({ x: e.touches[0].clientX - position.x, y: e.touches[0].clientY - position.y });
    }
  };
  
  const handleTouchMove = (e) => {
    if (e.touches.length === 2 && imageRef.current.dataset.initialDistance) {
      e.preventDefault();
      const distance = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      const initialDistance = parseFloat(imageRef.current.dataset.initialDistance);
      const initialZoom = parseFloat(imageRef.current.dataset.initialZoom);
      const newZoom = (distance / initialDistance) * initialZoom;
      setZoom(Math.min(Math.max(newZoom, 0.5), 4));
    } else if (isDragging && e.touches.length === 1) {
      setPosition({
        x: e.touches[0].clientX - dragStart.x,
        y: e.touches[0].clientY - dragStart.y
      });
    }
  };
  
  const handleTouchEnd = () => {
    setIsDragging(false);
    if (imageRef.current) {
      delete imageRef.current.dataset.initialDistance;
      delete imageRef.current.dataset.initialZoom;
    }
  };
  
  // Double tap to zoom
  const handleDoubleClick = () => {
    if (zoom === 1) {
      setZoom(2);
    } else {
      setZoom(1);
      setPosition({ x: 0, y: 0 });
    }
  };
  
  if (!open || !image) return null;
  return (
    <div className="fixed inset-0 z-[80] bg-slate-900/95 flex flex-col slide-up">
      <div className="flex-shrink-0 p-4 flex items-center justify-between border-b border-white/10">
        <h3 className="font-bold text-white flex items-center gap-2"><Icon name="sparkles" size={18} className="text-accent" />SonuÃ§</h3>
        <div className="flex items-center gap-2">
          {/* Zoom controls */}
          <div className="flex items-center gap-1 bg-white/10 rounded-lg px-2 py-1">
            <button onClick={() => setZoom(prev => Math.max(prev - 0.25, 0.5))} className="p-1 text-white/70 hover:text-white">
              <Icon name="minus" size={14} />
            </button>
            <span className="text-xs text-white/70 w-10 text-center">{Math.round(zoom * 100)}%</span>
            <button onClick={() => setZoom(prev => Math.min(prev + 0.25, 4))} className="p-1 text-white/70 hover:text-white">
              <Icon name="plus" size={14} />
            </button>
          </div>
          <button onClick={() => { setZoom(1); setPosition({ x: 0, y: 0 }); }} className="p-2 text-white/70 hover:text-white" title="SÄ±fÄ±rla">
            <Icon name="refresh" size={16} />
          </button>
          <button onClick={onClose} className="p-2 text-white"><Icon name="x" /></button>
        </div>
      </div>
      
      {/* Image container - fills available space */}
      <div 
        className="flex-1 overflow-hidden relative flex items-center justify-center bg-slate-950"
        onWheel={handleWheel}
        onTouchStart={handleTouchStart}
        onTouchMove={handleTouchMove}
        onTouchEnd={handleTouchEnd}
        onDoubleClick={handleDoubleClick}
      >
        <img 
          ref={imageRef}
          src={image} 
          className="max-w-full max-h-full object-contain rounded-lg transition-transform duration-100"
          style={{ 
            transform: `scale(${zoom}) translate(${position.x / zoom}px, ${position.y / zoom}px)`,
            cursor: zoom > 1 ? 'grab' : 'zoom-in'
          }}
          draggable={false}
        />
        {/* Zoom hint */}
        {zoom === 1 && (
          <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/50 text-white/70 text-xs px-3 py-1.5 rounded-full">
            Ã‡ift tÄ±kla yakÄ±nlaÅŸtÄ±r â€¢ KaydÄ±r veya tekerlek ile zoom
          </div>
        )}
      </div>
      
      {/* Item info - compact */}
      {(item || (items && items.length > 0)) && (
        <div className="flex-shrink-0 p-3 border-t border-white/10 bg-slate-900/80">
          {item && (
            <div className="flex items-center gap-3">
              <img src={item.image} className="w-12 h-12 rounded-lg object-cover" />
              <div className="flex-1 min-w-0">
                <p className="text-xs text-white/50">{item.brandName}</p>
                <p className="font-semibold text-white truncate">{item.name}</p>
              </div>
              <p className="text-brand2 font-bold">{item.price}</p>
            </div>
          )}
          {items && items.length > 0 && (
            <div className="flex gap-2 overflow-x-auto no-scrollbar">
              {items.map((i, idx) => (
                <div key={idx} className="flex-shrink-0 flex items-center gap-2 bg-white/10 rounded-lg px-2 py-1.5">
                  <img src={i.image} className="w-8 h-8 rounded object-cover" />
                  <span className="text-xs text-white">{i.name}</span>
                </div>
              ))}
            </div>
          )}
        </div>
      )}
      
      {/* Action buttons - Sepete Ekle, Kaydet, PaylaÅŸ */}
      <div className="flex-shrink-0 p-3 border-t border-white/10 safe-bottom bg-slate-900 space-y-2">
        {/* Primary Actions */}
        <div className="flex gap-2">
          {/* Add to Cart - TÃ¼m Ã¼rÃ¼nleri sepete ekle (beden sorarak) */}
          {items && items.length > 0 && (
            <button 
              onClick={() => {
                if (!addedToCart && window.addMultipleToCart) {
                  window.addMultipleToCart(items);
                  setAddedToCart(true);
                } else if (onAddToCart && !addedToCart) {
                  items.forEach(itm => onAddToCart(itm));
                  setAddedToCart(true);
                }
              }}
              disabled={addedToCart}
              className={`flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-sm transition ${
                addedToCart 
                  ? 'bg-green-500 text-white' 
                  : 'bg-orange-500 hover:bg-orange-600 text-white'
              }`}
            >
              <Icon name={addedToCart ? 'check' : 'shop'} size={16} />
              {addedToCart ? 'Sepete Eklendi' : `Sepete Ekle (${items.length})`}
            </button>
          )}
          
          {/* Save Combo */}
          <button 
            onClick={() => {
              if (onSaveCombo && !saved) {
                onSaveCombo({ image, items: items || (item ? [item] : []) });
                setSaved(true);
              }
            }}
            disabled={saved}
            className={`flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-sm transition ${
              saved 
                ? 'bg-green-500 text-white' 
                : 'bg-white/10 hover:bg-white/20 text-white'
            }`}
          >
            <Icon name={saved ? 'check' : 'heart'} size={16} />
            {saved ? 'Kaydedildi' : 'Kombini Kaydet'}
          </button>
        </div>
        
        {/* Share Options */}
        {showShareOptions ? (
          <div className="space-y-2">
            <div className="flex gap-2">
              <button 
                onClick={() => { onShareToFeed(); setShowShareOptions(false); }}
                className="flex-1 btn-primary py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 text-sm"
              >
                <Icon name="users" size={14} />AkÄ±ÅŸta PaylaÅŸ
              </button>
              <button 
                onClick={() => { onShareToDM && onShareToDM(); setShowShareOptions(false); }}
                className="flex-1 bg-brand py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 text-sm text-white"
              >
                <Icon name="mail" size={14} />DM GÃ¶nder
              </button>
            </div>
            <div className="flex gap-2">
              <button 
                onClick={() => { onShare(); setShowShareOptions(false); }}
                className="flex-1 bg-white/10 py-2 rounded-xl font-semibold flex items-center justify-center gap-2 text-sm text-white"
              >
                <Icon name="share" size={14} />DÄ±ÅŸa Aktar
              </button>
              <button 
                onClick={() => setShowShareOptions(false)}
                className="px-6 py-2 rounded-xl text-white/50 bg-white/5"
              >
                Ä°ptal
              </button>
            </div>
          </div>
        ) : (
          <button 
            onClick={() => setShowShareOptions(true)} 
            className="w-full bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-white"
          >
            <Icon name="share" size={16} />PaylaÅŸ
          </button>
        )}
      </div>
    </div>
  );
};

const AdviceModal = ({ open, item, advice, loading, onClose }) => {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-[80] bg-black/90 flex flex-col slide-up">
      <div className="p-4 flex items-center justify-between border-b border-slate-200">
        <h3 className="font-bold flex items-center gap-2"><Icon name="ruler" size={18} className="text-accent" />{t('sizeStyleAdvice')}</h3>
        <button onClick={onClose} className="p-2"><Icon name="x" /></button>
      </div>
      <div className="flex-1 overflow-auto custom-scroll p-4">
        <div className="flex gap-3 mb-4">
          <div className="w-20 h-28 rounded-xl overflow-hidden"><img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" loading="lazy" /></div>
          <div>
            <p className="text-xs text-slate-500">{item.brandName}</p>
            <p className="font-bold">{item.name}</p>
            <p className="text-brand2 text-sm">{item.price}</p>
          </div>
        </div>
        <div className="bg-brand/10 border border-brand/20 rounded-2xl p-4">
          {loading ? (
            <div className="flex items-center gap-2 text-slate-500"><div className="w-4 h-4 border-2 border-brand border-t-transparent rounded-full animate-spin" />Analiz ediliyor...</div>
          ) : (
            <p className="text-sm leading-relaxed whitespace-pre-wrap">{advice}</p>
          )}
        </div>
      </div>
      <div className="p-4 border-t border-slate-200">
        <button onClick={onClose} className="w-full btn-ghost py-4 rounded-2xl font-bold">Kapat</button>
      </div>
    </div>
  );
};

// ============ SOCIAL FEED ============
const SocialFeed = ({ user, authUser, friends, setFriends, posts, setPosts, setToast, dmChats, setDmChats, followRequests, setFollowRequests, sentFollowRequests, setSentFollowRequests, groups, setGroups, notifications, setNotifications }) => {
  const [tab, setTab] = useState('feed'); // feed, myPosts, create, friends, messages
  const [selectedImage, setSelectedImage] = useState(null);
  const [caption, setCaption] = useState('');
  const [askFeedback, setAskFeedback] = useState(false);
  const [visibility, setVisibility] = useState('public'); // public, friends, private
  const [posting, setPosting] = useState(false);
  const [selectedPost, setSelectedPost] = useState(null);
  const [comment, setComment] = useState('');
  const [shareModal, setShareModal] = useState({ open: false, post: null });
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [searching, setSearching] = useState(false);
  const [selectedChat, setSelectedChat] = useState(null);
  const [newMessage, setNewMessage] = useState('');
  const [showNewChat, setShowNewChat] = useState(false);
  
  // Grup mesajlaÅŸma state'leri
  const [showCreateGroup, setShowCreateGroup] = useState(false);
  const [groupName, setGroupName] = useState('');
  const [groupTopic, setGroupTopic] = useState('');
  const [selectedGroupMembers, setSelectedGroupMembers] = useState([]);
  const [showEditGroup, setShowEditGroup] = useState(false);
  const [editingGroup, setEditingGroup] = useState(null);
  
  // Grup oluÅŸturma fonksiyonu
  const createGroup = async () => {
    // Validasyon: En az 3 kiÅŸi (oluÅŸturan + 2 Ã¼ye)
    if (selectedGroupMembers.length < 2) {
      setToast({ open: true, type: 'error', title: 'Yetersiz Ãœye', message: t('minGroupMembers') });
      return;
    }
    
    if (!groupName.trim()) {
      setToast({ open: true, type: 'error', title: 'Grup AdÄ± Gerekli', message: 'Grup iÃ§in bir ad girin' });
      return;
    }
    
    // Grup limiti: max 10 kiÅŸi
    if (selectedGroupMembers.length > 9) {
      setToast({ open: true, type: 'error', title: 'Limit AÅŸÄ±ldÄ±', message: t('groupMaxMembers') });
      return;
    }
    
    const newGroup = {
      id: Date.now(),
      name: groupName.trim(),
      topic: groupTopic.trim() || null,
      creatorId: authUser?.uid,
      creatorName: user.username || user.displayName,
      members: [
        { id: authUser?.uid, name: user.username || user.displayName, avatar: user.profilePhoto || user.baseAvatar, role: 'admin' },
        ...selectedGroupMembers.map(m => ({ ...m, role: 'member' }))
      ],
      messages: [],
      createdAt: Date.now()
    };
    
    // GruplarÄ± gÃ¼ncelle
    setGroups(prev => [...prev, newGroup]);
    
    // Firebase'e kaydet
    if (db && authUser?.uid) {
      try {
        await db.collection('groups').doc(String(newGroup.id)).set({
          ...newGroup,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Ãœyelere bildirim gÃ¶nder
        for (const member of selectedGroupMembers) {
          await db.collection('users').doc(member.id).collection('notifications').add({
            type: 'group_invite',
            groupId: newGroup.id,
            groupName: newGroup.name,
            senderId: authUser.uid,
            senderName: user.username || user.displayName,
            senderAvatar: user.profilePhoto || user.baseAvatar,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      } catch (e) {
        console.error('Grup oluÅŸturma hatasÄ±:', e);
      }
    }
    
    // State'leri sÄ±fÄ±rla
    setShowCreateGroup(false);
    setGroupName('');
    setGroupTopic('');
    setSelectedGroupMembers([]);
    setToast({ open: true, type: 'success', title: t('groupCreated'), message: `${newGroup.name} grubu oluÅŸturuldu` });
    
    // Gruba gir
    setSelectedChat({ type: 'group', ...newGroup });
  };
  
  // Grup mesajÄ± gÃ¶nderme
  const sendGroupMessage = async () => {
    if (!newMessage.trim() || !selectedChat || selectedChat.type !== 'group') return;
    
    const msg = {
      id: Date.now(),
      senderId: authUser?.uid,
      senderName: user.username || user.displayName,
      senderAvatar: user.profilePhoto || user.baseAvatar,
      text: newMessage.trim(),
      type: 'text',
      timestamp: Date.now()
    };
    
    // Lokal state gÃ¼ncelle
    setGroups(prev => prev.map(g => 
      g.id === selectedChat.id 
        ? { ...g, messages: [...(g.messages || []), msg] }
        : g
    ));
    
    // selectedChat'i de gÃ¼ncelle
    setSelectedChat(prev => ({
      ...prev,
      messages: [...(prev.messages || []), msg]
    }));
    
    // Firebase'e kaydet
    if (db) {
      try {
        await db.collection('groups').doc(String(selectedChat.id)).collection('messages').add({
          ...msg,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Son mesajÄ± grup dokÃ¼manÄ±na kaydet
        await db.collection('groups').doc(String(selectedChat.id)).update({
          lastMessage: msg.text,
          lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (e) {
        console.error('Mesaj gÃ¶nderme hatasÄ±:', e);
      }
    }
    
    setNewMessage('');
  };
  
  // Gruptan ayrÄ±lma
  const leaveGroup = async (groupId) => {
    if (!confirm('Bu gruptan ayrÄ±lmak istediÄŸine emin misin?')) return;
    
    setGroups(prev => prev.map(g => {
      if (g.id === groupId) {
        return {
          ...g,
          members: g.members.filter(m => m.id !== authUser?.uid)
        };
      }
      return g;
    }).filter(g => g.members.some(m => m.id === authUser?.uid)));
    
    if (selectedChat?.id === groupId) {
      setSelectedChat(null);
    }
    
    // Firebase'den gÃ¼ncelle
    if (db) {
      const groupRef = db.collection('groups').doc(String(groupId));
      const groupDoc = await groupRef.get();
      if (groupDoc.exists) {
        const data = groupDoc.data();
        const updatedMembers = data.members.filter(m => m.id !== authUser?.uid);
        if (updatedMembers.length > 0) {
          await groupRef.update({ members: updatedMembers });
        } else {
          await groupRef.delete(); // Son Ã¼ye ayrÄ±lÄ±nca grubu sil
        }
      }
    }
    
    setToast({ open: true, type: 'info', title: 'Gruptan AyrÄ±ldÄ±n', message: '' });
  };
  
  // Grup dÃ¼zenleme (sadece admin)
  const updateGroupSettings = async () => {
    if (!editingGroup) return;
    
    setGroups(prev => prev.map(g => 
      g.id === editingGroup.id 
        ? { ...g, name: groupName.trim() || g.name, topic: groupTopic.trim() || g.topic }
        : g
    ));
    
    if (db) {
      await db.collection('groups').doc(String(editingGroup.id)).update({
        name: groupName.trim() || editingGroup.name,
        topic: groupTopic.trim() || editingGroup.topic
      }).catch(() => {});
    }
    
    setShowEditGroup(false);
    setEditingGroup(null);
    setGroupName('');
    setGroupTopic('');
    setToast({ open: true, type: 'success', title: 'Grup GÃ¼ncellendi', message: '' });
  };

  const myPosts = posts.filter(p => p.authorId === authUser?.uid);
  const feedPosts = posts.filter(p => 
    p.visibility === 'public' || 
    (p.visibility === 'friends' && friends.some(f => f.id === p.authorId)) ||
    p.authorId === authUser?.uid
  ).sort((a, b) => b.createdAt - a.createdAt);

  const createPost = () => {
    if (!selectedImage) {
      setToast({ open: true, type: 'error', title: 'GÃ¶rsel Yok', message: 'PaylaÅŸmak iÃ§in bir gÃ¶rsel seÃ§' });
      return;
    }
    setPosting(true);
    
    const newPost = {
      id: Date.now(),
      authorId: authUser?.uid,
      authorName: user.username || user.displayName || 'KullanÄ±cÄ±',
      authorUsername: user.username,
      authorAvatar: user.profilePhoto || user.baseAvatar || user.avatar,
      image: selectedImage,
      caption: caption,
      askFeedback: askFeedback,
      visibility: visibility,
      likes: [],
      comments: [],
      createdAt: Date.now()
    };
    
    setPosts(prev => [newPost, ...prev]);
    setSelectedImage(null);
    setCaption('');
    setAskFeedback(false);
    setTab('myPosts');
    setPosting(false);
    setToast({ open: true, type: 'success', title: 'PaylaÅŸÄ±ldÄ±!', message: 'GÃ¶nderin yayÄ±nlandÄ±' });
  };

  const likePost = (postId) => {
    setPosts(prev => prev.map(p => {
      if (p.id === postId) {
        const hasLiked = p.likes.includes(authUser?.uid);
        return {
          ...p,
          likes: hasLiked 
            ? p.likes.filter(id => id !== authUser?.uid)
            : [...p.likes, authUser?.uid]
        };
      }
      return p;
    }));
  };

  const addComment = (postId) => {
    if (!comment.trim()) return;
    setPosts(prev => prev.map(p => {
      if (p.id === postId) {
        return {
          ...p,
          comments: [...p.comments, {
            id: Date.now(),
            authorId: authUser?.uid,
            authorName: user.username || user.displayName || 'KullanÄ±cÄ±',
            authorUsername: user.username,
            text: comment,
            createdAt: Date.now()
          }]
        };
      }
      return p;
    }));
    setComment('');
  };

  const deletePost = (postId) => {
    if (confirm(t('deletePostConfirm'))) {
      setPosts(prev => prev.filter(p => p.id !== postId));
      setSelectedPost(null);
    }
  };

  const shareExternal = async (platform, post) => {
    const text = `${post.caption || 'TrAi ile denedim!'} #TrAi #VirtualTryOn #Fashion`;
    let shareUrl = 'https://trai.style';
    let uploadedImageUrl = null;
    
    // Upload image to Firebase Storage for shareable link
    if (post.image && post.image.startsWith('data:image') && storage && authUser?.uid) {
      try {
        setToast({ open: true, type: 'info', title: 'HazÄ±rlanÄ±yor...', message: 'GÃ¶rsel yÃ¼kleniyor' });
        const timestamp = Date.now();
        const storageRef = storage.ref(`shared/${authUser.uid}/${timestamp}.jpg`);
        const response = await fetch(post.image);
        const blob = await response.blob();
        await storageRef.put(blob);
        uploadedImageUrl = await storageRef.getDownloadURL();
        shareUrl = uploadedImageUrl;
      } catch (e) {
        console.warn('âš ï¸ Image upload for share failed:', e);
      }
    }
    
    if (platform === 'native' && navigator.share) {
      try {
        const response = await fetch(post.image);
        const blob = await response.blob();
        const file = new File([blob], 'trai-outfit.png', { type: 'image/png' });
        await navigator.share({
          title: 'TrAi - Sanal Deneme',
          text: text,
          files: [file]
        });
      } catch (e) {
        // Fallback to URL share
        try {
          await navigator.share({ title: 'TrAi', text: text, url: shareUrl });
        } catch (e2) {
          // Final fallback: download image
          downloadImage(post.image, 'trai-outfit.png');
          setToast({ open: true, type: 'success', title: 'Ä°ndirildi!', message: 'GÃ¶rseli paylaÅŸabilirsin' });
        }
      }
    } else if (platform === 'instagram') {
      // Instagram iÃ§in gÃ¶rseli indir
      downloadImage(post.image, 'trai-outfit.png');
      setToast({ open: true, type: 'success', title: t('downloaded'), message: t('shareOnInstagram') });
    } else if (platform === 'twitter') {
      const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(shareUrl)}`;
      window.location.href = twitterUrl; // window.open yerine location.href kullan
    } else if (platform === 'facebook') {
      const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&quote=${encodeURIComponent(text)}`;
      window.location.href = fbUrl;
    } else if (platform === 'whatsapp') {
      const waUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + shareUrl)}`;
      window.location.href = waUrl;
    } else if (platform === 'download') {
      // DoÄŸrudan indirme
      downloadImage(post.image, 'trai-outfit.png');
      setToast({ open: true, type: 'success', title: 'Ä°ndirildi!', message: 'GÃ¶rsel kaydedildi' });
    }
    
    setShareModal({ open: false, post: null });
  };
  
  // Helper function to download image
  const downloadImage = (dataUrl, filename) => {
    const link = document.createElement('a');
    link.href = dataUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const tabs = [
    { id: 'feed', icon: 'world', label: t('social') },
    { id: 'friends', icon: 'users', label: t('following') },
    { id: 'messages', icon: 'mail', label: 'DM' },
    { id: 'create', icon: 'plusCircle', label: t('share') }
  ];
  
  // Search for users to follow
  const searchUsers = async (query) => {
    if (!query || query.length < 2 || !db) return;
    setSearching(true);
    try {
      const snapshot = await db.collection('users')
        .where('username', '>=', query.toLowerCase())
        .where('username', '<=', query.toLowerCase() + '\uf8ff')
        .limit(10)
        .get();
      
      const results = [];
      snapshot.forEach(doc => {
        if (doc.id !== authUser?.uid) {
          results.push({ id: doc.id, ...doc.data() });
        }
      });
      setSearchResults(results);
    } catch (err) {
      console.error('Search error:', err);
    }
    setSearching(false);
  };
  
  // Follow a user
  const followUser = async (targetUser) => {
    if (!db || !authUser?.uid || !user) return;
    
    const myUid = authUser.uid;
    const targetUid = targetUser.id;
    
    // Check if already sent request
    if (sentFollowRequests.some(r => r.uid === targetUid || r === targetUid)) {
      setToast({ open: true, type: 'warning', title: 'Zaten gÃ¶nderildi', message: 'Bu kullanÄ±cÄ±ya zaten istek gÃ¶nderdin' });
      return;
    }
    
    // Check if already following
    if (friends.some(f => f.uid === targetUid || f.id === targetUid)) {
      setToast({ open: true, type: 'info', title: 'Zaten takip ediyorsun', message: 'Bu kullanÄ±cÄ±yÄ± zaten takip ediyorsun' });
      return;
    }
    
    try {
      const requestData = {
        fromUid: myUid,
        fromUsername: user.username,
        fromDisplayName: user.displayName,
        fromPhoto: user.profilePhoto || null,
        toUid: targetUid,
        toUsername: targetUser.username,
        status: 'pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Add to target's incoming requests (use doc ID as myUid to prevent duplicates)
      await db.collection('users').doc(targetUid).collection('followRequests').doc(myUid).set(requestData);
      
      // Add to my sent requests
      await db.collection('users').doc(myUid).collection('sentFollowRequests').doc(targetUid).set({
        ...requestData,
        toPhoto: targetUser.profilePhoto || targetUser.avatar || null
      });
      
      // Create notification
      await db.collection('users').doc(targetUid).collection('notifications').add({
        type: 'follow_request',
        fromUid: myUid,
        fromUsername: user.username,
        fromDisplayName: user.displayName,
        fromPhoto: user.profilePhoto || null,
        message: `${user.username || user.displayName} seni takip etmek istiyor`,
        read: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Local state will be updated by real-time listener
      setToast({ open: true, type: 'success', title: 'Ä°stek GÃ¶nderildi', message: `@${targetUser.username}'e takip isteÄŸi gÃ¶nderildi` });
    } catch (err) {
      console.error('Follow error:', err);
      setToast({ open: true, type: 'error', title: 'Hata', message: 'Ä°stek gÃ¶nderilemedi' });
    }
  };
  
  // Accept follow request - Creates MUTUAL follow
  const acceptRequest = async (request) => {
    if (!db || !authUser?.uid || !user) return;
    
    const myUid = authUser.uid;
    const fromUid = request.fromUid || request.fromUserId;
    
    if (!fromUid) {
      console.error('No fromUid in request:', request);
      return;
    }
    
    try {
      // They follow me - add to their following
      await db.collection('users').doc(fromUid).collection('following').doc(myUid).set({
        uid: myUid,
        username: user.username,
        displayName: user.displayName,
        profilePhoto: user.profilePhoto || null,
        followedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // I'm in their following - add them to my followers
      await db.collection('users').doc(myUid).collection('followers').doc(fromUid).set({
        uid: fromUid,
        username: request.fromUsername,
        displayName: request.fromDisplayName || request.fromUsername,
        profilePhoto: request.fromPhoto || request.fromAvatar || null,
        followedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // MUTUAL: I also follow them back
      await db.collection('users').doc(myUid).collection('following').doc(fromUid).set({
        uid: fromUid,
        username: request.fromUsername,
        displayName: request.fromDisplayName || request.fromUsername,
        profilePhoto: request.fromPhoto || request.fromAvatar || null,
        followedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // They're in my following - add me to their followers
      await db.collection('users').doc(fromUid).collection('followers').doc(myUid).set({
        uid: myUid,
        username: user.username,
        displayName: user.displayName,
        profilePhoto: user.profilePhoto || null,
        followedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Delete the request (use fromUid as doc ID)
      await db.collection('users').doc(myUid).collection('followRequests').doc(fromUid).delete().catch(() => {});
      // Also try to delete by request.id if it's different
      if (request.id && request.id !== fromUid) {
        await db.collection('users').doc(myUid).collection('followRequests').doc(request.id).delete().catch(() => {});
      }
      await db.collection('users').doc(fromUid).collection('sentFollowRequests').doc(myUid).delete().catch(() => {});
      
      // Send notification
      await db.collection('users').doc(fromUid).collection('notifications').add({
        type: 'follow_accepted',
        fromUid: myUid,
        fromUsername: user.username,
        fromDisplayName: user.displayName,
        fromPhoto: user.profilePhoto || null,
        message: `${user.username || user.displayName} takip isteÄŸini kabul etti`,
        read: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      console.log('âœ… Follow request accepted - mutual follow created');
      
      // Local state will be updated by real-time listeners
      setToast({ open: true, type: 'success', title: 'Kabul Edildi', message: `${request.fromUsername} artÄ±k arkadaÅŸÄ±n` });
    } catch (err) {
      console.error('Accept error:', err);
      setToast({ open: true, type: 'error', title: 'Hata', message: 'Ä°ÅŸlem baÅŸarÄ±sÄ±z' });
    }
  };
  
  // Send message
  const sendMessage = async () => {
    if (!newMessage.trim() || !selectedChat || !db || !authUser?.uid) return;
    
    try {
      const chatId = selectedChat.id;
      const messageData = {
        senderId: authUser.uid,
        senderName: user?.displayName || user?.username || 'KullanÄ±cÄ±',
        text: newMessage.trim(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: Date.now()
      };
      
      await db.collection('chats').doc(chatId).collection('messages').add(messageData);
      await db.collection('chats').doc(chatId).set({
        lastMessage: newMessage.trim(),
        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
        lastMessageBy: authUser.uid,
        updatedAt: Date.now()
      }, { merge: true });
      
      // Update local state
      setDmChats(prev => prev.map(c => 
        c.id === chatId 
          ? { ...c, messages: [...(c.messages || []), { ...messageData, id: Date.now() }] }
          : c
      ));
      
      setNewMessage('');
    } catch (err) {
      console.error('Send message error:', err);
    }
  };

  const PostCard = ({ post, showActions = true }) => {
    const isLiked = post.likes.includes(authUser?.uid);
    const isOwner = post.authorId === authUser?.uid;
    const timeAgo = getTimeAgo(post.createdAt);

    return (
      <div className="glass rounded-2xl overflow-hidden">
        {/* Header */}
        <div className="p-3 flex items-center gap-3">
          <div className="w-10 h-10 rounded-xl overflow-hidden bg-brand">
            {post.authorAvatar ? (
              <img src={post.authorAvatar} className="w-full h-full object-cover" />
            ) : (
              <div className="w-full h-full flex items-center justify-center text-lg">ðŸ‘¤</div>
            )}
          </div>
          <div className="flex-1">
            <p className="font-semibold text-sm">{post.authorName}</p>
            <p className="text-xs text-slate-400">{post.authorUsername ? `@${post.authorUsername}` : ''} {post.authorUsername ? 'Â·' : ''} {timeAgo}</p>
          </div>
          {post.askFeedback && (
            <span className="text-xs bg-amber-100 text-accent px-2 py-1 rounded-lg font-medium">
              ðŸ’¬ {t('askingFeedback')}
            </span>
          )}
          {isOwner && (
            <button onClick={() => setSelectedPost(post)} className="p-2 rounded-xl hover:bg-slate-200/60">
              <Icon name="moreHorizontal" size={18} />
            </button>
          )}
        </div>

        {/* Image */}
        <div className="aspect-[3/4] relative">
          <img src={post.image} className="w-full h-full object-cover" loading="lazy" />
          <div className="absolute bottom-2 right-2 flex gap-2">
            <span className="text-xs bg-slate-900/50 backdrop-blur px-2 py-1 rounded-lg">
              {post.visibility === 'public' ? `ðŸŒ ${t('public')}` : post.visibility === 'friends' ? `ðŸ‘¥ ${t('followersOnly')}` : `ðŸ”’ ${t('private')}`}
            </span>
          </div>
        </div>

        {/* Actions */}
        {showActions && (
          <div className="p-3 space-y-3">
            <div className="flex items-center gap-4">
              <button onClick={() => likePost(post.id)} className="flex items-center gap-1.5 text-sm">
                <Icon name={isLiked ? 'heartFilled' : 'heart'} size={22} className={isLiked ? 'text-red-400' : ''} />
                <span className="font-medium">{post.likes.length}</span>
              </button>
              <button onClick={() => setSelectedPost(post)} className="flex items-center gap-1.5 text-sm">
                <Icon name="messageCircle" size={22} />
                <span className="font-medium">{post.comments.length}</span>
              </button>
              <button onClick={() => setShareModal({ open: true, post })} className="flex items-center gap-1.5 text-sm">
                <Icon name="share" size={20} />
              </button>
              <div className="flex-1" />
              <button onClick={() => {
                const isSaved = favorites?.some(f => f.postId === post.id);
                // Toggle save
              }} className="p-1">
                <Icon name="bookmark" size={20} />
              </button>
            </div>

            {post.caption && (
              <p className="text-sm">
                <span className="font-semibold">{post.authorName}</span>{' '}
                <span className="text-slate-700">{post.caption}</span>
              </p>
            )}

            {post.comments.length > 0 && (
              <button onClick={() => setSelectedPost(post)} className="text-xs text-slate-500">
                {post.comments.length} yorumun tÃ¼mÃ¼nÃ¼ gÃ¶r
              </button>
            )}
          </div>
        )}
      </div>
    );
  };

  const getTimeAgo = (timestamp) => {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return 'Az Ã¶nce';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}dk`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}sa`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days}g`;
    return new Date(timestamp).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
  };

  return (
    <div className="h-full flex flex-col">
      {/* Tab Navigation */}
      <div className="flex-shrink-0 px-4 py-3 border-b border-slate-200">
        <div className="flex gap-1 bg-slate-100 rounded-2xl p-1">
          {tabs.map(t => (
            <button
              key={t.id}
              onClick={() => setTab(t.id)}
              className={`flex-1 py-2.5 px-2 rounded-xl text-xs font-semibold flex items-center justify-center gap-1.5 transition ${
                tab === t.id ? 'bg-brand text-white' : 'text-slate-500 hover:text-slate-600'
              }`}
            >
              <Icon name={t.icon} size={14} />
              {t.label}
            </button>
          ))}
        </div>
      </div>

      {/* FEED TAB */}
      {tab === 'feed' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24 space-y-4">
          {feedPosts.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                <Icon name="globe" size={28} className="text-slate-400" />
              </div>
              <p className="font-semibold text-slate-500">{t('feedEmpty')}</p>
              <p className="text-sm text-slate-400 mt-1">{t('beFirstToShare')}</p>
              <button onClick={() => setTab('create')} className="btn-primary px-6 py-2.5 rounded-xl mt-4 text-sm font-semibold">
                PaylaÅŸ
              </button>
            </div>
          ) : (
            feedPosts.map(post => <PostCard key={post.id} post={post} />)
          )}
        </div>
      )}

      {/* MY POSTS TAB */}
      {tab === 'myPosts' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {myPosts.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                <Icon name="image" size={28} className="text-slate-400" />
              </div>
              <p className="font-semibold text-slate-500">{t('noPostsYetProfile')}</p>
              <p className="text-sm text-slate-400 mt-1">Kombinlerini paylaÅŸarak baÅŸla</p>
              <button onClick={() => setTab('create')} className="btn-primary px-6 py-2.5 rounded-xl mt-4 text-sm font-semibold">
                {t('makeFirstPost')}
              </button>
            </div>
          ) : (
            <div className="grid grid-cols-3 gap-1">
              {myPosts.map(post => (
                <button
                  key={post.id}
                  onClick={() => setSelectedPost(post)}
                  className="aspect-square relative overflow-hidden rounded-lg"
                >
                  <img src={post.image} className="w-full h-full object-cover" loading="lazy" />
                  <div className="absolute inset-0 bg-black/0 hover:bg-slate-900/20 transition flex items-center justify-center opacity-0 hover:opacity-100">
                    <div className="flex gap-3 text-slate-800 text-sm">
                      <span className="flex items-center gap-1"><Icon name="heart" size={14} />{post.likes.length}</span>
                      <span className="flex items-center gap-1"><Icon name="messageCircle" size={14} />{post.comments.length}</span>
                    </div>
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>
      )}

      {/* CREATE TAB */}
      {tab === 'create' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24 space-y-4">
          <h3 className="font-bold text-lg">{t('newPost')}</h3>
          
          {/* Image Selection */}
          {!selectedImage ? (
            <div className="space-y-3">
              <p className="text-sm text-slate-500">PaylaÅŸmak istediÄŸin gÃ¶rseli seÃ§</p>
              
              {/* From Try History */}
              <div className="glass rounded-2xl p-4">
                <p className="text-xs text-slate-400 mb-3 font-semibold">ðŸ“¸ Deneme GeÃ§miÅŸinden</p>
                <div className="grid grid-cols-4 gap-2 max-h-48 overflow-y-auto">
                  {(window.tryHistoryRef || []).slice(0, 12).map((item, i) => (
                    <button
                      key={i}
                      onClick={() => setSelectedImage(item.image)}
                      className="aspect-square rounded-xl overflow-hidden border-2 border-transparent hover:border-brand2 transition"
                    >
                      <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" loading="lazy" />
                    </button>
                  ))}
                </div>
                {(!window.tryHistoryRef || window.tryHistoryRef.length === 0) && (
                  <p className="text-xs text-slate-400 text-center py-4">{t('noTriesYet')}</p>
                )}
              </div>

              {/* From Avatar */}
              <button
                onClick={() => setSelectedImage(user.baseAvatar || user.avatar)}
                className="w-full glass rounded-2xl p-4 flex items-center gap-4 hover:bg-slate-100 transition"
              >
                <div className="w-16 h-20 rounded-xl overflow-hidden">
                  <img src={user.baseAvatar || user.avatar} className="w-full h-full object-cover" />
                </div>
                <div className="text-left">
                  <p className="font-semibold">AvatarÄ±nÄ± PaylaÅŸ</p>
                  <p className="text-xs text-slate-500">Dijital ikizini gÃ¶ster</p>
                </div>
              </button>

              {/* Upload */}
              <label className="w-full glass rounded-2xl p-4 flex items-center justify-center gap-3 cursor-pointer hover:bg-slate-100 transition">
                <Icon name="upload" size={20} className="text-brand2" />
                <span className="font-semibold">Galeriden YÃ¼kle</span>
                <input
                  type="file"
                  accept="image/*"
                  className="hidden"
                  onChange={e => {
                    const file = e.target.files?.[0];
                    if (file) {
                      const reader = new FileReader();
                      reader.onload = (ev) => setSelectedImage(ev.target?.result);
                      reader.readAsDataURL(file);
                    }
                  }}
                />
              </label>
            </div>
          ) : (
            <>
              {/* Preview */}
              <div className="relative">
                <div className="aspect-[3/4] rounded-2xl overflow-hidden">
                  <img src={selectedImage} className="w-full h-full object-cover" />
                </div>
                <button
                  onClick={() => setSelectedImage(null)}
                  className="absolute top-2 right-2 p-2 rounded-xl bg-slate-900/50 backdrop-blur"
                >
                  <Icon name="x" size={18} />
                </button>
              </div>

              {/* Caption */}
              <div>
                <label className="text-xs text-slate-500 mb-1.5 block">AÃ§Ä±klama</label>
                <textarea
                  value={caption}
                  onChange={e => setCaption(e.target.value)}
                  placeholder="Bu kombini nasÄ±l buldunuz? ðŸ’«"
                  rows={3}
                  className="w-full bg-slate-100 border border-slate-200 rounded-xl p-3 text-sm resize-none focus:outline-none focus:border-brand2"
                />
              </div>

              {/* Ask Feedback Toggle */}
              <div className="flex items-center justify-between p-4 rounded-2xl glass">
                <div>
                  <p className="font-medium text-sm">Fikir Ä°ste</p>
                  <p className="text-xs text-slate-500">{t('getFeedbackFromFollowers')}</p>
                </div>
                <button
                  onClick={() => setAskFeedback(!askFeedback)}
                  className={`w-12 h-7 rounded-full transition-all ${askFeedback ? 'bg-accent' : 'bg-slate-200/60'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${askFeedback ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>

              {/* Visibility */}
              <div className="space-y-2">
                <p className="text-xs text-slate-500 font-semibold">Kimler GÃ¶rsÃ¼n?</p>
                <div className="grid grid-cols-3 gap-2">
                  {[
                    { id: 'public', icon: 'globe', label: 'Herkes' },
                    { id: 'friends', icon: 'users', label: t('following') },
                    { id: 'private', icon: 'lock', label: 'Sadece Ben' }
                  ].map(v => (
                    <button
                      key={v.id}
                      onClick={() => setVisibility(v.id)}
                      className={`py-3 rounded-xl text-xs font-semibold flex flex-col items-center gap-1.5 transition ${
                        visibility === v.id ? 'bg-brand text-white' : 'glass text-slate-500'
                      }`}
                    >
                      <Icon name={v.icon} size={18} />
                      {v.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Share Buttons */}
              <div className="space-y-3 pt-2">
                <button
                  onClick={createPost}
                  disabled={posting}
                  className="w-full btn-primary py-4 rounded-2xl font-bold flex items-center justify-center gap-2 disabled:opacity-50"
                >
                  {posting ? (
                    <><div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />PaylaÅŸÄ±lÄ±yor...</>
                  ) : (
                    <><Icon name="send" size={18} />Uygulama Ä°Ã§inde PaylaÅŸ</>
                  )}
                </button>

                <div className="flex items-center gap-3">
                  <div className="flex-1 h-px bg-slate-200/60" />
                  <span className="text-xs text-slate-400">veya</span>
                  <div className="flex-1 h-px bg-slate-200/60" />
                </div>

                <div className="grid grid-cols-4 gap-2">
                  <button
                    onClick={() => shareExternal('instagram', { image: selectedImage, caption })}
                    className="py-3 rounded-xl glass hover:bg-slate-200/60 flex flex-col items-center gap-1"
                  >
                    <div className="w-8 h-8 rounded-lg bg-brand flex items-center justify-center">
                      <Icon name="instagram" size={18} />
                    </div>
                    <span className="text-[10px] text-slate-500">Instagram</span>
                  </button>
                  <button
                    onClick={() => shareExternal('facebook', { image: selectedImage, caption })}
                    className="py-3 rounded-xl glass hover:bg-slate-200/60 flex flex-col items-center gap-1"
                  >
                    <div className="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center">
                      <Icon name="facebook" size={18} />
                    </div>
                    <span className="text-[10px] text-slate-500">Facebook</span>
                  </button>
                  <button
                    onClick={() => shareExternal('twitter', { image: selectedImage, caption })}
                    className="py-3 rounded-xl glass hover:bg-slate-200/60 flex flex-col items-center gap-1"
                  >
                    <div className="w-8 h-8 rounded-lg bg-black flex items-center justify-center">
                      <Icon name="twitter" size={18} />
                    </div>
                    <span className="text-[10px] text-slate-500">X</span>
                  </button>
                  <button
                    onClick={() => shareExternal('whatsapp', { image: selectedImage, caption })}
                    className="py-3 rounded-xl glass hover:bg-slate-200/60 flex flex-col items-center gap-1"
                  >
                    <div className="w-8 h-8 rounded-lg bg-green-500 flex items-center justify-center">
                      <Icon name="whatsapp" size={18} />
                    </div>
                    <span className="text-[10px] text-slate-500">WhatsApp</span>
                  </button>
                </div>
              </div>
            </>
          )}
        </div>
      )}

      {/* FRIENDS TAB */}
      {tab === 'friends' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24 space-y-4">
          {/* Search Users */}
          <div className="relative">
            <Icon name="search" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
            <input
              value={searchQuery}
              onChange={(e) => {
                setSearchQuery(e.target.value);
                if (e.target.value.length >= 2) searchUsers(e.target.value);
              }}
              placeholder="KullanÄ±cÄ± ara (@kullaniciadi)"
              className="w-full pl-11 py-3 rounded-xl bg-slate-100 border-none text-sm"
            />
          </div>
          
          {/* Search Results */}
          {searchResults.length > 0 && (
            <div className="glass rounded-2xl p-3 space-y-2">
              <p className="text-xs text-slate-500 font-semibold">ARAMA SONUÃ‡LARI</p>
              {searchResults.map(u => {
                const isFollowing = friends.some(f => f.id === u.id || f.uid === u.id);
                const isPending = sentFollowRequests?.some(r => r.uid === u.id || r === u.id);
                return (
                  <div key={u.id} className="flex items-center gap-3 p-2 rounded-xl hover:bg-slate-100">
                    <img 
                      src={u.profilePhoto || u.baseAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${u.id}`}
                      className="w-12 h-12 rounded-xl object-cover"
                    />
                    <div className="flex-1">
                      <p className="font-semibold text-sm">{u.displayName || u.username}</p>
                      <p className="text-xs text-slate-500">@{u.username}</p>
                    </div>
                    {isFollowing ? (
                      <span className="text-xs text-green-600 font-medium">Takip Ediliyor</span>
                    ) : isPending ? (
                      <span className="text-xs text-amber-600 font-medium">Ä°stek GÃ¶nderildi</span>
                    ) : (
                      <button 
                        onClick={() => followUser(u)}
                        className="btn-primary px-4 py-2 rounded-xl text-xs font-semibold"
                      >
                        Takip Et
                      </button>
                    )}
                  </div>
                );
              })}
            </div>
          )}
          
          {/* Follow Requests */}
          {followRequests && followRequests.length > 0 && (
            <div className="glass rounded-2xl p-3 space-y-2">
              <p className="text-xs text-slate-500 font-semibold">TAKÄ°P Ä°STEKLERÄ°</p>
              {followRequests.map(req => (
                <div key={req.id || req.fromUid} className="flex items-center gap-3 p-2 rounded-xl bg-amber-50">
                  <img 
                    src={req.fromPhoto || req.fromAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${req.fromUid || req.fromUserId}`}
                    className="w-12 h-12 rounded-xl object-cover"
                  />
                  <div className="flex-1">
                    <p className="font-semibold text-sm">{req.fromDisplayName || req.fromUsername}</p>
                    <p className="text-xs text-slate-500">Seni takip etmek istiyor</p>
                  </div>
                  <div className="flex gap-2">
                    <button 
                      onClick={() => acceptRequest(req)}
                      className="btn-primary px-3 py-1.5 rounded-lg text-xs font-semibold"
                    >
                      Kabul
                    </button>
                    <button 
                      onClick={async () => {
                        // Reject and delete request
                        if (db && authUser?.uid) {
                          const fromUid = req.fromUid || req.fromUserId;
                          await db.collection('users').doc(authUser.uid).collection('followRequests').doc(fromUid).delete().catch(() => {});
                          if (req.id && req.id !== fromUid) {
                            await db.collection('users').doc(authUser.uid).collection('followRequests').doc(req.id).delete().catch(() => {});
                          }
                          await db.collection('users').doc(fromUid).collection('sentFollowRequests').doc(authUser.uid).delete().catch(() => {});
                        }
                        setFollowRequests(prev => prev.filter(r => r.id !== req.id && r.fromUid !== req.fromUid));
                      }}
                      className="btn-ghost px-3 py-1.5 rounded-lg text-xs"
                    >
                      Reddet
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
          
          {/* Following List */}
          <div className="space-y-2">
            <p className="text-xs text-slate-500 font-semibold">TAKÄ°P EDÄ°LENLER ({friends.length})</p>
            {friends.length === 0 ? (
              <div className="text-center py-8 glass rounded-2xl">
                <Icon name="users" size={32} className="mx-auto text-slate-300 mb-2" />
                <p className="text-slate-500 text-sm">HenÃ¼z kimseyi takip etmiyorsun</p>
                <p className="text-slate-400 text-xs">YukarÄ±dan kullanÄ±cÄ± ara</p>
              </div>
            ) : (
              friends.map(friend => (
                <div key={friend.id} className="flex items-center gap-3 p-3 glass rounded-xl">
                  <img 
                    src={friend.profilePhoto || friend.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${friend.id}`}
                    className="w-12 h-12 rounded-xl object-cover"
                  />
                  <div className="flex-1">
                    <p className="font-semibold text-sm">{friend.displayName || friend.username}</p>
                    {friend.username && <p className="text-xs text-slate-500">@{friend.username}</p>}
                  </div>
                  <button 
                    onClick={() => {
                      // Start chat with this friend
                      const chatId = [authUser?.uid, friend.id].sort().join('_');
                      const existingChat = dmChats?.find(c => c.id === chatId);
                      if (existingChat) {
                        setSelectedChat(existingChat);
                      } else {
                        setSelectedChat({ 
                          id: chatId, 
                          type: 'dm', 
                          recipientId: friend.id, 
                          name: friend.displayName || friend.username,
                          avatar: friend.profilePhoto || friend.avatar,
                          messages: [] 
                        });
                      }
                      setTab('messages');
                    }}
                    className="p-2 rounded-xl bg-slate-100 hover:bg-slate-200"
                  >
                    <Icon name="mail" size={18} className="text-slate-600" />
                  </button>
                </div>
              ))
            )}
          </div>
        </div>
      )}

      {/* MESSAGES TAB */}
      {tab === 'messages' && (
        <div className="flex-1 overflow-hidden flex flex-col">
          {!selectedChat ? (
            // Chat List
            <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-2">
              {/* Action Buttons */}
              <div className="flex gap-2 mb-4">
                <button 
                  onClick={() => setShowNewChat(true)}
                  className="flex-1 btn-primary py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                >
                  <Icon name="mail" size={18} />Yeni Mesaj
                </button>
                <button 
                  onClick={() => setShowCreateGroup(true)}
                  className="flex-1 btn-ghost py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
                >
                  <Icon name="users" size={18} />{t('createGroup')}
                </button>
              </div>
              
              {/* Gruplar */}
              {groups && groups.length > 0 && (
                <div className="mb-4">
                  <p className="text-xs font-semibold text-slate-500 mb-2 uppercase">Gruplar</p>
                  <div className="space-y-2">
                    {groups.filter(g => g.members?.some(m => m.id === authUser?.uid)).map(group => {
                      const lastMsg = (group.messages || []).slice(-1)[0];
                      return (
                        <button
                          key={group.id}
                          onClick={() => setSelectedChat({ type: 'group', ...group })}
                          className="w-full flex items-center gap-3 p-3 glass rounded-xl text-left hover:bg-slate-100"
                        >
                          <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-brand to-purple-500 flex items-center justify-center">
                            <Icon name="users" size={20} className="text-white" />
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              <p className="font-semibold text-sm">{group.name}</p>
                              <span className="text-[10px] bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded">{group.members?.length || 0} Ã¼ye</span>
                            </div>
                            <p className="text-xs text-slate-500 truncate">
                              {lastMsg ? `${lastMsg.senderName}: ${lastMsg.text}` : (group.topic || 'HenÃ¼z mesaj yok')}
                            </p>
                          </div>
                          <Icon name="chevronRight" size={18} className="text-slate-400" />
                        </button>
                      );
                    })}
                  </div>
                </div>
              )}
              
              {/* DM'ler */}
              {(groups && groups.length > 0) && <p className="text-xs font-semibold text-slate-500 mb-2 uppercase">Direkt Mesajlar</p>}
              
              {(!dmChats || dmChats.length === 0) && (!groups || groups.length === 0) ? (
                <div className="text-center py-12">
                  <Icon name="mail" size={32} className="mx-auto text-slate-300 mb-2" />
                  <p className="text-slate-500 text-sm">HenÃ¼z mesajÄ±n yok</p>
                  <p className="text-slate-400 text-xs">ArkadaÅŸlarÄ±na mesaj gÃ¶nder veya grup oluÅŸtur</p>
                </div>
              ) : (
                dmChats.map(chat => (
                  <button
                    key={chat.id}
                    onClick={async () => {
                      // Load messages from Firebase when selecting chat
                      setSelectedChat({ ...chat, type: 'dm', messages: [], loading: true });
                      if (db && chat.id) {
                        try {
                          const messagesSnap = await db.collection('chats').doc(chat.id)
                            .collection('messages')
                            .orderBy('timestamp', 'asc')
                            .limit(100)
                            .get();
                          const messages = messagesSnap.docs.map(doc => {
                            const data = doc.data();
                            return {
                              id: doc.id,
                              senderId: data.senderId,
                              senderName: data.senderName,
                              text: data.text,
                              type: data.type || 'text',
                              image: data.image || null,
                              items: data.items || [],
                              timestamp: data.timestamp?.toMillis?.() || data.createdAt || Date.now(),
                              read: data.read
                            };
                          });
                          console.log('ðŸ“¨ SocialFeed messages loaded:', messages.length, messages.map(m => ({ type: m.type, hasImage: !!m.image })));
                          setSelectedChat(prev => prev?.id === chat.id ? { ...prev, messages, loading: false } : prev);
                        } catch(err) {
                          console.error('Messages load error:', err);
                          setSelectedChat(prev => prev?.id === chat.id ? { ...prev, loading: false } : prev);
                        }
                      }
                    }}
                    className="w-full flex items-center gap-3 p-3 glass rounded-xl text-left hover:bg-slate-100"
                  >
                    <img 
                      src={chat.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${chat.recipientId}`}
                      className="w-12 h-12 rounded-xl object-cover"
                    />
                    <div className="flex-1 min-w-0">
                      <p className="font-semibold text-sm">{chat.name}</p>
                      <p className="text-xs text-slate-500 truncate">{chat.lastMessage || 'Mesaj yok'}</p>
                    </div>
                    <Icon name="chevronRight" size={18} className="text-slate-400" />
                  </button>
                ))
              )}
            </div>
          ) : selectedChat.type === 'group' ? (
            // Group Chat View
            <div className="flex-1 flex flex-col overflow-hidden">
              {/* Group Header */}
              <div className="flex-shrink-0 p-3 border-b border-slate-200 flex items-center gap-3">
                <button onClick={() => setSelectedChat(null)} className="p-2 -ml-2 rounded-xl hover:bg-slate-100">
                  <Icon name="chevronLeft" size={20} />
                </button>
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-brand to-purple-500 flex items-center justify-center">
                  <Icon name="users" size={18} className="text-white" />
                </div>
                <div className="flex-1">
                  <p className="font-semibold">{selectedChat.name}</p>
                  <p className="text-xs text-slate-500">{selectedChat.members?.length || 0} Ã¼ye {selectedChat.topic && `â€¢ ${selectedChat.topic}`}</p>
                </div>
                {/* Grup ayarlarÄ± (sadece admin iÃ§in) */}
                {selectedChat.creatorId === authUser?.uid && (
                  <button 
                    onClick={() => {
                      setEditingGroup(selectedChat);
                      setGroupName(selectedChat.name);
                      setGroupTopic(selectedChat.topic || '');
                      setShowEditGroup(true);
                    }}
                    className="p-2 rounded-xl hover:bg-slate-100"
                  >
                    <Icon name="settings" size={18} />
                  </button>
                )}
                <button 
                  onClick={() => leaveGroup(selectedChat.id)}
                  className="p-2 rounded-xl hover:bg-red-100 text-red-500"
                >
                  <Icon name="logout" size={18} />
                </button>
              </div>
              
              {/* Group Members Preview */}
              <div className="flex-shrink-0 px-3 py-2 border-b border-slate-100 flex gap-1 overflow-x-auto no-scrollbar">
                {selectedChat.members?.slice(0, 6).map(member => (
                  <div key={member.id} className="flex-shrink-0 flex flex-col items-center">
                    <div className="w-8 h-8 rounded-full overflow-hidden bg-slate-200">
                      {member.avatar ? (
                        <img src={member.avatar} className="w-full h-full object-cover" />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-xs">ðŸ‘¤</div>
                      )}
                    </div>
                    <span className="text-[9px] text-slate-500 truncate max-w-[40px]">{member.name?.split(' ')[0]}</span>
                  </div>
                ))}
                {selectedChat.members?.length > 6 && (
                  <div className="flex-shrink-0 flex flex-col items-center">
                    <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500">
                      +{selectedChat.members.length - 6}
                    </div>
                  </div>
                )}
              </div>
              
              {/* Group Messages */}
              <div className="flex-1 min-h-0 overflow-y-auto custom-scroll p-4 space-y-3">
                {(selectedChat.messages || []).length === 0 ? (
                  <div className="text-center py-8 text-slate-400 text-sm">
                    Grup henÃ¼z oluÅŸturuldu. Ä°lk mesajÄ± sen gÃ¶nder!
                  </div>
                ) : (
                  (selectedChat.messages || []).map(msg => {
                    const isMine = msg.senderId === authUser?.uid;
                    return (
                      <div key={msg.id} className={`flex ${isMine ? 'justify-end' : 'justify-start'}`}>
                        {!isMine && (
                          <div className="w-6 h-6 rounded-full overflow-hidden mr-2 flex-shrink-0">
                            {msg.senderAvatar ? (
                              <img src={msg.senderAvatar} className="w-full h-full object-cover" />
                            ) : (
                              <div className="w-full h-full bg-slate-200 flex items-center justify-center text-[10px]">ðŸ‘¤</div>
                            )}
                          </div>
                        )}
                        <div className={`max-w-[70%]`}>
                          {!isMine && (
                            <p className="text-[10px] text-slate-500 mb-0.5 ml-1">{msg.senderName}</p>
                          )}
                          <div className={`px-4 py-2.5 rounded-2xl ${
                            isMine ? 'bg-brand text-white rounded-br-md' : 'glass rounded-bl-md'
                          }`}>
                            <p className="text-sm">{msg.text}</p>
                          </div>
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
              
              {/* Group Message Input */}
              <div className="p-3 border-t border-slate-200 flex gap-2 safe-bottom">
                <input
                  value={newMessage}
                  onChange={e => setNewMessage(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && sendGroupMessage()}
                  placeholder="Gruba mesaj yaz..."
                  className="flex-1 py-2.5 px-4 rounded-xl bg-slate-100 border-none text-sm"
                />
                <button 
                  onClick={sendGroupMessage}
                  disabled={!newMessage.trim()}
                  className="btn-primary px-4 rounded-xl disabled:opacity-50"
                >
                  <Icon name="send" size={18} />
                </button>
              </div>
            </div>
          ) : (
            // Chat View
            <div className="flex-1 flex flex-col overflow-hidden">
              {/* Chat Header */}
              <div className="flex-shrink-0 p-3 border-b border-slate-200 flex items-center gap-3">
                <button onClick={() => setSelectedChat(null)} className="p-2 -ml-2 rounded-xl hover:bg-slate-100">
                  <Icon name="chevronLeft" size={20} />
                </button>
                <img 
                  src={selectedChat.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${selectedChat.recipientId}`}
                  className="w-10 h-10 rounded-xl object-cover"
                />
                <div className="flex-1">
                  <p className="font-semibold">{selectedChat.name}</p>
                </div>
              </div>
              
              {/* Messages */}
              <div className="flex-1 min-h-0 overflow-y-auto custom-scroll p-4 space-y-3">
                {selectedChat.loading ? (
                  <div className="flex items-center justify-center py-8">
                    <div className="w-6 h-6 border-2 border-brand/30 border-t-brand rounded-full animate-spin" />
                  </div>
                ) : (selectedChat.messages || []).length === 0 ? (
                  <div className="text-center py-8 text-slate-400 text-sm">
                    HenÃ¼z mesaj yok. Ä°lk mesajÄ± sen gÃ¶nder!
                  </div>
                ) : (
                  (selectedChat.messages || []).map(msg => {
                    const isMine = msg.senderId === authUser?.uid;
                    return (
                      <div key={msg.id} className={`flex ${isMine ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[80%] px-4 py-2.5 rounded-2xl ${
                          isMine ? 'bg-brand text-white rounded-br-md' : 'glass rounded-bl-md'
                        }`}>
                          {msg.type === 'combo' && msg.image && (
                            <div className="mb-2">
                              <img src={msg.image} className="rounded-lg max-w-full max-h-64 object-contain" />
                              {msg.items && msg.items.length > 0 && (
                                <p className={`text-xs mt-1 ${isMine ? 'text-white/70' : 'text-slate-500'}`}>
                                  {msg.items.length} Ã¼rÃ¼nlÃ¼ kombin
                                </p>
                              )}
                            </div>
                          )}
                          <p className="text-sm">{msg.text}</p>
                          {msg.type !== 'combo' && msg.image && (
                            <img src={msg.image} className="mt-2 rounded-lg max-w-full max-h-48 object-contain" />
                          )}
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
              
              {/* Message Input */}
              <div className="p-3 border-t border-slate-200 flex gap-2 safe-bottom">
                <input
                  value={newMessage}
                  onChange={e => setNewMessage(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && sendMessage()}
                  placeholder="Mesaj yaz..."
                  className="flex-1 py-2.5 px-4 rounded-xl bg-slate-100 border-none text-sm"
                />
                <button onClick={sendMessage} className="btn-primary px-4 rounded-xl">
                  <Icon name="send" size={18} />
                </button>
              </div>
            </div>
          )}
          
          {/* New Chat Modal */}
          {showNewChat && (
            <div className="fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4">
              <div className="w-full max-w-sm glass rounded-3xl p-5 max-h-[70vh] overflow-y-auto">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-bold">Yeni Mesaj</h3>
                  <button onClick={() => setShowNewChat(false)} className="p-2 rounded-xl hover:bg-slate-200/60">
                    <Icon name="x" size={20} />
                  </button>
                </div>
                
                {friends.length === 0 ? (
                  <p className="text-center text-slate-500 py-4">Ã–nce arkadaÅŸ ekle</p>
                ) : (
                  <div className="space-y-2">
                    {friends.map(friend => (
                      <button
                        key={friend.id}
                        onClick={() => {
                          const chatId = [authUser?.uid, friend.id].sort().join('_');
                          setSelectedChat({ 
                            id: chatId, 
                            type: 'dm', 
                            recipientId: friend.id, 
                            name: friend.displayName || friend.username,
                            avatar: friend.profilePhoto || friend.avatar,
                            messages: [] 
                          });
                          setShowNewChat(false);
                        }}
                        className="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-100"
                      >
                        <img 
                          src={friend.profilePhoto || friend.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${friend.id}`}
                          className="w-10 h-10 rounded-xl object-cover"
                        />
                        <span className="font-medium">{friend.displayName || friend.username}</span>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}
          
          {/* Create Group Modal */}
          {showCreateGroup && (
            <div className="fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4">
              <div className="w-full max-w-md glass rounded-3xl p-5 max-h-[80vh] overflow-y-auto">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-bold text-lg">{t('createGroup')}</h3>
                  <button onClick={() => { setShowCreateGroup(false); setSelectedGroupMembers([]); setGroupName(''); setGroupTopic(''); }} className="p-2 rounded-xl hover:bg-slate-200/60">
                    <Icon name="x" size={20} />
                  </button>
                </div>
                
                {/* Grup Bilgileri */}
                <div className="space-y-4 mb-6">
                  <div>
                    <label className="text-xs font-semibold text-slate-500 mb-1.5 block">{t('groupName')} *</label>
                    <input
                      value={groupName}
                      onChange={e => setGroupName(e.target.value)}
                      placeholder="Ã¶rn: Stil TakÄ±mÄ±"
                      className="w-full"
                      maxLength={30}
                    />
                  </div>
                  <div>
                    <label className="text-xs font-semibold text-slate-500 mb-1.5 block">{t('groupTopic')}</label>
                    <input
                      value={groupTopic}
                      onChange={e => setGroupTopic(e.target.value)}
                      placeholder="Ã¶rn: HaftalÄ±k kombin paylaÅŸÄ±mÄ±"
                      className="w-full"
                      maxLength={50}
                    />
                  </div>
                </div>
                
                {/* Ãœye SeÃ§imi */}
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <label className="text-xs font-semibold text-slate-500">{t('selectMembers')} (min. 2 kiÅŸi)</label>
                    <span className="text-xs text-brand font-bold">{selectedGroupMembers.length}/9 seÃ§ili</span>
                  </div>
                  
                  <p className="text-[10px] text-slate-400 mb-3">{t('onlyFollowersCanJoin')}</p>
                  
                  {friends.length === 0 ? (
                    <div className="text-center py-6 bg-slate-50 rounded-xl">
                      <Icon name="users" size={24} className="mx-auto text-slate-300 mb-2" />
                      <p className="text-slate-500 text-sm">Ã–nce birilerini takip et</p>
                    </div>
                  ) : (
                    <div className="space-y-2 max-h-[200px] overflow-y-auto custom-scroll">
                      {friends.map(friend => {
                        const isSelected = selectedGroupMembers.some(m => m.id === friend.id);
                        return (
                          <button
                            key={friend.id}
                            onClick={() => {
                              if (isSelected) {
                                setSelectedGroupMembers(prev => prev.filter(m => m.id !== friend.id));
                              } else if (selectedGroupMembers.length < 9) {
                                setSelectedGroupMembers(prev => [...prev, {
                                  id: friend.id,
                                  name: friend.displayName || friend.username,
                                  avatar: friend.profilePhoto || friend.avatar
                                }]);
                              }
                            }}
                            className={`w-full flex items-center gap-3 p-2.5 rounded-xl transition ${
                              isSelected ? 'bg-brand/10 ring-2 ring-brand' : 'hover:bg-slate-100'
                            }`}
                          >
                            <img 
                              src={friend.profilePhoto || friend.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${friend.id}`}
                              className="w-10 h-10 rounded-xl object-cover"
                            />
                            <span className="flex-1 text-left font-medium text-sm">{friend.displayName || friend.username}</span>
                            <div className={`w-5 h-5 rounded-full flex items-center justify-center ${
                              isSelected ? 'bg-brand' : 'bg-slate-200'
                            }`}>
                              {isSelected && <Icon name="check" size={12} className="text-white" />}
                            </div>
                          </button>
                        );
                      })}
                    </div>
                  )}
                </div>
                
                {/* OluÅŸtur Butonu */}
                <button
                  onClick={createGroup}
                  disabled={selectedGroupMembers.length < 2 || !groupName.trim()}
                  className="w-full btn-primary py-3 rounded-xl font-bold mt-6 disabled:opacity-50 flex items-center justify-center gap-2"
                >
                  <Icon name="users" size={18} />
                  Grup OluÅŸtur ({selectedGroupMembers.length + 1} kiÅŸi)
                </button>
              </div>
            </div>
          )}
          
          {/* Edit Group Modal */}
          {showEditGroup && editingGroup && (
            <div className="fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4">
              <div className="w-full max-w-sm glass rounded-3xl p-5">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-bold">{t('editGroup')}</h3>
                  <button onClick={() => { setShowEditGroup(false); setEditingGroup(null); }} className="p-2 rounded-xl hover:bg-slate-200/60">
                    <Icon name="x" size={20} />
                  </button>
                </div>
                
                <div className="space-y-4">
                  <div>
                    <label className="text-xs font-semibold text-slate-500 mb-1.5 block">{t('groupName')}</label>
                    <input
                      value={groupName}
                      onChange={e => setGroupName(e.target.value)}
                      className="w-full"
                      maxLength={30}
                    />
                  </div>
                  <div>
                    <label className="text-xs font-semibold text-slate-500 mb-1.5 block">{t('groupTopic')}</label>
                    <input
                      value={groupTopic}
                      onChange={e => setGroupTopic(e.target.value)}
                      className="w-full"
                      maxLength={50}
                    />
                  </div>
                </div>
                
                <button
                  onClick={updateGroupSettings}
                  className="w-full btn-primary py-3 rounded-xl font-bold mt-6"
                >
                  Kaydet
                </button>
              </div>
            </div>
          )}
        </div>
      )}

      {/* Post Detail Modal */}
      {selectedPost && (
        <div className="fixed inset-0 z-[90] bg-black/90 flex flex-col slide-up">
          <div className="p-4 flex items-center justify-between border-b border-slate-200">
            <button onClick={() => setSelectedPost(null)} className="p-2 -ml-2">
              <Icon name="chevronLeft" size={24} />
            </button>
            <h3 className="font-bold">{t('post')}</h3>
            <div className="w-10" />
          </div>
          
          <div className="flex-1 overflow-y-auto custom-scroll">
            <PostCard post={selectedPost} showActions={true} />
            
            {/* Comments */}
            <div className="p-4 space-y-3">
              <h4 className="font-semibold text-sm">{t('comments')}</h4>
              {selectedPost.comments.length === 0 ? (
                <p className="text-sm text-slate-400">{t('noCommentsYet')}</p>
              ) : (
                selectedPost.comments.map(c => (
                  <div key={c.id} className="flex gap-3">
                    <div className="w-8 h-8 rounded-full bg-slate-200/60 flex items-center justify-center text-xs">ðŸ‘¤</div>
                    <div className="flex-1">
                      <p className="text-sm">
                        <span className="font-semibold">{c.authorName}</span>{' '}
                        <span className="text-slate-700">{c.text}</span>
                      </p>
                      <p className="text-xs text-slate-400 mt-0.5">{getTimeAgo(c.createdAt)}</p>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>

          {/* Comment Input */}
          <div className="p-4 border-t border-slate-200 flex gap-3 safe-bottom">
            <input
              type="text"
              value={comment}
              onChange={e => setComment(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && addComment(selectedPost.id)}
              placeholder={t('writeComment')}
              className="flex-1"
            />
            <button onClick={() => addComment(selectedPost.id)} className="btn-primary px-5 rounded-xl">
              <Icon name="send" size={18} />
            </button>
          </div>

          {/* Delete option for owner */}
          {selectedPost.authorId === authUser?.uid && (
            <div className="absolute top-4 right-4">
              <button 
                onClick={() => deletePost(selectedPost.id)}
                className="p-2 rounded-xl bg-red-500/20 hover:bg-red-500/30"
              >
                <Icon name="trash" size={18} className="text-red-400" />
              </button>
            </div>
          )}
        </div>
      )}

      {/* Share Modal */}
      {shareModal.open && shareModal.post && (
        <div className="fixed inset-0 z-[100] bg-black/80 flex items-end justify-center p-4">
          <div className="w-full max-w-lg glass rounded-3xl p-6 scale-in safe-bottom">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-bold text-lg">{t('share')}</h3>
              <button onClick={() => setShareModal({ open: false, post: null })} className="p-2 rounded-xl hover:bg-slate-200/60">
                <Icon name="x" size={20} />
              </button>
            </div>
            
            <div className="grid grid-cols-4 gap-4 mb-4">
              {navigator.share && (
                <button
                  onClick={() => shareExternal('native', shareModal.post)}
                  className="py-4 rounded-xl glass hover:bg-slate-200/60 flex flex-col items-center gap-2"
                >
                  <Icon name="share" size={24} className="text-brand2" />
                  <span className="text-xs">{t('share')}</span>
                </button>
              )}
              <button
                onClick={() => shareExternal('instagram', shareModal.post)}
                className="py-4 rounded-xl glass hover:bg-slate-200/60 flex flex-col items-center gap-2"
              >
                <div className="w-10 h-10 rounded-xl bg-brand flex items-center justify-center">
                  <Icon name="instagram" size={20} />
                </div>
                <span className="text-xs">Instagram</span>
              </button>
              <button
                onClick={() => shareExternal('facebook', shareModal.post)}
                className="py-4 rounded-xl glass hover:bg-slate-200/60 flex flex-col items-center gap-2"
              >
                <div className="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center">
                  <Icon name="facebook" size={20} />
                </div>
                <span className="text-xs">Facebook</span>
              </button>
              <button
                onClick={() => shareExternal('whatsapp', shareModal.post)}
                className="py-4 rounded-xl glass hover:bg-slate-200/60 flex flex-col items-center gap-2"
              >
                <div className="w-10 h-10 rounded-xl bg-green-500 flex items-center justify-center">
                  <Icon name="whatsapp" size={20} />
                </div>
                <span className="text-xs">WhatsApp</span>
              </button>
            </div>

            <button
              onClick={() => {
                navigator.clipboard?.writeText(`TrAi ile denedim! ${shareModal.post.caption || ''}`);
                setToast({ open: true, type: 'success', title: 'KopyalandÄ±', message: 'Link panoya kopyalandÄ±' });
                setShareModal({ open: false, post: null });
              }}
              className="w-full btn-secondary py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
            >
              <Icon name="copy" size={18} />
              Linki Kopyala
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

// ============ CONSENT POPUP ============
const ConsentPopup = ({ type, onAccept, onDecline, onDontShowAgain }) => {
  const isSharing = type === 'sharing';
  
  return (
    <div className="fixed inset-0 z-[100] bg-black/60 flex items-end sm:items-center justify-center p-4 fade-in">
      <div className="w-full max-w-sm bg-white rounded-3xl overflow-hidden shadow-2xl slide-up">
        <div className="p-6 text-center">
          <div className={`w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4 ${isSharing ? 'bg-brand/10' : 'bg-amber-100'}`}>
            <Icon name={isSharing ? 'share' : 'sparkles'} size={32} className={isSharing ? 'text-brand' : 'text-amber-500'} />
          </div>
          <h3 className="text-xl font-bold mb-2">{t(isSharing ? 'sharingConsentTitle' : 'analyticsConsentTitle')}</h3>
          <p className="text-slate-500 text-sm mb-6">{t(isSharing ? 'sharingConsentDesc' : 'analyticsConsentDesc')}</p>
          
          <div className="space-y-2">
            <button 
              onClick={onAccept}
              className="w-full btn-primary py-3.5 rounded-2xl font-bold"
            >
              {t(isSharing ? 'allowSharing' : 'allowAnalytics')}
            </button>
            <button 
              onClick={onDecline}
              className="w-full btn-ghost py-3 rounded-2xl font-medium text-sm"
            >
              {t('maybeLater')}
            </button>
          </div>
          
          <button 
            onClick={onDontShowAgain}
            className="mt-4 text-xs text-slate-400 hover:text-slate-600"
          >
            {t('dontShowAgain')}
          </button>
        </div>
      </div>
    </div>
  );
};

// ============ BOTTOM NAV ============
const BottomNav = ({ tab, setTab, hasNotifications }) => (
  <div className="flex-shrink-0 bg-white/95 backdrop-blur-xl border-t border-slate-200 p-2 pb-4 safe-bottom shadow-lg">
    <div className="flex justify-around">
      {[
        { id: 'shop', icon: 'shop', labelKey: 'explore' }, 
        { id: 'closet', icon: 'hanger', labelKey: 'closet' }, 
        { id: 'social', icon: 'world', labelKey: 'social' },
        { id: 'profile', icon: 'user', labelKey: 'profile' }
      ].map(item => (
        <button key={item.id} onClick={() => setTab(item.id)} className={`relative flex flex-col items-center gap-1 py-2 px-4 rounded-2xl transition ${tab === item.id ? 'text-brand bg-brand/10' : 'text-slate-600 hover:text-slate-900 hover:bg-slate-100'}`}>
          <Icon name={item.icon} size={20} />
          <span className="text-[10px] font-bold">{t(item.labelKey)}</span>
          {item.id === 'social' && hasNotifications && (
            <div className="absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full" />
          )}
        </button>
      ))}
    </div>
  </div>
);

// ============ MAIN APP ============
const App = () => {
  const [toast, setToast] = useState({ open: false });
  const [authUser, setAuthUser] = useState(null);
  const [user, setUser] = useState(null);
  const [loadingAvatar, setLoadingAvatar] = useState(false); // Avatar yÃ¼klenirken bekleme durumu
  const [closet, setCloset] = useState([]);
  const [tab, setTab] = useState('shop');
  const [trying, setTrying] = useState(false);
  const [tryItem, setTryItem] = useState(null);
  const [result, setResult] = useState({ open: false, image: null, item: null });
  const [advice, setAdvice] = useState({ open: false, item: null, text: '', loading: false });
  const [lastTryTime, setLastTryTime] = useState(0);
  const COOLDOWN_MS = 30000;
  
  // Referral code from URL
  const [pendingReferralCode, setPendingReferralCode] = useState(null);
  
  // URL'den referral kodunu yakala
  React.useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref');
    if (refCode) {
      console.log('ðŸŽ Referral code detected:', refCode);
      setPendingReferralCode(refCode);
      // URL'den parametreyi temizle (history'yi deÄŸiÅŸtirmeden)
      const newUrl = window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    }
  }, []);
  
  // Language state for re-rendering
  const [lang, setLang] = useState(currentLanguage);
  
  // Update language and trigger re-render
  const changeLanguage = (newLang) => {
    setLanguage(newLang);
    setLang(newLang);
  };
  
  // Social features state
  const [friends, setFriends] = useState([]);
  const [messages, setMessages] = useState([]);
  const [followRequests, setFollowRequests] = useState([]); // Incoming follow requests
  const [sentFollowRequests, setSentFollowRequests] = useState([]); // Outgoing pending requests
  const [notifications, setNotifications] = useState([]); // All notifications
  const [dmChats, setDmChats] = useState([]); // DM conversations
  const [selectedChat, setSelectedChat] = useState(null); // Currently open chat
  const [groups, setGroups] = useState([]); // Group chats
  const [settings, setSettings] = useState({
    profilePublic: true,
    combosPublic: true,
    showOnline: true,
    notifyMessages: true,
    notifyFriends: true,
    notifyDailyOutfit: true, // GÃ¼nlÃ¼k Ã¶neri bildirimi
    debugMode: true, // GeliÅŸtirici modu varsayÄ±lan aÃ§Ä±k
    sharingConsent: null, // null = not asked, true = accepted, false = declined
    analyticsConsent: null,
    sharingConsentDismissed: false, // Bir daha gÃ¶sterme
    analyticsConsentDismissed: false
  });
  
  // Consent popup state
  const [consentPopup, setConsentPopup] = useState({ open: false, type: null });
  
  // Closet features state
  const [savedCombos, setSavedCombos] = useState([]);
  const [favorites, setFavorites] = useState([]);
  const [tryHistory, setTryHistory] = useState([]);
  const [tryOnCache, setTryOnCache] = useState({});
  
  // Social feed state
  const [posts, setPosts] = useState([]);
  
  // DM Share Modal state
  const [dmShareModal, setDmShareModal] = useState({ open: false, image: null, items: [] });
  
  // Daily recommendation state
  const [dailyRecommendation, setDailyRecommendation] = useState(null);
  const [showDailyModal, setShowDailyModal] = useState(false);
  const [dailyWeather, setDailyWeather] = useState(null);
  
  // Cart & Payment state
  const [cart, setCart] = useState([]);
  const [savedAddresses, setSavedAddresses] = useState([]);
  const [showCart, setShowCart] = useState(false);
  const [showPayment, setShowPayment] = useState(false);
  const [showSubscription, setShowSubscription] = useState(false);
  const [paymentType, setPaymentType] = useState(null); // 'cart', 'subscription', 'tokens', 'videoTokens'
  const [paymentLoading, setPaymentLoading] = useState(false);
  const [tokenAmount, setTokenAmount] = useState(0);
  const [tokenPrice, setTokenPrice] = useState(0);
  
  // Paywall state
  const [showPaywall, setShowPaywall] = useState(false);
  const [paywallType, setPaywallType] = useState(null); // 'weeklyTries', 'comboTries', 'videoAccess', 'clothingUpload'
  
  // Avatar prompt state - ilk deneme iÃ§in avatar oluÅŸturma ekranÄ±
  const [showAvatarPrompt, setShowAvatarPrompt] = useState(false);
  const [showAvatarWizard, setShowAvatarWizard] = useState(false);
  
  // Size selection modal state
  const [sizeModal, setSizeModal] = useState({ open: false, product: null, callback: null });
  
  // Available sizes
  const AVAILABLE_SIZES = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '2XL', '3XL'];

  // Check cooldown before AI request
  // Cart functions - with size selection
  const addToCart = (product, options = {}) => {
    // If size already provided, add directly
    if (options.size || product.selectedSize) {
      const productWithSize = { 
        ...product, 
        selectedSize: options.size || product.selectedSize,
        quantity: 1 
      };
      setCart(prev => {
        const exists = prev.find(p => p.id === product.id && p.selectedSize === productWithSize.selectedSize);
        if (exists) {
          return prev.map(p => (p.id === product.id && p.selectedSize === productWithSize.selectedSize) 
            ? { ...p, quantity: (p.quantity || 1) + 1 } 
            : p);
        }
        return [...prev, productWithSize];
      });
      setToast({ open: true, type: 'success', title: t('addedToCart'), message: `${product.name} - ${productWithSize.selectedSize}` });
      return;
    }
    
    // Otherwise, open size selection modal
    setSizeModal({ 
      open: true, 
      product,
      callback: (size) => {
        const productWithSize = { ...product, selectedSize: size, quantity: 1 };
        setCart(prev => {
          const exists = prev.find(p => p.id === product.id && p.selectedSize === size);
          if (exists) {
            return prev.map(p => (p.id === product.id && p.selectedSize === size) 
              ? { ...p, quantity: (p.quantity || 1) + 1 } 
              : p);
          }
          return [...prev, productWithSize];
        });
        setToast({ open: true, type: 'success', title: t('addedToCart'), message: `${product.name} - ${size}` });
      }
    });
  };
  
  // Add multiple items to cart (from combo) - asks size for each
  const addMultipleToCart = async (items) => {
    if (!items || items.length === 0) return;
    
    let currentIndex = 0;
    
    const askNextSize = () => {
      if (currentIndex >= items.length) {
        setToast({ open: true, type: 'success', title: 'âœ… TamamlandÄ±', message: `${items.length} Ã¼rÃ¼n sepete eklendi` });
        return;
      }
      
      const item = items[currentIndex];
      setSizeModal({
        open: true,
        product: item,
        currentIndex: currentIndex + 1,
        totalItems: items.length,
        callback: (size) => {
          const productWithSize = { ...item, selectedSize: size, quantity: 1 };
          setCart(prev => [...prev, productWithSize]);
          currentIndex++;
          // Ask for next item after a short delay
          setTimeout(askNextSize, 300);
        }
      });
    };
    
    askNextSize();
  };
  
  // Expose addMultipleToCart globally for child components
  useEffect(() => {
    window.addMultipleToCart = addMultipleToCart;
    return () => { delete window.addMultipleToCart; };
  }, []);
  
  // Expose DM share modal and upload function globally
  useEffect(() => {
    window.openDMShareModal = (image, items) => {
      setDmShareModal({ open: true, image, items: items || [] });
    };
    window.uploadAndShareImage = uploadAndShareImage;
    window.storage = storage;
    return () => { 
      delete window.openDMShareModal; 
      delete window.uploadAndShareImage;
      delete window.storage;
    };
  }, [storage]);
  
  const removeFromCart = (productId) => {
    setCart(prev => prev.filter(p => p.id !== productId));
  };
  
  const updateCartQuantity = (productId, quantity) => {
    if (quantity <= 0) {
      removeFromCart(productId);
    } else {
      setCart(prev => prev.map(p => p.id === productId ? { ...p, quantity } : p));
    }
  };
  
  const cartTotal = cart.reduce((sum, p) => sum + (p.price * (p.quantity || 1)), 0);
  
  // Son kullanÄ±lan kredi tipini takip et (iade iÃ§in)
  const lastUsedCreditTypeRef = React.useRef(null);
  
  // Kredi sistemi fonksiyonlarÄ±
  // Universal kredi sistemi - hem keÅŸfet hem kombin iÃ§in
  const useCredit = (source = 'shop') => {
    if (!user) return false;
    
    // Ãœcretsiz haklarÄ± kontrol et (tek seferlik, yenilenmez)
    if (source === 'avatar' && (user.freeAvatarTry || 0) > 0) {
      const newVal = user.freeAvatarTry - 1;
      setUser(prev => ({ ...prev, freeAvatarTry: newVal }));
      if (db && authUser?.uid) {
        db.collection('users').doc(authUser.uid).update({ freeAvatarTry: newVal })
          .catch(e => console.error('âŒ freeAvatarTry save error:', e));
      }
      lastUsedCreditTypeRef.current = 'freeAvatar'; // Ä°ade iÃ§in kaydet
      setToast({ open: true, type: 'success', title: 'ðŸŽ Ãœcretsiz avatar hakkÄ± kullanÄ±ldÄ±', message: 'Ä°lk avatarÄ±nÄ± oluÅŸturuyorsun!' });
      return true;
    }
    
    if (source === 'shop' && (user.freeShopTry || 0) > 0) {
      const newVal = user.freeShopTry - 1;
      setUser(prev => ({ ...prev, freeShopTry: newVal }));
      if (db && authUser?.uid) {
        db.collection('users').doc(authUser.uid).update({ freeShopTry: newVal })
          .catch(e => console.error('âŒ freeShopTry save error:', e));
      }
      lastUsedCreditTypeRef.current = 'freeShop'; // Ä°ade iÃ§in kaydet
      setToast({ open: true, type: 'success', title: 'ðŸŽ Ãœcretsiz deneme hakkÄ± kullanÄ±ldÄ±', message: 'Ä°lk shop denemeni yaptÄ±n!' });
      return true;
    }
    
    if (source === 'combo' && (user.freeComboTry || 0) > 0) {
      const newVal = user.freeComboTry - 1;
      setUser(prev => ({ ...prev, freeComboTry: newVal }));
      if (db && authUser?.uid) {
        db.collection('users').doc(authUser.uid).update({ freeComboTry: newVal })
          .catch(e => console.error('âŒ freeComboTry save error:', e));
      }
      lastUsedCreditTypeRef.current = 'freeCombo'; // Ä°ade iÃ§in kaydet
      setToast({ open: true, type: 'success', title: 'ðŸŽ Ãœcretsiz kombin hakkÄ± kullanÄ±ldÄ±', message: 'Ä°lk kombinini denedin!' });
      return true;
    }
    
    // Ãœcretsiz hak yoksa satÄ±n alÄ±nmÄ±ÅŸ kredi kullan
    const currentCredits = user.credits || 0;
    if (currentCredits <= 0) {
      // HiÃ§ kredi yok - Paywall gÃ¶ster
      setPaywallType('noCredits');
      setShowPaywall(true);
      return false;
    }
    
    // SatÄ±n alÄ±nmÄ±ÅŸ kredi kullan
    const newCredits = currentCredits - 1;
    setUser(prev => ({ ...prev, credits: newCredits }));
    if (db && authUser?.uid) {
      db.collection('users').doc(authUser.uid).update({ credits: newCredits })
        .catch(e => console.error('âŒ credits save error:', e));
    }
    lastUsedCreditTypeRef.current = 'paidCredit'; // Ä°ade iÃ§in kaydet
    setToast({ open: true, type: 'info', title: t('creditUsed'), message: `${t('creditsRemaining')}: ${newCredits}` });
    return true;
  };
  
  // Kredi iade et (hata durumunda)
  const refundCredit = (source = 'shop') => {
    if (!user || !db || !authUser?.uid) return;
    
    // lastUsedCreditTypeRef'ten gerÃ§ek kullanÄ±lan tipi al
    const actualType = lastUsedCreditTypeRef.current;
    
    if (!actualType) {
      console.log('âš ï¸ Ä°ade edilecek kredi tipi bulunamadÄ±');
      return;
    }
    
    // KullanÄ±lan tipe gÃ¶re iade et
    if (actualType === 'freeAvatar') {
      const newVal = (user.freeAvatarTry || 0) + 1;
      setUser(prev => ({ ...prev, freeAvatarTry: newVal }));
      db.collection('users').doc(authUser.uid).update({ freeAvatarTry: newVal }).catch(() => {});
      setToast({ open: true, type: 'info', title: 'ðŸ’° Kredi Ä°ade Edildi', message: 'Ãœcretsiz avatar hakkÄ±nÄ±z geri verildi' });
    } else if (actualType === 'freeShop') {
      const newVal = (user.freeShopTry || 0) + 1;
      setUser(prev => ({ ...prev, freeShopTry: newVal }));
      db.collection('users').doc(authUser.uid).update({ freeShopTry: newVal }).catch(() => {});
      setToast({ open: true, type: 'info', title: 'ðŸ’° Kredi Ä°ade Edildi', message: 'Ãœcretsiz shop hakkÄ±nÄ±z geri verildi' });
    } else if (actualType === 'freeCombo') {
      const newVal = (user.freeComboTry || 0) + 1;
      setUser(prev => ({ ...prev, freeComboTry: newVal }));
      db.collection('users').doc(authUser.uid).update({ freeComboTry: newVal }).catch(() => {});
      setToast({ open: true, type: 'info', title: 'ðŸ’° Kredi Ä°ade Edildi', message: 'Ãœcretsiz kombin hakkÄ±nÄ±z geri verildi' });
    } else if (actualType === 'paidCredit') {
      // Normal kredi iade et
      const newCredits = (user.credits || 0) + 1;
      setUser(prev => ({ ...prev, credits: newCredits }));
      db.collection('users').doc(authUser.uid).update({ credits: newCredits }).catch(() => {});
      setToast({ open: true, type: 'info', title: 'ðŸ’° Kredi Ä°ade Edildi', message: 'Krediniz geri verildi' });
    }
    
    // KullanÄ±lan tipi sÄ±fÄ±rla
    lastUsedCreditTypeRef.current = null;
    console.log('ðŸ’° Kredi iade edildi:', actualType);
  };
  
  // KÄ±yafet yÃ¼kleme kontrolÃ¼ - Paywall ile
  const checkClothingUploadAccess = (currentCount) => {
    const clothingLimit = user?.clothingUploadLimit || 5;
    if (currentCount >= clothingLimit) {
      setPaywallType('clothingUpload');
      setShowPaywall(true);
      return false;
    }
    return true;
  };
  
  const addCredits = (amount) => {
    const newCredits = (user?.credits || 0) + amount;
    setUser(prev => ({ ...prev, credits: newCredits }));
    if (db && authUser?.uid) {
      db.collection('users').doc(authUser.uid).update({ credits: newCredits })
        .catch(e => console.error('âŒ addCredits save error:', e));
    }
  };
  
  // Referral kredi kazanma (gÃ¼venlik kontrollÃ¼)
  const earnReferralCredit = async (referredUserId, reason = 'avatar_created') => {
    if (!user || !db || !authUser?.uid) return;
    
    // AylÄ±k limit kontrolÃ¼ (max 10 referral/ay)
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const monthKey = `${currentYear}-${currentMonth}`;
    let creditsThisMonth = user.referralCreditsThisMonth || 0;
    
    // Ay deÄŸiÅŸtiyse sÄ±fÄ±rla
    if (user.referralLastResetMonth !== monthKey) {
      creditsThisMonth = 0;
    }
    
    if (creditsThisMonth >= 10) {
      console.log('âš ï¸ AylÄ±k referral limiti doldu (10/10)');
      setToast({ open: true, type: 'warning', title: t('referralLimitReached'), message: 'Gelecek ay tekrar kazanabilirsin' });
      return false;
    }
    
    // AynÄ± kullanÄ±cÄ±dan daha Ã¶nce kredi alÄ±nmÄ±ÅŸ mÄ± kontrol et
    const referralsRef = db.collection('users').doc(authUser.uid).collection('referral_history');
    const existingReferral = await referralsRef.where('referredUserId', '==', referredUserId).where('reason', '==', reason).get();
    
    if (!existingReferral.empty) {
      console.log('âš ï¸ Bu kullanÄ±cÄ±dan zaten bu sebep iÃ§in kredi alÄ±nmÄ±ÅŸ');
      return false;
    }
    
    // Kredi ekle
    const newCredits = (user.credits || 0) + 1;
    const newReferralEarned = (user.referralCreditsEarned || 0) + 1;
    
    setUser(prev => ({ 
      ...prev, 
      credits: newCredits,
      referralCreditsEarned: newReferralEarned,
      referralCreditsThisMonth: creditsThisMonth + 1,
      referralLastResetMonth: monthKey
    }));
    
    // Firebase'e kaydet
    await db.collection('users').doc(authUser.uid).update({
      credits: newCredits,
      referralCreditsEarned: newReferralEarned,
      referralCreditsThisMonth: creditsThisMonth + 1,
      referralLastResetMonth: monthKey
    }).catch(e => console.error('âŒ referral credit error:', e));
    
    // Referral geÃ§miÅŸine kaydet (duplicate kontrolÃ¼ iÃ§in)
    await referralsRef.add({
      referredUserId,
      reason, // 'avatar_created' veya 'package_purchased'
      earnedAt: firebase.firestore.FieldValue.serverTimestamp(),
      creditsEarned: 1
    }).catch(e => console.error('âŒ referral history error:', e));
    
    const reasonText = reason === 'avatar_created' ? 'ArkadaÅŸÄ±n avatar oluÅŸturdu!' : 'ArkadaÅŸÄ±n paket satÄ±n aldÄ±!';
    setToast({ open: true, type: 'success', title: 'ðŸŽ‰ Referans Kredisi!', message: `${reasonText} +1 kredi kazandÄ±n` });
    
    return true;
  };
  
  // Referral kodu ile referans veren kullanÄ±cÄ±yÄ± bul
  const findReferrerByCode = async (referralCode) => {
    if (!db || !referralCode) return null;
    
    try {
      const snapshot = await db.collection('users')
        .where('referralCode', '==', referralCode.toUpperCase())
        .limit(1)
        .get();
      
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        return { uid: doc.id, ...doc.data() };
      }
    } catch (e) {
      console.error('âŒ Referrer lookup error:', e);
    }
    return null;
  };
  
  // Referans veren kullanÄ±cÄ±ya kredi ver (avatar oluÅŸturulduÄŸunda Ã§aÄŸrÄ±lÄ±r)
  const triggerReferralReward = async (newUserDeviceId) => {
    if (!user?.referredBy || !db || !authUser?.uid) return;
    
    // Kendi device ID'mizi al
    const myDeviceId = getDeviceId();
    
    // Referans veren kullanÄ±cÄ±nÄ±n device ID'si ile karÅŸÄ±laÅŸtÄ±r
    try {
      const referrerDoc = await db.collection('users').doc(user.referredBy).get();
      if (referrerDoc.exists) {
        const referrerData = referrerDoc.data();
        
        // Device ID kontrolÃ¼ - aynÄ± cihazdan aÃ§Ä±lan hesaplar sayÄ±lmaz
        if (referrerData.deviceId && referrerData.deviceId === myDeviceId) {
          console.log('âš ï¸ Referral rejected: Same device detected');
          return;
        }
        
        // Referans veren kullanÄ±cÄ±nÄ±n aylÄ±k limitini kontrol et
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        const monthKey = `${currentYear}-${currentMonth}`;
        let referrerCreditsThisMonth = referrerData.referralCreditsThisMonth || 0;
        
        if (referrerData.referralLastResetMonth !== monthKey) {
          referrerCreditsThisMonth = 0;
        }
        
        if (referrerCreditsThisMonth >= 10) {
          console.log('âš ï¸ Referrer monthly limit reached');
          return;
        }
        
        // Daha Ã¶nce bu kullanÄ±cÄ± iÃ§in kredi verilmiÅŸ mi kontrol et
        const historySnapshot = await db.collection('users').doc(user.referredBy)
          .collection('referral_history')
          .where('referredUserId', '==', authUser.uid)
          .where('reason', '==', 'avatar_created')
          .get();
        
        if (!historySnapshot.empty) {
          console.log('âš ï¸ Referral already rewarded for this user');
          return;
        }
        
        // Referans verene kredi ver
        const newReferrerCredits = (referrerData.credits || 0) + 1;
        const newReferrerEarned = (referrerData.referralCreditsEarned || 0) + 1;
        
        await db.collection('users').doc(user.referredBy).update({
          credits: newReferrerCredits,
          referralCreditsEarned: newReferrerEarned,
          referralCreditsThisMonth: referrerCreditsThisMonth + 1,
          referralLastResetMonth: monthKey
        });
        
        // Referral geÃ§miÅŸine kaydet
        await db.collection('users').doc(user.referredBy).collection('referral_history').add({
          referredUserId: authUser.uid,
          referredUsername: user.username || user.displayName,
          reason: 'avatar_created',
          earnedAt: firebase.firestore.FieldValue.serverTimestamp(),
          creditsEarned: 1
        });
        
        // Referans verene bildirim gÃ¶nder
        await db.collection('users').doc(user.referredBy).collection('notifications').add({
          type: 'referral_reward',
          message: `${user.username || 'Bir arkadaÅŸÄ±n'} avatar oluÅŸturdu! +1 kredi kazandÄ±n ðŸŽ‰`,
          senderName: user.username || user.displayName,
          senderAvatar: user.profilePhoto || user.baseAvatar,
          read: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… Referral reward sent to:', user.referredBy);
      }
    } catch (e) {
      console.error('âŒ Referral reward error:', e);
    }
  };
  
  // Paket satÄ±n alÄ±ndÄ±ÄŸÄ±nda referans verene kredi ver
  const triggerReferralRewardOnPurchase = async () => {
    if (!user?.referredBy || !db || !authUser?.uid) return;
    
    try {
      const referrerDoc = await db.collection('users').doc(user.referredBy).get();
      if (!referrerDoc.exists) return;
      
      const referrerData = referrerDoc.data();
      
      // Device ID kontrolÃ¼
      const myDeviceId = getDeviceId();
      if (referrerData.deviceId && referrerData.deviceId === myDeviceId) {
        console.log('âš ï¸ Referral rejected on purchase: Same device');
        return;
      }
      
      // AylÄ±k limit kontrolÃ¼
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      const monthKey = `${currentYear}-${currentMonth}`;
      let referrerCreditsThisMonth = referrerData.referralCreditsThisMonth || 0;
      
      if (referrerData.referralLastResetMonth !== monthKey) {
        referrerCreditsThisMonth = 0;
      }
      
      if (referrerCreditsThisMonth >= 10) {
        console.log('âš ï¸ Referrer monthly limit reached on purchase');
        return;
      }
      
      // Referans verene kredi ver
      const newReferrerCredits = (referrerData.credits || 0) + 1;
      const newReferrerEarned = (referrerData.referralCreditsEarned || 0) + 1;
      
      await db.collection('users').doc(user.referredBy).update({
        credits: newReferrerCredits,
        referralCreditsEarned: newReferrerEarned,
        referralCreditsThisMonth: referrerCreditsThisMonth + 1,
        referralLastResetMonth: monthKey
      });
      
      // Referral geÃ§miÅŸine kaydet
      await db.collection('users').doc(user.referredBy).collection('referral_history').add({
        referredUserId: authUser.uid,
        referredUsername: user.username || user.displayName,
        reason: 'package_purchased',
        earnedAt: firebase.firestore.FieldValue.serverTimestamp(),
        creditsEarned: 1
      });
      
      // Referans verene bildirim gÃ¶nder
      await db.collection('users').doc(user.referredBy).collection('notifications').add({
        type: 'referral_reward',
        message: `${user.username || 'Bir arkadaÅŸÄ±n'} paket satÄ±n aldÄ±! +1 kredi kazandÄ±n ðŸŽ‰`,
        senderName: user.username || user.displayName,
        senderAvatar: user.profilePhoto || user.baseAvatar,
        read: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      console.log('âœ… Referral purchase reward sent to:', user.referredBy);
    } catch (e) {
      console.error('âŒ Referral purchase reward error:', e);
    }
  };
  
  // Payment simulation
  const processPayment = async (type, amount) => {
    setPaymentLoading(true);
    // Simulate payment processing
    await new Promise(r => setTimeout(r, 2000));
    setPaymentLoading(false);
    
    if (type === 'subscription') {
      setUser(prev => ({
        ...prev,
        subscription: {
          active: true,
          plan: 'premium',
          remainingCredits: 100,
          startDate: Date.now(),
          endDate: Date.now() + (30 * 24 * 60 * 60 * 1000)
        }
      }));
      if (db && authUser?.uid) {
        db.collection('users').doc(authUser.uid).update({
          subscription: {
            active: true,
            plan: 'premium',
            remainingCredits: 100,
            startDate: Date.now(),
            endDate: Date.now() + (30 * 24 * 60 * 60 * 1000)
          }
        }).catch(e => console.error('âŒ subscription save error:', e.code, e.message));
      }
      setToast({ open: true, type: 'success', title: 'Ã–deme BaÅŸarÄ±lÄ±', message: 'Premium Ã¼ye oldunuz!' });
      
      // Referans verene Ã¶dÃ¼l gÃ¶nder (paket alÄ±mÄ±)
      await triggerReferralRewardOnPurchase();
      
    } else if (type === 'credits') {
      addCredits(amount);
      setToast({ open: true, type: 'success', title: 'Ã–deme BaÅŸarÄ±lÄ±', message: `+${amount} Kredi eklendi` });
      
      // Referans verene Ã¶dÃ¼l gÃ¶nder (paket alÄ±mÄ±)
      await triggerReferralRewardOnPurchase();
      
    } else if (type === 'videoTokens') {
      addVideoTokens(amount);
      setToast({ open: true, type: 'success', title: 'Ã–deme BaÅŸarÄ±lÄ±', message: `+${amount} Video kredisi eklendi` });
    } else if (type === 'clothingUpload') {
      setUser(prev => ({ ...prev, clothingUploadPurchased: true }));
      if (db && authUser?.uid) {
        db.collection('users').doc(authUser.uid).update({ clothingUploadPurchased: true })
          .catch(e => console.error('âŒ clothingUploadPurchased save error:', e.code, e.message));
      }
      setToast({ open: true, type: 'success', title: 'Ã–deme BaÅŸarÄ±lÄ±', message: '100 kÄ±yafet hakkÄ± aktifleÅŸtirildi!' });
    } else if (type === 'cart') {
      setCart([]);
      setToast({ open: true, type: 'success', title: t('orderConfirmed'), message: t('thankYouOrder') });
    }
    
    setShowPayment(false);
    setShowSubscription(false);
    return true;
  };

  const checkCooldown = () => {
    const now = Date.now();
    const elapsed = now - lastTryTime;
    if (elapsed < COOLDOWN_MS) {
      const remaining = Math.ceil((COOLDOWN_MS - elapsed) / 1000);
      setToast({ open: true, type: 'error', title: 'LÃ¼tfen bekle', message: `${remaining} saniye sonra tekrar dene` });
      return false;
    }
    return true;
  };

  // Bildirim izni iste ve kaydet
  const requestNotificationPermission = async () => {
    if (!('Notification' in window)) return false;
    if (Notification.permission === 'granted') return true;
    if (Notification.permission !== 'denied') {
      const permission = await Notification.requestPermission();
      return permission === 'granted';
    }
    return false;
  };

  // Bildirim gÃ¶nder
  const sendNotification = (title, body, icon = 'âœ¨') => {
    if (!('Notification' in window) || Notification.permission !== 'granted') return;
    
    try {
      new Notification(title, {
        body,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">' + icon + '</text></svg>',
        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ðŸ‘”</text></svg>',
        tag: 'trai-daily',
        requireInteraction: false
      });
    } catch (e) {
      // Bildirim gÃ¶nderilemedi
    }
  };

  // Hava durumunu al
  const fetchWeatherForRecommendation = async () => {
    try {
      if (!navigator.geolocation) return null;
      
      const pos = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
      });
      
      const { latitude, longitude } = pos.coords;
      const res = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code`
      );
      const data = await res.json();
      
      const weatherCodes = {
        0: { icon: 'â˜€ï¸', text: 'AÃ§Ä±k' }, 1: { icon: 'ðŸŒ¤ï¸', text: 'Az Bulutlu' },
        2: { icon: 'â›…', text: 'ParÃ§alÄ± Bulutlu' }, 3: { icon: 'â˜ï¸', text: 'Bulutlu' },
        45: { icon: 'ðŸŒ«ï¸', text: 'Sisli' }, 51: { icon: 'ðŸŒ§ï¸', text: 'YaÄŸmurlu' },
        61: { icon: 'ðŸŒ§ï¸', text: 'YaÄŸmurlu' }, 71: { icon: 'ðŸŒ¨ï¸', text: 'KarlÄ±' },
        80: { icon: 'ðŸŒ¦ï¸', text: 'SaÄŸanak' }, 95: { icon: 'â›ˆï¸', text: 'FÄ±rtÄ±na' }
      };
      
      const code = data.current.weather_code;
      const weatherInfo = weatherCodes[code] || { icon: 'ðŸŒ¡ï¸', text: 'Belirsiz' };
      
      return {
        temp: Math.round(data.current.temperature_2m),
        icon: weatherInfo.icon,
        text: weatherInfo.text
      };
    } catch {
      return null;
    }
  };

  // GÃ¼nlÃ¼k Ã¶neri kontrolÃ¼ ve gÃ¶sterimi
  const checkDailyRecommendation = async () => {
    if (!authUser || !closet.length) return;
    
    const today = new Date().toDateString();
    const lastShown = localStorage.getItem(`trai_daily_shown_${authUser.uid}`);
    
    // BugÃ¼n zaten gÃ¶sterildi mi?
    if (lastShown === today) return;
    
    // Hava durumunu al
    const weather = await fetchWeatherForRecommendation();
    setDailyWeather(weather);
    
    // AI'dan Ã¶neri al
    const recommendation = await AI.getDailyRecommendation(
      closet, 
      weather, 
      null, // occasion - ÅŸimdilik yok
      user?.gender || 'unisex'
    );
    
    if (recommendation && Object.values(recommendation.items).some(Boolean)) {
      setDailyRecommendation(recommendation);
      setShowDailyModal(true);
      
      // BugÃ¼n gÃ¶sterildi olarak iÅŸaretle
      localStorage.setItem(`trai_daily_shown_${authUser.uid}`, today);
    }
  };

  // Sabah 9'da bildirim kontrolÃ¼
  const scheduleMorningNotification = () => {
    if (!authUser || !settings.notifyDailyOutfit) return;
    
    const now = new Date();
    const hour = now.getHours();
    
    // Saat 9'dan Ã¶nce ve bugÃ¼n bildirim gÃ¶nderilmedi mi?
    const today = now.toDateString();
    const lastNotified = localStorage.getItem(`trai_daily_notified_${authUser.uid}`);
    
    if (lastNotified === today) return; // BugÃ¼n zaten bildirim gÃ¶nderildi
    
    // EÄŸer saat 9'u geÃ§tiyse ve uygulama aÃ§Ä±ldÄ±ysa bildirim gÃ¶nderme (uygulama aÃ§Ä±k)
    if (hour >= 9) {
      // Uygulama aÃ§Ä±k, bildirim gerek yok - modal gÃ¶sterilecek
      return;
    }
    
    // Saat 9'a kadar bekle
    const nineAM = new Date(now);
    nineAM.setHours(9, 0, 0, 0);
    const msUntilNine = nineAM.getTime() - now.getTime();
    
    if (msUntilNine > 0) {
      setTimeout(async () => {
        // KullanÄ±cÄ± hala giriÅŸ yapmamÄ±ÅŸ mÄ± kontrol et
        const stillNotShown = localStorage.getItem(`trai_daily_shown_${authUser.uid}`) !== today;
        
        if (stillNotShown && settings.notifyDailyOutfit) {
          // Hava durumu al
          const weather = await fetchWeatherForRecommendation();
          
          // Bildirim gÃ¶nder
          const weatherText = weather ? `${weather.temp}Â°C ${weather.text}` : '';
          sendNotification(
            'ðŸ‘” BugÃ¼n Ne Giysen?',
            `${weatherText ? weatherText + ' - ' : ''}DolabÄ±ndan kombin Ã¶nerimiz hazÄ±r!`,
            'ðŸ‘”'
          );
          
          // Bildirim gÃ¶nderildi olarak iÅŸaretle
          localStorage.setItem(`trai_daily_notified_${authUser.uid}`, today);
        }
      }, msUntilNine);
    }
  };

  // Load data on mount - DON'T load user here, wait for auth
  useEffect(() => {
    // Only load non-user-specific data on mount
    // User data will be loaded after auth is confirmed
    const ps = safeJsonParse(localStorage.getItem('trai_posts_v1'), []);
    if (Array.isArray(ps)) setPosts(ps);
  }, []);

  // Load user-specific data AFTER auth is confirmed - onSnapshot ile CANLI dinleme
  const [dataLoaded, setDataLoaded] = useState(false);
  const [initialLoadComplete, setInitialLoadComplete] = useState(false); // NEW: Prevents race condition
  const avatarDownloadedRef = React.useRef(false); // useRef kullan - render'lar arasÄ± persist eder
  const isFirstSnapshotRef = React.useRef(true); // NEW: Track first snapshot to prevent overwrites
  const pendingSaveRef = React.useRef(false); // NEW: Track if we're currently saving to prevent loops
  
  useEffect(() => {
    if (!authUser) {
      // Clear user when logged out
      setUser(null);
      setLoadingAvatar(false);
      setCloset([]);
      setFriends([]);
      setMessages([]);
      setSavedCombos([]);
      setFavorites([]);
      setTryHistory([]);
      setTryOnCache({});
      setDataLoaded(false);
      setInitialLoadComplete(false);
      avatarDownloadedRef.current = false; // Reset on logout
      isFirstSnapshotRef.current = true; // Reset on logout
      return;
    }
    
    const userId = authUser.uid;
    console.log('ðŸ”‘ Auth confirmed, userId:', userId);
    
    // Set loading state
    setLoadingAvatar(true);
    isFirstSnapshotRef.current = true; // Reset for new user
    
    // KayÄ±t sÄ±rasÄ±nda gelen username ve displayName
    // pendingReferralCode varsa referredBy olarak ayarla
    let referredByUid = authUser.referredBy || null;
    
    // URL'den gelen referral kodunu iÅŸle (async IIFE)
    (async () => {
      if (pendingReferralCode && !referredByUid) {
        const referrer = await findReferrerByCode(pendingReferralCode);
        if (referrer && referrer.uid !== authUser.uid) {
          // Device ID kontrolÃ¼ - aynÄ± cihazdan gelen referral'larÄ± reddet
          const myDeviceId = getDeviceId();
          if (referrer.deviceId !== myDeviceId) {
            referredByUid = referrer.uid;
            console.log('âœ… Referral code validated, referrer:', referrer.uid);
          } else {
            console.log('âš ï¸ Referral rejected: Same device as referrer');
          }
        }
        setPendingReferralCode(null); // KullanÄ±ldÄ±, temizle
      }
    })();
    
    const currentMonthKey = `${new Date().getFullYear()}-${new Date().getMonth()}`;
    
    const initialUserData = authUser.username ? {
      username: authUser.username,
      displayName: authUser.displayName || null,
      email: authUser.email || null,
      credits: 0,
      // Ãœcretsiz haklar - tek seferlik, yenilenmez
      freeAvatarTry: authUser.isReturningEmail ? 0 : 1,  // 1 avatar oluÅŸturma hakkÄ±
      freeShopTry: authUser.isReturningEmail ? 0 : 1,    // 1 shop deneme hakkÄ±
      freeComboTry: authUser.isReturningEmail ? 0 : 1,   // 1 kombin deneme hakkÄ±
      subscription: null,
      clothingUploadLimit: 5,  // VarsayÄ±lan 5 kÄ±yafet yÃ¼kleme hakkÄ±
      clothingUploadCount: 0,
      avatarRefreshCount: 0,   // Avatar yenileme sayÄ±sÄ±
      avatarRefreshLimit: 0,   // SatÄ±n alÄ±nan avatar yenileme hakkÄ±
      // Referral sistemi
      referralCode: generateReferralCode(authUser.uid),
      referredBy: referredByUid,
      referralCreditsEarned: 0,
      referralCreditsThisMonth: 0,
      referralLastResetMonth: currentMonthKey,
      referralActivated: false, // Avatar oluÅŸturulduÄŸunda true olacak
      // Device tracking for abuse prevention
      deviceId: getDeviceId(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    } : null;
    
    if (!db) {
      console.warn('âš ï¸ Firestore baÄŸlantÄ±sÄ± yok');
      setLoadingAvatar(false);
      setDataLoaded(true);
      setInitialLoadComplete(true);
      return;
    }
    
    // Firestore'dan CANLI dinleme baÅŸlat (onSnapshot)
    const unsubscribe = db.collection('users').doc(userId).onSnapshot(
      async (doc) => {
        // CRITICAL FIX: Skip if we're currently saving (prevents read-after-write loop)
        if (pendingSaveRef.current) {
          console.log('â­ï¸ Skipping snapshot - save in progress');
          return;
        }
        
        console.log('ðŸ“¡ onSnapshot triggered, exists:', doc.exists, 'isFirst:', isFirstSnapshotRef.current);
        
        if (doc.exists) {
          const data = doc.data();
          console.log('ðŸ“¦ Firestore data keys:', Object.keys(data));
          console.log('ðŸ‘¤ Username from Firestore:', data.username, '| DisplayName:', data.displayName);
          
          // CRITICAL FIX: If username is missing, try to fetch from usernames collection
          let resolvedUsername = data.username;
          let resolvedDisplayName = data.displayName;
          
          if (!resolvedUsername) {
            console.log('âš ï¸ Username missing in users doc, searching in usernames collection...');
            try {
              const usernamesSnapshot = await db.collection('usernames')
                .where('uid', '==', userId)
                .limit(1)
                .get();
              
              if (!usernamesSnapshot.empty) {
                const usernameDoc = usernamesSnapshot.docs[0];
                resolvedUsername = usernameDoc.data().username || usernameDoc.id;
                console.log('âœ… Found username from usernames collection:', resolvedUsername);
                
                // Also update the users doc to include username for future
                db.collection('users').doc(userId).update({
                  username: resolvedUsername,
                  usernameLower: resolvedUsername.toLowerCase()
                }).catch(e => console.warn('Could not update users doc with username:', e.message));
              }
            } catch (e) {
              console.warn('Could not fetch from usernames collection:', e.message);
            }
          }
          
          // CRITICAL FIX: Only load data on FIRST snapshot or if local state is empty
          // This prevents remote overwrites after local changes
          const shouldLoadData = isFirstSnapshotRef.current;
          
          // Avatar'Ä± sadece bir kez indir (her snapshot'ta deÄŸil)
          let baseAvatarDataUrl = null;
          
          if (!avatarDownloadedRef.current && data.baseAvatarStorageUrl) {
            console.log('ðŸ–¼ï¸ Avatar indiriliyor...');
            try {
              baseAvatarDataUrl = await downloadAvatarFromStorage(userId);
              if (baseAvatarDataUrl) {
                console.log('âœ… Avatar indirildi');
                avatarDownloadedRef.current = true;
              } else {
                console.log('âš ï¸ Avatar bulunamadÄ±');
              }
            } catch (e) {
              console.error('âŒ Avatar indirme hatasÄ±:', e.message);
            }
          }
          
          // Ãœcretsiz haklar artÄ±k yenilenmiyor - tek seferlik
          // Eski kullanÄ±cÄ±larÄ± yeni sisteme migrate et
          const freeAvatarTry = data.freeAvatarTry ?? (data.baseAvatar ? 0 : 1);
          const freeShopTry = data.freeShopTry ?? (data.freeShopTries > 0 ? 1 : 0);
          const freeComboTry = data.freeComboTry ?? (data.freeComboTries > 0 ? 1 : 0);
          
          // User state'i gÃ¼ncelle - ALWAYS update user for credits etc
          setUser(prev => {
            const newUser = {
              username: resolvedUsername || prev?.username || null,
              displayName: resolvedDisplayName || prev?.displayName || null,
              profilePhoto: data.profilePhoto,
              email: data.email,
              emailVerified: authUser.emailVerified || false,
              credits: data.credits ?? 0,
              // Yeni Ã¼cretsiz hak sistemi
              freeAvatarTry: freeAvatarTry,
              freeShopTry: freeShopTry,
              freeComboTry: freeComboTry,
              subscription: data.subscription || null,
              // KÄ±yafet yÃ¼kleme sistemi
              clothingUploadLimit: data.clothingUploadLimit ?? 5,
              clothingUploadCount: data.clothingUploadCount ?? 0,
              // Avatar yenileme sistemi
              avatarRefreshCount: data.avatarRefreshCount ?? 0,
              avatarRefreshLimit: data.avatarRefreshLimit ?? 0,
              // Referral sistemi
              referralCode: data.referralCode || generateReferralCode(userId),
              referredBy: data.referredBy || null,
              referralCreditsEarned: data.referralCreditsEarned ?? 0,
              // Avatar parametreleri
              gender: data.params?.gender || data.gender,
              age: data.params?.age || data.age,
              height: data.params?.height || data.height,
              weight: data.params?.weight || data.weight,
              bodyType: data.params?.bodyType || data.bodyType,
              skinTone: data.params?.skinTone || data.skinTone,
              hairColor: data.params?.hairColor || data.hairColor,
              hairLength: data.params?.hairLength || data.hairLength,
              hairType: data.params?.hairType || data.hairType,
              hijab: data.params?.hijab || data.hijab || false,
              // Mevcut avatar'Ä± koru veya yenisini ekle
              baseAvatar: baseAvatarDataUrl || prev?.baseAvatar || data.baseAvatarDataUrl || null
            };
            return newUser;
          });
          
          // CRITICAL FIX: Only load arrays on FIRST snapshot
          if (shouldLoadData) {
            console.log('ðŸ“¥ Initial load - populating state from Firestore');
            if (data.closet && Array.isArray(data.closet)) {
              setCloset(data.closet);
              console.log('ðŸ‘• Closet loaded:', data.closet.length, 'items');
            }
            if (data.savedCombos && Array.isArray(data.savedCombos)) setSavedCombos(data.savedCombos);
            if (data.favorites && Array.isArray(data.favorites)) setFavorites(data.favorites);
            if (data.tryHistory && Array.isArray(data.tryHistory)) setTryHistory(data.tryHistory);
            if (data.settings) setSettings(prev => ({ ...prev, ...data.settings }));
            
            // Mevcut kullanÄ±cÄ± iÃ§in avatar kontrolÃ¼ - YENÄ° KULLANICI DEÄžÄ°L
            // createdAt varsa ve avatar yoksa, avatar oluÅŸturma prompt'u gÃ¶ster
            // Ama sadece daha Ã¶nce avatar oluÅŸturmuÅŸ ve silmiÅŸ kullanÄ±cÄ±lar iÃ§in kontrol et
            const hasAvatar = baseAvatarDataUrl || data.baseAvatarDataUrl || data.baseAvatarStorageUrl;
            const isExistingUser = data.createdAt != null; // Firestore'da createdAt varsa mevcut kullanÄ±cÄ±
            
            // Avatar kontrolÃ¼: Mevcut kullanÄ±cÄ± (createdAt var) + Avatar yok + daha Ã¶nce avatar oluÅŸturmuÅŸ (freeAvatarTry 0)
            // Bu, daha Ã¶nce avatar oluÅŸturmuÅŸ ama bir ÅŸekilde silmiÅŸ kullanÄ±cÄ±larÄ± yakalamak iÃ§in
            if (isExistingUser && !hasAvatar && freeAvatarTry === 0) {
              console.log('âš ï¸ Mevcut kullanÄ±cÄ± avatar olmadan giriÅŸ yaptÄ±');
              // Avatar prompt'u gÃ¶sterme - kullanÄ±cÄ± deneme yapmak istediÄŸinde otomatik gÃ¶sterilecek
            }
            
            isFirstSnapshotRef.current = false; // Mark first load complete
          } else {
            console.log('â­ï¸ Subsequent snapshot - preserving local state');
          }
          
          setLoadingAvatar(false);
          setDataLoaded(true);
          // Small delay before enabling saves to prevent immediate re-save
          setTimeout(() => setInitialLoadComplete(true), 500);
          
        } else {
          // KullanÄ±cÄ± Firestore'da yok - yeni profil oluÅŸtur
          console.log('ðŸ†• Yeni kullanÄ±cÄ±, profil oluÅŸturuluyor...');
          
          if (initialUserData) {
            db.collection('users').doc(userId).set(initialUserData)
              .then(() => {
                console.log('âœ… Yeni profil oluÅŸturuldu');
                setUser({
                  ...initialUserData,
                  createdAt: Date.now()
                });
                isFirstSnapshotRef.current = false;
              })
              .catch(e => {
                console.error('âŒ Profil oluÅŸturma hatasÄ±:', e.code, e.message);
                setUser({ username: authUser.username || null });
              });
          } else {
            // initialUserData yok - sadece temel bilgilerle devam et
            console.log('âš ï¸ initialUserData yok, temel profil oluÅŸturuluyor');
            const basicProfile = {
              email: authUser.email,
              credits: 0,
              freeAvatarTry: 1,
              freeShopTry: 1,
              freeComboTry: 1,
              clothingUploadLimit: 5,
              clothingUploadCount: 0,
              avatarRefreshCount: 0,
              avatarRefreshLimit: 0,
              referralCode: generateReferralCode(authUser.uid),
              deviceId: getDeviceId(),
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            db.collection('users').doc(userId).set(basicProfile)
              .then(() => {
                setUser({ ...basicProfile, createdAt: Date.now() });
                isFirstSnapshotRef.current = false;
              })
              .catch(e => console.error('Basic profile error:', e.code, e.message));
          }
          
          setLoadingAvatar(false);
          setDataLoaded(true);
          setTimeout(() => setInitialLoadComplete(true), 500);
        }
      },
      (error) => {
        console.error('âŒ Firestore onSnapshot error:', error.code, error.message);
        setLoadingAvatar(false);
        setDataLoaded(true);
        setInitialLoadComplete(true);
        
        // Hata durumunda bile UI'Ä± aÃ§
        if (initialUserData) {
          setUser(initialUserData);
        }
      }
    );
    
    // Cleanup - component unmount veya authUser deÄŸiÅŸtiÄŸinde dinleyiciyi kaldÄ±r
    return () => {
      console.log('ðŸ”Œ Firestore listener unsubscribed');
      unsubscribe();
    };
  }, [authUser]);

  // Load following list from Firestore - REAL TIME
  useEffect(() => {
    if (!authUser?.uid || !db) return;
    
    const userId = authUser.uid;
    console.log('ðŸ‘¥ Loading following list...');
    
    const unsubscribe = db.collection('users').doc(userId).collection('following')
      .orderBy('followedAt', 'desc')
      .onSnapshot(
        (snapshot) => {
          const followingList = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            followingList.push({
              id: doc.id,
              uid: doc.id,
              username: data.username,
              displayName: data.displayName,
              name: data.displayName || data.username,
              avatar: data.profilePhoto,
              profilePhoto: data.profilePhoto,
              status: 'following',
              addedAt: data.followedAt?.toMillis?.() || Date.now()
            });
          });
          console.log('âœ… Following loaded:', followingList.length);
          setFriends(followingList);
        },
        (error) => {
          console.error('âŒ Following load error:', error);
        }
      );
    
    return () => unsubscribe();
  }, [authUser]);

  // Load incoming follow requests - REAL TIME
  useEffect(() => {
    if (!authUser?.uid || !db) return;
    
    const userId = authUser.uid;
    console.log('ðŸ“© Loading follow requests...');
    
    const unsubscribe = db.collection('users').doc(userId).collection('followRequests')
      .orderBy('createdAt', 'desc')
      .onSnapshot(
        (snapshot) => {
          const requests = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            requests.push({
              id: doc.id,
              fromUid: data.fromUid,
              fromUsername: data.fromUsername,
              fromDisplayName: data.fromDisplayName,
              fromPhoto: data.fromPhoto,
              status: data.status,
              createdAt: data.createdAt?.toMillis?.() || Date.now()
            });
          });
          console.log('âœ… Follow requests loaded:', requests.length);
          setFollowRequests(requests);
        },
        (error) => {
          console.error('âŒ Follow requests load error:', error);
        }
      );
    
    return () => unsubscribe();
  }, [authUser]);

  // Load sent follow requests - REAL TIME
  useEffect(() => {
    if (!authUser?.uid || !db) return;
    
    const userId = authUser.uid;
    
    const unsubscribe = db.collection('users').doc(userId).collection('sentFollowRequests')
      .onSnapshot(
        (snapshot) => {
          const requests = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            requests.push({
              uid: doc.id,
              username: data.toUsername,
              displayName: data.toDisplayName,
              profilePhoto: data.toPhoto,
              status: data.status
            });
          });
          console.log('âœ… Sent follow requests loaded:', requests.length);
          setSentFollowRequests(requests);
        },
        (error) => {
          console.error('âŒ Sent requests load error:', error);
        }
      );
    
    return () => unsubscribe();
  }, [authUser]);

  // Load notifications - REAL TIME
  useEffect(() => {
    if (!authUser?.uid || !db) return;
    
    const userId = authUser.uid;
    console.log('ðŸ”” Loading notifications...');
    
    const unsubscribe = db.collection('users').doc(userId).collection('notifications')
      .orderBy('createdAt', 'desc')
      .limit(50)
      .onSnapshot(
        (snapshot) => {
          const notifs = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            notifs.push({
              id: doc.id,
              type: data.type,
              fromUid: data.fromUid,
              fromUsername: data.fromUsername,
              fromPhoto: data.fromPhoto,
              message: data.message,
              read: data.read,
              createdAt: data.createdAt?.toMillis?.() || Date.now()
            });
          });
          console.log('âœ… Notifications loaded:', notifs.length);
          setNotifications(notifs);
        },
        (error) => {
          console.error('âŒ Notifications load error:', error);
        }
      );
    
    return () => unsubscribe();
  }, [authUser]);

  // Load DM chats from Firestore - REAL TIME
  useEffect(() => {
    if (!authUser?.uid || !db) return;
    
    const userId = authUser.uid;
    console.log('ðŸ’¬ Loading chats...');
    
    const unsubscribe = db.collection('chats')
      .where('participants', 'array-contains', userId)
      .onSnapshot(
        async (snapshot) => {
          const chatsList = [];
          const userAvatars = {};
          
          // First, collect all other user IDs
          snapshot.forEach(doc => {
            const data = doc.data();
            const otherUserId = data.participants.find(p => p !== userId);
            if (otherUserId && !userAvatars[otherUserId]) {
              userAvatars[otherUserId] = null; // Mark for fetching
            }
          });
          
          // Fetch avatars for all other users
          const otherUserIds = Object.keys(userAvatars);
          for (const uid of otherUserIds) {
            try {
              const userDoc = await db.collection('users').doc(uid).get();
              if (userDoc.exists) {
                const userData = userDoc.data();
                userAvatars[uid] = {
                  avatar: userData.profilePhoto || userData.baseAvatarStorageUrl || null,
                  displayName: userData.displayName || userData.username || 'KullanÄ±cÄ±'
                };
              }
            } catch (e) {
              console.log('Could not fetch avatar for', uid);
            }
          }
          
          // Build chat list with avatars
          snapshot.forEach(doc => {
            const data = doc.data();
            const otherUserId = data.participants.find(p => p !== userId);
            const otherUserInfo = userAvatars[otherUserId] || {};
            chatsList.push({
              id: doc.id,
              recipientId: otherUserId,
              name: otherUserInfo.displayName || data.participantNames?.[otherUserId] || 'KullanÄ±cÄ±',
              avatar: otherUserInfo.avatar || null,
              lastMessage: data.lastMessage,
              lastMessageTime: data.lastMessageTime?.toMillis?.() || data.updatedAt || Date.now(),
              lastMessageBy: data.lastMessageBy,
              messages: [], // Will be loaded when chat is opened
              approved: true
            });
          });
          
          // Sort by lastMessageTime (client-side)
          chatsList.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
          
          console.log('âœ… Chats loaded:', chatsList.length);
          // Merge with existing local state to preserve loaded messages
          setDmChats(prev => {
            return chatsList.map(chat => {
              const existing = prev.find(c => c.id === chat.id);
              return existing ? { ...chat, messages: existing.messages, avatar: chat.avatar || existing.avatar } : chat;
            });
          });
        },
        (error) => {
          console.error('âŒ Chats load error:', error);
        }
      );
    
    return () => unsubscribe();
  }, [authUser]);

  // Load messages when a chat is selected
  const loadChatMessages = async (chatId) => {
    if (!db || !chatId) return;
    
    try {
      const messagesRef = db.collection('chats').doc(chatId).collection('messages')
        .orderBy('timestamp', 'asc')
        .limit(100);
      
      const snapshot = await messagesRef.get();
      const messagesList = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        messagesList.push({
          id: doc.id,
          senderId: data.senderId,
          senderName: data.senderName,
          text: data.text,
          type: data.type || 'text',
          image: data.image || null,
          items: data.items || [],
          timestamp: data.timestamp?.toMillis?.() || data.createdAt || Date.now(),
          read: data.read
        });
      });
      
      console.log('âœ… Messages loaded:', messagesList.length, messagesList.map(m => ({ type: m.type, hasImage: !!m.image })));
      
      // Update dmChats with loaded messages
      setDmChats(prev => prev.map(c => 
        c.id === chatId ? { ...c, messages: messagesList } : c
      ));
      
      return messagesList;
    } catch (e) {
      console.error('âŒ Load messages error:', e);
      return [];
    }
  };

  // GÃ¼nlÃ¼k Ã¶neri kontrolÃ¼ - kullanÄ±cÄ± ve dolap yÃ¼klendikten sonra
  useEffect(() => {
    if (authUser && closet.length > 0 && user) {
      // Bildirim izni iste
      requestNotificationPermission();
      
      // Sabah 9 bildirimi planla
      scheduleMorningNotification();
      
      // GÃ¼nlÃ¼k Ã¶neriyi kontrol et (kÄ±sa gecikme ile - UI yÃ¼klensin)
      const timer = setTimeout(() => {
        checkDailyRecommendation();
      }, 2000);
      
      return () => clearTimeout(timer);
    }
  }, [authUser, closet.length, user]);

  // Save user to localStorage and Firestore (user-specific)
  useEffect(() => {
    if (user && authUser && initialLoadComplete) {
      const userId = authUser.uid;
      localStorage.setItem(`trai_user_${userId}`, JSON.stringify(user));
      // Sync to Firestore if logged in
      if (db) {
        // Upload baseAvatar to Storage first (async, don't block)
        const avatarData = user.baseAvatar || user.avatar; // Support both old and new
        
        // params objesi - sadece tanÄ±mlÄ± deÄŸerleri iÃ§ersin (undefined Firestore'da hata verir)
        const userParams = {};
        if (user.gender !== undefined) userParams.gender = user.gender;
        if (user.age !== undefined) userParams.age = user.age;
        if (user.height !== undefined) userParams.height = user.height;
        if (user.weight !== undefined) userParams.weight = user.weight;
        if (user.bodyType !== undefined) userParams.bodyType = user.bodyType;
        if (user.skinTone !== undefined) userParams.skinTone = user.skinTone;
        if (user.hairColor !== undefined) userParams.hairColor = user.hairColor;
        if (user.hairLength !== undefined) userParams.hairLength = user.hairLength;
        if (user.hairType !== undefined) userParams.hairType = user.hairType;
        if (user.hairStyle !== undefined) userParams.hairStyle = user.hairStyle;
        if (user.hijab !== undefined) userParams.hijab = user.hijab;
        
        // Temel kullanÄ±cÄ± verisi
        const userData = {
          username: user.username || null,
          usernameLower: user.username ? user.username.toLowerCase() : null,
          displayName: user.displayName || null,
          profilePhoto: user.profilePhoto || null,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // params sadece boÅŸ deÄŸilse ekle
        if (Object.keys(userParams).length > 0) {
          userData.params = userParams;
        }
        
        if (avatarData && avatarData.startsWith('data:image')) {
          pendingSaveRef.current = true;
          uploadAvatarToStorage(userId, avatarData).then(storageUrl => {
            // Save to Firestore with storage URL reference AND backup base64
            db.collection('users').doc(userId).set({
              ...userData,
              baseAvatarStorageUrl: storageUrl || null,
              baseAvatarDataUrl: avatarData.substring(0, 500000) // Store truncated backup (500KB max)
            }, { merge: true })
              .then(() => {
                console.log('âœ… User data saved to Firestore');
                pendingSaveRef.current = false;
              })
              .catch(e => {
                console.error('âŒ User save error:', e.code, e.message);
                pendingSaveRef.current = false;
              });
          });
        } else {
          // Just save without baseAvatar
          pendingSaveRef.current = true;
          db.collection('users').doc(userId).set(userData, { merge: true })
            .then(() => {
              console.log('âœ… User data saved (no avatar)');
              pendingSaveRef.current = false;
            })
            .catch(e => {
              console.error('âŒ User save error:', e.code, e.message);
              pendingSaveRef.current = false;
            });
        }
      }
    }
  }, [user, authUser, initialLoadComplete]);

  // Save closet to Firestore (user-specific) - with debounce
  const closetSaveTimeoutRef = React.useRef(null);
  useEffect(() => {
    if (authUser && initialLoadComplete && db && closet) {
      // Clear previous timeout
      if (closetSaveTimeoutRef.current) clearTimeout(closetSaveTimeoutRef.current);
      
      // Debounce: wait 1 second before saving
      closetSaveTimeoutRef.current = setTimeout(() => {
        console.log('ðŸ’¾ Saving closet:', closet.length, 'items');
        pendingSaveRef.current = true;
        db.collection('users').doc(authUser.uid).update({ closet })
          .then(() => {
            console.log('âœ… Closet saved');
            pendingSaveRef.current = false;
          })
          .catch(e => {
            console.error('âŒ Closet save error:', e.code, e.message);
            pendingSaveRef.current = false;
          });
      }, 1000);
    }
    return () => {
      if (closetSaveTimeoutRef.current) clearTimeout(closetSaveTimeoutRef.current);
    };
  }, [closet, authUser, initialLoadComplete]);

  // Save settings to Firestore - with debounce
  const settingsSaveTimeoutRef = React.useRef(null);
  useEffect(() => {
    if (authUser && initialLoadComplete && db) {
      if (settingsSaveTimeoutRef.current) clearTimeout(settingsSaveTimeoutRef.current);
      settingsSaveTimeoutRef.current = setTimeout(() => {
        pendingSaveRef.current = true;
        db.collection('users').doc(authUser.uid).update({ settings })
          .then(() => {
            console.log('âœ… Settings saved');
            pendingSaveRef.current = false;
          })
          .catch(e => {
            console.error('âŒ Settings save error:', e.code, e.message);
            pendingSaveRef.current = false;
          });
      }, 1000);
    }
    return () => {
      if (settingsSaveTimeoutRef.current) clearTimeout(settingsSaveTimeoutRef.current);
    };
  }, [settings, authUser, initialLoadComplete]);

  // Save savedCombos to Firestore - with debounce
  const combosSaveTimeoutRef = React.useRef(null);
  useEffect(() => {
    if (authUser && initialLoadComplete && db) {
      if (combosSaveTimeoutRef.current) clearTimeout(combosSaveTimeoutRef.current);
      combosSaveTimeoutRef.current = setTimeout(() => {
        pendingSaveRef.current = true;
        db.collection('users').doc(authUser.uid).update({ savedCombos })
          .then(() => {
            console.log('âœ… Saved combos saved');
            pendingSaveRef.current = false;
          })
          .catch(e => {
            console.error('âŒ Combos save error:', e.code, e.message);
            pendingSaveRef.current = false;
          });
      }, 1000);
    }
    return () => {
      if (combosSaveTimeoutRef.current) clearTimeout(combosSaveTimeoutRef.current);
    };
  }, [savedCombos, authUser, initialLoadComplete]);

  // Save favorites to Firestore - with debounce
  const favoritesSaveTimeoutRef = React.useRef(null);
  useEffect(() => {
    if (authUser && initialLoadComplete && db) {
      if (favoritesSaveTimeoutRef.current) clearTimeout(favoritesSaveTimeoutRef.current);
      favoritesSaveTimeoutRef.current = setTimeout(() => {
        pendingSaveRef.current = true;
        db.collection('users').doc(authUser.uid).update({ favorites })
          .then(() => {
            console.log('âœ… Favorites saved');
            pendingSaveRef.current = false;
          })
          .catch(e => {
            console.error('âŒ Favorites save error:', e.code, e.message);
            pendingSaveRef.current = false;
          });
      }, 1000);
    }
    return () => {
      if (favoritesSaveTimeoutRef.current) clearTimeout(favoritesSaveTimeoutRef.current);
    };
  }, [favorites, authUser, initialLoadComplete]);

  // Save tryHistory to Firestore (limit to last 30) - with debounce
  const historySaveTimeoutRef = React.useRef(null);
  useEffect(() => {
    if (authUser && initialLoadComplete && db) {
      if (historySaveTimeoutRef.current) clearTimeout(historySaveTimeoutRef.current);
      historySaveTimeoutRef.current = setTimeout(() => {
        pendingSaveRef.current = true;
        db.collection('users').doc(authUser.uid).update({ tryHistory: tryHistory.slice(0, 30) })
          .then(() => {
            console.log('âœ… Try history saved');
            pendingSaveRef.current = false;
          })
          .catch(e => {
            console.error('âŒ History save error:', e.code, e.message);
            pendingSaveRef.current = false;
          });
      }, 1000);
    }
    window.tryHistoryRef = tryHistory;
    return () => {
      if (historySaveTimeoutRef.current) clearTimeout(historySaveTimeoutRef.current);
    };
  }, [tryHistory, authUser, initialLoadComplete]);

  // Save posts to localStorage (shared across users)
  useEffect(() => {
    localStorage.setItem('trai_posts_v1', JSON.stringify(posts));
  }, [posts]);

  const addToCloset = item => setCloset(prev => prev.some(x => x.id === item.id) ? prev : [...prev, { ...item, subType: item.subType || item.type || null, addedAt: Date.now() }]);
  const removeFromCloset = id => setCloset(prev => prev.filter(i => i.id !== id));
  
  // Add custom clothing to closet
  const addCustomClothing = async (item) => {
    // Add to local state - closet will be automatically saved via useEffect
    setCloset(prev => [...prev, { ...item, isCustom: true, addedAt: Date.now() }]);
    console.log('ðŸ‘• Custom clothing added:', item.name);
    // No need for separate Firestore save - the closet useEffect handles it
  };

  // Get base avatar - prefer from Storage, fallback to local
  // Avatar cache - Firebase'den bir kez indir, sonra cache'den kullan
  const [avatarCache, setAvatarCache] = useState(null);
  
  const getBaseAvatar = async () => {
    // 1. Ã–nce cache'e bak
    if (avatarCache) {
      debugLog('Avatar', 'Cache\'den alÄ±ndÄ±', 'success');
      return avatarCache;
    }
    
    // 2. Local state'e bak
    const localAvatar = user?.baseAvatar || user?.avatar;
    if (localAvatar && localAvatar.startsWith('data:image')) {
      debugLog('Avatar', 'Local state\'den alÄ±ndÄ±', 'success');
      setAvatarCache(localAvatar);
      return localAvatar;
    }
    
    // 3. Son Ã§are: Firebase Storage'dan indir
    if (authUser && storage) {
      debugLog('Avatar', 'Firebase\'den indiriliyor...', 'info');
      const storageAvatar = await downloadAvatarFromStorage(authUser.uid);
      if (storageAvatar) {
        debugLog('Avatar', 'Firebase\'den indirildi', 'success');
        setAvatarCache(storageAvatar);
        return storageAvatar;
      }
    }
    
    debugLog('Avatar', 'Avatar bulunamadÄ±', 'error');
    return null;
  };
  
  // Avatar deÄŸiÅŸtiÄŸinde cache'i gÃ¼ncelle
  useEffect(() => {
    const localAvatar = user?.baseAvatar || user?.avatar;
    if (localAvatar && localAvatar.startsWith('data:image')) {
      setAvatarCache(localAvatar);
    }
  }, [user?.baseAvatar, user?.avatar]);

  const tryOnSingle = async item => {
    const avatarData = user?.baseAvatar || user?.avatar;
    if (!avatarData) {
      // Avatar yoksa, prompt modal gÃ¶ster
      setShowAvatarPrompt(true);
      return;
    }
    
    // Check if user is Gold (no watermark)
    const isGoldUser = user?.subscription === 'gold' || user?.subscriptionTier === 'gold';
    
    // Check cache first - no cooldown or token usage for cached results
    const cacheKey = `single_${item.id}`;
    if (tryOnCache[cacheKey]) {
      // Use cached result
      addToCloset(item);
      setResult({ open: true, image: tryOnCache[cacheKey], item });
      setToast({ open: true, type: 'success', title: 'HÄ±zlÄ± SonuÃ§ âš¡', message: 'Ã–nceki deneme gÃ¶rseli yÃ¼klendi!' });
      return;
    }
    
    // Kredi kontrolÃ¼ - keÅŸfet iÃ§in 'shop' source
    if (!useCredit('shop')) {
      return;
    }
    
    // Check cooldown before making API request
    if (!checkCooldown()) return;
    
    setTrying(true);
    setTryItem(item);
    setLastTryTime(Date.now()); // Set cooldown start
    
    try {
      const baseAvatar = await getBaseAvatar();
      if (!baseAvatar || !baseAvatar.startsWith('data:image')) {
        throw new Error('Avatar yÃ¼klenemedi');
      }
      
      let img = await AI.tryOnSingle(baseAvatar, item, BACKGROUNDS[0].value, { hijab: user?.hijab });
      
      if (!img || !img.startsWith('data:image')) {
        throw new Error('GÃ¶rsel oluÅŸturulamadÄ±');
      }
      
      // Add watermark unless Gold user
      if (!isGoldUser) {
        img = await addWatermark(img, 'TrAi Style');
      }
      
      setTryOnCache(prev => ({ ...prev, [cacheKey]: img }));
      addToCloset(item);
      setUser(prev => ({ ...prev, tryOnCount: (prev.tryOnCount || 0) + 1 }));
      setResult({ open: true, image: img, item });
      setToast({ open: true, type: 'success', title: t('success'), message: 'Deneme gÃ¶rseli hazÄ±r!' });
    } catch (e) {
      // Hata durumunda krediyi iade et
      refundCredit('shop');
      // refundCredit zaten toast gÃ¶steriyor, ek hata mesajÄ± gÃ¶stermeye gerek yok
    } finally {
      setTrying(false);
      setTryItem(null);
    }
  };

  // Callback for SmartCloset combo results
  const onTryOnResult = (img, items) => {
    try {
      debugLog('Result', `SonuÃ§ alÄ±ndÄ±: ${img ? Math.round(img.length/1024) + 'KB' : 'null'}, ${items?.length || 0} Ã¼rÃ¼n`, img ? 'success' : 'error');
      
      if (!img || !img.startsWith('data:image')) {
        debugLog('Result', 'GeÃ§ersiz gÃ¶rsel formatÄ±', 'error');
        setToast({ open: true, type: 'error', title: t('error'), message: 'GÃ¶rsel oluÅŸturulamadÄ±' });
        return;
      }
      
      debugLog('Result', 'Dolaba ekleniyor...', 'info');
      items.forEach(addToCloset);
      
      debugLog('Result', 'User gÃ¼ncelleniyor...', 'info');
      setUser(prev => ({ ...prev, tryOnCount: (prev.tryOnCount || 0) + 1 }));
      
      debugLog('Result', 'Modal state hazÄ±rlanÄ±yor...', 'info');
      const modalData = { 
        open: true, 
        image: img, 
        item: items.length === 1 ? items[0] : null,
        items: items
      };
      
      debugLog('Result', 'setResult Ã§aÄŸrÄ±lÄ±yor...', 'info');
      setResult(modalData);
      debugLog('Result', 'Modal aÃ§Ä±ldÄ± âœ“', 'success');
    } catch (err) {
      debugLog('Result', `HATA: ${err.message}`, 'error');
      console.error('onTryOnResult error:', err);
      setToast({ open: true, type: 'error', title: t('error'), message: 'SonuÃ§ gÃ¶sterilemedi: ' + err.message });
    }
  };

  const getAdvice = async item => {
    setAdvice({ open: true, item, text: '', loading: true });
    const text = await AI.getStyleAdvice(item, user);
    setAdvice(prev => ({ ...prev, text, loading: false }));
  };

  const resetAvatar = () => {
    if (confirm('AvatarÄ±nÄ± yenilemek istiyor musun? Ã–nceki deneme gÃ¶rselleri de silinecek.')) {
      setUser(null);
      setTryOnCache({}); // Clear try-on cache when avatar changes
      if (authUser) {
        localStorage.removeItem(`trai_user_${authUser.uid}`);
        localStorage.removeItem(`trai_tryoncache_${authUser.uid}`);
      }
    }
  };

  // Delete account and all user data
  const deleteAccount = async () => {
    if (!confirm('HesabÄ±nÄ± ve tÃ¼m verilerini kalÄ±cÄ± olarak silmek istiyor musun? Bu iÅŸlem geri alÄ±namaz!')) return;
    if (!confirm('Emin misin? Avatar, dolap, paylaÅŸÄ±mlar, geÃ§miÅŸ ve tÃ¼m veriler silinecek.')) return;
    
    try {
      if (authUser) {
        const userId = authUser.uid;
        const userEmail = authUser.email;
        
        // Delete user's posts from local state immediately
        setPosts(prev => prev.filter(p => p.authorId !== userId));
        
        // Delete from Firestore
        if (db) {
          await db.collection('users').doc(userId).delete()
            .catch(e => console.error('âŒ User doc delete error:', e.code, e.message));
          
          // Track deleted email to prevent free trial abuse
          if (userEmail) {
            await db.collection('deletedEmails').doc(userEmail.toLowerCase()).set({
              deletedAt: Date.now(),
              uid: userId
            }).catch(e => console.warn('âš ï¸ Deleted email track error:', e));
          }
          
          // Delete user's posts from Firestore (if stored there)
          try {
            const postsSnapshot = await db.collection('posts').where('authorId', '==', userId).get();
            const batch = db.batch();
            postsSnapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            console.log('âœ… User posts deleted from Firestore');
          } catch (e) {
            console.warn('âš ï¸ Posts delete error:', e);
          }
          
          // Delete user's comments from posts
          try {
            const allPostsSnapshot = await db.collection('posts').get();
            const batch = db.batch();
            allPostsSnapshot.forEach(doc => {
              const data = doc.data();
              if (data.comments && data.comments.some(c => c.authorId === userId)) {
                const filteredComments = data.comments.filter(c => c.authorId !== userId);
                batch.update(doc.ref, { comments: filteredComments });
              }
            });
            await batch.commit();
          } catch (e) {
            console.warn('âš ï¸ Comments cleanup error:', e);
          }
          
          // Delete follows where user is involved
          try {
            const followsFromSnapshot = await db.collection('follows').where('fromUid', '==', userId).get();
            const followsToSnapshot = await db.collection('follows').where('toUid', '==', userId).get();
            const batch = db.batch();
            followsFromSnapshot.forEach(doc => batch.delete(doc.ref));
            followsToSnapshot.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            console.log('âœ… User follows deleted');
          } catch (e) {
            console.warn('âš ï¸ Follows delete error:', e);
          }
        }
        
        // Delete from Storage
        if (storage) {
          try {
            // Delete avatar
            await storage.ref(`avatars/${userId}/base-avatar.png`).delete().catch(() => {});
            
            // Delete shared images
            const sharedRef = storage.ref(`shared/${userId}`);
            const sharedList = await sharedRef.listAll().catch(() => ({ items: [] }));
            await Promise.all(sharedList.items.map(item => item.delete().catch(() => {})));
            
            // Delete combo images
            const combosRef = storage.ref(`combos/${userId}`);
            const combosList = await combosRef.listAll().catch(() => ({ items: [] }));
            await Promise.all(combosList.items.map(item => item.delete().catch(() => {})));
            
            console.log('âœ… User storage files deleted');
          } catch (e) {
            console.warn('âš ï¸ Storage delete error:', e);
          }
        }
        
        // Clear all localStorage
        localStorage.removeItem(`trai_user_${userId}`);
        localStorage.removeItem(`trai_closet_${userId}`);
        localStorage.removeItem(`trai_friends_${userId}`);
        localStorage.removeItem(`trai_messages_${userId}`);
        localStorage.removeItem(`trai_settings_${userId}`);
        localStorage.removeItem(`trai_combos_${userId}`);
        localStorage.removeItem(`trai_favorites_${userId}`);
        localStorage.removeItem(`trai_history_${userId}`);
        localStorage.removeItem(`trai_tryoncache_${userId}`);
        
        // Delete Firebase auth account
        if (auth?.currentUser) {
          await auth.currentUser.delete();
        }
      }
      // Clear state
      setUser(null);
      setAuthUser(null);
      setToast({ open: true, type: 'success', title: 'Hesap Silindi', message: 'TÃ¼m verileriniz kalÄ±cÄ± olarak silindi.' });
    } catch (e) {
      setToast({ open: true, type: 'error', title: t('error'), message: 'Hesap silinemedi: ' + e.message });
    }
  };

  const logout = async () => {
    if (auth) await auth.signOut();
    setAuthUser(null);
    setToast({ open: true, type: 'success', title: 'Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±', message: 'GÃ¶rÃ¼ÅŸÃ¼rÃ¼z!' });
  };

  // Auth screen
  if (!authUser) {
    return (
      <>
        <div className="h-screen w-full max-w-lg lg:max-w-6xl mx-auto bg-dark"><AuthScreen onAuthed={setAuthUser} setToast={setToast} changeLanguage={changeLanguage} /></div>
        <Toast toast={toast} onClose={() => setToast({ open: false })} />
      </>
    );
  }

  // Avatar wizard - artÄ±k kayÄ±t sonrasÄ± zorunlu deÄŸil, sadece showAvatarWizard true ise gÃ¶ster
  if (showAvatarWizard) {
    return (
      <>
        <div className="h-screen w-full max-w-lg lg:max-w-6xl mx-auto bg-dark">
          <AvatarWizard 
            onComplete={async (avatarData) => {
              setUser(prev => ({ ...prev, ...avatarData }));
              setShowAvatarWizard(false);
              setShowAvatarPrompt(false);
              
              // Referral Ã¶dÃ¼lÃ¼nÃ¼ tetikle (ilk avatar oluÅŸturma)
              if (user?.referredBy && !user?.referralActivated) {
                console.log('ðŸŽ Triggering referral reward for first avatar...');
                await triggerReferralReward();
                
                // KullanÄ±cÄ±nÄ±n referralActivated durumunu gÃ¼ncelle
                if (db && authUser?.uid) {
                  db.collection('users').doc(authUser.uid).update({
                    referralActivated: true
                  }).catch(e => console.error('referralActivated update error:', e));
                }
                setUser(prev => ({ ...prev, referralActivated: true }));
              }
            }} 
            setToast={setToast} 
            initialParams={user}
            useCredit={useCredit}
            refundCredit={refundCredit}
          />
        </div>
        <Toast toast={toast} onClose={() => setToast({ open: false })} />
      </>
    );
  }
  
  // Avatar yÃ¼kleniyorsa loading gÃ¶ster
  if (loadingAvatar) {
    return (
      <>
        <div className="h-screen w-full max-w-lg lg:max-w-6xl mx-auto bg-dark flex items-center justify-center">
          <div className="text-center">
            <div className="w-16 h-16 rounded-2xl bg-brand flex items-center justify-center mx-auto mb-4 animate-pulse">
              <span className="text-3xl">âœ¨</span>
            </div>
            <p className="text-slate-500 font-medium">AvatarÄ±n yÃ¼kleniyor...</p>
          </div>
        </div>
        <Toast toast={toast} onClose={() => setToast({ open: false })} />
      </>
    );
  }
  
  // User henÃ¼z yÃ¼klenmediyse loading gÃ¶ster
  if (!user) {
    return (
      <>
        <div className="h-screen w-full max-w-lg lg:max-w-6xl mx-auto bg-dark flex items-center justify-center">
          <div className="text-center">
            <div className="w-16 h-16 rounded-2xl bg-brand flex items-center justify-center mx-auto mb-4 animate-pulse">
              <span className="text-3xl">ðŸ‘¤</span>
            </div>
            <p className="text-slate-500 font-medium">Profil yÃ¼kleniyor...</p>
          </div>
        </div>
        <Toast toast={toast} onClose={() => setToast({ open: false })} />
      </>
    );
  }

  // Enhance user with stats
  const userWithStats = { ...user, closetCount: closet.length, tryOnCount: user?.tryOnCount || 0 };

  // Desktop navigation items
  const navItems = [
    { id: 'shop', icon: 'shop', label: t('shopTab') || 'KeÅŸfet' },
    { id: 'closet', icon: 'hanger', label: t('closetTab') || 'DolabÄ±m' },
    { id: 'social', icon: 'users', label: t('socialTab') || 'Sosyal' },
    { id: 'profile', icon: 'user', label: t('profileTab') || 'Profil' }
  ];

  // Main app
  return (
    <>
      {/* Desktop Layout */}
      <div className="hidden lg:grid app-shell">
        {/* Left Sidebar - Navigation */}
        <div className="desktop-sidebar-left">
          <button 
            onClick={() => setTab('shop')}
            className="flex items-center gap-3 mb-8 hover:opacity-80 transition text-left"
          >
            <img src={LOGO_BASE64} alt="TrAi" className="w-10 h-10 rounded-xl" />
            <div>
              <h1 className="font-bold text-lg">{CONFIG.name}</h1>
              <p className="text-xs text-slate-500">{t('slogan')}</p>
            </div>
          </button>
          
          <nav className="space-y-2">
            {navItems.map(item => (
              <button
                key={item.id}
                onClick={() => setTab(item.id)}
                className={`desktop-nav-item w-full ${tab === item.id ? 'active' : ''}`}
              >
                <Icon name={item.icon} size={20} />
                <span>{item.label}</span>
              </button>
            ))}
          </nav>
          
          {/* User Info */}
          <div className="mt-auto pt-8 border-t border-slate-200 mt-8">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-xl overflow-hidden bg-brand">
                {(user.profilePhoto || user.baseAvatar) ? (
                  <img src={user.profilePhoto || user.baseAvatar} className="w-full h-full object-cover" />
                ) : (
                  <div className="w-full h-full flex items-center justify-center text-white">
                    <Icon name="user" size={20} />
                  </div>
                )}
              </div>
              <div className="flex-1 min-w-0">
                <p className="font-semibold text-sm truncate">{user.displayName || user.username}</p>
                <p className="text-xs text-slate-500">@{user.username}</p>
              </div>
            </div>
            <div className="flex items-center gap-4 mt-4 text-sm">
              <span className="text-amber-500">ðŸª™ {(user.freeAvatarTry || 0) + (user.freeShopTry || 0) + (user.freeComboTry || 0) + (user.credits || 0)}</span>
            </div>
          </div>
        </div>
        
        {/* Main Content */}
        <div className="desktop-main flex flex-col overflow-hidden">
          {tab === 'shop' && <Shop user={user} closet={closet} onTryOn={tryOnSingle} onAddToCloset={addToCloset} onAdvice={getAdvice} onAddToCart={addToCart} cart={cart} onShowCart={() => setShowCart(true)} onShowSubscription={() => setShowSubscription(true)} setTab={setTab} />}
          {tab === 'closet' && (
            <SmartCloset 
              user={user}
              authUser={authUser}
              closet={closet} 
              onRemove={removeFromCloset} 
              onTryOnResult={onTryOnResult} 
              setToast={setToast}
              savedCombos={savedCombos}
              setSavedCombos={setSavedCombos}
              favorites={favorites}
              setFavorites={setFavorites}
              tryHistory={tryHistory}
              setTryHistory={setTryHistory}
              getBaseAvatar={getBaseAvatar}
              tryOnCache={tryOnCache}
              setTryOnCache={setTryOnCache}
              checkCooldown={checkCooldown}
              setLastTryTime={setLastTryTime}
              settings={settings}
              onShowSubscription={() => setShowSubscription(true)}
              onAddCustomClothing={addCustomClothing}
              useCredit={useCredit}
              refundCredit={refundCredit}
              onAddToCart={addToCart}
              showAvatarPrompt={showAvatarPrompt}
              setShowAvatarPrompt={setShowAvatarPrompt}
              onFirstTryOn={() => {
                if (settings.analyticsConsent === null && !settings.analyticsConsentDismissed) {
                  setTimeout(() => setConsentPopup({ open: true, type: 'analytics' }), 1500);
                }
              }}
              onShareToFeed={(image, items) => {
                if (settings.sharingConsent === null && !settings.sharingConsentDismissed) {
                  window.pendingShare = { image, items };
                  setConsentPopup({ open: true, type: 'sharing' });
                  return;
                }
                const newPost = {
                  id: Date.now(),
                  authorId: authUser?.uid,
                  authorName: user?.username || user?.displayName || 'KullanÄ±cÄ±',
                  authorUsername: user?.username,
                  authorAvatar: user?.profilePhoto || user?.baseAvatar || user?.avatar,
                  image: image,
                  items: items || [],
                  caption: '',
                  askFeedback: false,
                  visibility: 'public',
                  likes: [],
                  comments: [],
                  createdAt: Date.now()
                };
                setPosts(prev => [newPost, ...prev]);
                setTab('social');
              }}
            />
          )}
          {tab === 'profile' && (
            <Profile 
              user={userWithStats} 
              authUser={authUser} 
              onResetAvatar={resetAvatar} 
              onLogout={logout}
              onDeleteAccount={deleteAccount}
              friends={friends}
              setFriends={setFriends}
              messages={messages}
              setMessages={setMessages}
              settings={settings}
              setSettings={setSettings}
              followRequests={followRequests}
              setFollowRequests={setFollowRequests}
              sentFollowRequests={sentFollowRequests}
              setSentFollowRequests={setSentFollowRequests}
              notifications={notifications}
              setNotifications={setNotifications}
              dmChats={dmChats}
              setDmChats={setDmChats}
              selectedChat={selectedChat}
              setSelectedChat={setSelectedChat}
              groups={groups}
              setGroups={setGroups}
              setMainTab={setTab}
              onUpdateUser={(newParams) => {
                setUser(prev => ({ ...prev, ...newParams }));
                setAvatarCache(null);
              }}
              onUpdateProfilePhoto={(photo) => {
                setUser(prev => ({ ...prev, profilePhoto: photo }));
              }}
              changeLanguage={changeLanguage}
            />
          )}
          {tab === 'social' && (
            <SocialFeed
              user={user}
              authUser={authUser}
              friends={friends}
              setFriends={setFriends}
              posts={posts}
              setPosts={setPosts}
              setToast={setToast}
              dmChats={dmChats}
              setDmChats={setDmChats}
              followRequests={followRequests}
              setFollowRequests={setFollowRequests}
              sentFollowRequests={sentFollowRequests}
              setSentFollowRequests={setSentFollowRequests}
              groups={groups}
              setGroups={setGroups}
              notifications={notifications}
              setNotifications={setNotifications}
            />
          )}
        </div>
        
        {/* Right Sidebar - Quick Stats / Activity */}
        <div className="desktop-sidebar-right">
          <h3 className="font-bold text-sm text-slate-500 mb-4">{t('quickStats') || 'HÄ±zlÄ± BakÄ±ÅŸ'}</h3>
          
          <div className="space-y-4">
            <div className="glass rounded-xl p-4">
              <p className="text-xs text-slate-500 mb-1">{t('closetCount') || 'DolabÄ±mda'}</p>
              <p className="text-2xl font-bold">{closet.length} <span className="text-sm font-normal text-slate-500">parÃ§a</span></p>
            </div>
            
            <div className="glass rounded-xl p-4">
              <p className="text-xs text-slate-500 mb-1">{t('savedCombos') || 'KayÄ±tlÄ± Kombinler'}</p>
              <p className="text-2xl font-bold">{savedCombos.length} <span className="text-sm font-normal text-slate-500">kombin</span></p>
            </div>
            
            <div className="glass rounded-xl p-4">
              <p className="text-xs text-slate-500 mb-1">{t('tryOnHistory') || 'Deneme GeÃ§miÅŸi'}</p>
              <p className="text-2xl font-bold">{tryHistory.length} <span className="text-sm font-normal text-slate-500">deneme</span></p>
            </div>
          </div>
          
          {/* Recent Try-ons */}
          {tryHistory.length > 0 && (
            <div className="mt-6">
              <h3 className="font-bold text-sm text-slate-500 mb-3">{t('recentTryOns') || 'Son Denemeler'}</h3>
              <div className="grid grid-cols-2 gap-2">
                {tryHistory.slice(0, 4).map(item => (
                  <div key={item.id} className="aspect-[3/4] rounded-xl overflow-hidden">
                    <img src={item.image} className="w-full h-full object-cover" />
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Mobile Layout */}
      <div className="lg:hidden fixed inset-0 w-full max-w-lg mx-auto bg-dark flex flex-col">
        <div className="flex-1 overflow-y-auto overflow-x-hidden">
          {tab === 'shop' && <Shop user={user} closet={closet} onTryOn={tryOnSingle} onAddToCloset={addToCloset} onAdvice={getAdvice} onAddToCart={addToCart} cart={cart} onShowCart={() => setShowCart(true)} onShowSubscription={() => setShowSubscription(true)} setTab={setTab} />}
          {tab === 'closet' && (
            <SmartCloset 
              user={user}
              authUser={authUser}
              closet={closet} 
              onRemove={removeFromCloset} 
              onTryOnResult={onTryOnResult} 
              setToast={setToast}
              savedCombos={savedCombos}
              setSavedCombos={setSavedCombos}
              favorites={favorites}
              setFavorites={setFavorites}
              tryHistory={tryHistory}
              setTryHistory={setTryHistory}
              getBaseAvatar={getBaseAvatar}
              tryOnCache={tryOnCache}
              setTryOnCache={setTryOnCache}
              checkCooldown={checkCooldown}
              setLastTryTime={setLastTryTime}
              settings={settings}
              onShowSubscription={() => setShowSubscription(true)}
              onAddCustomClothing={addCustomClothing}
              useCredit={useCredit}
              refundCredit={refundCredit}
              onAddToCart={addToCart}
              showAvatarPrompt={showAvatarPrompt}
              setShowAvatarPrompt={setShowAvatarPrompt}
              onFirstTryOn={() => {
                if (settings.analyticsConsent === null && !settings.analyticsConsentDismissed) {
                  setTimeout(() => setConsentPopup({ open: true, type: 'analytics' }), 1500);
                }
              }}
              onShareToFeed={(image, items) => {
                if (settings.sharingConsent === null && !settings.sharingConsentDismissed) {
                  window.pendingShare = { image, items };
                  setConsentPopup({ open: true, type: 'sharing' });
                  return;
                }
                const newPost = {
                  id: Date.now(),
                  authorId: authUser?.uid,
                  authorName: user?.username || user?.displayName || 'KullanÄ±cÄ±',
                  authorUsername: user?.username,
                  authorAvatar: user?.profilePhoto || user?.baseAvatar || user?.avatar,
                  image: image,
                  items: items || [],
                  caption: '',
                  askFeedback: false,
                  visibility: 'public',
                  likes: [],
                  comments: [],
                  createdAt: Date.now()
                };
                setPosts(prev => [newPost, ...prev]);
                setTab('social');
              }}
            />
          )}
          {tab === 'profile' && (
            <Profile 
              user={userWithStats} 
              authUser={authUser} 
              onResetAvatar={resetAvatar} 
              onLogout={logout}
              onDeleteAccount={deleteAccount}
              friends={friends}
              setFriends={setFriends}
              messages={messages}
              setMessages={setMessages}
              settings={settings}
              setSettings={setSettings}
              followRequests={followRequests}
              setFollowRequests={setFollowRequests}
              sentFollowRequests={sentFollowRequests}
              setSentFollowRequests={setSentFollowRequests}
              notifications={notifications}
              setNotifications={setNotifications}
              dmChats={dmChats}
              setDmChats={setDmChats}
              selectedChat={selectedChat}
              setSelectedChat={setSelectedChat}
              groups={groups}
              setGroups={setGroups}
              setMainTab={setTab}
              onUpdateUser={(newParams) => {
                setUser(prev => ({ ...prev, ...newParams }));
                setAvatarCache(null);
              }}
              onUpdateProfilePhoto={(photo) => {
                setUser(prev => ({ ...prev, profilePhoto: photo }));
              }}
              changeLanguage={changeLanguage}
            />
          )}
          {tab === 'social' && (
            <SocialFeed
              user={user}
              authUser={authUser}
              friends={friends}
              setFriends={setFriends}
              posts={posts}
              setPosts={setPosts}
              setToast={setToast}
              dmChats={dmChats}
              setDmChats={setDmChats}
              followRequests={followRequests}
              setFollowRequests={setFollowRequests}
              sentFollowRequests={sentFollowRequests}
              setSentFollowRequests={setSentFollowRequests}
              groups={groups}
              setGroups={setGroups}
              notifications={notifications}
              setNotifications={setNotifications}
            />
          )}
        </div>
        <BottomNav tab={tab} setTab={setTab} hasNotifications={posts.some(p => p.askFeedback && p.authorId !== authUser?.uid)} />
      </div>

      {trying && <FullscreenLoader title="Deneme HazÄ±rlanÄ±yor" subtitle={`${tryItem?.name || 'AI gÃ¶rsel oluÅŸturuyor'}...`} />}
      <ResultModal 
        open={result.open} 
        image={result.image} 
        item={result.item}
        items={result.items}
        onClose={() => setResult({ open: false })} 
        onShare={async () => { 
          const shareResult = await uploadAndShareImage(result.image, authUser, storage);
          if (shareResult?.copied) {
            setToast({ open: true, type: 'success', title: 'Link KopyalandÄ±!', message: 'PaylaÅŸÄ±m linki panoya kopyalandÄ±' });
          }
        }}
        onAddToCart={addToCart}
        onSaveCombo={async (combo) => {
          try {
            let imageUrl = combo.image;
            
            // If image is base64, upload to Firebase Storage
            if (combo.image && combo.image.startsWith('data:image') && storage && authUser?.uid) {
              try {
                const comboId = Date.now();
                const storageRef = storage.ref(`combos/${authUser.uid}/${comboId}.png`);
                
                // Convert base64 to blob
                const response = await fetch(combo.image);
                const blob = await response.blob();
                
                // Upload
                await storageRef.put(blob);
                imageUrl = await storageRef.getDownloadURL();
                console.log('âœ… Combo image uploaded to Storage');
              } catch (uploadErr) {
                console.warn('âš ï¸ Combo image upload failed, using base64:', uploadErr);
                // Fallback: compress the image or skip
                imageUrl = null; // Don't save huge base64
              }
            }
            
            const newCombo = {
              id: Date.now(),
              name: `Kombin ${savedCombos.length + 1}`,
              image: imageUrl,
              items: (combo.items || []).map(item => ({
                id: item.id,
                name: item.name,
                brandName: item.brandName,
                price: item.price,
                image: item.image,
                category: item.category,
                color: item.color,
                type: item.type
              })),
              background: { id: 'studio', value: 'Clean white studio', label: 'StÃ¼dyo' },
              createdAt: Date.now()
            };
            setSavedCombos(prev => [newCombo, ...prev]);
            setToast({ open: true, type: 'success', title: 'Kaydedildi!', message: 'Kombinler sekmesine eklendi' });
          } catch (err) {
            console.error('Combo save error:', err);
            setToast({ open: true, type: 'error', title: 'Hata', message: 'Kombin kaydedilemedi' });
          }
        }}
        onShareToFeed={() => {
          // Sosyal akÄ±ÅŸa paylaÅŸ
          const newPost = {
            id: Date.now(),
            authorId: authUser?.uid,
            authorName: user?.username || user?.displayName || 'KullanÄ±cÄ±',
            authorUsername: user?.username,
            authorAvatar: user?.profilePhoto || user?.baseAvatar || user?.avatar,
            image: result.image, // SocialFeed 'image' alanÄ±nÄ± kullanÄ±yor
            items: result.items || (result.item ? [result.item] : []),
            caption: '',
            askFeedback: false,
            visibility: 'public',
            likes: [],
            comments: [],
            createdAt: Date.now()
          };
          setPosts(prev => [newPost, ...prev]);
          setResult({ open: false });
          setTab('social');
          setToast({ open: true, type: 'success', title: 'PaylaÅŸÄ±ldÄ±!', message: 'Kombinin sosyal akÄ±ÅŸta yayÄ±nlandÄ±' });
        }}
        onShareToDM={() => {
          // DM Share Modal'Ä± aÃ§
          setDmShareModal({
            open: true,
            image: result.image,
            items: result.items || []
          });
          setResult({ open: false });
        }}
      />
      <AdviceModal open={advice.open} item={advice.item || {}} advice={advice.text} loading={advice.loading} onClose={() => setAdvice({ open: false })} />
      
      {/* Size Selection Modal */}
      <SizeSelectionModal
        open={sizeModal.open}
        product={sizeModal.product}
        currentIndex={sizeModal.currentIndex}
        totalItems={sizeModal.totalItems}
        userMeasurements={user ? { height: user.height, weight: user.weight, bodyType: user.bodyType } : null}
        onSelect={(size) => {
          if (sizeModal.callback) {
            sizeModal.callback(size);
          }
          setSizeModal({ open: false, product: null, callback: null });
        }}
        onClose={() => setSizeModal({ open: false, product: null, callback: null })}
      />
      
      {/* DM Share Modal */}
      <DMShareModal
        open={dmShareModal.open}
        image={dmShareModal.image}
        items={dmShareModal.items}
        friends={friends}
        groups={[]}
        currentUserId={authUser?.uid}
        onClose={() => setDmShareModal({ open: false, image: null, items: [] })}
        onSend={async (userIds, image, items) => {
          if (!authUser?.uid || !db) {
            setToast({ open: true, type: 'error', title: 'Hata', message: 'GiriÅŸ yapÄ±lmamÄ±ÅŸ' });
            return;
          }
          
          setToast({ open: true, type: 'info', title: 'ðŸ“¤ GÃ¶nderiliyor...', message: 'LÃ¼tfen bekleyin' });
          
          try {
            // Upload image to Firebase Storage first
            let imageUrl = image;
            if (image && image.startsWith('data:image') && storage) {
              try {
                const timestamp = Date.now();
                const storageRef = storage.ref(`dm_images/${authUser.uid}/${timestamp}.jpg`);
                const response = await fetch(image);
                const blob = await response.blob();
                await storageRef.put(blob);
                imageUrl = await storageRef.getDownloadURL();
                console.log('âœ… DM image uploaded:', imageUrl);
              } catch (uploadErr) {
                console.warn('âš ï¸ Image upload failed:', uploadErr);
                // Continue without image URL
                imageUrl = null;
              }
            }
            
            // Send to each selected user
            for (const recipientId of userIds) {
              const chatId = [authUser.uid, recipientId].sort().join('_');
              
              // Get recipient info for participantNames
              let recipientName = 'KullanÄ±cÄ±';
              const friend = friends.find(f => f.id === recipientId);
              if (friend) {
                recipientName = friend.displayName || friend.username || 'KullanÄ±cÄ±';
              }
              
              const messageData = {
                senderId: authUser.uid,
                senderName: user?.displayName || user?.username || 'KullanÄ±cÄ±',
                recipientId,
                type: 'combo',
                image: imageUrl, // Now it's a proper URL
                items: (items || []).map(item => ({
                  id: item.id,
                  name: item.name,
                  brandName: item.brandName,
                  price: item.price,
                  image: item.image
                })),
                text: 'ðŸ“¸ Bir kombin paylaÅŸtÄ±',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                createdAt: Date.now(),
                read: false
              };
              
              // Save message
              await db.collection('chats').doc(chatId).collection('messages').add(messageData);
              
              // Update chat metadata
              await db.collection('chats').doc(chatId).set({
                participants: [authUser.uid, recipientId],
                participantNames: {
                  [authUser.uid]: user?.displayName || user?.username || 'KullanÄ±cÄ±',
                  [recipientId]: recipientName
                },
                lastMessage: 'ðŸ“¸ Bir kombin paylaÅŸtÄ±',
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessageBy: authUser.uid,
                updatedAt: Date.now()
              }, { merge: true });
            }
            
            setToast({ open: true, type: 'success', title: 'GÃ¶nderildi! âœ…', message: `${userIds.length} kiÅŸiye kombin gÃ¶nderildi` });
          } catch (err) {
            console.error('DM send error:', err);
            setToast({ open: true, type: 'error', title: 'Hata', message: 'Mesaj gÃ¶nderilemedi' });
          }
        }}
      />
      
      {/* Cart Modal - Trendyol Checkout */}
      <CartModal 
        open={showCart} 
        cart={cart} 
        onClose={() => setShowCart(false)} 
        onRemove={removeFromCart}
        onUpdateQuantity={updateCartQuantity}
        total={cartTotal}
      />
      
      {/* Paywall Modal */}
      <PaywallModal 
        open={showPaywall}
        onClose={() => setShowPaywall(false)}
        type={paywallType}
        user={user}
        onPurchase={(planId) => {
          setShowPaywall(false);
          // Plan seÃ§imine gÃ¶re SubscriptionModal'a yÃ¶nlendir
          setShowSubscription(true);
        }}
      />
      
      {/* Subscription Modal */}
      <SubscriptionModal 
        open={showSubscription} 
        user={user} 
        onClose={() => setShowSubscription(false)}
        onSubscribe={() => { setShowSubscription(false); setPaymentType('subscription'); setShowPayment(true); }}
        onBuyTokens={(amount, type, price) => { 
          setShowSubscription(false); 
          setPaymentType(type); 
          setTokenAmount(amount);
          setTokenPrice(price);
          setShowPayment(true); 
        }}
        loading={paymentLoading}
      />
      
      {/* Payment Modal */}
      <PaymentModal 
        open={showPayment} 
        onClose={() => setShowPayment(false)}
        onComplete={processPayment}
        amount={paymentType === 'subscription' ? 199 : paymentType === 'cart' ? cartTotal : tokenPrice}
        type={paymentType}
        tokenAmount={tokenAmount}
        loading={paymentLoading}
      />
      
      {/* GÃ¼nlÃ¼k Kombin Ã–nerisi Modal */}
      {showDailyModal && dailyRecommendation && (
        <div className="fixed inset-0 z-[100] bg-black/95 flex flex-col slide-up">
          <div className="p-4 flex items-center justify-between border-b border-slate-200">
            <h3 className="font-bold flex items-center gap-2">
              <span className="text-2xl">ðŸ‘”</span>
              GÃ¼nÃ¼n Kombin Ã–nerisi
            </h3>
            <button onClick={() => setShowDailyModal(false)} className="p-2 rounded-xl hover:bg-slate-200/60">
              <Icon name="x" size={20} />
            </button>
          </div>
          
          <div className="flex-1 overflow-auto custom-scroll p-4">
            {/* Hava Durumu */}
            {dailyWeather && (
              <div className="glass rounded-2xl p-4 mb-4 flex items-center gap-4">
                <span className="text-4xl">{dailyWeather.icon}</span>
                <div>
                  <p className="text-2xl font-bold">{dailyWeather.temp}Â°C</p>
                  <p className="text-slate-500">{dailyWeather.text}</p>
                </div>
              </div>
            )}
            
            {/* Ã–neri AÃ§Ä±klamasÄ± */}
            <div className="glass rounded-2xl p-4 mb-4">
              <p className="text-sm leading-relaxed">{dailyRecommendation.reason}</p>
              {dailyRecommendation.tip && (
                <p className="text-xs text-brand2 mt-2 flex items-center gap-1">
                  <Icon name="sparkles" size={12} />
                  {dailyRecommendation.tip}
                </p>
              )}
            </div>
            
            {/* Ã–nerilen ÃœrÃ¼nler */}
            <p className="text-xs text-slate-500 mb-2 font-bold">Ã–NERÄ°LEN KOMBÄ°N</p>
            <div className="grid grid-cols-2 gap-3">
              {dailyRecommendation.items.fullbody && (
                <div className="glass rounded-2xl p-3 col-span-2">
                  <div className="flex items-center gap-3">
                    <img src={dailyRecommendation.items.fullbody.image} className="w-20 h-20 rounded-xl object-cover ring-2 ring-brand" />
                    <div>
                      <p className="text-xs text-brand">ðŸ‘— {t('dressLabel')}</p>
                      <p className="font-semibold">{dailyRecommendation.items.fullbody.name}</p>
                      <p className="text-xs text-slate-500">{dailyRecommendation.items.fullbody.brandName}</p>
                    </div>
                  </div>
                </div>
              )}
              {dailyRecommendation.items.top && (
                <div className="glass rounded-2xl p-3">
                  <img src={dailyRecommendation.items.top.image} className="w-full aspect-square rounded-xl object-cover ring-2 ring-brand2 mb-2" />
                  <p className="text-xs text-brand2">ðŸ‘• {t('topLabel')}</p>
                  <p className="font-semibold text-sm truncate">{dailyRecommendation.items.top.name}</p>
                </div>
              )}
              {dailyRecommendation.items.bottom && (
                <div className="glass rounded-2xl p-3">
                  <img src={dailyRecommendation.items.bottom.image} className="w-full aspect-square rounded-xl object-cover ring-2 ring-accent mb-2" />
                  <p className="text-xs text-accent">ðŸ‘– {t('bottomLabel')}</p>
                  <p className="font-semibold text-sm truncate">{dailyRecommendation.items.bottom.name}</p>
                </div>
              )}
              {dailyRecommendation.items.outerwear && (
                <div className="glass rounded-2xl p-3 col-span-2">
                  <div className="flex items-center gap-3">
                    <img src={dailyRecommendation.items.outerwear.image} className="w-20 h-20 rounded-xl object-cover ring-2 ring-blue-400" />
                    <div>
                      <p className="text-xs text-blue-400">ðŸ§¥ {t('outerwearLabel')}</p>
                      <p className="font-semibold">{dailyRecommendation.items.outerwear.name}</p>
                      <p className="text-xs text-slate-500">{dailyRecommendation.items.outerwear.brandName}</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
          
          <div className="p-4 space-y-2 border-t border-slate-200 safe-bottom">
            <button 
              onClick={() => {
                // SeÃ§ili Ã¼rÃ¼nleri dolap sekmesine aktar
                setTab('closet');
                setShowDailyModal(false);
                setToast({ open: true, type: 'success', title: 'HazÄ±r!', message: 'Dolaba git ve kombini dene' });
              }}
              className="w-full btn-primary py-4 rounded-2xl font-bold flex items-center justify-center gap-2"
            >
              <Icon name="sparkles" size={18} />
              Bu Kombini Dene
            </button>
            <button 
              onClick={() => setShowDailyModal(false)}
              className="w-full btn-ghost py-3 rounded-2xl font-semibold text-slate-500"
            >
              Sonra BakarÄ±m
            </button>
          </div>
        </div>
      )}
      
      {/* Consent Popup */}
      {consentPopup.open && (
        <ConsentPopup 
          type={consentPopup.type}
          onAccept={() => {
            if (consentPopup.type === 'sharing') {
              setSettings(prev => ({ ...prev, sharingConsent: true }));
              // Process pending share if exists
              if (window.pendingShare) {
                const { image, items } = window.pendingShare;
                const newPost = {
                  id: Date.now(),
                  authorId: authUser?.uid,
                  authorName: user?.username || user?.displayName || 'KullanÄ±cÄ±',
                  authorUsername: user?.username,
                  authorAvatar: user?.profilePhoto || user?.baseAvatar || user?.avatar,
                  image: image,
                  items: items || [],
                  caption: '',
                  askFeedback: false,
                  visibility: 'public',
                  likes: [],
                  comments: [],
                  createdAt: Date.now()
                };
                setPosts(prev => [newPost, ...prev]);
                setTab('social');
                window.pendingShare = null;
              }
            } else {
              setSettings(prev => ({ ...prev, analyticsConsent: true }));
            }
            setConsentPopup({ open: false, type: null });
          }}
          onDecline={() => {
            if (consentPopup.type === 'sharing') {
              setSettings(prev => ({ ...prev, sharingConsent: false }));
            } else {
              setSettings(prev => ({ ...prev, analyticsConsent: false }));
            }
            window.pendingShare = null;
            setConsentPopup({ open: false, type: null });
          }}
          onDontShowAgain={() => {
            if (consentPopup.type === 'sharing') {
              setSettings(prev => ({ ...prev, sharingConsentDismissed: true }));
            } else {
              setSettings(prev => ({ ...prev, analyticsConsentDismissed: true }));
            }
            window.pendingShare = null;
            setConsentPopup({ open: false, type: null });
          }}
        />
      )}
      
      {/* Dijital Ä°kizini OluÅŸtur Modal */}
      {showAvatarPrompt && (
        <div className="fixed inset-0 z-[100] bg-black/85 backdrop-blur-sm flex items-center justify-center p-4">
          <div className="w-full max-w-md bg-surface rounded-3xl overflow-hidden fade-in">
            {/* Header */}
            <div className="bg-gradient-to-r from-brand to-purple-600 p-6 text-white text-center">
              <div className="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center mx-auto mb-4">
                <span className="text-4xl">âœ¨</span>
              </div>
              <h2 className="text-xl font-bold mb-2">Dijital Ä°kizini OluÅŸtur</h2>
              <p className="text-white/80 text-sm">
                KÄ±yafetleri sanal olarak denemek iÃ§in Ã¶nce dijital avatarÄ±nÄ± oluÅŸturman gerekiyor
              </p>
            </div>
            
            {/* Content */}
            <div className="p-6 space-y-4">
              <div className="bg-green-50 border border-green-200 rounded-xl p-4">
                <div className="flex items-start gap-3">
                  <span className="text-green-600 text-xl">ðŸ”’</span>
                  <div>
                    <p className="font-semibold text-green-800 text-sm">Gizlilik Garantisi</p>
                    <p className="text-green-700 text-xs mt-1">
                      OluÅŸturduÄŸun avatar ve kombinler <strong>paylaÅŸmadÄ±ÄŸÄ±n sÃ¼rece sadece sen gÃ¶rebilirsin</strong>. 
                      FotoÄŸraflarÄ±n gÃ¼vende!
                    </p>
                  </div>
                </div>
              </div>
              
              <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <div className="flex items-start gap-3">
                  <span className="text-blue-600 text-xl">ðŸ’¾</span>
                  <div>
                    <p className="font-semibold text-blue-800 text-sm">Tek Seferlik Ä°ÅŸlem</p>
                    <p className="text-blue-700 text-xs mt-1">
                      AvatarÄ±n kaydedilir, her seferinde yeniden oluÅŸturman gerekmez. 
                      Ä°stersen daha sonra Profil bÃ¶lÃ¼mÃ¼nden deÄŸiÅŸtirebilirsin.
                    </p>
                  </div>
                </div>
              </div>
              
              <button
                onClick={() => {
                  setShowAvatarPrompt(false);
                  setShowAvatarWizard(true);
                }}
                className="w-full py-4 rounded-xl font-bold bg-gradient-to-r from-brand to-purple-600 text-white shadow-lg flex items-center justify-center gap-2"
              >
                <span>âœ¨</span>
                AvatarÄ±mÄ± OluÅŸtur
              </button>
              
              <button
                onClick={() => setShowAvatarPrompt(false)}
                className="w-full py-3 rounded-xl font-semibold text-slate-500 hover:bg-slate-100 transition"
              >
                Daha Sonra
              </button>
            </div>
          </div>
        </div>
      )}
      
      <Toast toast={toast} onClose={() => setToast({ open: false })} />
    </>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
