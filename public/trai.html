<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>TrAi ‚Ä¢ Sanal Stil Asistanƒ±n</title>
  
  <!-- Security: Content Security Policy - Tightened -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com https://www.gstatic.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: blob: https:;
    connect-src 'self' https://generativelanguage.googleapis.com https://firestore.googleapis.com https://*.firebaseio.com https://firebasestorage.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com wss://*.firebaseio.com;
    frame-src 'none';
    object-src 'none';
    base-uri 'self';
  ">
  
  <!-- Security: Prevent MIME sniffing -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  
  <!-- Security: Referrer Policy - No referrer to external sites -->
  <meta name="referrer" content="no-referrer">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#6d28d9',
            brand2: '#8b5cf6',
            accent: '#f59e0b',
            dark: '#0b0b14'
          }
        }
      }
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body,#root{height:100%;height:100dvh;margin:0;padding:0}
    body{
      font-family:'Inter',sans-serif;
      background:
        radial-gradient(1100px 800px at 18% 10%, rgba(139,92,246,.20), transparent 60%),
        radial-gradient(900px 650px at 85% 20%, rgba(245,158,11,.14), transparent 60%),
        linear-gradient(135deg,#0b0b14 0%,#101126 52%,#0b0b14 100%);
      color:#fff;overflow:hidden;-webkit-font-smoothing:antialiased
    }
    .safe-bottom{padding-bottom:env(safe-area-inset-bottom,0)}
    .safe-top{padding-top:env(safe-area-inset-top,0)}
    .glass{background:rgba(17,24,39,.62);backdrop-filter:blur(18px);border:1px solid rgba(255,255,255,.10)}
    .glass-dark{background:rgba(8,8,16,.86);backdrop-filter:blur(18px);border:1px solid rgba(255,255,255,.06)}
    .btn-primary{
      background:linear-gradient(135deg,#6d28d9 0%,#8b5cf6 45%,#4f46e5 100%);
      transition:all .22s;
      box-shadow:0 16px 40px rgba(109,40,217,.22)
    }
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 20px 50px rgba(109,40,217,.30)}
    .btn-primary:active{transform:scale(0.98)}
    .btn-ghost{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);transition:all .18s}
    .btn-ghost:hover{background:rgba(255,255,255,.12)}
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .custom-scroll::-webkit-scrollbar{width:4px}
    .custom-scroll::-webkit-scrollbar-track{background:rgba(255,255,255,.05)}
    .custom-scroll::-webkit-scrollbar-thumb{background:rgba(139,92,246,.55);border-radius:6px}
    input,select,textarea{
      background:rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.16);
      color:#fff;padding:14px;border-radius:14px;font-size:15px;transition:all .2s;width:100%
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,.18)}
    select option{background:#101126;color:#fff}
    .fade-in{animation:fadeIn .22s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .slide-up{animation:slideUp .33s ease-out}
    @keyframes slideUp{from{opacity:0;transform:translateY(100%)}to{opacity:1;transform:translateY(0)}}
    .product-card{transition:all .24s}
    .product-card:hover{transform:translateY(-3px)}
    .badge{background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.14)}
    .ring-pulse{animation:ringPulse 1.25s infinite}
    @keyframes ringPulse{0%{transform:scale(.78);opacity:.9}100%{transform:scale(1.8);opacity:0}}
    .shadow-soft{box-shadow:0 20px 60px rgba(0,0,0,.45)}
    .safe-bottom{padding-bottom:env(safe-area-inset-bottom,0)}
    .safe-top{padding-top:env(safe-area-inset-top,0)}
    .bg-gradient-premium{background:radial-gradient(ellipse 1000px 800px at 50% 0%,rgba(109,40,217,.15),transparent 50%),radial-gradient(ellipse 800px 600px at 100% 50%,rgba(245,158,11,.08),transparent 50%),linear-gradient(180deg,#0b0b14 0%,#0f0f1a 50%,#0b0b14 100%)}
    .float{animation:float 3s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .btn-secondary{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);transition:all .2s}
    .btn-secondary:hover{background:rgba(255,255,255,.1)}
    .scale-in{animation:scaleIn .3s cubic-bezier(.16,1,.3,1)}
    @keyframes scaleIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
  </style>
</head>
<body>
<div id="root"></div>

<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<script type="text/babel">
const { useEffect, useMemo, useRef, useState } = React;

// ============ GLOBAL ERROR HANDLER ============
window.onerror = function(message, source, lineno, colno, error) {
  console.error('üö® GLOBAL ERROR:', message, 'at', source, lineno, colno);
  if (typeof debugLog !== 'undefined') {
    debugLog('CRASH', `${message} (line ${lineno})`, 'error');
  }
  // Prevent white screen - show alert instead
  alert('Uygulama hatasƒ±: ' + message + '\n\nSayfayƒ± yenileyin.');
  return false;
};

window.onunhandledrejection = function(event) {
  console.error('üö® UNHANDLED PROMISE:', event.reason);
  if (typeof debugLog !== 'undefined') {
    debugLog('CRASH', `Promise: ${event.reason?.message || event.reason}`, 'error');
  }
};

// ============ CONFIG ============
const CONFIG = {
  name: "TrAi",
  slogan: "Sanal Stil Asistanƒ±n",
  // Gemini API key moved to server-side for security (Vercel Environment Variables)
  imageModel: "gemini-2.0-flash-preview-image-generation",
  textModel: "gemini-2.0-flash",
  videoModel: "veo-3.0-generate-preview",
  timeoutMs: 90000,
  firebase: {
    apiKey: "AIzaSyA00c8vwyaoHBybeaS7skxmQNtb9BGZOWo",
    authDomain: "trai-fashion-1e0e6.firebaseapp.com",
    projectId: "trai-fashion-1e0e6",
    storageBucket: "trai-fashion-1e0e6.appspot.com",
    messagingSenderId: "651572736872",
    appId: "1:651572736872:web:15e8657d2507a3ffdbdcdd"
  }
};

// ============ FIREBASE INIT ============
let auth = null;
let db = null;
let storage = null;
let FIREBASE_OK = false;

try {
  firebase.initializeApp(CONFIG.firebase);
  auth = firebase.auth();
  db = firebase.firestore();
  storage = firebase.storage();
  FIREBASE_OK = true;
  // Test Firebase connection
  auth.onAuthStateChanged(() => {
    console.log('Firebase Auth connected successfully');
  });
  // Handle Google redirect result (for mobile/popup blocked cases)
  auth.getRedirectResult().then((result) => {
    if (result.user) {
      console.log('Google redirect login successful:', result.user.email);
    }
  }).catch((error) => {
    console.error('Redirect error:', error.code, error.message);
  });
} catch (e) {
  FIREBASE_OK = false;
  console.error('Firebase init error:', e);
  // Firebase initialization failed - app will work in offline mode
}

// Helper: Upload avatar to Firebase Storage
async function uploadAvatarToStorage(userId, avatarDataUrl) {
  if (!FIREBASE_OK || !storage || !avatarDataUrl) return null;
  try {
    const ref = storage.ref(`avatars/${userId}/base-avatar.png`);
    // Convert data URL to blob
    const response = await fetch(avatarDataUrl);
    const blob = await response.blob();
    // Upload
    await ref.put(blob, { contentType: 'image/png' });
    // Get download URL
    const url = await ref.getDownloadURL();
    return url;
  } catch (e) {
    return null;
  }
}

// Helper: Download avatar from Firebase Storage as data URL
async function downloadAvatarFromStorage(userId) {
  if (!FIREBASE_OK || !storage) return null;
  try {
    const ref = storage.ref(`avatars/${userId}/base-avatar.png`);
    const url = await ref.getDownloadURL();
    // Fetch and convert to data URL
    const response = await fetch(url);
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  } catch (e) {
    return null;
  }
}

// ============ ICONS ============
const Icons = {
  camera:<path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/>,
  user:<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/>,
  users:<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
  userPlus:<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></>,
  userMinus:<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/></>,
  messageCircle:<path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>,
  send:<><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
  settings:<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
  bell:<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9 M13.73 21a2 2 0 0 1-3.46 0"/>,
  info:<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>,
  layers:<><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>,
  heart:<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>,
  heartFilled:<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" fill="currentColor"/>,
  clock:<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
  trash:<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>,
  bookmark:<path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>,
  grid:<><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></>,
  list:<><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>,
  pants:<path d="M4 2h16v6l-3 14H7L4 8V2z M4 8h16"/>,
  globe:<><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></>,
  image:<><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></>,
  plusCircle:<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></>,
  moreHorizontal:<><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></>,
  upload:<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>,
  copy:<><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>,
  instagram:<><rect x="2" y="2" width="20" height="20" rx="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></>,
  facebook:<path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>,
  twitter:<path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>,
  whatsapp:<path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413z" fill="currentColor" stroke="none"/>,
  shop:<path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z M3 6h18 M16 10a4 4 0 0 1-8 0"/>,
  shirt:<path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/>,
  sparkles:<path d="M12 3l1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3z"/>,
  hanger:<><path d="M12 3a1 1 0 0 0-1 1v1.3a4 4 0 0 0-2.5 6.4L2 18v2h20v-2l-6.5-6.3A4 4 0 0 0 13 5.3V4a1 1 0 0 0-1-1z"/><circle cx="12" cy="8" r="1"/></>,
  x:<path d="M18 6L6 18 M6 6l12 12"/>,
  check:<path d="M20 6L9 17l-5-5"/>,
  chevronLeft:<path d="M15 18l-6-6 6-6"/>,
  chevronRight:<path d="M9 18l6-6-6-6"/>,
  refresh:<path d="M23 4v6h-6 M1 20v-6h6 M3.51 9a9 9 0 0 1 14.85-3.36L23 10 M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>,
  share:<path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8 M16 6l-4-4-4 4 M12 2v13"/>,
  logout:<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-5-5-5 M21 12H9"/>,
  shield:<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
  lock:<><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
  eye:<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>,
  eyeOff:<><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></>,
  mail:<><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></>,
  google:<path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="currentColor" stroke="none"/>,
  sun:<><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>,
  calendar:<><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
  mapPin:<><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>,
  video:<><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></>,
  download:<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>
};

const Icon = ({name, size=24, className=""}) => (
  <svg width={size} height={size} className={className} viewBox="0 0 24 24"
       fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
    {Icons[name]}
  </svg>
);

// ============ HELPERS ============
const sleep = ms => new Promise(r => setTimeout(r, ms));

function dataUrlToInlinePart(dataUrl, fallbackMime = "image/png") {
  if (!dataUrl || typeof dataUrl !== "string") return null;
  const m = dataUrl.match(/^data:(.*?);base64,(.*)$/);
  if (!m) return null;
  // Ensure valid MIME type - never use application/octet-stream
  let mimeType = m[1] || fallbackMime;
  if (!mimeType || mimeType === "application/octet-stream" || !mimeType.startsWith("image/")) {
    mimeType = fallbackMime;
  }
  return { inlineData: { mimeType, data: m[2] } };
}

// Allowed image hosts for product images
const ALLOWED_IMAGE_HOSTS = new Set([
  "static.zara.net",
  "cdn.dsmcdn.com",
  "img-trendyol-images.mncdn.com",
  "images.unsplash.com",
  "via.placeholder.com",
  "picsum.photos",
  "firebasestorage.googleapis.com"
]);

function isAllowedImageUrl(urlStr) {
  try {
    const url = new URL(urlStr);
    // Allow https only, check hostname against allowlist or known CDN patterns
    if (url.protocol !== "https:") return false;
    return ALLOWED_IMAGE_HOSTS.has(url.hostname) || 
           url.hostname.endsWith('.cloudinary.com') ||
           url.hostname.endsWith('.imgix.net') ||
           url.hostname.endsWith('.zara.net') ||
           url.hostname.endsWith('.dsmcdn.com') ||
           url.hostname.endsWith('.firebasestorage.app');
  } catch { 
    return false; 
  }
}

// ============ DEBUG LOG SYSTEM ============
const DEBUG_MODE = true;
const DEBUG_LOGS = [];
const MAX_DEBUG_LOGS = 50;

function debugLog(step, message, type = 'info') {
  const timestamp = new Date().toLocaleTimeString();
  const log = { timestamp, step, message, type };
  DEBUG_LOGS.unshift(log);
  if (DEBUG_LOGS.length > MAX_DEBUG_LOGS) DEBUG_LOGS.pop();
  
  // Console'a da yaz
  const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warn' ? '‚ö†Ô∏è' : 'üìç';
  console.log(`${icon} [${step}] ${message}`);
  
  // UI g√ºncelle
  if (typeof window !== 'undefined' && window.updateDebugPanel) {
    window.updateDebugPanel();
  }
}

// ============ IMAGE PROCESSING ============
const IMAGE_CACHE = {};
const MAX_IMAGE_SIZE = 800; // Max dimension for API
const IMAGE_QUALITY = 0.8;

// Resize image to max dimension
function resizeImage(img, maxSize = MAX_IMAGE_SIZE) {
  let width = img.naturalWidth || img.width;
  let height = img.naturalHeight || img.height;
  
  // K√º√ß√ºltme gerekli mi?
  if (width <= maxSize && height <= maxSize) {
    // K√º√ß√ºltme gerekmez ama yine de canvas'a √ßiz (CORS i√ßin)
    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    return canvas.toDataURL('image/jpeg', IMAGE_QUALITY);
  }
  
  // Oran koruyarak k√º√ß√ºlt
  if (width > height) {
    height = Math.round(height * maxSize / width);
    width = maxSize;
  } else {
    width = Math.round(width * maxSize / height);
    height = maxSize;
  }
  
  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, width, height);
  
  debugLog('Resize', `${img.naturalWidth}x${img.naturalHeight} ‚Üí ${width}x${height}`, 'info');
  return canvas.toDataURL('image/jpeg', IMAGE_QUALITY);
}

// Load and cache image with CORS support
async function loadImageWithCORS(imageUrl, timeout = 15000) {
  // Cache check
  if (IMAGE_CACHE[imageUrl]) {
    debugLog('Cache', 'G√∂rsel cache\'den alƒ±ndƒ±', 'success');
    return IMAGE_CACHE[imageUrl];
  }
  
  debugLog('Load', `Y√ºkleniyor: ${imageUrl.substring(0, 50)}...`, 'info');
  
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    
    const timer = setTimeout(() => {
      debugLog('Load', 'Timeout - g√∂rsel y√ºklenemedi', 'error');
      resolve(null);
    }, timeout);
    
    img.onload = () => {
      clearTimeout(timer);
      try {
        const dataUrl = resizeImage(img, MAX_IMAGE_SIZE);
        const sizeKB = Math.round(dataUrl.length / 1024);
        debugLog('Load', `Ba≈üarƒ±lƒ±: ${sizeKB}KB`, 'success');
        IMAGE_CACHE[imageUrl] = dataUrl;
        resolve(dataUrl);
      } catch (e) {
        debugLog('Load', `Canvas hatasƒ±: ${e.message}`, 'error');
        resolve(null);
      }
    };
    
    img.onerror = () => {
      clearTimeout(timer);
      debugLog('Load', 'CORS veya network hatasƒ±', 'error');
      resolve(null);
    };
    
    img.src = imageUrl;
  });
}

// Preload all product images
async function preloadAllProductImages() {
  const products = typeof MODO_PRODUCTS !== 'undefined' ? MODO_PRODUCTS : [];
  debugLog('Preload', `${products.length} √ºr√ºn g√∂rseli y√ºkleniyor...`, 'info');
  
  let loaded = 0;
  for (const product of products) {
    if (product.image && !IMAGE_CACHE[product.image]) {
      const result = await loadImageWithCORS(product.image);
      if (result) loaded++;
      await new Promise(r => setTimeout(r, 50));
    }
  }
  debugLog('Preload', `${loaded}/${products.length} g√∂rsel y√ºklendi`, 'success');
}

// Start preloading
if (typeof window !== 'undefined') {
  window.addEventListener('load', () => {
    setTimeout(preloadAllProductImages, 1500);
  });
}

// Main function to get product image
async function getProductImageDataUrl(imageUrl) {
  debugLog('GetImage', '√úr√ºn g√∂rseli istendi', 'info');
  
  // 1. Cache
  if (IMAGE_CACHE[imageUrl]) {
    debugLog('GetImage', 'Cache\'den alƒ±ndƒ±', 'success');
    return IMAGE_CACHE[imageUrl];
  }
  
  // 2. Load with CORS
  const result = await loadImageWithCORS(imageUrl);
  if (result) {
    return result;
  }
  
  // 3. Fallback: fetch as blob
  debugLog('GetImage', 'Fetch ile deneniyor...', 'warn');
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000);
    
    const res = await fetch(imageUrl, { 
      mode: 'cors',
      signal: controller.signal
    });
    clearTimeout(timeout);
    
    if (res.ok) {
      const blob = await res.blob();
      debugLog('GetImage', `Blob alƒ±ndƒ±: ${Math.round(blob.size/1024)}KB`, 'info');
      
      // Blob'u image'a √ßevir ve resize et
      const img = await new Promise((resolve, reject) => {
        const image = new Image();
        image.onload = () => resolve(image);
        image.onerror = reject;
        image.src = URL.createObjectURL(blob);
      });
      
      const dataUrl = resizeImage(img, MAX_IMAGE_SIZE);
      URL.revokeObjectURL(img.src);
      IMAGE_CACHE[imageUrl] = dataUrl;
      debugLog('GetImage', 'Fetch ba≈üarƒ±lƒ±', 'success');
      return dataUrl;
    }
  } catch (e) {
    debugLog('GetImage', `Fetch hatasƒ±: ${e.message}`, 'error');
  }
  
  debugLog('GetImage', 'T√ºm y√∂ntemler ba≈üarƒ±sƒ±z', 'error');
  return null;
}

// Compress result image from API (reduce size for React state)
async function compressResultImage(dataUrl, maxSize = 1024, quality = 0.85) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      try {
        let width = img.naturalWidth;
        let height = img.naturalHeight;
        
        // K√º√ß√ºltme gerekiyorsa
        if (width > maxSize || height > maxSize) {
          if (width > height) {
            height = Math.round(height * maxSize / width);
            width = maxSize;
          } else {
            width = Math.round(width * maxSize / height);
            height = maxSize;
          }
        }
        
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        const compressed = canvas.toDataURL('image/jpeg', quality);
        resolve(compressed);
      } catch (e) {
        reject(e);
      }
    };
    img.onerror = () => reject(new Error('Image load failed'));
    img.src = dataUrl;
  });
}

// Safe image display in new tab (no document.write with user data)
function openImageInNewTabSafe(dataUrl) {
  // Security: Only allow data:image/* URLs
  if (typeof dataUrl !== "string" || !dataUrl.startsWith("data:image/")) {
    return false;
  }

  const w = window.open("about:blank", "_blank", "noopener,noreferrer");
  if (!w) return false;

  const doc = w.document;
  doc.open();
  doc.write("<!doctype html><html><head><meta charset='utf-8'><title>TrAi</title></head><body></body></html>");
  doc.close();

  // Safe: DOM API + attribute set (no HTML injection)
  doc.body.style.cssText = "margin:0;background:#0b0b14;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:16px";

  const img = doc.createElement("img");
  img.src = dataUrl;  // Safe: dataUrl is validated above
  img.style.cssText = "max-width:100%;border-radius:18px;box-shadow:0 20px 70px rgba(0,0,0,.6)";
  doc.body.appendChild(img);

  return true;
}

async function shareImage(dataUrl) {
  // Validate dataUrl format
  if (typeof dataUrl !== "string" || !dataUrl.startsWith("data:image/")) {
    return false;
  }
  
  try {
    if (navigator.share) {
      const res = await fetch(dataUrl);
      const blob = await res.blob();
      const file = new File([blob], `trai-${Date.now()}.png`, { type: "image/png" });
      await navigator.share({ title: "TrAi", text: "TrAi ile olu≈üturuldu ‚ú®", files: [file] });
      return true;
    }
  } catch {}
  
  // Fallback: Open in new tab safely
  return openImageInNewTabSafe(dataUrl);
}

function safeJsonParse(x, fallback) {
  try { return JSON.parse(x); } catch { return fallback; }
}

// ============ ULTRA-POWERFUL AI SERVICE ============
const AI = {
  async callGenerateContent({ model, parts, imageConfig, timeoutMs = CONFIG.timeoutMs }) {
    debugLog('API', `Model: ${model}, Parts: ${parts.length}, Timeout: ${timeoutMs/1000}s`, 'info');
    
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), timeoutMs);

    // Build generation config for image generation
    const generationConfig = {
      responseModalities: ["TEXT", "IMAGE"]
    };

    // Safety settings - relaxed for fashion/clothing content
    const safetySettings = [
      { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
      { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
      { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
      { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
    ];

    const body = {
      contents: [{ parts }],
      generationConfig,
      safetySettings
    };

    const startTime = Date.now();
    
    try {
      debugLog('API', 'ƒ∞stek g√∂nderiliyor...', 'info');
      
      // Use server-side proxy to protect API key
      const res = await fetch('/api/gemini', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ model, ...body }),
        signal: ctrl.signal
      });

      const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
      debugLog('API', `Yanƒ±t alƒ±ndƒ±: ${elapsed}s, Status: ${res.status}`, res.ok ? 'success' : 'error');
      
      const data = await res.json().catch(() => {
        debugLog('API', 'JSON parse hatasƒ±', 'error');
        return {};
      });
      
      if (!res.ok || data?.error) {
        const errMsg = data?.error?.message || `HTTP ${res.status}`;
        debugLog('API', `Hata: ${errMsg}`, 'error');
        // Model bulunamadƒ± hatasƒ±
        if (errMsg.includes('not found') || errMsg.includes('404')) {
          throw new Error("Model bulunamadƒ±. API yapƒ±landƒ±rmasƒ±nƒ± kontrol edin.");
        }
        // API key hatasƒ±
        if (errMsg.includes('API key') || res.status === 401 || res.status === 403) {
          throw new Error("API anahtarƒ± ge√ßersiz veya yetkisiz.");
        }
        // Quota/Rate limit hatasƒ±
        if (errMsg.includes('quota') || errMsg.includes('rate') || res.status === 429) {
          throw new Error("API limiti a≈üƒ±ldƒ±. 30 saniye bekleyip tekrar dene.");
        }
        // Resource exhausted
        if (errMsg.includes('RESOURCE_EXHAUSTED') || errMsg.includes('exhausted')) {
          throw new Error("Sunucu yoƒüun. Biraz bekleyip tekrar dene.");
        }
        throw new Error(errMsg);
      }

      // Check for blocked content or empty response
      if (data?.candidates?.[0]?.finishReason === 'SAFETY') {
        debugLog('API', 'G√ºvenlik filtresi', 'error');
        throw new Error("ƒ∞√ßerik g√ºvenlik filtresine takƒ±ldƒ±");
      }
      
      if (data?.candidates?.[0]?.finishReason === 'RECITATION') {
        debugLog('API', 'ƒ∞√ßerik kƒ±sƒ±tlamasƒ±', 'error');
        throw new Error("ƒ∞√ßerik kƒ±sƒ±tlamasƒ±. Farklƒ± bir fotoƒüraf deneyin.");
      }
      
      if (!data?.candidates?.length) {
        debugLog('API', 'Bo≈ü yanƒ±t', 'error');
        throw new Error("API yanƒ±t vermedi - model me≈ügul olabilir");
      }

      // Yanƒ±tta g√∂rsel var mƒ± kontrol et
      for (const c of (data?.candidates || [])) {
        for (const p of (c?.content?.parts || [])) {
          if (p.inlineData?.data) {
            // Ensure valid image MIME type
            let mimeType = p.inlineData.mimeType || "image/png";
            if (!mimeType.startsWith("image/") || mimeType === "application/octet-stream") {
              mimeType = "image/png";
            }
            const rawSize = Math.round(p.inlineData.data.length / 1024);
            debugLog('API', `Ham g√∂rsel: ${rawSize}KB`, 'info');
            
            // G√∂rseli k√º√ß√ºlt (b√ºy√ºkse)
            const rawDataUrl = `data:${mimeType};base64,${p.inlineData.data}`;
            
            if (rawSize > 300) {
              debugLog('API', 'G√∂rsel sƒ±kƒ±≈ütƒ±rƒ±lƒ±yor...', 'info');
              try {
                const compressed = await compressResultImage(rawDataUrl);
                const compressedSize = Math.round(compressed.length / 1024);
                debugLog('API', `Sƒ±kƒ±≈ütƒ±rƒ±ldƒ±: ${rawSize}KB ‚Üí ${compressedSize}KB`, 'success');
                return compressed;
              } catch (compErr) {
                debugLog('API', `Sƒ±kƒ±≈ütƒ±rma hatasƒ±: ${compErr.message}`, 'warn');
                return rawDataUrl; // Fallback to original
              }
            }
            
            debugLog('API', `G√∂rsel alƒ±ndƒ±: ${rawSize}KB`, 'success');
            return rawDataUrl;
          }
        }
      }

      // If we got here, there's text but no image
      const textResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (textResponse) {
        debugLog('API', `G√∂rsel yok, metin d√∂nd√º: ${textResponse.substring(0, 100)}...`, 'warn');
        throw new Error("Model g√∂rsel √ºretemedi. Farklƒ± fotoƒüraflar deneyin.");
      }

      debugLog('API', 'G√∂rsel alƒ±namadƒ±', 'error');
      throw new Error("G√∂rsel alƒ±namadƒ±");
    } catch (e) {
      if (e.name === "AbortError") {
        debugLog('API', 'Zaman a≈üƒ±mƒ±', 'error');
        throw new Error("ƒ∞stek zaman a≈üƒ±mƒ±na uƒüradƒ± (" + (timeoutMs/1000) + "s)");
      }
      throw e;
    } finally {
      clearTimeout(timer);
    }
  },

  async generateWithFallback(parts, imageConfig) {
    let lastError;
    const maxAttempts = 2; // 3'ten 2'ye d√º≈ü√ºrd√ºk - daha hƒ±zlƒ± sonu√ß
    
    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
      try {
        const result = await this.callGenerateContent({ 
          model: CONFIG.imageModel, 
          parts, 
          imageConfig,
          timeoutMs: CONFIG.timeoutMs
        });
        
        // Sonu√ß ge√ßerli mi kontrol et
        if (result && result.startsWith('data:image')) {
          return result;
        }
        throw new Error("Ge√ßersiz g√∂rsel formatƒ±");
      } catch (e) {
        lastError = e;
        
        // Son deneme deƒüilse ve timeout/network hatasƒ± deƒüilse bekle
        if (attempt < maxAttempts) {
          const isRetryable = !e.message.includes('zaman a≈üƒ±mƒ±') && 
                             !e.message.includes('g√ºvenlik filtresine');
          if (isRetryable) {
            await sleep(1500); // Sabit 1.5 saniye bekle
            continue;
          }
        }
        break; // Retry yapƒ±lmayacak hatalar i√ßin d√∂ng√ºden √ßƒ±k
      }
    }
    
    // Kullanƒ±cƒ± dostu hata mesajlarƒ±
    const errorMsg = lastError?.message || 'Bilinmeyen hata';
    if (errorMsg.includes('zaman a≈üƒ±mƒ±')) {
      throw new Error('ƒ∞≈ülem √ßok uzun s√ºrd√º. L√ºtfen tekrar dene.');
    }
    if (errorMsg.includes('g√ºvenlik filtresine')) {
      throw new Error('G√∂rsel olu≈üturulamadƒ±. Farklƒ± bir √ºr√ºn dene.');
    }
    if (errorMsg.includes('me≈ügul')) {
      throw new Error('Sistem yoƒüun. Biraz bekleyip tekrar dene.');
    }
    throw new Error('G√∂rsel olu≈üturulamadƒ±. Tekrar dene.');
  },

  async generateBaseAvatar(params, photoDataUrls) {
    const gender = params.gender === "female" ? "woman" : "man";
    
    const bodyTypeDesc = {
      slim: "slim",
      athletic: "athletic",
      average: "average",
      curvy: "curvy",
      plus: "plus-size"
    }[params.bodyType] || "average";

    // Gemini 3 i√ßin kƒ±sa ve net prompt
    const prompt = `Create a full-body fashion photo of this exact person from the reference photo(s).

Person: ${gender}, ${params.age} years old, ${params.height}cm, ${bodyTypeDesc} build.
Outfit: White t-shirt, black pants, white sneakers.
Style: Standing pose, white background, fashion catalog quality.

Keep the exact same face, features, and identity from the reference.`;

    const parts = [{ text: prompt }];
    for (const p of photoDataUrls) {
      const inline = dataUrlToInlinePart(p, "image/jpeg");
      if (inline) parts.push(inline);
    }

    return await this.generateWithFallback(parts, null);
  },

  async tryOnSingle(baseAvatarDataUrl, item, backgroundValue) {
    debugLog('TryOn', `Tek √ºr√ºn: ${item.name}`, 'info');
    
    if (!baseAvatarDataUrl || !baseAvatarDataUrl.startsWith('data:image')) {
      debugLog('TryOn', 'Avatar ge√ßersiz', 'error');
      throw new Error("Ge√ßersiz avatar formatƒ±");
    }
    
    const avatarSize = Math.round(baseAvatarDataUrl.length / 1024);
    debugLog('TryOn', `Avatar: ${avatarSize}KB`, 'info');
    
    const avatarInline = dataUrlToInlinePart(baseAvatarDataUrl, "image/png");
    if (!avatarInline) {
      debugLog('TryOn', 'Avatar inline d√∂n√º≈üt√ºr√ºlemedi', 'error');
      throw new Error("Avatar g√∂rseli okunamadƒ±");
    }

    // √úr√ºn g√∂rselini al
    debugLog('TryOn', '√úr√ºn g√∂rseli y√ºkleniyor...', 'info');
    const itemDataUrl = await getProductImageDataUrl(item.image);
    if (!itemDataUrl) {
      debugLog('TryOn', '√úr√ºn g√∂rseli alƒ±namadƒ±', 'error');
      throw new Error("√úr√ºn g√∂rseli y√ºklenemedi. Sayfayƒ± yenileyip tekrar deneyin.");
    }
    
    const itemSize = Math.round(itemDataUrl.length / 1024);
    debugLog('TryOn', `√úr√ºn g√∂rseli: ${itemSize}KB`, 'success');
    
    const itemInline = dataUrlToInlinePart(itemDataUrl, "image/jpeg");
    if (!itemInline) {
      debugLog('TryOn', '√úr√ºn inline d√∂n√º≈üt√ºr√ºlemedi', 'error');
      throw new Error("√úr√ºn g√∂rseli i≈ülenemedi");
    }

    const isTop = item.category === 'top';
    const isOuterwear = item.category === 'outerwear';
    
    // Gemini 3 i√ßin kƒ±sa ve net prompt
    const action = isOuterwear ? 'Add this jacket/coat over their outfit' : 
                   isTop ? 'Replace their top with this' : 'Replace their bottom with this';
    
    const prompt = `Virtual try-on: Put the clothing from IMAGE 2 on the person from IMAGE 1.

${action}: ${item.color} ${item.type}.

Keep the exact same face and identity. Full body, white background, fashion photo style.`;

    const parts = [{ text: prompt }, avatarInline, itemInline];
    return await this.generateWithFallback(parts, null);
  },

  async tryOnCombo(baseAvatarDataUrl, items, backgroundValue) {
    if (!baseAvatarDataUrl || !baseAvatarDataUrl.startsWith('data:image')) {
      throw new Error("Ge√ßersiz avatar formatƒ±");
    }

    const top = items.find(i => i.category === "top");
    const bottom = items.find(i => i.category === "bottom");

    // Tek √ºr√ºn varsa tryOnSingle kullan
    if (items.length === 1) {
      return await this.tryOnSingle(baseAvatarDataUrl, items[0], backgroundValue);
    }

    const avatarInline = dataUrlToInlinePart(baseAvatarDataUrl, "image/png");
    if (!avatarInline) throw new Error("Avatar g√∂rseli okunamadƒ±");

    // √úr√ºn g√∂rsellerini al
    let topInline = null, bottomInline = null;
    
    if (top) {
      const topDataUrl = await getProductImageDataUrl(top.image);
      if (topDataUrl) {
        topInline = dataUrlToInlinePart(topDataUrl, "image/jpeg");
      }
    }
    
    if (bottom) {
      const bottomDataUrl = await getProductImageDataUrl(bottom.image);
      if (bottomDataUrl) {
        bottomInline = dataUrlToInlinePart(bottomDataUrl, "image/jpeg");
      }
    }

    // En az bir g√∂rsel gerekli
    if (!topInline && !bottomInline) {
      throw new Error("√úr√ºn g√∂rselleri y√ºklenemedi. Sayfayƒ± yenileyip tekrar deneyin.");
    }

    let prompt;
    const parts = [{ text: '' }, avatarInline];
    
    // Gemini 3 i√ßin kƒ±sa ve net prompt'lar
    if (topInline && bottomInline) {
      parts.push(topInline, bottomInline);
      prompt = `Virtual try-on: Dress the person from IMAGE 1 in the complete outfit.

Top: ${top.color} ${top.type} (IMAGE 2)
Bottom: ${bottom.color} ${bottom.type} (IMAGE 3)

Keep exact same face. Full body, white background, fashion photo.`;
    } else if (topInline) {
      parts.push(topInline);
      prompt = `Virtual try-on: Put the ${top.color} ${top.type} from IMAGE 2 on the person from IMAGE 1.

Add matching dark pants. Keep exact same face. Full body, white background.`;
    } else {
      parts.push(bottomInline);
      prompt = `Virtual try-on: Put the ${bottom.color} ${bottom.type} from IMAGE 2 on the person from IMAGE 1.

Add matching white top. Keep exact same face. Full body, white background.`;
    }

    parts[0] = { text: prompt };
    return await this.generateWithFallback(parts, null);
  },

  async getStyleAdvice(item, user) {
    const gender = user.gender === "female" ? "Kadƒ±n" : "Erkek";
    const prompt = `Sen d√ºnyaca √ºnl√º bir moda stilistisin. ${gender} m√º≈üteri i√ßin "${item.name}" (${item.brandName}, ${item.type}) √ºr√ºn√º hakkƒ±nda profesyonel stil tavsiyesi ver.

≈ûunlarƒ± i√ßeren KISA ve ETKƒ∞Lƒ∞ tavsiye yaz:
1. Bu par√ßayƒ± kimler giyebilir?
2. Hangi par√ßalarla kombinlenir? (2-3 somut √∂neri)
3. Hangi ortamlarda giyilir?
4. Sezon √∂nerisi

Maximum 100 kelime, samimi ve profesyonel T√ºrk√ße.`;

    try {
      const res = await fetch('/api/gemini', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ model: CONFIG.textModel, contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await res.json();
      return data?.candidates?.[0]?.content?.parts?.[0]?.text || "Tavsiye alƒ±namadƒ±.";
    } catch {
      return "Tavsiye alƒ±namadƒ±.";
    }
  },

  // T√ºm kategorileri destekleyen genel try-on fonksiyonu
  // G√∂rsel yerine metin a√ßƒ±klamasƒ± kullanƒ±r - CORS sorununu bypass eder
  async tryOnOutfit(baseAvatarDataUrl, items, backgroundValue) {
    if (!baseAvatarDataUrl || !baseAvatarDataUrl.startsWith('data:image')) {
      throw new Error("Ge√ßersiz avatar formatƒ±");
    }
    
    const avatarInline = dataUrlToInlinePart(baseAvatarDataUrl, "image/png");
    if (!avatarInline) throw new Error("Avatar g√∂rseli okunamadƒ±");

    // Kategorilere ayƒ±r
    const fullbody = items.find(i => i.category === 'fullbody');
    const outerwear = items.find(i => i.category === 'outerwear');
    const top = items.find(i => i.category === 'top');
    const bottom = items.find(i => i.category === 'bottom');

    // Detaylƒ± kƒ±yafet a√ßƒ±klamalarƒ± olu≈ütur
    const getClothingDescription = (item) => {
      if (!item) return '';
      return `${item.color} colored ${item.type} (${item.description || item.name})`;
    };

    // Prompt olu≈ütur - sadece metin a√ßƒ±klamasƒ± ile
    let clothingInstructions = '';
    
    if (fullbody) {
      clothingInstructions = getClothingDescription(fullbody);
      if (outerwear) {
        clothingInstructions += `, with ${getClothingDescription(outerwear)} on top`;
      }
    } else {
      const topDesc = top ? getClothingDescription(top) : 'white t-shirt';
      const bottomDesc = bottom ? getClothingDescription(bottom) : 'black pants';
      clothingInstructions = `${topDesc} and ${bottomDesc}`;
      
      if (outerwear) {
        clothingInstructions += `, with ${getClothingDescription(outerwear)}`;
      }
    }

    // Gemini 3 i√ßin kƒ±sa ve net prompt
    const prompt = `Virtual try-on: Dress the person from the reference image in: ${clothingInstructions}.

Keep exact same face. Full body, white background, fashion photo.`;

    const parts = [{ text: prompt }, avatarInline];
    return await this.generateWithFallback(parts, null);
  },

  // G√ºnl√ºk kombin √∂nerisi - Kullanƒ±cƒ±nƒ±n dolabƒ±ndaki √ºr√ºnlerden
  async getDailyRecommendation(closet, weather, occasion, userGender) {
    if (!closet || closet.length === 0) return null;

    // Kategorilere ayƒ±r
    const tops = closet.filter(i => i.category === 'top');
    const bottoms = closet.filter(i => i.category === 'bottom');
    const outerwears = closet.filter(i => i.category === 'outerwear');
    const fullbodies = closet.filter(i => i.category === 'fullbody');

    // Dolap i√ßeriƒüini metin olarak hazƒ±rla
    const closetDescription = [
      tops.length > 0 ? `√úst giyim: ${tops.map(i => `${i.color} ${i.type}`).join(', ')}` : '',
      bottoms.length > 0 ? `Alt giyim: ${bottoms.map(i => `${i.color} ${i.type}`).join(', ')}` : '',
      outerwears.length > 0 ? `Dƒ±≈ü giyim: ${outerwears.map(i => `${i.color} ${i.type}`).join(', ')}` : '',
      fullbodies.length > 0 ? `Elbise/Tulum: ${fullbodies.map(i => `${i.color} ${i.type}`).join(', ')}` : ''
    ].filter(Boolean).join('\n');

    // Hava durumu ve etkinlik bilgisi
    const weatherInfo = weather 
      ? `Hava: ${weather.temp}¬∞C, ${weather.text}` 
      : '';
    const occasionInfo = occasion 
      ? `Etkinlik: ${occasion.name} (${occasion.suggestion})` 
      : '';

    const prompt = `Sen bir moda stilistisin. Kullanƒ±cƒ±nƒ±n dolabƒ±ndaki kƒ±yafetlerden bug√ºn i√ßin kombin √∂ner.

DOLAP ƒ∞√áERƒ∞ƒûƒ∞:
${closetDescription}

${weatherInfo}
${occasionInfo}
Cinsiyet: ${userGender === 'female' ? 'Kadƒ±n' : 'Erkek'}

G√ñREV:
1. Yukarƒ±daki kƒ±yafetlerden SADECE mevcut olanlarƒ± kullanarak bir kombin √∂ner
2. Hava durumuna uygun se√ßim yap
3. Varsa etkinliƒüe uygun ol

CEVAP FORMATI (JSON):
{
  "combo": {
    "top": "se√ßilen √ºst giyim adƒ± veya null",
    "bottom": "se√ßilen alt giyim adƒ± veya null",
    "outerwear": "se√ßilen dƒ±≈ü giyim adƒ± veya null",
    "fullbody": "se√ßilen elbise adƒ± veya null"
  },
  "reason": "Kƒ±sa √∂neri a√ßƒ±klamasƒ± (max 50 kelime)",
  "tip": "G√ºn√ºn stil ipucu (max 20 kelime)"
}

SADECE JSON d√∂nd√ºr, ba≈üka bir ≈üey yazma.`;

    try {
      const res = await fetch('/api/gemini', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ model: CONFIG.textModel, contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await res.json();
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
      
      // JSON parse et
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const result = JSON.parse(jsonMatch[0]);
        
        // √ñnerilen √ºr√ºnleri bul
        const recommended = {
          top: result.combo.top ? tops.find(i => i.type.toLowerCase().includes(result.combo.top.toLowerCase()) || result.combo.top.toLowerCase().includes(i.type.toLowerCase()) || i.name.toLowerCase().includes(result.combo.top.toLowerCase())) : null,
          bottom: result.combo.bottom ? bottoms.find(i => i.type.toLowerCase().includes(result.combo.bottom.toLowerCase()) || result.combo.bottom.toLowerCase().includes(i.type.toLowerCase()) || i.name.toLowerCase().includes(result.combo.bottom.toLowerCase())) : null,
          outerwear: result.combo.outerwear ? outerwears.find(i => i.type.toLowerCase().includes(result.combo.outerwear.toLowerCase()) || result.combo.outerwear.toLowerCase().includes(i.type.toLowerCase()) || i.name.toLowerCase().includes(result.combo.outerwear.toLowerCase())) : null,
          fullbody: result.combo.fullbody ? fullbodies.find(i => i.type.toLowerCase().includes(result.combo.fullbody.toLowerCase()) || result.combo.fullbody.toLowerCase().includes(i.type.toLowerCase()) || i.name.toLowerCase().includes(result.combo.fullbody.toLowerCase())) : null
        };
        
        return {
          items: recommended,
          reason: result.reason || '',
          tip: result.tip || ''
        };
      }
    } catch (e) {
      // Hata durumunda basit √∂neri
    }
    
    // Fallback: Rastgele se√ßim
    return {
      items: {
        top: tops[Math.floor(Math.random() * tops.length)] || null,
        bottom: bottoms[Math.floor(Math.random() * bottoms.length)] || null,
        outerwear: weather && weather.temp < 15 ? outerwears[0] : null,
        fullbody: null
      },
      reason: 'Bug√ºn i√ßin rahat bir kombin √∂neriyoruz.',
      tip: 'Kendini iyi hisset! ‚ú®'
    };
  },

  // Video Try-On Generation using Veo 3.0
  async generateVideoTryOn(baseAvatarDataUrl, items, userParams = {}) {
    if (!baseAvatarDataUrl || !baseAvatarDataUrl.startsWith('data:image')) {
      throw new Error("Ge√ßersiz avatar formatƒ±");
    }
    
    debugLog('VIDEO', `Video olu≈üturma ba≈ülƒ±yor - ${items.length} par√ßa`, 'info');

    // Build detailed clothing description
    const clothingParts = items.map(item => {
      const material = item.material ? ` made of ${item.material}` : '';
      return `${item.color} ${item.type}${material} (${item.description || item.name})`;
    }).join(', ');

    // Build user physical description for consistency
    const userDesc = [];
    if (userParams.gender) userDesc.push(userParams.gender === 'male' ? 'male' : 'female');
    if (userParams.age) userDesc.push(`approximately ${userParams.age} years old`);
    if (userParams.height) userDesc.push(`${userParams.height}cm tall`);
    if (userParams.bodyType) userDesc.push(`${userParams.bodyType} body type`);
    if (userParams.skinTone) userDesc.push(`${userParams.skinTone} skin tone`);
    if (userParams.hairColor) userDesc.push(`${userParams.hairColor} hair`);
    if (userParams.hairStyle) userDesc.push(`${userParams.hairStyle} hairstyle`);

    // Strong prompt for video generation - preserves identity and makes clothes realistic
    const prompt = `Create a stunning 6-second cinematic fashion showcase video.

CRITICAL IDENTITY PRESERVATION:
- The person in this video must be EXACTLY the same person shown in the reference image
- Preserve with 100% accuracy: face shape, facial features, eyes, nose, lips, eyebrows, skin tone, complexion
- Maintain exact hair color, hair style, hair length, hair texture throughout the video
- Keep body proportions, height, build, and physique identical to reference
${userDesc.length > 0 ? `- Physical details: ${userDesc.join(', ')}` : ''}

OUTFIT TO WEAR:
${clothingParts}

CLOTHING REQUIREMENTS:
- Clothes must look photorealistic with accurate fabric textures
- Natural draping, proper fit based on body measurements
- Realistic wrinkles and folds in fabric
- Clothing should move naturally with body movement
- Colors must be accurate and consistent

VIDEO SEQUENCE:
1. (0-1s) Person stands confidently, slight smile, soft lighting
2. (1-3s) Graceful 360-degree turn to showcase outfit from all angles
3. (3-5s) Natural walking motion, 2-3 elegant steps forward
4. (5-6s) Final pose facing camera, confident expression

PRODUCTION QUALITY:
- Professional fashion advertisement cinematography
- Soft, flattering studio lighting
- Clean neutral background (light gray or white)
- Smooth camera tracking following subject
- 4K quality, cinematic color grading
- 24fps smooth motion

OUTPUT: 6 seconds, MP4 format, high quality fashion video`;

    try {
      const res = await fetch('/api/gemini', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: CONFIG.videoModel,
          contents: [{
            parts: [
              { text: prompt },
              {
                inlineData: {
                  mimeType: "image/png",
                  data: baseAvatarDataUrl.split(',')[1]
                }
              }
            ]
          }],
          generationConfig: {
            responseModalities: ["VIDEO"]
          }
        })
      });

      const data = await res.json();
      
      if (!res.ok || data?.error) {
        const errMsg = data?.error?.message || 'Video olu≈üturulamadƒ±';
        debugLog('VIDEO', `API Hatasƒ±: ${errMsg}`, 'error');
        throw new Error(errMsg);
      }

      // Extract video from response
      for (const c of (data?.candidates || [])) {
        for (const p of (c?.content?.parts || [])) {
          if (p.inlineData?.data) {
            const mimeType = p.inlineData.mimeType || 'video/mp4';
            if (mimeType.startsWith('video/')) {
              debugLog('VIDEO', 'Video ba≈üarƒ±yla olu≈üturuldu', 'success');
              return `data:${mimeType};base64,${p.inlineData.data}`;
            }
          }
          // Check for video file URI
          if (p.fileData?.fileUri) {
            debugLog('VIDEO', 'Video URI alƒ±ndƒ±', 'success');
            return p.fileData.fileUri;
          }
        }
      }

      throw new Error("Video yanƒ±tta bulunamadƒ±");
    } catch (e) {
      debugLog('VIDEO', `Hata: ${e.message}`, 'error');
      throw e;
    }
  }
};

// ============ PRODUCT CATALOG ============
const BRANDS = [
  { id: 'modo', name: 'MODO', featured: true },
  { id: 'zara', name: 'ZARA' },
  { id: 'hm', name: 'H&M' },
  { id: 'mango', name: 'MANGO' },
  { id: 'massimo', name: 'MASSIMO DUTTI' },
  { id: 'cos', name: 'COS' }
];

// MODO Demo Products - ImgBB Hosted Images (CORS-free)
const MODO_PRODUCTS = [
  // ===================== ERKEK √úST Gƒ∞Yƒ∞M (4) =====================
  {
    id: 1,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Beyaz Basic T-shirt',
    type: 'T-shirt',
    color: 'Beyaz',
    category: 'top',
    gender: 'male',
    price: '299 TL',
    priceNum: 299,
    image: 'https://i.ibb.co/SDVQ7nM4/Beyaz-Basic-T-shirt-Regular-fit-pamuklu-jpg.webp',
    description: 'Regular fit, pamuklu'
  },
  {
    id: 2,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Siyah Slim Fit G√∂mlek',
    type: 'G√∂mlek',
    color: 'Siyah',
    category: 'top',
    gender: 'male',
    price: '549 TL',
    priceNum: 549,
    image: 'https://i.ibb.co/hFq5SB0m/Siyah-Slim-Fit-G-mlek-Poplin-kuma.webp',
    description: 'Poplin kuma≈ü'
  },
  {
    id: 3,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Lacivert V-Yaka Triko',
    type: 'Kazak',
    color: 'Lacivert',
    category: 'top',
    gender: 'male',
    price: '649 TL',
    priceNum: 649,
    image: 'https://i.ibb.co/Kx6P2wjs/Lacivert-V-Yaka-Triko-nce-rg-kazak-jpg.webp',
    description: 'ƒ∞nce √∂rg√º kazak'
  },
  {
    id: 4,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Gri Oversize Sweatshirt',
    type: 'Sweatshirt',
    color: 'Gri',
    category: 'top',
    gender: 'male',
    price: '599 TL',
    priceNum: 599,
    image: 'https://i.ibb.co/kVqhCHFX/Gri-Oversize-Sweatshirt-Kap-onsuz-jpg.webp',
    description: 'Kap√º≈üonsuz'
  },
  // ===================== ERKEK ALT Gƒ∞Yƒ∞M (3) =====================
  {
    id: 5,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Siyah Slim Fit Kuma≈ü Pantolon',
    type: 'Pantolon',
    color: 'Siyah',
    category: 'bottom',
    gender: 'male',
    price: '699 TL',
    priceNum: 699,
    image: 'https://i.ibb.co/0yFTyBX9/Siyah-Slim-Fit-Kuma-Pantolon-Klasik-kesim-jpg.webp',
    description: 'Klasik kesim'
  },
  {
    id: 6,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Koyu Mavi Slim Jean',
    type: 'Jean',
    color: 'Mavi',
    category: 'bottom',
    gender: 'male',
    price: '599 TL',
    priceNum: 599,
    image: 'https://i.ibb.co/zVnJhyZ4/Koyu-Mavi-Slim-Jean-Denim-jpg.webp',
    description: 'Denim'
  },
  {
    id: 7,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Bej Chino Pantolon',
    type: 'Pantolon',
    color: 'Bej',
    category: 'bottom',
    gender: 'male',
    price: '549 TL',
    priceNum: 549,
    image: 'https://i.ibb.co/ymJRyY3y/Bej-Chino-Pantolon-Regular-fit-jpg.webp',
    description: 'Regular fit'
  },
  // ===================== ERKEK DI≈û Gƒ∞Yƒ∞M (3) =====================
  {
    id: 8,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Siyah Blazer Ceket',
    type: 'Blazer',
    color: 'Siyah',
    category: 'outerwear',
    gender: 'male',
    price: '1.299 TL',
    priceNum: 1299,
    image: 'https://i.ibb.co/nqT1ZkTs/Siyah-Blazer-Ceket-regular-fit-jpg.webp',
    description: 'Regular fit'
  },
  {
    id: 9,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Lacivert Bomber Mont',
    type: 'Mont',
    color: 'Lacivert',
    category: 'outerwear',
    gender: 'male',
    price: '1.199 TL',
    priceNum: 1199,
    image: 'https://i.ibb.co/TMMx8zR4/Lacivert-Bomber-Mont-Su-ge-irmez-jpg.webp',
    description: 'Su ge√ßirmez'
  },
  {
    id: 10,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Kahverengi Deri Ceket',
    type: 'Ceket',
    color: 'Kahverengi',
    category: 'outerwear',
    gender: 'male',
    price: '2.499 TL',
    priceNum: 2499,
    image: 'https://i.ibb.co/5hSb7nGd/Kahverengi-Deri-Ceket-Biker-model-jpg.webp',
    description: 'Biker model'
  },
  // ===================== KADIN √úST Gƒ∞Yƒ∞M (4) =====================
  {
    id: 11,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Beyaz Crop Top',
    type: 'T-shirt',
    color: 'Beyaz',
    category: 'top',
    gender: 'female',
    price: '249 TL',
    priceNum: 249,
    image: 'https://i.ibb.co/nqksypmR/Beyaz-Crop-Top-K-sa-kesim-ti-rt-jpg.webp',
    description: 'Kƒ±sa kesim ti≈ü√∂rt'
  },
  {
    id: 12,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Siyah Saten Bluz',
    type: 'Bluz',
    color: 'Siyah',
    category: 'top',
    gender: 'female',
    price: '599 TL',
    priceNum: 599,
    image: 'https://i.ibb.co/tpLPdtJd/Siyah-Saten-Bluz-V-yaka-jpg.webp',
    description: 'V yaka'
  },
  {
    id: 13,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Pembe √ñrme Hƒ±rka',
    type: 'Hƒ±rka',
    color: 'Pembe',
    category: 'top',
    gender: 'female',
    price: '699 TL',
    priceNum: 699,
    image: 'https://i.ibb.co/1t9yNrcN/Pembe-rme-H-rka-D-meli-jpg.webp',
    description: 'D√ºƒümeli'
  },
  {
    id: 14,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Bordo Boƒüazlƒ± Kazak',
    type: 'Kazak',
    color: 'Bordo',
    category: 'top',
    gender: 'female',
    price: '749 TL',
    priceNum: 749,
    image: 'https://i.ibb.co/2YfHzv8H/Bordo-Bo-azl-Kazak-Y-n-kar-m-jpg.webp',
    description: 'Y√ºn karƒ±≈üƒ±m'
  },
  // ===================== KADIN ALT Gƒ∞Yƒ∞M (3) =====================
  {
    id: 15,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Siyah Y√ºksek Bel Pantolon',
    type: 'Pantolon',
    color: 'Siyah',
    category: 'bottom',
    gender: 'female',
    price: '699 TL',
    priceNum: 699,
    image: 'https://i.ibb.co/5gn9tjZ8/Siyah-Y-ksek-Bel-Pantolon-Cigarette-fit-jpg.webp',
    description: 'Cigarette fit'
  },
  {
    id: 16,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Mavi Mom Jean',
    type: 'Jean',
    color: 'Mavi',
    category: 'bottom',
    gender: 'female',
    price: '649 TL',
    priceNum: 649,
    image: 'https://i.ibb.co/39KnrzLB/Mavi-Mom-Jean-Vintage-y-kama-jpg.webp',
    description: 'Vintage yƒ±kama'
  },
  {
    id: 17,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Bej Wide Leg Pantolon',
    type: 'Pantolon',
    color: 'Bej',
    category: 'bottom',
    gender: 'female',
    price: '749 TL',
    priceNum: 749,
    image: 'https://i.ibb.co/WWFxY3bR/Bej-Wide-Leg-Pantolon-Bol-pa-a-jpg.webp',
    description: 'Bol pa√ßa'
  },
  // ===================== KADIN DI≈û Gƒ∞Yƒ∞M (3) =====================
  {
    id: 18,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Siyah Uzun Palto',
    type: 'Palto',
    color: 'Siyah',
    category: 'outerwear',
    gender: 'female',
    price: '1.899 TL',
    priceNum: 1899,
    image: 'https://i.ibb.co/pjhz9tj2/Siyah-Uzun-Palto-Oversize-kesim-jpg.webp',
    description: 'Oversize kesim'
  },
  {
    id: 19,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Bej Tren√ßkot',
    type: 'Tren√ßkot',
    color: 'Bej',
    category: 'outerwear',
    gender: 'female',
    price: '1.699 TL',
    priceNum: 1699,
    image: 'https://i.ibb.co/vCxKrLg8/Bej-Tren-kot-Klasik-ku-akl-jpg.avif',
    description: 'Klasik, ku≈üaklƒ±'
  },
  {
    id: 20,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Beyaz Puffer Mont',
    type: 'Mont',
    color: 'Beyaz',
    category: 'outerwear',
    gender: 'female',
    price: '1.499 TL',
    priceNum: 1499,
    image: 'https://i.ibb.co/PZM8jNt2/Beyaz-Puffer-Mont-i-me-mont-jpg.webp',
    description: '≈ûi≈üme mont'
  },
  // ===================== UNƒ∞SEX √úST Gƒ∞Yƒ∞M (2) =====================
  {
    id: 21,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Siyah Hoodie',
    type: 'Sweatshirt',
    color: 'Siyah',
    category: 'top',
    gender: 'unisex',
    price: '649 TL',
    priceNum: 649,
    image: 'https://i.ibb.co/YBj0CfYL/Siyah-Hoodie-Kap-onlu-sweatshirt-jpg.webp',
    description: 'Kap√º≈üonlu sweatshirt'
  },
  {
    id: 22,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Sarƒ± Oversize T-shirt',
    type: 'T-shirt',
    color: 'Sarƒ±',
    category: 'top',
    gender: 'unisex',
    price: '349 TL',
    priceNum: 349,
    image: 'https://i.ibb.co/9m6qQP8D/Sar-Oversize-T-shirt-Geni-kesim-jpg.webp',
    description: 'Geni≈ü kesim'
  },
  // ===================== UNƒ∞SEX ALT Gƒ∞Yƒ∞M (2) =====================
  {
    id: 23,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Siyah Jogger E≈üofman Altƒ±',
    type: 'E≈üofman',
    color: 'Siyah',
    category: 'bottom',
    gender: 'unisex',
    price: '449 TL',
    priceNum: 449,
    image: 'https://i.ibb.co/w8w7HCd/Siyah-Jogger-E-ofman-Alt-Pa-as-lastikli-jpg.webp',
    description: 'Pa√ßasƒ± lastikli'
  },
  {
    id: 24,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Gri Sweatpant',
    type: 'E≈üofman',
    color: 'Gri',
    category: 'bottom',
    gender: 'unisex',
    price: '399 TL',
    priceNum: 399,
    image: 'https://i.ibb.co/svJqLDPL/Gri-Sweatpant-Rahat-kesim-jpg.webp',
    description: 'Rahat kesim'
  },
  // ===================== UNƒ∞SEX DI≈û Gƒ∞Yƒ∞M (1) =====================
  {
    id: 25,
    brandId: 'modo',
    brandName: 'MODO',
    name: 'Haki Ye≈üil Parka',
    type: 'Parka',
    color: 'Ye≈üil',
    category: 'outerwear',
    gender: 'unisex',
    price: '1.399 TL',
    priceNum: 1399,
    image: 'https://i.ibb.co/20x7gPT4/Haki-Ye-il-Parka-Kap-onlu-uzun-jpg.webp',
    description: 'Kap√º≈üonlu, uzun'
  }
];


const ALL_PRODUCTS = MODO_PRODUCTS;

const BACKGROUNDS = [
  { id: 'studio', name: 'St√ºdyo', value: 'Clean white professional photography studio with seamless backdrop' },
  { id: 'street', name: 'Sokak', value: 'Fashionable European city street with elegant architecture, shallow depth of field' },
  { id: 'office', name: 'Ofis', value: 'Modern minimalist corporate office with large windows and natural light' },
  { id: 'cafe', name: 'Kafe', value: 'Trendy hipster cafe interior with warm ambient lighting' },
  { id: 'park', name: 'Park', value: 'Beautiful green park with golden hour sunlight filtering through trees' },
  { id: 'beach', name: 'Plaj', value: 'Stunning beach at sunset with soft warm lighting' }
];

// ============ UI COMPONENTS ============
const Logo = () => (
  <div className="flex items-center gap-3">
    <div className="w-11 h-11 rounded-2xl bg-gradient-to-br from-brand to-brand2 flex items-center justify-center shadow-soft">
      <span className="text-xl">‚ú®</span>
    </div>
    <div>
      <div className="text-lg font-black tracking-tight">{CONFIG.name}</div>
      <div className="text-xs text-white/60">{CONFIG.slogan}</div>
    </div>
  </div>
);

const Toast = ({ toast, onClose }) => {
  // Auto-close after 2 seconds
  useEffect(() => {
    if (toast?.open) {
      const timer = setTimeout(() => {
        onClose();
      }, 2000);
      return () => clearTimeout(timer);
    }
  }, [toast?.open, onClose]);

  if (!toast?.open) return null;
  return (
    <div className="fixed z-[100] left-0 right-0 top-4 px-4 fade-in">
      <div className="max-w-md mx-auto glass rounded-2xl p-3 flex items-center gap-3">
        <div className={`w-8 h-8 rounded-xl flex items-center justify-center ${toast.type === 'error' ? 'bg-red-500/20' : 'bg-green-500/20'}`}>
          <Icon name={toast.type === 'error' ? 'x' : 'check'} size={16} className={toast.type === 'error' ? 'text-red-400' : 'text-green-400'} />
        </div>
        <div className="flex-1">
          <div className="font-bold text-sm">{toast.title || (toast.type === 'error' ? 'Hata' : 'Ba≈üarƒ±lƒ±')}</div>
          <div className="text-xs text-white/70">{toast.message}</div>
        </div>
        <button onClick={onClose} className="p-1.5 rounded-lg hover:bg-white/10"><Icon name="x" size={16} /></button>
      </div>
    </div>
  );
};

// ============ DEBUG PANEL ============
const DebugPanel = () => {
  const [logs, setLogs] = useState([]);
  const [isOpen, setIsOpen] = useState(false);
  
  useEffect(() => {
    // Update logs periodically
    const interval = setInterval(() => {
      if (typeof DEBUG_LOGS !== 'undefined') {
        setLogs([...DEBUG_LOGS]);
      }
    }, 500);
    
    // Register global update function
    if (typeof window !== 'undefined') {
      window.updateDebugPanel = () => setLogs([...DEBUG_LOGS]);
    }
    
    return () => clearInterval(interval);
  }, []);
  
  if (!DEBUG_MODE) return null;
  
  return (
    <>
      {/* Toggle Button */}
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="fixed bottom-20 right-4 z-[90] w-10 h-10 rounded-full bg-yellow-500 text-black font-bold flex items-center justify-center shadow-lg"
      >
        üêõ
      </button>
      
      {/* Debug Panel */}
      {isOpen && (
        <div className="fixed bottom-32 right-4 left-4 z-[90] max-w-md ml-auto glass rounded-2xl overflow-hidden">
          <div className="bg-yellow-500/20 px-4 py-2 flex items-center justify-between">
            <span className="font-bold text-yellow-400 text-sm">üîç Debug Logs</span>
            <button onClick={() => setIsOpen(false)} className="text-white/60">‚úï</button>
          </div>
          <div className="max-h-48 overflow-y-auto p-2 space-y-1 text-xs font-mono">
            {logs.length === 0 ? (
              <div className="text-white/40 text-center py-4">Hen√ºz log yok</div>
            ) : (
              logs.map((log, i) => (
                <div key={i} className={`px-2 py-1 rounded ${
                  log.type === 'error' ? 'bg-red-500/20 text-red-300' :
                  log.type === 'success' ? 'bg-green-500/20 text-green-300' :
                  log.type === 'warn' ? 'bg-yellow-500/20 text-yellow-300' :
                  'bg-white/5 text-white/70'
                }`}>
                  <span className="text-white/40">{log.timestamp}</span>
                  <span className="text-white/60 mx-1">|</span>
                  <span className="font-semibold">{log.step}</span>
                  <span className="text-white/60 mx-1">‚Üí</span>
                  <span>{log.message}</span>
                </div>
              ))
            )}
          </div>
        </div>
      )}
    </>
  );
};

const FullscreenLoader = ({ title, subtitle, onCancel, showProgress = true }) => {
  const [elapsed, setElapsed] = useState(0);
  
  useEffect(() => {
    if (!showProgress) return;
    const interval = setInterval(() => {
      setElapsed(e => e + 1);
    }, 1000);
    return () => clearInterval(interval);
  }, [showProgress]);
  
  const progressMessages = [
    "AI modeli y√ºkleniyor...",
    "G√∂rsel i≈üleniyor...",
    "Avatar analiz ediliyor...",
    "Kƒ±yafet yerle≈ütiriliyor...",
    "Detaylar ekleniyor...",
    "Son r√∂tu≈ülar yapƒ±lƒ±yor..."
  ];
  
  const currentMessage = progressMessages[Math.min(Math.floor(elapsed / 8), progressMessages.length - 1)];
  
  return (
    <div className="fixed inset-0 z-[90] bg-black/80 backdrop-blur flex items-center justify-center p-6">
      <div className="w-full max-w-sm glass-dark rounded-3xl p-6 text-center fade-in shadow-soft">
        <div className="relative w-20 h-20 mx-auto mb-4">
          <div className="absolute inset-0 rounded-full bg-gradient-to-r from-brand to-accent opacity-25 ring-pulse" />
          <div className="relative w-full h-full rounded-full bg-gradient-to-br from-brand to-brand2 flex items-center justify-center">
            <span className="text-3xl">‚ú®</span>
          </div>
        </div>
        <div className="text-lg font-black">{title}</div>
        <div className="text-sm text-white/70 mt-1">{subtitle}</div>
        {showProgress && (
          <div className="mt-3">
            <div className="text-xs text-white/50">{currentMessage}</div>
            <div className="text-[10px] text-white/30 mt-1">{elapsed} saniye</div>
          </div>
        )}
        {onCancel && <button onClick={onCancel} className="mt-4 btn-ghost px-6 py-2 rounded-xl text-sm font-bold">ƒ∞ptal</button>}
      </div>
    </div>
  );
};

// ============ TERMS OF USE ============
const TERMS = {
  updated: "25 Aralƒ±k 2025",
  sections: [
    { title: "1. Giri≈ü", content: `TrAi Technologies olarak, TrAi uygulamasƒ±nƒ±n kullanƒ±mƒ±nƒ± d√ºzenleyen bu Kullanƒ±m Ko≈üullarƒ±'nƒ± kabul etmenizi rica ediyoruz. Bu Uygulamayƒ± kullanarak, bu Ko≈üullarƒ± ve Gizlilik Politikamƒ±zƒ± okuduƒüunuzu, anladƒ±ƒüƒ±nƒ±zƒ± ve kabul ettiƒüinizi beyan edersiniz.` },
    { title: "2. Hizmet Tanƒ±mƒ±", content: `TrAi, yapay zeka teknolojisi kullanarak sanal giysi deneme hizmeti sunan bir platformdur.\n\nHizmetlerimiz:\n‚Ä¢ Dijital Avatar Olu≈üturma\n‚Ä¢ Sanal Kƒ±yafet Deneme\n‚Ä¢ AI Stil √ñnerileri\n‚Ä¢ Dijital Dolap Y√∂netimi` },
    { title: "3. Hesap G√ºvenliƒüi", content: `Hesap olu≈ütururken doƒüru ve g√ºncel bilgiler saƒülamayƒ± kabul edersiniz. Hesap bilgilerinizin gizliliƒüinden siz sorumlusunuz. 18 ya≈üƒ±ndan k√º√ß√ºkseniz, ebeveyn veya vasi onayƒ± gereklidir.` },
    { title: "4. Gizlilik ve Veri Koruma", content: `Toplanan Veriler:\n‚Ä¢ Hesap bilgileri (e-posta)\n‚Ä¢ Y√ºz fotoƒüraflarƒ± (avatar olu≈üturma i√ßin)\n‚Ä¢ Fiziksel √∂zellikler (boy, kilo, v√ºcut tipi)\n‚Ä¢ Olu≈üturulan avatar ve deneme g√∂rselleri\n‚Ä¢ Kullanƒ±m verileri\n\n√ñNEMLƒ∞: Fotoƒüraflarƒ±nƒ±z avatar olu≈üturmak i√ßin Google Gemini AI hizmetine g√∂nderilmektedir. Bu i≈ülem i√ßin a√ßƒ±k rƒ±zanƒ±z gerekmektedir.\n\nVerileriniz pazarlama amacƒ±yla √º√ß√ºnc√º taraflarla payla≈üƒ±lmaz.` },
    { title: "5. √ú√ß√ºnc√º Taraf Hizmetler", content: `Uygulamamƒ±z a≈üaƒüƒ±daki √º√ß√ºnc√º taraf hizmetleri kullanmaktadƒ±r:\n\n‚Ä¢ Google Gemini AI: Avatar ve giysi deneme g√∂rsellerinin olu≈üturulmasƒ± i√ßin fotoƒüraflarƒ±nƒ±z i≈ülenir.\n‚Ä¢ Firebase (Google): Kimlik doƒürulama ve veri depolama.\n\nBu hizmetlerin gizlilik politikalarƒ± i√ßin ilgili platformlarƒ±n web sitelerini ziyaret ediniz.` },
    { title: "6. KVKK Haklarƒ±", content: `6698 sayƒ±lƒ± KVKK kapsamƒ±nda haklarƒ±nƒ±z:\n\n‚Ä¢ Verilerinizin i≈ülenip i≈ülenmediƒüini √∂ƒürenme\n‚Ä¢ ƒ∞≈ülenme amacƒ±nƒ± √∂ƒürenme\n‚Ä¢ Aktarƒ±ldƒ±ƒüƒ± √º√ß√ºnc√º ki≈üileri bilme\n‚Ä¢ D√ºzeltme ve silme talep etme\n‚Ä¢ ƒ∞tiraz etme hakkƒ±\n‚Ä¢ Zararƒ±n giderilmesini talep etme\n\nKVKK ba≈üvurularƒ±: kvkk@trai.app` },
    { title: "7. Fotoƒüraf ƒ∞≈üleme ve Saklama", content: `‚Ä¢ Y√ºklediƒüiniz fotoƒüraflar yalnƒ±zca avatar olu≈üturma amacƒ±yla kullanƒ±lƒ±r.\n‚Ä¢ Fotoƒüraflar Google Gemini AI'a i≈ülenmek √ºzere g√∂nderilir.\n‚Ä¢ Olu≈üturulan avatarlar hesabƒ±nƒ±zda saklanƒ±r.\n‚Ä¢ Hesap silme talebinde t√ºm verileriniz (avatar dahil) kalƒ±cƒ± olarak silinir.\n‚Ä¢ T√ºm veri iletimi 256-bit TLS ile ≈üifrelenir.` },
    { title: "8. Veri Saklama S√ºresi", content: `‚Ä¢ Avatar ve deneme g√∂rselleri: Hesap aktif olduƒüu s√ºrece\n‚Ä¢ Hesap bilgileri: Hesap silinene kadar\n‚Ä¢ Orijinal fotoƒüraflar: ƒ∞≈ülem sonrasƒ± cihazƒ±nƒ±zda kalƒ±r, sunucularƒ±mƒ±zda saklanmaz\n\nHesabƒ±nƒ±zƒ± sildiƒüinizde t√ºm verileriniz 30 g√ºn i√ßinde kalƒ±cƒ± olarak silinir.` },
    { title: "9. Fikri M√ºlkiyet", content: `TrAi uygulamasƒ± ve i√ßeriƒüinin t√ºm haklarƒ± TrAi Technologies'e aittir. Olu≈üturduƒüunuz g√∂rseller √ºzerinde ki≈üisel kullanƒ±m hakkƒ±na sahipsiniz.` },
    { title: "10. Sorumluluk", content: `Hizmet "olduƒüu gibi" sunulmaktadƒ±r. Kesintisiz veya hatasƒ±z √ßalƒ±≈ümayƒ± garanti etmeyiz. AI sonu√ßlarƒ±nƒ±n %100 doƒüru olacaƒüƒ±nƒ± garanti etmeyiz.` },
    { title: "11. ƒ∞leti≈üim", content: `TrAi Technologies\ndestek@trai.app\nkvkk@trai.app` }
  ]
};

const TermsModal = ({ isOpen, onClose, onAccept }) => {
  const [scrolled, setScrolled] = useState(false);
  const ref = useRef(null);
  const onScroll = () => { const el = ref.current; if (el && el.scrollHeight - el.scrollTop <= el.clientHeight + 50) setScrolled(true); };
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[100] bg-black/85 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="w-full max-w-xl max-h-[85vh] bg-surface rounded-3xl overflow-hidden flex flex-col border border-white/10 fade-in">
        <div className="p-5 border-b border-white/10 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-brand/20 flex items-center justify-center"><Icon name="shield" size={20} className="text-brand2" /></div>
            <div><h2 className="font-bold">Kullanƒ±m Ko≈üullarƒ±</h2><p className="text-xs text-white/40">Son g√ºncelleme: {TERMS.updated}</p></div>
          </div>
          <button onClick={onClose} className="p-2 rounded-xl hover:bg-white/10"><Icon name="x" size={20} /></button>
        </div>
        <div ref={ref} onScroll={onScroll} className="flex-1 overflow-y-auto custom-scroll p-5 space-y-4">
          {TERMS.sections.map((s, i) => (<div key={i}><h3 className="text-sm font-bold text-brand2 mb-1">{s.title}</h3><p className="text-sm text-white/60 leading-relaxed whitespace-pre-line">{s.content}</p></div>))}
          <div className="glass rounded-2xl p-4 flex items-start gap-3 border border-brand/20"><Icon name="shield" size={18} className="text-brand2 flex-shrink-0 mt-0.5" /><p className="text-xs text-white/50">Ki≈üisel verileriniz 6698 sayƒ±lƒ± KVKK kapsamƒ±nda korunmaktadƒ±r. kvkk@trai.app</p></div>
        </div>
        <div className="p-5 border-t border-white/10 space-y-3">
          {!scrolled && <p className="text-xs text-white/30 text-center">L√ºtfen a≈üaƒüƒ± kaydƒ±rarak t√ºm ko≈üullarƒ± okuyun</p>}
          <div className="flex gap-3">
            <button onClick={onClose} className="flex-1 btn-ghost py-3 rounded-xl font-semibold text-sm">Vazge√ß</button>
            <button onClick={onAccept} disabled={!scrolled} className="flex-1 btn-primary py-3 rounded-xl font-semibold text-sm disabled:opacity-40">Kabul Ediyorum</button>
          </div>
        </div>
      </div>
    </div>
  );
};

// ============ AUTH SCREEN ============
const AuthScreen = ({ onAuthed, setToast }) => {
  const [mode, setMode] = useState('welcome');
  const [email, setEmail] = useState('');
  const [pass, setPass] = useState('');
  const [showPass, setShowPass] = useState(false);
  const [termsOk, setTermsOk] = useState(false);
  const [showTerms, setShowTerms] = useState(false);
  const [busy, setBusy] = useState(false);

  useEffect(() => {
    if (auth) auth.onAuthStateChanged(u => { if (u) onAuthed({ uid: u.uid, email: u.email }); });
    if (localStorage.getItem('trai_terms_v1')) setTermsOk(true);
  }, []);

  const acceptTerms = () => { setTermsOk(true); localStorage.setItem('trai_terms_v1', '1'); setShowTerms(false); };

  const submit = async () => {
    if (!auth) return setToast({ open: true, type: 'error', title: 'Baƒülantƒ± Hatasƒ±', message: 'Firebase baƒülantƒ±sƒ± kurulamadƒ±. Sayfayƒ± yenileyin.' });
    if (!email || !pass) return setToast({ open: true, type: 'error', title: 'Eksik', message: 'E-posta ve ≈üifre gerekli' });
    if (!termsOk) return setToast({ open: true, type: 'error', title: 'Ko≈üullar', message: 'Kullanƒ±m ko≈üullarƒ±nƒ± kabul edin' });
    setBusy(true);
    try {
      const c = mode === 'login' ? await auth.signInWithEmailAndPassword(email, pass) : await auth.createUserWithEmailAndPassword(email, pass);
      onAuthed({ uid: c.user.uid, email: c.user.email });
      setToast({ open: true, type: 'success', title: 'Ho≈ü geldin!', message: 'Giri≈ü ba≈üarƒ±lƒ±' });
    } catch (e) {
      let m = e.message;
      if (e.code === 'auth/invalid-credential') m = 'E-posta veya ≈üifre hatalƒ±';
      if (e.code === 'auth/email-already-in-use') m = 'Bu e-posta zaten kayƒ±tlƒ±';
      if (e.code === 'auth/weak-password') m = '≈ûifre en az 6 karakter olmalƒ±';
      if (e.code === 'auth/invalid-email') m = 'Ge√ßersiz e-posta adresi';
      if (e.code === 'auth/user-not-found') m = 'Bu e-posta ile kayƒ±tlƒ± hesap bulunamadƒ±';
      if (e.code === 'auth/wrong-password') m = '≈ûifre hatalƒ±';
      if (e.code === 'auth/too-many-requests') m = '√áok fazla deneme. L√ºtfen bekleyin.';
      if (e.code === 'auth/network-request-failed') m = 'Sunucuya baƒülanƒ±lamƒ±yor. VPN kullanƒ±yorsanƒ±z kapatmayƒ± deneyin veya sayfayƒ± yenileyin.';
      if (e.code === 'auth/internal-error') m = 'Sunucu hatasƒ±. L√ºtfen tekrar deneyin.';
      console.error('Auth error:', e.code, e.message);
      setToast({ open: true, type: 'error', title: 'Hata', message: m });
    }
    setBusy(false);
  };

  const googleLogin = async () => {
    if (!auth) return setToast({ open: true, type: 'error', title: 'Baƒülantƒ± Hatasƒ±', message: 'Firebase baƒülantƒ±sƒ± kurulamadƒ±. Sayfayƒ± yenileyin.' });
    if (!termsOk) return setToast({ open: true, type: 'error', title: 'Ko≈üullar', message: 'Kullanƒ±m ko≈üullarƒ±nƒ± kabul edin' });
    setBusy(true);
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      
      // Try popup first, fallback to redirect on mobile/blocked
      let result;
      try {
        result = await auth.signInWithPopup(provider);
      } catch (popupError) {
        // If popup blocked or failed on mobile, try redirect
        if (popupError.code === 'auth/popup-blocked' || popupError.code === 'auth/popup-closed-by-user' || /mobile|android|iphone|ipad/i.test(navigator.userAgent)) {
          await auth.signInWithRedirect(provider);
          return; // Will complete after redirect
        }
        throw popupError;
      }
      
      onAuthed({ uid: result.user.uid, email: result.user.email });
      setToast({ open: true, type: 'success', title: 'Ho≈ü geldin!', message: 'Google ile giri≈ü ba≈üarƒ±lƒ±' });
    } catch (e) { 
      let m = e.message;
      if (e.code === 'auth/popup-closed-by-user') m = 'Giri≈ü penceresi kapatƒ±ldƒ±';
      if (e.code === 'auth/popup-blocked') m = 'Popup engellendi. Tekrar deneyin.';
      if (e.code === 'auth/network-request-failed') m = 'Sunucuya baƒülanƒ±lamƒ±yor. VPN kullanƒ±yorsanƒ±z kapatmayƒ± deneyin.';
      if (e.code === 'auth/cancelled-popup-request') m = 'Birden fazla popup isteƒüi. Tekrar deneyin.';
      if (e.code === 'auth/operation-not-allowed') m = 'Google giri≈üi aktif deƒüil. Y√∂neticiye ba≈üvurun.';
      console.error('Google auth error:', e.code, e.message);
      setToast({ open: true, type: 'error', title: 'Hata', message: m }); 
    }
    setBusy(false);
  };

  if (mode === 'welcome') {
    return (
      <div className="h-full bg-gradient-premium flex flex-col">
        <div className="flex-1 flex flex-col items-center justify-center p-8 text-center">
          <div className="mb-8 float"><div className="w-20 h-20 rounded-3xl bg-gradient-to-br from-brand to-brand2 flex items-center justify-center shadow-lg shadow-brand/30"><span className="text-4xl">‚ú®</span></div></div>
          <h1 className="text-4xl font-black tracking-tight mb-2">{CONFIG.name}</h1>
          <p className="text-lg text-white/60 mb-4">{CONFIG.slogan}</p>
          <div className="flex gap-6 mt-8 mb-12">
            {[{ icon: 'user', label: 'Dijital ƒ∞kiz' }, { icon: 'shirt', label: 'Sanal Deneme' }, { icon: 'sparkles', label: 'AI Stilist' }].map((f, i) => (
              <div key={i} className="text-center fade-in" style={{ animationDelay: `${i * 0.1}s` }}><div className="w-12 h-12 rounded-2xl glass flex items-center justify-center mx-auto mb-2"><Icon name={f.icon} size={20} className="text-brand2" /></div><span className="text-xs text-white/50">{f.label}</span></div>
            ))}
          </div>
          <div className="flex items-center gap-4 text-white/40 text-xs"><div className="flex items-center gap-1"><Icon name="shield" size={14} /><span>KVKK Uyumlu</span></div><div className="w-1 h-1 rounded-full bg-white/20" /><div className="flex items-center gap-1"><Icon name="lock" size={14} /><span>256-bit SSL</span></div></div>
        </div>
        <div className="p-6 space-y-3 safe-bottom">
          <button onClick={() => setMode('register')} className="w-full btn-primary py-4 rounded-2xl font-bold flex items-center justify-center gap-2">√úcretsiz Ba≈üla<Icon name="chevronRight" size={20} /></button>
          <button onClick={() => setMode('login')} className="w-full btn-ghost py-4 rounded-2xl font-semibold text-sm">Zaten hesabƒ±m var</button>
        </div>
      </div>
    );
  }

  return (
    <div className="h-full bg-gradient-premium flex flex-col">
      <div className="p-6 safe-top"><button onClick={() => setMode('welcome')} className="p-2 -ml-2 rounded-xl hover:bg-white/10"><Icon name="chevronLeft" size={24} /></button></div>
      <div className="flex-1 px-6 overflow-y-auto custom-scroll">
        <div className="flex justify-center mb-6"><div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-brand to-brand2 flex items-center justify-center"><span className="text-2xl">‚ú®</span></div></div>
        <h1 className="text-2xl font-bold text-center mb-1">{mode === 'login' ? 'Tekrar Ho≈ü Geldin' : 'Hesap Olu≈ütur'}</h1>
        <p className="text-sm text-white/50 text-center mb-8">{mode === 'login' ? 'Hesabƒ±na giri≈ü yap' : 'Moda yolculuƒüuna ba≈üla'}</p>
        
        <button onClick={googleLogin} disabled={busy} className="w-full btn-secondary py-4 rounded-2xl font-semibold text-sm flex items-center justify-center gap-3 mb-6 disabled:opacity-50"><Icon name="google" size={20} />Google ile devam et</button>
        <div className="flex items-center gap-3 mb-6"><div className="flex-1 h-px bg-white/10" /><span className="text-xs text-white/40">veya</span><div className="flex-1 h-px bg-white/10" /></div>
        
        <div className="space-y-4 mb-6">
          <div><label className="text-xs text-white/50 mb-1.5 block">E-posta</label><div className="relative"><Icon name="mail" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-white/30" /><input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="ornek@mail.com" className="pl-11" /></div></div>
          <div><label className="text-xs text-white/50 mb-1.5 block">≈ûifre</label><div className="relative"><Icon name="lock" size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-white/30" /><input type={showPass ? 'text' : 'password'} value={pass} onChange={e => setPass(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" className="pl-11 pr-11" /><button type="button" onClick={() => setShowPass(!showPass)} className="absolute right-3 top-1/2 -translate-y-1/2 p-1.5"><Icon name={showPass ? 'eyeOff' : 'eye'} size={18} className="text-white/40" /></button></div></div>
        </div>
        
        <div className="flex items-start gap-3 mb-6 p-4 rounded-2xl glass">
          <input type="checkbox" checked={termsOk} onChange={e => setTermsOk(e.target.checked)} className="w-5 h-5 rounded border-2 border-white/20 bg-white/5 checked:bg-brand checked:border-brand mt-0.5 cursor-pointer accent-brand" />
          <p className="text-sm text-white/70"><button onClick={() => setShowTerms(true)} className="text-white font-medium underline underline-offset-2">Kullanƒ±m Ko≈üullarƒ±</button> ve <button onClick={() => setShowTerms(true)} className="text-white font-medium underline underline-offset-2">Gizlilik Politikasƒ±</button>'nƒ± okudum, kabul ediyorum.</p>
        </div>
        
        <button onClick={submit} disabled={busy || !termsOk} className="w-full btn-primary py-4 rounded-2xl font-bold disabled:opacity-50 mb-4">
          {busy ? <span className="flex items-center justify-center gap-2"><div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />ƒ∞≈üleniyor...</span> : (mode === 'login' ? 'Giri≈ü Yap' : 'Kayƒ±t Ol')}
        </button>
        <p className="text-center text-sm text-white/50 pb-8">{mode === 'login' ? 'Hesabƒ±n yok mu? ' : 'Zaten hesabƒ±n var mƒ±? '}<button onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-brand2 font-semibold">{mode === 'login' ? 'Kayƒ±t ol' : 'Giri≈ü yap'}</button></p>
      </div>
      <TermsModal isOpen={showTerms} onClose={() => setShowTerms(false)} onAccept={acceptTerms} />
    </div>
  );
};

// ============ AVATAR WIZARD ============
const AvatarWizard = ({ onComplete, setToast }) => {
  const [step, setStep] = useState(1);
  const [params, setParams] = useState({
    gender: 'female', age: '25', height: '170', weight: '60',
    bodyType: 'average', skinTone: 'medium', hairColor: 'brown', hairStyle: 'medium'
  });
  const [photos, setPhotos] = useState([]);
  const [status, setStatus] = useState('');
  const [busy, setBusy] = useState(false);
  const [cameraReady, setCameraReady] = useState(false);
  const [useNativeCamera, setUseNativeCamera] = useState(false);
  const fileInputRef = useRef(null);
  const videoRef = useRef(null);
  const streamRef = useRef(null);

  // Detect if mobile
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

  useEffect(() => {
    if (step === 2 && !isMobile) {
      startWebCamera();
    }
    return () => stopCamera();
  }, [step]);

  // Web camera using getUserMedia
  const startWebCamera = async () => {
    try {
      setCameraReady(false);
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });
      streamRef.current = stream;
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        videoRef.current.onloadedmetadata = () => {
          videoRef.current.play().then(() => setCameraReady(true)).catch(() => setCameraReady(true));
        };
      }
    } catch (e) {
      // Fallback to file input if camera fails
      setUseNativeCamera(true);
    }
  };

  const stopCamera = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(t => t.stop());
      streamRef.current = null;
    }
  };

  // Take photo from video stream (web)
  const takePhotoFromVideo = () => {
    const video = videoRef.current;
    if (!video) return;
    
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    const ctx = canvas.getContext('2d');
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(video, 0, 0);
    const photo = canvas.toDataURL('image/jpeg', 0.9);
    
    addPhoto(photo);
  };

  // Handle photo from file input (mobile)
  const handleFileSelect = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (ev) => addPhoto(ev.target.result);
    reader.readAsDataURL(file);
    e.target.value = '';
  };

  // Add photo and trigger generate if 3 photos
  const addPhoto = (photo) => {
    setPhotos(prev => {
      const newPhotos = [...prev, photo];
      if (newPhotos.length >= 3) {
        stopCamera();
        setTimeout(() => generate(newPhotos), 100);
      }
      return newPhotos;
    });
  };

  const openNativeCamera = () => fileInputRef.current?.click();

  const generate = async (photoArray) => {
    setBusy(true);
    setStep(3);
    setStatus('Fotoƒüraflar analiz ediliyor...');
    
    try {
      await sleep(500);
      setStatus('Y√ºz √∂zellikleri √ßƒ±karƒ±lƒ±yor...');
      await sleep(500);
      setStatus('Dijital ikiz olu≈üturuluyor...');
      
      const baseAvatar = await AI.generateBaseAvatar(params, photoArray);
      
      if (!baseAvatar) {
        throw new Error('Avatar olu≈üturulamadƒ±');
      }
      
      setStatus('Hazƒ±r! ‚ú®');
      await sleep(400);
      onComplete({ ...params, baseAvatar, createdAt: Date.now() });
      setToast({ open: true, type: 'success', title: 'Ba≈üarƒ±lƒ±', message: 'Dijital ikizin olu≈üturuldu!' });
    } catch (e) {
      // Error handled via toast, no console logging in production
      setToast({ open: true, type: 'error', title: 'Avatar hatasƒ±', message: e.message || 'Bir hata olu≈ütu' });
      setStep(1);
      setPhotos([]);
    }
    setBusy(false);
  };

  if (step === 1) {
    return (
      <div className="h-full flex flex-col overflow-y-auto custom-scroll">
        <div className="p-6 pt-8"><Logo /></div>
        <div className="px-6 pb-32">
          <div className="glass rounded-3xl p-6">
            <div className="text-center mb-6">
              <div className="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-brand to-brand2 flex items-center justify-center mb-3 shadow-soft">
                <Icon name="user" size={32} />
              </div>
              <h1 className="text-xl font-black">Dijital ƒ∞kizini Olu≈ütur</h1>
              <p className="text-sm text-white/60 mt-1">√ñzelliklerini gir, 3 fotoƒüraf √ßek</p>
            </div>
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-2">
                {['female', 'male'].map(g => (
                  <button key={g} onClick={() => setParams(p => ({ ...p, gender: g }))}
                    className={`py-3 rounded-2xl font-bold ${params.gender === g ? 'bg-white/12' : 'bg-white/6 text-white/60'}`}>
                    {g === 'female' ? 'üë© Kadƒ±n' : 'üë® Erkek'}
                  </button>
                ))}
              </div>
              <div className="grid grid-cols-3 gap-2">
                {[{ k: 'age', l: 'Ya≈ü' }, { k: 'height', l: 'Boy (cm)' }, { k: 'weight', l: 'Kilo (kg)' }].map(f => (
                  <div key={f.k}>
                    <label className="text-xs text-white/60 mb-1 block">{f.l}</label>
                    <input type="number" value={params[f.k]} onChange={e => setParams(p => ({ ...p, [f.k]: e.target.value }))} className="text-center" />
                  </div>
                ))}
              </div>
              <select value={params.bodyType} onChange={e => setParams(p => ({ ...p, bodyType: e.target.value }))}>
                <option value="slim">ƒ∞nce / Zayƒ±f</option>
                <option value="athletic">Atletik / Fit</option>
                <option value="average">Normal / Orta</option>
                <option value="curvy">Dolgun</option>
                <option value="plus">B√ºy√ºk Beden</option>
              </select>
              <select value={params.skinTone} onChange={e => setParams(p => ({ ...p, skinTone: e.target.value }))}>
                <option value="fair">√áok A√ßƒ±k Ten</option>
                <option value="light">A√ßƒ±k Ten</option>
                <option value="medium">Buƒüday Ten</option>
                <option value="olive">Zeytin Ten</option>
                <option value="tan">Bronz Ten</option>
                <option value="dark">Koyu Ten</option>
              </select>
              <div className="grid grid-cols-2 gap-2">
                <select value={params.hairColor} onChange={e => setParams(p => ({ ...p, hairColor: e.target.value }))}>
                  <option value="black">Siyah Sa√ß</option>
                  <option value="brown">Kahverengi</option>
                  <option value="blonde">Sarƒ±</option>
                  <option value="red">Kƒ±zƒ±l</option>
                  <option value="gray">Gri</option>
                </select>
                <select value={params.hairStyle} onChange={e => setParams(p => ({ ...p, hairStyle: e.target.value }))}>
                  <option value="short">Kƒ±sa</option>
                  <option value="medium">Orta</option>
                  <option value="long">Uzun</option>
                  <option value="curly">Kƒ±vƒ±rcƒ±k</option>
                  {params.gender === 'male' && <option value="bald">Kel</option>}
                </select>
              </div>
              <button onClick={() => setStep(2)} className="w-full btn-primary py-4 rounded-2xl font-bold flex items-center justify-center gap-2">
                <Icon name="camera" size={20} />Fotoƒüraf √áek
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (step === 2) {
    const labels = ['√ñn Y√ºz', 'Saƒü Profil', 'Sol Profil'];
    const showVideo = !isMobile && !useNativeCamera;
    
    return (
      <div className="fixed inset-0 bg-black flex flex-col" style={{ height: '100dvh' }}>
        {/* Hidden file input for mobile camera */}
        <input 
          ref={fileInputRef}
          type="file" 
          accept="image/*" 
          capture="user"
          onChange={handleFileSelect}
          className="hidden"
        />
        
        <div className="flex-shrink-0 p-4 flex items-center justify-between safe-top">
          <button onClick={() => { stopCamera(); setStep(1); setPhotos([]); }} className="p-2"><Icon name="chevronLeft" /></button>
          <div className="text-center">
            <div className="font-bold">{photos.length + 1}/3</div>
            <div className="text-xs text-white/60">{labels[photos.length] || 'Tamamlandƒ±'}</div>
          </div>
          <div className="w-10" />
        </div>
        
        <div className="flex-shrink-0 px-4 pb-2 flex gap-2">
          {[0, 1, 2].map(i => (
            <div key={i} className={`flex-1 h-1.5 rounded-full ${i < photos.length ? 'bg-brand2' : i === photos.length ? 'bg-accent' : 'bg-white/20'}`} />
          ))}
        </div>
        
        {/* Camera/Preview Area */}
        <div className="flex-1 relative overflow-hidden" style={{ minHeight: 0 }}>
          {showVideo ? (
            <>
              <video 
                ref={videoRef} 
                autoPlay 
                playsInline 
                muted
                className={`w-full h-full object-cover scale-x-[-1] ${cameraReady ? 'opacity-100' : 'opacity-0'}`}
              />
              {!cameraReady && (
                <div className="absolute inset-0 flex items-center justify-center bg-black">
                  <div className="text-center">
                    <div className="w-12 h-12 border-4 border-brand2 border-t-transparent rounded-full animate-spin mx-auto mb-3" />
                    <p className="text-white/60 text-sm">Kamera ba≈ülatƒ±lƒ±yor...</p>
                  </div>
                </div>
              )}
              {cameraReady && (
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                  <div className="w-48 h-64 border-2 border-dashed border-white/50 rounded-3xl" />
                </div>
              )}
            </>
          ) : (
            <div className="w-full h-full flex flex-col items-center justify-center p-6 bg-dark">
              {photos.length > 0 ? (
                <div className="grid grid-cols-3 gap-3 w-full max-w-sm mb-4">
                  {photos.map((p, i) => (
                    <div key={i} className="aspect-square rounded-2xl overflow-hidden border-2 border-brand2">
                      <img src={p} className="w-full h-full object-cover" />
                    </div>
                  ))}
                  {Array(3 - photos.length).fill(0).map((_, i) => (
                    <div key={`e-${i}`} className="aspect-square rounded-2xl border-2 border-dashed border-white/20 flex items-center justify-center">
                      <Icon name="camera" size={20} className="text-white/20" />
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center mb-6">
                  <div className="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-brand to-brand2 flex items-center justify-center mb-4">
                    <Icon name="camera" size={36} />
                  </div>
                  <h3 className="font-bold text-lg">Selfie √áek</h3>
                  <p className="text-white/50 text-sm mt-1">3 farklƒ± a√ßƒ±dan fotoƒüraf √ßekin</p>
                </div>
              )}
              <div className="glass rounded-xl p-3 max-w-sm w-full">
                <div className="flex items-center gap-3 text-sm">
                  <div className="w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center">
                    <span className="text-accent font-bold">{photos.length + 1}</span>
                  </div>
                  <div>
                    <div className="font-semibold">{labels[photos.length]}</div>
                    <div className="text-white/50 text-xs">
                      {photos.length === 0 && "D√ºz bakƒ±n"}
                      {photos.length === 1 && "Saƒüa d√∂n√ºn"}
                      {photos.length === 2 && "Sola d√∂n√ºn"}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Photo thumbnails for video mode */}
        {showVideo && photos.length > 0 && (
          <div className="flex-shrink-0 px-4 py-2 flex gap-2 justify-center">
            {photos.map((p, i) => (
              <div key={i} className="w-12 h-12 rounded-lg overflow-hidden border-2 border-brand2">
                <img src={p} className="w-full h-full object-cover" />
              </div>
            ))}
          </div>
        )}
        
        <div className="flex-shrink-0 p-4 safe-bottom">
          <button 
            onClick={showVideo ? takePhotoFromVideo : openNativeCamera}
            disabled={showVideo && !cameraReady}
            className={`w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 ${
              (showVideo && !cameraReady) ? 'bg-white/10 text-white/40' : 'btn-primary'
            }`}
          >
            <Icon name="camera" size={20} />
            {(showVideo && !cameraReady) ? 'Kamera Bekleniyor...' : `Fotoƒüraf √áek (${photos.length + 1}/3)`}
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="h-full flex items-center justify-center p-6">
      <div className="text-center">
        <div className="relative w-24 h-24 mx-auto mb-6">
          <div className="absolute inset-0 rounded-full bg-gradient-to-r from-brand to-accent opacity-25 ring-pulse" />
          <div className="relative w-full h-full rounded-full bg-gradient-to-br from-brand to-brand2 flex items-center justify-center">
            <span className="text-4xl">‚ú®</span>
          </div>
        </div>
        <h2 className="text-xl font-black">Olu≈üturuluyor</h2>
        <p className="text-white/60 mt-1">{status}</p>
      </div>
    </div>
  );
};

// ============ PRODUCT CARD ============
const ProductCard = ({ product, onTryOn, onAddToCloset, onAdvice, isInCloset }) => {
  const [loaded, setLoaded] = useState(false);
  const isFeatured = product.brandId === 'modo';
  return (
    <div className={`product-card glass rounded-2xl overflow-hidden fade-in ${isFeatured ? 'ring-1 ring-brand2/50' : ''}`}>
      <div className="relative aspect-[3/4] bg-white/5">
        {!loaded && <div className="absolute inset-0 bg-white/5 animate-pulse" />}
        <img src={product.image} alt="" crossOrigin="anonymous" className={`w-full h-full object-cover transition-opacity ${loaded ? 'opacity-100' : 'opacity-0'}`}
          onLoad={() => setLoaded(true)} loading="lazy" />
        <div className="absolute top-2 left-2 flex gap-1">
          <div className={`badge px-2 py-1 rounded-lg text-[10px] font-bold ${isFeatured ? 'bg-gradient-to-r from-brand to-brand2' : ''}`}>{product.brandName}</div>
          {isFeatured && <div className="bg-accent/90 px-1.5 py-1 rounded-lg text-[9px] font-bold">‚ú®</div>}
        </div>
        {isInCloset && <div className="absolute top-2 right-2 bg-green-500/80 p-1.5 rounded-lg"><Icon name="check" size={10} /></div>}
      </div>
      <div className="p-3">
        <div className="text-brand2 font-bold text-sm">{product.price}</div>
        <div className="text-xs text-white/70 truncate">{product.name}</div>
        {product.description && <div className="text-[10px] text-white/40 truncate mt-0.5">{product.description}</div>}
        <div className="mt-3 space-y-2">
          <button onClick={() => onTryOn(product)} className="w-full bg-brand hover:bg-brand2 py-2.5 rounded-xl text-xs font-bold flex items-center justify-center gap-1 transition">
            <Icon name="shirt" size={14} />√úzerimde Dene
          </button>
          <div className="grid grid-cols-2 gap-2">
            <button onClick={() => onAddToCloset(product)} disabled={isInCloset}
              className={`py-2 rounded-xl text-xs font-bold flex items-center justify-center gap-1 ${isInCloset ? 'bg-green-500/20 text-green-400' : 'bg-white/10 hover:bg-white/15'}`}>
              <Icon name={isInCloset ? 'check' : 'hanger'} size={12} />{isInCloset ? 'Eklendi' : 'Ekle'}
            </button>
            <button onClick={() => onAdvice(product)} className="bg-accent/20 hover:bg-accent/30 text-accent py-2 rounded-xl text-xs font-bold flex items-center justify-center gap-1">
              <Icon name="sparkles" size={12} />Tavsiye
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// ============ SHOP ============
const Shop = ({ user, closet, onTryOn, onAddToCloset, onAdvice }) => {
  const [brand, setBrand] = useState('all');
  const [category, setCategory] = useState('all');
  const [search, setSearch] = useState('');

  const closetIds = useMemo(() => new Set(closet.map(i => i.id)), [closet]);

  const products = useMemo(() => {
    let f = ALL_PRODUCTS.filter(p => p.gender === 'unisex' || p.gender === user.gender);
    if (brand !== 'all') f = f.filter(p => p.brandId === brand);
    if (category !== 'all') f = f.filter(p => p.category === category);
    if (search) {
      const q = search.toLowerCase();
      f = f.filter(p => p.name.toLowerCase().includes(q) || p.brandName.toLowerCase().includes(q) || p.type.toLowerCase().includes(q));
    }
    return f;
  }, [user.gender, brand, category, search]);

  const featuredBrand = BRANDS.find(b => b.featured);

  return (
    <div className="h-full flex flex-col">
      {/* Search */}
      <div className="p-4 pb-2">
        <input value={search} onChange={e => setSearch(e.target.value)} placeholder="√úr√ºn, marka, kategori ara..." />
      </div>
      
      {/* Featured Banner */}
      {!search && brand === 'all' && (
        <div className="px-4 pb-3">
          <div className="glass rounded-2xl p-4 bg-gradient-to-r from-brand/20 to-brand2/20 border border-brand/30">
            <div className="flex items-center justify-between">
              <div>
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-lg">‚ú®</span>
                  <span className="text-xs font-bold text-brand2 uppercase tracking-wide">√ñne √áƒ±kan Koleksiyon</span>
                </div>
                <h3 className="text-xl font-black">{featuredBrand?.name || 'MODO'}</h3>
                <p className="text-xs text-white/60 mt-1">Sezonun en trend par√ßalarƒ±</p>
              </div>
              <button 
                onClick={() => setBrand('modo')} 
                className="btn-primary px-4 py-2 rounded-xl text-xs font-bold"
              >
                Ke≈üfet
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Brand Filter */}
      <div className="px-4 pb-2 space-y-2">
        <div className="flex gap-2 overflow-x-auto no-scrollbar">
          <button onClick={() => setBrand('all')} className={`px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap ${brand === 'all' ? 'bg-brand' : 'bg-white/10'}`}>T√ºm√º</button>
          {BRANDS.map(b => (
            <button key={b.id} onClick={() => setBrand(b.id)} className={`px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap flex items-center gap-1 ${brand === b.id ? 'bg-brand' : 'bg-white/10'}`}>
              {b.featured && <span className="text-[10px]">‚ú®</span>}
              {b.name}
            </button>
          ))}
        </div>
        <div className="flex gap-2">
          {[{ v: 'all', l: 'T√ºm√º' }, { v: 'top', l: '√úst' }, { v: 'bottom', l: 'Alt' }, { v: 'outerwear', l: 'Dƒ±≈ü' }, { v: 'fullbody', l: 'Elbise' }].map(c => (
            <button key={c.v} onClick={() => setCategory(c.v)} className={`flex-1 py-2 rounded-xl text-xs font-bold ${category === c.v ? 'bg-brand' : 'bg-white/10'}`}>{c.l}</button>
          ))}
        </div>
      </div>

      {/* Product Count */}
      <div className="px-4 pb-2">
        <p className="text-xs text-white/40">{products.length} √ºr√ºn bulundu</p>
      </div>

      {/* Products Grid */}
      <div className="flex-1 overflow-y-auto custom-scroll p-4 pt-0 pb-24">
        {products.length === 0 ? (
          <div className="text-center py-12">
            <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
              <Icon name="shop" size={28} className="text-white/30" />
            </div>
            <p className="font-semibold text-white/60">√úr√ºn Bulunamadƒ±</p>
            <p className="text-sm text-white/40 mt-1">Farklƒ± filtreler deneyin</p>
          </div>
        ) : (
          <div className="grid grid-cols-2 gap-3">
            {products.map(p => (
              <ProductCard key={p.id} product={p} onTryOn={onTryOn} onAddToCloset={onAddToCloset} onAdvice={onAdvice} isInCloset={closetIds.has(p.id)} />
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

// ============ CLOSET ============
const SmartCloset = ({ user, closet, onRemove, onTryOnResult, setToast, savedCombos, setSavedCombos, favorites, setFavorites, tryHistory, setTryHistory, getBaseAvatar, tryOnCache, setTryOnCache, checkCooldown, setLastTryTime, onShareToFeed, tokens, setTokens, videoTokens, setVideoTokens }) => {
  const [tab, setTab] = useState('items'); // items, combos, favorites, history, weather, video
  const [selected, setSelected] = useState({ top: null, bottom: null, outerwear: null, fullbody: null });
  const [bg, setBg] = useState(BACKGROUNDS[0]);
  const [loading, setLoading] = useState(false);
  const [comboName, setComboName] = useState('');
  const [showSaveCombo, setShowSaveCombo] = useState(false);
  const [viewMode, setViewMode] = useState('grid');
  const [sortBy, setSortBy] = useState('recent');
  
  // Video state
  const [videoLoading, setVideoLoading] = useState(false);
  const [videoResult, setVideoResult] = useState(null);
  const [showVideoModal, setShowVideoModal] = useState(false);
  const [showPackageModal, setShowPackageModal] = useState(false);
  
  // Weather & Calendar state
  const [weather, setWeather] = useState(null);
  const [weatherLoading, setWeatherLoading] = useState(false);
  const [occasion, setOccasion] = useState(null);

  // Kategorilere ayƒ±r
  const tops = closet.filter(i => i.category === 'top');
  const bottoms = closet.filter(i => i.category === 'bottom');
  const outerwears = closet.filter(i => i.category === 'outerwear');
  const fullbodies = closet.filter(i => i.category === 'fullbody');

  // Toggle selection based on category
  const toggle = item => {
    // Fullbody se√ßildiƒüinde top/bottom temizle
    if (item.category === 'fullbody') {
      setSelected({ top: null, bottom: null, outerwear: selected.outerwear, fullbody: selected.fullbody?.id === item.id ? null : item });
    } 
    // Top/bottom se√ßildiƒüinde fullbody temizle
    else if (item.category === 'top' || item.category === 'bottom') {
      setSelected(p => ({ ...p, fullbody: null, [item.category]: p[item.category]?.id === item.id ? null : item }));
    }
    // Outerwear her zaman eklenebilir
    else {
      setSelected(p => ({ ...p, [item.category]: p[item.category]?.id === item.id ? null : item }));
    }
  };

  // Hava durumu al
  const fetchWeather = async () => {
    setWeatherLoading(true);
    try {
      if (!navigator.geolocation) {
        throw new Error('Konum desteƒüi yok');
      }
      
      const pos = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
      });
      
      const { latitude, longitude } = pos.coords;
      
      // Open-Meteo API (√ºcretsiz, API key gerektirmez)
      const res = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto&forecast_days=3`
      );
      const data = await res.json();
      
      // Hava kodu a√ßƒ±klamasƒ±
      const weatherCodes = {
        0: { icon: '‚òÄÔ∏è', text: 'A√ßƒ±k' },
        1: { icon: 'üå§Ô∏è', text: 'Az Bulutlu' },
        2: { icon: '‚õÖ', text: 'Par√ßalƒ± Bulutlu' },
        3: { icon: '‚òÅÔ∏è', text: 'Bulutlu' },
        45: { icon: 'üå´Ô∏è', text: 'Sisli' },
        48: { icon: 'üå´Ô∏è', text: 'Yoƒüun Sis' },
        51: { icon: 'üåßÔ∏è', text: 'Hafif Yaƒümur' },
        53: { icon: 'üåßÔ∏è', text: 'Yaƒümurlu' },
        55: { icon: 'üåßÔ∏è', text: 'Yoƒüun Yaƒümur' },
        61: { icon: 'üåßÔ∏è', text: 'Hafif Yaƒümur' },
        63: { icon: 'üåßÔ∏è', text: 'Yaƒümurlu' },
        65: { icon: 'üåßÔ∏è', text: '≈ûiddetli Yaƒümur' },
        71: { icon: 'üå®Ô∏è', text: 'Hafif Kar' },
        73: { icon: 'üå®Ô∏è', text: 'Karlƒ±' },
        75: { icon: 'üå®Ô∏è', text: 'Yoƒüun Kar' },
        80: { icon: 'üå¶Ô∏è', text: 'Saƒüanak' },
        95: { icon: '‚õàÔ∏è', text: 'Fƒ±rtƒ±na' }
      };
      
      const code = data.current.weather_code;
      const weatherInfo = weatherCodes[code] || { icon: 'üå°Ô∏è', text: 'Belirsiz' };
      
      setWeather({
        temp: Math.round(data.current.temperature_2m),
        icon: weatherInfo.icon,
        text: weatherInfo.text,
        wind: Math.round(data.current.wind_speed_10m),
        daily: data.daily ? data.daily.time.map((date, i) => ({
          date: new Date(date).toLocaleDateString('tr-TR', { weekday: 'short' }),
          max: Math.round(data.daily.temperature_2m_max[i]),
          min: Math.round(data.daily.temperature_2m_min[i]),
          icon: (weatherCodes[data.daily.weather_code[i]] || weatherInfo).icon
        })) : []
      });
    } catch (e) {
      setToast({ open: true, type: 'error', title: 'Hava Durumu', message: 'Konum alƒ±namadƒ±. Tarayƒ±cƒ± iznini kontrol edin.' });
    }
    setWeatherLoading(false);
  };

  // Hava durumuna g√∂re √∂neri
  const getWeatherSuggestion = () => {
    if (!weather) return null;
    const temp = weather.temp;
    if (temp < 5) return { text: 'Kalƒ±n mont ve kat kat giyinin', categories: ['outerwear', 'top'] };
    if (temp < 15) return { text: 'Ceket veya hƒ±rka √∂nerilir', categories: ['outerwear', 'top', 'bottom'] };
    if (temp < 22) return { text: 'Hafif katman ideal', categories: ['top', 'bottom'] };
    return { text: 'Hafif ve serin kƒ±yafetler', categories: ['top', 'bottom', 'fullbody'] };
  };

  // Etkinlik t√ºrleri
  const occasions = [
    { id: 'work', name: 'ƒ∞≈ü', icon: 'üíº', suggestion: 'Formal veya smart casual' },
    { id: 'casual', name: 'G√ºnl√ºk', icon: 'üëï', suggestion: 'Rahat ve ≈üƒ±k' },
    { id: 'date', name: 'Randevu', icon: 'üíï', suggestion: '≈ûƒ±k ve dikkat √ßekici' },
    { id: 'sport', name: 'Spor', icon: 'üèÉ', suggestion: 'Rahat ve esnek' },
    { id: 'party', name: 'Parti', icon: 'üéâ', suggestion: 'G√∂z alƒ±cƒ± ve eƒülenceli' },
    { id: 'wedding', name: 'D√ºƒü√ºn', icon: 'üíí', suggestion: 'Elegant ve ≈üƒ±k' }
  ];

  // Unified try-on function: handles all categories
  const handleTryOn = async () => {
    // Se√ßili √ºr√ºnleri topla
    const items = [selected.fullbody, selected.top, selected.bottom, selected.outerwear].filter(Boolean);
    
    if (!items.length) {
      setToast({ open: true, type: 'error', title: 'Se√ßim yok', message: 'En az bir √ºr√ºn se√ß' });
      return;
    }
    
    const avatarData = user?.baseAvatar || user?.avatar;
    if (!avatarData) {
      setToast({ open: true, type: 'error', title: 'Avatar yok', message: '√ñnce avatar olu≈üturmalƒ±sƒ±n' });
      return;
    }
    
    // Create cache key
    const cacheKey = `combo_${items.map(i => i.id).sort().join('_')}_${bg.id}`;
    
    // Check cache first
    if (tryOnCache && tryOnCache[cacheKey]) {
      const cachedResult = tryOnCache[cacheKey];
      const historyItem = { id: Date.now(), image: cachedResult, items, background: bg, createdAt: Date.now() };
      setTryHistory(prev => [historyItem, ...prev].slice(0, 50));
      onTryOnResult(cachedResult, items);
      setToast({ open: true, type: 'success', title: 'Hƒ±zlƒ± Sonu√ß ‚ö°', message: '√ñnceki deneme y√ºklendi!' });
      return;
    }
    
    if (checkCooldown && !checkCooldown()) return;
    
    setLoading(true);
    if (setLastTryTime) setLastTryTime(Date.now());
    
    try {
      const baseAvatar = getBaseAvatar ? await getBaseAvatar() : avatarData;
      if (!baseAvatar || !baseAvatar.startsWith('data:image')) {
        throw new Error('Avatar y√ºklenemedi');
      }
      
      debugLog('TryOn', `Kombin: ${items.length} √ºr√ºn`, 'info');
      const result = await AI.tryOnCombo(baseAvatar, items, bg.value);
        
      if (!result || !result.startsWith('data:image')) {
        throw new Error("G√∂rsel olu≈üturulamadƒ±");
      }
      
      if (setTryOnCache) {
        setTryOnCache(prev => ({ ...prev, [cacheKey]: result }));
      }
      
      debugLog('TryOn', 'History\'ye ekleniyor...', 'info');
      const historyItem = { id: Date.now(), image: result, items, background: bg, createdAt: Date.now() };
      setTryHistory(prev => [historyItem, ...prev].slice(0, 50));
      
      debugLog('TryOn', 'Loading kapatƒ±lƒ±yor...', 'info');
      setLoading(false);
      
      debugLog('TryOn', 'onTryOnResult √ßaƒürƒ±lƒ±yor...', 'info');
      onTryOnResult(result, items);
      
      debugLog('TryOn', 'Toast g√∂steriliyor...', 'info');
      setToast({ open: true, type: 'success', title: 'Ba≈üarƒ±lƒ±', message: 'Kombin hazƒ±r!' });
      
      debugLog('TryOn', 'ƒ∞≈ülem tamamlandƒ± ‚úì', 'success');
    } catch (e) {
      debugLog('TryOn', `HATA: ${e.message}`, 'error');
      setLoading(false);
      setToast({ open: true, type: 'error', title: 'Deneme hatasƒ±', message: e.message || 'Bir hata olu≈ütu' });
    }
  };

  // Video Try-On Function
  const tryVideoTryOn = async () => {
    const items = [selected.fullbody, selected.top, selected.bottom, selected.outerwear].filter(Boolean);
    
    if (!items.length) {
      setToast({ open: true, type: 'error', title: 'Se√ßim yok', message: 'Video i√ßin en az bir √ºr√ºn se√ß' });
      return;
    }
    
    if (!videoTokens || videoTokens < 1) {
      setShowPackageModal(true);
      return;
    }
    
    const avatarData = user?.baseAvatar || user?.avatar;
    if (!avatarData) {
      setToast({ open: true, type: 'error', title: 'Avatar yok', message: '√ñnce avatar olu≈üturmalƒ±sƒ±n' });
      return;
    }
    
    setVideoLoading(true);
    setShowVideoModal(true);
    
    try {
      const baseAvatar = getBaseAvatar ? await getBaseAvatar() : avatarData;
      if (!baseAvatar || !baseAvatar.startsWith('data:image')) {
        throw new Error('Avatar y√ºklenemedi');
      }
      
      const userParams = {
        gender: user?.gender,
        age: user?.age,
        height: user?.height,
        bodyType: user?.bodyType,
        skinTone: user?.skinTone,
        hairColor: user?.hairColor,
        hairStyle: user?.hairStyle
      };
      
      debugLog('VIDEO', `Video olu≈üturuluyor - ${items.length} par√ßa`, 'info');
      const result = await AI.generateVideoTryOn(baseAvatar, items, userParams);
      
      if (!result) {
        throw new Error("Video olu≈üturulamadƒ±");
      }
      
      // Deduct video token
      if (setVideoTokens) {
        setVideoTokens(prev => Math.max(0, prev - 1));
      }
      
      setVideoResult(result);
      setToast({ open: true, type: 'success', title: 'Video Hazƒ±r! üé¨', message: '6 saniyelik moda videon olu≈üturuldu!' });
      
    } catch (e) {
      debugLog('VIDEO', `HATA: ${e.message}`, 'error');
      setToast({ open: true, type: 'error', title: 'Video hatasƒ±', message: e.message || 'Video olu≈üturulamadƒ±' });
      setShowVideoModal(false);
    }
    
    setVideoLoading(false);
  };

  // Package purchase handler
  const purchasePackage = (packageType) => {
    // Simulated purchase - in real app this would connect to payment provider
    if (packageType === 'video5') {
      if (setVideoTokens) setVideoTokens(prev => prev + 5);
      setToast({ open: true, type: 'success', title: 'Paket Alƒ±ndƒ±! üé¨', message: '5 Video Token eklendi!' });
    } else if (packageType === 'video10') {
      if (setVideoTokens) setVideoTokens(prev => prev + 10);
      setToast({ open: true, type: 'success', title: 'Paket Alƒ±ndƒ±! üé¨', message: '10 Video Token eklendi!' });
    } else if (packageType === 'urgent5') {
      if (setTokens) setTokens(prev => prev + 5);
      setToast({ open: true, type: 'success', title: 'Paket Alƒ±ndƒ±! ‚ö°', message: '5 Acil Token eklendi!' });
    } else if (packageType === 'hd30') {
      if (setTokens) setTokens(prev => prev + 30);
      setToast({ open: true, type: 'success', title: 'Paket Alƒ±ndƒ±! ‚ú®', message: '30 HD Token eklendi!' });
    }
    setShowPackageModal(false);
  };

  const saveCombo = () => {
    const items = [selected.fullbody, selected.top, selected.bottom, selected.outerwear].filter(Boolean);
    if (!items.length) return;
    const combo = {
      id: Date.now(),
      name: comboName || `Kombin ${savedCombos.length + 1}`,
      items: items,
      background: bg,
      createdAt: Date.now()
    };
    setSavedCombos(prev => [...prev, combo]);
    setComboName('');
    setShowSaveCombo(false);
    setSelected({ top: null, bottom: null, outerwear: null, fullbody: null });
    setToast({ open: true, type: 'success', title: 'Kaydedildi', message: 'Kombin kaydedildi!' });
  };

  const deleteCombo = (id) => {
    if (confirm('Bu kombini silmek istiyor musun?')) {
      setSavedCombos(prev => prev.filter(c => c.id !== id));
    }
  };

  const toggleFavorite = (item) => {
    const isFav = favorites.some(f => f.id === item.id);
    if (isFav) {
      setFavorites(prev => prev.filter(f => f.id !== item.id));
    } else {
      setFavorites(prev => [...prev, { ...item, favoritedAt: Date.now() }]);
    }
  };

  const isFavorite = (itemId) => favorites.some(f => f.id === itemId);

  const sortedCloset = useMemo(() => {
    let sorted = [...closet];
    if (sortBy === 'recent') sorted.sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0));
    if (sortBy === 'brand') sorted.sort((a, b) => a.brandName.localeCompare(b.brandName));
    if (sortBy === 'color') sorted.sort((a, b) => a.color.localeCompare(b.color));
    return sorted;
  }, [closet, sortBy]);

  const tabs = [
    { id: 'items', icon: 'hanger', label: '√úr√ºnler', count: closet.length },
    { id: 'video', icon: 'video', label: 'Video', count: videoTokens || 0 },
    { id: 'weather', icon: 'sun', label: 'Hava', count: 0 },
    { id: 'combos', icon: 'layers', label: 'Kombinler', count: savedCombos.length },
    { id: 'favorites', icon: 'heart', label: 'Favoriler', count: favorites.length },
    { id: 'history', icon: 'clock', label: 'Ge√ßmi≈ü', count: tryHistory.length }
  ];

  if (!closet.length && tab === 'items') {
    return (
      <div className="h-full flex flex-col">
        {/* Tab Navigation */}
        <div className="flex-shrink-0 px-4 py-3 border-b border-white/10">
          <div className="flex gap-1 bg-white/5 rounded-2xl p-1">
            {tabs.map(t => (
              <button
                key={t.id}
                onClick={() => setTab(t.id)}
                className={`flex-1 py-2.5 px-1 rounded-xl text-xs font-semibold flex items-center justify-center gap-1 transition ${
                  tab === t.id ? 'bg-brand text-white' : 'text-white/50 hover:text-white/70'
                }`}
              >
                <Icon name={t.icon} size={14} />
                <span className="hidden sm:inline">{t.label}</span>
                {t.count > 0 && <span className="bg-white/20 px-1.5 py-0.5 rounded-full text-[10px]">{t.count}</span>}
              </button>
            ))}
          </div>
        </div>
        <div className="flex-1 flex items-center justify-center p-6">
          <div className="text-center">
            <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
              <Icon name="hanger" size={32} className="text-white/30" />
            </div>
            <p className="text-white/60 font-bold">Dolabƒ±n Bo≈ü</p>
            <p className="text-white/40 text-sm mt-1">Alƒ±≈üveri≈üten √ºr√ºn ekle</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="h-full flex flex-col">
      {/* Tab Navigation */}
      <div className="flex-shrink-0 px-4 py-3 border-b border-white/10">
        <div className="flex gap-1 bg-white/5 rounded-2xl p-1">
          {tabs.map(t => (
            <button
              key={t.id}
              onClick={() => setTab(t.id)}
              className={`flex-1 py-2.5 px-1 rounded-xl text-xs font-semibold flex items-center justify-center gap-1 transition ${
                tab === t.id ? 'bg-brand text-white' : 'text-white/50 hover:text-white/70'
              }`}
            >
              <Icon name={t.icon} size={14} />
              <span className="hidden sm:inline">{t.label}</span>
              {t.count > 0 && <span className="bg-white/20 px-1.5 py-0.5 rounded-full text-[10px]">{t.count}</span>}
            </button>
          ))}
        </div>
      </div>

      {/* ITEMS TAB */}
      {tab === 'items' && (
        <>
          {/* Controls */}
          <div className="flex-shrink-0 px-4 py-3 space-y-3">
            {/* Background Selection */}
            <div className="flex gap-2 overflow-x-auto no-scrollbar">
              {BACKGROUNDS.map(b => (
                <button key={b.id} onClick={() => setBg(b)} className={`px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap ${bg.id === b.id ? 'bg-brand' : 'bg-white/10'}`}>
                  {b.name}
                </button>
              ))}
            </div>
            {/* Sort & View */}
            <div className="flex items-center justify-between">
              <div className="flex gap-2">
                <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="bg-white/10 border-0 text-xs py-1.5 px-3 rounded-lg">
                  <option value="recent">Son Eklenen</option>
                  <option value="brand">Marka</option>
                  <option value="color">Renk</option>
                </select>
              </div>
              <div className="flex gap-1 bg-white/10 rounded-lg p-1">
                <button onClick={() => setViewMode('grid')} className={`p-1.5 rounded ${viewMode === 'grid' ? 'bg-white/20' : ''}`}>
                  <Icon name="grid" size={14} />
                </button>
                <button onClick={() => setViewMode('list')} className={`p-1.5 rounded ${viewMode === 'list' ? 'bg-white/20' : ''}`}>
                  <Icon name="list" size={14} />
                </button>
              </div>
            </div>
          </div>

          {/* Items Grid/List */}
          <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-32">
            {/* Fullbody - Elbiseler */}
            {fullbodies.length > 0 && (
              <div className="mb-4">
                <p className="text-xs text-white/50 mb-2 font-bold flex items-center gap-2">
                  üëó ELBƒ∞SE & TULUM ({fullbodies.length})
                </p>
                <div className={viewMode === 'grid' ? 'grid grid-cols-4 gap-2' : 'space-y-2'}>
                  {fullbodies.map(item => (
                    <div key={item.id} className={`relative ${viewMode === 'list' ? 'glass rounded-xl p-3 flex items-center gap-3' : ''}`}>
                      <button 
                        onClick={() => toggle(item)} 
                        className={`${viewMode === 'grid' ? 'aspect-square w-full' : 'w-16 h-16 flex-shrink-0'} rounded-xl overflow-hidden border-2 ${selected.fullbody?.id === item.id ? 'border-pink-400' : 'border-white/10'}`}
                      >
                        <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                        {selected.fullbody?.id === item.id && <div className="absolute inset-0 bg-pink-400/30 flex items-center justify-center"><Icon name="check" size={16} /></div>}
                      </button>
                      {viewMode === 'list' && (
                        <div className="flex-1 min-w-0">
                          <p className="font-semibold text-sm truncate">{item.name}</p>
                          <p className="text-xs text-white/50">{item.brandName}</p>
                        </div>
                      )}
                      <div className={`${viewMode === 'grid' ? 'absolute top-1 right-1' : ''} flex gap-1`}>
                        <button onClick={() => toggleFavorite(item)} className="p-1.5 rounded-lg bg-black/50 hover:bg-black/70">
                          <Icon name={isFavorite(item.id) ? 'heartFilled' : 'heart'} size={12} className={isFavorite(item.id) ? 'text-red-400' : 'text-white/60'} />
                        </button>
                        <button onClick={() => onRemove(item.id)} className="p-1.5 rounded-lg bg-black/50 hover:bg-red-500/50">
                          <Icon name="trash" size={12} className="text-white/60" />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Tops */}
            {tops.length > 0 && (
              <div className="mb-4">
                <p className="text-xs text-white/50 mb-2 font-bold flex items-center gap-2">
                  <Icon name="shirt" size={12} /> √úST Gƒ∞Yƒ∞M ({tops.length})
                </p>
                <div className={viewMode === 'grid' ? 'grid grid-cols-4 gap-2' : 'space-y-2'}>
                  {tops.map(item => (
                    <div key={item.id} className={`relative ${viewMode === 'list' ? 'glass rounded-xl p-3 flex items-center gap-3' : ''}`}>
                      <button 
                        onClick={() => toggle(item)} 
                        className={`${viewMode === 'grid' ? 'aspect-square w-full' : 'w-16 h-16 flex-shrink-0'} rounded-xl overflow-hidden border-2 ${selected.top?.id === item.id ? 'border-brand2' : 'border-white/10'}`}
                      >
                        <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                        {selected.top?.id === item.id && <div className="absolute inset-0 bg-brand2/30 flex items-center justify-center"><Icon name="check" size={16} /></div>}
                      </button>
                      {viewMode === 'list' && (
                        <div className="flex-1 min-w-0">
                          <p className="font-semibold text-sm truncate">{item.name}</p>
                          <p className="text-xs text-white/50">{item.brandName}</p>
                        </div>
                      )}
                      <div className={`${viewMode === 'grid' ? 'absolute top-1 right-1' : ''} flex gap-1`}>
                        <button onClick={() => toggleFavorite(item)} className="p-1.5 rounded-lg bg-black/50 hover:bg-black/70">
                          <Icon name={isFavorite(item.id) ? 'heartFilled' : 'heart'} size={12} className={isFavorite(item.id) ? 'text-red-400' : 'text-white/60'} />
                        </button>
                        <button onClick={() => onRemove(item.id)} className="p-1.5 rounded-lg bg-black/50 hover:bg-red-500/50">
                          <Icon name="trash" size={12} className="text-white/60" />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {/* Bottoms */}
            {bottoms.length > 0 && (
              <div className="mb-4">
                <p className="text-xs text-white/50 mb-2 font-bold flex items-center gap-2">
                  üëñ ALT Gƒ∞Yƒ∞M ({bottoms.length})
                </p>
                <div className={viewMode === 'grid' ? 'grid grid-cols-4 gap-2' : 'space-y-2'}>
                  {bottoms.map(item => (
                    <div key={item.id} className={`relative ${viewMode === 'list' ? 'glass rounded-xl p-3 flex items-center gap-3' : ''}`}>
                      <button 
                        onClick={() => toggle(item)} 
                        className={`${viewMode === 'grid' ? 'aspect-square w-full' : 'w-16 h-16 flex-shrink-0'} rounded-xl overflow-hidden border-2 ${selected.bottom?.id === item.id ? 'border-accent' : 'border-white/10'}`}
                      >
                        <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                        {selected.bottom?.id === item.id && <div className="absolute inset-0 bg-amber-400/20 border-2 border-amber-400 rounded-xl flex items-center justify-center"><Icon name="check" size={16} className="text-amber-400" /></div>}
                      </button>
                      {viewMode === 'list' && (
                        <div className="flex-1 min-w-0">
                          <p className="font-semibold text-sm truncate">{item.name}</p>
                          <p className="text-xs text-white/50">{item.brandName}</p>
                        </div>
                      )}
                      <div className={`${viewMode === 'grid' ? 'absolute top-1 right-1' : ''} flex gap-1`}>
                        <button onClick={() => toggleFavorite(item)} className="p-1.5 rounded-lg bg-black/50 hover:bg-black/70">
                          <Icon name={isFavorite(item.id) ? 'heartFilled' : 'heart'} size={12} className={isFavorite(item.id) ? 'text-red-400' : 'text-white/60'} />
                        </button>
                        <button onClick={() => onRemove(item.id)} className="p-1.5 rounded-lg bg-black/50 hover:bg-red-500/50">
                          <Icon name="trash" size={12} className="text-white/60" />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {/* Outerwear - Mont, Palto, Ceket */}
            {outerwears.length > 0 && (
              <div className="mb-4">
                <p className="text-xs text-white/50 mb-2 font-bold flex items-center gap-2">
                  üß• DI≈û Gƒ∞Yƒ∞M ({outerwears.length})
                </p>
                <div className={viewMode === 'grid' ? 'grid grid-cols-4 gap-2' : 'space-y-2'}>
                  {outerwears.map(item => (
                    <div key={item.id} className={`relative ${viewMode === 'list' ? 'glass rounded-xl p-3 flex items-center gap-3' : ''}`}>
                      <button 
                        onClick={() => toggle(item)} 
                        className={`${viewMode === 'grid' ? 'aspect-square w-full' : 'w-16 h-16 flex-shrink-0'} rounded-xl overflow-hidden border-2 ${selected.outerwear?.id === item.id ? 'border-blue-400' : 'border-white/10'}`}
                      >
                        <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                        {selected.outerwear?.id === item.id && <div className="absolute inset-0 bg-blue-400/30 flex items-center justify-center"><Icon name="check" size={16} /></div>}
                      </button>
                      {viewMode === 'list' && (
                        <div className="flex-1 min-w-0">
                          <p className="font-semibold text-sm truncate">{item.name}</p>
                          <p className="text-xs text-white/50">{item.brandName}</p>
                        </div>
                      )}
                      <div className={`${viewMode === 'grid' ? 'absolute top-1 right-1' : ''} flex gap-1`}>
                        <button onClick={() => toggleFavorite(item)} className="p-1.5 rounded-lg bg-black/50 hover:bg-black/70">
                          <Icon name={isFavorite(item.id) ? 'heartFilled' : 'heart'} size={12} className={isFavorite(item.id) ? 'text-red-400' : 'text-white/60'} />
                        </button>
                        <button onClick={() => onRemove(item.id)} className="p-1.5 rounded-lg bg-black/50 hover:bg-red-500/50">
                          <Icon name="trash" size={12} className="text-white/60" />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Bottom Actions */}
          <div className="absolute bottom-20 left-0 right-0 p-4 space-y-2">
            {(selected.top || selected.bottom || selected.fullbody || selected.outerwear) && (
              <button onClick={() => setShowSaveCombo(true)} className="w-full btn-secondary py-3 rounded-xl font-semibold flex items-center justify-center gap-2">
                <Icon name="bookmark" size={16} />Kombini Kaydet
              </button>
            )}
            <button 
              onClick={handleTryOn} 
              disabled={loading || (!selected.top && !selected.bottom && !selected.fullbody && !selected.outerwear)} 
              className="w-full btn-primary py-4 rounded-2xl font-bold flex items-center justify-center gap-2 disabled:opacity-50"
            >
              {loading ? (
                <><div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />Olu≈üturuluyor...</>
              ) : (
                <><Icon name="sparkles" size={18} />
                  {[selected.fullbody, selected.top, selected.bottom, selected.outerwear].filter(Boolean).length > 1 
                    ? `Kombini Dene (${[selected.fullbody, selected.top, selected.bottom, selected.outerwear].filter(Boolean).length} par√ßa)` 
                    : '√úzerimde G√∂r'}
                </>
              )}
            </button>
          </div>

          {/* Selected Items Preview */}
          {(selected.top || selected.bottom || selected.fullbody || selected.outerwear) && (
            <div className="absolute bottom-36 left-4 right-4">
              <div className="glass rounded-xl p-2 flex items-center gap-2">
                <span className="text-xs text-white/50 px-2">Se√ßili:</span>
                <div className="flex gap-1 flex-1 overflow-x-auto no-scrollbar">
                  {selected.fullbody && (
                    <div className="relative flex-shrink-0">
                      <img src={selected.fullbody.image} className="w-10 h-10 rounded-lg object-cover ring-2 ring-pink-400" />
                      <button onClick={() => setSelected(p => ({...p, fullbody: null}))} className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
                        <Icon name="x" size={10} />
                      </button>
                    </div>
                  )}
                  {selected.top && (
                    <div className="relative flex-shrink-0">
                      <img src={selected.top.image} className="w-10 h-10 rounded-lg object-cover ring-2 ring-brand2" />
                      <button onClick={() => setSelected(p => ({...p, top: null}))} className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
                        <Icon name="x" size={10} />
                      </button>
                    </div>
                  )}
                  {selected.bottom && (
                    <div className="relative flex-shrink-0">
                      <img src={selected.bottom.image} className="w-10 h-10 rounded-lg object-cover ring-2 ring-accent" />
                      <button onClick={() => setSelected(p => ({...p, bottom: null}))} className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
                        <Icon name="x" size={10} />
                      </button>
                    </div>
                  )}
                  {selected.outerwear && (
                    <div className="relative flex-shrink-0">
                      <img src={selected.outerwear.image} className="w-10 h-10 rounded-lg object-cover ring-2 ring-blue-400" />
                      <button onClick={() => setSelected(p => ({...p, outerwear: null}))} className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
                        <Icon name="x" size={10} />
                      </button>
                    </div>
                  )}
                </div>
                <button 
                  onClick={() => setSelected({ top: null, bottom: null, outerwear: null, fullbody: null })} 
                  className="text-xs text-white/50 hover:text-white px-2"
                >
                  Temizle
                </button>
              </div>
            </div>
          )}

          {/* Save Combo Modal */}
          {showSaveCombo && (
            <div className="fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4">
              <div className="w-full max-w-sm glass rounded-3xl p-6 scale-in">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-bold text-lg">Kombini Kaydet</h3>
                  <button onClick={() => setShowSaveCombo(false)} className="p-2 rounded-xl hover:bg-white/10">
                    <Icon name="x" size={20} />
                  </button>
                </div>
                <div className="flex gap-2 justify-center mb-4 flex-wrap">
                  {selected.fullbody && <img src={selected.fullbody.image} className="w-14 h-14 rounded-xl object-cover ring-2 ring-pink-400" />}
                  {selected.top && <img src={selected.top.image} className="w-14 h-14 rounded-xl object-cover ring-2 ring-brand2" />}
                  {selected.bottom && <img src={selected.bottom.image} className="w-14 h-14 rounded-xl object-cover ring-2 ring-accent" />}
                  {selected.outerwear && <img src={selected.outerwear.image} className="w-14 h-14 rounded-xl object-cover ring-2 ring-blue-400" />}
                </div>
                <input
                  type="text"
                  value={comboName}
                  onChange={e => setComboName(e.target.value)}
                  placeholder="Kombin adƒ± (opsiyonel)"
                  className="mb-4"
                />
                <div className="flex gap-3">
                  <button onClick={() => setShowSaveCombo(false)} className="flex-1 btn-ghost py-3 rounded-xl font-semibold">ƒ∞ptal</button>
                  <button onClick={saveCombo} className="flex-1 btn-primary py-3 rounded-xl font-semibold">Kaydet</button>
                </div>
              </div>
            </div>
          )}

          {/* Package Purchase Modal */}
          {showPackageModal && (
            <div className="fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4">
              <div className="w-full max-w-md glass rounded-3xl p-6 scale-in max-h-[90vh] overflow-y-auto">
                <div className="flex items-center justify-between mb-6">
                  <h3 className="font-bold text-xl">Token Paketleri</h3>
                  <button onClick={() => setShowPackageModal(false)} className="p-2 rounded-xl hover:bg-white/10">
                    <Icon name="x" size={20} />
                  </button>
                </div>
                
                {/* Video Packages */}
                <div className="mb-6">
                  <h4 className="font-semibold text-pink-400 mb-3 flex items-center gap-2">
                    <Icon name="video" size={16} />
                    Video Paketleri
                  </h4>
                  <div className="space-y-3">
                    <div className="bg-gradient-to-r from-pink-500/20 to-purple-500/20 rounded-2xl p-4 border border-pink-500/30">
                      <div className="flex items-center justify-between mb-2">
                        <div>
                          <p className="font-bold">5 Video Token</p>
                          <p className="text-xs text-white/60">6 saniyelik moda videolarƒ±</p>
                        </div>
                        <span className="text-2xl font-black text-pink-400">‚Ç∫300</span>
                      </div>
                      <button 
                        onClick={() => purchasePackage('video5')}
                        className="w-full py-2 bg-gradient-to-r from-pink-500 to-purple-500 rounded-xl font-bold text-sm"
                      >
                        Satƒ±n Al
                      </button>
                    </div>
                    
                    <div className="bg-gradient-to-r from-pink-500/20 to-purple-500/20 rounded-2xl p-4 border border-pink-500/30 relative overflow-hidden">
                      <div className="absolute top-2 right-2 bg-yellow-500 text-black text-[10px] font-bold px-2 py-0.5 rounded-full">
                        %5 ƒ∞NDƒ∞Rƒ∞M
                      </div>
                      <div className="flex items-center justify-between mb-2">
                        <div>
                          <p className="font-bold">10 Video Token</p>
                          <p className="text-xs text-white/60">En pop√ºler paket!</p>
                        </div>
                        <div className="text-right">
                          <span className="text-2xl font-black text-pink-400">‚Ç∫570</span>
                          <p className="text-xs text-white/40 line-through">‚Ç∫600</p>
                        </div>
                      </div>
                      <button 
                        onClick={() => purchasePackage('video10')}
                        className="w-full py-2 bg-gradient-to-r from-pink-500 to-purple-500 rounded-xl font-bold text-sm"
                      >
                        Satƒ±n Al
                      </button>
                    </div>
                  </div>
                </div>
                
                {/* Image Packages */}
                <div>
                  <h4 className="font-semibold text-brand2 mb-3 flex items-center gap-2">
                    <Icon name="image" size={16} />
                    G√∂rsel Paketleri
                  </h4>
                  <div className="space-y-3">
                    <div className="bg-white/5 rounded-2xl p-4 border border-white/10">
                      <div className="flex items-center justify-between mb-2">
                        <div>
                          <p className="font-bold flex items-center gap-2">
                            5 Acil Token
                            <span className="text-[10px] bg-orange-500/20 text-orange-400 px-2 py-0.5 rounded-full">ACƒ∞L</span>
                          </p>
                          <p className="text-xs text-white/60">Bekleme s√ºresiz deneme</p>
                        </div>
                        <span className="text-xl font-black text-brand2">‚Ç∫99</span>
                      </div>
                      <button 
                        onClick={() => purchasePackage('urgent5')}
                        className="w-full py-2 bg-brand2 rounded-xl font-bold text-sm"
                      >
                        Satƒ±n Al
                      </button>
                    </div>
                    
                    <div className="bg-white/5 rounded-2xl p-4 border border-white/10 relative overflow-hidden">
                      <div className="absolute top-2 right-2 bg-green-500 text-black text-[10px] font-bold px-2 py-0.5 rounded-full">
                        EN DEƒûERLƒ∞
                      </div>
                      <div className="flex items-center justify-between mb-2">
                        <div>
                          <p className="font-bold flex items-center gap-2">
                            30 HD Token
                            <span className="text-[10px] bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full">HD</span>
                          </p>
                          <p className="text-xs text-white/60">Y√ºksek kalite denemeler</p>
                        </div>
                        <span className="text-xl font-black text-brand2">‚Ç∫349</span>
                      </div>
                      <button 
                        onClick={() => purchasePackage('hd30')}
                        className="w-full py-2 bg-brand2 rounded-xl font-bold text-sm"
                      >
                        Satƒ±n Al
                      </button>
                    </div>
                  </div>
                </div>
                
                <p className="text-center text-xs text-white/40 mt-4">
                  √ñdemeler g√ºvenli ≈üekilde i≈ülenir. 256-bit SSL korumalƒ±.
                </p>
              </div>
            </div>
          )}

          {/* Video Loading Modal */}
          {showVideoModal && videoLoading && (
            <div className="fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4">
              <div className="w-full max-w-sm glass rounded-3xl p-8 text-center scale-in">
                <div className="w-20 h-20 mx-auto mb-4 relative">
                  <div className="absolute inset-0 rounded-full bg-gradient-to-r from-pink-500 to-purple-500 animate-spin" style={{ padding: '3px' }}>
                    <div className="w-full h-full bg-dark rounded-full" />
                  </div>
                  <div className="absolute inset-0 flex items-center justify-center">
                    <Icon name="video" size={32} className="text-pink-400" />
                  </div>
                </div>
                <h3 className="font-bold text-xl mb-2">Video Olu≈üturuluyor</h3>
                <p className="text-white/60 text-sm">6 saniyelik moda videon hazƒ±rlanƒ±yor...</p>
                <p className="text-white/40 text-xs mt-2">Bu i≈ülem 30-60 saniye s√ºrebilir</p>
              </div>
            </div>
          )}
        </>
      )}

      {/* WEATHER TAB */}
      {tab === 'weather' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {/* Weather Card */}
          <div className="glass rounded-2xl p-4 mb-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-bold flex items-center gap-2">
                <Icon name="sun" size={18} className="text-yellow-400" />
                Hava Durumu
              </h3>
              <button 
                onClick={fetchWeather} 
                disabled={weatherLoading}
                className="px-3 py-1.5 bg-white/10 rounded-lg text-xs font-semibold flex items-center gap-1"
              >
                {weatherLoading ? (
                  <><div className="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin" /> Y√ºkleniyor</>
                ) : (
                  <><Icon name="mapPin" size={12} /> Konumdan Al</>
                )}
              </button>
            </div>
            
            {weather ? (
              <div>
                <div className="flex items-center gap-4 mb-4">
                  <span className="text-5xl">{weather.icon}</span>
                  <div>
                    <p className="text-3xl font-bold">{weather.temp}¬∞C</p>
                    <p className="text-white/60">{weather.text}</p>
                    <p className="text-xs text-white/40">R√ºzgar: {weather.wind} km/s</p>
                  </div>
                </div>
                
                {/* 3 G√ºnl√ºk Tahmin */}
                {weather.daily?.length > 0 && (
                  <div className="grid grid-cols-3 gap-2 mt-4 pt-4 border-t border-white/10">
                    {weather.daily.map((day, i) => (
                      <div key={i} className="text-center bg-white/5 rounded-xl p-2">
                        <p className="text-xs text-white/50">{day.date}</p>
                        <span className="text-xl">{day.icon}</span>
                        <p className="text-xs"><span className="text-white/80">{day.max}¬∞</span> <span className="text-white/40">{day.min}¬∞</span></p>
                      </div>
                    ))}
                  </div>
                )}
                
                {/* Kƒ±yafet √ñnerisi */}
                {getWeatherSuggestion() && (
                  <div className="mt-4 p-3 bg-brand/20 rounded-xl">
                    <p className="text-sm font-semibold flex items-center gap-2">
                      <Icon name="sparkles" size={14} className="text-brand2" />
                      {getWeatherSuggestion().text}
                    </p>
                  </div>
                )}
              </div>
            ) : (
              <div className="text-center py-6">
                <span className="text-4xl">üå°Ô∏è</span>
                <p className="text-sm text-white/50 mt-2">Hava durumunu g√∂rmek i√ßin konumunuzu payla≈üƒ±n</p>
              </div>
            )}
          </div>

          {/* Occasion Selection */}
          <div className="glass rounded-2xl p-4">
            <h3 className="font-bold mb-3 flex items-center gap-2">
              <Icon name="calendar" size={18} className="text-accent" />
              Bug√ºn Ne Yapƒ±yorsun?
            </h3>
            <div className="grid grid-cols-3 gap-2">
              {occasions.map(occ => (
                <button 
                  key={occ.id}
                  onClick={() => setOccasion(occasion?.id === occ.id ? null : occ)}
                  className={`p-3 rounded-xl text-center transition ${occasion?.id === occ.id ? 'bg-accent/30 ring-1 ring-accent' : 'bg-white/5 hover:bg-white/10'}`}
                >
                  <span className="text-2xl block mb-1">{occ.icon}</span>
                  <p className="text-xs font-semibold">{occ.name}</p>
                </button>
              ))}
            </div>
            
            {occasion && (
              <div className="mt-4 p-3 bg-accent/20 rounded-xl">
                <p className="text-sm">
                  <span className="font-semibold">{occasion.name}</span> i√ßin √∂neri: {occasion.suggestion}
                </p>
              </div>
            )}
          </div>

          {/* Quick Suggestion */}
          {(weather || occasion) && (
            <div className="mt-4">
              <button 
                onClick={() => setTab('items')}
                className="w-full btn-primary py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
              >
                <Icon name="sparkles" size={16} />
                Kƒ±yafet Se√ßmeye Git
              </button>
            </div>
          )}
        </div>
      )}

      {/* VIDEO TAB */}
      {tab === 'video' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {/* Video Token Info */}
          <div className="glass rounded-2xl p-4 mb-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-bold flex items-center gap-2">
                <Icon name="video" size={18} className="text-pink-400" />
                Video Deneme
              </h3>
              <div className="flex items-center gap-2">
                <span className="px-3 py-1.5 bg-pink-500/20 rounded-lg text-xs font-bold text-pink-400">
                  üé¨ {videoTokens || 0} Video
                </span>
                <button 
                  onClick={() => setShowPackageModal(true)}
                  className="px-3 py-1.5 bg-gradient-to-r from-pink-500 to-purple-500 rounded-lg text-xs font-bold"
                >
                  + Satƒ±n Al
                </button>
              </div>
            </div>
            
            <p className="text-sm text-white/60 mb-4">
              6 saniyelik profesyonel moda videosu olu≈ütur! AI, avatarƒ±nƒ± se√ßtiƒüin kƒ±yafetlerle canlandƒ±rƒ±r.
            </p>
            
            {/* Selected Items Preview */}
            {(selected.top || selected.bottom || selected.fullbody || selected.outerwear) ? (
              <div className="bg-white/5 rounded-xl p-3 mb-4">
                <p className="text-xs text-white/50 mb-2">Se√ßili √úr√ºnler:</p>
                <div className="flex gap-2 flex-wrap">
                  {selected.fullbody && (
                    <div className="flex items-center gap-1 bg-pink-500/20 px-2 py-1 rounded-lg">
                      <img src={selected.fullbody.image} className="w-6 h-6 rounded object-cover" />
                      <span className="text-xs">{selected.fullbody.name}</span>
                    </div>
                  )}
                  {selected.top && (
                    <div className="flex items-center gap-1 bg-brand2/20 px-2 py-1 rounded-lg">
                      <img src={selected.top.image} className="w-6 h-6 rounded object-cover" />
                      <span className="text-xs">{selected.top.name}</span>
                    </div>
                  )}
                  {selected.bottom && (
                    <div className="flex items-center gap-1 bg-amber-400/20 px-2 py-1 rounded-lg">
                      <img src={selected.bottom.image} className="w-6 h-6 rounded object-cover" />
                      <span className="text-xs">{selected.bottom.name}</span>
                    </div>
                  )}
                  {selected.outerwear && (
                    <div className="flex items-center gap-1 bg-blue-400/20 px-2 py-1 rounded-lg">
                      <img src={selected.outerwear.image} className="w-6 h-6 rounded object-cover" />
                      <span className="text-xs">{selected.outerwear.name}</span>
                    </div>
                  )}
                </div>
              </div>
            ) : (
              <div className="bg-white/5 rounded-xl p-4 text-center mb-4">
                <Icon name="shirt" size={24} className="mx-auto mb-2 text-white/30" />
                <p className="text-sm text-white/50">√úr√ºnler sekmesinden kƒ±yafet se√ß</p>
              </div>
            )}
            
            <button
              onClick={tryVideoTryOn}
              disabled={videoLoading || (!selected.top && !selected.bottom && !selected.fullbody && !selected.outerwear)}
              className="w-full btn-primary py-3 rounded-xl font-bold flex items-center justify-center gap-2 disabled:opacity-50"
            >
              {videoLoading ? (
                <>
                  <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                  Video Olu≈üturuluyor...
                </>
              ) : (
                <>
                  <Icon name="video" size={18} />
                  Video Olu≈ütur (1 Token)
                </>
              )}
            </button>
          </div>
          
          {/* Video Result */}
          {videoResult && (
            <div className="glass rounded-2xl p-4">
              <h4 className="font-semibold mb-3 flex items-center gap-2">
                <Icon name="video" size={16} className="text-pink-400" />
                Son Video
              </h4>
              <video 
                src={videoResult} 
                controls 
                autoPlay 
                loop 
                className="w-full rounded-xl"
                style={{ maxHeight: '400px' }}
              />
              <div className="flex gap-2 mt-3">
                <a 
                  href={videoResult} 
                  download="trai-fashion-video.mp4"
                  className="flex-1 btn-secondary py-2 rounded-xl text-sm font-semibold flex items-center justify-center gap-2"
                >
                  <Icon name="download" size={16} />
                  ƒ∞ndir
                </a>
                <button 
                  onClick={() => setVideoResult(null)}
                  className="px-4 py-2 bg-white/10 rounded-xl text-sm"
                >
                  Kapat
                </button>
              </div>
            </div>
          )}
          
          {/* How it works */}
          <div className="mt-4 p-4 bg-gradient-to-br from-pink-500/10 to-purple-500/10 rounded-2xl border border-pink-500/20">
            <h4 className="font-semibold mb-3 flex items-center gap-2">
              <span>‚ú®</span> Nasƒ±l √áalƒ±≈üƒ±r?
            </h4>
            <div className="space-y-2 text-sm text-white/70">
              <p>1. √úr√ºnler sekmesinden kƒ±yafet se√ß</p>
              <p>2. Video sekmesine gel</p>
              <p>3. "Video Olu≈ütur" butonuna tƒ±kla</p>
              <p>4. 6 saniyelik profesyonel moda videonu indir!</p>
            </div>
          </div>
        </div>
      )}

      {/* COMBOS TAB */}
      {tab === 'combos' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {savedCombos.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                <Icon name="layers" size={28} className="text-white/30" />
              </div>
              <p className="font-semibold text-white/60">Kayƒ±tlƒ± Kombin Yok</p>
              <p className="text-sm text-white/40 mt-1">√úr√ºnler sekmesinden kombin olu≈ütur ve kaydet</p>
            </div>
          ) : (
            <div className="space-y-3">
              {savedCombos.map(combo => (
                <div key={combo.id} className="glass rounded-2xl p-4">
                  <div className="flex items-start justify-between mb-3">
                    <div>
                      <h4 className="font-semibold">{combo.name}</h4>
                      <p className="text-xs text-white/50">
                        {new Date(combo.createdAt).toLocaleDateString('tr-TR')} ‚Ä¢ {combo.background.name}
                      </p>
                    </div>
                    <button onClick={() => deleteCombo(combo.id)} className="p-2 rounded-xl hover:bg-red-500/20">
                      <Icon name="trash" size={16} className="text-red-400" />
                    </button>
                  </div>
                  <div className="flex gap-2 mb-3">
                    {combo.items.map((item, i) => (
                      <div key={i} className="w-16 h-16 rounded-xl overflow-hidden border border-white/10">
                        <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                      </div>
                    ))}
                  </div>
                  <button 
                    onClick={() => {
                      const top = combo.items.find(i => i.category === 'top');
                      const bottom = combo.items.find(i => i.category === 'bottom');
                      setSelected({ top: top || null, bottom: bottom || null });
                      setBg(combo.background);
                      setTab('items');
                    }}
                    className="w-full btn-secondary py-2.5 rounded-xl text-sm font-semibold flex items-center justify-center gap-2"
                  >
                    <Icon name="sparkles" size={14} />Dene
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* FAVORITES TAB */}
      {tab === 'favorites' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {favorites.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                <Icon name="heart" size={28} className="text-white/30" />
              </div>
              <p className="font-semibold text-white/60">Favori Yok</p>
              <p className="text-sm text-white/40 mt-1">Beƒüendiƒüin √ºr√ºnleri favorilere ekle</p>
            </div>
          ) : (
            <div className="grid grid-cols-2 gap-3">
              {favorites.map(item => (
                <div key={item.id} className="glass rounded-2xl overflow-hidden">
                  <div className="aspect-square relative">
                    <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                    <button 
                      onClick={() => toggleFavorite(item)}
                      className="absolute top-2 right-2 p-2 rounded-xl bg-black/50"
                    >
                      <Icon name="heartFilled" size={16} className="text-red-400" />
                    </button>
                  </div>
                  <div className="p-3">
                    <p className="text-xs text-white/50">{item.brandName}</p>
                    <p className="font-semibold text-sm truncate">{item.name}</p>
                    <p className="text-brand2 text-sm font-bold">{item.price}</p>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* HISTORY TAB */}
      {tab === 'history' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {tryHistory.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                <Icon name="clock" size={28} className="text-white/30" />
              </div>
              <p className="font-semibold text-white/60">Deneme Ge√ßmi≈üi Bo≈ü</p>
              <p className="text-sm text-white/40 mt-1">Kƒ±yafet denemelerin burada g√∂r√ºnecek</p>
            </div>
          ) : (
            <div className="space-y-3">
              {tryHistory.map(item => (
                <div key={item.id} className="glass rounded-2xl overflow-hidden">
                  <div className="aspect-[3/4] relative">
                    <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                    <div className="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/80 to-transparent">
                      <p className="text-xs text-white/70">
                        {new Date(item.createdAt).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}
                      </p>
                      <div className="flex gap-1 mt-1">
                        {item.items.map((it, i) => (
                          <span key={i} className="text-[10px] bg-white/20 px-2 py-0.5 rounded-full">{it.brandName}</span>
                        ))}
                      </div>
                    </div>
                  </div>
                  <div className="p-3 flex gap-2">
                    <button 
                      onClick={() => {
                        if (onShareToFeed) {
                          onShareToFeed(item.image, item.items || []);
                          setToast({ open: true, type: 'success', title: 'Payla≈üƒ±ldƒ±!', message: 'Sosyal akƒ±≈üta yayƒ±nlandƒ±' });
                        }
                      }}
                      className="flex-1 btn-primary py-2 rounded-xl text-xs font-semibold flex items-center justify-center gap-1"
                    >
                      <Icon name="users" size={12} />TrAi'de
                    </button>
                    <button 
                      onClick={() => shareImage(item.image)}
                      className="flex-1 btn-secondary py-2 rounded-xl text-xs font-semibold flex items-center justify-center gap-1"
                    >
                      <Icon name="share" size={12} />Harici
                    </button>
                    <button 
                      onClick={() => {
                        setTryHistory(prev => prev.filter(h => h.id !== item.id));
                      }}
                      className="px-3 rounded-xl bg-red-500/20 hover:bg-red-500/30"
                    >
                      <Icon name="trash" size={14} className="text-red-400" />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {loading && <FullscreenLoader 
        title={[selected.fullbody, selected.top, selected.bottom, selected.outerwear].filter(Boolean).length > 1 ? "Kombin Hazƒ±rlanƒ±yor" : "Deneme Hazƒ±rlanƒ±yor"} 
        subtitle="AI g√∂rsel olu≈üturuyor..." 
      />}
    </div>
  );
};

// ============ PROFILE (EXPANDED) ============
const Profile = ({ user, authUser, onResetAvatar, onLogout, onDeleteAccount, friends, setFriends, messages, setMessages, settings, setSettings }) => {
  const [tab, setTab] = useState('profile'); // profile, avatar, friends, settings, messages
  const [showAddFriend, setShowAddFriend] = useState(false);
  const [friendEmail, setFriendEmail] = useState('');
  const [selectedChat, setSelectedChat] = useState(null);
  const [newMessage, setNewMessage] = useState('');

  // Add friend
  const addFriend = () => {
    if (!friendEmail.trim()) return;
    const newFriend = {
      id: Date.now(),
      email: friendEmail,
      name: friendEmail.split('@')[0],
      avatar: null, // Will be loaded from their profile
      status: 'pending', // pending, accepted
      addedAt: Date.now()
    };
    setFriends(prev => [...prev, newFriend]);
    setFriendEmail('');
    setShowAddFriend(false);
  };

  const removeFriend = (id) => {
    if (confirm('Bu arkada≈üƒ± silmek istiyor musun?')) {
      setFriends(prev => prev.filter(f => f.id !== id));
    }
  };

  const sendMessage = () => {
    if (!newMessage.trim() || !selectedChat) return;
    const msg = {
      id: Date.now(),
      friendId: selectedChat.id,
      text: newMessage,
      sent: true,
      timestamp: Date.now()
    };
    setMessages(prev => [...prev, msg]);
    setNewMessage('');
  };

  const getChatMessages = (friendId) => messages.filter(m => m.friendId === friendId);

  const tabs = [
    { id: 'profile', icon: 'user', label: 'Profil' },
    { id: 'avatar', icon: 'sparkles', label: 'ƒ∞kizim' },
    { id: 'friends', icon: 'users', label: 'Arkada≈ülar' },
    { id: 'settings', icon: 'settings', label: 'Ayarlar' }
  ];

  // Physical attributes labels
  const bodyTypeLabels = {
    slim: 'ƒ∞nce', athletic: 'Atletik', average: 'Normal', curvy: 'Dolgun', plus: 'B√ºy√ºk Beden'
  };
  const skinToneLabels = {
    fair: '√áok A√ßƒ±k', light: 'A√ßƒ±k', medium: 'Buƒüday', olive: 'Zeytin', tan: 'Bronz', dark: 'Koyu'
  };
  const hairColorLabels = {
    black: 'Siyah', brown: 'Kahve', blonde: 'Sarƒ±', red: 'Kƒ±zƒ±l', gray: 'Gri'
  };
  const hairStyleLabels = {
    short: 'Kƒ±sa', medium: 'Orta', long: 'Uzun', curly: 'Kƒ±vƒ±rcƒ±k', wavy: 'Dalgalƒ±', bald: 'Kel'
  };

  return (
    <div className="h-full flex flex-col">
      {/* Profile Header - Face crop only */}
      <div className="relative h-40 flex-shrink-0 overflow-hidden">
        <div className="absolute inset-0 bg-gradient-to-br from-brand/30 to-brand2/30" />
        <div className="absolute inset-0 flex items-center justify-center">
          <div className="relative">
            <div className="w-24 h-24 rounded-full overflow-hidden border-4 border-brand2/50 shadow-lg">
              <img src={user.baseAvatar || user.avatar} className="w-full h-full object-cover object-top scale-150" />
            </div>
            {settings?.profilePublic && (
              <div className="absolute -bottom-1 -right-1 bg-green-500 p-1.5 rounded-full border-2 border-dark">
                <Icon name="globe" size={10} />
              </div>
            )}
          </div>
        </div>
        <div className="absolute bottom-3 left-0 right-0 text-center">
          <h1 className="text-lg font-bold">{user.gender === 'female' ? 'üë©' : 'üë®'} {authUser?.email?.split('@')[0] || 'Kullanƒ±cƒ±'}</h1>
          <p className="text-white/50 text-xs">Premium √úye ‚ú®</p>
        </div>
      </div>

      {/* Tab Navigation */}
      <div className="flex-shrink-0 px-4 py-3 border-b border-white/10">
        <div className="flex gap-1 bg-white/5 rounded-2xl p-1">
          {tabs.map(t => (
            <button
              key={t.id}
              onClick={() => setTab(t.id)}
              className={`flex-1 py-2.5 px-2 rounded-xl text-xs font-semibold flex items-center justify-center gap-1.5 transition ${
                tab === t.id ? 'bg-brand text-white' : 'text-white/50 hover:text-white/70'
              }`}
            >
              <Icon name={t.icon} size={14} />
              <span className="hidden sm:inline">{t.label}</span>
            </button>
          ))}
        </div>
      </div>

      {/* Tab Content */}
      <div className="flex-1 overflow-y-auto custom-scroll pb-24">
        {/* PROFILE TAB */}
        {tab === 'profile' && (
          <div className="p-4 space-y-4 fade-in">
            {/* Stats */}
            <div className="grid grid-cols-3 gap-3">
              <div className="glass rounded-2xl p-4 text-center">
                <div className="text-2xl font-bold text-brand2">{friends.length}</div>
                <div className="text-xs text-white/50">Arkada≈ü</div>
              </div>
              <div className="glass rounded-2xl p-4 text-center">
                <div className="text-2xl font-bold text-accent">{user.closetCount || 0}</div>
                <div className="text-xs text-white/50">Dolap</div>
              </div>
              <div className="glass rounded-2xl p-4 text-center">
                <div className="text-2xl font-bold text-green-400">{user.tryOnCount || 0}</div>
                <div className="text-xs text-white/50">Deneme</div>
              </div>
            </div>

            {/* Account Info */}
            <div className="glass rounded-2xl p-4 space-y-3">
              <h3 className="font-semibold text-sm flex items-center gap-2">
                <Icon name="user" size={16} className="text-brand2" />
                Hesap Bilgileri
              </h3>
              <div className="space-y-2">
                <div className="flex justify-between items-center py-2 border-b border-white/5">
                  <span className="text-white/50 text-sm">E-posta</span>
                  <span className="text-sm font-medium">{authUser?.email || '-'}</span>
                </div>
                <div className="flex justify-between items-center py-2 border-b border-white/5">
                  <span className="text-white/50 text-sm">√úyelik</span>
                  <span className="text-sm font-medium text-brand2">Premium ‚ú®</span>
                </div>
                <div className="flex justify-between items-center py-2">
                  <span className="text-white/50 text-sm">Katƒ±lƒ±m</span>
                  <span className="text-sm font-medium">{new Date(user.createdAt).toLocaleDateString('tr-TR')}</span>
                </div>
              </div>
            </div>

            {/* Quick Actions */}
            <div className="glass rounded-2xl p-4 space-y-3">
              <h3 className="font-semibold text-sm flex items-center gap-2">
                <Icon name="sparkles" size={16} className="text-accent" />
                Hƒ±zlƒ± ƒ∞≈ülemler
              </h3>
              <button onClick={() => setTab('avatar')} className="w-full btn-secondary py-3 rounded-xl font-semibold flex items-center justify-center gap-2 text-sm">
                <Icon name="user" size={16} />Sanal ƒ∞kizimi G√∂r√ºnt√ºle
              </button>
            </div>

            {/* Logout */}
            <button onClick={onLogout} className="w-full bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-400 py-4 rounded-xl font-semibold flex items-center justify-center gap-2">
              <Icon name="logout" size={18} />√áƒ±kƒ±≈ü Yap
            </button>
          </div>
        )}

        {/* AVATAR TAB - Sanal ƒ∞kizim */}
        {tab === 'avatar' && (
          <div className="p-4 space-y-4 fade-in">
            {/* Full Body Avatar */}
            <div className="glass rounded-3xl overflow-hidden">
              <div className="aspect-[3/4] relative bg-gradient-to-b from-white/5 to-transparent">
                <img src={user.baseAvatar || user.avatar} className="w-full h-full object-contain" />
                <div className="absolute top-3 right-3 bg-brand2/90 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1">
                  <Icon name="sparkles" size={12} />Full Body
                </div>
              </div>
            </div>

            {/* Physical Attributes */}
            <div className="glass rounded-2xl p-4 space-y-4">
              <div className="flex items-center justify-between">
                <h3 className="font-semibold text-sm flex items-center gap-2">
                  <Icon name="user" size={16} className="text-brand2" />
                  Fiziksel √ñzellikler
                </h3>
                <span className="text-xs text-white/40">D√ºzenlemek i√ßin avatarƒ± yenile</span>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <div className="bg-white/5 rounded-xl p-3">
                  <div className="text-xs text-white/50 mb-1">Cinsiyet</div>
                  <div className="font-semibold">{user.gender === 'female' ? 'üë© Kadƒ±n' : 'üë® Erkek'}</div>
                </div>
                <div className="bg-white/5 rounded-xl p-3">
                  <div className="text-xs text-white/50 mb-1">Ya≈ü</div>
                  <div className="font-semibold">{user.age} ya≈üƒ±nda</div>
                </div>
                <div className="bg-white/5 rounded-xl p-3">
                  <div className="text-xs text-white/50 mb-1">Boy</div>
                  <div className="font-semibold">{user.height} cm</div>
                </div>
                <div className="bg-white/5 rounded-xl p-3">
                  <div className="text-xs text-white/50 mb-1">Kilo</div>
                  <div className="font-semibold">{user.weight} kg</div>
                </div>
              </div>

              <div className="space-y-2">
                <div className="flex justify-between items-center py-2 border-b border-white/5">
                  <span className="text-white/50 text-sm">V√ºcut Tipi</span>
                  <span className="text-sm font-medium">{bodyTypeLabels[user.bodyType] || user.bodyType}</span>
                </div>
                <div className="flex justify-between items-center py-2 border-b border-white/5">
                  <span className="text-white/50 text-sm">Ten Rengi</span>
                  <span className="text-sm font-medium">{skinToneLabels[user.skinTone] || user.skinTone}</span>
                </div>
                <div className="flex justify-between items-center py-2 border-b border-white/5">
                  <span className="text-white/50 text-sm">Sa√ß Rengi</span>
                  <span className="text-sm font-medium">{hairColorLabels[user.hairColor] || user.hairColor}</span>
                </div>
                <div className="flex justify-between items-center py-2">
                  <span className="text-white/50 text-sm">Sa√ß Stili</span>
                  <span className="text-sm font-medium">{hairStyleLabels[user.hairStyle] || user.hairStyle}</span>
                </div>
              </div>
            </div>

            {/* Refresh Avatar Button */}
            <button onClick={onResetAvatar} className="w-full btn-primary py-4 rounded-xl font-semibold flex items-center justify-center gap-2">
              <Icon name="refresh" size={18} />Avatarƒ± Yeniden Olu≈ütur
            </button>
            
            <p className="text-center text-xs text-white/40">
              Avatarƒ±nƒ± yeniden olu≈üturmak i√ßin yeni fotoƒüraflar √ßekmen gerekecek
            </p>
          </div>
        )}

        {/* FRIENDS TAB */}
        {tab === 'friends' && (
          <div className="p-4 space-y-4 fade-in">
            {/* Add Friend Button */}
            <button onClick={() => setShowAddFriend(true)} className="w-full btn-primary py-4 rounded-xl font-semibold flex items-center justify-center gap-2">
              <Icon name="userPlus" size={18} />Arkada≈ü Ekle
            </button>

            {/* Friends List */}
            {friends.length === 0 ? (
              <div className="text-center py-12">
                <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                  <Icon name="users" size={28} className="text-white/30" />
                </div>
                <p className="font-semibold text-white/60">Hen√ºz arkada≈üƒ±n yok</p>
                <p className="text-sm text-white/40 mt-1">Arkada≈ü ekleyerek kombinlerini payla≈ü</p>
              </div>
            ) : (
              <div className="space-y-2">
                {friends.map(friend => (
                  <div key={friend.id} className="glass rounded-2xl p-4 flex items-center gap-3">
                    <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-brand to-brand2 flex items-center justify-center">
                      {friend.avatar ? (
                        <img src={friend.avatar} className="w-full h-full rounded-xl object-cover" />
                      ) : (
                        <span className="text-lg">üë§</span>
                      )}
                    </div>
                    <div className="flex-1">
                      <div className="font-semibold">{friend.name}</div>
                      <div className="text-xs text-white/50">{friend.email}</div>
                    </div>
                    <div className="flex items-center gap-2">
                      {friend.status === 'pending' && (
                        <span className="text-xs text-amber-400 bg-amber-500/20 px-2 py-1 rounded-lg">Bekliyor</span>
                      )}
                      <button onClick={() => setSelectedChat(friend)} className="p-2 rounded-xl hover:bg-white/10">
                        <Icon name="messageCircle" size={18} className="text-brand2" />
                      </button>
                      <button onClick={() => removeFriend(friend.id)} className="p-2 rounded-xl hover:bg-red-500/20">
                        <Icon name="userMinus" size={18} className="text-red-400" />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Add Friend Modal */}
            {showAddFriend && (
              <div className="fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4">
                <div className="w-full max-w-sm glass rounded-3xl p-6 scale-in">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-lg">Arkada≈ü Ekle</h3>
                    <button onClick={() => setShowAddFriend(false)} className="p-2 rounded-xl hover:bg-white/10">
                      <Icon name="x" size={20} />
                    </button>
                  </div>
                  <p className="text-sm text-white/50 mb-4">Arkada≈üƒ±nƒ±n e-posta adresini gir</p>
                  <input
                    type="email"
                    value={friendEmail}
                    onChange={e => setFriendEmail(e.target.value)}
                    placeholder="arkadas@mail.com"
                    className="mb-4"
                  />
                  <div className="flex gap-3">
                    <button onClick={() => setShowAddFriend(false)} className="flex-1 btn-ghost py-3 rounded-xl font-semibold">ƒ∞ptal</button>
                    <button onClick={addFriend} className="flex-1 btn-primary py-3 rounded-xl font-semibold">Ekle</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* MESSAGES TAB */}
        {tab === 'messages' && (
          <div className="h-full flex flex-col fade-in">
            {!selectedChat ? (
              // Chat List
              <div className="p-4 space-y-2">
                {friends.length === 0 ? (
                  <div className="text-center py-12">
                    <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                      <Icon name="messageCircle" size={28} className="text-white/30" />
                    </div>
                    <p className="font-semibold text-white/60">Mesaj yok</p>
                    <p className="text-sm text-white/40 mt-1">√ñnce arkada≈ü ekle</p>
                  </div>
                ) : (
                  friends.map(friend => {
                    const lastMsg = getChatMessages(friend.id).slice(-1)[0];
                    return (
                      <button
                        key={friend.id}
                        onClick={() => setSelectedChat(friend)}
                        className="w-full glass rounded-2xl p-4 flex items-center gap-3 text-left hover:bg-white/5 transition"
                      >
                        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-brand to-brand2 flex items-center justify-center">
                          <span className="text-lg">üë§</span>
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="font-semibold">{friend.name}</div>
                          <div className="text-xs text-white/50 truncate">
                            {lastMsg ? lastMsg.text : 'Hen√ºz mesaj yok'}
                          </div>
                        </div>
                        <Icon name="chevronRight" size={18} className="text-white/30" />
                      </button>
                    );
                  })
                )}
              </div>
            ) : (
              // Chat View
              <div className="flex flex-col h-full">
                {/* Chat Header */}
                <div className="p-4 border-b border-white/10 flex items-center gap-3">
                  <button onClick={() => setSelectedChat(null)} className="p-2 -ml-2 rounded-xl hover:bg-white/10">
                    <Icon name="chevronLeft" size={20} />
                  </button>
                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-brand to-brand2 flex items-center justify-center">
                    <span>üë§</span>
                  </div>
                  <div>
                    <div className="font-semibold">{selectedChat.name}</div>
                    <div className="text-xs text-white/50">√áevrimi√ßi</div>
                  </div>
                </div>

                {/* Messages */}
                <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-3">
                  {getChatMessages(selectedChat.id).length === 0 ? (
                    <div className="text-center py-8 text-white/40 text-sm">
                      Hen√ºz mesaj yok. ƒ∞lk mesajƒ± sen g√∂nder!
                    </div>
                  ) : (
                    getChatMessages(selectedChat.id).map(msg => (
                      <div key={msg.id} className={`flex ${msg.sent ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[80%] px-4 py-2.5 rounded-2xl ${
                          msg.sent ? 'bg-brand text-white rounded-br-md' : 'glass rounded-bl-md'
                        }`}>
                          <p className="text-sm">{msg.text}</p>
                          <p className="text-[10px] opacity-50 mt-1">
                            {new Date(msg.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                          </p>
                        </div>
                      </div>
                    ))
                  )}
                </div>

                {/* Message Input */}
                <div className="p-4 border-t border-white/10 flex gap-3">
                  <input
                    type="text"
                    value={newMessage}
                    onChange={e => setNewMessage(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && sendMessage()}
                    placeholder="Mesaj yaz..."
                    className="flex-1"
                  />
                  <button onClick={sendMessage} className="btn-primary px-5 rounded-xl">
                    <Icon name="send" size={18} />
                  </button>
                </div>
              </div>
            )}
          </div>
        )}

        {/* SETTINGS TAB */}
        {tab === 'settings' && (
          <div className="p-4 space-y-4 fade-in">
            {/* Privacy Settings */}
            <div className="glass rounded-2xl p-4 space-y-4">
              <h3 className="font-semibold text-sm flex items-center gap-2">
                <Icon name="shield" size={16} className="text-brand2" />
                Gizlilik Ayarlarƒ±
              </h3>

              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">Profil G√∂r√ºn√ºrl√ºƒü√º</div>
                  <div className="text-xs text-white/50">Profilini herkes g√∂rebilsin</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, profilePublic: !s.profilePublic }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.profilePublic ? 'bg-brand' : 'bg-white/10'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.profilePublic ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>

              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">Kombinleri Payla≈ü</div>
                  <div className="text-xs text-white/50">Kombinlerin arkada≈ülarƒ±na g√∂r√ºns√ºn</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, combosPublic: !s.combosPublic }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.combosPublic ? 'bg-brand' : 'bg-white/10'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.combosPublic ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>

              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">√áevrimi√ßi Durumu</div>
                  <div className="text-xs text-white/50">Aktif olduƒüunda g√∂r√ºns√ºn</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, showOnline: !s.showOnline }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.showOnline ? 'bg-brand' : 'bg-white/10'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.showOnline ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>
            </div>

            {/* Notification Settings */}
            <div className="glass rounded-2xl p-4 space-y-4">
              <h3 className="font-semibold text-sm flex items-center gap-2">
                <Icon name="bell" size={16} className="text-accent" />
                Bildirimler
              </h3>

              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">Mesaj Bildirimleri</div>
                  <div className="text-xs text-white/50">Yeni mesajlarda bildirim al</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, notifyMessages: !s.notifyMessages }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.notifyMessages ? 'bg-brand' : 'bg-white/10'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.notifyMessages ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>

              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">Arkada≈ü ƒ∞stekleri</div>
                  <div className="text-xs text-white/50">Yeni isteklerde bildirim al</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, notifyFriends: !s.notifyFriends }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.notifyFriends ? 'bg-brand' : 'bg-white/10'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.notifyFriends ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>
              <div className="flex items-center justify-between py-2">
                <div>
                  <div className="font-medium text-sm">G√ºnl√ºk Kombin √ñnerisi</div>
                  <div className="text-xs text-white/50">Sabah 9'da hava durumuna g√∂re √∂neri</div>
                </div>
                <button
                  onClick={() => setSettings(s => ({ ...s, notifyDailyOutfit: !s.notifyDailyOutfit }))}
                  className={`w-12 h-7 rounded-full transition-all ${settings.notifyDailyOutfit ? 'bg-brand' : 'bg-white/10'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${settings.notifyDailyOutfit ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>
            </div>

            {/* App Info */}
            <div className="glass rounded-2xl p-4 space-y-3">
              <h3 className="font-semibold text-sm flex items-center gap-2">
                <Icon name="info" size={16} className="text-white/50" />
                Uygulama
              </h3>
              <div className="flex justify-between items-center py-2 border-b border-white/5">
                <span className="text-white/50 text-sm">Versiyon</span>
                <span className="text-sm font-medium">1.0.0</span>
              </div>
              <div className="flex justify-between items-center py-2">
                <span className="text-white/50 text-sm">Geli≈ütirici</span>
                <span className="text-sm font-medium">TrAi Technologies</span>
              </div>
            </div>

            {/* Danger Zone */}
            <div className="glass rounded-2xl p-4 border border-red-500/20">
              <h3 className="font-semibold text-sm text-red-400 mb-3 flex items-center gap-2">
                <Icon name="trash" size={16} />
                Tehlikeli B√∂lge
              </h3>
              
              {/* Clear Local Data */}
              <div className="mb-4 pb-4 border-b border-white/10">
                <p className="text-xs text-white/50 mb-2">Tarayƒ±cƒ±daki √∂nbellek ve ge√ßmi≈ü verilerini temizle (hesap silinmez).</p>
                <button 
                  onClick={() => {
                    if (confirm('Yerel √∂nbellek ve ge√ßmi≈ü silinsin mi? (Hesabƒ±n silinmez)')) {
                      if (authUser) {
                        localStorage.removeItem(`trai_tryoncache_${authUser.uid}`);
                        localStorage.removeItem(`trai_history_${authUser.uid}`);
                      }
                      window.location.reload();
                    }
                  }}
                  className="w-full bg-orange-500/10 hover:bg-orange-500/20 border border-orange-500/20 text-orange-400 py-2.5 rounded-xl text-sm font-semibold flex items-center justify-center gap-2"
                >
                  <Icon name="trash" size={14} />
                  √ñnbelleƒüi Temizle
                </button>
              </div>
              
              {/* Delete Account */}
              <p className="text-xs text-white/50 mb-3">Hesabƒ±nƒ± sildiƒüinde t√ºm veriler (avatar, dolap, ge√ßmi≈ü) kalƒ±cƒ± olarak silinir. Bu i≈ülem geri alƒ±namaz.</p>
              <button 
                onClick={onDeleteAccount}
                className="w-full bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-400 py-3 rounded-xl text-sm font-semibold flex items-center justify-center gap-2"
              >
                <Icon name="trash" size={16} />
                Hesabƒ±mƒ± Kalƒ±cƒ± Olarak Sil
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// ============ MODALS ============
const ResultModal = ({ open, image, item, items, onClose, onShare, onShareToFeed }) => {
  const [showShareOptions, setShowShareOptions] = useState(false);
  
  if (!open || !image) return null;
  return (
    <div className="fixed inset-0 z-[80] bg-black/90 flex flex-col slide-up">
      <div className="p-4 flex items-center justify-between border-b border-white/10">
        <h3 className="font-bold flex items-center gap-2"><Icon name="sparkles" size={18} className="text-accent" />Sonu√ß</h3>
        <button onClick={onClose} className="p-2"><Icon name="x" /></button>
      </div>
      <div className="flex-1 overflow-auto custom-scroll p-4">
        <img src={image} className="w-full rounded-2xl shadow-soft" />
        {item && (
          <div className="mt-3 glass rounded-xl p-3">
            <p className="text-xs text-white/50">{item.brandName}</p>
            <p className="font-bold">{item.name}</p>
            <p className="text-brand2 text-sm">{item.price}</p>
          </div>
        )}
        {items && items.length > 0 && (
          <div className="mt-3 glass rounded-xl p-3">
            <p className="text-xs text-white/50 mb-2">Kombin ({items.length} par√ßa)</p>
            <div className="flex gap-2 flex-wrap">
              {items.map((i, idx) => (
                <div key={idx} className="flex items-center gap-2 bg-white/5 rounded-lg px-2 py-1">
                  <img src={i.image} className="w-8 h-8 rounded object-cover" />
                  <span className="text-xs">{i.name}</span>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
      <div className="p-4 border-t border-white/10 space-y-2 safe-bottom">
        {showShareOptions ? (
          <>
            <button 
              onClick={() => { onShareToFeed(); setShowShareOptions(false); }}
              className="w-full btn-primary py-4 rounded-2xl font-bold flex items-center justify-center gap-2"
            >
              <Icon name="users" size={18} />TrAi'de Payla≈ü
            </button>
            <button 
              onClick={() => { onShare(); setShowShareOptions(false); }}
              className="w-full btn-secondary py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
            >
              <Icon name="share" size={16} />Harici Payla≈ü
            </button>
            <button 
              onClick={() => setShowShareOptions(false)}
              className="w-full btn-ghost py-2 rounded-xl text-sm text-white/50"
            >
              ƒ∞ptal
            </button>
          </>
        ) : (
          <button 
            onClick={() => setShowShareOptions(true)} 
            className="w-full btn-primary py-4 rounded-2xl font-bold flex items-center justify-center gap-2"
          >
            <Icon name="share" size={18} />Payla≈ü
          </button>
        )}
      </div>
    </div>
  );
};

const AdviceModal = ({ open, item, advice, loading, onClose }) => {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-[80] bg-black/90 flex flex-col slide-up">
      <div className="p-4 flex items-center justify-between border-b border-white/10">
        <h3 className="font-bold flex items-center gap-2"><Icon name="sparkles" size={18} className="text-accent" />Stil Tavsiyesi</h3>
        <button onClick={onClose} className="p-2"><Icon name="x" /></button>
      </div>
      <div className="flex-1 overflow-auto custom-scroll p-4">
        <div className="flex gap-3 mb-4">
          <div className="w-20 h-28 rounded-xl overflow-hidden"><img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" /></div>
          <div>
            <p className="text-xs text-white/50">{item.brandName}</p>
            <p className="font-bold">{item.name}</p>
            <p className="text-brand2 text-sm">{item.price}</p>
          </div>
        </div>
        <div className="bg-brand/10 border border-brand/20 rounded-2xl p-4">
          {loading ? (
            <div className="flex items-center gap-2 text-white/60"><div className="w-4 h-4 border-2 border-brand border-t-transparent rounded-full animate-spin" />Analiz ediliyor...</div>
          ) : (
            <p className="text-sm leading-relaxed whitespace-pre-wrap">{advice}</p>
          )}
        </div>
      </div>
      <div className="p-4 border-t border-white/10">
        <button onClick={onClose} className="w-full btn-ghost py-4 rounded-2xl font-bold">Kapat</button>
      </div>
    </div>
  );
};

// ============ SOCIAL FEED ============
const SocialFeed = ({ user, authUser, friends, posts, setPosts, setToast }) => {
  const [tab, setTab] = useState('feed'); // feed, myPosts, create
  const [selectedImage, setSelectedImage] = useState(null);
  const [caption, setCaption] = useState('');
  const [askFeedback, setAskFeedback] = useState(false);
  const [visibility, setVisibility] = useState('public'); // public, friends, private
  const [posting, setPosting] = useState(false);
  const [selectedPost, setSelectedPost] = useState(null);
  const [comment, setComment] = useState('');
  const [shareModal, setShareModal] = useState({ open: false, post: null });

  const myPosts = posts.filter(p => p.authorId === authUser?.uid);
  const feedPosts = posts.filter(p => 
    p.visibility === 'public' || 
    (p.visibility === 'friends' && friends.some(f => f.id === p.authorId)) ||
    p.authorId === authUser?.uid
  ).sort((a, b) => b.createdAt - a.createdAt);

  const createPost = () => {
    if (!selectedImage) {
      setToast({ open: true, type: 'error', title: 'G√∂rsel Yok', message: 'Payla≈ümak i√ßin bir g√∂rsel se√ß' });
      return;
    }
    setPosting(true);
    
    const newPost = {
      id: Date.now(),
      authorId: authUser?.uid,
      authorName: authUser?.email?.split('@')[0] || 'Kullanƒ±cƒ±',
      authorAvatar: user.baseAvatar || user.avatar,
      image: selectedImage,
      caption: caption,
      askFeedback: askFeedback,
      visibility: visibility,
      likes: [],
      comments: [],
      createdAt: Date.now()
    };
    
    setPosts(prev => [newPost, ...prev]);
    setSelectedImage(null);
    setCaption('');
    setAskFeedback(false);
    setTab('myPosts');
    setPosting(false);
    setToast({ open: true, type: 'success', title: 'Payla≈üƒ±ldƒ±!', message: 'G√∂nderin yayƒ±nlandƒ±' });
  };

  const likePost = (postId) => {
    setPosts(prev => prev.map(p => {
      if (p.id === postId) {
        const hasLiked = p.likes.includes(authUser?.uid);
        return {
          ...p,
          likes: hasLiked 
            ? p.likes.filter(id => id !== authUser?.uid)
            : [...p.likes, authUser?.uid]
        };
      }
      return p;
    }));
  };

  const addComment = (postId) => {
    if (!comment.trim()) return;
    setPosts(prev => prev.map(p => {
      if (p.id === postId) {
        return {
          ...p,
          comments: [...p.comments, {
            id: Date.now(),
            authorId: authUser?.uid,
            authorName: authUser?.email?.split('@')[0] || 'Kullanƒ±cƒ±',
            text: comment,
            createdAt: Date.now()
          }]
        };
      }
      return p;
    }));
    setComment('');
  };

  const deletePost = (postId) => {
    if (confirm('Bu g√∂nderiyi silmek istiyor musun?')) {
      setPosts(prev => prev.filter(p => p.id !== postId));
      setSelectedPost(null);
    }
  };

  const shareExternal = async (platform, post) => {
    const text = `${post.caption || 'TrAi ile denedim!'} #TrAi #VirtualTryOn #Fashion`;
    const url = 'https://trai.app';
    
    if (platform === 'native' && navigator.share) {
      try {
        const response = await fetch(post.image);
        const blob = await response.blob();
        const file = new File([blob], 'trai-outfit.png', { type: 'image/png' });
        await navigator.share({
          title: 'TrAi - Sanal Deneme',
          text: text,
          files: [file]
        });
      } catch (e) {
        // Fallback to URL share
        await navigator.share({ title: 'TrAi', text: text, url: url });
      }
    } else if (platform === 'instagram') {
      // Instagram'a y√∂nlendir - g√∂rseli indirmesi gerekiyor
      const link = document.createElement('a');
      link.href = post.image;
      link.download = 'trai-outfit.png';
      link.click();
      setToast({ open: true, type: 'success', title: 'ƒ∞ndirildi', message: 'G√∂rseli Instagram\'da payla≈üabilirsin' });
    } else if (platform === 'twitter') {
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank', 'noopener,noreferrer');
    } else if (platform === 'facebook') {
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`, '_blank', 'noopener,noreferrer');
    } else if (platform === 'whatsapp') {
      window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank', 'noopener,noreferrer');
    }
    
    setShareModal({ open: false, post: null });
  };

  const tabs = [
    { id: 'feed', icon: 'globe', label: 'Akƒ±≈ü' },
    { id: 'myPosts', icon: 'image', label: 'Payla≈üƒ±mlarƒ±m' },
    { id: 'create', icon: 'plusCircle', label: 'Payla≈ü' }
  ];

  const PostCard = ({ post, showActions = true }) => {
    const isLiked = post.likes.includes(authUser?.uid);
    const isOwner = post.authorId === authUser?.uid;
    const timeAgo = getTimeAgo(post.createdAt);

    return (
      <div className="glass rounded-2xl overflow-hidden fade-in">
        {/* Header */}
        <div className="p-3 flex items-center gap-3">
          <div className="w-10 h-10 rounded-xl overflow-hidden bg-gradient-to-br from-brand to-brand2">
            {post.authorAvatar ? (
              <img src={post.authorAvatar} className="w-full h-full object-cover" />
            ) : (
              <div className="w-full h-full flex items-center justify-center text-lg">üë§</div>
            )}
          </div>
          <div className="flex-1">
            <p className="font-semibold text-sm">{post.authorName}</p>
            <p className="text-xs text-white/40">{timeAgo}</p>
          </div>
          {post.askFeedback && (
            <span className="text-xs bg-accent/20 text-accent px-2 py-1 rounded-lg font-medium">
              üí¨ Fikir ƒ∞stiyor
            </span>
          )}
          {isOwner && (
            <button onClick={() => setSelectedPost(post)} className="p-2 rounded-xl hover:bg-white/10">
              <Icon name="moreHorizontal" size={18} />
            </button>
          )}
        </div>

        {/* Image */}
        <div className="aspect-[3/4] relative">
          <img src={post.image} className="w-full h-full object-cover" />
          <div className="absolute bottom-2 right-2 flex gap-2">
            <span className="text-xs bg-black/60 backdrop-blur px-2 py-1 rounded-lg">
              {post.visibility === 'public' ? 'üåç Herkese A√ßƒ±k' : post.visibility === 'friends' ? 'üë• Arkada≈ülar' : 'üîí √ñzel'}
            </span>
          </div>
        </div>

        {/* Actions */}
        {showActions && (
          <div className="p-3 space-y-3">
            <div className="flex items-center gap-4">
              <button onClick={() => likePost(post.id)} className="flex items-center gap-1.5 text-sm">
                <Icon name={isLiked ? 'heartFilled' : 'heart'} size={22} className={isLiked ? 'text-red-400' : ''} />
                <span className="font-medium">{post.likes.length}</span>
              </button>
              <button onClick={() => setSelectedPost(post)} className="flex items-center gap-1.5 text-sm">
                <Icon name="messageCircle" size={22} />
                <span className="font-medium">{post.comments.length}</span>
              </button>
              <button onClick={() => setShareModal({ open: true, post })} className="flex items-center gap-1.5 text-sm">
                <Icon name="share" size={20} />
              </button>
              <div className="flex-1" />
              <button onClick={() => {
                const isSaved = favorites?.some(f => f.postId === post.id);
                // Toggle save
              }} className="p-1">
                <Icon name="bookmark" size={20} />
              </button>
            </div>

            {post.caption && (
              <p className="text-sm">
                <span className="font-semibold">{post.authorName}</span>{' '}
                <span className="text-white/80">{post.caption}</span>
              </p>
            )}

            {post.comments.length > 0 && (
              <button onClick={() => setSelectedPost(post)} className="text-xs text-white/50">
                {post.comments.length} yorumun t√ºm√ºn√º g√∂r
              </button>
            )}
          </div>
        )}
      </div>
    );
  };

  const getTimeAgo = (timestamp) => {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return 'Az √∂nce';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}dk`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}sa`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days}g`;
    return new Date(timestamp).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
  };

  return (
    <div className="h-full flex flex-col">
      {/* Tab Navigation */}
      <div className="flex-shrink-0 px-4 py-3 border-b border-white/10">
        <div className="flex gap-1 bg-white/5 rounded-2xl p-1">
          {tabs.map(t => (
            <button
              key={t.id}
              onClick={() => setTab(t.id)}
              className={`flex-1 py-2.5 px-2 rounded-xl text-xs font-semibold flex items-center justify-center gap-1.5 transition ${
                tab === t.id ? 'bg-brand text-white' : 'text-white/50 hover:text-white/70'
              }`}
            >
              <Icon name={t.icon} size={14} />
              {t.label}
            </button>
          ))}
        </div>
      </div>

      {/* FEED TAB */}
      {tab === 'feed' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24 space-y-4">
          {feedPosts.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                <Icon name="globe" size={28} className="text-white/30" />
              </div>
              <p className="font-semibold text-white/60">Akƒ±≈ü Bo≈ü</p>
              <p className="text-sm text-white/40 mt-1">ƒ∞lk g√∂nderiyi sen payla≈ü!</p>
              <button onClick={() => setTab('create')} className="btn-primary px-6 py-2.5 rounded-xl mt-4 text-sm font-semibold">
                Payla≈ü
              </button>
            </div>
          ) : (
            feedPosts.map(post => <PostCard key={post.id} post={post} />)
          )}
        </div>
      )}

      {/* MY POSTS TAB */}
      {tab === 'myPosts' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24">
          {myPosts.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-16 h-16 rounded-2xl glass flex items-center justify-center mx-auto mb-4">
                <Icon name="image" size={28} className="text-white/30" />
              </div>
              <p className="font-semibold text-white/60">Hen√ºz Payla≈üƒ±mƒ±n Yok</p>
              <p className="text-sm text-white/40 mt-1">Kombinlerini payla≈üarak ba≈üla</p>
              <button onClick={() => setTab('create')} className="btn-primary px-6 py-2.5 rounded-xl mt-4 text-sm font-semibold">
                ƒ∞lk Payla≈üƒ±mƒ±nƒ± Yap
              </button>
            </div>
          ) : (
            <div className="grid grid-cols-3 gap-1">
              {myPosts.map(post => (
                <button
                  key={post.id}
                  onClick={() => setSelectedPost(post)}
                  className="aspect-square relative overflow-hidden rounded-lg"
                >
                  <img src={post.image} className="w-full h-full object-cover" />
                  <div className="absolute inset-0 bg-black/0 hover:bg-black/30 transition flex items-center justify-center opacity-0 hover:opacity-100">
                    <div className="flex gap-3 text-white text-sm">
                      <span className="flex items-center gap-1"><Icon name="heart" size={14} />{post.likes.length}</span>
                      <span className="flex items-center gap-1"><Icon name="messageCircle" size={14} />{post.comments.length}</span>
                    </div>
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>
      )}

      {/* CREATE TAB */}
      {tab === 'create' && (
        <div className="flex-1 overflow-y-auto custom-scroll p-4 pb-24 space-y-4">
          <h3 className="font-bold text-lg">Yeni Payla≈üƒ±m</h3>
          
          {/* Image Selection */}
          {!selectedImage ? (
            <div className="space-y-3">
              <p className="text-sm text-white/50">Payla≈ümak istediƒüin g√∂rseli se√ß</p>
              
              {/* From Try History */}
              <div className="glass rounded-2xl p-4">
                <p className="text-xs text-white/40 mb-3 font-semibold">üì∏ Deneme Ge√ßmi≈üinden</p>
                <div className="grid grid-cols-4 gap-2 max-h-48 overflow-y-auto">
                  {(window.tryHistoryRef || []).slice(0, 12).map((item, i) => (
                    <button
                      key={i}
                      onClick={() => setSelectedImage(item.image)}
                      className="aspect-square rounded-xl overflow-hidden border-2 border-transparent hover:border-brand2 transition"
                    >
                      <img src={item.image} crossOrigin="anonymous" className="w-full h-full object-cover" />
                    </button>
                  ))}
                </div>
                {(!window.tryHistoryRef || window.tryHistoryRef.length === 0) && (
                  <p className="text-xs text-white/30 text-center py-4">Hen√ºz deneme yok</p>
                )}
              </div>

              {/* From Avatar */}
              <button
                onClick={() => setSelectedImage(user.baseAvatar || user.avatar)}
                className="w-full glass rounded-2xl p-4 flex items-center gap-4 hover:bg-white/5 transition"
              >
                <div className="w-16 h-20 rounded-xl overflow-hidden">
                  <img src={user.baseAvatar || user.avatar} className="w-full h-full object-cover" />
                </div>
                <div className="text-left">
                  <p className="font-semibold">Avatarƒ±nƒ± Payla≈ü</p>
                  <p className="text-xs text-white/50">Dijital ikizini g√∂ster</p>
                </div>
              </button>

              {/* Upload */}
              <label className="w-full glass rounded-2xl p-4 flex items-center justify-center gap-3 cursor-pointer hover:bg-white/5 transition">
                <Icon name="upload" size={20} className="text-brand2" />
                <span className="font-semibold">Galeriden Y√ºkle</span>
                <input
                  type="file"
                  accept="image/*"
                  className="hidden"
                  onChange={e => {
                    const file = e.target.files?.[0];
                    if (file) {
                      const reader = new FileReader();
                      reader.onload = (ev) => setSelectedImage(ev.target?.result);
                      reader.readAsDataURL(file);
                    }
                  }}
                />
              </label>
            </div>
          ) : (
            <>
              {/* Preview */}
              <div className="relative">
                <div className="aspect-[3/4] rounded-2xl overflow-hidden">
                  <img src={selectedImage} className="w-full h-full object-cover" />
                </div>
                <button
                  onClick={() => setSelectedImage(null)}
                  className="absolute top-2 right-2 p-2 rounded-xl bg-black/60 backdrop-blur"
                >
                  <Icon name="x" size={18} />
                </button>
              </div>

              {/* Caption */}
              <div>
                <label className="text-xs text-white/50 mb-1.5 block">A√ßƒ±klama</label>
                <textarea
                  value={caption}
                  onChange={e => setCaption(e.target.value)}
                  placeholder="Bu kombini nasƒ±l buldunuz? üí´"
                  rows={3}
                  className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm resize-none focus:outline-none focus:border-brand2"
                />
              </div>

              {/* Ask Feedback Toggle */}
              <div className="flex items-center justify-between p-4 rounded-2xl glass">
                <div>
                  <p className="font-medium text-sm">Fikir ƒ∞ste</p>
                  <p className="text-xs text-white/50">Arkada≈ülarƒ±ndan yorum al</p>
                </div>
                <button
                  onClick={() => setAskFeedback(!askFeedback)}
                  className={`w-12 h-7 rounded-full transition-all ${askFeedback ? 'bg-accent' : 'bg-white/10'}`}
                >
                  <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${askFeedback ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>

              {/* Visibility */}
              <div className="space-y-2">
                <p className="text-xs text-white/50 font-semibold">Kimler G√∂rs√ºn?</p>
                <div className="grid grid-cols-3 gap-2">
                  {[
                    { id: 'public', icon: 'globe', label: 'Herkes' },
                    { id: 'friends', icon: 'users', label: 'Arkada≈ülar' },
                    { id: 'private', icon: 'lock', label: 'Sadece Ben' }
                  ].map(v => (
                    <button
                      key={v.id}
                      onClick={() => setVisibility(v.id)}
                      className={`py-3 rounded-xl text-xs font-semibold flex flex-col items-center gap-1.5 transition ${
                        visibility === v.id ? 'bg-brand text-white' : 'glass text-white/60'
                      }`}
                    >
                      <Icon name={v.icon} size={18} />
                      {v.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Share Buttons */}
              <div className="space-y-3 pt-2">
                <button
                  onClick={createPost}
                  disabled={posting}
                  className="w-full btn-primary py-4 rounded-2xl font-bold flex items-center justify-center gap-2 disabled:opacity-50"
                >
                  {posting ? (
                    <><div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />Payla≈üƒ±lƒ±yor...</>
                  ) : (
                    <><Icon name="send" size={18} />Uygulama ƒ∞√ßinde Payla≈ü</>
                  )}
                </button>

                <div className="flex items-center gap-3">
                  <div className="flex-1 h-px bg-white/10" />
                  <span className="text-xs text-white/30">veya</span>
                  <div className="flex-1 h-px bg-white/10" />
                </div>

                <div className="grid grid-cols-4 gap-2">
                  <button
                    onClick={() => shareExternal('instagram', { image: selectedImage, caption })}
                    className="py-3 rounded-xl glass hover:bg-white/10 flex flex-col items-center gap-1"
                  >
                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 via-pink-500 to-orange-500 flex items-center justify-center">
                      <Icon name="instagram" size={18} />
                    </div>
                    <span className="text-[10px] text-white/50">Instagram</span>
                  </button>
                  <button
                    onClick={() => shareExternal('facebook', { image: selectedImage, caption })}
                    className="py-3 rounded-xl glass hover:bg-white/10 flex flex-col items-center gap-1"
                  >
                    <div className="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center">
                      <Icon name="facebook" size={18} />
                    </div>
                    <span className="text-[10px] text-white/50">Facebook</span>
                  </button>
                  <button
                    onClick={() => shareExternal('twitter', { image: selectedImage, caption })}
                    className="py-3 rounded-xl glass hover:bg-white/10 flex flex-col items-center gap-1"
                  >
                    <div className="w-8 h-8 rounded-lg bg-black flex items-center justify-center">
                      <Icon name="twitter" size={18} />
                    </div>
                    <span className="text-[10px] text-white/50">X</span>
                  </button>
                  <button
                    onClick={() => shareExternal('whatsapp', { image: selectedImage, caption })}
                    className="py-3 rounded-xl glass hover:bg-white/10 flex flex-col items-center gap-1"
                  >
                    <div className="w-8 h-8 rounded-lg bg-green-500 flex items-center justify-center">
                      <Icon name="whatsapp" size={18} />
                    </div>
                    <span className="text-[10px] text-white/50">WhatsApp</span>
                  </button>
                </div>
              </div>
            </>
          )}
        </div>
      )}

      {/* Post Detail Modal */}
      {selectedPost && (
        <div className="fixed inset-0 z-[90] bg-black/90 flex flex-col slide-up">
          <div className="p-4 flex items-center justify-between border-b border-white/10">
            <button onClick={() => setSelectedPost(null)} className="p-2 -ml-2">
              <Icon name="chevronLeft" size={24} />
            </button>
            <h3 className="font-bold">G√∂nderi</h3>
            <div className="w-10" />
          </div>
          
          <div className="flex-1 overflow-y-auto custom-scroll">
            <PostCard post={selectedPost} showActions={true} />
            
            {/* Comments */}
            <div className="p-4 space-y-3">
              <h4 className="font-semibold text-sm">Yorumlar</h4>
              {selectedPost.comments.length === 0 ? (
                <p className="text-sm text-white/40">Hen√ºz yorum yok</p>
              ) : (
                selectedPost.comments.map(c => (
                  <div key={c.id} className="flex gap-3">
                    <div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-xs">üë§</div>
                    <div className="flex-1">
                      <p className="text-sm">
                        <span className="font-semibold">{c.authorName}</span>{' '}
                        <span className="text-white/80">{c.text}</span>
                      </p>
                      <p className="text-xs text-white/40 mt-0.5">{getTimeAgo(c.createdAt)}</p>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>

          {/* Comment Input */}
          <div className="p-4 border-t border-white/10 flex gap-3 safe-bottom">
            <input
              type="text"
              value={comment}
              onChange={e => setComment(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && addComment(selectedPost.id)}
              placeholder="Yorum yaz..."
              className="flex-1"
            />
            <button onClick={() => addComment(selectedPost.id)} className="btn-primary px-5 rounded-xl">
              <Icon name="send" size={18} />
            </button>
          </div>

          {/* Delete option for owner */}
          {selectedPost.authorId === authUser?.uid && (
            <div className="absolute top-4 right-4">
              <button 
                onClick={() => deletePost(selectedPost.id)}
                className="p-2 rounded-xl bg-red-500/20 hover:bg-red-500/30"
              >
                <Icon name="trash" size={18} className="text-red-400" />
              </button>
            </div>
          )}
        </div>
      )}

      {/* Share Modal */}
      {shareModal.open && shareModal.post && (
        <div className="fixed inset-0 z-[100] bg-black/80 flex items-end justify-center p-4">
          <div className="w-full max-w-lg glass rounded-3xl p-6 scale-in safe-bottom">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-bold text-lg">Payla≈ü</h3>
              <button onClick={() => setShareModal({ open: false, post: null })} className="p-2 rounded-xl hover:bg-white/10">
                <Icon name="x" size={20} />
              </button>
            </div>
            
            <div className="grid grid-cols-4 gap-4 mb-4">
              {navigator.share && (
                <button
                  onClick={() => shareExternal('native', shareModal.post)}
                  className="py-4 rounded-xl glass hover:bg-white/10 flex flex-col items-center gap-2"
                >
                  <Icon name="share" size={24} className="text-brand2" />
                  <span className="text-xs">Payla≈ü</span>
                </button>
              )}
              <button
                onClick={() => shareExternal('instagram', shareModal.post)}
                className="py-4 rounded-xl glass hover:bg-white/10 flex flex-col items-center gap-2"
              >
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 via-pink-500 to-orange-500 flex items-center justify-center">
                  <Icon name="instagram" size={20} />
                </div>
                <span className="text-xs">Instagram</span>
              </button>
              <button
                onClick={() => shareExternal('facebook', shareModal.post)}
                className="py-4 rounded-xl glass hover:bg-white/10 flex flex-col items-center gap-2"
              >
                <div className="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center">
                  <Icon name="facebook" size={20} />
                </div>
                <span className="text-xs">Facebook</span>
              </button>
              <button
                onClick={() => shareExternal('whatsapp', shareModal.post)}
                className="py-4 rounded-xl glass hover:bg-white/10 flex flex-col items-center gap-2"
              >
                <div className="w-10 h-10 rounded-xl bg-green-500 flex items-center justify-center">
                  <Icon name="whatsapp" size={20} />
                </div>
                <span className="text-xs">WhatsApp</span>
              </button>
            </div>

            <button
              onClick={() => {
                navigator.clipboard?.writeText(`TrAi ile denedim! ${shareModal.post.caption || ''}`);
                setToast({ open: true, type: 'success', title: 'Kopyalandƒ±', message: 'Link panoya kopyalandƒ±' });
                setShareModal({ open: false, post: null });
              }}
              className="w-full btn-secondary py-3 rounded-xl font-semibold flex items-center justify-center gap-2"
            >
              <Icon name="copy" size={18} />
              Linki Kopyala
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

// ============ BOTTOM NAV ============
const BottomNav = ({ tab, setTab, hasNotifications }) => (
  <div className="glass-dark border-t border-white/10 p-2 pb-4 safe-bottom">
    <div className="flex justify-around">
      {[
        { id: 'shop', icon: 'shop', label: 'Ke≈üfet' }, 
        { id: 'closet', icon: 'hanger', label: 'Dolap' }, 
        { id: 'social', icon: 'globe', label: 'Sosyal' },
        { id: 'profile', icon: 'user', label: 'Profil' }
      ].map(t => (
        <button key={t.id} onClick={() => setTab(t.id)} className={`relative flex flex-col items-center gap-1 py-2 px-3 rounded-2xl transition ${tab === t.id ? 'text-brand2 bg-white/10' : 'text-white/55'}`}>
          <Icon name={t.icon} size={20} />
          <span className="text-[10px] font-bold">{t.label}</span>
          {t.id === 'social' && hasNotifications && (
            <div className="absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full" />
          )}
        </button>
      ))}
    </div>
  </div>
);

// ============ MAIN APP ============
const App = () => {
  const [toast, setToast] = useState({ open: false });
  const [authUser, setAuthUser] = useState(null);
  const [user, setUser] = useState(null);
  const [loadingAvatar, setLoadingAvatar] = useState(false); // Avatar y√ºklenirken bekleme durumu
  const [closet, setCloset] = useState([]);
  const [tab, setTab] = useState('shop');
  const [trying, setTrying] = useState(false);
  const [tryItem, setTryItem] = useState(null);
  const [result, setResult] = useState({ open: false, image: null, item: null });
  const [advice, setAdvice] = useState({ open: false, item: null, text: '', loading: false });
  const [lastTryTime, setLastTryTime] = useState(0);
  const COOLDOWN_MS = 30000;
  
  // Data loaded flag - prevents overwriting saved data on initial load
  const [dataLoaded, setDataLoaded] = useState(false);
  
  // Token system
  const [tokens, setTokens] = useState(3); // Free users get 3 tokens
  const [videoTokens, setVideoTokens] = useState(0);
  const [subscription, setSubscription] = useState(null);
  
  // Social features state
  const [friends, setFriends] = useState([]);
  const [messages, setMessages] = useState([]);
  const [settings, setSettings] = useState({
    profilePublic: true,
    combosPublic: true,
    showOnline: true,
    notifyMessages: true,
    notifyFriends: true,
    notifyDailyOutfit: true // G√ºnl√ºk √∂neri bildirimi
  });
  
  // Closet features state
  const [savedCombos, setSavedCombos] = useState([]);
  const [favorites, setFavorites] = useState([]);
  const [tryHistory, setTryHistory] = useState([]);
  const [tryOnCache, setTryOnCache] = useState({});
  
  // Social feed state
  const [posts, setPosts] = useState([]);
  
  // Daily recommendation state
  const [dailyRecommendation, setDailyRecommendation] = useState(null);
  const [showDailyModal, setShowDailyModal] = useState(false);
  const [dailyWeather, setDailyWeather] = useState(null);

  // Check cooldown before AI request
  const checkCooldown = () => {
    const now = Date.now();
    const elapsed = now - lastTryTime;
    if (elapsed < COOLDOWN_MS) {
      const remaining = Math.ceil((COOLDOWN_MS - elapsed) / 1000);
      setToast({ open: true, type: 'error', title: 'L√ºtfen bekle', message: `${remaining} saniye sonra tekrar dene` });
      return false;
    }
    return true;
  };

  // Bildirim izni iste ve kaydet
  const requestNotificationPermission = async () => {
    if (!('Notification' in window)) return false;
    if (Notification.permission === 'granted') return true;
    if (Notification.permission !== 'denied') {
      const permission = await Notification.requestPermission();
      return permission === 'granted';
    }
    return false;
  };

  // Bildirim g√∂nder
  const sendNotification = (title, body, icon = '‚ú®') => {
    if (!('Notification' in window) || Notification.permission !== 'granted') return;
    
    try {
      new Notification(title, {
        body,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">' + icon + '</text></svg>',
        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üëî</text></svg>',
        tag: 'trai-daily',
        requireInteraction: false
      });
    } catch (e) {
      // Bildirim g√∂nderilemedi
    }
  };

  // Hava durumunu al
  const fetchWeatherForRecommendation = async () => {
    try {
      if (!navigator.geolocation) return null;
      
      const pos = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
      });
      
      const { latitude, longitude } = pos.coords;
      const res = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,weather_code`
      );
      const data = await res.json();
      
      const weatherCodes = {
        0: { icon: '‚òÄÔ∏è', text: 'A√ßƒ±k' }, 1: { icon: 'üå§Ô∏è', text: 'Az Bulutlu' },
        2: { icon: '‚õÖ', text: 'Par√ßalƒ± Bulutlu' }, 3: { icon: '‚òÅÔ∏è', text: 'Bulutlu' },
        45: { icon: 'üå´Ô∏è', text: 'Sisli' }, 51: { icon: 'üåßÔ∏è', text: 'Yaƒümurlu' },
        61: { icon: 'üåßÔ∏è', text: 'Yaƒümurlu' }, 71: { icon: 'üå®Ô∏è', text: 'Karlƒ±' },
        80: { icon: 'üå¶Ô∏è', text: 'Saƒüanak' }, 95: { icon: '‚õàÔ∏è', text: 'Fƒ±rtƒ±na' }
      };
      
      const code = data.current.weather_code;
      const weatherInfo = weatherCodes[code] || { icon: 'üå°Ô∏è', text: 'Belirsiz' };
      
      return {
        temp: Math.round(data.current.temperature_2m),
        icon: weatherInfo.icon,
        text: weatherInfo.text
      };
    } catch {
      return null;
    }
  };

  // G√ºnl√ºk √∂neri kontrol√º ve g√∂sterimi
  const checkDailyRecommendation = async () => {
    if (!authUser || !closet.length) return;
    
    const today = new Date().toDateString();
    const lastShown = localStorage.getItem(`trai_daily_shown_${authUser.uid}`);
    
    // Bug√ºn zaten g√∂sterildi mi?
    if (lastShown === today) return;
    
    // Hava durumunu al
    const weather = await fetchWeatherForRecommendation();
    setDailyWeather(weather);
    
    // AI'dan √∂neri al
    const recommendation = await AI.getDailyRecommendation(
      closet, 
      weather, 
      null, // occasion - ≈üimdilik yok
      user?.gender || 'unisex'
    );
    
    if (recommendation && Object.values(recommendation.items).some(Boolean)) {
      setDailyRecommendation(recommendation);
      setShowDailyModal(true);
      
      // Bug√ºn g√∂sterildi olarak i≈üaretle
      localStorage.setItem(`trai_daily_shown_${authUser.uid}`, today);
    }
  };

  // Sabah 9'da bildirim kontrol√º
  const scheduleMorningNotification = () => {
    if (!authUser || !settings.notifyDailyOutfit) return;
    
    const now = new Date();
    const hour = now.getHours();
    
    // Saat 9'dan √∂nce ve bug√ºn bildirim g√∂nderilmedi mi?
    const today = now.toDateString();
    const lastNotified = localStorage.getItem(`trai_daily_notified_${authUser.uid}`);
    
    if (lastNotified === today) return; // Bug√ºn zaten bildirim g√∂nderildi
    
    // Eƒüer saat 9'u ge√ßtiyse ve uygulama a√ßƒ±ldƒ±ysa bildirim g√∂nderme (uygulama a√ßƒ±k)
    if (hour >= 9) {
      // Uygulama a√ßƒ±k, bildirim gerek yok - modal g√∂sterilecek
      return;
    }
    
    // Saat 9'a kadar bekle
    const nineAM = new Date(now);
    nineAM.setHours(9, 0, 0, 0);
    const msUntilNine = nineAM.getTime() - now.getTime();
    
    if (msUntilNine > 0) {
      setTimeout(async () => {
        // Kullanƒ±cƒ± hala giri≈ü yapmamƒ±≈ü mƒ± kontrol et
        const stillNotShown = localStorage.getItem(`trai_daily_shown_${authUser.uid}`) !== today;
        
        if (stillNotShown && settings.notifyDailyOutfit) {
          // Hava durumu al
          const weather = await fetchWeatherForRecommendation();
          
          // Bildirim g√∂nder
          const weatherText = weather ? `${weather.temp}¬∞C ${weather.text}` : '';
          sendNotification(
            'üëî Bug√ºn Ne Giysen?',
            `${weatherText ? weatherText + ' - ' : ''}Dolabƒ±ndan kombin √∂nerimiz hazƒ±r!`,
            'üëî'
          );
          
          // Bildirim g√∂nderildi olarak i≈üaretle
          localStorage.setItem(`trai_daily_notified_${authUser.uid}`, today);
        }
      }, msUntilNine);
    }
  };

  // Load data on mount - DON'T load user here, wait for auth
  useEffect(() => {
    // Only load non-user-specific data on mount
    // User data will be loaded after auth is confirmed
    const ps = safeJsonParse(localStorage.getItem('trai_posts_v1'), []);
    if (Array.isArray(ps)) setPosts(ps);
  }, []);

  // Load user-specific data AFTER auth is confirmed
  useEffect(() => {
    if (!authUser) {
      // Clear user when logged out
      setUser(null);
      setLoadingAvatar(false);
      setCloset([]);
      setFriends([]);
      setMessages([]);
      setSavedCombos([]);
      setFavorites([]);
      setTryHistory([]);
      setTryOnCache({});
      setTokens(3);
      setVideoTokens(0);
      setDataLoaded(false);
      return;
    }
    
    // Set loading state while fetching
    setLoadingAvatar(true);
    
    // Load user-specific data from localStorage (keyed by userId)
    const userId = authUser.uid;
    const u = safeJsonParse(localStorage.getItem(`trai_user_${userId}`), null);
    const c = safeJsonParse(localStorage.getItem(`trai_closet_${userId}`), []);
    const f = safeJsonParse(localStorage.getItem(`trai_friends_${userId}`), []);
    const m = safeJsonParse(localStorage.getItem(`trai_messages_${userId}`), []);
    const s = safeJsonParse(localStorage.getItem(`trai_settings_${userId}`), null);
    const sc = safeJsonParse(localStorage.getItem(`trai_combos_${userId}`), []);
    const fv = safeJsonParse(localStorage.getItem(`trai_favorites_${userId}`), []);
    const th = safeJsonParse(localStorage.getItem(`trai_history_${userId}`), []);
    const tc = safeJsonParse(localStorage.getItem(`trai_tryoncache_${userId}`), {});
    const tk = safeJsonParse(localStorage.getItem(`trai_tokens_${userId}`), 3);
    const vtk = safeJsonParse(localStorage.getItem(`trai_videotokens_${userId}`), 0);
    
    if (u) {
      setUser(u);
      setLoadingAvatar(false); // localStorage'dan y√ºklendi
    }
    if (Array.isArray(c)) setCloset(c);
    if (Array.isArray(f)) setFriends(f);
    if (Array.isArray(m)) setMessages(m);
    if (s) setSettings(prev => ({ ...prev, ...s }));
    if (Array.isArray(sc)) setSavedCombos(sc);
    if (Array.isArray(fv)) setFavorites(fv);
    if (Array.isArray(th)) setTryHistory(th);
    if (tc && typeof tc === 'object') setTryOnCache(tc);
    setTokens(typeof tk === 'number' ? tk : 3);
    setVideoTokens(typeof vtk === 'number' ? vtk : 0);
    
    // Mark data as loaded - prevents overwriting on save
    setDataLoaded(true);
    
    // Eƒüer localStorage'da user yoksa Firebase'den y√ºklenecek, loading devam eder
    if (!u) {
      // Loading state Firebase useEffect'te kaldƒ±rƒ±lacak
    } else {
      setLoadingAvatar(false);
    }
  }, [authUser]);

  // G√ºnl√ºk √∂neri kontrol√º - kullanƒ±cƒ± ve dolap y√ºklendikten sonra
  useEffect(() => {
    if (authUser && closet.length > 0 && user) {
      // Bildirim izni iste
      requestNotificationPermission();
      
      // Sabah 9 bildirimi planla
      scheduleMorningNotification();
      
      // G√ºnl√ºk √∂neriyi kontrol et (kƒ±sa gecikme ile - UI y√ºklensin)
      const timer = setTimeout(() => {
        checkDailyRecommendation();
      }, 2000);
      
      return () => clearTimeout(timer);
    }
  }, [authUser, closet.length, user]);

  // Save user to localStorage and Firestore (user-specific)
  useEffect(() => {
    if (user && authUser) {
      const userId = authUser.uid;
      localStorage.setItem(`trai_user_${userId}`, JSON.stringify(user));
      // Sync to Firestore if logged in
      if (db) {
        // Upload baseAvatar to Storage first (async, don't block)
        const avatarData = user.baseAvatar || user.avatar; // Support both old and new
        if (avatarData && avatarData.startsWith('data:image')) {
          uploadAvatarToStorage(userId, avatarData).then(storageUrl => {
            // Save to Firestore with storage URL reference
            db.collection('users').doc(userId).set({
              baseAvatarStorageUrl: storageUrl || null,
              params: { gender: user.gender, age: user.age, height: user.height, weight: user.weight, bodyType: user.bodyType, skinTone: user.skinTone, hairColor: user.hairColor, hairStyle: user.hairStyle },
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).catch(() => {});
          });
        } else {
          // Just save params without baseAvatar
          db.collection('users').doc(userId).set({
            params: { gender: user.gender, age: user.age, height: user.height, weight: user.weight, bodyType: user.bodyType, skinTone: user.skinTone, hairColor: user.hairColor, hairStyle: user.hairStyle },
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true }).catch(() => {});
        }
      }
    }
  }, [user, authUser]);

  // Save closet to localStorage (user-specific) - only after data is loaded
  useEffect(() => {
    if (authUser && dataLoaded) {
      localStorage.setItem(`trai_closet_${authUser.uid}`, JSON.stringify(closet));
    }
  }, [closet, authUser, dataLoaded]);

  // Save friends to localStorage (user-specific)
  useEffect(() => {
    if (authUser && dataLoaded) {
      localStorage.setItem(`trai_friends_${authUser.uid}`, JSON.stringify(friends));
    }
  }, [friends, authUser, dataLoaded]);

  // Save messages to localStorage (user-specific)
  useEffect(() => {
    if (authUser && dataLoaded) {
      localStorage.setItem(`trai_messages_${authUser.uid}`, JSON.stringify(messages));
    }
  }, [messages, authUser, dataLoaded]);

  // Save settings to localStorage (user-specific)
  useEffect(() => {
    if (authUser && dataLoaded) {
      localStorage.setItem(`trai_settings_${authUser.uid}`, JSON.stringify(settings));
    }
  }, [settings, authUser, dataLoaded]);

  // Save savedCombos to localStorage (user-specific)
  useEffect(() => {
    if (authUser && dataLoaded) {
      localStorage.setItem(`trai_combos_${authUser.uid}`, JSON.stringify(savedCombos));
    }
  }, [savedCombos, authUser, dataLoaded]);

  // Save favorites to localStorage (user-specific)
  useEffect(() => {
    if (authUser && dataLoaded) {
      localStorage.setItem(`trai_favorites_${authUser.uid}`, JSON.stringify(favorites));
    }
  }, [favorites, authUser, dataLoaded]);

  // Save tryHistory to localStorage (user-specific)
  useEffect(() => {
    if (authUser && dataLoaded) {
      localStorage.setItem(`trai_history_${authUser.uid}`, JSON.stringify(tryHistory));
    }
    // Make tryHistory accessible to SocialFeed
    window.tryHistoryRef = tryHistory;
  }, [tryHistory, authUser, dataLoaded]);

  // Save tryOnCache to localStorage (user-specific)
  useEffect(() => {
    if (authUser && dataLoaded && Object.keys(tryOnCache).length > 0) {
      localStorage.setItem(`trai_tryoncache_${authUser.uid}`, JSON.stringify(tryOnCache));
    }
  }, [tryOnCache, authUser, dataLoaded]);

  // Save tokens to localStorage (user-specific)
  useEffect(() => {
    if (authUser && dataLoaded) {
      localStorage.setItem(`trai_tokens_${authUser.uid}`, JSON.stringify(tokens));
    }
  }, [tokens, authUser, dataLoaded]);

  // Save video tokens to localStorage (user-specific)
  useEffect(() => {
    if (authUser && dataLoaded) {
      localStorage.setItem(`trai_videotokens_${authUser.uid}`, JSON.stringify(videoTokens));
    }
  }, [videoTokens, authUser, dataLoaded]);

  // Save posts to localStorage (shared across users)
  useEffect(() => {
    localStorage.setItem('trai_posts_v1', JSON.stringify(posts));
  }, [posts]);

  // Load baseAvatar from Firestore/Storage on auth
  useEffect(() => {
    if (authUser && db && !user) {
      setLoadingAvatar(true);
      db.collection('users').doc(authUser.uid).get().then(async doc => {
        if (doc.exists) {
          const data = doc.data();
          // Try to load baseAvatar from Storage
          let baseAvatarDataUrl = null;
          if (data.baseAvatarStorageUrl || data.avatarStorageUrl || storage) {
            baseAvatarDataUrl = await downloadAvatarFromStorage(authUser.uid);
          }
          if (baseAvatarDataUrl && data.params) {
            setUser({ ...data.params, baseAvatar: baseAvatarDataUrl });
            setToast({ open: true, type: 'success', title: 'Ho≈ü geldin', message: 'Avatarƒ±n y√ºklendi!' });
          }
        }
        setLoadingAvatar(false);
      }).catch(() => {
        setLoadingAvatar(false);
      });
    }
  }, [authUser]);

  const addToCloset = item => setCloset(prev => prev.some(x => x.id === item.id) ? prev : [...prev, { ...item, addedAt: Date.now() }]);
  const removeFromCloset = id => setCloset(prev => prev.filter(i => i.id !== id));

  // Get base avatar - prefer from Storage, fallback to local
  // Avatar cache - Firebase'den bir kez indir, sonra cache'den kullan
  const [avatarCache, setAvatarCache] = useState(null);
  
  const getBaseAvatar = async () => {
    // 1. √ñnce cache'e bak
    if (avatarCache) {
      debugLog('Avatar', 'Cache\'den alƒ±ndƒ±', 'success');
      return avatarCache;
    }
    
    // 2. Local state'e bak
    const localAvatar = user?.baseAvatar || user?.avatar;
    if (localAvatar && localAvatar.startsWith('data:image')) {
      debugLog('Avatar', 'Local state\'den alƒ±ndƒ±', 'success');
      setAvatarCache(localAvatar);
      return localAvatar;
    }
    
    // 3. Son √ßare: Firebase Storage'dan indir
    if (authUser && storage) {
      debugLog('Avatar', 'Firebase\'den indiriliyor...', 'info');
      const storageAvatar = await downloadAvatarFromStorage(authUser.uid);
      if (storageAvatar) {
        debugLog('Avatar', 'Firebase\'den indirildi', 'success');
        setAvatarCache(storageAvatar);
        return storageAvatar;
      }
    }
    
    debugLog('Avatar', 'Avatar bulunamadƒ±', 'error');
    return null;
  };
  
  // Avatar deƒüi≈ütiƒüinde cache'i g√ºncelle
  useEffect(() => {
    const localAvatar = user?.baseAvatar || user?.avatar;
    if (localAvatar && localAvatar.startsWith('data:image')) {
      setAvatarCache(localAvatar);
    }
  }, [user?.baseAvatar, user?.avatar]);

  const tryOnSingle = async item => {
    const avatarData = user?.baseAvatar || user?.avatar;
    if (!avatarData) {
      setToast({ open: true, type: 'error', title: 'Avatar yok', message: '√ñnce avatar olu≈ütur' });
      return;
    }
    
    // Check cache first - no cooldown for cached results
    const cacheKey = `single_${item.id}`;
    if (tryOnCache[cacheKey]) {
      // Use cached result
      addToCloset(item);
      setResult({ open: true, image: tryOnCache[cacheKey], item });
      setToast({ open: true, type: 'success', title: 'Hƒ±zlƒ± Sonu√ß ‚ö°', message: '√ñnceki deneme g√∂rseli y√ºklendi!' });
      return;
    }
    
    // Check cooldown before making API request
    if (!checkCooldown()) return;
    
    setTrying(true);
    setTryItem(item);
    setLastTryTime(Date.now()); // Set cooldown start
    
    try {
      const baseAvatar = await getBaseAvatar();
      if (!baseAvatar || !baseAvatar.startsWith('data:image')) {
        throw new Error('Avatar y√ºklenemedi');
      }
      
      const img = await AI.tryOnSingle(baseAvatar, item, BACKGROUNDS[0].value);
      
      if (!img || !img.startsWith('data:image')) {
        throw new Error('G√∂rsel olu≈üturulamadƒ±');
      }
      
      setTryOnCache(prev => ({ ...prev, [cacheKey]: img }));
      addToCloset(item);
      setUser(prev => ({ ...prev, tryOnCount: (prev.tryOnCount || 0) + 1 }));
      setResult({ open: true, image: img, item });
      setToast({ open: true, type: 'success', title: 'Ba≈üarƒ±lƒ±', message: 'Deneme g√∂rseli hazƒ±r!' });
    } catch (e) {
      setToast({ open: true, type: 'error', title: 'Deneme hatasƒ±', message: e.message || 'Bir hata olu≈ütu' });
    } finally {
      setTrying(false);
      setTryItem(null);
    }
  };

  // Callback for SmartCloset combo results
  const onTryOnResult = (img, items) => {
    try {
      debugLog('Result', `Sonu√ß alƒ±ndƒ±: ${img ? Math.round(img.length/1024) + 'KB' : 'null'}, ${items?.length || 0} √ºr√ºn`, img ? 'success' : 'error');
      
      if (!img || !img.startsWith('data:image')) {
        debugLog('Result', 'Ge√ßersiz g√∂rsel formatƒ±', 'error');
        setToast({ open: true, type: 'error', title: 'Hata', message: 'G√∂rsel olu≈üturulamadƒ±' });
        return;
      }
      
      debugLog('Result', 'Dolaba ekleniyor...', 'info');
      items.forEach(addToCloset);
      
      debugLog('Result', 'User g√ºncelleniyor...', 'info');
      setUser(prev => ({ ...prev, tryOnCount: (prev.tryOnCount || 0) + 1 }));
      
      debugLog('Result', 'Modal state hazƒ±rlanƒ±yor...', 'info');
      const modalData = { 
        open: true, 
        image: img, 
        item: items.length === 1 ? items[0] : null,
        items: items
      };
      
      debugLog('Result', 'setResult √ßaƒürƒ±lƒ±yor...', 'info');
      setResult(modalData);
      debugLog('Result', 'Modal a√ßƒ±ldƒ± ‚úì', 'success');
    } catch (err) {
      debugLog('Result', `HATA: ${err.message}`, 'error');
      console.error('onTryOnResult error:', err);
      setToast({ open: true, type: 'error', title: 'Hata', message: 'Sonu√ß g√∂sterilemedi: ' + err.message });
    }
  };

  const getAdvice = async item => {
    setAdvice({ open: true, item, text: '', loading: true });
    const text = await AI.getStyleAdvice(item, user);
    setAdvice(prev => ({ ...prev, text, loading: false }));
  };

  const resetAvatar = () => {
    if (confirm('Avatarƒ±nƒ± yenilemek istiyor musun? √ñnceki deneme g√∂rselleri de silinecek.')) {
      setUser(null);
      setTryOnCache({}); // Clear try-on cache when avatar changes
      if (authUser) {
        localStorage.removeItem(`trai_user_${authUser.uid}`);
        localStorage.removeItem(`trai_tryoncache_${authUser.uid}`);
      }
    }
  };

  // Delete account and all user data
  const deleteAccount = async () => {
    if (!confirm('Hesabƒ±nƒ± ve t√ºm verilerini kalƒ±cƒ± olarak silmek istiyor musun? Bu i≈ülem geri alƒ±namaz!')) return;
    if (!confirm('Emin misin? Avatar, dolap, ge√ßmi≈ü ve t√ºm veriler silinecek.')) return;
    
    try {
      if (authUser) {
        const userId = authUser.uid;
        // Delete from Firestore
        if (db) {
          await db.collection('users').doc(userId).delete().catch(() => {});
        }
        // Delete from Storage
        if (storage) {
          try {
            await storage.ref(`avatars/${userId}/base-avatar.png`).delete();
          } catch {}
        }
        // Clear all localStorage
        localStorage.removeItem(`trai_user_${userId}`);
        localStorage.removeItem(`trai_closet_${userId}`);
        localStorage.removeItem(`trai_friends_${userId}`);
        localStorage.removeItem(`trai_messages_${userId}`);
        localStorage.removeItem(`trai_settings_${userId}`);
        localStorage.removeItem(`trai_combos_${userId}`);
        localStorage.removeItem(`trai_favorites_${userId}`);
        localStorage.removeItem(`trai_history_${userId}`);
        localStorage.removeItem(`trai_tryoncache_${userId}`);
        // Delete Firebase auth account
        if (auth?.currentUser) {
          await auth.currentUser.delete();
        }
      }
      // Clear state
      setUser(null);
      setAuthUser(null);
      setToast({ open: true, type: 'success', title: 'Hesap Silindi', message: 'T√ºm verileriniz kalƒ±cƒ± olarak silindi.' });
    } catch (e) {
      setToast({ open: true, type: 'error', title: 'Hata', message: 'Hesap silinemedi: ' + e.message });
    }
  };

  const logout = async () => {
    if (auth) await auth.signOut();
    setAuthUser(null);
    setToast({ open: true, type: 'success', title: '√áƒ±kƒ±≈ü yapƒ±ldƒ±', message: 'G√∂r√º≈ü√ºr√ºz!' });
  };

  // Auth screen
  if (!authUser) {
    return (
      <>
        <div className="h-screen max-w-lg mx-auto bg-dark"><AuthScreen onAuthed={setAuthUser} setToast={setToast} /></div>
        <Toast toast={toast} onClose={() => setToast({ open: false })} />
      </>
    );
  }

  // Avatar wizard - show loading while fetching from Firebase
  if (!user) {
    // Eƒüer avatar y√ºkleniyorsa loading g√∂ster
    if (loadingAvatar) {
      return (
        <>
          <div className="h-screen max-w-lg mx-auto bg-dark flex items-center justify-center">
            <div className="text-center">
              <div className="w-16 h-16 rounded-2xl bg-gradient-to-br from-brand to-brand2 flex items-center justify-center mx-auto mb-4 animate-pulse">
                <span className="text-3xl">‚ú®</span>
              </div>
              <p className="text-white/60 font-medium">Avatarƒ±n y√ºkleniyor...</p>
            </div>
          </div>
          <Toast toast={toast} onClose={() => setToast({ open: false })} />
        </>
      );
    }
    
    return (
      <>
        <div className="h-screen max-w-lg mx-auto bg-dark"><AvatarWizard onComplete={setUser} setToast={setToast} /></div>
        <Toast toast={toast} onClose={() => setToast({ open: false })} />
      </>
    );
  }

  // Enhance user with stats
  const userWithStats = { ...user, closetCount: closet.length, tryOnCount: user.tryOnCount || 0 };

  // Main app
  return (
    <>
      <div className="h-screen max-w-lg mx-auto bg-dark relative flex flex-col overflow-hidden">
        <div className="flex-1 overflow-hidden">
          {tab === 'shop' && <Shop user={user} closet={closet} onTryOn={tryOnSingle} onAddToCloset={addToCloset} onAdvice={getAdvice} />}
          {tab === 'closet' && (
            <SmartCloset 
              user={user} 
              closet={closet} 
              onRemove={removeFromCloset} 
              onTryOnResult={onTryOnResult} 
              setToast={setToast}
              savedCombos={savedCombos}
              setSavedCombos={setSavedCombos}
              favorites={favorites}
              setFavorites={setFavorites}
              tryHistory={tryHistory}
              setTryHistory={setTryHistory}
              getBaseAvatar={getBaseAvatar}
              tryOnCache={tryOnCache}
              setTryOnCache={setTryOnCache}
              checkCooldown={checkCooldown}
              setLastTryTime={setLastTryTime}
              tokens={tokens}
              setTokens={setTokens}
              videoTokens={videoTokens}
              setVideoTokens={setVideoTokens}
              onShareToFeed={(image, items) => {
                const newPost = {
                  id: Date.now(),
                  authorId: authUser?.uid,
                  authorName: user?.displayName || authUser?.email?.split('@')[0] || 'Kullanƒ±cƒ±',
                  authorAvatar: user?.baseAvatar || user?.avatar,
                  imageData: image,
                  items: items || [],
                  caption: '',
                  askFeedback: false,
                  visibility: 'public',
                  likes: [],
                  comments: [],
                  createdAt: Date.now()
                };
                setPosts(prev => [newPost, ...prev]);
                setTab('social');
              }}
            />
          )}
          {tab === 'profile' && (
            <Profile 
              user={userWithStats} 
              authUser={authUser} 
              onResetAvatar={resetAvatar} 
              onLogout={logout}
              onDeleteAccount={deleteAccount}
              friends={friends}
              setFriends={setFriends}
              messages={messages}
              setMessages={setMessages}
              settings={settings}
              setSettings={setSettings}
            />
          )}
          {tab === 'social' && (
            <SocialFeed
              user={user}
              authUser={authUser}
              friends={friends}
              posts={posts}
              setPosts={setPosts}
              setToast={setToast}
            />
          )}
        </div>
        <BottomNav tab={tab} setTab={setTab} hasNotifications={posts.some(p => p.askFeedback && p.authorId !== authUser?.uid)} />
      </div>

      {trying && <FullscreenLoader title="Deneme Hazƒ±rlanƒ±yor" subtitle={`${tryItem?.name || 'AI g√∂rsel olu≈üturuyor'}...`} />}
      <ResultModal 
        open={result.open} 
        image={result.image} 
        item={result.item}
        items={result.items}
        onClose={() => setResult({ open: false })} 
        onShare={async () => { await shareImage(result.image); }}
        onShareToFeed={() => {
          // Sosyal akƒ±≈üa payla≈ü
          const newPost = {
            id: Date.now(),
            authorId: authUser?.uid,
            authorName: user?.displayName || authUser?.email?.split('@')[0] || 'Kullanƒ±cƒ±',
            authorAvatar: user?.baseAvatar || user?.avatar,
            imageData: result.image,
            items: result.items || (result.item ? [result.item] : []),
            caption: '',
            askFeedback: false,
            visibility: 'public',
            likes: [],
            comments: [],
            createdAt: Date.now()
          };
          setPosts(prev => [newPost, ...prev]);
          setResult({ open: false });
          setTab('social');
          setToast({ open: true, type: 'success', title: 'Payla≈üƒ±ldƒ±!', message: 'Kombinin sosyal akƒ±≈üta yayƒ±nlandƒ±' });
        }}
      />
      <AdviceModal open={advice.open} item={advice.item || {}} advice={advice.text} loading={advice.loading} onClose={() => setAdvice({ open: false })} />
      
      {/* G√ºnl√ºk Kombin √ñnerisi Modal */}
      {showDailyModal && dailyRecommendation && (
        <div className="fixed inset-0 z-[100] bg-black/95 flex flex-col slide-up">
          <div className="p-4 flex items-center justify-between border-b border-white/10">
            <h3 className="font-bold flex items-center gap-2">
              <span className="text-2xl">üëî</span>
              G√ºn√ºn Kombin √ñnerisi
            </h3>
            <button onClick={() => setShowDailyModal(false)} className="p-2 rounded-xl hover:bg-white/10">
              <Icon name="x" size={20} />
            </button>
          </div>
          
          <div className="flex-1 overflow-auto custom-scroll p-4">
            {/* Hava Durumu */}
            {dailyWeather && (
              <div className="glass rounded-2xl p-4 mb-4 flex items-center gap-4">
                <span className="text-4xl">{dailyWeather.icon}</span>
                <div>
                  <p className="text-2xl font-bold">{dailyWeather.temp}¬∞C</p>
                  <p className="text-white/60">{dailyWeather.text}</p>
                </div>
              </div>
            )}
            
            {/* √ñneri A√ßƒ±klamasƒ± */}
            <div className="glass rounded-2xl p-4 mb-4">
              <p className="text-sm leading-relaxed">{dailyRecommendation.reason}</p>
              {dailyRecommendation.tip && (
                <p className="text-xs text-brand2 mt-2 flex items-center gap-1">
                  <Icon name="sparkles" size={12} />
                  {dailyRecommendation.tip}
                </p>
              )}
            </div>
            
            {/* √ñnerilen √úr√ºnler */}
            <p className="text-xs text-white/50 mb-2 font-bold">√ñNERƒ∞LEN KOMBƒ∞N</p>
            <div className="grid grid-cols-2 gap-3">
              {dailyRecommendation.items.fullbody && (
                <div className="glass rounded-2xl p-3 col-span-2">
                  <div className="flex items-center gap-3">
                    <img src={dailyRecommendation.items.fullbody.image} className="w-20 h-20 rounded-xl object-cover ring-2 ring-pink-400" />
                    <div>
                      <p className="text-xs text-pink-400">üëó Elbise</p>
                      <p className="font-semibold">{dailyRecommendation.items.fullbody.name}</p>
                      <p className="text-xs text-white/50">{dailyRecommendation.items.fullbody.brandName}</p>
                    </div>
                  </div>
                </div>
              )}
              {dailyRecommendation.items.top && (
                <div className="glass rounded-2xl p-3">
                  <img src={dailyRecommendation.items.top.image} className="w-full aspect-square rounded-xl object-cover ring-2 ring-brand2 mb-2" />
                  <p className="text-xs text-brand2">üëï √úst</p>
                  <p className="font-semibold text-sm truncate">{dailyRecommendation.items.top.name}</p>
                </div>
              )}
              {dailyRecommendation.items.bottom && (
                <div className="glass rounded-2xl p-3">
                  <img src={dailyRecommendation.items.bottom.image} className="w-full aspect-square rounded-xl object-cover ring-2 ring-accent mb-2" />
                  <p className="text-xs text-accent">üëñ Alt</p>
                  <p className="font-semibold text-sm truncate">{dailyRecommendation.items.bottom.name}</p>
                </div>
              )}
              {dailyRecommendation.items.outerwear && (
                <div className="glass rounded-2xl p-3 col-span-2">
                  <div className="flex items-center gap-3">
                    <img src={dailyRecommendation.items.outerwear.image} className="w-20 h-20 rounded-xl object-cover ring-2 ring-blue-400" />
                    <div>
                      <p className="text-xs text-blue-400">üß• Dƒ±≈ü Giyim</p>
                      <p className="font-semibold">{dailyRecommendation.items.outerwear.name}</p>
                      <p className="text-xs text-white/50">{dailyRecommendation.items.outerwear.brandName}</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
          
          <div className="p-4 space-y-2 border-t border-white/10 safe-bottom">
            <button 
              onClick={() => {
                // Se√ßili √ºr√ºnleri dolap sekmesine aktar
                setTab('closet');
                setShowDailyModal(false);
                setToast({ open: true, type: 'success', title: 'Hazƒ±r!', message: 'Dolaba git ve kombini dene' });
              }}
              className="w-full btn-primary py-4 rounded-2xl font-bold flex items-center justify-center gap-2"
            >
              <Icon name="sparkles" size={18} />
              Bu Kombini Dene
            </button>
            <button 
              onClick={() => setShowDailyModal(false)}
              className="w-full btn-ghost py-3 rounded-2xl font-semibold text-white/60"
            >
              Sonra Bakarƒ±m
            </button>
          </div>
        </div>
      )}
      
      <Toast toast={toast} onClose={() => setToast({ open: false })} />
      <DebugPanel />
    </>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
